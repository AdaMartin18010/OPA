# OPA/Rego 版本兼容性说明

> **最后更新**: 2025-10-25  
> **文档版本**: v1.1  
> **验证周期**: 每月检查并更新

---

## 📋 快速参考

| 本项目文档适用版本 | OPA版本 | Rego语言版本 | 测试状态 |
|-------------------|---------|-------------|---------|
| **当前推荐** | **v0.68+** | **v1.0** | ✅ 已验证 |
| 最低要求 | v0.55+ | v1.0 | ✅ 兼容 |
| 测试覆盖 | v0.55 - v0.68 | v1.0 | ✅ 全面 |

---

## 🎯 核心版本信息

### OPA版本

**最新稳定版**: v0.68.0 (2024-10)  
**最低支持版**: v0.55.0 (2023-08)  
**Rego v1冻结**: v0.42.0 (2022-06) 引入Rego v1

### Rego语言版本

**当前版本**: v1.0  
**状态**: ✅ 语法已冻结（自2022年6月）  
**语法**: 使用 `import rego.v1` 启用

---

## 📊 功能兼容性矩阵

### 核心语言特性

| 特性 | 最低OPA版本 | Rego版本 | 本文档使用 | 说明 |
|------|------------|---------|-----------|------|
| 基础语法 | v0.1+ | - | ✅ | package, import, rules |
| `if` 关键字 | v0.42+ | v1.0 | ✅ | 替代 `:-` |
| `contains` 关键字 | v0.42+ | v1.0 | ✅ | 集合规则 |
| `in` 关键字 | v0.42+ | v1.0 | ✅ | 成员测试 |
| `every` 关键字 | v0.42+ | v1.0 | ✅ | 全称量词 |
| `import rego.v1` | v0.42+ | v1.0 | ✅ | 启用v1语法 |

### 编译和部署

| 特性 | 最低OPA版本 | 测试状态 | 本文档覆盖 |
|------|------------|---------|-----------|
| WASM编译 | v0.20+ | ✅ | [01.3-WASM编译规范](docs/01-技术规范/01.3-WASM编译规范.md) |
| Bundle打包 | v0.10+ | ✅ | [01.2-Bundle格式规范](docs/01-技术规范/01.2-Bundle格式规范.md) |
| 部分求值 | v0.20+ | ✅ | [03.6-部分求值技术](docs/03-实现架构/03.6-部分求值技术.md) |
| IR优化 | v0.50+ | ✅ | [03.3-编译器设计](docs/03-实现架构/03.3-编译器设计.md) |

### 内置函数

| 函数类别 | 最低OPA版本 | 函数数量 | 文档链接 |
|---------|------------|---------|---------|
| 字符串操作 | v0.1+ | 20+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#字符串函数) |
| 数组操作 | v0.1+ | 15+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#数组函数) |
| 对象操作 | v0.1+ | 10+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#对象函数) |
| 集合操作 | v0.1+ | 10+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#集合函数) |
| JWT | v0.10+ | 5+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#jwt函数) |
| 加密 | v0.20+ | 8+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#加密函数) |
| HTTP | v0.30+ | 2+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#http函数) |
| GraphQL | v0.45+ | 5+ | [02.3-内置函数库](docs/02-语言模型/02.3-内置函数库.md#图遍历) |

### 生态系统集成

| 工具/平台 | 版本要求 | 测试版本 | 兼容性 | 文档 |
|---------|---------|---------|-------|------|
| **Kubernetes** | 1.23+ | 1.28, 1.29, 1.30 | ✅ | [04.1-Kubernetes集成](docs/04-生态系统/04.1-Kubernetes集成.md) |
| **Gatekeeper** | v3.10+ | v3.17 | ✅ | [04.2-Gatekeeper详解](docs/04-生态系统/04.2-Gatekeeper详解.md) |
| **Envoy** | 1.18+ | 1.31 | ✅ | [05.2-API网关授权](docs/05-应用场景/05.2-API网关授权.md) |
| **Istio** | 1.10+ | 1.23 | ✅ | [05.2-API网关授权](docs/05-应用场景/05.2-API网关授权.md) |
| **Docker** | 20.10+ | 27.x | ✅ | 部署示例 |

---

## 🔄 重要版本变更历史

### OPA v0.68.0 (2024-10)

**新特性**:

- 性能优化：查询评估速度提升15%
- 新增内置函数：`crypto.x509.parse_and_verify_certificates_with_options`
- 改进WASM编译器

**影响**: 本文档所有示例已验证兼容

---

### OPA v0.60.0 (2024-02)

**新特性**:

- 新增 `http.send` 超时配置
- 改进部分求值性能
- WASM内存优化

**影响**: 部分求值相关文档已更新

---

### OPA v0.55.0 (2023-08)

**新特性**:

- 稳定的Rego v1语法
- 改进错误消息
- 性能基准工具增强

**影响**: 本文档最低支持版本

**⚠️ 重要**: v0.55之前的版本可能与文档示例不兼容

---

### OPA v0.42.0 (2022-06) - Rego v1里程碑

**新特性**:

- 🎉 引入Rego v1语法
- 新关键字：`if`, `contains`, `in`, `every`
- `import rego.v1` 启用新语法

**影响**: **所有文档使用Rego v1语法**

**迁移指南**:

```rego
# Rego v0 (旧语法)
allow = true {
    input.user == "admin"
}

# Rego v1 (新语法 - 本文档使用)
import rego.v1

allow if {
    input.user == "admin"
}
```

---

## 📖 按文档的版本要求

### 技术规范

| 文档 | 最低OPA版本 | 推荐版本 | 关键特性 |
|------|------------|---------|---------|
| [01.1-API规范](docs/01-技术规范/01.1-API规范.md) | v0.10+ | v0.68+ | REST API, Health Check |
| [01.2-Bundle格式](docs/01-技术规范/01.2-Bundle格式规范.md) | v0.10+ | v0.68+ | Bundle签名需v0.20+ |
| [01.3-WASM编译](docs/01-技术规范/01.3-WASM编译规范.md) | v0.20+ | v0.68+ | 优化需v0.50+ |
| [01.4-性能基准](docs/01-技术规范/01.4-性能基准与度量.md) | v0.30+ | v0.68+ | Profiling工具 |
| [01.5-安全合规](docs/01-技术规范/01.5-安全合规标准.md) | v0.30+ | v0.68+ | TLS, 签名验证 |

### 语言模型

| 文档 | 最低OPA版本 | 推荐版本 | Rego版本 |
|------|------------|---------|---------|
| [02.1-Rego语法](docs/02-语言模型/02.1-Rego语法规范.md) | v0.42+ | v0.68+ | v1.0 必需 |
| [02.2-类型系统](docs/02-语言模型/02.2-类型系统.md) | v0.42+ | v0.68+ | v1.0 |
| [02.3-内置函数](docs/02-语言模型/02.3-内置函数库.md) | v0.30+ | v0.68+ | 部分函数有版本要求 |
| [02.4-求值模型](docs/02-语言模型/02.4-求值模型.md) | v0.42+ | v0.68+ | v1.0 |

### 实现架构

| 文档 | 最低OPA版本 | 推荐版本 | 说明 |
|------|------------|---------|------|
| [03.1-词法解析](docs/03-实现架构/03.1-词法分析与语法解析.md) | v0.42+ | v0.68+ | Rego v1解析器 |
| [03.2-AST与IR](docs/03-实现架构/03.2-AST与IR.md) | v0.50+ | v0.68+ | 新IR引入v0.50 |
| [03.3-编译器设计](docs/03-实现架构/03.3-编译器设计.md) | v0.50+ | v0.68+ | 优化Pass |
| [03.4-求值器](docs/03-实现架构/03.4-Top-Down求值器.md) | v0.42+ | v0.68+ | - |
| [03.5-索引优化](docs/03-实现架构/03.5-索引与优化.md) | v0.30+ | v0.68+ | - |
| [03.6-部分求值](docs/03-实现架构/03.6-部分求值技术.md) | v0.20+ | v0.68+ | 性能关键 |

---

## ⚠️ 已知兼容性问题

### 1. Rego v0 vs v1

**问题**: 混用v0和v1语法

**症状**:

```text
rego_parse_error: unexpected keyword, must use 'if' keyword
```

**解决**:

```rego
# 方案1: 使用Rego v1 (推荐)
import rego.v1

allow if {
    input.user == "admin"
}

# 方案2: 使用旧语法
allow = true {
    input.user == "admin"
}
```

---

### 2. WASM编译限制

**问题**: 部分内置函数不支持WASM

**不支持的函数**:

- `http.send` (网络I/O)
- `opa.runtime` (运行时信息)

**解决**: 使用SDK注入外部数据

---

### 3. Kubernetes版本

**问题**: K8s API变化

**影响**: AdmissionReview API版本

**解决**:

```rego
# 支持多版本
admission.v1
admission.v1beta1
```

---

## 🔍 版本检查命令

### 检查OPA版本

```bash
opa version

# 输出:
# Version: 0.68.0
# Build Commit: ...
# Build Timestamp: ...
# Build Hostname: ...
```

### 检查Rego语法版本

```bash
# 验证v1语法
opa check --strict --format pretty policy.rego

# 转换v0到v1
opa fmt -w --rego-v1 policy.rego
```

### 测试兼容性

```bash
# 使用特定OPA版本测试
docker run --rm -v $(pwd):/work openpolicyagent/opa:0.68.0 test /work

# 测试多个版本
for version in 0.55.0 0.60.0 0.68.0; do
  echo "Testing OPA $version..."
  docker run --rm -v $(pwd):/work openpolicyagent/opa:$version test /work
done
```

---

## 📅 维护计划

### 检查周期

- **每月**: 检查OPA新版本发布
- **每季度**: 更新兼容性矩阵
- **重大版本**: 立即评估影响

### 更新流程

1. ✅ 检查OPA发布说明
2. ✅ 测试新版本与文档示例
3. ✅ 更新兼容性矩阵
4. ✅ 更新受影响文档
5. ✅ 更新CI/CD版本

---

## 🆘 升级指南

### 从v0.4x升级到v0.68+

```bash
# 1. 转换为Rego v1语法
opa fmt -w --rego-v1 *.rego

# 2. 添加import
echo "import rego.v1" > temp.rego
cat policy.rego >> temp.rego
mv temp.rego policy.rego

# 3. 运行测试
opa test . -v

# 4. 更新部署配置
# - 更新Docker镜像版本
# - 更新Kubernetes部署YAML
```

---

## 📞 获取帮助

遇到版本兼容性问题？

- 📖 查看 [FAQ](docs/FAQ.md#版本兼容性)
- 💬 提问 [GitHub Discussions](../../discussions)
- 🐛 报告 [GitHub Issues](../../issues)
- 📧 邮件 [维护者](mailto:maintainer@example.com)

---

## 🔗 相关资源

- [OPA发布说明](https://github.com/open-policy-agent/opa/releases)
- [Rego v1迁移指南](https://www.openpolicyagent.org/docs/latest/rego-v1-migration/)
- [兼容性测试](https://github.com/open-policy-agent/opa/tree/main/test)

---

**最后更新**: 2025-10-21  
**下次检查**: 2025-11-21  
**维护者**: OPA中文文档团队
