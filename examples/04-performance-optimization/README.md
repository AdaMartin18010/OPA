# ç¤ºä¾‹04ï¼šæ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

> **éš¾åº¦**: â­â­â­â­ é«˜çº§  
> **åœºæ™¯**: é«˜æ€§èƒ½åœºæ™¯ä¼˜åŒ–  
> **å­¦ä¹ æ—¶é—´**: 45-60åˆ†é’Ÿ

---

## ğŸ“‹ åœºæ™¯è¯´æ˜

æœ¬ç¤ºä¾‹å±•ç¤ºRegoç­–ç•¥çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½å·®å¼‚ã€‚

### ä¼˜åŒ–åœºæ™¯

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šæ­£ç¡®çš„æŸ¥è¯¢é¡ºåº
2. **è§„åˆ™ä¼˜åŒ–**ï¼šé¿å…é‡å¤è®¡ç®—
3. **æ•°æ®ç»“æ„ä¼˜åŒ–**ï¼šé€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„

### æ€§èƒ½ç›®æ ‡

- ä¼˜åŒ–å‰ï¼š100ms+
- ä¼˜åŒ–åï¼š<10ms
- æ€§èƒ½æå‡ï¼š10x+

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

- `policy_slow.rego`: æœªä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæ…¢ï¼‰
- `policy_fast.rego`: ä¼˜åŒ–åç‰ˆæœ¬ï¼ˆå¿«ï¼‰
- `policy_test.rego`: æ€§èƒ½å¯¹æ¯”æµ‹è¯•
- `data.json`: æµ‹è¯•æ•°æ®ï¼ˆ1000+ç”¨æˆ·ï¼‰
- `input.json`: æµ‹è¯•è¾“å…¥
- `benchmark.sh`: æ€§èƒ½åŸºå‡†æµ‹è¯•è„šæœ¬

---

## ğŸš€ å¿«é€Ÿè¿è¡Œ

### 1. æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```bash
cd examples/04-performance-optimization

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
opa test . -v

# æ€§èƒ½åŸºå‡†æµ‹è¯•
./benchmark.sh
```

é¢„æœŸè¾“å‡ºï¼š
```
==> Testing SLOW version
Queries per second: 100
P99 latency: 150ms

==> Testing FAST version  
Queries per second: 10000
P99 latency: 1.5ms

Performance improvement: 100x faster! ğŸš€
```

### 2. å•ç‹¬æµ‹è¯•æ…¢ç‰ˆæœ¬

```bash
opa eval -d policy_slow.rego -d data.json -i input.json \
    --profile \
    "data.authz_slow.allow"
```

### 3. å•ç‹¬æµ‹è¯•å¿«ç‰ˆæœ¬

```bash
opa eval -d policy_fast.rego -d data.json -i input.json \
    --profile \
    "data.authz_fast.allow"
```

---

## ğŸ“– ä¼˜åŒ–æŠ€æœ¯è¯¦è§£

### ä¼˜åŒ–1ï¼šç´¢å¼•ä¼˜åŒ–

#### âŒ æ…¢ç‰ˆæœ¬ï¼ˆæ— ç´¢å¼•ï¼‰

```rego
# policy_slow.rego
package authz_slow

import rego.v1

# é—®é¢˜ï¼šå…ˆéå†æ‰€æœ‰ç”¨æˆ·ï¼Œå†æ£€æŸ¥ID
allow if {
    some user in data.users
    user.name == input.user_name  # å…¨è¡¨æ‰«æï¼
    input.action in user.permissions
}
```

**æ€§èƒ½é—®é¢˜**:
- å…¨è¡¨æ‰«æï¼šéå†æ‰€æœ‰1000+ç”¨æˆ·
- æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œn=ç”¨æˆ·æ•°

#### âœ… å¿«ç‰ˆæœ¬ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰

```rego
# policy_fast.rego
package authz_fast

import rego.v1

# ä¼˜åŒ–ï¼šç›´æ¥é€šè¿‡IDæŸ¥æ‰¾
allow if {
    user := data.users[input.user_id]  # O(1) å“ˆå¸ŒæŸ¥æ‰¾ï¼
    input.action in user.permissions
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- å“ˆå¸ŒæŸ¥æ‰¾ï¼šç›´æ¥å®šä½ç”¨æˆ·
- æ—¶é—´å¤æ‚åº¦ï¼šO(1)
- **æ€§èƒ½æå‡ï¼š100x+**

---

### ä¼˜åŒ–2ï¼šè§„åˆ™é¡ºåºä¼˜åŒ–

#### âŒ æ…¢ç‰ˆæœ¬ï¼ˆé”™è¯¯é¡ºåºï¼‰

```rego
# é—®é¢˜ï¼šæ˜‚è´µçš„æ“ä½œåœ¨å‰é¢
allow if {
    some user in data.users              # æ…¢ï¼šéå†æ‰€æœ‰ç”¨æˆ·
    user.department == "engineering"     # æ…¢ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒ
    user.id == input.user_id             # å¿«ï¼šä½†åœ¨æœ€å
}
```

**æ€§èƒ½é—®é¢˜**:
- å…ˆæ‰§è¡Œæ˜‚è´µæ“ä½œï¼ˆéå†ã€å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
- å¤§éƒ¨åˆ†è¯·æ±‚åœ¨æœ€åæ‰å¤±è´¥

#### âœ… å¿«ç‰ˆæœ¬ï¼ˆæ­£ç¡®é¡ºåºï¼‰

```rego
# ä¼˜åŒ–ï¼šå»‰ä»·çš„æ£€æŸ¥åœ¨å‰é¢
allow if {
    input.user_id                         # å¿«ï¼šç®€å•å­˜åœ¨æ£€æŸ¥
    user := data.users[input.user_id]    # å¿«ï¼šç´¢å¼•æŸ¥æ‰¾
    user.department == "engineering"      # å¿«ï¼šåªå¯¹åŒ¹é…ç”¨æˆ·æ£€æŸ¥
}
```

**ä¼˜åŒ–åŸåˆ™**:
1. **æœ€å»‰ä»·çš„æ£€æŸ¥æ”¾æœ€å‰**
2. **æœ€å¯èƒ½å¤±è´¥çš„æ£€æŸ¥æ”¾æœ€å‰**
3. **é¿å…ä¸å¿…è¦çš„è®¡ç®—**

---

### ä¼˜åŒ–3ï¼šé¿å…é‡å¤è®¡ç®—

#### âŒ æ…¢ç‰ˆæœ¬ï¼ˆé‡å¤è®¡ç®—ï¼‰

```rego
# é—®é¢˜ï¼šåŒä¸€ä¸ªå€¼è®¡ç®—å¤šæ¬¡
has_permission(action) if {
    user := data.users[input.user_id]
    action in user.permissions
}

allow if {
    has_permission("read")
    has_permission("write")  # é‡å¤æŸ¥æ‰¾ç”¨æˆ·ï¼
}
```

**æ€§èƒ½é—®é¢˜**:
- æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°æŸ¥æ‰¾ç”¨æˆ·
- å¤šæ¬¡è°ƒç”¨ = å¤šæ¬¡æŸ¥æ‰¾

#### âœ… å¿«ç‰ˆæœ¬ï¼ˆç¼“å­˜ç»“æœï¼‰

```rego
# ä¼˜åŒ–ï¼šåªæŸ¥æ‰¾ä¸€æ¬¡ç”¨æˆ·
user := data.users[input.user_id]

has_permission(action) if {
    action in user.permissions
}

allow if {
    has_permission("read")
    has_permission("write")  # å¤ç”¨å·²æŸ¥æ‰¾çš„ç”¨æˆ·
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- ç”¨æˆ·æŸ¥æ‰¾åªæ‰§è¡Œä¸€æ¬¡
- åç»­è°ƒç”¨ç›´æ¥ä½¿ç”¨ç¼“å­˜

---

### ä¼˜åŒ–4ï¼šæ•°æ®ç»“æ„é€‰æ‹©

#### âŒ æ…¢ç‰ˆæœ¬ï¼ˆæ•°ç»„ï¼‰

```rego
# data.json
{
  "allowed_actions": ["read", "write", "delete"]
}

# policy_slow.rego
allow if {
    input.action in data.allowed_actions  # O(n) çº¿æ€§æŸ¥æ‰¾
}
```

**æ€§èƒ½é—®é¢˜**:
- æ•°ç»„ `in` æ“ä½œæ˜¯çº¿æ€§æŸ¥æ‰¾ O(n)

#### âœ… å¿«ç‰ˆæœ¬ï¼ˆé›†åˆï¼‰

```rego
# data.json  
{
  "allowed_actions_set": {
    "read": true,
    "write": true,
    "delete": true
  }
}

# policy_fast.rego
allow if {
    data.allowed_actions_set[input.action]  # O(1) å“ˆå¸ŒæŸ¥æ‰¾
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- é›†åˆæŸ¥æ‰¾ï¼šO(1)
- **é€‚ç”¨äºé¢‘ç¹æŸ¥è¯¢çš„åœºæ™¯**

---

## ğŸ“ æ€§èƒ½ä¼˜åŒ–åŸåˆ™

### 1. æµ‹é‡ä¼˜å…ˆ

```bash
# å§‹ç»ˆå…ˆæµ‹é‡æ€§èƒ½
opa eval --profile -d policy.rego -i input.json "data.authz.allow"

# ä½¿ç”¨ opa bench
opa bench -d policy.rego -i input.json --count 10000 "data.authz.allow"
```

**é»„é‡‘æ³•åˆ™**:
- âš ï¸ ä¸è¦è¿‡æ—©ä¼˜åŒ–
- âš ï¸ ä¸è¦çŒœæµ‹ç“¶é¢ˆ
- âœ… æµ‹é‡å®é™…æ€§èƒ½
- âœ… ä¼˜åŒ–çœŸæ­£çš„ç“¶é¢ˆ

### 2. æŸ¥è¯¢é¡ºåº

**ä¼˜åŒ–é¡ºåº**:
1. ç­‰å€¼æ¯”è¾ƒï¼ˆ`==`ï¼‰æ”¾æœ€å‰
2. ç´¢å¼•æŸ¥æ‰¾ï¼ˆ`data.users[id]`ï¼‰
3. Set membershipï¼ˆ`in`ï¼‰
4. å­—ç¬¦ä¸²æ“ä½œ
5. å¾ªç¯éå†æ”¾æœ€å

### 3. ä½¿ç”¨ç´¢å¼•

**ç´¢å¼•æ¡ä»¶**:
- OPAè‡ªåŠ¨ä¸º `data` åˆ›å»ºç´¢å¼•
- ä½¿ç”¨ç­‰å€¼æŸ¥æ‰¾ `data.users[id]` è€Œé `some user in data.users; user.id == id`

### 4. é¿å…å…¨è¡¨æ‰«æ

```rego
# âŒ é¿å…
some user in data.users
user.name == input.name

# âœ… æ”¹ä¸º
user := data.users_by_name[input.name]
```

### 5. é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„

| æ“ä½œ | æ•°ç»„ | å¯¹è±¡/Set | æ¨è |
|---|---|---|---|
| æŸ¥æ‰¾ | O(n) | O(1) | å¯¹è±¡/Set |
| éå† | O(n) | O(n) | éƒ½å¯ä»¥ |
| é¡ºåºé‡è¦ | âœ… | âŒ | æ•°ç»„ |

---

## ğŸ”§ æ€§èƒ½åˆ†æå·¥å…·

### ä½¿ç”¨ `--profile` æ ‡å¿—

```bash
opa eval --profile -d policy.rego -i input.json "data.authz.allow"
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
+----------+----------+----------+---------+
|   TIME   | NUM EVAL | NUM REDO | LOCATION|
+----------+----------+----------+---------+
| 45.2ms   | 1        | 1        | data.authz.allow
| 40.1ms   | 1000     | 1000     | data.users[_]  <-- ç“¶é¢ˆï¼
| 5ms      | 100      | 0        | ...
+----------+----------+----------+---------+
```

**å…³é”®æŒ‡æ ‡**:
- **TIME**: è€—æ—¶ï¼ˆæ‰¾æœ€å¤§çš„ï¼‰
- **NUM EVAL**: è¯„ä¼°æ¬¡æ•°ï¼ˆè¶Šå°è¶Šå¥½ï¼‰
- **NUM REDO**: å›æº¯æ¬¡æ•°ï¼ˆè¶Šå°è¶Šå¥½ï¼‰

### ä½¿ç”¨ `opa bench`

```bash
opa bench \
    -d policy.rego \
    -i input.json \
    --count 10000 \
    --format json \
    "data.authz.allow" \
    | jq '.histogram_timer_opa_rego_query_ns.p99'
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†æ•°æ®

### æµ‹è¯•ç¯å¢ƒ

- **CPU**: Intel i7-9750H @ 2.6GHz
- **å†…å­˜**: 16GB
- **OPAç‰ˆæœ¬**: v0.68+
- **æ•°æ®è§„æ¨¡**: 1000ç”¨æˆ·ï¼Œæ¯ç”¨æˆ·10ä¸ªæƒé™

### åŸºå‡†ç»“æœ

| ç‰ˆæœ¬ | QPS | P50 | P99 | è¯´æ˜ |
|---|---|---|---|---|
| **æ…¢ç‰ˆæœ¬** | 100 | 50ms | 150ms | å…¨è¡¨æ‰«æ |
| **å¿«ç‰ˆæœ¬** | 10,000 | 0.5ms | 1.5ms | ç´¢å¼•ä¼˜åŒ– |
| **æå‡** | **100x** | **100x** | **100x** | ğŸš€ |

---

## ğŸ” æ‰©å±•ç»ƒä¹ 

### ç»ƒä¹ 1ï¼šåˆ†æç“¶é¢ˆ

ä½¿ç”¨ `--profile` åˆ†æä»¥ä¸‹ç­–ç•¥çš„ç“¶é¢ˆï¼š

```rego
package exercise1

allow if {
    some user in data.users
    some role in user.roles
    some perm in data.role_permissions[role]
    perm == input.required_permission
}
```

**æç¤º**: æ‰¾å‡ºåµŒå¥—å¾ªç¯å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚

### ç»ƒä¹ 2ï¼šä¼˜åŒ–å¤æ‚æŸ¥è¯¢

ä¼˜åŒ–ä»¥ä¸‹ç­–ç•¥ï¼ˆæ¶‰åŠå¤šè¡¨å…³è”ï¼‰ï¼š

```rego
package exercise2

allow if {
    user := data.users[_]
    user.name == input.user_name
    dept := data.departments[_]
    dept.id == user.department_id
    input.action in dept.allowed_actions
}
```

**æç¤º**: 
1. ä½¿ç”¨ç´¢å¼•é¿å…å…¨è¡¨æ‰«æ
2. è°ƒæ•´æŸ¥è¯¢é¡ºåº
3. é¢„è®¡ç®—éƒ¨é—¨æƒé™

### ç»ƒä¹ 3ï¼šéƒ¨åˆ†æ±‚å€¼

ä½¿ç”¨ `opa build` çš„éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–ï¼š

```bash
opa build \
    --target wasm \
    --entrypoint authz/allow \
    --optimize 2 \
    --partial \
    -d policy.rego \
    -d data.json
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../../docs/08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)
- [æ€§èƒ½åŸºå‡†ä¸åº¦é‡](../../docs/01-æŠ€æœ¯è§„èŒƒ/01.4-æ€§èƒ½åŸºå‡†ä¸åº¦é‡.md)
- [ç´¢å¼•ä¸ä¼˜åŒ–](../../docs/03-å®ç°æ¶æ„/03.5-ç´¢å¼•ä¸ä¼˜åŒ–.md)
- [éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯](../../docs/03-å®ç°æ¶æ„/03.6-éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯.md)

---

## â“ å¸¸è§é—®é¢˜

**Q: ä½•æ—¶éœ€è¦ä¼˜åŒ–ï¼Ÿ**

A: å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶è€ƒè™‘ä¼˜åŒ–ï¼š
- P99å»¶è¿Ÿ > 10ms
- QPS < 1000
- CPUä½¿ç”¨ç‡ > 80%

**Q: ä¼˜åŒ–çš„ä¼˜å…ˆçº§ï¼Ÿ**

A: ä¼˜åŒ–é¡ºåºï¼š
1. ç´¢å¼•ä¼˜åŒ–ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. æŸ¥è¯¢é¡ºåºä¼˜åŒ–
3. æ•°æ®ç»“æ„ä¼˜åŒ–
4. è§„åˆ™ç»“æ„ä¼˜åŒ–

**Q: å¦‚ä½•æƒè¡¡æ€§èƒ½å’Œå¯è¯»æ€§ï¼Ÿ**

A: åŸåˆ™ï¼š
- âœ… ä¼˜å…ˆä¿è¯å¯è¯»æ€§
- âœ… åªä¼˜åŒ–çœŸæ­£çš„ç“¶é¢ˆ
- âœ… æ·»åŠ æ³¨é‡Šè¯´æ˜ä¼˜åŒ–åŸå› 
- âš ï¸ é¿å…è¿‡åº¦ä¼˜åŒ–

---

## ğŸ¯ æ€§èƒ½æ£€æŸ¥æ¸…å•

ä½¿ç”¨è¿™ä¸ªæ¸…å•æ£€æŸ¥ä½ çš„ç­–ç•¥ï¼š

- [ ] ä½¿ç”¨ `--profile` åˆ†æäº†æ€§èƒ½
- [ ] ç­‰å€¼æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•ï¼ˆ`data.users[id]`ï¼‰
- [ ] å»‰ä»·çš„æ£€æŸ¥æ”¾åœ¨å‰é¢
- [ ] é¿å…äº†å…¨è¡¨æ‰«æ
- [ ] é¢‘ç¹æŸ¥è¯¢ä½¿ç”¨Setè€Œéæ•°ç»„
- [ ] é¿å…äº†é‡å¤è®¡ç®—
- [ ] è§„åˆ™ç®€æ´ï¼Œæ— æ·±åº¦åµŒå¥—
- [ ] åœ¨å®é™…æ•°æ®ä¸Šæµ‹è¯•äº†æ€§èƒ½

---

**ä¸‹ä¸€æ­¥**: 
- å®è·µï¼šä¼˜åŒ–ä½ è‡ªå·±çš„ç­–ç•¥
- å­¦ä¹ ï¼š[WASMç¼–è¯‘](../docs/01-æŠ€æœ¯è§„èŒƒ/01.3-WASMç¼–è¯‘è§„èŒƒ.md)è·å¾—æ›´æè‡´æ€§èƒ½
- å‚è€ƒï¼š[SaaS WASMå®æˆ˜](../../docs/09-ç”Ÿäº§å®æˆ˜/09.3-SaaSå¤šç§Ÿæˆ·WASMå®æˆ˜.md)çœ‹ç”Ÿäº§çº§ä¼˜åŒ–

---

**æ€§èƒ½ä¼˜åŒ–çš„é»„é‡‘æ³•åˆ™**: *æµ‹é‡ â†’ ä¼˜åŒ– â†’ éªŒè¯* ğŸ”

