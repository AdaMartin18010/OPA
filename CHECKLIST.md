# OPA生产环境检查清单

> **用途**: 生产环境部署前的完整检查清单  
> **适用**: 所有OPA生产部署场景  
> **版本**: v1.0 (2025-10-21)

---

## 📋 使用说明

在将OPA部署到生产环境之前，请仔细检查以下每一项。建议：

- ✅ **打印**本清单，逐项检查
- ✅ **团队Review**，多人检查
- ✅ **记录证据**，保存检查结果
- ✅ **定期复查**，每季度回顾

---

## 1️⃣ 策略开发阶段

### 1.1 策略设计

- [ ] **需求明确**: 业务需求文档完整
- [ ] **设计评审**: 架构设计通过团队评审
- [ ] **安全评估**: 安全团队审批通过
- [ ] **性能预估**: 完成性能影响评估

### 1.2 代码质量

- [ ] **语法检查**: 所有策略通过`opa check`
- [ ] **格式规范**: 使用`opa fmt`格式化
- [ ] **Rego v1**: 使用`import rego.v1`语法
- [ ] **代码审查**: 至少2人Code Review
- [ ] **静态分析**: 无复杂度告警
- [ ] **命名规范**: 遵循项目命名约定

**验证命令**:
```bash
# 语法检查
opa check --strict policy.rego

# 格式检查
opa fmt -d policy.rego

# 复杂度检查
opa check --metrics policy.rego
```

### 1.3 测试覆盖

- [ ] **单元测试**: 覆盖率≥90%
- [ ] **边界测试**: 覆盖边界条件
- [ ] **负面测试**: 测试拒绝场景
- [ ] **性能测试**: 基准测试通过
- [ ] **集成测试**: 与系统集成测试
- [ ] **压力测试**: 高负载测试通过

**验证命令**:
```bash
# 运行测试
opa test . -v --coverage

# 性能基准
opa bench policy.rego

# 输出覆盖率报告
opa test . --coverage --format=json
```

**覆盖率要求**:
```json
{
  "coverage": {
    "lines": 95.5,  // 目标: ≥90%
    "not_covered": []
  }
}
```

---

## 2️⃣ 部署配置阶段

### 2.1 版本兼容性

- [ ] **OPA版本**: 使用推荐版本(v0.55+)
- [ ] **Rego版本**: 使用v1.0语法
- [ ] **依赖检查**: 所有依赖版本兼容
- [ ] **向后兼容**: 不破坏现有功能
- [ ] **版本文档**: 记录版本要求

**参考**: [VERSION_COMPATIBILITY.md](VERSION_COMPATIBILITY.md)

### 2.2 部署架构

- [ ] **部署模式**: 选择合适模式(Sidecar/集中式/WASM)
- [ ] **高可用**: 至少2个副本
- [ ] **负载均衡**: 配置健康检查
- [ ] **资源限制**: 设置CPU/内存限制
- [ ] **网络策略**: 配置网络隔离
- [ ] **服务发现**: 注册到服务注册中心

**Kubernetes资源配置**:
```yaml
resources:
  requests:
    memory: "128Mi"  # 最小值
    cpu: "100m"      # 最小值
  limits:
    memory: "512Mi"  # 最大值
    cpu: "500m"      # 最大值

replicas: 3          # 最少2个副本
```

### 2.3 策略分发

- [ ] **Bundle配置**: Bundle服务配置正确
- [ ] **签名验证**: 启用Bundle签名验证
- [ ] **更新策略**: 配置合理的轮询间隔
- [ ] **缓存策略**: 启用本地缓存
- [ ] **回滚机制**: 准备回滚方案
- [ ] **版本控制**: Bundle版本化管理

**OPA配置示例**:
```yaml
bundles:
  authz:
    service: bundle-server
    resource: bundles/authz.tar.gz
    signing:
      keyid: my_key
      scope: write
    polling:
      min_delay_seconds: 60
      max_delay_seconds: 120
    persist: true  # 启用持久化
```

---

## 3️⃣ 安全配置阶段

### 3.1 认证授权

- [ ] **API认证**: OPA API启用认证
- [ ] **TLS加密**: 启用TLS/mTLS
- [ ] **证书管理**: 证书有效期>30天
- [ ] **密钥轮转**: 定期轮转密钥
- [ ] **最小权限**: 服务账户最小权限
- [ ] **网络隔离**: 限制网络访问

**TLS配置**:
```yaml
# OPA配置
tls:
  cert_file: /certs/server-cert.pem
  private_key_file: /certs/server-key.pem
  ca_cert_file: /certs/ca-cert.pem
```

### 3.2 数据安全

- [ ] **敏感数据**: 敏感数据加密存储
- [ ] **访问控制**: 限制策略访问权限
- [ ] **审计日志**: 启用审计日志
- [ ] **数据备份**: 定期备份策略和数据
- [ ] **数据脱敏**: 日志中脱敏处理
- [ ] **合规检查**: 通过安全合规审计

### 3.3 漏洞管理

- [ ] **镜像扫描**: 容器镜像无高危漏洞
- [ ] **依赖检查**: 依赖库无已知漏洞
- [ ] **定期更新**: 计划定期更新OPA版本
- [ ] **安全公告**: 订阅OPA安全公告
- [ ] **应急响应**: 准备安全应急预案

---

## 4️⃣ 监控运维阶段

### 4.1 监控指标

- [ ] **性能监控**: P50/P95/P99延迟监控
- [ ] **错误监控**: 错误率监控
- [ ] **资源监控**: CPU/内存/网络监控
- [ ] **业务监控**: 决策分布监控
- [ ] **健康检查**: 配置liveness/readiness
- [ ] **SLO设置**: 定义服务等级目标

**关键指标**:
```promql
# P99延迟
histogram_quantile(0.99, rate(opa_http_request_duration_seconds_bucket[5m]))

# 错误率
rate(opa_http_request_errors_total[5m])

# 内存使用
container_memory_usage_bytes{container="opa"}

# 决策量
rate(opa_decision_total[5m])
```

### 4.2 日志管理

- [ ] **日志级别**: 生产环境使用info级别
- [ ] **结构化日志**: 使用JSON格式
- [ ] **日志收集**: 集成到日志系统
- [ ] **日志保留**: 设置合理保留期
- [ ] **审计日志**: 启用决策日志
- [ ] **日志分析**: 定期分析异常

**日志配置**:
```yaml
# OPA配置
decision_logs:
  console: false
  plugin: decision_logger
  reporting:
    max_decisions_per_second: 100
    upload_size_limit_bytes: 32768

# 只记录拒绝决策
decision_logs:
  console: true
  filter: |
    package system.log
    import rego.v1
    
    mask contains "/health"  # 忽略健康检查
    
    drop if {
        input.result.allow  # 忽略允许决策
    }
```

### 4.3 告警配置

- [ ] **延迟告警**: P99延迟超过阈值
- [ ] **错误告警**: 错误率超过阈值
- [ ] **资源告警**: CPU/内存超过80%
- [ ] **可用性告警**: 健康检查失败
- [ ] **Bundle告警**: Bundle加载失败
- [ ] **告警分级**: 区分critical/warning

**Prometheus告警规则**:
```yaml
groups:
  - name: opa
    rules:
      # 高延迟告警
      - alert: OPAHighLatency
        expr: histogram_quantile(0.99, rate(opa_http_request_duration_seconds_bucket[5m])) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "OPA P99延迟超过10ms"
          description: "当前P99: {{ $value }}s"
      
      # 高错误率告警
      - alert: OPAHighErrorRate
        expr: rate(opa_http_request_errors_total[5m]) / rate(opa_http_request_total[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "OPA错误率超过1%"
      
      # 内存告警
      - alert: OPAHighMemory
        expr: container_memory_usage_bytes{container="opa"} / container_spec_memory_limit_bytes{container="opa"} > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "OPA内存使用超过80%"
      
      # Bundle加载失败
      - alert: OPABundleLoadFailed
        expr: increase(opa_bundle_failed_load_counter[5m]) > 0
        labels:
          severity: critical
        annotations:
          summary: "OPA Bundle加载失败"
```

### 4.4 故障处理

- [ ] **降级方案**: 准备降级策略
- [ ] **回滚流程**: 快速回滚机制
- [ ] **应急文档**: 应急处理文档
- [ ] **值班制度**: 7x24值班安排
- [ ] **故障演练**: 定期故障演练
- [ ] **事后分析**: 故障后复盘

---

## 5️⃣ 文档合规阶段

### 5.1 技术文档

- [ ] **部署文档**: 完整的部署文档
- [ ] **运维手册**: 日常运维手册
- [ ] **故障手册**: 故障处理手册
- [ ] **API文档**: 策略API文档
- [ ] **架构图**: 部署架构图
- [ ] **配置说明**: 配置参数说明

### 5.2 变更管理

- [ ] **变更流程**: 遵循变更管理流程
- [ ] **影响分析**: 完成影响分析
- [ ] **审批记录**: 获得必要审批
- [ ] **通知机制**: 通知相关方
- [ ] **回退计划**: 准备回退计划
- [ ] **变更记录**: 记录变更历史

### 5.3 合规审计

- [ ] **合规要求**: 满足行业合规要求
- [ ] **审计日志**: 完整审计日志
- [ ] **访问控制**: 符合访问控制要求
- [ ] **数据保护**: 符合数据保护法规
- [ ] **审计报告**: 通过合规审计
- [ ] **持续合规**: 定期合规检查

---

## 6️⃣ 性能优化阶段

### 6.1 策略优化

- [ ] **部分求值**: 使用部分求值优化
- [ ] **索引优化**: 数据结构使用索引
- [ ] **缓存策略**: 合理使用缓存
- [ ] **规则简化**: 简化复杂规则
- [ ] **避免遍历**: 减少数组遍历
- [ ] **性能分析**: 使用profiling分析

**优化示例**:
```rego
# ❌ 性能差
permissions := [p | p := data.all_permissions[_]; p.user == input.user]

# ✅ 性能优化：使用索引
permissions := data.permissions_by_user[input.user]
```

### 6.2 部署优化

- [ ] **WASM编译**: 考虑WASM编译
- [ ] **Bundle优化**: 压缩Bundle体积
- [ ] **连接池**: 配置连接池
- [ ] **超时设置**: 合理的超时配置
- [ ] **资源调优**: 调优CPU/内存配置
- [ ] **网络优化**: 优化网络配置

### 6.3 性能目标

- [ ] **延迟目标**: P99延迟<预期值
- [ ] **吞吐目标**: QPS满足需求
- [ ] **资源目标**: CPU/内存在预算内
- [ ] **可用性目标**: 可用性≥99.9%
- [ ] **错误率目标**: 错误率<0.1%
- [ ] **容量规划**: 完成容量规划

**性能基准**:
| 场景 | P99延迟目标 | QPS目标 |
|------|-----------|---------|
| Sidecar | <5ms | 10K+ |
| 集中式 | <10ms | 50K+ |
| WASM | <2ms | 100K+ |

---

## 7️⃣ 灾难恢复阶段

### 7.1 备份策略

- [ ] **策略备份**: 定期备份策略代码
- [ ] **配置备份**: 备份配置文件
- [ ] **数据备份**: 备份决策数据
- [ ] **备份测试**: 定期测试恢复
- [ ] **异地备份**: 多地域备份
- [ ] **自动备份**: 自动化备份流程

### 7.2 容灾方案

- [ ] **多可用区**: 跨可用区部署
- [ ] **多区域**: 跨区域部署(可选)
- [ ] **故障转移**: 自动故障转移
- [ ] **数据同步**: 实时数据同步
- [ ] **容灾演练**: 定期容灾演练
- [ ] **RTO/RPO**: 明确RTO/RPO指标

### 7.3 降级预案

- [ ] **熔断机制**: 配置熔断策略
- [ ] **降级策略**: 准备降级方案
- [ ] **本地缓存**: 启用本地缓存降级
- [ ] **默认策略**: 准备默认策略
- [ ] **手动切换**: 支持手动降级
- [ ] **恢复机制**: 自动恢复机制

---

## ✅ 上线前最终检查

### 关键确认项

- [ ] **所有测试通过**: 单元/集成/性能测试全部通过
- [ ] **安全审计通过**: 安全团队审批
- [ ] **性能达标**: 性能指标符合要求
- [ ] **监控就绪**: 监控告警已配置
- [ ] **文档完整**: 所有文档已更新
- [ ] **团队培训**: 运维团队已培训
- [ ] **应急演练**: 完成应急演练
- [ ] **上线审批**: 获得上线审批

### 上线当天

- [ ] **备份现状**: 备份当前配置
- [ ] **通知相关方**: 通知利益相关方
- [ ] **灰度发布**: 采用灰度发布
- [ ] **实时监控**: 实时监控指标
- [ ] **值班到位**: 值班人员到位
- [ ] **回滚准备**: 回滚方案就绪
- [ ] **沟通渠道**: 沟通渠道畅通

### 上线后

- [ ] **监控观察**: 持续监控24小时
- [ ] **数据分析**: 分析上线数据
- [ ] **问题记录**: 记录遇到的问题
- [ ] **总结会议**: 上线总结会议
- [ ] **文档更新**: 更新相关文档
- [ ] **经验沉淀**: 沉淀经验教训

---

## 📊 检查清单评分

完成度计算：

```
完成度 = (已勾选项 / 总检查项) × 100%

建议：
- ≥95%: 可以上线 ✅
- 85-95%: 补充遗漏项
- <85%: 暂缓上线 ❌
```

---

## 📝 检查记录模板

```markdown
# OPA生产环境检查记录

**项目名称**: _____________
**检查日期**: _____________
**检查人员**: _____________
**审核人员**: _____________

## 检查结果

- 总检查项: ___
- 已完成项: ___
- 未完成项: ___
- 完成度: ___%

## 关键发现

### 通过项
1. 
2. 

### 遗漏项
1. 
2. 

### 风险项
1. 
2. 

## 改进计划

| 项目 | 负责人 | 截止日期 | 状态 |
|------|-------|---------|------|
|      |       |         |      |

## 审批意见

- [ ] 同意上线
- [ ] 补充完善后上线
- [ ] 不同意上线

**签名**: _____________  
**日期**: _____________
```

---

## 🔗 相关资源

- [生产案例集](PRODUCTION_CASES.md)
- [性能优化指南](docs/08-最佳实践/08.2-性能优化指南.md)
- [安全合规标准](docs/01-技术规范/01.5-安全合规标准.md)
- [FAQ](docs/FAQ.md)

---

## 📞 获取帮助

遇到问题？

- 📖 查看文档: [docs/](docs/)
- 💬 提问讨论: [GitHub Discussions](../../discussions)
- 🐛 报告问题: [GitHub Issues](../../issues)

---

**版本**: v1.0  
**维护**: OPA中文文档团队  
**更新**: 每季度review并更新

