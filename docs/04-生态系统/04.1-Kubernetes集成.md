# Kubernetes é›†æˆï¼ˆKubernetes Integrationï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: Kubernetes 1.23+ | OPA v0.55+ | Gatekeeper v3.10+  
> **æ¨èç‰ˆæœ¬**: Kubernetes 1.28+ | OPA v0.68+ | Gatekeeper v3.17+  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯  
> **æˆç†Ÿåº¦**: CNCFæ¯•ä¸šé¡¹ç›®

---

## âš ï¸ ç”Ÿäº§éƒ¨ç½²æç¤º

> **Kubernetesç”Ÿäº§ç¯å¢ƒæ³¨æ„**:
> 
> - âœ… **é«˜å¯ç”¨**: Gatekeeperè‡³å°‘3å‰¯æœ¬ï¼Œè·¨å¯ç”¨åŒºéƒ¨ç½²
> - âœ… **èµ„æºé™åˆ¶**: æ ¹æ®é›†ç¾¤è§„æ¨¡è®¾ç½®åˆç†çš„CPU/å†…å­˜
> - âœ… **å®¡è®¡æ¨¡å¼**: æ–°ç­–ç•¥å…ˆç”¨`audit`æ¨¡å¼éªŒè¯ï¼Œç¨³å®šåæ”¹ä¸º`enforce`
> - âœ… **ç™½åå•**: ä¸ºç³»ç»Ÿå‘½åç©ºé—´ï¼ˆkube-systemç­‰ï¼‰é…ç½®ä¾‹å¤–
> - âœ… **ç›‘æ§å‘Šè­¦**: ç›‘æ§ç­–ç•¥è¿è§„ç‡ã€Webhookå»¶è¿Ÿã€é”™è¯¯ç‡
> - âš ï¸ Admission Webhookå¤±è´¥ä¼šé˜»å¡æ‰€æœ‰èµ„æºåˆ›å»ºï¼ŒåŠ¡å¿…æµ‹è¯•å……åˆ†
> - âš ï¸ ç­–ç•¥æ›´æ–°å¯èƒ½å½±å“ç°æœ‰èµ„æºï¼Œä½¿ç”¨Constraintå®¡è®¡åŠŸèƒ½è¯„ä¼°å½±å“
> 
> ç›¸å…³: [ç”Ÿäº§æ¡ˆä¾‹-é‡‘èK8sç­–ç•¥](../../PRODUCTION_CASES.md#æ¡ˆä¾‹2é‡‘èå…¬å¸kubernetesç­–ç•¥) | [æ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## ç›®å½•

- [Kubernetes é›†æˆï¼ˆKubernetes Integrationï¼‰](#kubernetes-é›†æˆkubernetes-integration)
  - [âš ï¸ ç”Ÿäº§éƒ¨ç½²æç¤º](#ï¸-ç”Ÿäº§éƒ¨ç½²æç¤º)
  - [ç›®å½•](#ç›®å½•)
  - [1. é›†æˆæ¦‚è¿°](#1-é›†æˆæ¦‚è¿°)
    - [1.1 ä¸ºä»€ä¹ˆéœ€è¦OPA in Kubernetes](#11-ä¸ºä»€ä¹ˆéœ€è¦opa-in-kubernetes)
    - [1.2 é›†æˆç‚¹](#12-é›†æˆç‚¹)
    - [1.3 éƒ¨ç½²æ¨¡å¼å¯¹æ¯”](#13-éƒ¨ç½²æ¨¡å¼å¯¹æ¯”)
  - [2. Admission Controlé›†æˆ](#2-admission-controlé›†æˆ)
    - [2.1 æ¶æ„](#21-æ¶æ„)
    - [2.2 Validating Admission Webhook](#22-validating-admission-webhook)
      - [2.2.1 éƒ¨ç½²OPA](#221-éƒ¨ç½²opa)
      - [2.2.2 é…ç½®Webhook](#222-é…ç½®webhook)
      - [2.2.3 ç­–ç•¥ç¤ºä¾‹](#223-ç­–ç•¥ç¤ºä¾‹)
    - [2.3 Mutating Admission Webhook](#23-mutating-admission-webhook)
      - [2.3.1 é…ç½®](#231-é…ç½®)
      - [2.3.2 ç­–ç•¥ç¤ºä¾‹](#232-ç­–ç•¥ç¤ºä¾‹)
  - [3. Gatekeeperé¡¹ç›®](#3-gatekeeperé¡¹ç›®)
    - [3.1 æ¦‚è¿°](#31-æ¦‚è¿°)
    - [3.2 æ ¸å¿ƒæ¦‚å¿µ](#32-æ ¸å¿ƒæ¦‚å¿µ)
      - [3.2.1 ConstraintTemplateï¼ˆçº¦æŸæ¨¡æ¿ï¼‰](#321-constrainttemplateçº¦æŸæ¨¡æ¿)
      - [3.2.2 Constraintï¼ˆçº¦æŸå®ä¾‹ï¼‰](#322-constraintçº¦æŸå®ä¾‹)
    - [3.3 éƒ¨ç½²Gatekeeper](#33-éƒ¨ç½²gatekeeper)
      - [3.3.1 å®‰è£…](#331-å®‰è£…)
      - [3.3.2 éªŒè¯å®‰è£…](#332-éªŒè¯å®‰è£…)
    - [3.4 é¢„å®šä¹‰ç­–ç•¥åº“](#34-é¢„å®šä¹‰ç­–ç•¥åº“)
    - [3.5 å®¡è®¡æ¨¡å¼](#35-å®¡è®¡æ¨¡å¼)
  - [4. å¸¸è§åº”ç”¨åœºæ™¯](#4-å¸¸è§åº”ç”¨åœºæ™¯)
    - [4.1 å®‰å…¨åˆè§„](#41-å®‰å…¨åˆè§„)
      - [4.1.1 ç¦æ­¢ä»¥rootè¿è¡Œ](#411-ç¦æ­¢ä»¥rootè¿è¡Œ)
      - [4.1.2 å¼ºåˆ¶ç½‘ç»œç­–ç•¥](#412-å¼ºåˆ¶ç½‘ç»œç­–ç•¥)
    - [4.2 èµ„æºæ²»ç†](#42-èµ„æºæ²»ç†)
      - [4.2.1 CPU/å†…å­˜é™åˆ¶](#421-cpuå†…å­˜é™åˆ¶)
      - [4.2.2 å‰¯æœ¬æ•°é™åˆ¶](#422-å‰¯æœ¬æ•°é™åˆ¶)
    - [4.3 å‘½åè§„èŒƒ](#43-å‘½åè§„èŒƒ)
      - [4.3.1 èµ„æºå‘½å](#431-èµ„æºå‘½å)
      - [4.3.2 æ ‡ç­¾è§„èŒƒ](#432-æ ‡ç­¾è§„èŒƒ)
  - [5. éƒ¨ç½²æ¶æ„](#5-éƒ¨ç½²æ¶æ„)
    - [5.1 é«˜å¯ç”¨æ¶æ„](#51-é«˜å¯ç”¨æ¶æ„)
    - [5.2 ç­–ç•¥åˆ†å‘](#52-ç­–ç•¥åˆ†å‘)
      - [5.2.1 Bundleæ–¹å¼](#521-bundleæ–¹å¼)
      - [5.2.2 ConfigMapæ–¹å¼](#522-configmapæ–¹å¼)
      - [5.2.3 OCIæ–¹å¼](#523-ociæ–¹å¼)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ€§èƒ½ä¼˜åŒ–](#61-æ€§èƒ½ä¼˜åŒ–)
    - [6.2 å®‰å…¨åŠ å›º](#62-å®‰å…¨åŠ å›º)
    - [6.3 ç›‘æ§ä¸å‘Šè­¦](#63-ç›‘æ§ä¸å‘Šè­¦)
  - [é™„å½•: æ•…éšœæ’æŸ¥](#é™„å½•-æ•…éšœæ’æŸ¥)
    - [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## 1. é›†æˆæ¦‚è¿°

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦OPA in Kubernetes

**ç—›ç‚¹**:

- âœ— åŸç”ŸRBACè¡¨è¾¾èƒ½åŠ›æœ‰é™
- âœ— æ— æ³•è·¨èµ„æºå®æ–½ç­–ç•¥
- âœ— ç¼ºå°‘ç»†ç²’åº¦çš„å­—æ®µçº§æ§åˆ¶
- âœ— éš¾ä»¥å®æ–½ç»„ç»‡çº§åˆè§„è¦æ±‚

**OPAè§£å†³æ–¹æ¡ˆ**:

- âœ“ ç»Ÿä¸€ç­–ç•¥è¯­è¨€ï¼ˆRegoï¼‰
- âœ“ åŠ¨æ€å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰
- âœ“ è¿è¡Œæ—¶ç­–ç•¥æ‰§è¡Œ
- âœ“ å®¡è®¡ä¸åˆè§„æŠ¥å‘Š

---

### 1.2 é›†æˆç‚¹

```mermaid
graph LR
    A[kubectl] -->|Create Pod| B[API Server]
    B --> C{Admission Control}
    C -->|Mutating| D[OPA Mutating Webhook]
    C -->|Validating| E[OPA Validating Webhook]
    D --> F{Policy Decision}
    E --> F
    F -->|Allow| G[Persist to etcd]
    F -->|Deny| H[Reject Request]
```

**é›†æˆå±‚æ¬¡**:

1. **Admission Webhook**: å‡†å…¥æ§åˆ¶ï¼ˆä¸»è¦ï¼‰
2. **Authorization Webhook**: æˆæƒå†³ç­–
3. **Audit Webhook**: å®¡è®¡æ—¥å¿—
4. **Sidecar Injector**: æ³¨å…¥ç­–ç•¥ä»£ç†

---

### 1.3 éƒ¨ç½²æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | æ¶æ„ | é€‚ç”¨åœºæ™¯ | æˆç†Ÿåº¦ |
|------|------|---------|--------|
| **OPA Sidecar** | æ¯Podä¸€OPA | åº”ç”¨çº§ç­–ç•¥ | ğŸŸ¢ ç”Ÿäº§ |
| **OPA Admission** | é›†ç¾¤çº§OPA | å‡†å…¥æ§åˆ¶ | ğŸŸ¢ ç”Ÿäº§ |
| **Gatekeeper** | CRD+OPA | åˆè§„ç®¡ç† | ğŸŸ¢ CNCFæ¯•ä¸š |
| **Kyverno** | çº¯K8såŸç”Ÿ | ç®€å•ç­–ç•¥ | ğŸŸ¡ ç«å“ |

---

## 2. Admission Controlé›†æˆ

### 2.1 æ¶æ„

**ç»„ä»¶**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Kubernetes API Server            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Mutating             â”‚ Validating
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPA Mutating    â”‚   â”‚ OPA Validating  â”‚
â”‚ Webhook         â”‚   â”‚ Webhook         â”‚
â”‚ (ä¿®æ”¹èµ„æº)       â”‚   â”‚ (éªŒè¯èµ„æº)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    OPA Engine       â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
         â”‚  â”‚  Rego Policy  â”‚  â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 Validating Admission Webhook

**ç”¨é€”**: éªŒè¯èµ„æºæ˜¯å¦ç¬¦åˆç­–ç•¥ï¼Œæ‹’ç»ä¸åˆè§„è¯·æ±‚ã€‚

#### 2.2.1 éƒ¨ç½²OPA

**Deployment**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opa
  namespace: opa
spec:
  replicas: 3
  selector:
    matchLabels:
      app: opa
  template:
    metadata:
      labels:
        app: opa
    spec:
      containers:
      - name: opa
        image: openpolicyagent/opa:0.60.0
        args:
          - "run"
          - "--server"
          - "--addr=:8181"
          - "--diagnostic-addr=:8282"
          - "--bundle=/policies"
          - "--log-level=debug"
        ports:
        - containerPort: 8181
          name: https
        - containerPort: 8282
          name: diagnostics
        volumeMounts:
        - name: policies
          mountPath: /policies
        livenessProbe:
          httpGet:
            path: /health
            port: 8282
          initialDelaySeconds: 5
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /health?bundle=true
            port: 8282
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: policies
        configMap:
          name: opa-policies
```

**Service**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: opa
  namespace: opa
spec:
  selector:
    app: opa
  ports:
  - name: https
    port: 443
    targetPort: 8181
```

#### 2.2.2 é…ç½®Webhook

**ValidatingWebhookConfiguration**:

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: opa-validating-webhook
webhooks:
- name: validating.opa.io
  clientConfig:
    service:
      name: opa
      namespace: opa
      path: "/v1/data/kubernetes/admission/deny"
    caBundle: <BASE64_CA_CERT>
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["*"]
    apiVersions: ["*"]
    resources: ["pods", "deployments", "services"]
  admissionReviewVersions: ["v1"]
  sideEffects: None
  failurePolicy: Fail  # or Ignore
  namespaceSelector:
    matchExpressions:
    - key: opa-admission
      operator: NotIn
      values: ["ignore"]
```

**å…³é”®å­—æ®µ**:

- `failurePolicy`: `Fail`ï¼ˆæ‹’ç»ï¼‰æˆ– `Ignore`ï¼ˆè·³è¿‡ï¼‰
- `namespaceSelector`: æ’é™¤ç³»ç»Ÿå‘½åç©ºé—´
- `path`: ç­–ç•¥æŸ¥è¯¢è·¯å¾„

#### 2.2.3 ç­–ç•¥ç¤ºä¾‹

**ç¦æ­¢ç‰¹æƒå®¹å™¨**:

```rego
package kubernetes.admission

import future.keywords.if
import future.keywords.contains

deny contains msg if {
    input.request.kind.kind == "Pod"
    container := input.request.object.spec.containers[_]
    container.securityContext.privileged == true
    msg := sprintf("Privilegedå®¹å™¨è¢«ç¦æ­¢: %v", [container.name])
}
```

**è¦æ±‚èµ„æºé™åˆ¶**:

```rego
deny contains msg if {
    input.request.kind.kind == "Pod"
    container := input.request.object.spec.containers[_]
    not container.resources.limits
    msg := sprintf("å®¹å™¨ %v å¿…é¡»è®¾ç½®èµ„æºé™åˆ¶", [container.name])
}
```

**é•œåƒä»“åº“ç™½åå•**:

```rego
allowed_registries := [
    "gcr.io",
    "docker.io/library",
    "mycompany.azurecr.io"
]

deny contains msg if {
    input.request.kind.kind == "Pod"
    container := input.request.object.spec.containers[_]
    image := container.image
    not image_from_allowed_registry(image)
    msg := sprintf("é•œåƒ %v æ¥è‡ªæœªæˆæƒä»“åº“", [image])
}

image_from_allowed_registry(image) if {
    some registry in allowed_registries
    startswith(image, registry)
}
```

---

### 2.3 Mutating Admission Webhook

**ç”¨é€”**: è‡ªåŠ¨ä¿®æ”¹èµ„æºï¼Œæ³¨å…¥sidecarã€æ ‡ç­¾ç­‰ã€‚

#### 2.3.1 é…ç½®

**MutatingWebhookConfiguration**:

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: opa-mutating-webhook
webhooks:
- name: mutating.opa.io
  clientConfig:
    service:
      name: opa
      namespace: opa
      path: "/v1/data/kubernetes/admission/mutate"
    caBundle: <BASE64_CA_CERT>
  rules:
  - operations: ["CREATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  admissionReviewVersions: ["v1"]
  sideEffects: None
  failurePolicy: Fail
```

#### 2.3.2 ç­–ç•¥ç¤ºä¾‹

**è‡ªåŠ¨æ·»åŠ æ ‡ç­¾**:

```rego
package kubernetes.admission

import future.keywords.if

mutate contains patch if {
    input.request.kind.kind == "Pod"
    not input.request.object.metadata.labels.team
    patch := {
        "op": "add",
        "path": "/metadata/labels/team",
        "value": "default"
    }
}
```

**æ³¨å…¥Sidecarå®¹å™¨**:

```rego
mutate contains patch if {
    input.request.kind.kind == "Pod"
    input.request.object.metadata.annotations["inject-sidecar"] == "true"
    patch := {
        "op": "add",
        "path": "/spec/containers/-",
        "value": {
            "name": "logging-sidecar",
            "image": "fluentd:v1.14",
            "resources": {
                "limits": {"memory": "100Mi"}
            }
        }
    }
}
```

**è¿”å›æ ¼å¼**ï¼ˆJSON Patch RFC 6902ï¼‰:

```json
{
    "apiVersion": "admission.k8s.io/v1",
    "kind": "AdmissionReview",
    "response": {
        "uid": "<request-uid>",
        "allowed": true,
        "patchType": "JSONPatch",
        "patch": "W3sib3AiOiAiYWRkIiwgInBhdGgiOi..."  // Base64ç¼–ç 
    }
}
```

---

## 3. Gatekeeperé¡¹ç›®

### 3.1 æ¦‚è¿°

**Gatekeeper** = OPA + Kubernetes CRD + çº¦æŸæ¡†æ¶

**ä¼˜åŠ¿**:

- âœ“ åŸç”ŸKubernetesä½“éªŒï¼ˆCRDï¼‰
- âœ“ é¢„å®šä¹‰ç­–ç•¥åº“ï¼ˆ200+ templatesï¼‰
- âœ“ å®¡è®¡æ¨¡å¼ï¼ˆå‘ç°è€Œéé˜»æ­¢ï¼‰
- âœ“ è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

**GitHub**: <https://github.com/open-policy-agent/gatekeeper>

---

### 3.2 æ ¸å¿ƒæ¦‚å¿µ

#### 3.2.1 ConstraintTemplateï¼ˆçº¦æŸæ¨¡æ¿ï¼‰

**å®šä¹‰**: å¯å¤ç”¨çš„ç­–ç•¥æ¨¡æ¿ï¼ˆRego + CRD Schemaï¼‰ã€‚

**ç¤ºä¾‹**:

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items:
                type: string
  targets:
  - target: admission.k8s.gatekeeper.sh
    rego: |
      package k8srequiredlabels

      import future.keywords.if

      violation[{"msg": msg, "details": {"missing_labels": missing}}] if {
        provided := {label | input.review.object.metadata.labels[label]}
        required := {label | label := input.parameters.labels[_]}
        missing := required - provided
        count(missing) > 0
        msg := sprintf("ç¼ºå°‘å¿…éœ€æ ‡ç­¾: %v", [missing])
      }
```

**ç»„æˆ**:

- `crd.spec`: CRDå®šä¹‰ï¼ˆå‚æ•° schemaï¼‰
- `targets[].rego`: Regoç­–ç•¥é€»è¾‘

#### 3.2.2 Constraintï¼ˆçº¦æŸå®ä¾‹ï¼‰

**å®šä¹‰**: ConstraintTemplate çš„å®ä¾‹åŒ–ï¼ŒæŒ‡å®šå‚æ•°ã€‚

**ç¤ºä¾‹**:

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: pod-must-have-team-label
spec:
  match:
    kinds:
    - apiGroups: [""]
      kinds: ["Pod"]
  parameters:
    labels:
    - "team"
    - "app"
```

---

### 3.3 éƒ¨ç½²Gatekeeper

#### 3.3.1 å®‰è£…

**Helmå®‰è£…**:

```bash
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm install gatekeeper/gatekeeper \
    --name-template=gatekeeper \
    --namespace gatekeeper-system \
    --create-namespace
```

**Manifestå®‰è£…**:

```bash
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.15/deploy/gatekeeper.yaml
```

#### 3.3.2 éªŒè¯å®‰è£…

```bash
kubectl get pods -n gatekeeper-system
# è¾“å‡º:
# NAME                                             READY   STATUS
# gatekeeper-audit-66c8f6f7d9-xxxxx               1/1     Running
# gatekeeper-controller-manager-5d7f96d9b7-xxxxx  1/1     Running
# gatekeeper-controller-manager-5d7f96d9b7-yyyyy  1/1     Running
```

---

### 3.4 é¢„å®šä¹‰ç­–ç•¥åº“

**PSPï¼ˆPod Security Policyï¼‰æ›¿ä»£**:

```yaml
# ç¦æ­¢ç‰¹æƒå®¹å™¨
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spsprivilegedcontainer
# ... (200è¡ŒRego)
```

**å¸¸ç”¨æ¨¡æ¿**:

| æ¨¡æ¿ | ç”¨é€” |
|------|------|
| `K8sRequiredLabels` | å¿…éœ€æ ‡ç­¾ |
| `K8sBlockNodePort` | ç¦æ­¢NodePort |
| `K8sImageDigests` | è¦æ±‚é•œåƒæ‘˜è¦ |
| `K8sRequiredResources` | å¿…éœ€èµ„æºé™åˆ¶ |
| `K8sDisallowedTags` | ç¦æ­¢latestæ ‡ç­¾ |

**åº“åœ°å€**: <https://github.com/open-policy-agent/gatekeeper-library>

---

### 3.5 å®¡è®¡æ¨¡å¼

**Audit Controller**: å®šæœŸæ‰«æç°æœ‰èµ„æºï¼ŒæŠ¥å‘Šè¿è§„ã€‚

**å¯ç”¨å®¡è®¡**:

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: pod-must-have-team-label
spec:
  enforcementAction: dryrun  # æˆ– deny/warn
  ...
```

**æŸ¥çœ‹è¿è§„**:

```bash
kubectl get k8srequiredlabels pod-must-have-team-label -o yaml
```

**Statuså­—æ®µ**:

```yaml
status:
  totalViolations: 5
  violations:
  - enforcementAction: dryrun
    kind: Pod
    message: "ç¼ºå°‘å¿…éœ€æ ‡ç­¾: {team}"
    name: bad-pod
    namespace: default
```

---

## 4. å¸¸è§åº”ç”¨åœºæ™¯

### 4.1 å®‰å…¨åˆè§„

#### 4.1.1 ç¦æ­¢ä»¥rootè¿è¡Œ

```rego
package security

import future.keywords.if

violation[{"msg": msg}] if {
    not input.review.object.spec.securityContext.runAsNonRoot
    msg := "Podå¿…é¡»ä»¥érootç”¨æˆ·è¿è¡Œ"
}
```

#### 4.1.2 å¼ºåˆ¶ç½‘ç»œç­–ç•¥

```rego
violation[{"msg": msg}] if {
    input.review.kind.kind == "Pod"
    namespace := input.review.namespace
    not has_network_policy(namespace)
    msg := sprintf("å‘½åç©ºé—´ %v å¿…é¡»æœ‰NetworkPolicy", [namespace])
}

has_network_policy(ns) if {
    some policy in data.kubernetes.networkpolicies
    policy.metadata.namespace == ns
}
```

---

### 4.2 èµ„æºæ²»ç†

#### 4.2.1 CPU/å†…å­˜é™åˆ¶

```rego
violation[{"msg": msg}] if {
    container := input.review.object.spec.containers[_]
    not container.resources.limits.memory
    msg := sprintf("å®¹å™¨ %v å¿…é¡»è®¾ç½®å†…å­˜é™åˆ¶", [container.name])
}

violation[{"msg": msg}] if {
    container := input.review.object.spec.containers[_]
    memory_limit := container.resources.limits.memory
    memory_limit_bytes := parse_quantity(memory_limit)
    memory_limit_bytes > 2 * 1024 * 1024 * 1024  # 2Gi
    msg := sprintf("å®¹å™¨ %v å†…å­˜é™åˆ¶ä¸èƒ½è¶…è¿‡2Gi", [container.name])
}
```

#### 4.2.2 å‰¯æœ¬æ•°é™åˆ¶

```rego
violation[{"msg": msg}] if {
    input.review.kind.kind == "Deployment"
    replicas := input.review.object.spec.replicas
    replicas > 10
    msg := sprintf("Deploymentå‰¯æœ¬æ•°ä¸èƒ½è¶…è¿‡10ï¼Œå½“å‰ä¸º %v", [replicas])
}
```

---

### 4.3 å‘½åè§„èŒƒ

#### 4.3.1 èµ„æºå‘½å

```rego
violation[{"msg": msg}] if {
    name := input.review.object.metadata.name
    not re_match("^[a-z0-9]([-a-z0-9]*[a-z0-9])?$", name)
    msg := sprintf("èµ„æºå %v ä¸ç¬¦åˆå‘½åè§„èŒƒ", [name])
}
```

#### 4.3.2 æ ‡ç­¾è§„èŒƒ

```rego
required_labels := ["app", "team", "env"]

violation[{"msg": msg}] if {
    labels := input.review.object.metadata.labels
    some required_label in required_labels
    not labels[required_label]
    msg := sprintf("ç¼ºå°‘å¿…éœ€æ ‡ç­¾: %v", [required_label])
}
```

---

## 5. éƒ¨ç½²æ¶æ„

### 5.1 é«˜å¯ç”¨æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Kubernetes API Server (HA)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  LoadBalancer       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ OPA-1   â”‚   â”‚ OPA-2  â”‚   â”‚ OPA-3  â”‚
â”‚ Pod     â”‚   â”‚ Pod    â”‚   â”‚ Pod    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  Bundle Server â”‚
           â”‚  (S3/OCI/Git)  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®**:

```yaml
spec:
  replicas: 3
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - opa
        topologyKey: kubernetes.io/hostname
```

---

### 5.2 ç­–ç•¥åˆ†å‘

#### 5.2.1 Bundleæ–¹å¼

**Bundle Server**:

```yaml
services:
  - name: bundle-server
    url: https://bundle.example.com
bundles:
  authz:
    service: bundle-server
    resource: bundles/kubernetes.tar.gz
    polling:
      min_delay_seconds: 10
      max_delay_seconds: 30
```

#### 5.2.2 ConfigMapæ–¹å¼

```bash
kubectl create configmap opa-policies \
    --from-file=policy.rego \
    --namespace=opa
```

#### 5.2.3 OCIæ–¹å¼

```yaml
bundles:
  authz:
    resource: ghcr.io/myorg/opa-policies:latest
    persist: true
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ€§èƒ½ä¼˜åŒ–

**1. ä½¿ç”¨namespaceSelectorå‡å°‘è°ƒç”¨**:

```yaml
namespaceSelector:
  matchExpressions:
  - key: policy-enabled
    operator: In
    values: ["true"]
```

**2. åˆç†è®¾ç½®failurePolicy**:

```yaml
failurePolicy: Ignore  # ç”Ÿäº§ç¯å¢ƒå»ºè®® Fail
```

**3. å¯ç”¨ç¼“å­˜**:

```yaml
args:
  - "--decision-logs-reporting-timeout=10s"
  - "--decision-logs-reporting-interval=5s"
```

---

### 6.2 å®‰å…¨åŠ å›º

**1. å¯ç”¨TLS**:

```bash
# ç”Ÿæˆè¯ä¹¦
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# åˆ›å»ºSecret
kubectl create secret tls opa-tls \
    --cert=cert.pem \
    --key=key.pem \
    --namespace=opa
```

**2. RBACæœ€å°æƒé™**:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: opa
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["get", "list", "watch"]  # åªè¯»
```

---

### 6.3 ç›‘æ§ä¸å‘Šè­¦

**PrometheusæŒ‡æ ‡**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: opa-metrics
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8282"
spec:
  selector:
    app: opa
  ports:
  - port: 8282
    name: metrics
```

**å…³é”®æŒ‡æ ‡**:

- `http_request_duration_seconds`: Webhookå»¶è¿Ÿ
- `opa_policy_evaluation_total`: ç­–ç•¥æ±‚å€¼æ¬¡æ•°
- `admission_webhook_request_total`: Webhookè¯·æ±‚æ€»æ•°

**å‘Šè­¦è§„åˆ™**:

```yaml
- alert: OPAWebhookHighLatency
  expr: histogram_quantile(0.99, http_request_duration_seconds_bucket{handler="webhook"}) > 0.1
  for: 5m
  annotations:
    summary: "OPA Webhookå»¶è¿Ÿè¶…è¿‡100ms"
```

---

## é™„å½•: æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. Webhookè¶…æ—¶**:

```bash
# æ£€æŸ¥OPAæ—¥å¿—
kubectl logs -n opa -l app=opa --tail=100

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
kubectl run test --image=busybox --rm -it -- wget -O- http://opa.opa.svc:8181/health
```

**2. ç­–ç•¥ä¸ç”Ÿæ•ˆ**:

```bash
# æ£€æŸ¥ç­–ç•¥æ˜¯å¦åŠ è½½
curl http://localhost:8181/v1/policies

# æµ‹è¯•ç­–ç•¥
opa eval --bundle /policies 'data.kubernetes.admission.deny' -i input.json
```

**3. è¯ä¹¦é—®é¢˜**:

```bash
# éªŒè¯è¯ä¹¦
openssl x509 -in cert.pem -text -noout

# é‡æ–°ç”ŸæˆCA Bundle
kubectl get secret opa-tls -n opa -o jsonpath='{.data.ca\.crt}' | base64 -d
```

---

**ä¸‹ä¸€ç¯‡**: [04.2-Gatekeeperè¯¦è§£](./04.2-Gatekeeperè¯¦è§£.md)  
**ç›¸å…³**: [05.3-åˆè§„æ€§æ£€æŸ¥](../05-åº”ç”¨åœºæ™¯/05.3-åˆè§„æ€§æ£€æŸ¥.md)
