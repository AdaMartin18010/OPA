# Gatekeeper è¯¦è§£ï¼ˆOPA Gatekeeper Deep Diveï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: Gatekeeper v3.10+ | æ¨è v3.18+  
> **Kubernetesç‰ˆæœ¬**: 1.25+ | æ¨è 1.30+  
> **é¡¹ç›®çŠ¶æ€**: âœ… CNCFæ¯•ä¸šé¡¹ç›®  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯  
> **å‚è€ƒ**: <https://open-policy-agent.github.io/gatekeeper/>

---

## ğŸ›¡ï¸ Gatekeeperç”Ÿäº§éƒ¨ç½²

> **æ ¸å¿ƒèƒ½åŠ›**:
>
> - âœ… K8såŸç”Ÿé›†æˆï¼ˆAdmission Webhookï¼‰
> - âœ… CRDé©±åŠ¨ç­–ç•¥ç®¡ç†ï¼ˆConstraintTemplate + Constraintï¼‰
> - âœ… å®¡è®¡æ¨¡å¼ï¼ˆAudit Modeï¼‰æ£€æµ‹ç°æœ‰è¿è§„
> - âœ… å˜æ›´é›†ï¼ˆMutationï¼‰èƒ½åŠ›
>
> **ç”Ÿäº§ç¯å¢ƒå»ºè®®**:
>
> - âš ï¸ **å…ˆç”¨Auditæ¨¡å¼**éªŒè¯ç­–ç•¥ï¼Œé¿å…è¯¯æ‹¦æˆª
> - âš ï¸ é…ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆå»ºè®®3-5sï¼‰
> - âœ… ç›‘æ§Webhookå»¶è¿Ÿå’Œé”™è¯¯ç‡
> - âœ… ä½¿ç”¨`enforcementAction: dryrun`æµ‹è¯•æ–°ç­–ç•¥
> - âœ… å®šæœŸå®¡è®¡è¿è§„èµ„æºï¼ˆæ¯æ—¥/æ¯å‘¨ï¼‰
>
> å®æˆ˜: [K8sé›†æˆ](04.1-Kubernetesé›†æˆ.md) | [é‡‘èK8sæ¡ˆä¾‹](../../PRODUCTION_CASES.md#æ¡ˆä¾‹2é‡‘èå…¬å¸kubernetesç­–ç•¥) | [éƒ¨ç½²æ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## ğŸ“ English Summary

In-depth guide to OPA Gatekeeper, the Kubernetes-native policy enforcement solution.

**Key Topics**:

- **Architecture**: Policy Controller pattern, CRD-driven configuration
- **ConstraintTemplates**: Reusable policy definitions with parameters
- **Constraints**: Policy instances with specific configuration
- **Audit Mode**: Continuous compliance scanning for existing resources
- **Mutation**: Resource modification capabilities (Gatekeeper v3.4+)
- **Production**: High availability, monitoring, troubleshooting

**Target Audience**: Kubernetes administrators, platform engineers enforcing cluster policies.

**Version**: Gatekeeper v3.10+ (Recommended: v3.18+), CNCF Graduated Project

---

## ç›®å½•

- [Gatekeeper è¯¦è§£ï¼ˆOPA Gatekeeper Deep Diveï¼‰](#gatekeeper-è¯¦è§£opa-gatekeeper-deep-dive)
  - [ğŸ›¡ï¸ Gatekeeperç”Ÿäº§éƒ¨ç½²](#ï¸-gatekeeperç”Ÿäº§éƒ¨ç½²)
  - [ğŸ“ English Summary](#-english-summary)
  - [ç›®å½•](#ç›®å½•)
  - [1. Gatekeeperæ¦‚è¿°](#1-gatekeeperæ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯Gatekeeper](#11-ä»€ä¹ˆæ˜¯gatekeeper)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 æ¶æ„è®¾è®¡](#13-æ¶æ„è®¾è®¡)
  - [2. æ ¸å¿ƒæ¦‚å¿µ](#2-æ ¸å¿ƒæ¦‚å¿µ)
    - [2.1 ConstraintTemplate](#21-constrainttemplate)
    - [2.2 Constraint](#22-constraint)
    - [2.3 Audit](#23-audit)
  - [3. å®‰è£…éƒ¨ç½²](#3-å®‰è£…éƒ¨ç½²)
    - [3.1 Helmå®‰è£…](#31-helmå®‰è£…)
    - [3.2 Kubectlå®‰è£…](#32-kubectlå®‰è£…)
    - [3.3 éªŒè¯å®‰è£…](#33-éªŒè¯å®‰è£…)
  - [4. ç­–ç•¥ç¼–å†™](#4-ç­–ç•¥ç¼–å†™)
    - [4.1 åˆ›å»ºConstraintTemplate](#41-åˆ›å»ºconstrainttemplate)
    - [4.2 åˆ›å»ºConstraint](#42-åˆ›å»ºconstraint)
    - [4.3 æµ‹è¯•ç­–ç•¥](#43-æµ‹è¯•ç­–ç•¥)
  - [5. å†…ç½®Constraints](#5-å†…ç½®constraints)
    - [5.1 å¸¸ç”¨Constraints](#51-å¸¸ç”¨constraints)
    - [5.2 Podå®‰å…¨](#52-podå®‰å…¨)
    - [5.3 èµ„æºé™åˆ¶](#53-èµ„æºé™åˆ¶)
  - [6. é«˜çº§ç‰¹æ€§](#6-é«˜çº§ç‰¹æ€§)
    - [6.1 Mutation](#61-mutation)
    - [6.2 External Data](#62-external-data)
    - [6.3 Sync](#63-sync)
  - [7. å®¡è®¡æ¨¡å¼](#7-å®¡è®¡æ¨¡å¼)
    - [7.1 å®¡è®¡é…ç½®](#71-å®¡è®¡é…ç½®)
    - [7.2 è¿è§„æŠ¥å‘Š](#72-è¿è§„æŠ¥å‘Š)
    - [7.3 æŒç»­åˆè§„](#73-æŒç»­åˆè§„)
  - [8. æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)
    - [8.1 èµ„æºé…ç½®](#81-èµ„æºé…ç½®)
    - [8.2 ç­–ç•¥ä¼˜åŒ–](#82-ç­–ç•¥ä¼˜åŒ–)
    - [8.3 ç¼“å­˜ç­–ç•¥](#83-ç¼“å­˜ç­–ç•¥)
  - [9. ç›‘æ§å‘Šè­¦](#9-ç›‘æ§å‘Šè­¦)
    - [9.1 Metrics](#91-metrics)
    - [9.2 æ—¥å¿—](#92-æ—¥å¿—)
    - [9.3 å‘Šè­¦è§„åˆ™](#93-å‘Šè­¦è§„åˆ™)
  - [10. æœ€ä½³å®è·µ](#10-æœ€ä½³å®è·µ)
    - [10.1 ç­–ç•¥ç»„ç»‡](#101-ç­–ç•¥ç»„ç»‡)
    - [10.2 æµ‹è¯•ç­–ç•¥](#102-æµ‹è¯•ç­–ç•¥)
    - [10.3 æ•…éšœæ’æŸ¥](#103-æ•…éšœæ’æŸ¥)
  - [é™„å½•Aï¼šå¸¸ç”¨ç­–ç•¥åº“](#é™„å½•aå¸¸ç”¨ç­–ç•¥åº“)
  - [é™„å½•Bï¼šæ•…éšœæ’æŸ¥æ¸…å•](#é™„å½•bæ•…éšœæ’æŸ¥æ¸…å•)

---

## 1. Gatekeeperæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯Gatekeeper

**å®šä¹‰**ï¼š

```text
Gatekeeper = OPA + Kubernetes Admission Controller

ä½œç”¨:
  - ç­–ç•¥å³ä»£ç  (Policy as Code)
  - å‡†å…¥æ§åˆ¶ (Admission Control)
  - å®¡è®¡åˆè§„ (Audit & Compliance)
  - å˜æ›´ç®¡ç† (Mutation)
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Kubernetes API Server           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ Admission Request
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Gatekeeper                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Validation                     â”‚  â”‚
â”‚  â”‚     æ£€æŸ¥èµ„æºæ˜¯å¦ç¬¦åˆç­–ç•¥             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  2. Mutation (å¯é€‰)                â”‚  â”‚
â”‚  â”‚     è‡ªåŠ¨ä¿®æ”¹èµ„æºä»¥ç¬¦åˆç­–ç•¥           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  3. Audit                          â”‚  â”‚
â”‚  â”‚     æ£€æŸ¥ç°æœ‰èµ„æºçš„åˆè§„æ€§             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ Allow/Deny
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Resource Created/Updated        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒä»·å€¼

**ä¼ä¸šçº§ç­–ç•¥ç®¡ç†**ï¼š

```text
1. å®‰å…¨åˆè§„
   â”œâ”€â”€ é•œåƒå®‰å…¨æ‰«æ
   â”œâ”€â”€ ç¦æ­¢ç‰¹æƒå®¹å™¨
   â”œâ”€â”€ ç½‘ç»œç­–ç•¥å¼ºåˆ¶
   â””â”€â”€ å¯†é’¥ç®¡ç†

2. èµ„æºæ²»ç†
   â”œâ”€â”€ CPU/å†…å­˜é™åˆ¶
   â”œâ”€â”€ å­˜å‚¨é…é¢
   â”œâ”€â”€ å‰¯æœ¬æ•°é™åˆ¶
   â””â”€â”€ æ ‡ç­¾è§„èŒƒ

3. è¿ç»´æ ‡å‡†
   â”œâ”€â”€ å‘½åè§„èŒƒ
   â”œâ”€â”€ æ ‡ç­¾æ ‡å‡†åŒ–
   â”œâ”€â”€ æ³¨è§£è¦æ±‚
   â””â”€â”€ æœ€ä½³å®è·µ

4. å¤šç§Ÿæˆ·éš”ç¦»
   â”œâ”€â”€ å‘½åç©ºé—´éš”ç¦»
   â”œâ”€â”€ èµ„æºé…é¢
   â”œâ”€â”€ RBACç­–ç•¥
   â””â”€â”€ ç½‘ç»œéš”ç¦»
```

### 1.3 æ¶æ„è®¾è®¡

**ç»„ä»¶æ¶æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gatekeeper Components               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Controller Manager                â”‚    â”‚
â”‚  â”‚  - Webhook Management              â”‚    â”‚
â”‚  â”‚  - Constraint Processing           â”‚    â”‚
â”‚  â”‚  - Template Compilation            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Audit Controller                  â”‚    â”‚
â”‚  â”‚  - Periodic Scans                  â”‚    â”‚
â”‚  â”‚  - Violation Detection             â”‚    â”‚
â”‚  â”‚  - Report Generation               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Webhook Server                    â”‚    â”‚
â”‚  â”‚  - Admission Review                â”‚    â”‚
â”‚  â”‚  - Policy Evaluation (OPA)         â”‚    â”‚
â”‚  â”‚  - Response Generation             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 ConstraintTemplate

**å®šä¹‰æ¨¡æ¿**ï¼š

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        # æ¨¡æ¿å‚æ•°å®šä¹‰
        openAPIV3Schema:
          type: object
          properties:
            labels:
              type: array
              items:
                type: string
  
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels

        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("ç¼ºå°‘å¿…éœ€æ ‡ç­¾: %v", [missing])
        }
```

**Templateç»“æ„**ï¼š

```text
ConstraintTemplate
â”œâ”€â”€ CRDå®šä¹‰
â”‚   â”œâ”€â”€ kind: çº¦æŸç±»å‹åç§°
â”‚   â””â”€â”€ validation: å‚æ•°éªŒè¯schema
â”‚
â””â”€â”€ Regoç­–ç•¥
    â”œâ”€â”€ input.review: èµ„æºå¯¹è±¡
    â”œâ”€â”€ input.parameters: çº¦æŸå‚æ•°
    â””â”€â”€ violation: è¿è§„æŠ¥å‘Š
```

### 2.2 Constraint

**ä½¿ç”¨æ¨¡æ¿**ï¼š

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: require-app-labels
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment"]
  parameters:
    labels: ["app", "owner", "env"]
```

**Constrainté…ç½®**ï¼š

```yaml
spec:
  # åŒ¹é…è§„åˆ™
  match:
    kinds:
      - apiGroups: ["*"]
        kinds: ["Pod"]
    namespaces: ["production"]
    excludedNamespaces: ["kube-system"]
    namespaceSelector:
      matchLabels:
        environment: production
  
  # å‚æ•°
  parameters:
    labels: ["app", "team"]
  
  # å¼ºåˆ¶æ¨¡å¼
  enforcementAction: deny  # deny, dryrun, warn
```

### 2.3 Audit

**å®¡è®¡é…ç½®**ï¼š

```yaml
apiVersion: config.gatekeeper.sh/v1alpha1
kind: Config
metadata:
  name: config
  namespace: gatekeeper-system
spec:
  # åŒæ­¥èµ„æºåˆ°OPAç¼“å­˜
  sync:
    syncOnly:
      - group: ""
        version: "v1"
        kind: "Namespace"
      - group: "apps"
        version: "v1"
        kind: "Deployment"
  
  # å®¡è®¡é…ç½®
  validation:
    traces:
      - user: "system:*"
        kind:
          group: ""
          version: "v1"
          kind: "Pod"
```

---

## 3. å®‰è£…éƒ¨ç½²

### 3.1 Helmå®‰è£…

**æ·»åŠ Helmä»“åº“**ï¼š

```bash
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update
```

**å®‰è£…Gatekeeper**ï¼š

```bash
helm install gatekeeper gatekeeper/gatekeeper \
  --namespace gatekeeper-system \
  --create-namespace \
  --set auditInterval=60 \
  --set constraintViolationsLimit=100 \
  --set replicas=3
```

**è‡ªå®šä¹‰é…ç½®**ï¼š

```yaml
# values.yaml
replicas: 3

auditInterval: 60

resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

enableExternalData: true

# ç›‘æ§
metrics:
  enabled: true
  
logLevel: INFO
```

### 3.2 Kubectlå®‰è£…

**ç›´æ¥éƒ¨ç½²**ï¼š

```bash
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.15/deploy/gatekeeper.yaml
```

### 3.3 éªŒè¯å®‰è£…

**æ£€æŸ¥PodçŠ¶æ€**ï¼š

```bash
kubectl get pods -n gatekeeper-system

# è¾“å‡º:
NAME                                    READY   STATUS
gatekeeper-audit-xxx                    1/1     Running
gatekeeper-controller-manager-xxx       1/1     Running
gatekeeper-controller-manager-yyy       1/1     Running
```

**æ£€æŸ¥Webhook**ï¼š

```bash
kubectl get validatingwebhookconfigurations

# åº”è¯¥çœ‹åˆ°:
gatekeeper-validating-webhook-configuration
```

**æµ‹è¯•ç­–ç•¥**ï¼š

```bash
# éƒ¨ç½²ç¤ºä¾‹ConstraintTemplate
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/requiredlabels/template.yaml

# éƒ¨ç½²Constraint
cat <<EOF | kubectl apply -f -
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: ns-must-have-labels
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
  parameters:
    labels: ["owner"]
EOF

# æµ‹è¯• - åº”è¯¥è¢«æ‹’ç»
kubectl create namespace test-ns
# Error: namespace test-ns ç¼ºå°‘å¿…éœ€æ ‡ç­¾: owner

# æ­£ç¡®åˆ›å»º
kubectl create namespace test-ns --dry-run=client -o yaml | \
  kubectl label --local -f - owner=team-a --dry-run=client -o yaml | \
  kubectl apply -f -
```

---

## 4. ç­–ç•¥ç¼–å†™

### 4.1 åˆ›å»ºConstraintTemplate

**ç¦æ­¢ç‰¹æƒå®¹å™¨**ï¼š

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spsprivilegedcontainer
spec:
  crd:
    spec:
      names:
        kind: K8sPSPPrivilegedContainer
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spsprivilegedcontainer

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          container.securityContext.privileged == true
          msg := sprintf("ç‰¹æƒå®¹å™¨è¢«ç¦æ­¢: %v", [container.name])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.initContainers[_]
          container.securityContext.privileged == true
          msg := sprintf("ç‰¹æƒinitå®¹å™¨è¢«ç¦æ­¢: %v", [container.name])
        }
```

### 4.2 åˆ›å»ºConstraint

**åº”ç”¨çº¦æŸ**ï¼š

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPPrivilegedContainer
metadata:
  name: deny-privileged-containers
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - "kube-system"
  enforcementAction: deny
```

### 4.3 æµ‹è¯•ç­–ç•¥

**æœ¬åœ°æµ‹è¯•**ï¼š

```bash
# ä½¿ç”¨gatoræµ‹è¯•ï¼ˆGatekeeper CLIï¼‰
gator test -f constraints/ -f templates/ -f testcases/

# testcases/privileged-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod
spec:
  containers:
  - name: nginx
    image: nginx
    securityContext:
      privileged: true
```

**é›†ç¾¤æµ‹è¯•**ï¼š

```bash
# Dry-runæ¨¡å¼
kubectl run test-pod --image=nginx --dry-run=server -o yaml \
  --overrides='{"spec":{"containers":[{"name":"nginx","securityContext":{"privileged":true}}]}}'

# åº”è¯¥çœ‹åˆ°Gatekeeperæ‹’ç»
```

---

## 5. å†…ç½®Constraints

### 5.1 å¸¸ç”¨Constraints

**Gatekeeper Library**ï¼š

```text
å®˜æ–¹ç­–ç•¥åº“: https://github.com/open-policy-agent/gatekeeper-library

åˆ†ç±»:
â”œâ”€â”€ general/           # é€šç”¨ç­–ç•¥
â”‚   â”œâ”€â”€ allowedrepos   # å…è®¸çš„é•œåƒä»“åº“
â”‚   â”œâ”€â”€ requiredlabels # å¿…éœ€æ ‡ç­¾
â”‚   â””â”€â”€ uniqueingresshost # å”¯ä¸€Ingressä¸»æœº
â”‚
â”œâ”€â”€ pod-security-policy/  # Podå®‰å…¨
â”‚   â”œâ”€â”€ privileged     # ç¦æ­¢ç‰¹æƒ
â”‚   â”œâ”€â”€ hostnetwork    # ç¦æ­¢ä¸»æœºç½‘ç»œ
â”‚   â””â”€â”€ capabilities   # é™åˆ¶Linuxèƒ½åŠ›
â”‚
â””â”€â”€ general/           # èµ„æºé™åˆ¶
    â”œâ”€â”€ resourcelimits # CPU/å†…å­˜é™åˆ¶
    â””â”€â”€ replicacounts  # å‰¯æœ¬æ•°é™åˆ¶
```

### 5.2 Podå®‰å…¨

**ç¦æ­¢ä¸»æœºè·¯å¾„æŒ‚è½½**ï¼š

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spsphostfilesystem
spec:
  crd:
    spec:
      names:
        kind: K8sPSPHostFilesystem
      validation:
        openAPIV3Schema:
          type: object
          properties:
            allowedHostPaths:
              type: array
              items:
                type: object
                properties:
                  pathPrefix:
                    type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spsphostfilesystem
        
        violation[{"msg": msg}] {
          volume := input.review.object.spec.volumes[_]
          volume.hostPath
          allowed := input.parameters.allowedHostPaths[_]
          not startswith(volume.hostPath.path, allowed.pathPrefix)
          msg := sprintf("ç¦æ­¢æŒ‚è½½ä¸»æœºè·¯å¾„: %v", [volume.hostPath.path])
        }
```

### 5.3 èµ„æºé™åˆ¶

**å¼ºåˆ¶èµ„æºé™åˆ¶**ï¼š

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8scontainerresourcelimits
spec:
  crd:
    spec:
      names:
        kind: K8sContainerResourceLimits
      validation:
        openAPIV3Schema:
          type: object
          properties:
            cpu:
              type: string
            memory:
              type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8scontainerresourcelimits
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits
          msg := sprintf("å®¹å™¨å¿…é¡»è®¾ç½®èµ„æºé™åˆ¶: %v", [container.name])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.cpu
          msg := sprintf("å®¹å™¨å¿…é¡»è®¾ç½®CPUé™åˆ¶: %v", [container.name])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.memory
          msg := sprintf("å®¹å™¨å¿…é¡»è®¾ç½®å†…å­˜é™åˆ¶: %v", [container.name])
        }
```

---

## 6. é«˜çº§ç‰¹æ€§

### 6.1 Mutation

**è‡ªåŠ¨æ·»åŠ æ ‡ç­¾**ï¼š

```yaml
apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: Assign
metadata:
  name: add-default-labels
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
  location: "metadata.labels.managed-by"
  parameters:
    assign:
      value: "gatekeeper"
```

**ä¿®æ”¹é•œåƒä»“åº“**ï¼š

```yaml
apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: ModifySet
metadata:
  name: add-sidecar
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    namespaceSelector:
      matchLabels:
        sidecar-injection: "enabled"
  location: "spec.containers"
  parameters:
    operation: merge
    values:
      - name: sidecar
        image: envoy:latest
```

### 6.2 External Data

**æŸ¥è¯¢å¤–éƒ¨API**ï¼š

```yaml
apiVersion: externaldata.gatekeeper.sh/v1alpha1
kind: Provider
metadata:
  name: image-scanner
spec:
  url: https://scanner.example.com/api/scan
  timeout: 5
```

**ä½¿ç”¨External Data**ï¼š

```rego
package imagescan

violation[{"msg": msg}] {
  container := input.review.object.spec.containers[_]
  image := container.image
  
  # æŸ¥è¯¢å¤–éƒ¨æ‰«æå™¨
  response := external_data({
    "provider": "image-scanner",
    "keys": [image]
  })
  
  vulnerabilities := response[image].vulnerabilities
  critical := [v | v := vulnerabilities[_]; v.severity == "CRITICAL"]
  count(critical) > 0
  
  msg := sprintf("é•œåƒåŒ…å«%dä¸ªä¸¥é‡æ¼æ´: %v", [count(critical), image])
}
```

### 6.3 Sync

**åŒæ­¥èµ„æºåˆ°ç¼“å­˜**ï¼š

```yaml
apiVersion: config.gatekeeper.sh/v1alpha1
kind: Config
metadata:
  name: config
  namespace: gatekeeper-system
spec:
  sync:
    syncOnly:
      - group: ""
        version: "v1"
        kind: "Namespace"
      - group: ""
        version: "v1"
        kind: "Pod"
      - group: "rbac.authorization.k8s.io"
        version: "v1"
        kind: "Role"
```

**åœ¨ç­–ç•¥ä¸­ä½¿ç”¨**ï¼š

```rego
package uniqueingresshost

violation[{"msg": msg}] {
  input.review.kind.kind == "Ingress"
  host := input.review.object.spec.rules[_].host
  
  # æŸ¥è¯¢æ‰€æœ‰Ingress
  other := data.inventory.namespace[_]["networking.k8s.io/v1"].Ingress[_]
  other.spec.rules[_].host == host
  other.metadata.name != input.review.object.metadata.name
  
  msg := sprintf("Ingressä¸»æœºåå†²çª: %v", [host])
}
```

---

## 7. å®¡è®¡æ¨¡å¼

### 7.1 å®¡è®¡é…ç½®

**å¯ç”¨å®¡è®¡**ï¼š

```yaml
# Helm values
audit:
  enabled: true
  interval: 60  # 60ç§’æ‰«æä¸€æ¬¡
  constraintViolationsLimit: 100
  logLevel: INFO
```

### 7.2 è¿è§„æŠ¥å‘Š

**æŸ¥çœ‹è¿è§„**ï¼š

```bash
# æŸ¥çœ‹è¿è§„çŠ¶æ€
kubectl get constraints

NAME                           ENFORCEMENT-ACTION   TOTAL-VIOLATIONS
deny-privileged-containers     deny                 3
require-labels                 warn                 15

# è¯¦ç»†è¿è§„ä¿¡æ¯
kubectl get constraint deny-privileged-containers -o yaml
```

**è¿è§„è¯¦æƒ…**ï¼š

```yaml
status:
  auditTimestamp: "2025-10-21T10:30:00Z"
  totalViolations: 3
  violations:
    - enforcementAction: deny
      kind: Pod
      message: "ç‰¹æƒå®¹å™¨è¢«ç¦æ­¢: nginx"
      name: privileged-pod
      namespace: default
    - enforcementAction: deny
      kind: Pod
      message: "ç‰¹æƒå®¹å™¨è¢«ç¦æ­¢: app"
      name: test-pod
      namespace: production
```

### 7.3 æŒç»­åˆè§„

**å®šæœŸå®¡è®¡æµç¨‹**ï¼š

```text
1. Gatekeeperå®¡è®¡æ§åˆ¶å™¨å®šæœŸæ‰«æ
   â†“
2. å¯¹æ¯”Constraintså’Œå®é™…èµ„æº
   â†“
3. è®°å½•è¿è§„åˆ°Constraint status
   â†“
4. (å¯é€‰) å‘é€å‘Šè­¦åˆ°ç›‘æ§ç³»ç»Ÿ
   â†“
5. è¿ç»´å›¢é˜Ÿä¿®å¤è¿è§„èµ„æº
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 èµ„æºé…ç½®

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š

```yaml
# values.yaml
replicas: 3

resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# åäº²å’Œæ€§
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - gatekeeper
        topologyKey: kubernetes.io/hostname
```

### 8.2 ç­–ç•¥ä¼˜åŒ–

**ä¼˜åŒ–Regoä»£ç **ï¼š

```rego
# âŒ æ…¢: åµŒå¥—å¾ªç¯
violation[{"msg": msg}] {
  container := input.review.object.spec.containers[_]
  some i
  forbidden := data.forbidden_images[i]
  contains(container.image, forbidden)
  msg := "..."
}

# âœ… å¿«: ä½¿ç”¨é›†åˆæ“ä½œ
forbidden_patterns := {pattern | pattern := data.forbidden_images[_]}

violation[{"msg": msg}] {
  container := input.review.object.spec.containers[_]
  some pattern in forbidden_patterns
  contains(container.image, pattern)
  msg := "..."
}
```

### 8.3 ç¼“å­˜ç­–ç•¥

**Syncé…ç½®ä¼˜åŒ–**ï¼š

```yaml
spec:
  sync:
    # åªåŒæ­¥å¿…éœ€çš„èµ„æº
    syncOnly:
      - group: ""
        version: "v1"
        kind: "Namespace"
```

---

## 9. ç›‘æ§å‘Šè­¦

### 9.1 Metrics

**PrometheusæŒ‡æ ‡**ï¼š

```text
gatekeeper_violations{enforcement_action="deny"} 5
gatekeeper_constraint_templates_total 20
gatekeeper_constraints_total 35
gatekeeper_webhook_latency_seconds 0.05
```

### 9.2 æ—¥å¿—

**æŸ¥çœ‹æ—¥å¿—**ï¼š

```bash
kubectl logs -n gatekeeper-system \
  deployment/gatekeeper-controller-manager \
  --tail=100

# å®¡è®¡æ—¥å¿—
kubectl logs -n gatekeeper-system \
  deployment/gatekeeper-audit \
  --tail=100
```

### 9.3 å‘Šè­¦è§„åˆ™

**Prometheuså‘Šè­¦**ï¼š

```yaml
groups:
  - name: gatekeeper
    rules:
      - alert: GatekeeperHighViolations
        expr: sum(gatekeeper_violations) > 100
        for: 5m
        annotations:
          summary: "Gatekeeperè¿è§„æ•°è¿‡é«˜"
      
      - alert: GatekeeperWebhookSlow
        expr: histogram_quantile(0.99, gatekeeper_webhook_latency_seconds) > 1
        for: 5m
        annotations:
          summary: "Gatekeeper Webhookå»¶è¿Ÿè¿‡é«˜"
```

---

## 10. æœ€ä½³å®è·µ

### 10.1 ç­–ç•¥ç»„ç»‡

**ç›®å½•ç»“æ„**ï¼š

```text
policies/
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ privileged-containers.yaml
â”‚   â”‚   â””â”€â”€ host-network.yaml
â”‚   â”œâ”€â”€ resources/
â”‚   â”‚   â””â”€â”€ resource-limits.yaml
â”‚   â””â”€â”€ general/
â”‚       â””â”€â”€ required-labels.yaml
â”‚
â”œâ”€â”€ constraints/
â”‚   â”œâ”€â”€ production/
â”‚   â”‚   â”œâ”€â”€ deny-privileged.yaml
â”‚   â”‚   â””â”€â”€ require-labels.yaml
â”‚   â””â”€â”€ staging/
â”‚       â””â”€â”€ warn-privileged.yaml
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ security/
    â””â”€â”€ resources/
```

### 10.2 æµ‹è¯•ç­–ç•¥

**CI/CDé›†æˆ**ï¼š

```yaml
# .github/workflows/gatekeeper-test.yml
name: Gatekeeper Policy Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Install gator
        run: |
          curl -L -o gator https://github.com/open-policy-agent/gatekeeper/releases/download/v3.15.0/gator-linux-amd64
          chmod +x gator
      
      - name: Run tests
        run: |
          ./gator test -f policies/
```

### 10.3 æ•…éšœæ’æŸ¥

**å¸¸è§é—®é¢˜**ï¼š

```bash
# 1. Webhookè¶…æ—¶
kubectl get validatingwebhookconfiguration \
  gatekeeper-validating-webhook-configuration \
  -o yaml | grep timeout

# å¢åŠ è¶…æ—¶
kubectl patch validatingwebhookconfig gatekeeper-validating-webhook-configuration \
  --type='json' -p='[{"op": "replace", "path": "/webhooks/0/timeoutSeconds", "value": 10}]'

# 2. ç­–ç•¥ä¸ç”Ÿæ•ˆ
kubectl get constrainttemplate
kubectl get constraint

# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
kubectl describe constraint <name>

# 3. æ€§èƒ½é—®é¢˜
kubectl top pods -n gatekeeper-system
kubectl logs -n gatekeeper-system deployment/gatekeeper-controller-manager
```

---

## é™„å½•Aï¼šå¸¸ç”¨ç­–ç•¥åº“

**å®‰å…¨ç­–ç•¥**ï¼š

- ç¦æ­¢ç‰¹æƒå®¹å™¨
- ç¦æ­¢ä¸»æœºç½‘ç»œ/PID/IPC
- é™åˆ¶Linux Capabilities
- å¼ºåˆ¶åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- ç¦æ­¢ç‰¹æƒå‡çº§

**èµ„æºç­–ç•¥**:

- å¼ºåˆ¶èµ„æºé™åˆ¶/è¯·æ±‚
- é™åˆ¶é•œåƒå¤§å°
- é™åˆ¶å‰¯æœ¬æ•°
- PVCå¤§å°é™åˆ¶

**åˆè§„ç­–ç•¥**:

- å¿…éœ€æ ‡ç­¾/æ³¨è§£
- é•œåƒä»“åº“ç™½åå•
- ç¦æ­¢latestæ ‡ç­¾
- Ingressä¸»æœºåå”¯ä¸€æ€§
- LoadBalanceré™åˆ¶

---

## é™„å½•Bï¼šæ•…éšœæ’æŸ¥æ¸…å•

```text
â–¡ Gatekeeper Podè¿è¡Œæ­£å¸¸
â–¡ ValidatingWebhookConfigurationå­˜åœ¨
â–¡ ConstraintTemplateå·²åˆ›å»º
â–¡ Constraintå·²åˆ›å»ºä¸”çŠ¶æ€æ­£å¸¸
â–¡ Auditæ­£å¸¸è¿è¡Œ
â–¡ Metricså¯è®¿é—®
â–¡ æ—¥å¿—æ— ERROR
â–¡ Webhookå»¶è¿Ÿæ­£å¸¸ï¼ˆ<100msï¼‰
â–¡ è¿è§„æ•°åœ¨å¯æ§èŒƒå›´
â–¡ èµ„æºä½¿ç”¨æ­£å¸¸
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [Kubernetesé›†æˆ](./04.1-Kubernetesé›†æˆ.md)
- [è®¿é—®æ§åˆ¶(RBAC)](../05-åº”ç”¨åœºæ™¯/05.1-è®¿é—®æ§åˆ¶(RBAC).md)

**å‚è€ƒèµ„æº**ï¼š

- Gatekeeperå®˜æ–¹æ–‡æ¡£: <https://open-policy-agent.github.io/gatekeeper/>
- Gatekeeper Library: <https://github.com/open-policy-agent/gatekeeper-library>
- CNCFé¡¹ç›®é¡µ: <https://www.cncf.io/projects/open-policy-agent-gatekeeper/>
