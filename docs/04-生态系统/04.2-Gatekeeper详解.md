# Gatekeeper 详解（OPA Gatekeeper Deep Dive）

> **更新日期**: 2025年10月21日  
> **Gatekeeper版本**: v3.15+  
> **Kubernetes版本**: 1.25+  
> **状态**: CNCF毕业项目  
> **参考**: <https://open-policy-agent.github.io/gatekeeper/>

---

## 目录

- [Gatekeeper 详解（OPA Gatekeeper Deep Dive）](#gatekeeper-详解opa-gatekeeper-deep-dive)
  - [目录](#目录)
  - [1. Gatekeeper概述](#1-gatekeeper概述)
    - [1.1 什么是Gatekeeper](#11-什么是gatekeeper)
    - [1.2 核心价值](#12-核心价值)
    - [1.3 架构设计](#13-架构设计)
  - [2. 核心概念](#2-核心概念)
    - [2.1 ConstraintTemplate](#21-constrainttemplate)
    - [2.2 Constraint](#22-constraint)
    - [2.3 Audit](#23-audit)
  - [3. 安装部署](#3-安装部署)
    - [3.1 Helm安装](#31-helm安装)
    - [3.2 Kubectl安装](#32-kubectl安装)
    - [3.3 验证安装](#33-验证安装)
  - [4. 策略编写](#4-策略编写)
    - [4.1 创建ConstraintTemplate](#41-创建constrainttemplate)
    - [4.2 创建Constraint](#42-创建constraint)
    - [4.3 测试策略](#43-测试策略)
  - [5. 内置Constraints](#5-内置constraints)
    - [5.1 常用Constraints](#51-常用constraints)
    - [5.2 Pod安全](#52-pod安全)
    - [5.3 资源限制](#53-资源限制)
  - [6. 高级特性](#6-高级特性)
    - [6.1 Mutation](#61-mutation)
    - [6.2 External Data](#62-external-data)
    - [6.3 Sync](#63-sync)
  - [7. 审计模式](#7-审计模式)
    - [7.1 审计配置](#71-审计配置)
    - [7.2 违规报告](#72-违规报告)
    - [7.3 持续合规](#73-持续合规)
  - [8. 性能优化](#8-性能优化)
    - [8.1 资源配置](#81-资源配置)
    - [8.2 策略优化](#82-策略优化)
    - [8.3 缓存策略](#83-缓存策略)
  - [9. 监控告警](#9-监控告警)
    - [9.1 Metrics](#91-metrics)
    - [9.2 日志](#92-日志)
    - [9.3 告警规则](#93-告警规则)
  - [10. 最佳实践](#10-最佳实践)
    - [10.1 策略组织](#101-策略组织)
    - [10.2 测试策略](#102-测试策略)
    - [10.3 故障排查](#103-故障排查)
  - [附录A：常用策略库](#附录a常用策略库)
  - [附录B：故障排查清单](#附录b故障排查清单)

---

## 1. Gatekeeper概述

### 1.1 什么是Gatekeeper

**定义**：

```text
Gatekeeper = OPA + Kubernetes Admission Controller

作用:
  - 策略即代码 (Policy as Code)
  - 准入控制 (Admission Control)
  - 审计合规 (Audit & Compliance)
  - 变更管理 (Mutation)
```

**核心功能**：

```text
┌──────────────────────────────────────────┐
│          Kubernetes API Server           │
└────────────────┬─────────────────────────┘
                 │
                 ↓ Admission Request
┌──────────────────────────────────────────┐
│             Gatekeeper                   │
│  ┌────────────────────────────────────┐  │
│  │  1. Validation                     │  │
│  │     检查资源是否符合策略             │  │
│  ├────────────────────────────────────┤  │
│  │  2. Mutation (可选)                │  │
│  │     自动修改资源以符合策略           │  │
│  ├────────────────────────────────────┤  │
│  │  3. Audit                          │  │
│  │     检查现有资源的合规性             │  │
│  └────────────────────────────────────┘  │
└────────────────┬─────────────────────────┘
                 │
                 ↓ Allow/Deny
┌──────────────────────────────────────────┐
│          Resource Created/Updated        │
└──────────────────────────────────────────┘
```

### 1.2 核心价值

**企业级策略管理**：

```text
1. 安全合规
   ├── 镜像安全扫描
   ├── 禁止特权容器
   ├── 网络策略强制
   └── 密钥管理

2. 资源治理
   ├── CPU/内存限制
   ├── 存储配额
   ├── 副本数限制
   └── 标签规范

3. 运维标准
   ├── 命名规范
   ├── 标签标准化
   ├── 注解要求
   └── 最佳实践

4. 多租户隔离
   ├── 命名空间隔离
   ├── 资源配额
   ├── RBAC策略
   └── 网络隔离
```

### 1.3 架构设计

**组件架构**：

```text
┌─────────────────────────────────────────────┐
│         Gatekeeper Components               │
├─────────────────────────────────────────────┤
│                                             │
│  ┌────────────────────────────────────┐    │
│  │  Controller Manager                │    │
│  │  - Webhook Management              │    │
│  │  - Constraint Processing           │    │
│  │  - Template Compilation            │    │
│  └────────────────────────────────────┘    │
│                                             │
│  ┌────────────────────────────────────┐    │
│  │  Audit Controller                  │    │
│  │  - Periodic Scans                  │    │
│  │  - Violation Detection             │    │
│  │  - Report Generation               │    │
│  └────────────────────────────────────┘    │
│                                             │
│  ┌────────────────────────────────────┐    │
│  │  Webhook Server                    │    │
│  │  - Admission Review                │    │
│  │  - Policy Evaluation (OPA)         │    │
│  │  - Response Generation             │    │
│  └────────────────────────────────────┘    │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 2. 核心概念

### 2.1 ConstraintTemplate

**定义模板**：

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        # 模板参数定义
        openAPIV3Schema:
          type: object
          properties:
            labels:
              type: array
              items:
                type: string
  
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels

        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("缺少必需标签: %v", [missing])
        }
```

**Template结构**：

```text
ConstraintTemplate
├── CRD定义
│   ├── kind: 约束类型名称
│   └── validation: 参数验证schema
│
└── Rego策略
    ├── input.review: 资源对象
    ├── input.parameters: 约束参数
    └── violation: 违规报告
```

### 2.2 Constraint

**使用模板**：

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: require-app-labels
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment"]
  parameters:
    labels: ["app", "owner", "env"]
```

**Constraint配置**：

```yaml
spec:
  # 匹配规则
  match:
    kinds:
      - apiGroups: ["*"]
        kinds: ["Pod"]
    namespaces: ["production"]
    excludedNamespaces: ["kube-system"]
    namespaceSelector:
      matchLabels:
        environment: production
  
  # 参数
  parameters:
    labels: ["app", "team"]
  
  # 强制模式
  enforcementAction: deny  # deny, dryrun, warn
```

### 2.3 Audit

**审计配置**：

```yaml
apiVersion: config.gatekeeper.sh/v1alpha1
kind: Config
metadata:
  name: config
  namespace: gatekeeper-system
spec:
  # 同步资源到OPA缓存
  sync:
    syncOnly:
      - group: ""
        version: "v1"
        kind: "Namespace"
      - group: "apps"
        version: "v1"
        kind: "Deployment"
  
  # 审计配置
  validation:
    traces:
      - user: "system:*"
        kind:
          group: ""
          version: "v1"
          kind: "Pod"
```

---

## 3. 安装部署

### 3.1 Helm安装

**添加Helm仓库**：

```bash
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update
```

**安装Gatekeeper**：

```bash
helm install gatekeeper gatekeeper/gatekeeper \
  --namespace gatekeeper-system \
  --create-namespace \
  --set auditInterval=60 \
  --set constraintViolationsLimit=100 \
  --set replicas=3
```

**自定义配置**：

```yaml
# values.yaml
replicas: 3

auditInterval: 60

resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

enableExternalData: true

# 监控
metrics:
  enabled: true
  
logLevel: INFO
```

### 3.2 Kubectl安装

**直接部署**：

```bash
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.15/deploy/gatekeeper.yaml
```

### 3.3 验证安装

**检查Pod状态**：

```bash
kubectl get pods -n gatekeeper-system

# 输出:
NAME                                    READY   STATUS
gatekeeper-audit-xxx                    1/1     Running
gatekeeper-controller-manager-xxx       1/1     Running
gatekeeper-controller-manager-yyy       1/1     Running
```

**检查Webhook**：

```bash
kubectl get validatingwebhookconfigurations

# 应该看到:
gatekeeper-validating-webhook-configuration
```

**测试策略**：

```bash
# 部署示例ConstraintTemplate
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/requiredlabels/template.yaml

# 部署Constraint
cat <<EOF | kubectl apply -f -
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: ns-must-have-labels
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
  parameters:
    labels: ["owner"]
EOF

# 测试 - 应该被拒绝
kubectl create namespace test-ns
# Error: namespace test-ns 缺少必需标签: owner

# 正确创建
kubectl create namespace test-ns --dry-run=client -o yaml | \
  kubectl label --local -f - owner=team-a --dry-run=client -o yaml | \
  kubectl apply -f -
```

---

## 4. 策略编写

### 4.1 创建ConstraintTemplate

**禁止特权容器**：

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spsprivilegedcontainer
spec:
  crd:
    spec:
      names:
        kind: K8sPSPPrivilegedContainer
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spsprivilegedcontainer

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          container.securityContext.privileged == true
          msg := sprintf("特权容器被禁止: %v", [container.name])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.initContainers[_]
          container.securityContext.privileged == true
          msg := sprintf("特权init容器被禁止: %v", [container.name])
        }
```

### 4.2 创建Constraint

**应用约束**：

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPPrivilegedContainer
metadata:
  name: deny-privileged-containers
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - "kube-system"
  enforcementAction: deny
```

### 4.3 测试策略

**本地测试**：

```bash
# 使用gator测试（Gatekeeper CLI）
gator test -f constraints/ -f templates/ -f testcases/

# testcases/privileged-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod
spec:
  containers:
  - name: nginx
    image: nginx
    securityContext:
      privileged: true
```

**集群测试**：

```bash
# Dry-run模式
kubectl run test-pod --image=nginx --dry-run=server -o yaml \
  --overrides='{"spec":{"containers":[{"name":"nginx","securityContext":{"privileged":true}}]}}'

# 应该看到Gatekeeper拒绝
```

---

## 5. 内置Constraints

### 5.1 常用Constraints

**Gatekeeper Library**：

```text
官方策略库: https://github.com/open-policy-agent/gatekeeper-library

分类:
├── general/           # 通用策略
│   ├── allowedrepos   # 允许的镜像仓库
│   ├── requiredlabels # 必需标签
│   └── uniqueingresshost # 唯一Ingress主机
│
├── pod-security-policy/  # Pod安全
│   ├── privileged     # 禁止特权
│   ├── hostnetwork    # 禁止主机网络
│   └── capabilities   # 限制Linux能力
│
└── general/           # 资源限制
    ├── resourcelimits # CPU/内存限制
    └── replicacounts  # 副本数限制
```

### 5.2 Pod安全

**禁止主机路径挂载**：

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spsphostfilesystem
spec:
  crd:
    spec:
      names:
        kind: K8sPSPHostFilesystem
      validation:
        openAPIV3Schema:
          type: object
          properties:
            allowedHostPaths:
              type: array
              items:
                type: object
                properties:
                  pathPrefix:
                    type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spsphostfilesystem
        
        violation[{"msg": msg}] {
          volume := input.review.object.spec.volumes[_]
          volume.hostPath
          allowed := input.parameters.allowedHostPaths[_]
          not startswith(volume.hostPath.path, allowed.pathPrefix)
          msg := sprintf("禁止挂载主机路径: %v", [volume.hostPath.path])
        }
```

### 5.3 资源限制

**强制资源限制**：

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8scontainerresourcelimits
spec:
  crd:
    spec:
      names:
        kind: K8sContainerResourceLimits
      validation:
        openAPIV3Schema:
          type: object
          properties:
            cpu:
              type: string
            memory:
              type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8scontainerresourcelimits
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits
          msg := sprintf("容器必须设置资源限制: %v", [container.name])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.cpu
          msg := sprintf("容器必须设置CPU限制: %v", [container.name])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.memory
          msg := sprintf("容器必须设置内存限制: %v", [container.name])
        }
```

---

## 6. 高级特性

### 6.1 Mutation

**自动添加标签**：

```yaml
apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: Assign
metadata:
  name: add-default-labels
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
  location: "metadata.labels.managed-by"
  parameters:
    assign:
      value: "gatekeeper"
```

**修改镜像仓库**：

```yaml
apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: ModifySet
metadata:
  name: add-sidecar
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    namespaceSelector:
      matchLabels:
        sidecar-injection: "enabled"
  location: "spec.containers"
  parameters:
    operation: merge
    values:
      - name: sidecar
        image: envoy:latest
```

### 6.2 External Data

**查询外部API**：

```yaml
apiVersion: externaldata.gatekeeper.sh/v1alpha1
kind: Provider
metadata:
  name: image-scanner
spec:
  url: https://scanner.example.com/api/scan
  timeout: 5
```

**使用External Data**：

```rego
package imagescan

violation[{"msg": msg}] {
  container := input.review.object.spec.containers[_]
  image := container.image
  
  # 查询外部扫描器
  response := external_data({
    "provider": "image-scanner",
    "keys": [image]
  })
  
  vulnerabilities := response[image].vulnerabilities
  critical := [v | v := vulnerabilities[_]; v.severity == "CRITICAL"]
  count(critical) > 0
  
  msg := sprintf("镜像包含%d个严重漏洞: %v", [count(critical), image])
}
```

### 6.3 Sync

**同步资源到缓存**：

```yaml
apiVersion: config.gatekeeper.sh/v1alpha1
kind: Config
metadata:
  name: config
  namespace: gatekeeper-system
spec:
  sync:
    syncOnly:
      - group: ""
        version: "v1"
        kind: "Namespace"
      - group: ""
        version: "v1"
        kind: "Pod"
      - group: "rbac.authorization.k8s.io"
        version: "v1"
        kind: "Role"
```

**在策略中使用**：

```rego
package uniqueingresshost

violation[{"msg": msg}] {
  input.review.kind.kind == "Ingress"
  host := input.review.object.spec.rules[_].host
  
  # 查询所有Ingress
  other := data.inventory.namespace[_]["networking.k8s.io/v1"].Ingress[_]
  other.spec.rules[_].host == host
  other.metadata.name != input.review.object.metadata.name
  
  msg := sprintf("Ingress主机名冲突: %v", [host])
}
```

---

## 7. 审计模式

### 7.1 审计配置

**启用审计**：

```yaml
# Helm values
audit:
  enabled: true
  interval: 60  # 60秒扫描一次
  constraintViolationsLimit: 100
  logLevel: INFO
```

### 7.2 违规报告

**查看违规**：

```bash
# 查看违规状态
kubectl get constraints

NAME                           ENFORCEMENT-ACTION   TOTAL-VIOLATIONS
deny-privileged-containers     deny                 3
require-labels                 warn                 15

# 详细违规信息
kubectl get constraint deny-privileged-containers -o yaml
```

**违规详情**：

```yaml
status:
  auditTimestamp: "2025-10-21T10:30:00Z"
  totalViolations: 3
  violations:
    - enforcementAction: deny
      kind: Pod
      message: "特权容器被禁止: nginx"
      name: privileged-pod
      namespace: default
    - enforcementAction: deny
      kind: Pod
      message: "特权容器被禁止: app"
      name: test-pod
      namespace: production
```

### 7.3 持续合规

**定期审计流程**：

```text
1. Gatekeeper审计控制器定期扫描
   ↓
2. 对比Constraints和实际资源
   ↓
3. 记录违规到Constraint status
   ↓
4. (可选) 发送告警到监控系统
   ↓
5. 运维团队修复违规资源
```

---

## 8. 性能优化

### 8.1 资源配置

**生产环境配置**：

```yaml
# values.yaml
replicas: 3

resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# 反亲和性
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - gatekeeper
        topologyKey: kubernetes.io/hostname
```

### 8.2 策略优化

**优化Rego代码**：

```rego
# ❌ 慢: 嵌套循环
violation[{"msg": msg}] {
  container := input.review.object.spec.containers[_]
  some i
  forbidden := data.forbidden_images[i]
  contains(container.image, forbidden)
  msg := "..."
}

# ✅ 快: 使用集合操作
forbidden_patterns := {pattern | pattern := data.forbidden_images[_]}

violation[{"msg": msg}] {
  container := input.review.object.spec.containers[_]
  some pattern in forbidden_patterns
  contains(container.image, pattern)
  msg := "..."
}
```

### 8.3 缓存策略

**Sync配置优化**：

```yaml
spec:
  sync:
    # 只同步必需的资源
    syncOnly:
      - group: ""
        version: "v1"
        kind: "Namespace"
```

---

## 9. 监控告警

### 9.1 Metrics

**Prometheus指标**：

```text
gatekeeper_violations{enforcement_action="deny"} 5
gatekeeper_constraint_templates_total 20
gatekeeper_constraints_total 35
gatekeeper_webhook_latency_seconds 0.05
```

### 9.2 日志

**查看日志**：

```bash
kubectl logs -n gatekeeper-system \
  deployment/gatekeeper-controller-manager \
  --tail=100

# 审计日志
kubectl logs -n gatekeeper-system \
  deployment/gatekeeper-audit \
  --tail=100
```

### 9.3 告警规则

**Prometheus告警**：

```yaml
groups:
  - name: gatekeeper
    rules:
      - alert: GatekeeperHighViolations
        expr: sum(gatekeeper_violations) > 100
        for: 5m
        annotations:
          summary: "Gatekeeper违规数过高"
      
      - alert: GatekeeperWebhookSlow
        expr: histogram_quantile(0.99, gatekeeper_webhook_latency_seconds) > 1
        for: 5m
        annotations:
          summary: "Gatekeeper Webhook延迟过高"
```

---

## 10. 最佳实践

### 10.1 策略组织

**目录结构**：

```text
policies/
├── templates/
│   ├── security/
│   │   ├── privileged-containers.yaml
│   │   └── host-network.yaml
│   ├── resources/
│   │   └── resource-limits.yaml
│   └── general/
│       └── required-labels.yaml
│
├── constraints/
│   ├── production/
│   │   ├── deny-privileged.yaml
│   │   └── require-labels.yaml
│   └── staging/
│       └── warn-privileged.yaml
│
└── tests/
    ├── security/
    └── resources/
```

### 10.2 测试策略

**CI/CD集成**：

```yaml
# .github/workflows/gatekeeper-test.yml
name: Gatekeeper Policy Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Install gator
        run: |
          curl -L -o gator https://github.com/open-policy-agent/gatekeeper/releases/download/v3.15.0/gator-linux-amd64
          chmod +x gator
      
      - name: Run tests
        run: |
          ./gator test -f policies/
```

### 10.3 故障排查

**常见问题**：

```bash
# 1. Webhook超时
kubectl get validatingwebhookconfiguration \
  gatekeeper-validating-webhook-configuration \
  -o yaml | grep timeout

# 增加超时
kubectl patch validatingwebhookconfig gatekeeper-validating-webhook-configuration \
  --type='json' -p='[{"op": "replace", "path": "/webhooks/0/timeoutSeconds", "value": 10}]'

# 2. 策略不生效
kubectl get constrainttemplate
kubectl get constraint

# 查看详细状态
kubectl describe constraint <name>

# 3. 性能问题
kubectl top pods -n gatekeeper-system
kubectl logs -n gatekeeper-system deployment/gatekeeper-controller-manager
```

---

## 附录A：常用策略库

**安全策略**：

- 禁止特权容器
- 禁止主机网络/PID/IPC
- 限制Linux Capabilities
- 强制只读根文件系统
- 禁止特权升级

**资源策略**:

- 强制资源限制/请求
- 限制镜像大小
- 限制副本数
- PVC大小限制

**合规策略**:

- 必需标签/注解
- 镜像仓库白名单
- 禁止latest标签
- Ingress主机名唯一性
- LoadBalancer限制

---

## 附录B：故障排查清单

```text
□ Gatekeeper Pod运行正常
□ ValidatingWebhookConfiguration存在
□ ConstraintTemplate已创建
□ Constraint已创建且状态正常
□ Audit正常运行
□ Metrics可访问
□ 日志无ERROR
□ Webhook延迟正常（<100ms）
□ 违规数在可控范围
□ 资源使用正常
```

---

**相关文档**：

- [Kubernetes集成](./04.1-Kubernetes集成.md)
- [访问控制(RBAC)](../05-应用场景/05.1-访问控制(RBAC).md)

**参考资源**：

- Gatekeeper官方文档: <https://open-policy-agent.github.io/gatekeeper/>
- Gatekeeper Library: <https://github.com/open-policy-agent/gatekeeper-library>
- CNCF项目页: <https://www.cncf.io/projects/open-policy-agent-gatekeeper/>
