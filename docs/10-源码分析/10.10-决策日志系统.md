# 决策日志系统

> **文档类型**: 源码实现分析  
> **核心模块**: `plugins/logs/`, `server/types/log.go`  
> **适用读者**: 合规审计工程师、监控系统开发者  
> **最后更新**: 2025年10月23日  
> **文档状态**: ✅ Phase 2.10 - 决策日志  
> **OPA版本**: v0.68.0

---

## 📋 文档概述

决策日志（Decision Logs）记录OPA的所有策略决策，用于审计、调试和合规。

**核心功能**:
- 决策记录与序列化
- 日志缓冲与批量发送
- 远程日志服务集成
- 性能优化（采样、过滤）

---

## 1. 日志结构

### 1.1 EventV1

```go
// EventV1: 决策日志事件
type EventV1 struct {
    Labels      map[string]string      `json:"labels"`
    DecisionID  string                 `json:"decision_id"`
    Revision    string                 `json:"revision,omitempty"`
    Path        string                 `json:"path"`
    Input       *interface{}           `json:"input,omitempty"`
    Result      *interface{}           `json:"result,omitempty"`
    RequestedBy string                 `json:"requested_by,omitempty"`
    Timestamp   time.Time              `json:"timestamp"`
    Metrics     map[string]interface{} `json:"metrics,omitempty"`
}
```

### 1.2 日志示例

```json
{
  "labels": {
    "app": "myapp",
    "id": "backend-01"
  },
  "decision_id": "550e8400-e29b-41d4-a716-446655440000",
  "path": "data.example.allow",
  "input": {
    "method": "GET",
    "path": "/api/users"
  },
  "result": true,
  "timestamp": "2025-10-23T10:30:00Z",
  "metrics": {
    "timer_rego_query_eval_ns": 125000
  }
}
```

---

## 2. 插件实现

### 2.1 LogsPlugin

```go
// Plugin: 决策日志插件
type Plugin struct {
    manager *plugins.Manager
    config  *Config
    
    // 日志缓冲区
    buffer chan *EventV1
    
    // 上传器
    uploader *Uploader
}

// Log: 记录决策
func (p *Plugin) Log(ctx context.Context, event *EventV1) error {
    // 应用采样
    if !p.shouldLog(event) {
        return nil
    }
    
    // 应用过滤
    event = p.filter(event)
    
    // 写入缓冲区
    select {
    case p.buffer <- event:
        return nil
    default:
        return fmt.Errorf("log buffer full")
    }
}

// shouldLog: 采样决策
func (p *Plugin) shouldLog(event *EventV1) bool {
    if p.config.SamplingRate >= 1.0 {
        return true
    }
    
    return rand.Float64() < p.config.SamplingRate
}
```

---

## 3. 日志上传

### 3.1 批量上传

```go
// uploadLoop: 上传循环
func (p *Plugin) uploadLoop(ctx context.Context) {
    ticker := time.NewTicker(p.config.UploadInterval)
    defer ticker.Stop()
    
    batch := make([]*EventV1, 0, p.config.BatchSize)
    
    for {
        select {
        case <-ctx.Done():
            return
            
        case event := <-p.buffer:
            batch = append(batch, event)
            
            if len(batch) >= p.config.BatchSize {
                p.upload(ctx, batch)
                batch = batch[:0]
            }
            
        case <-ticker.C:
            if len(batch) > 0 {
                p.upload(ctx, batch)
                batch = batch[:0]
            }
        }
    }
}

// upload: 上传日志
func (p *Plugin) upload(ctx context.Context, events []*EventV1) error {
    // 序列化
    data, err := json.Marshal(events)
    if err != nil {
        return err
    }
    
    // HTTP POST
    req, _ := http.NewRequest("POST", p.config.URL, bytes.NewReader(data))
    req.Header.Set("Content-Type", "application/json")
    
    resp, err := p.client.Do(req)
    if err != nil {
        return err
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != 200 {
        return fmt.Errorf("upload failed: %d", resp.StatusCode)
    }
    
    return nil
}
```

---

## 4. 配置选项

### 4.1 Config

```go
// Config: 日志插件配置
type Config struct {
    // 服务端点
    URL string `json:"url"`
    
    // 批量大小
    BatchSize int `json:"batch_size"`
    
    // 上传间隔
    UploadInterval time.Duration `json:"upload_interval_seconds"`
    
    // 采样率 (0.0-1.0)
    SamplingRate float64 `json:"sampling_rate"`
    
    // 过滤规则
    Filter string `json:"filter"`
    
    // 缓冲区大小
    BufferSize int `json:"buffer_size"`
}
```

---

**文档版本**: v1.0  
**最后更新**: 2025年10月23日

**相关阅读**:
- [OPA架构总览](10.1-OPA架构总览与代码结构.md)
- [API规范](../01-技术规范/01.1-API规范.md)

