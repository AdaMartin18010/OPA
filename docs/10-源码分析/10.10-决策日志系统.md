# å†³ç­–æ—¥å¿—ç³»ç»Ÿ

> **æ–‡æ¡£ç±»å‹**: æºç å®ç°åˆ†æ  
> **æ ¸å¿ƒæ¨¡å—**: `plugins/logs/`, `server/types/log.go`  
> **é€‚ç”¨è¯»è€…**: åˆè§„å®¡è®¡å·¥ç¨‹å¸ˆã€ç›‘æ§ç³»ç»Ÿå¼€å‘è€…  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 2.10 - å†³ç­–æ—¥å¿—  
> **OPAç‰ˆæœ¬**: v0.68.0

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

å†³ç­–æ—¥å¿—ï¼ˆDecision Logsï¼‰è®°å½•OPAçš„æ‰€æœ‰ç­–ç•¥å†³ç­–ï¼Œç”¨äºå®¡è®¡ã€è°ƒè¯•å’Œåˆè§„ã€‚

**æ ¸å¿ƒåŠŸèƒ½**:
- å†³ç­–è®°å½•ä¸åºåˆ—åŒ–
- æ—¥å¿—ç¼“å†²ä¸æ‰¹é‡å‘é€
- è¿œç¨‹æ—¥å¿—æœåŠ¡é›†æˆ
- æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡‡æ ·ã€è¿‡æ»¤ï¼‰

---

## 1. æ—¥å¿—ç»“æ„

### 1.1 EventV1

```go
// EventV1: å†³ç­–æ—¥å¿—äº‹ä»¶
type EventV1 struct {
    Labels      map[string]string      `json:"labels"`
    DecisionID  string                 `json:"decision_id"`
    Revision    string                 `json:"revision,omitempty"`
    Path        string                 `json:"path"`
    Input       *interface{}           `json:"input,omitempty"`
    Result      *interface{}           `json:"result,omitempty"`
    RequestedBy string                 `json:"requested_by,omitempty"`
    Timestamp   time.Time              `json:"timestamp"`
    Metrics     map[string]interface{} `json:"metrics,omitempty"`
}
```

### 1.2 æ—¥å¿—ç¤ºä¾‹

```json
{
  "labels": {
    "app": "myapp",
    "id": "backend-01"
  },
  "decision_id": "550e8400-e29b-41d4-a716-446655440000",
  "path": "data.example.allow",
  "input": {
    "method": "GET",
    "path": "/api/users"
  },
  "result": true,
  "timestamp": "2025-10-23T10:30:00Z",
  "metrics": {
    "timer_rego_query_eval_ns": 125000
  }
}
```

---

## 2. æ’ä»¶å®ç°

### 2.1 LogsPlugin

```go
// Plugin: å†³ç­–æ—¥å¿—æ’ä»¶
type Plugin struct {
    manager *plugins.Manager
    config  *Config
    
    // æ—¥å¿—ç¼“å†²åŒº
    buffer chan *EventV1
    
    // ä¸Šä¼ å™¨
    uploader *Uploader
}

// Log: è®°å½•å†³ç­–
func (p *Plugin) Log(ctx context.Context, event *EventV1) error {
    // åº”ç”¨é‡‡æ ·
    if !p.shouldLog(event) {
        return nil
    }
    
    // åº”ç”¨è¿‡æ»¤
    event = p.filter(event)
    
    // å†™å…¥ç¼“å†²åŒº
    select {
    case p.buffer <- event:
        return nil
    default:
        return fmt.Errorf("log buffer full")
    }
}

// shouldLog: é‡‡æ ·å†³ç­–
func (p *Plugin) shouldLog(event *EventV1) bool {
    if p.config.SamplingRate >= 1.0 {
        return true
    }
    
    return rand.Float64() < p.config.SamplingRate
}
```

---

## 3. æ—¥å¿—ä¸Šä¼ 

### 3.1 æ‰¹é‡ä¸Šä¼ 

```go
// uploadLoop: ä¸Šä¼ å¾ªç¯
func (p *Plugin) uploadLoop(ctx context.Context) {
    ticker := time.NewTicker(p.config.UploadInterval)
    defer ticker.Stop()
    
    batch := make([]*EventV1, 0, p.config.BatchSize)
    
    for {
        select {
        case <-ctx.Done():
            return
            
        case event := <-p.buffer:
            batch = append(batch, event)
            
            if len(batch) >= p.config.BatchSize {
                p.upload(ctx, batch)
                batch = batch[:0]
            }
            
        case <-ticker.C:
            if len(batch) > 0 {
                p.upload(ctx, batch)
                batch = batch[:0]
            }
        }
    }
}

// upload: ä¸Šä¼ æ—¥å¿—
func (p *Plugin) upload(ctx context.Context, events []*EventV1) error {
    // åºåˆ—åŒ–
    data, err := json.Marshal(events)
    if err != nil {
        return err
    }
    
    // HTTP POST
    req, _ := http.NewRequest("POST", p.config.URL, bytes.NewReader(data))
    req.Header.Set("Content-Type", "application/json")
    
    resp, err := p.client.Do(req)
    if err != nil {
        return err
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != 200 {
        return fmt.Errorf("upload failed: %d", resp.StatusCode)
    }
    
    return nil
}
```

---

## 4. é…ç½®é€‰é¡¹

### 4.1 Config

```go
// Config: æ—¥å¿—æ’ä»¶é…ç½®
type Config struct {
    // æœåŠ¡ç«¯ç‚¹
    URL string `json:"url"`
    
    // æ‰¹é‡å¤§å°
    BatchSize int `json:"batch_size"`
    
    // ä¸Šä¼ é—´éš”
    UploadInterval time.Duration `json:"upload_interval_seconds"`
    
    // é‡‡æ ·ç‡ (0.0-1.0)
    SamplingRate float64 `json:"sampling_rate"`
    
    // è¿‡æ»¤è§„åˆ™
    Filter string `json:"filter"`
    
    // ç¼“å†²åŒºå¤§å°
    BufferSize int `json:"buffer_size"`
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥

**ç›¸å…³é˜…è¯»**:
- [OPAæ¶æ„æ€»è§ˆ](10.1-OPAæ¶æ„æ€»è§ˆä¸ä»£ç ç»“æ„.md)
- [APIè§„èŒƒ](../01-æŠ€æœ¯è§„èŒƒ/01.1-APIè§„èŒƒ.md)

