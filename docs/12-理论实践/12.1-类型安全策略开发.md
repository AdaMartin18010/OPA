# ç±»å‹å®‰å…¨ç­–ç•¥å¼€å‘

> **æ–‡æ¡£ç±»å‹**: ç†è®ºå®è·µæ¡¥æ¢  
> **æ ¸å¿ƒä¸»é¢˜**: åŸºäºç±»å‹ç³»ç»Ÿçš„å®‰å…¨ç­–ç•¥å¼€å‘å®è·µ  
> **é€‚ç”¨è¯»è€…**: ç­–ç•¥å¼€å‘è€…ã€ç±»å‹ç³»ç»Ÿç ”ç©¶è€…ã€DevSecOpså·¥ç¨‹å¸ˆ  
> **å…ˆä¿®çŸ¥è¯†**: [Regoè¯­è¨€åŸºç¡€](../02-è¯­è¨€æ¨¡å‹/02.1-Regoè¯­è¨€è§„èŒƒ.md)ã€[ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–](../06-å½¢å¼åŒ–è¯æ˜/06.5-ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–.md)  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 4.1 - ç†è®ºå®è·µ  
> **å®è·µä»·å€¼**: ç¼–å†™ç±»å‹å®‰å…¨ã€å¯ç»´æŠ¤çš„Regoç­–ç•¥

---

## ğŸ¯ æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£å°†**ç±»å‹ç³»ç»Ÿç†è®º**åº”ç”¨äº**å®é™…ç­–ç•¥å¼€å‘**ï¼Œå¸®åŠ©å¼€å‘è€…ç¼–å†™ç±»å‹å®‰å…¨ã€å¥å£®çš„Regoç­–ç•¥ã€‚

**æ ¸å¿ƒå†…å®¹**:

- ç±»å‹æ¨å¯¼åœ¨ç­–ç•¥å¼€å‘ä¸­çš„åº”ç”¨
- å¸¸è§ç±»å‹é”™è¯¯åŠè¯Šæ–­æ–¹æ³•
- ç±»å‹é©±åŠ¨å¼€å‘ï¼ˆType-Driven Developmentï¼‰
- ç±»å‹å®‰å…¨æ¨¡å¼ä¸åæ¨¡å¼
- é™æ€ç±»å‹æ£€æŸ¥å·¥å…·

**å­¦ä¹ ä»·å€¼**:

- ğŸ’ª ç¼–å†™æ›´å¥å£®çš„ç­–ç•¥
- ğŸ› å¿«é€Ÿå®šä½ç±»å‹é”™è¯¯
- ğŸ›¡ï¸ é˜²æ­¢è¿è¡Œæ—¶ç±»å‹å¼‚å¸¸
- ğŸ“š æé«˜ä»£ç å¯ç»´æŠ¤æ€§

---

## ç›®å½•

- [ç±»å‹å®‰å…¨ç­–ç•¥å¼€å‘](#ç±»å‹å®‰å…¨ç­–ç•¥å¼€å‘)
  - [ğŸ¯ æ–‡æ¡£ç›®æ ‡](#-æ–‡æ¡£ç›®æ ‡)
  - [ç›®å½•](#ç›®å½•)
  - [1. ç±»å‹ç³»ç»Ÿå›é¡¾](#1-ç±»å‹ç³»ç»Ÿå›é¡¾)
    - [1.1 Regoç±»å‹ç³»ç»ŸåŸºç¡€](#11-regoç±»å‹ç³»ç»ŸåŸºç¡€)
    - [1.2 ç±»å‹æ¨å¯¼è§„åˆ™](#12-ç±»å‹æ¨å¯¼è§„åˆ™)
    - [1.3 ç±»å‹å®‰å…¨çš„é‡è¦æ€§](#13-ç±»å‹å®‰å…¨çš„é‡è¦æ€§)
  - [2. ç±»å‹é©±åŠ¨å¼€å‘](#2-ç±»å‹é©±åŠ¨å¼€å‘)
    - [2.1 TDDåŸåˆ™](#21-tddåŸåˆ™)
    - [2.2 ç±»å‹ä½œä¸ºè§„çº¦](#22-ç±»å‹ä½œä¸ºè§„çº¦)
    - [2.3 ç±»å‹ä¼˜å…ˆè®¾è®¡](#23-ç±»å‹ä¼˜å…ˆè®¾è®¡)
  - [3. å¸¸è§ç±»å‹é”™è¯¯](#3-å¸¸è§ç±»å‹é”™è¯¯)
    - [3.1 ç±»å‹ä¸åŒ¹é…](#31-ç±»å‹ä¸åŒ¹é…)
    - [3.2 ç©ºå€¼é”™è¯¯](#32-ç©ºå€¼é”™è¯¯)
    - [3.3 é›†åˆç±»å‹é”™è¯¯](#33-é›†åˆç±»å‹é”™è¯¯)
  - [4. ç±»å‹æ³¨è§£ä¸æ–‡æ¡£](#4-ç±»å‹æ³¨è§£ä¸æ–‡æ¡£)
    - [4.1 æ³¨é‡Šä¸­çš„ç±»å‹ä¿¡æ¯](#41-æ³¨é‡Šä¸­çš„ç±»å‹ä¿¡æ¯)
    - [4.2 è¾“å…¥è¾“å‡ºå¥‘çº¦](#42-è¾“å…¥è¾“å‡ºå¥‘çº¦)
    - [4.3 ç±»å‹ç¤ºä¾‹](#43-ç±»å‹ç¤ºä¾‹)
  - [5. ç±»å‹å®‰å…¨æ¨¡å¼](#5-ç±»å‹å®‰å…¨æ¨¡å¼)
    - [5.1 é˜²å¾¡æ€§ç¼–ç¨‹](#51-é˜²å¾¡æ€§ç¼–ç¨‹)
    - [5.2 ç±»å‹å«è¯­å¥](#52-ç±»å‹å«è¯­å¥)
    - [5.3 å®‰å…¨çš„ç±»å‹è½¬æ¢](#53-å®‰å…¨çš„ç±»å‹è½¬æ¢)
  - [6. é«˜çº§ç±»å‹æŠ€æœ¯](#6-é«˜çº§ç±»å‹æŠ€æœ¯)
    - [6.1 æ³›å‹æ¨¡å¼](#61-æ³›å‹æ¨¡å¼)
    - [6.2 ç±»å‹å¤šæ€](#62-ç±»å‹å¤šæ€)
    - [6.3 ä¾èµ–ç±»å‹æ¨¡æ‹Ÿ](#63-ä¾èµ–ç±»å‹æ¨¡æ‹Ÿ)
  - [7. é™æ€åˆ†æå·¥å…·](#7-é™æ€åˆ†æå·¥å…·)
    - [7.1 OPAç±»å‹æ£€æŸ¥å™¨](#71-opaç±»å‹æ£€æŸ¥å™¨)
    - [7.2 Regal Linter](#72-regal-linter)
    - [7.3 è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™](#73-è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™)
  - [8. æµ‹è¯•ä¸éªŒè¯](#8-æµ‹è¯•ä¸éªŒè¯)
    - [8.1 ç±»å‹æµ‹è¯•](#81-ç±»å‹æµ‹è¯•)
    - [8.2 å±æ€§æµ‹è¯•](#82-å±æ€§æµ‹è¯•)
    - [8.3 æ¨¡ç³Šæµ‹è¯•](#83-æ¨¡ç³Šæµ‹è¯•)
  - [9. å®æˆ˜æ¡ˆä¾‹](#9-å®æˆ˜æ¡ˆä¾‹)
    - [9.1 RBACç­–ç•¥](#91-rbacç­–ç•¥)
    - [9.2 æ•°æ®éªŒè¯ç­–ç•¥](#92-æ•°æ®éªŒè¯ç­–ç•¥)
    - [9.3 APIæˆæƒç­–ç•¥](#93-apiæˆæƒç­–ç•¥)
  - [10. æœ€ä½³å®è·µ](#10-æœ€ä½³å®è·µ)
    - [10.1 è®¾è®¡åŸåˆ™](#101-è®¾è®¡åŸåˆ™)
    - [10.2 ä»£ç ç»„ç»‡](#102-ä»£ç ç»„ç»‡)
    - [10.3 æŒç»­æ”¹è¿›](#103-æŒç»­æ”¹è¿›)
  - [é™„å½•](#é™„å½•)
    - [A. ç±»å‹é€ŸæŸ¥è¡¨](#a-ç±»å‹é€ŸæŸ¥è¡¨)
    - [B. é”™è¯¯è¯Šæ–­æŒ‡å—](#b-é”™è¯¯è¯Šæ–­æŒ‡å—)
    - [C. å·¥å…·é…ç½®](#c-å·¥å…·é…ç½®)

---

## 1. ç±»å‹ç³»ç»Ÿå›é¡¾

### 1.1 Regoç±»å‹ç³»ç»ŸåŸºç¡€

**Regoçš„ç±»å‹å±‚æ¬¡**:

```text
any
â”œâ”€â”€ null
â”œâ”€â”€ boolean
â”œâ”€â”€ number
â”œâ”€â”€ string
â”œâ”€â”€ array<T>
â”œâ”€â”€ object<K, V>
â””â”€â”€ set<T>
```

**ç±»å‹ç¤ºä¾‹**:

```rego
# æ ‡é‡ç±»å‹
null_value := null
bool_value := true
num_value := 42
str_value := "hello"

# é›†åˆç±»å‹
arr_value := [1, 2, 3]              # array<number>
obj_value := {"key": "value"}       # object<string, string>
set_value := {1, 2, 3}              # set<number>

# åµŒå¥—ç±»å‹
nested := {                         # object<string, array<object<string, number>>>
    "users": [
        {"id": 1, "age": 30},
        {"id": 2, "age": 25}
    ]
}
```

### 1.2 ç±»å‹æ¨å¯¼è§„åˆ™

**ç®—æœ¯è¿ç®—**:

```rego
# âœ“ æ­£ç¡®ï¼šnumber + number = number
result := 10 + 20  # result: number = 30

# âœ— é”™è¯¯ï¼šstring + number
result := "10" + 20  # ç±»å‹é”™è¯¯ï¼
```

**å­—ç¬¦ä¸²æ‹¼æ¥**:

```rego
# âœ“ ä½¿ç”¨ sprintf
name := "Alice"
greeting := sprintf("Hello, %s!", [name])  # string

# âœ“ ä½¿ç”¨ concat
parts := ["Hello", "World"]
message := concat(", ", parts)  # string
```

**é›†åˆæ“ä½œ**:

```rego
# âœ“ æ­£ç¡®ï¼šset<T> | set<T> = set<T>
s1 := {1, 2, 3}
s2 := {3, 4, 5}
union := s1 | s2  # {1, 2, 3, 4, 5}

# âœ— é”™è¯¯ï¼šarray | set
arr := [1, 2, 3]
s := {4, 5}
result := arr | s  # ç±»å‹é”™è¯¯ï¼
```

### 1.3 ç±»å‹å®‰å…¨çš„é‡è¦æ€§

**è¿è¡Œæ—¶é”™è¯¯ç¤ºä¾‹**:

```rego
# ä¸å®‰å…¨çš„ç­–ç•¥
allow {
    # å‡è®¾ input.age æ˜¯ number
    input.age >= 18
}

# é—®é¢˜ï¼šå¦‚æœ input.age æ˜¯ string "18" æˆ– nullï¼Ÿ
# ç»“æœï¼šè¿è¡Œæ—¶é”™è¯¯æˆ–æ„å¤–è¡Œä¸º
```

**ç±»å‹å®‰å…¨ç‰ˆæœ¬**:

```rego
allow {
    # ç±»å‹å«è¯­å¥
    is_number(input.age)
    input.age >= 18
}
```

---

## 2. ç±»å‹é©±åŠ¨å¼€å‘

### 2.1 TDDåŸåˆ™

**ç±»å‹ä¼˜å…ˆæ€è€ƒ**:

1. **è®¾è®¡ç±»å‹å¥‘çº¦** â†’ å®šä¹‰è¾“å…¥è¾“å‡ºç±»å‹
2. **ç¼–å†™ç±»å‹æ£€æŸ¥** â†’ ç¡®ä¿ç±»å‹æ­£ç¡®
3. **å®ç°ä¸šåŠ¡é€»è¾‘** â†’ åœ¨ç±»å‹å®‰å…¨çš„åŸºç¡€ä¸Š

### 2.2 ç±»å‹ä½œä¸ºè§„çº¦

**ç¤ºä¾‹ï¼šç”¨æˆ·æƒé™æ£€æŸ¥**:

**æ­¥éª¤1ï¼šå®šä¹‰ç±»å‹å¥‘çº¦**:

```rego
# ç±»å‹å¥‘çº¦ï¼ˆæ³¨é‡Šå½¢å¼ï¼‰
# @input: {
#   "user": string,
#   "resource": string,
#   "action": string
# }
# @output: boolean
# @requires: data.permissions[user][resource][action] exists
```

**æ­¥éª¤2ï¼šå®ç°ç±»å‹æ£€æŸ¥**:

```rego
# è¾…åŠ©å‡½æ•°ï¼šéªŒè¯è¾“å…¥ç±»å‹
valid_input {
    is_string(input.user)
    is_string(input.resource)
    is_string(input.action)
}
```

**æ­¥éª¤3ï¼šå®ç°ä¸šåŠ¡é€»è¾‘**:

```rego
allow {
    valid_input  # ç±»å‹æ£€æŸ¥
    data.permissions[input.user][input.resource][input.action]
}
```

### 2.3 ç±»å‹ä¼˜å…ˆè®¾è®¡

**è®¾è®¡æ¨¡å¼**:

```rego
# 1. å®šä¹‰æ•°æ®æ¨¡å‹
package model

# Userç±»å‹
# type User = {
#   id: string,
#   name: string,
#   roles: set<string>,
#   metadata: object<string, any>
# }

# 2. å®šä¹‰ç±»å‹éªŒè¯
is_valid_user(user) {
    is_string(user.id)
    is_string(user.name)
    is_set(user.roles)
    is_object(user.metadata)
}

# 3. ä½¿ç”¨ç±»å‹å®‰å…¨çš„å‡½æ•°
get_user_roles(user) := roles {
    is_valid_user(user)
    roles := user.roles
}
```

---

## 3. å¸¸è§ç±»å‹é”™è¯¯

### 3.1 ç±»å‹ä¸åŒ¹é…

**é”™è¯¯ç¤ºä¾‹**:

```rego
# é”™è¯¯1ï¼šæ¯”è¾ƒä¸åŒç±»å‹
allow {
    input.count == "10"  # number vs string
}

# é”™è¯¯2ï¼šå¯¹éé›†åˆä½¿ç”¨é›†åˆæ“ä½œ
allow {
    input.value in 42  # 42ä¸æ˜¯é›†åˆ
}

# é”™è¯¯3ï¼šå¯¹éæ•°å­—è¿›è¡Œç®—æœ¯
total := input.price + input.tax  # å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Ÿ
```

**ä¿®æ­£æ–¹æ³•**:

```rego
# ä¿®æ­£1ï¼šç±»å‹è½¬æ¢
allow {
    to_number(input.count) == 10
}

# ä¿®æ­£2ï¼šç±»å‹æ£€æŸ¥
allow {
    is_array(input.values)
    input.value in input.values
}

# ä¿®æ­£3ï¼šç±»å‹éªŒè¯
total := result {
    is_number(input.price)
    is_number(input.tax)
    result := input.price + input.tax
}
```

### 3.2 ç©ºå€¼é”™è¯¯

**é—®é¢˜ï¼šç©ºå¼•ç”¨**:

```rego
# ä¸å®‰å…¨
user_name := input.user.name  # å¦‚æœ input.user ä¸å­˜åœ¨ï¼Ÿ

# ä¸å®‰å…¨
age := data.users[id].age  # å¦‚æœ id ä¸å­˜åœ¨ï¼Ÿ
```

**å®‰å…¨å¤„ç†**:

```rego
# æ–¹æ³•1ï¼šä½¿ç”¨é»˜è®¤å€¼
user_name := name {
    name := input.user.name
} else := "anonymous"

# æ–¹æ³•2ï¼šæ˜¾å¼æ£€æŸ¥
safe_age := age {
    data.users[id]
    age := data.users[id].age
}

# æ–¹æ³•3ï¼šä½¿ç”¨ object.get (OPA 0.43+)
age := object.get(data.users[id], "age", 0)
```

### 3.3 é›†åˆç±»å‹é”™è¯¯

**Array vs Set vs Object**:

```rego
# é”™è¯¯ï¼šæ··æ·† array å’Œ set
arr := [1, 2, 3, 2]  # array: [1, 2, 3, 2]
set := {1, 2, 3, 2}  # set: {1, 2, 3}

# é”™è¯¯ï¼šå¯¹ array ä½¿ç”¨ set æ“ä½œ
result := [1, 2] | [3, 4]  # é”™è¯¯ï¼åº”è¯¥ç”¨ array.concat

# æ­£ç¡®ï¼šè½¬æ¢åæ“ä½œ
result := arr_union(arr1, arr2)

arr_union(a1, a2) := result {
    s1 := {x | some x in a1}
    s2 := {x | some x in a2}
    result := s1 | s2
}
```

---

## 4. ç±»å‹æ³¨è§£ä¸æ–‡æ¡£

### 4.1 æ³¨é‡Šä¸­çš„ç±»å‹ä¿¡æ¯

**æ ‡å‡†æ ¼å¼**:

```rego
# has_permission æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™
#
# @param user: string - ç”¨æˆ·ID
# @param resource: string - èµ„æºæ ‡è¯†
# @param action: string - æ“ä½œç±»å‹
# @return: boolean - æ˜¯å¦æœ‰æƒé™
# @example: has_permission("alice", "/api/users", "read") == true
has_permission(user, resource, action) {
    data.acl[user][resource][action]
}
```

### 4.2 è¾“å…¥è¾“å‡ºå¥‘çº¦

**Schemaå®šä¹‰**:

```rego
package schema

# å®šä¹‰è¾“å…¥Schema
input_schema := {
    "type": "object",
    "properties": {
        "user": {"type": "string"},
        "resource": {"type": "string"},
        "action": {"type": "string"},
        "context": {
            "type": "object",
            "properties": {
                "ip": {"type": "string"},
                "timestamp": {"type": "number"}
            }
        }
    },
    "required": ["user", "resource", "action"]
}

# éªŒè¯è¾“å…¥
validate_input {
    # ä½¿ç”¨å†…ç½®å‡½æ•°æˆ–è‡ªå®šä¹‰éªŒè¯
    check_required_fields
    check_field_types
}

check_required_fields {
    input.user
    input.resource
    input.action
}

check_field_types {
    is_string(input.user)
    is_string(input.resource)
    is_string(input.action)
}
```

### 4.3 ç±»å‹ç¤ºä¾‹

**æµ‹è¯•æ•°æ®ä½œä¸ºç±»å‹æ–‡æ¡£**:

```rego
# æµ‹è¯•æ–‡ä»¶æä¾›ç±»å‹ç¤ºä¾‹
test_allow_admin {
    allow with input as {
        "user": "admin",        # string
        "resource": "/api",     # string
        "action": "write",      # string
        "context": {            # object
            "ip": "10.0.0.1",   # string
            "timestamp": 1234567890  # number
        }
    }
}
```

---

## 5. ç±»å‹å®‰å…¨æ¨¡å¼

### 5.1 é˜²å¾¡æ€§ç¼–ç¨‹

**Always Validate**:

```rego
# ä¸å®‰å…¨
process_user {
    age := input.user.age
    age >= 18
}

# å®‰å…¨
process_user {
    # å¤šå±‚é˜²å¾¡
    input.user                    # æ£€æŸ¥å­˜åœ¨
    is_object(input.user)         # æ£€æŸ¥ç±»å‹
    input.user.age                # æ£€æŸ¥å­—æ®µ
    is_number(input.user.age)     # æ£€æŸ¥å­—æ®µç±»å‹
    input.user.age >= 0           # æ£€æŸ¥å€¼åŸŸ
    input.user.age < 150          # åˆç†æ€§æ£€æŸ¥
    
    # ä¸šåŠ¡é€»è¾‘
    input.user.age >= 18
}
```

### 5.2 ç±»å‹å«è¯­å¥

**Guard Pattern**:

```rego
# å®šä¹‰ç±»å‹å«å£«
guard_string(x) {
    is_string(x)
    count(x) > 0  # éç©º
}

guard_positive_number(x) {
    is_number(x)
    x > 0
}

guard_valid_email(x) {
    is_string(x)
    regex.match(`^[^@]+@[^@]+\.[^@]+$`, x)
}

# ä½¿ç”¨å«å£«
allow {
    guard_string(input.user)
    guard_string(input.action)
    # ä¸šåŠ¡é€»è¾‘...
}
```

### 5.3 å®‰å…¨çš„ç±»å‹è½¬æ¢

**ç±»å‹è½¬æ¢å‡½æ•°**:

```rego
# å®‰å…¨çš„å­—ç¬¦ä¸²è½¬æ•°å­—
safe_to_number(str) := num {
    is_string(str)
    num := to_number(str)
} else := 0  # é»˜è®¤å€¼

# å®‰å…¨çš„æ•°ç»„è®¿é—®
safe_array_get(arr, idx) := val {
    is_array(arr)
    is_number(idx)
    idx >= 0
    idx < count(arr)
    val := arr[idx]
} else := null

# å®‰å…¨çš„å¯¹è±¡è®¿é—®
safe_object_get(obj, key, default) := val {
    is_object(obj)
    is_string(key)
    val := obj[key]
} else := default
```

---

## 6. é«˜çº§ç±»å‹æŠ€æœ¯

### 6.1 æ³›å‹æ¨¡å¼

**æ³›å‹å‡½æ•°æ¨¡æ‹Ÿ**:

```rego
# æ³›å‹ map å‡½æ•°
map_array(arr, f) := [y | some i; x := arr[i]; y := f(x)]

# ä½¿ç”¨
double(x) := x * 2
numbers := [1, 2, 3]
doubled := map_array(numbers, double)  # [2, 4, 6]

# æ³›å‹ filter å‡½æ•°
filter_array(arr, pred) := [x | some i; x := arr[i]; pred(x)]

# ä½¿ç”¨
is_even(x) { x % 2 == 0 }
numbers := [1, 2, 3, 4]
evens := filter_array(numbers, is_even)  # [2, 4]
```

### 6.2 ç±»å‹å¤šæ€

**å¤šæ€å‡½æ•°**:

```rego
# æ¥å—å¤šç§ç±»å‹çš„å‡½æ•°
length(x) := count(x) {
    # å¯¹ array, set, object, string éƒ½é€‚ç”¨
    is_collection(x)
}

is_collection(x) {
    is_array(x)
} {
    is_set(x)
} {
    is_object(x)
} {
    is_string(x)
}
```

### 6.3 ä¾èµ–ç±»å‹æ¨¡æ‹Ÿ

**å€¼ä¾èµ–çš„ç±»å‹æ£€æŸ¥**:

```rego
# æ£€æŸ¥æ•°ç»„é•¿åº¦åœ¨èŒƒå›´å†…
valid_array_length(arr, min, max) {
    is_array(arr)
    is_number(min)
    is_number(max)
    length := count(arr)
    length >= min
    length <= max
}

# æ£€æŸ¥å¯¹è±¡åŒ…å«ç‰¹å®šé”®
valid_object_keys(obj, required_keys) {
    is_object(obj)
    is_set(required_keys)
    object_keys := {k | obj[k]}
    required_keys & object_keys == required_keys
}

# ä½¿ç”¨
validate_user(user) {
    valid_object_keys(user, {"id", "name", "email"})
    is_string(user.id)
    count(user.id) > 0
}
```

---

## 7. é™æ€åˆ†æå·¥å…·

### 7.1 OPAç±»å‹æ£€æŸ¥å™¨

**ä½¿ç”¨OPAå†…ç½®ç±»å‹æ£€æŸ¥**:

```bash
# æ£€æŸ¥ç­–ç•¥
opa check policy.rego

# ä¸¥æ ¼æ¨¡å¼
opa check --strict policy.rego

# è¾“å‡ºç¤ºä¾‹
policy.rego:10: error: undefined function concat/1
```

**å¸¸è§æ£€æŸ¥**:

- âœ… æœªå®šä¹‰è§„åˆ™å¼•ç”¨
- âœ… å‚æ•°æ•°é‡ä¸åŒ¹é…
- âœ… æ˜æ˜¾çš„ç±»å‹é”™è¯¯
- âš ï¸ æ³¨æ„ï¼šä¸æ˜¯å®Œæ•´çš„ç±»å‹æ£€æŸ¥å™¨

### 7.2 Regal Linter

**å®‰è£…Regal**:

```bash
# å®‰è£…
go install github.com/styrainc/regal@latest

# æˆ–ä½¿ç”¨ Homebrew
brew install styrainc/packages/regal
```

**é…ç½® .regal.yaml**:

```yaml
rules:
  style:
    prefer-snake-case:
      level: error
  bugs:
    undefined-function:
      level: error
    constant-condition:
      level: warning
  idiomatic:
    no-defined-entrypoint:
      level: warning
  custom:
    prefer-explicit-types:
      level: warning
```

**è¿è¡ŒLinter**:

```bash
# æ£€æŸ¥å•ä¸ªæ–‡ä»¶
regal lint policy.rego

# æ£€æŸ¥æ•´ä¸ªç›®å½•
regal lint policies/

# ä¿®å¤å¯ä¿®å¤çš„é—®é¢˜
regal lint --fix policies/
```

### 7.3 è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™

**ç¼–å†™è‡ªå®šä¹‰Regalè§„åˆ™**:

```rego
# custom-rules/type-annotations.rego
package custom.rules.type_annotations

import data.regal.ast

# METADATA
# description: å‡½æ•°åº”æœ‰ç±»å‹æ³¨é‡Š
rule := {
    "category": "custom",
    "title": "missing-type-annotation"
}

violations[msg] {
    some rule in ast.rules
    not has_type_annotation(rule)
    
    msg := {
        "location": rule.location,
        "message": sprintf("å‡½æ•° %s ç¼ºå°‘ç±»å‹æ³¨é‡Š", [rule.head.name])
    }
}

has_type_annotation(rule) {
    some comment in rule.comments
    contains(comment, "@param")
    contains(comment, "@return")
}
```

---

## 8. æµ‹è¯•ä¸éªŒè¯

### 8.1 ç±»å‹æµ‹è¯•

**æµ‹è¯•ä¸åŒç±»å‹è¾“å…¥**:

```rego
# æµ‹è¯•æ­£å¸¸æƒ…å†µ
test_allow_with_valid_input {
    allow with input as {
        "user": "alice",
        "action": "read"
    }
}

# æµ‹è¯•ç±»å‹é”™è¯¯æƒ…å†µ
test_reject_with_number_user {
    not allow with input as {
        "user": 123,  # åº”è¯¥æ˜¯ string
        "action": "read"
    }
}

test_reject_with_null_action {
    not allow with input as {
        "user": "alice",
        "action": null  # åº”è¯¥æ˜¯ string
    }
}

# æµ‹è¯•ç¼ºå¤±å­—æ®µ
test_reject_with_missing_field {
    not allow with input as {
        "user": "alice"
        # ç¼ºå°‘ action
    }
}
```

### 8.2 å±æ€§æµ‹è¯•

**åŸºäºå±æ€§çš„æµ‹è¯•**:

```rego
# å±æ€§ï¼šå‡½æ•°åº”è¯¥æ˜¯çº¯å‡½æ•°
test_function_purity {
    # ç›¸åŒè¾“å…¥åº”è¯¥äº§ç”Ÿç›¸åŒè¾“å‡º
    result1 := compute_score("alice")
    result2 := compute_score("alice")
    result1 == result2
}

# å±æ€§ï¼šå‡½æ•°åº”è¯¥æ˜¯å¹‚ç­‰çš„
test_function_idempotence {
    input1 := {"user": "bob"}
    result1 := process(input1)
    result2 := process(result1)
    result1 == result2
}

# å±æ€§ï¼šç±»å‹ä¿æŒ
test_type_preservation {
    is_number(input.value)
    result := transform(input.value)
    is_number(result)  # åº”ä¿æŒç±»å‹
}
```

### 8.3 æ¨¡ç³Šæµ‹è¯•

**ç”Ÿæˆéšæœºæµ‹è¯•æ•°æ®**:

```python
# fuzzer.py - ç”ŸæˆRegoæµ‹è¯•æ•°æ®
import json
import random
import string

def generate_input():
    return {
        "user": random_string(10),
        "age": random.randint(0, 100),
        "roles": random_set(5),
        "metadata": random_object()
    }

def random_string(length):
    return ''.join(random.choices(string.ascii_letters, k=length))

def random_set(max_size):
    return list(set(random.choices(range(100), k=random.randint(1, max_size))))

def random_object():
    return {
        random_string(5): random.choice([
            random_string(10),
            random.randint(0, 1000),
            random.choice([True, False]),
            None
        ])
        for _ in range(random.randint(1, 5))
    }

# ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
for i in range(100):
    test_input = generate_input()
    with open(f'test_cases/fuzz_{i}.json', 'w') as f:
        json.dump(test_input, f)
```

**è¿è¡Œæ¨¡ç³Šæµ‹è¯•**:

```bash
# å¯¹æ‰€æœ‰ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹è¿è¡Œç­–ç•¥
for file in test_cases/fuzz_*.json; do
    opa eval --data policy.rego --input "$file" 'data.policy.allow' || echo "Failed on $file"
done
```

---

## 9. å®æˆ˜æ¡ˆä¾‹

### 9.1 RBACç­–ç•¥

**ç±»å‹å®‰å…¨çš„RBACå®ç°**:

```rego
package rbac

# ç±»å‹å®šä¹‰ï¼ˆæ³¨é‡Šï¼‰
# type User = string
# type Role = string
# type Resource = string
# type Action = string
# type Permission = {resource: Resource, actions: set<Action>}

# ç±»å‹éªŒè¯
valid_permission_check {
    is_string(input.user)
    count(input.user) > 0
    is_string(input.resource)
    count(input.resource) > 0
    is_string(input.action)
    count(input.action) > 0
}

# è·å–ç”¨æˆ·è§’è‰²ï¼ˆç±»å‹å®‰å…¨ï¼‰
user_roles[role] {
    valid_permission_check
    some role in data.role_assignments[input.user]
}

# è·å–è§’è‰²æƒé™
role_permissions[perm] {
    some role in user_roles
    some perm in data.role_permissions[role]
}

# æ£€æŸ¥æƒé™
has_permission {
    some perm in role_permissions
    perm.resource == input.resource
    input.action in perm.actions
}

# ä¸»å†³ç­–
allow {
    valid_permission_check
    has_permission
}

# æµ‹è¯•
test_admin_can_write {
    allow with input as {
        "user": "alice",
        "resource": "/api/users",
        "action": "write"
    } with data.role_assignments as {
        "alice": ["admin"]
    } with data.role_permissions as {
        "admin": [
            {
                "resource": "/api/users",
                "actions": {"read", "write", "delete"}
            }
        ]
    }
}
```

### 9.2 æ•°æ®éªŒè¯ç­–ç•¥

**ç±»å‹å®‰å…¨çš„æ•°æ®éªŒè¯**:

```rego
package validation

# éªŒè¯ç”¨æˆ·æ•°æ®
validate_user(user) = errors {
    errors := array.concat(
        check_required_fields(user),
        array.concat(
            check_field_types(user),
            check_field_constraints(user)
        )
    )
}

# æ£€æŸ¥å¿…éœ€å­—æ®µ
check_required_fields(user) := errors {
    required := {"id", "name", "email", "age"}
    provided := {k | user[k]}
    missing := required - provided
    
    errors := [sprintf("ç¼ºå°‘å¿…éœ€å­—æ®µ: %s", [f]) | some f in missing]
}

# æ£€æŸ¥å­—æ®µç±»å‹
check_field_types(user) := errors {
    type_checks := [
        {"field": "id", "check": is_string(user.id)},
        {"field": "name", "check": is_string(user.name)},
        {"field": "email", "check": is_string(user.email)},
        {"field": "age", "check": is_number(user.age)},
    ]
    
    errors := [
        sprintf("å­—æ®µ %s ç±»å‹é”™è¯¯", [check.field])
        | some check in type_checks
        not check.check
    ]
}

# æ£€æŸ¥å­—æ®µçº¦æŸ
check_field_constraints(user) := errors {
    constraint_checks := [
        {
            "name": "id_not_empty",
            "check": count(user.id) > 0
        },
        {
            "name": "valid_email",
            "check": regex.match(`^[^@]+@[^@]+\.[^@]+$`, user.email)
        },
        {
            "name": "age_range",
            "check": user.age >= 0 and user.age < 150
        },
    ]
    
    errors := [
        sprintf("çº¦æŸæ£€æŸ¥å¤±è´¥: %s", [check.name])
        | some check in constraint_checks
        not check.check
    ]
}

# æµ‹è¯•
test_valid_user {
    errors := validate_user({
        "id": "usr123",
        "name": "Alice",
        "email": "alice@example.com",
        "age": 30
    })
    count(errors) == 0
}

test_invalid_user_missing_field {
    errors := validate_user({
        "id": "usr123",
        "name": "Alice"
        # ç¼ºå°‘ email å’Œ age
    })
    count(errors) > 0
}
```

### 9.3 APIæˆæƒç­–ç•¥

**ç±»å‹å®‰å…¨çš„APIç½‘å…³æˆæƒ**:

```rego
package api.authz

import future.keywords.if
import future.keywords.in

# ç±»å‹: HTTPRequest = {
#   method: string,
#   path: array<string>,
#   headers: object<string, string>,
#   user: string
# }

# éªŒè¯è¯·æ±‚æ ¼å¼
valid_request if {
    is_string(input.method)
    is_array(input.path)
    is_object(input.headers)
    is_string(input.user)
}

# æå–JWT tokenï¼ˆç±»å‹å®‰å…¨ï¼‰
token := t if {
    auth_header := input.headers.Authorization
    is_string(auth_header)
    startswith(auth_header, "Bearer ")
    t := substring(auth_header, 7, -1)
}

# è§£ç å¹¶éªŒè¯token
decoded_token := payload if {
    token
    [_, payload, _] := io.jwt.decode(token)
    is_object(payload)
}

# æ£€æŸ¥tokenæœ‰æ•ˆæ€§
valid_token if {
    decoded_token
    is_number(decoded_token.exp)
    decoded_token.exp > time.now_ns() / 1000000000
}

# è·¯å¾„åŒ¹é…ï¼ˆç±»å‹å®‰å…¨ï¼‰
path_matches(pattern, path) if {
    is_array(pattern)
    is_array(path)
    count(pattern) == count(path)
    every i, segment in pattern {
        segment == "*" or segment == path[i]
    }
}

# ä¸»å†³ç­–
allow if {
    valid_request
    valid_token
    has_permission
}

has_permission if {
    some rule in data.api_rules
    rule.method == input.method
    path_matches(rule.path, input.path)
    input.user in rule.allowed_users
}

# æµ‹è¯•
test_allow_with_valid_token {
    allow with input as {
        "method": "GET",
        "path": ["api", "users", "123"],
        "headers": {
            "Authorization": "Bearer eyJ..."
        },
        "user": "alice"
    } with data.api_rules as [
        {
            "method": "GET",
            "path": ["api", "users", "*"],
            "allowed_users": ["alice", "bob"]
        }
    ] with time.now_ns as 1000000000000
}
```

---

## 10. æœ€ä½³å®è·µ

### 10.1 è®¾è®¡åŸåˆ™

**SOLID for Rego**:

1. **Single Responsibility** - æ¯ä¸ªè§„åˆ™åªåšä¸€ä»¶äº‹

   ```rego
   # Good
   is_admin(user) { user in data.admins }
   can_write(resource) { input.action == "write" }
   
   allow {
       is_admin(input.user)
       can_write(input.resource)
   }
   ```

2. **Open/Closed** - æ˜“äºæ‰©å±•ï¼Œéš¾ä»¥ä¿®æ”¹

   ```rego
   # å®šä¹‰æ‰©å±•ç‚¹
   permission_check {
       basic_permission_check
   }
   
   permission_check {
       advanced_permission_check
   }
   ```

3. **Type Safety** - å§‹ç»ˆéªŒè¯ç±»å‹

   ```rego
   # æ€»æ˜¯åŒ…å«ç±»å‹æ£€æŸ¥
   process(x) {
       is_expected_type(x)
       # ä¸šåŠ¡é€»è¾‘...
   }
   ```

### 10.2 ä»£ç ç»„ç»‡

**æ¨¡å—åŒ–ç»“æ„**:

```text
policies/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ types.rego          # ç±»å‹å®šä¹‰å’ŒéªŒè¯
â”‚   â”œâ”€â”€ guards.rego         # ç±»å‹å«å£«
â”‚   â””â”€â”€ utils.rego          # å·¥å…·å‡½æ•°
â”œâ”€â”€ authz/
â”‚   â”œâ”€â”€ rbac.rego          # RBACé€»è¾‘
â”‚   â”œâ”€â”€ abac.rego          # ABACé€»è¾‘
â”‚   â””â”€â”€ authz_test.rego
â”œâ”€â”€ validation/
â”‚   â”œâ”€â”€ input.rego         # è¾“å…¥éªŒè¯
â”‚   â””â”€â”€ validation_test.rego
â””â”€â”€ main.rego              # ä¸»ç­–ç•¥
```

**ç¤ºä¾‹ï¼štypes.rego**:

```rego
package lib.types

# ç±»å‹å®šä¹‰
User := {
    "id": String,
    "name": String,
    "email": Email,
    "age": PositiveInt,
    "roles": SetString
}

# ç±»å‹éªŒè¯å‡½æ•°
is_valid_user(user) {
    is_string(user.id)
    is_string(user.name)
    is_valid_email(user.email)
    is_positive_int(user.age)
    is_set_string(user.roles)
}

is_valid_email(email) {
    is_string(email)
    regex.match(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`, email)
}

is_positive_int(x) {
    is_number(x)
    x > 0
    x == round(x)
}

is_set_string(s) {
    is_set(s)
    every item in s { is_string(item) }
}
```

### 10.3 æŒç»­æ”¹è¿›

**é™æ€åˆ†æé›†æˆ**:

```yaml
# .github/workflows/opa-check.yml
name: OPA Policy Check

on: [push, pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Setup Regal
        run: go install github.com/styrainc/regal@latest
      
      - name: Check Policies
        run: |
          opa check --strict policies/
          regal lint policies/
      
      - name: Run Tests
        run: opa test policies/ -v
```

**ä»£ç å®¡æŸ¥æ¸…å•**:

- [ ] æ‰€æœ‰å‡½æ•°éƒ½æœ‰ç±»å‹æ³¨é‡Š
- [ ] è¾“å…¥éƒ½ç»è¿‡ç±»å‹éªŒè¯
- [ ] æ²¡æœ‰å‡è®¾è¾“å…¥æ€»æ˜¯å­˜åœ¨
- [ ] ä½¿ç”¨ç±»å‹å®‰å…¨çš„è¾…åŠ©å‡½æ•°
- [ ] æœ‰å®Œæ•´çš„æµ‹è¯•è¦†ç›–ï¼ˆåŒ…æ‹¬ç±»å‹é”™è¯¯æƒ…å†µï¼‰
- [ ] é€šè¿‡é™æ€åˆ†æå·¥å…·æ£€æŸ¥
- [ ] æ–‡æ¡£è¯´æ˜äº†ç±»å‹å¥‘çº¦

---

## é™„å½•

### A. ç±»å‹é€ŸæŸ¥è¡¨

| ç±»å‹ | æ£€æŸ¥å‡½æ•° | ç¤ºä¾‹å€¼ |
|------|---------|--------|
| null | - | `null` |
| boolean | `is_boolean(x)` | `true`, `false` |
| number | `is_number(x)` | `42`, `3.14` |
| string | `is_string(x)` | `"hello"` |
| array | `is_array(x)` | `[1, 2, 3]` |
| object | `is_object(x)` | `{"key": "value"}` |
| set | `is_set(x)` | `{1, 2, 3}` |

### B. é”™è¯¯è¯Šæ–­æŒ‡å—

**å¸¸è§é”™è¯¯ä¿¡æ¯åŠè§£å†³æ–¹æ¡ˆ**:

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `undefined ref` | å¼•ç”¨ä¸å­˜åœ¨çš„è·¯å¾„ | æ£€æŸ¥æ•°æ®è·¯å¾„ï¼Œæ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥ |
| `operands must be ..` | ç±»å‹ä¸åŒ¹é… | æ·»åŠ ç±»å‹æ£€æŸ¥æˆ–è½¬æ¢ |
| `function ... undefined` | å‡½æ•°ä¸å­˜åœ¨ | æ£€æŸ¥æ‹¼å†™ï¼Œå¯¼å…¥æ­£ç¡®çš„åŒ… |
| `too many/few args` | å‚æ•°æ•°é‡é”™è¯¯ | æ£€æŸ¥å‡½æ•°ç­¾å |

### C. å·¥å…·é…ç½®

**VS Codeè®¾ç½®** (`.vscode/settings.json`):

```json
{
    "opa.checkOnSave": true,
    "opa.strictMode": true,
    "opa.bundleMode": false,
    "opa.roots": ["policies/"],
    "regal.enable": true,
    "regal.configPath": ".regal.yaml"
}
```

**Regalé…ç½®** (`.regal.yaml`):

```yaml
rules:
  bugs:
    undefined-function: {level: error}
    constant-condition: {level: warning}
  style:
    prefer-snake-case: {level: warning}
    line-length: {level: warning, max-line-length: 120}
  idiomatic:
    no-defined-entrypoint: {level: ignore}
  custom:
    type-annotations: {level: warning}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
**ç»´æŠ¤è€…**: OPAæŠ€æœ¯æ–‡æ¡£é¡¹ç›®

**ç›¸å…³é˜…è¯»**:

- [ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–](../06-å½¢å¼åŒ–è¯æ˜/06.5-ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–.md) - ç†è®ºåŸºç¡€
- [Regoè¯­è¨€è§„èŒƒ](../02-è¯­è¨€æ¨¡å‹/02.1-Regoè¯­è¨€è§„èŒƒ.md) - è¯­æ³•å‚è€ƒ
- [ç­–ç•¥æµ‹è¯•æŒ‡å—](../04-ç­–ç•¥ç¼–å†™/04.4-ç­–ç•¥æµ‹è¯•.md) - æµ‹è¯•æ–¹æ³•
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../05-æœ€ä½³å®è·µ/05.6-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md) - æ€§èƒ½å»ºè®®
