# 安全加固实践

> **文档类型**: 理论实践桥梁  
> **核心主题**: OPA生产环境安全加固实战指南  
> **适用读者**: 安全工程师、DevSecOps、系统架构师  
> **先修知识**: [安全最佳实践](../05-最佳实践/05.4-安全最佳实践.md)  
> **最后更新**: 2025年10月23日  
> **文档状态**: ✅ Phase 4.4 - 理论实践  
> **实践价值**: 构建安全可信的OPA部署

---

## 🎯 文档目标

本文档将**安全理论**应用于**OPA生产加固**，帮助安全工程师建立纵深防御体系。

**核心内容**:

- 认证与授权机制
- 数据加密传输
- 安全审计与合规
- 漏洞防护与检测
- 安全配置基线

**学习价值**:

- 🔒 保护策略和数据
- 🛡️ 防御安全威胁
- 📋 满足合规要求
- 🔍 可审计可追溯

---

## 目录

[TOC内容将在后续版本补充完整，包含10大章节，预计总长度1,700行]

## 1. 安全威胁模型

### 1.1 威胁分类

| 威胁类型 | 描述 | 风险等级 |
|---------|------|---------|
| **未授权访问** | 攻击者绕过认证访问OPA | 🔴 高 |
| **中间人攻击** | 网络传输被窃听/篡改 | 🔴 高 |
| **策略注入** | 恶意策略代码注入 | 🔴 高 |
| **数据泄露** | 敏感数据被非法获取 | 🟡 中 |
| **DoS攻击** | 恶意请求耗尽资源 | 🟡 中 |
| **供应链攻击** | 依赖包被篡改 | 🟢 低 |

### 1.2 攻击面分析

```text
┌─────────────────────────────────────┐
│  OPA Attack Surface                 │
├─────────────────────────────────────┤
│  1. HTTP API (端口8181)              │ ← 认证/授权
│  2. Bundle下载 (HTTPS)               │ ← 签名验证
│  3. 决策日志 (上传)                   │ ← 加密传输
│  4. 配置文件 (文件系统)               │ ← 访问控制
│  5. 环境变量 (注入)                   │ ← 参数验证
└─────────────────────────────────────┘
```

---

## 2. 认证机制

### 2.1 Bearer Token认证

**配置**:

```yaml
# config.yaml
server:
  authentication:
    scheme: bearer
```

**客户端使用**:

```bash
# 使用Token访问
curl -H "Authorization: Bearer <token>" \
     https://opa.example.com/v1/data/policy/allow
```

### 2.2 mTLS双向认证

**生成证书**:

```bash
# 1. 生成CA
openssl genrsa -out ca.key 4096
openssl req -x509 -new -nodes -key ca.key \
    -sha256 -days 3650 -out ca.crt \
    -subj "/CN=OPA-CA"

# 2. 生成服务器证书
openssl genrsa -out server.key 4096
openssl req -new -key server.key -out server.csr \
    -subj "/CN=opa.example.com"
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out server.crt -days 365

# 3. 生成客户端证书
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.csr \
    -subj "/CN=client-app"
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out client.crt -days 365
```

**OPA配置**:

```yaml
# config.yaml
server:
  tls:
    cert_file: /certs/server.crt
    private_key_file: /certs/server.key
    ca_cert_file: /certs/ca.crt
  authentication:
    scheme: tls
```

**客户端访问**:

```bash
curl --cert client.crt --key client.key --cacert ca.crt \
     https://opa.example.com:8181/v1/data/policy/allow
```

### 2.3 OAuth2/OIDC集成

**使用Envoy做OAuth2代理**:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
data:
  envoy.yaml: |
    static_resources:
      listeners:
      - address:
          socket_address:
            address: 0.0.0.0
            port_value: 8080
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: ingress_http
              route_config:
                name: local_route
                virtual_hosts:
                - name: opa
                  domains: ["*"]
                  routes:
                  - match: { prefix: "/" }
                    route: { cluster: opa_cluster }
              http_filters:
              - name: envoy.filters.http.oauth2
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
                  config:
                    token_endpoint:
                      cluster: oauth_cluster
                      uri: https://oauth.example.com/token
                      timeout: 3s
                    authorization_endpoint: https://oauth.example.com/authorize
                    redirect_uri: https://opa.example.com/callback
                    credentials:
                      client_id: opa-client
                      client_secret:
                        name: oauth_secret
                        sds_config:
                          path: /etc/envoy/oauth_secret.yaml
              - name: envoy.filters.http.router
      clusters:
      - name: opa_cluster
        connect_timeout: 0.25s
        type: STRICT_DNS
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: opa_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: opa-service
                    port_value: 8181
```

---

## 3. 授权控制

### 3.1 API访问控制

**OPA自身的授权策略**:

```rego
package system.authz

import future.keywords.if

# 默认拒绝
default allow := false

# 允许健康检查（无需认证）
allow if {
    input.path == ["health"]
    input.method == "GET"
}

# 允许已认证用户查询策略
allow if {
    input.identity  # 已认证
    input.path[0] == "v1"
    input.path[1] == "data"
    input.method == "POST"
}

# 仅管理员可以修改策略
allow if {
    input.identity.role == "admin"
    input.path[0] == "v1"
    input.path[1] == "policies"
    input.method in ["PUT", "DELETE"]
}

# 仅管理员可以查看指标
allow if {
    input.identity.role == "admin"
    input.path == ["metrics"]
}
```

**启用系统授权**:

```yaml
# config.yaml
server:
  authorization: basic
```

### 3.2 RBAC配置

**角色定义**:

```json
{
  "roles": {
    "admin": {
      "permissions": [
        "policy:read",
        "policy:write",
        "policy:delete",
        "data:read",
        "data:write",
        "metrics:read",
        "config:write"
      ]
    },
    "developer": {
      "permissions": [
        "policy:read",
        "data:read"
      ]
    },
    "auditor": {
      "permissions": [
        "policy:read",
        "logs:read"
      ]
    }
  },
  "users": {
    "alice": {
      "roles": ["admin"]
    },
    "bob": {
      "roles": ["developer"]
    },
    "charlie": {
      "roles": ["auditor"]
    }
  }
}
```

---

## 4. 数据加密

### 4.1 传输加密

**强制HTTPS**:

```yaml
# config.yaml
server:
  tls:
    cert_file: /certs/tls.crt
    private_key_file: /certs/tls.key
  # 禁用HTTP
  addr: :0
  tls_addr: :8181
  
  # TLS配置加固
  min_tls_version: "1.2"
  cipher_suites:
    - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
    - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
```

### 4.2 静态数据加密

**加密敏感配置**:

```bash
# 使用SOPS加密配置文件
sops --encrypt config.yaml > config.enc.yaml

# 在Pod中解密
apiVersion: v1
kind: Pod
metadata:
  name: opa
spec:
  initContainers:
  - name: decrypt
    image: mozilla/sops:latest
    command:
    - sh
    - -c
    - |
      sops --decrypt /encrypted/config.enc.yaml > /config/config.yaml
    volumeMounts:
    - name: encrypted-config
      mountPath: /encrypted
    - name: config
      mountPath: /config
    env:
    - name: SOPS_AGE_KEY
      valueFrom:
        secretKeyRef:
          name: sops-key
          key: age_key
  containers:
  - name: opa
    image: openpolicyagent/opa:latest
    volumeMounts:
    - name: config
      mountPath: /config
  volumes:
  - name: encrypted-config
    configMap:
      name: opa-encrypted-config
  - name: config
    emptyDir: {}
```

### 4.3 Secret管理

**集成Vault**:

```yaml
# vault-agent-config.yaml
vault:
  address: "https://vault.example.com"
  role: "opa"

auto_auth:
  method:
    type: kubernetes
    mount_path: auth/kubernetes
    config:
      role: "opa"

template:
- destination: /vault/secrets/config.yaml
  contents: |
    bundles:
      authz:
        service: bundle_service
        credentials:
          bearer:
            token: "{{ with secret \"secret/opa/bundle-token\" }}{{ .Data.data.token }}{{ end }}"
```

---

## 5. Bundle签名验证

### 5.1 签名Bundle

**生成密钥对**:

```bash
# 生成私钥
openssl genrsa -out private_key.pem 2048

# 提取公钥
openssl rsa -in private_key.pem -pubout -out public_key.pem
```

**签名Bundle**:

```bash
# 构建并签名Bundle
opa build --sign-private-key private_key.pem \
    --signing-alg RS256 \
    --bundle \
    --output signed-bundle.tar.gz \
    policies/
```

### 5.2 验证签名

**OPA配置**:

```yaml
# config.yaml
bundles:
  authz:
    service: bundle_service
    resource: bundles/authz.tar.gz
    signing:
      keyid: my_signing_key
      scope: write
      
services:
  bundle_service:
    url: https://bundles.example.com
    
keys:
  my_signing_key:
    algorithm: RS256
    key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
      -----END PUBLIC KEY-----
```

---

## 6. 审计日志

### 6.1 决策日志

**配置决策日志**:

```yaml
# config.yaml
decision_logs:
  console: true  # 开发环境
  plugin: my_decision_logger  # 生产环境
  
plugins:
  my_decision_logger:
    url: https://log-collector.example.com/v1/logs
    credentials:
      bearer:
        token_path: /var/run/secrets/log-token
```

**决策日志格式**:

```json
{
  "labels": {
    "app": "opa",
    "id": "instance-1"
  },
  "decision_id": "4ca636c1-55e4-417a-b1d8-4aceb67960d1",
  "bundles": {
    "authz": {
      "revision": "v1.2.3"
    }
  },
  "path": "policy/allow",
  "input": {
    "user": "alice",
    "action": "read",
    "resource": "/api/data"
  },
  "result": true,
  "requested_by": "10.0.0.5",
  "timestamp": "2025-10-23T10:15:30.123456789Z",
  "metrics": {
    "timer_rego_query_eval_ns": 1234567
  }
}
```

### 6.2 日志分析

**ELK集成**:

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/opa/decision*.log
  json:
    keys_under_root: true
    add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "opa-decisions-%{+yyyy.MM.dd}"
  
setup.kibana:
  host: "kibana:5601"
```

**Kibana查询示例**:

```text
# 查找被拒绝的请求
result:false

# 查找特定用户的决策
input.user:"alice"

# 查找慢查询
metrics.timer_rego_query_eval_ns:>1000000000
```

---

## 7. 漏洞防护

### 7.1 DoS防护

**限流配置**:

```nginx
# nginx.conf
limit_req_zone $binary_remote_addr zone=opa_limit:10m rate=10r/s;

server {
    location /v1/data/ {
        limit_req zone=opa_limit burst=20 nodelay;
        
        proxy_pass http://opa_backend;
    }
}
```

**Kubernetes资源限制**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: opa
spec:
  containers:
  - name: opa
    image: openpolicyagent/opa:latest
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "2000m"
        memory: "2Gi"
```

### 7.2 输入验证

**安全的策略示例**:

```rego
package security

import future.keywords.if

# 输入验证
valid_input if {
    is_string(input.user)
    count(input.user) > 0
    count(input.user) <= 255
    regex.match(`^[a-zA-Z0-9_-]+$`, input.user)  # 只允许字母数字
}

valid_input if {
    is_string(input.action)
    input.action in {"read", "write", "delete"}  # 白名单
}

# 拒绝无效输入
deny["Invalid input"] if {
    not valid_input
}
```

### 7.3 代码注入防护

**禁用不安全的内置函数**:

```yaml
# config.yaml
runtime:
  builtins:
    # 禁用文件系统操作
    file.read: false
    file.write: false
    # 禁用网络操作（生产环境）
    http.send: false
    # 禁用代码执行
    opa.runtime: false
```

---

## 8. 安全扫描

### 8.1 静态分析

**Regal安全规则**:

```yaml
# .regal.yaml
rules:
  security:
    http-send-insecure:
      level: error
    file-read-insecure:
      level: error
    eval-unsafe:
      level: error
  bugs:
    undefined-function:
      level: error
```

### 8.2 容器扫描

**Trivy扫描**:

```bash
# 扫描OPA镜像
trivy image openpolicyagent/opa:latest

# CI/CD集成
trivy image --exit-code 1 --severity HIGH,CRITICAL \
    openpolicyagent/opa:latest
```

### 8.3 依赖扫描

**Go依赖扫描**:

```bash
# 检查已知漏洞
govulncheck ./...

# 更新依赖
go get -u all
go mod tidy
```

---

## 9. 合规性

### 9.1 SOC 2合规

**审计要点**:

- [ ] 所有API访问已认证
- [ ] 传输数据已加密（TLS 1.2+）
- [ ] 敏感数据已加密存储
- [ ] 访问日志已完整记录
- [ ] 日志已安全存储（不可篡改）
- [ ] 定期安全审计
- [ ] 漏洞修复流程

### 9.2 GDPR合规

**数据处理**:

```rego
package gdpr

import future.keywords.if

# PII字段定义
pii_fields := {"email", "phone", "ssn", "address"}

# 删除PII（决策日志）
sanitized_input := {k: v |
    some k, v in input
    not pii_fields[k]
}

# 使用脱敏输入
allow if {
    # 使用sanitized_input而不是input
    check_permission(sanitized_input)
}
```

### 9.3 HIPAA合规

**医疗数据保护**:

```yaml
# config.yaml
decision_logs:
  plugin: hipaa_logger
  
plugins:
  hipaa_logger:
    # 加密传输
    url: https://logs.example.com/v1/hipaa
    tls:
      ca_cert_file: /certs/ca.crt
    credentials:
      bearer:
        token_path: /secrets/log-token
    # 不记录敏感字段
    mask_fields:
      - input.patient.ssn
      - input.patient.medical_record
```

---

## 10. 安全配置基线

### 10.1 生产配置清单

```yaml
# production-config.yaml

# 服务器配置
server:
  addr: :0  # 禁用HTTP
  tls_addr: :8181
  tls:
    cert_file: /certs/tls.crt
    private_key_file: /certs/tls.key
    ca_cert_file: /certs/ca.crt
    min_version: "1.2"
  authentication: tls
  authorization: basic

# Bundle配置
bundles:
  authz:
    service: bundle_service
    signing:
      keyid: production_key
      scope: write

# 决策日志
decision_logs:
  plugin: secure_logger
  
# 运行时限制
runtime:
  builtins:
    http.send: false
    file.read: false
  
# 资源限制
caches:
  inter_query_builtin_cache:
    max_size_bytes: 104857600  # 100MB
```

### 10.2 安全检查脚本

```bash
#!/bin/bash
# security-check.sh

echo "=== OPA Security Audit ==="

# 1. 检查TLS配置
if curl -k https://localhost:8181/health 2>&1 | grep -q "SSL"; then
    echo "✓ TLS enabled"
else
    echo "✗ TLS not enabled" && exit 1
fi

# 2. 检查认证
if curl http://localhost:8181/v1/data 2>&1 | grep -q "401"; then
    echo "✓ Authentication required"
else
    echo "✗ No authentication" && exit 1
fi

# 3. 检查Bundle签名
if opa run --server --log-level debug 2>&1 | grep -q "bundle signature verified"; then
    echo "✓ Bundle signing enabled"
else
    echo "⚠ Bundle signing not verified"
fi

# 4. 检查决策日志
if [ -f /var/log/opa/decisions.log ]; then
    echo "✓ Decision logging enabled"
else
    echo "✗ Decision logging not enabled" && exit 1
fi

echo "=== Audit Complete ==="
```

---

**文档版本**: v1.0  
**最后更新**: 2025年10月23日  
**维护者**: OPA技术文档项目

**相关阅读**:

- [安全最佳实践](../05-最佳实践/05.4-安全最佳实践.md) - 安全指南
- [大规模部署架构](12.3-大规模部署架构.md) - 安全架构
- [CI/CD最佳实践](12.5-CI_CD最佳实践.md) - 安全CI/CD
