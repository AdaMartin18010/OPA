# CI/CDæœ€ä½³å®è·µ

> **æ–‡æ¡£ç±»å‹**: ç†è®ºå®è·µæ¡¥æ¢  
> **æ ¸å¿ƒä¸»é¢˜**: OPAç­–ç•¥çš„æŒç»­é›†æˆä¸æŒç»­éƒ¨ç½²  
> **é€‚ç”¨è¯»è€…**: DevOpså·¥ç¨‹å¸ˆã€SREã€ç­–ç•¥å¼€å‘è€…  
> **å…ˆä¿®çŸ¥è¯†**: [ç­–ç•¥æµ‹è¯•](../04-ç­–ç•¥ç¼–å†™/04.4-ç­–ç•¥æµ‹è¯•.md)ã€[ç‰ˆæœ¬æ§åˆ¶](../05-æœ€ä½³å®è·µ/05.7-ç‰ˆæœ¬æ§åˆ¶.md)  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 4.5 - ç†è®ºå®è·µ  
> **å®è·µä»·å€¼**: è‡ªåŠ¨åŒ–ç­–ç•¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## ğŸ¯ æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£å°†**DevOpsç†è®º**åº”ç”¨äº**OPAç­–ç•¥ç®¡ç†**ï¼Œæ„å»ºè‡ªåŠ¨åŒ–çš„CI/CDæµæ°´çº¿ã€‚

**æ ¸å¿ƒå†…å®¹**:

- ç­–ç•¥ç‰ˆæœ¬æ§åˆ¶
- è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹
- Bundleæ„å»ºä¸å‘å¸ƒ
- ç°åº¦å‘å¸ƒç­–ç•¥
- å›æ»šæœºåˆ¶

**å­¦ä¹ ä»·å€¼**:

- ğŸš€ å¿«é€Ÿè¿­ä»£ç­–ç•¥
- ğŸ”’ ç¡®ä¿ç­–ç•¥è´¨é‡
- ğŸ“¦ è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
- ğŸ”„ å®‰å…¨å›æ»šæœºåˆ¶

---

## ç›®å½•

[TOCå†…å®¹å°†åœ¨åç»­ç‰ˆæœ¬è¡¥å……å®Œæ•´ï¼ŒåŒ…å«10å¤§ç« èŠ‚ï¼Œé¢„è®¡æ€»é•¿åº¦1,400è¡Œ]

## 1. ç‰ˆæœ¬æ§åˆ¶

### 1.1 Gitå·¥ä½œæµ

**GitFlowæ¨¡å‹**:

```text
main (ç”Ÿäº§)
  â”œâ”€ release/v1.2.0
  â”‚   â””â”€ feature/rbac-rules
  â”‚   â””â”€ feature/api-authz
  â””â”€ develop (å¼€å‘)
      â””â”€ hotfix/security-patch
```

**åˆ†æ”¯ç­–ç•¥**:

```bash
# åŠŸèƒ½å¼€å‘
git checkout -b feature/new-policy develop

# å‘å¸ƒå‡†å¤‡
git checkout -b release/v1.2.0 develop

# ç´§æ€¥ä¿®å¤
git checkout -b hotfix/critical-fix main
```

### 1.2 è¯­ä¹‰åŒ–ç‰ˆæœ¬

**ç‰ˆæœ¬å·è§„èŒƒ**: `MAJOR.MINOR.PATCH`

- **MAJOR**: ä¸å…¼å®¹çš„APIå˜æ›´
- **MINOR**: å‘åå…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **PATCH**: å‘åå…¼å®¹çš„é—®é¢˜ä¿®æ­£

**ç¤ºä¾‹**:

```text
v1.0.0 â†’ v1.0.1  # ä¿®å¤bug
v1.0.1 â†’ v1.1.0  # æ–°å¢è§„åˆ™
v1.1.0 â†’ v2.0.0  # ç ´åæ€§å˜æ›´
```

---

## 2. è‡ªåŠ¨åŒ–æµ‹è¯•

### 2.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `policy_test.rego`

```rego
package policy.test

import future.keywords.if
import data.policy

# æµ‹è¯•ç®¡ç†å‘˜æƒé™
test_admin_can_write if {
    policy.allow with input as {
        "user": "alice",
        "role": "admin",
        "action": "write",
        "resource": "/api/data"
    } with data.users as {
        "alice": {"roles": ["admin"]}
    }
}

# æµ‹è¯•æ™®é€šç”¨æˆ·æƒé™
test_user_cannot_write if {
    not policy.allow with input as {
        "user": "bob",
        "role": "user",
        "action": "write",
        "resource": "/api/data"
    } with data.users as {
        "bob": {"roles": ["user"]}
    }
}

# è¾¹ç•Œæ¡ä»¶æµ‹è¯•
test_empty_input if {
    not policy.allow with input as {}
}

test_invalid_action if {
    not policy.allow with input as {
        "user": "alice",
        "action": "invalid"
    }
}
```

**è¿è¡Œæµ‹è¯•**:

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
opa test policies/ -v

# è¦†ç›–ç‡æŠ¥å‘Š
opa test --coverage policies/

# è¾“å‡º:
# policy.rego: 85.7% (6/7 lines)
```

### 2.2 é›†æˆæµ‹è¯•

**Conftesté›†æˆ**:

```bash
# å®‰è£…Conftest
brew install conftest

# åˆ›å»ºç­–ç•¥
# policy/k8s.rego
package main

deny[msg] {
  input.kind == "Deployment"
  not input.spec.template.spec.securityContext.runAsNonRoot
  msg := "Containers must not run as root"
}

# æµ‹è¯•Kubernetesé…ç½®
conftest test deployment.yaml
```

### 2.3 æ€§èƒ½æµ‹è¯•

**åŸºå‡†æµ‹è¯•**:

```bash
# benchmark_test.sh
#!/bin/bash

echo "=== Performance Benchmark ==="

# ç®€å•æŸ¥è¯¢åŸºå‡†
opa eval --bench --count 10000 \
    --data policy.rego \
    'data.policy.allow' \
    --input <(echo '{"user": "alice"}')

# å¤æ‚æŸ¥è¯¢åŸºå‡†
opa eval --bench --count 1000 \
    --data complex_policy.rego \
    'data.policy.allow' \
    --input complex_input.json

# æ€§èƒ½å›å½’æ£€æµ‹
if [ $(python3 check_regression.py) -eq 1 ]; then
    echo "Performance regression detected!"
    exit 1
fi
```

---

## 3. CI Pipeline

### 3.1 GitHub Actions

```yaml
# .github/workflows/opa-ci.yml
name: OPA CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Verify policies
        run: opa check --strict policies/
      
      - name: Run tests
        run: opa test policies/ -v
      
      - name: Coverage check
        run: |
          opa test --coverage policies/ > coverage.txt
          COVERAGE=$(grep -oP '\d+\.\d+(?=%)' coverage.txt | head -1)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage $COVERAGE% is below 80%"
            exit 1
          fi
      
      - name: Lint policies
        run: |
          go install github.com/styrainc/regal@latest
          regal lint policies/
      
      - name: Security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'policies/'
  
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build bundle
        run: |
          opa build --bundle policies/ \
            --output bundle.tar.gz \
            --revision ${{ github.sha }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: bundle
          path: bundle.tar.gz
```

### 3.2 GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - verify
  - test
  - build
  - deploy

variables:
  OPA_VERSION: "0.58.0"

before_script:
  - wget https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64
  - chmod +x opa_linux_amd64
  - mv opa_linux_amd64 /usr/local/bin/opa

verify:
  stage: verify
  script:
    - opa check --strict policies/
    - regal lint policies/

test:
  stage: test
  script:
    - opa test policies/ -v
    - opa test --coverage policies/
  coverage: '/\d+\.\d+%/'

build:
  stage: build
  script:
    - opa build --bundle policies/ --output bundle.tar.gz
  artifacts:
    paths:
      - bundle.tar.gz
    expire_in: 1 week

deploy_dev:
  stage: deploy
  script:
    - aws s3 cp bundle.tar.gz s3://opa-bundles-dev/bundle-${CI_COMMIT_SHA}.tar.gz
  environment:
    name: development
  only:
    - develop

deploy_prod:
  stage: deploy
  script:
    - aws s3 cp bundle.tar.gz s3://opa-bundles-prod/bundle-${CI_COMMIT_SHA}.tar.gz
  environment:
    name: production
  when: manual
  only:
    - main
```

---

## 4. CD Pipeline

### 4.1 Bundleæ„å»º

**ç­¾åBundle**:

```bash
#!/bin/bash
# build-bundle.sh

set -e

VERSION=$(git describe --tags --always)
OUTPUT="bundle-${VERSION}.tar.gz"

echo "Building bundle version: $VERSION"

# æ„å»ºBundle
opa build \
    --bundle policies/ \
    --revision "$VERSION" \
    --sign-private-key /secrets/signing-key.pem \
    --signing-alg RS256 \
    --output "$OUTPUT"

# éªŒè¯ç­¾å
opa verify \
    --public-key /secrets/signing-key.pub \
    "$OUTPUT"

echo "Bundle built and signed: $OUTPUT"
```

### 4.2 å‘å¸ƒç­–ç•¥

**å¤šç¯å¢ƒå‘å¸ƒ**:

```yaml
# ArgoCD Application
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: opa-policies
spec:
  project: default
  source:
    repoURL: https://bundles.example.com
    targetRevision: HEAD
    path: policies
  destination:
    server: https://kubernetes.default.svc
    namespace: opa-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

### 4.3 ç°åº¦å‘å¸ƒ

**Flaggeré…ç½®**:

```yaml
apiVersion: flagger.app/v1beta1
kind:  Canary
metadata:
  name: opa-canary
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: opa
  service:
    port: 8181
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        cmd: "hey -z 1m -q 10 -c 2 http://opa-canary:8181/health"
```

---

## 5. è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶

### 5.1 ç«¯åˆ°ç«¯æµ‹è¯•

**E2Eæµ‹è¯•è„šæœ¬**:

```python
# e2e_test.py
import requests
import pytest

OPA_URL = "http://localhost:8181"

class TestOPAEndpoints:
    def test_health_check(self):
        resp = requests.get(f"{OPA_URL}/health")
        assert resp.status_code == 200
        assert resp.json() == {"status": "ok"}
    
    def test_allow_admin(self):
        resp = requests.post(
            f"{OPA_URL}/v1/data/policy/allow",
            json={
                "input": {
                    "user": "alice",
                    "role": "admin",
                    "action": "write"
                }
            }
        )
        assert resp.status_code == 200
        assert resp.json()["result"] == True
    
    def test_deny_user(self):
        resp = requests.post(
            f"{OPA_URL}/v1/data/policy/allow",
            json={
                "input": {
                    "user": "bob",
                    "role": "user",
                    "action": "write"
                }
            }
        )
        assert resp.status_code == 200
        assert resp.json()["result"] == False
    
    def test_performance(self):
        import time
        start = time.time()
        for _ in range(100):
            requests.post(
                f"{OPA_URL}/v1/data/policy/allow",
                json={"input": {"user": "alice"}}
            )
        duration = time.time() - start
        avg_latency = duration / 100
        assert avg_latency < 0.050  # < 50ms

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 5.2 å¥‘çº¦æµ‹è¯•

**Pactæµ‹è¯•**:

```python
# pact_test.py
from pact import Consumer, Provider

pact = Consumer("MyApp").has_pact_with(Provider("OPA"))

pact.given("user alice is admin") \
    .upon_receiving("a request for alice's permissions") \
    .with_request("POST", "/v1/data/policy/allow") \
    .will_respond_with(200, body={"result": True})

with pact:
    # æµ‹è¯•ä»£ç 
    result = my_app.check_permission("alice", "write")
    assert result == True
```

---

## 6. ç›‘æ§ä¸å‘Šè­¦

### 6.1 éƒ¨ç½²æŒ‡æ ‡

**Prometheusç›‘æ§**:

```yaml
# prometheus-rules.yml
groups:
  - name: opa_deployment
    rules:
      - alert: OPABundleUpdateFailure
        expr: increase(bundle_loading_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "OPA bundle update failed"
          description: "Bundle loading errors detected"
      
      - alert: OPAHighErrorRate
        expr: rate(http_request_duration_seconds_count{code=~"5.."}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "OPA error rate is high"
```

### 6.2 éƒ¨ç½²é€šçŸ¥

**Slacké€šçŸ¥**:

```bash
#!/bin/bash
# notify-deployment.sh

SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

send_notification() {
    local message=$1
    local color=$2
    
    curl -X POST $SLACK_WEBHOOK \
        -H 'Content-Type: application/json' \
        -d "{
            \"attachments\": [{
                \"color\": \"$color\",
                \"title\": \"OPA Deployment\",
                \"text\": \"$message\",
                \"footer\": \"GitLab CI/CD\",
                \"ts\": $(date +%s)
            }]
        }"
}

# ä½¿ç”¨
if [ $CI_JOB_STATUS == "success" ]; then
    send_notification "âœ… Deployed to production: v${VERSION}" "good"
else
    send_notification "âŒ Deployment failed: ${CI_JOB_URL}" "danger"
fi
```

---

## 7. å›æ»šæœºåˆ¶

### 7.1 å¿«é€Ÿå›æ»š

**Kuberneteså›æ»š**:

```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
kubectl rollout undo deployment/opa

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/opa --to-revision=3

# æŸ¥çœ‹å›æ»šçŠ¶æ€
kubectl rollout status deployment/opa
```

### 7.2 Bundleç‰ˆæœ¬ç®¡ç†

**ç‰ˆæœ¬åŒ–Bundle**:

```bash
# éƒ¨ç½²ç‰¹å®šç‰ˆæœ¬
aws s3 cp s3://opa-bundles/bundle-v1.2.3.tar.gz /tmp/bundle.tar.gz

# é…ç½®OPAä½¿ç”¨ç‰¹å®šç‰ˆæœ¬
kubectl set env deployment/opa \
    BUNDLE_VERSION=v1.2.3

# éªŒè¯ç‰ˆæœ¬
kubectl logs deployment/opa | grep "bundle revision"
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 ç­–ç•¥å³ä»£ç 

**é¡¹ç›®ç»“æ„**:

```text
opa-policies/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml
â”‚       â””â”€â”€ cd.yml
â”œâ”€â”€ policies/
â”‚   â”œâ”€â”€ authz/
â”‚   â”‚   â”œâ”€â”€ rbac.rego
â”‚   â”‚   â””â”€â”€ rbac_test.rego
â”‚   â”œâ”€â”€ validation/
â”‚   â”‚   â”œâ”€â”€ k8s.rego
â”‚   â”‚   â””â”€â”€ k8s_test.rego
â”‚   â””â”€â”€ data.json
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build-bundle.sh
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â””â”€â”€ rollback.sh
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ e2e/
â”‚   â”‚   â””â”€â”€ test_api.py
â”‚   â””â”€â”€ integration/
â”‚       â””â”€â”€ test_k8s.sh
â”œâ”€â”€ .regal.yaml
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

### 8.2 ä»£ç å®¡æŸ¥æµç¨‹

**PRæ¨¡æ¿** (`.github/pull_request_template.md`):

```markdown
## Description
<!-- Describe the changes in this PR -->

## Type of change
- [ ] New policy
- [ ] Bug fix
- [ ] Performance improvement
- [ ] Breaking change
- [ ] Documentation update

## Checklist
- [ ] Tests added/updated
- [ ] Documentation updated
- [ ] Lint passed (`make lint`)
- [ ] All tests pass (`make test`)
- [ ] Coverage > 80% (`make coverage`)
- [ ] Performance regression check passed
- [ ] Security review completed

## Testing
<!-- How was this tested? -->

## Performance Impact
<!-- Any performance implications? -->
```

### 8.3 è‡ªåŠ¨åŒ–Makefile

```makefile
# Makefile

.PHONY: help verify test build deploy

help:
 @echo "Available targets:"
 @echo "  verify  - Check policy syntax"
 @echo "  lint    - Run linter"
 @echo "  test    - Run tests"
 @echo "  coverage- Generate coverage report"
 @echo "  build   - Build bundle"
 @echo "  deploy  - Deploy to production"

verify:
 opa check --strict policies/

lint:
 regal lint policies/

test:
 opa test policies/ -v

coverage:
 opa test --coverage policies/

build:
 ./scripts/build-bundle.sh

deploy:
 ./scripts/deploy.sh

ci: verify lint test coverage

all: ci build
```

---

## 9. æ•…éšœå¤„ç†

### 9.1 å¤±è´¥åœºæ™¯

| åœºæ™¯ | æ£€æµ‹æ–¹æ³• | åº”å¯¹æªæ–½ |
|------|---------|---------|
| æµ‹è¯•å¤±è´¥ | CIå¤±è´¥ | é˜»æ­¢åˆå¹¶ |
| éƒ¨ç½²å¤±è´¥ | Health checkå¤±è´¥ | è‡ªåŠ¨å›æ»š |
| æ€§èƒ½é€€åŒ– | åŸºå‡†æµ‹è¯•å¤±è´¥ | äººå·¥å®¡æŸ¥ |
| å®‰å…¨æ¼æ´ | Trivyæ‰«æ | é˜»æ­¢éƒ¨ç½² |

### 9.2 è‡ªåŠ¨å›æ»šè§¦å‘å™¨

```yaml
# rollback-policy.yaml
triggers:
  - name: high_error_rate
    condition: error_rate > 0.05
    action: rollback
  - name: high_latency
    condition: p99_latency > 100ms
    action: rollback
  - name: health_check_failure
    condition: health_check_failures > 3
    action: rollback
```

---

## 10. æŒç»­æ”¹è¿›

### 10.1 æŒ‡æ ‡è¿½è¸ª

**éƒ¨ç½²é¢‘ç‡**:

- ç›®æ ‡: æ¯å¤©è‡³å°‘1æ¬¡éƒ¨ç½²
- å½“å‰: æ¯å‘¨3æ¬¡
- æ”¹è¿›: è‡ªåŠ¨åŒ–æ›´å¤šæµç¨‹

**å˜æ›´å¤±è´¥ç‡**:

- ç›®æ ‡: < 5%
- å½“å‰: 8%
- æ”¹è¿›: å¢å¼ºæµ‹è¯•è¦†ç›–

**æ¢å¤æ—¶é—´**:

- ç›®æ ‡: < 1å°æ—¶
- å½“å‰: 2å°æ—¶
- æ”¹è¿›: è‡ªåŠ¨å›æ»š

### 10.2 åé¦ˆå¾ªç¯

```text
1. å¼€å‘ç­–ç•¥
   â†“
2. æäº¤PR
   â†“
3. è‡ªåŠ¨æµ‹è¯•
   â†“
4. ä»£ç å®¡æŸ¥
   â†“
5. åˆå¹¶åˆ°main
   â†“
6. è‡ªåŠ¨éƒ¨ç½²åˆ°dev
   â†“
7. é›†æˆæµ‹è¯•
   â†“
8. ç°åº¦å‘å¸ƒåˆ°prod
   â†“
9. ç›‘æ§æŒ‡æ ‡
   â†“
10. æ”¶é›†åé¦ˆ
   â†“
(å›åˆ°æ­¥éª¤1)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
**ç»´æŠ¤è€…**: OPAæŠ€æœ¯æ–‡æ¡£é¡¹ç›®

**ç›¸å…³é˜…è¯»**:

- [ç­–ç•¥æµ‹è¯•](../04-ç­–ç•¥ç¼–å†™/04.4-ç­–ç•¥æµ‹è¯•.md) - æµ‹è¯•æ–¹æ³•
- [ç‰ˆæœ¬æ§åˆ¶](../05-æœ€ä½³å®è·µ/05.7-ç‰ˆæœ¬æ§åˆ¶.md) - ç‰ˆæœ¬ç®¡ç†
- [å¤§è§„æ¨¡éƒ¨ç½²æ¶æ„](12.3-å¤§è§„æ¨¡éƒ¨ç½²æ¶æ„.md) - éƒ¨ç½²æ¶æ„
- [å®‰å…¨åŠ å›ºå®è·µ](12.4-å®‰å…¨åŠ å›ºå®è·µ.md) - å®‰å…¨CI/CD
