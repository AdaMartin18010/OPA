# CI/CD最佳实践

> **文档类型**: 理论实践桥梁  
> **核心主题**: OPA策略的持续集成与持续部署  
> **适用读者**: DevOps工程师、SRE、策略开发者  
> **先修知识**: [策略测试](../04-策略编写/04.4-策略测试.md)、[版本控制](../05-最佳实践/05.7-版本控制.md)  
> **最后更新**: 2025年10月23日  
> **文档状态**: ✅ Phase 4.5 - 理论实践  
> **实践价值**: 自动化策略生命周期管理

---

## 🎯 文档目标

本文档将**DevOps理论**应用于**OPA策略管理**，构建自动化的CI/CD流水线。

**核心内容**:

- 策略版本控制
- 自动化测试流程
- Bundle构建与发布
- 灰度发布策略
- 回滚机制

**学习价值**:

- 🚀 快速迭代策略
- 🔒 确保策略质量
- 📦 自动化部署流程
- 🔄 安全回滚机制

---

## 目录

[TOC内容将在后续版本补充完整，包含10大章节，预计总长度1,400行]

## 1. 版本控制

### 1.1 Git工作流

**GitFlow模型**:

```text
main (生产)
  ├─ release/v1.2.0
  │   └─ feature/rbac-rules
  │   └─ feature/api-authz
  └─ develop (开发)
      └─ hotfix/security-patch
```

**分支策略**:

```bash
# 功能开发
git checkout -b feature/new-policy develop

# 发布准备
git checkout -b release/v1.2.0 develop

# 紧急修复
git checkout -b hotfix/critical-fix main
```

### 1.2 语义化版本

**版本号规范**: `MAJOR.MINOR.PATCH`

- **MAJOR**: 不兼容的API变更
- **MINOR**: 向后兼容的功能性新增
- **PATCH**: 向后兼容的问题修正

**示例**:

```text
v1.0.0 → v1.0.1  # 修复bug
v1.0.1 → v1.1.0  # 新增规则
v1.1.0 → v2.0.0  # 破坏性变更
```

---

## 2. 自动化测试

### 2.1 单元测试

**测试文件**: `policy_test.rego`

```rego
package policy.test

import future.keywords.if
import data.policy

# 测试管理员权限
test_admin_can_write if {
    policy.allow with input as {
        "user": "alice",
        "role": "admin",
        "action": "write",
        "resource": "/api/data"
    } with data.users as {
        "alice": {"roles": ["admin"]}
    }
}

# 测试普通用户权限
test_user_cannot_write if {
    not policy.allow with input as {
        "user": "bob",
        "role": "user",
        "action": "write",
        "resource": "/api/data"
    } with data.users as {
        "bob": {"roles": ["user"]}
    }
}

# 边界条件测试
test_empty_input if {
    not policy.allow with input as {}
}

test_invalid_action if {
    not policy.allow with input as {
        "user": "alice",
        "action": "invalid"
    }
}
```

**运行测试**:

```bash
# 运行所有测试
opa test policies/ -v

# 覆盖率报告
opa test --coverage policies/

# 输出:
# policy.rego: 85.7% (6/7 lines)
```

### 2.2 集成测试

**Conftest集成**:

```bash
# 安装Conftest
brew install conftest

# 创建策略
# policy/k8s.rego
package main

deny[msg] {
  input.kind == "Deployment"
  not input.spec.template.spec.securityContext.runAsNonRoot
  msg := "Containers must not run as root"
}

# 测试Kubernetes配置
conftest test deployment.yaml
```

### 2.3 性能测试

**基准测试**:

```bash
# benchmark_test.sh
#!/bin/bash

echo "=== Performance Benchmark ==="

# 简单查询基准
opa eval --bench --count 10000 \
    --data policy.rego \
    'data.policy.allow' \
    --input <(echo '{"user": "alice"}')

# 复杂查询基准
opa eval --bench --count 1000 \
    --data complex_policy.rego \
    'data.policy.allow' \
    --input complex_input.json

# 性能回归检测
if [ $(python3 check_regression.py) -eq 1 ]; then
    echo "Performance regression detected!"
    exit 1
fi
```

---

## 3. CI Pipeline

### 3.1 GitHub Actions

```yaml
# .github/workflows/opa-ci.yml
name: OPA CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Verify policies
        run: opa check --strict policies/
      
      - name: Run tests
        run: opa test policies/ -v
      
      - name: Coverage check
        run: |
          opa test --coverage policies/ > coverage.txt
          COVERAGE=$(grep -oP '\d+\.\d+(?=%)' coverage.txt | head -1)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage $COVERAGE% is below 80%"
            exit 1
          fi
      
      - name: Lint policies
        run: |
          go install github.com/styrainc/regal@latest
          regal lint policies/
      
      - name: Security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'policies/'
  
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build bundle
        run: |
          opa build --bundle policies/ \
            --output bundle.tar.gz \
            --revision ${{ github.sha }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: bundle
          path: bundle.tar.gz
```

### 3.2 GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - verify
  - test
  - build
  - deploy

variables:
  OPA_VERSION: "0.58.0"

before_script:
  - wget https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64
  - chmod +x opa_linux_amd64
  - mv opa_linux_amd64 /usr/local/bin/opa

verify:
  stage: verify
  script:
    - opa check --strict policies/
    - regal lint policies/

test:
  stage: test
  script:
    - opa test policies/ -v
    - opa test --coverage policies/
  coverage: '/\d+\.\d+%/'

build:
  stage: build
  script:
    - opa build --bundle policies/ --output bundle.tar.gz
  artifacts:
    paths:
      - bundle.tar.gz
    expire_in: 1 week

deploy_dev:
  stage: deploy
  script:
    - aws s3 cp bundle.tar.gz s3://opa-bundles-dev/bundle-${CI_COMMIT_SHA}.tar.gz
  environment:
    name: development
  only:
    - develop

deploy_prod:
  stage: deploy
  script:
    - aws s3 cp bundle.tar.gz s3://opa-bundles-prod/bundle-${CI_COMMIT_SHA}.tar.gz
  environment:
    name: production
  when: manual
  only:
    - main
```

---

## 4. CD Pipeline

### 4.1 Bundle构建

**签名Bundle**:

```bash
#!/bin/bash
# build-bundle.sh

set -e

VERSION=$(git describe --tags --always)
OUTPUT="bundle-${VERSION}.tar.gz"

echo "Building bundle version: $VERSION"

# 构建Bundle
opa build \
    --bundle policies/ \
    --revision "$VERSION" \
    --sign-private-key /secrets/signing-key.pem \
    --signing-alg RS256 \
    --output "$OUTPUT"

# 验证签名
opa verify \
    --public-key /secrets/signing-key.pub \
    "$OUTPUT"

echo "Bundle built and signed: $OUTPUT"
```

### 4.2 发布策略

**多环境发布**:

```yaml
# ArgoCD Application
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: opa-policies
spec:
  project: default
  source:
    repoURL: https://bundles.example.com
    targetRevision: HEAD
    path: policies
  destination:
    server: https://kubernetes.default.svc
    namespace: opa-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

### 4.3 灰度发布

**Flagger配置**:

```yaml
apiVersion: flagger.app/v1beta1
kind:  Canary
metadata:
  name: opa-canary
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: opa
  service:
    port: 8181
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        cmd: "hey -z 1m -q 10 -c 2 http://opa-canary:8181/health"
```

---

## 5. 自动化测试套件

### 5.1 端到端测试

**E2E测试脚本**:

```python
# e2e_test.py
import requests
import pytest

OPA_URL = "http://localhost:8181"

class TestOPAEndpoints:
    def test_health_check(self):
        resp = requests.get(f"{OPA_URL}/health")
        assert resp.status_code == 200
        assert resp.json() == {"status": "ok"}
    
    def test_allow_admin(self):
        resp = requests.post(
            f"{OPA_URL}/v1/data/policy/allow",
            json={
                "input": {
                    "user": "alice",
                    "role": "admin",
                    "action": "write"
                }
            }
        )
        assert resp.status_code == 200
        assert resp.json()["result"] == True
    
    def test_deny_user(self):
        resp = requests.post(
            f"{OPA_URL}/v1/data/policy/allow",
            json={
                "input": {
                    "user": "bob",
                    "role": "user",
                    "action": "write"
                }
            }
        )
        assert resp.status_code == 200
        assert resp.json()["result"] == False
    
    def test_performance(self):
        import time
        start = time.time()
        for _ in range(100):
            requests.post(
                f"{OPA_URL}/v1/data/policy/allow",
                json={"input": {"user": "alice"}}
            )
        duration = time.time() - start
        avg_latency = duration / 100
        assert avg_latency < 0.050  # < 50ms

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 5.2 契约测试

**Pact测试**:

```python
# pact_test.py
from pact import Consumer, Provider

pact = Consumer("MyApp").has_pact_with(Provider("OPA"))

pact.given("user alice is admin") \
    .upon_receiving("a request for alice's permissions") \
    .with_request("POST", "/v1/data/policy/allow") \
    .will_respond_with(200, body={"result": True})

with pact:
    # 测试代码
    result = my_app.check_permission("alice", "write")
    assert result == True
```

---

## 6. 监控与告警

### 6.1 部署指标

**Prometheus监控**:

```yaml
# prometheus-rules.yml
groups:
  - name: opa_deployment
    rules:
      - alert: OPABundleUpdateFailure
        expr: increase(bundle_loading_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "OPA bundle update failed"
          description: "Bundle loading errors detected"
      
      - alert: OPAHighErrorRate
        expr: rate(http_request_duration_seconds_count{code=~"5.."}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "OPA error rate is high"
```

### 6.2 部署通知

**Slack通知**:

```bash
#!/bin/bash
# notify-deployment.sh

SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

send_notification() {
    local message=$1
    local color=$2
    
    curl -X POST $SLACK_WEBHOOK \
        -H 'Content-Type: application/json' \
        -d "{
            \"attachments\": [{
                \"color\": \"$color\",
                \"title\": \"OPA Deployment\",
                \"text\": \"$message\",
                \"footer\": \"GitLab CI/CD\",
                \"ts\": $(date +%s)
            }]
        }"
}

# 使用
if [ $CI_JOB_STATUS == "success" ]; then
    send_notification "✅ Deployed to production: v${VERSION}" "good"
else
    send_notification "❌ Deployment failed: ${CI_JOB_URL}" "danger"
fi
```

---

## 7. 回滚机制

### 7.1 快速回滚

**Kubernetes回滚**:

```bash
# 回滚到上一个版本
kubectl rollout undo deployment/opa

# 回滚到指定版本
kubectl rollout undo deployment/opa --to-revision=3

# 查看回滚状态
kubectl rollout status deployment/opa
```

### 7.2 Bundle版本管理

**版本化Bundle**:

```bash
# 部署特定版本
aws s3 cp s3://opa-bundles/bundle-v1.2.3.tar.gz /tmp/bundle.tar.gz

# 配置OPA使用特定版本
kubectl set env deployment/opa \
    BUNDLE_VERSION=v1.2.3

# 验证版本
kubectl logs deployment/opa | grep "bundle revision"
```

---

## 8. 最佳实践

### 8.1 策略即代码

**项目结构**:

```text
opa-policies/
├── .github/
│   └── workflows/
│       ├── ci.yml
│       └── cd.yml
├── policies/
│   ├── authz/
│   │   ├── rbac.rego
│   │   └── rbac_test.rego
│   ├── validation/
│   │   ├── k8s.rego
│   │   └── k8s_test.rego
│   └── data.json
├── scripts/
│   ├── build-bundle.sh
│   ├── deploy.sh
│   └── rollback.sh
├── tests/
│   ├── e2e/
│   │   └── test_api.py
│   └── integration/
│       └── test_k8s.sh
├── .regal.yaml
├── Makefile
└── README.md
```

### 8.2 代码审查流程

**PR模板** (`.github/pull_request_template.md`):

```markdown
## Description
<!-- Describe the changes in this PR -->

## Type of change
- [ ] New policy
- [ ] Bug fix
- [ ] Performance improvement
- [ ] Breaking change
- [ ] Documentation update

## Checklist
- [ ] Tests added/updated
- [ ] Documentation updated
- [ ] Lint passed (`make lint`)
- [ ] All tests pass (`make test`)
- [ ] Coverage > 80% (`make coverage`)
- [ ] Performance regression check passed
- [ ] Security review completed

## Testing
<!-- How was this tested? -->

## Performance Impact
<!-- Any performance implications? -->
```

### 8.3 自动化Makefile

```makefile
# Makefile

.PHONY: help verify test build deploy

help:
 @echo "Available targets:"
 @echo "  verify  - Check policy syntax"
 @echo "  lint    - Run linter"
 @echo "  test    - Run tests"
 @echo "  coverage- Generate coverage report"
 @echo "  build   - Build bundle"
 @echo "  deploy  - Deploy to production"

verify:
 opa check --strict policies/

lint:
 regal lint policies/

test:
 opa test policies/ -v

coverage:
 opa test --coverage policies/

build:
 ./scripts/build-bundle.sh

deploy:
 ./scripts/deploy.sh

ci: verify lint test coverage

all: ci build
```

---

## 9. 故障处理

### 9.1 失败场景

| 场景 | 检测方法 | 应对措施 |
|------|---------|---------|
| 测试失败 | CI失败 | 阻止合并 |
| 部署失败 | Health check失败 | 自动回滚 |
| 性能退化 | 基准测试失败 | 人工审查 |
| 安全漏洞 | Trivy扫描 | 阻止部署 |

### 9.2 自动回滚触发器

```yaml
# rollback-policy.yaml
triggers:
  - name: high_error_rate
    condition: error_rate > 0.05
    action: rollback
  - name: high_latency
    condition: p99_latency > 100ms
    action: rollback
  - name: health_check_failure
    condition: health_check_failures > 3
    action: rollback
```

---

## 10. 持续改进

### 10.1 指标追踪

**部署频率**:

- 目标: 每天至少1次部署
- 当前: 每周3次
- 改进: 自动化更多流程

**变更失败率**:

- 目标: < 5%
- 当前: 8%
- 改进: 增强测试覆盖

**恢复时间**:

- 目标: < 1小时
- 当前: 2小时
- 改进: 自动回滚

### 10.2 反馈循环

```text
1. 开发策略
   ↓
2. 提交PR
   ↓
3. 自动测试
   ↓
4. 代码审查
   ↓
5. 合并到main
   ↓
6. 自动部署到dev
   ↓
7. 集成测试
   ↓
8. 灰度发布到prod
   ↓
9. 监控指标
   ↓
10. 收集反馈
   ↓
(回到步骤1)
```

---

**文档版本**: v1.0  
**最后更新**: 2025年10月23日  
**维护者**: OPA技术文档项目

**相关阅读**:

- [策略测试](../04-策略编写/04.4-策略测试.md) - 测试方法
- [版本控制](../05-最佳实践/05.7-版本控制.md) - 版本管理
- [大规模部署架构](12.3-大规模部署架构.md) - 部署架构
- [安全加固实践](12.4-安全加固实践.md) - 安全CI/CD
