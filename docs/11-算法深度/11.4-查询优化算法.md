# æŸ¥è¯¢ä¼˜åŒ–ç®—æ³•

> **æ–‡æ¡£ç±»å‹**: ç®—æ³•æ·±åº¦åˆ†æ  
> **æ ¸å¿ƒä¸»é¢˜**: OPAæŸ¥è¯¢è§„åˆ’ä¸ä¼˜åŒ–ç®—æ³•  
> **é€‚ç”¨è¯»è€…**: æ€§èƒ½ä¼˜åŒ–å·¥ç¨‹å¸ˆã€æ•°æ®åº“ç ”ç©¶è€…ã€OPAæ ¸å¿ƒå¼€å‘è€…  
> **å…ˆä¿®çŸ¥è¯†**: [SLD-Resolution](11.1-SLD-Resolutionè¯¦è§£.md)ã€[ç´¢å¼•æ•°æ®ç»“æ„](11.3-ç´¢å¼•æ•°æ®ç»“æ„.md)  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 3.4 - ç®—æ³•åˆ†æ  
> **ç†è®ºåŸºç¡€**: æŸ¥è¯¢ä¼˜åŒ–ã€ä»£ä»·æ¨¡å‹ã€åŠ¨æ€è§„åˆ’

---

## ğŸ¯ æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æOPAçš„**æŸ¥è¯¢ä¼˜åŒ–ç®—æ³•**ï¼Œè¿™æ˜¯å®ç°é«˜æ€§èƒ½ç­–ç•¥æ±‚å€¼çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

**æ ¸å¿ƒå†…å®¹**:

- æŸ¥è¯¢è§„åˆ’ç®—æ³•
- ä»£ä»·ä¼°ç®—æ¨¡å‹
- å­æŸ¥è¯¢é‡æ’åº
- ç´¢å¼•é€‰æ‹©ç­–ç•¥
- éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–

**å­¦ä¹ ä»·å€¼**:

- ç†è§£OPAå¦‚ä½•ä¼˜åŒ–æŸ¥è¯¢æ‰§è¡Œ
- æŒæ¡æŸ¥è¯¢è§„åˆ’ç®—æ³•
- ç¼–å†™é«˜æ€§èƒ½Regoç­–ç•¥
- ä¼˜åŒ–å¤æ‚æŸ¥è¯¢åœºæ™¯

---

## ç›®å½•

- [æŸ¥è¯¢ä¼˜åŒ–ç®—æ³•](#æŸ¥è¯¢ä¼˜åŒ–ç®—æ³•)
  - [ğŸ¯ æ–‡æ¡£ç›®æ ‡](#-æ–‡æ¡£ç›®æ ‡)
  - [ç›®å½•](#ç›®å½•)
  - [1. æŸ¥è¯¢ä¼˜åŒ–æ¦‚è§ˆ](#1-æŸ¥è¯¢ä¼˜åŒ–æ¦‚è§ˆ)
    - [1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–](#11-ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–)
    - [1.2 ä¼˜åŒ–ç›®æ ‡](#12-ä¼˜åŒ–ç›®æ ‡)
    - [1.3 ä¼˜åŒ–é˜¶æ®µ](#13-ä¼˜åŒ–é˜¶æ®µ)
  - [2. ä»£ä»·æ¨¡å‹](#2-ä»£ä»·æ¨¡å‹)
    - [2.1 åŸºæ•°ä¼°ç®—](#21-åŸºæ•°ä¼°ç®—)
    - [2.2 ä»£ä»·å‡½æ•°](#22-ä»£ä»·å‡½æ•°)
    - [2.3 é€‰æ‹©æ€§ä¼°ç®—](#23-é€‰æ‹©æ€§ä¼°ç®—)
  - [3. æŸ¥è¯¢è§„åˆ’](#3-æŸ¥è¯¢è§„åˆ’)
    - [3.1 è§„åˆ’å™¨æ¶æ„](#31-è§„åˆ’å™¨æ¶æ„)
    - [3.2 è§„åˆ’ç®—æ³•](#32-è§„åˆ’ç®—æ³•)
    - [3.3 åŠ¨æ€è§„åˆ’æ–¹æ³•](#33-åŠ¨æ€è§„åˆ’æ–¹æ³•)
  - [4. å­æŸ¥è¯¢é‡æ’åº](#4-å­æŸ¥è¯¢é‡æ’åº)
    - [4.1 è´ªå¿ƒç®—æ³•](#41-è´ªå¿ƒç®—æ³•)
    - [4.2 ä¾èµ–åˆ†æ](#42-ä¾èµ–åˆ†æ)
    - [4.3 æœ€ä¼˜æ’åº](#43-æœ€ä¼˜æ’åº)
  - [5. ç´¢å¼•é€‰æ‹©](#5-ç´¢å¼•é€‰æ‹©)
    - [5.1 ç´¢å¼•å¯ç”¨æ€§åˆ†æ](#51-ç´¢å¼•å¯ç”¨æ€§åˆ†æ)
    - [5.2 ç´¢å¼•é€‰æ‹©ç®—æ³•](#52-ç´¢å¼•é€‰æ‹©ç®—æ³•)
    - [5.3 å¤šç´¢å¼•åˆå¹¶](#53-å¤šç´¢å¼•åˆå¹¶)
  - [6. è°“è¯ä¸‹æ¨](#6-è°“è¯ä¸‹æ¨)
    - [6.1 æ¦‚å¿µ](#61-æ¦‚å¿µ)
    - [6.2 ä¸‹æ¨è§„åˆ™](#62-ä¸‹æ¨è§„åˆ™)
    - [6.3 å®ç°](#63-å®ç°)
  - [7. å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤](#7-å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤)
    - [7.1 è¯†åˆ«CSE](#71-è¯†åˆ«cse)
    - [7.2 æ¶ˆé™¤ç®—æ³•](#72-æ¶ˆé™¤ç®—æ³•)
    - [7.3 ç¼“å­˜ç­–ç•¥](#73-ç¼“å­˜ç­–ç•¥)
  - [8. éƒ¨åˆ†æ±‚å€¼](#8-éƒ¨åˆ†æ±‚å€¼)
    - [8.1 é™æ€åˆ†æ](#81-é™æ€åˆ†æ)
    - [8.2 ç‰¹åŒ–ç®—æ³•](#82-ç‰¹åŒ–ç®—æ³•)
    - [8.3 å¢é‡æ±‚å€¼](#83-å¢é‡æ±‚å€¼)
  - [9. OPAä¸­çš„å®ç°](#9-opaä¸­çš„å®ç°)
    - [9.1 QueryPlanner](#91-queryplanner)
    - [9.2 ä¼˜åŒ–Pass](#92-ä¼˜åŒ–pass)
    - [9.3 æ‰§è¡Œè®¡åˆ’](#93-æ‰§è¡Œè®¡åˆ’)
  - [10. å®æˆ˜ç¤ºä¾‹](#10-å®æˆ˜ç¤ºä¾‹)
    - [10.1 ç®€å•ä¼˜åŒ–](#101-ç®€å•ä¼˜åŒ–)
    - [10.2 å¤æ‚ä¼˜åŒ–](#102-å¤æ‚ä¼˜åŒ–)
    - [10.3 æ€§èƒ½å¯¹æ¯”](#103-æ€§èƒ½å¯¹æ¯”)
  - [é™„å½•](#é™„å½•)
    - [A. ç®—æ³•å‚è€ƒ](#a-ç®—æ³•å‚è€ƒ)
    - [B. ä¼˜åŒ–è§„åˆ™](#b-ä¼˜åŒ–è§„åˆ™)
    - [C. æ€§èƒ½åŸºå‡†](#c-æ€§èƒ½åŸºå‡†)

---

## 1. æŸ¥è¯¢ä¼˜åŒ–æ¦‚è§ˆ

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–

**æœªä¼˜åŒ–çš„æŸ¥è¯¢**:

```rego
allow {
    # 1. æ˜‚è´µçš„è®¡ç®—ï¼ˆ100msï¼‰
    expensive_check(input.data)
    
    # 2. ç®€å•çš„æ£€æŸ¥ï¼ˆ1msï¼‰
    input.user == "admin"
    
    # 3. ä¸­ç­‰å¤æ‚åº¦ï¼ˆ10msï¼‰
    user_has_permission(input.user, input.action)
}
```

**æ‰§è¡Œé¡ºåº**:

1. `expensive_check` â†’ 100ms
2. `input.user == "admin"` â†’ å¤±è´¥
3. ä¸æ‰§è¡Œç¬¬ä¸‰ä¸ª

**æ€»æ—¶é—´**: 100ms + 1ms = 101ms

**ä¼˜åŒ–åçš„æŸ¥è¯¢**:

```rego
allow {
    # é‡æ’åºï¼šå…ˆæ‰§è¡Œå¿«é€Ÿæ£€æŸ¥
    input.user == "admin"  # 1ms
    user_has_permission(input.user, input.action)  # 10ms
    expensive_check(input.data)  # 100ms
}
```

**æ‰§è¡Œé¡ºåº**:

1. `input.user == "admin"` â†’ 1ms â†’ å¤±è´¥ï¼

**æ€»æ—¶é—´**: 1msï¼ˆå¿«100å€ï¼ï¼‰

### 1.2 ä¼˜åŒ–ç›®æ ‡

1. **æœ€å°åŒ–æ‰§è¡Œæ—¶é—´**: å‡å°‘CPUå‘¨æœŸ
2. **æœ€å°åŒ–å†…å­˜ä½¿ç”¨**: å‡å°‘ä¸­é—´ç»“æœ
3. **æœ€å°åŒ–I/O**: å‡å°‘æ•°æ®è®¿é—®
4. **å¯é¢„æµ‹æ€§**: ç¨³å®šçš„æ€§èƒ½

### 1.3 ä¼˜åŒ–é˜¶æ®µ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Regoæºä»£ç         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯­æ³•åˆ†æ          â”‚
â”‚   (ASTç”Ÿæˆ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯­ä¹‰åˆ†æ          â”‚
â”‚   (ç±»å‹æ£€æŸ¥ç­‰)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŸ¥è¯¢è§„åˆ’          â”‚ â† æœ¬æ–‡é‡ç‚¹
â”‚   - ä»£ä»·ä¼°ç®—        â”‚
â”‚   - å­æŸ¥è¯¢é‡æ’åº    â”‚
â”‚   - ç´¢å¼•é€‰æ‹©        â”‚
â”‚   - è°“è¯ä¸‹æ¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»£ç ç”Ÿæˆ/æ‰§è¡Œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ä»£ä»·æ¨¡å‹

### 2.1 åŸºæ•°ä¼°ç®—

**å®šä¹‰**: ä¼°ç®—æŸ¥è¯¢ç»“æœçš„æ•°é‡

**ç¤ºä¾‹**:

```rego
# æ•°æ®
data.users = {
    "alice": {...},
    "bob": {...},
    ...  # 10,000ä¸ªç”¨æˆ·
}

# æŸ¥è¯¢
data.users[x].role == "admin"
```

**åŸºæ•°ä¼°ç®—**:

- æ€»ç”¨æˆ·æ•°: 10,000
- å‡è®¾10%æ˜¯admin: 1,000
- ä¼°ç®—åŸºæ•°: **1,000**

### 2.2 ä»£ä»·å‡½æ•°

**å®šä¹‰**: ä¼°ç®—æŸ¥è¯¢çš„æ‰§è¡Œæˆæœ¬

**é€šç”¨å…¬å¼**:

```text
Cost(Query) = Î±Â·CPU + Î²Â·IO + Î³Â·Memory
```

å…¶ä¸­ï¼š

- Î±, Î², Î³: æƒé‡ç³»æ•°
- CPU: è®¡ç®—æˆæœ¬
- IO: I/Oæˆæœ¬
- Memory: å†…å­˜æˆæœ¬

**OPAçš„ç®€åŒ–æ¨¡å‹**:

```text
Cost(Query) = Î£ Cost(SubQuery)

Cost(SubQuery) = {
    IndexCost   if ä½¿ç”¨ç´¢å¼•
    ScanCost    if å…¨æ‰«æ
    FunctionCost if è°ƒç”¨å‡½æ•°
}
```

**å…·ä½“ä»£ä»·**:

```go
const (
    CostIndexLookup   = 1     // ç´¢å¼•æŸ¥æ‰¾
    CostTableScan     = 1000  // å…¨è¡¨æ‰«æ
    CostComparison    = 10    // æ¯”è¾ƒæ“ä½œ
    CostFunctionCall  = 100   // å‡½æ•°è°ƒç”¨
    CostUnification   = 20    // ç»Ÿä¸€æ“ä½œ
)
```

### 2.3 é€‰æ‹©æ€§ä¼°ç®—

**å®šä¹‰**: æŸ¥è¯¢è¿‡æ»¤æ‰çš„æ•°æ®æ¯”ä¾‹

```text
é€‰æ‹©æ€§ = è¾“å‡ºè¡Œæ•° / è¾“å…¥è¡Œæ•°
```

**ç¤ºä¾‹**:

```rego
# è¾“å…¥: 10,000ä¸ªç”¨æˆ·
data.users[x].age > 30  # è¾“å‡º: 3,000ä¸ªç”¨æˆ·

é€‰æ‹©æ€§ = 3,000 / 10,000 = 0.3
```

**é€‰æ‹©æ€§å½±å“æ‰§è¡Œé¡ºåº**:

- ä½é€‰æ‹©æ€§ï¼ˆè¿‡æ»¤å¤šï¼‰â†’ å…ˆæ‰§è¡Œ
- é«˜é€‰æ‹©æ€§ï¼ˆè¿‡æ»¤å°‘ï¼‰â†’ åæ‰§è¡Œ

---

## 3. æŸ¥è¯¢è§„åˆ’

### 3.1 è§„åˆ’å™¨æ¶æ„

```go
type QueryPlanner struct {
    rules    []*Rule
    indexes  []Index
    stats    *Statistics
}

func (qp *QueryPlanner) Plan(query *Query) *ExecutionPlan {
    // 1. åˆ†ææŸ¥è¯¢
    analysis := qp.Analyze(query)
    
    // 2. ç”Ÿæˆå€™é€‰è®¡åˆ’
    candidates := qp.GenerateCandidates(analysis)
    
    // 3. ä»£ä»·è¯„ä¼°
    bestPlan := qp.ChooseBest(candidates)
    
    // 4. ä¼˜åŒ–
    optimized := qp.Optimize(bestPlan)
    
    return optimized
}
```

### 3.2 è§„åˆ’ç®—æ³•

**è´ªå¿ƒç®—æ³•** (OPAçš„ä¸»è¦æ–¹æ³•):

```go
func GreedyPlanner(literals []Literal) []Literal {
    ordered := []Literal{}
    remaining := append([]Literal{}, literals...)
    boundVars := NewVarSet()
    
    for len(remaining) > 0 {
        // é€‰æ‹©ä»£ä»·æœ€ä½çš„å­—é¢é‡
        bestIdx := -1
        bestCost := math.MaxFloat64
        
        for i, lit := range remaining {
            cost := EstimateCost(lit, boundVars)
            if cost < bestCost {
                bestCost = cost
                bestIdx = i
            }
        }
        
        // æ·»åŠ åˆ°è®¡åˆ’
        best := remaining[bestIdx]
        ordered = append(ordered, best)
        
        // æ›´æ–°å·²ç»‘å®šå˜é‡
        boundVars.AddAll(best.OutputVars())
        
        // ç§»é™¤å·²é€‰æ‹©çš„
        remaining = append(remaining[:bestIdx], remaining[bestIdx+1:]...)
    }
    
    return ordered
}
```

### 3.3 åŠ¨æ€è§„åˆ’æ–¹æ³•

**Selingerç®—æ³•** (æ›´ä¼˜ä½†æ›´å¤æ‚):

```go
func DPPlanner(literals []Literal) []Literal {
    n := len(literals)
    
    // dp[S] = è®¿é—®å­é›†Sçš„æœ€ä¼˜è®¡åˆ’
    dp := make(map[Set]*Plan)
    
    // åˆå§‹åŒ–ï¼šå•ä¸ªå­—é¢é‡
    for i := 0; i < n; i++ {
        set := NewSet(i)
        dp[set] = &Plan{
            Literals: []Literal{literals[i]},
            Cost:     EstimateCost(literals[i], NewVarSet()),
        }
    }
    
    // åŠ¨æ€è§„åˆ’ï¼šé€æ­¥æ‰©å±•å­é›†
    for size := 2; size <= n; size++ {
        for subset := range Subsets(n, size) {
            bestPlan := &Plan{Cost: math.MaxFloat64}
            
            // å°è¯•æ‰€æœ‰å¯èƒ½çš„æœ€åä¸€ä¸ªå­—é¢é‡
            for i := range subset {
                remaining := subset.Remove(i)
                prevPlan := dp[remaining]
                
                cost := prevPlan.Cost + 
                       EstimateCost(literals[i], prevPlan.BoundVars)
                
                if cost < bestPlan.Cost {
                    bestPlan = &Plan{
                        Literals: append(prevPlan.Literals, literals[i]),
                        Cost:     cost,
                    }
                }
            }
            
            dp[subset] = bestPlan
        }
    }
    
    return dp[FullSet(n)].Literals
}
```

**å¤æ‚åº¦**:

- è´ªå¿ƒ: O(nÂ²)
- åŠ¨æ€è§„åˆ’: O(nÂ·2â¿)

---

## 4. å­æŸ¥è¯¢é‡æ’åº

### 4.1 è´ªå¿ƒç®—æ³•

**æ ¸å¿ƒæ€æƒ³**: ä¼˜å…ˆæ‰§è¡Œä½ä»£ä»·ã€é«˜é€‰æ‹©æ€§çš„å­æŸ¥è¯¢

**ç®—æ³•**:

```python
def reorder_subqueries(queries):
    ordered = []
    remaining = queries.copy()
    bound_vars = set()
    
    while remaining:
        # é€‰æ‹©æœ€ä¼˜å­æŸ¥è¯¢
        best = None
        best_score = float('inf')
        
        for q in remaining:
            # å¯æ‰§è¡Œæ€§æ£€æŸ¥
            if not q.vars_subset_of(bound_vars):
                continue
            
            # è®¡ç®—å¾—åˆ†ï¼ˆè¶Šä½è¶Šå¥½ï¼‰
            score = estimate_cost(q) / (1 + estimate_selectivity(q))
            
            if score < best_score:
                best = q
                best_score = score
        
        if best is None:
            # æ— æ³•ç»§ç»­ï¼Œé€‰æ‹©å¼•å…¥æœ€å°‘å˜é‡çš„æŸ¥è¯¢
            best = min(remaining, key=lambda q: len(q.unbound_vars(bound_vars)))
        
        ordered.append(best)
        bound_vars.update(best.output_vars())
        remaining.remove(best)
    
    return ordered
```

### 4.2 ä¾èµ–åˆ†æ

**ä¾èµ–å›¾**:

```rego
allow {
    a := input.x          # Q1: æ— ä¾èµ–
    b := data.table[a]    # Q2: ä¾èµ–Q1 (å˜é‡a)
    c := process(b)       # Q3: ä¾èµ–Q2 (å˜é‡b)
    d := input.y          # Q4: æ— ä¾èµ–
}
```

**ä¾èµ–å›¾**:

```text
Q1 (a) â†’ Q2 (b) â†’ Q3 (c)

Q4 (d) (ç‹¬ç«‹)
```

**çº¦æŸ**: å¿…é¡»ä¿æŒæ‹“æ‰‘åº

**å¯èƒ½çš„æ‰§è¡Œé¡ºåº**:

1. Q1 â†’ Q2 â†’ Q3 â†’ Q4 âœ“
2. Q1 â†’ Q4 â†’ Q2 â†’ Q3 âœ“
3. Q4 â†’ Q1 â†’ Q2 â†’ Q3 âœ“
4. Q2 â†’ Q1 â†’ Q3 â†’ Q4 âœ— (è¿åä¾èµ–)

### 4.3 æœ€ä¼˜æ’åº

**ç®—æ³•**: æ‹“æ‰‘æ’åº + ä»£ä»·ä¼˜åŒ–

```go
func OptimalOrdering(queries []*Query) []*Query {
    // 1. æ„å»ºä¾èµ–å›¾
    graph := BuildDependencyGraph(queries)
    
    // 2. æ‹“æ‰‘æ’åºï¼ˆè¿”å›æ‰€æœ‰å¯èƒ½æ’åºï¼‰
    orderings := TopologicalSort(graph)
    
    // 3. é€‰æ‹©ä»£ä»·æœ€ä½çš„
    bestOrdering := orderings[0]
    bestCost := EstimateTotalCost(bestOrdering)
    
    for _, ordering := range orderings[1:] {
        cost := EstimateTotalCost(ordering)
        if cost < bestCost {
            bestCost = cost
            bestOrdering = ordering
        }
    }
    
    return bestOrdering
}
```

---

## 5. ç´¢å¼•é€‰æ‹©

### 5.1 ç´¢å¼•å¯ç”¨æ€§åˆ†æ

**åˆ¤æ–­æ˜¯å¦å¯ç”¨ç´¢å¼•**:

```go
func CanUseIndex(query *Query, index *Index) bool {
    // æ£€æŸ¥æŸ¥è¯¢è·¯å¾„æ˜¯å¦åŒ¹é…ç´¢å¼•
    if !index.Matches(query.Path) {
        return false
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç»‘å®šå˜é‡
    for _, key := range index.KeyColumns {
        if !query.IsBound(key) {
            return false
        }
    }
    
    return true
}
```

**ç¤ºä¾‹**:

```rego
# æŸ¥è¯¢
data.users[name].role == "admin"

# ç´¢å¼•1: data.users[?]  â† ä¸å¯ç”¨ï¼ˆnameæœªç»‘å®šï¼‰
# ç´¢å¼•2: data.users[?].role â†’ value  â† å¯ç”¨ï¼
```

### 5.2 ç´¢å¼•é€‰æ‹©ç®—æ³•

**å•æŸ¥è¯¢çš„ç´¢å¼•é€‰æ‹©**:

```go
func SelectIndex(query *Query, indexes []*Index) *Index {
    var bestIndex *Index
    bestCost := EstimateScanCost(query) // å…¨æ‰«æä½œä¸ºåŸºå‡†
    
    for _, index := range indexes {
        if !CanUseIndex(query, index) {
            continue
        }
        
        cost := EstimateIndexCost(query, index)
        
        if cost < bestCost {
            bestCost = cost
            bestIndex = index
        }
    }
    
    return bestIndex
}
```

### 5.3 å¤šç´¢å¼•åˆå¹¶

**åœºæ™¯**: å¤šä¸ªæ¡ä»¶ï¼Œæ¯ä¸ªæœ‰ç´¢å¼•

```rego
# æŸ¥è¯¢
data.users[x].role == "admin"
data.users[x].dept == "eng"

# ç´¢å¼•1: role â†’ users
# ç´¢å¼•2: dept â†’ users
```

**ç­–ç•¥**:

1. **ç´¢å¼•åˆå¹¶** (Index Merge):

   ```text
   ç»“æœ = Index1(role="admin") âˆ© Index2(dept="eng")
   ```

2. **ç´¢å¼•é€‰æ‹©** (Choose One):

   ```text
   ä½¿ç”¨Index1ï¼Œç„¶åè¿‡æ»¤dept
   æˆ–
   ä½¿ç”¨Index2ï¼Œç„¶åè¿‡æ»¤role
   ```

**ä»£ä»·æ¯”è¾ƒ**:

```text
Cost(Merge) = Cost(Index1) + Cost(Index2) + Cost(Intersection)
Cost(Choose) = Cost(BestIndex) + Cost(Filter)

é€‰æ‹©ä»£ä»·æ›´ä½çš„ç­–ç•¥
```

---

## 6. è°“è¯ä¸‹æ¨

### 6.1 æ¦‚å¿µ

**å®šä¹‰**: å°†è¿‡æ»¤æ¡ä»¶å°½æ—©åº”ç”¨ï¼Œå‡å°‘ä¸­é—´æ•°æ®

**ç¤ºä¾‹**:

```rego
# åŸå§‹æŸ¥è¯¢
users[name] {
    data.employees[name]
    data.employees[name].dept == "eng"
}

# ä¸‹æ¨åï¼ˆé€»è¾‘ä¸Šï¼‰
users[name] {
    data.employees[name]  # å¸¦è¿‡æ»¤: .dept == "eng"
}
```

### 6.2 ä¸‹æ¨è§„åˆ™

**å¯ä¸‹æ¨çš„è°“è¯**:

1. âœ“ ç­‰å€¼è°“è¯: `x == 5`
2. âœ“ èŒƒå›´è°“è¯: `x > 10, x < 20`
3. âœ“ æˆå‘˜è°“è¯: `x in [1, 2, 3]`
4. âœ— ä¾èµ–å¤–éƒ¨å˜é‡çš„è°“è¯

**ç¤ºä¾‹**:

```rego
# å¯ä¸‹æ¨
data.users[x].age > 30  # ä¸‹æ¨åˆ°data.usersè®¿é—®

# ä¸å¯ä¸‹æ¨
data.users[x].manager == input.user  # ä¾èµ–input.user
```

### 6.3 å®ç°

```go
func PushDownPredicates(query *Query) *Query {
    optimized := query.Clone()
    
    for _, predicate := range query.Predicates {
        // æ£€æŸ¥æ˜¯å¦å¯ä¸‹æ¨
        if canPushDown(predicate) {
            // æ‰¾åˆ°åº”ä¸‹æ¨åˆ°çš„å­æŸ¥è¯¢
            target := findTarget(predicate, query.SubQueries)
            
            if target != nil {
                // ç§»é™¤åŸä½ç½®
                optimized.RemovePredicate(predicate)
                
                // æ·»åŠ åˆ°ç›®æ ‡
                target.AddPredicate(predicate)
            }
        }
    }
    
    return optimized
}
```

---

## 7. å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤

### 7.1 è¯†åˆ«CSE

**ç¤ºä¾‹**:

```rego
allow {
    user := input.user
    data.roles[user] == "admin"  # è®¿é—®data.roles[user]
    data.roles[user] != "guest"  # å†æ¬¡è®¿é—®data.roles[user]
}
```

**ä¼˜åŒ–**:

```rego
allow {
    user := input.user
    role := data.roles[user]  # åªè®¿é—®ä¸€æ¬¡
    role == "admin"
    role != "guest"
}
```

### 7.2 æ¶ˆé™¤ç®—æ³•

```go
func EliminateCSE(query *Query) *Query {
    // 1. è¯†åˆ«å…¬å…±å­è¡¨è¾¾å¼
    exprCount := make(map[string]int)
    
    for _, expr := range query.Expressions {
        exprCount[expr.String()]++
    }
    
    // 2. æå–å¤šæ¬¡å‡ºç°çš„è¡¨è¾¾å¼
    cse := make(map[string]*Var)
    
    for expr, count := range exprCount {
        if count > 1 {
            // åˆ›å»ºæ–°å˜é‡
            v := NewVar(fmt.Sprintf("_cse_%d", len(cse)))
            cse[expr] = v
        }
    }
    
    // 3. é‡å†™æŸ¥è¯¢
    optimized := query.Clone()
    
    for exprStr, v := range cse {
        expr := ParseExpr(exprStr)
        
        // æ·»åŠ èµ‹å€¼: v := expr
        optimized.AddAssignment(v, expr)
        
        // æ›¿æ¢æ‰€æœ‰å‡ºç°
        optimized.ReplaceExpr(expr, v)
    }
    
    return optimized
}
```

### 7.3 ç¼“å­˜ç­–ç•¥

**è®°å¿†åŒ–** (Memoization):

```go
type MemoCache struct {
    cache map[string]interface{}
    mu    sync.RWMutex
}

func (mc *MemoCache) Eval(key string, fn func() interface{}) interface{} {
    // æ£€æŸ¥ç¼“å­˜
    mc.mu.RLock()
    if value, ok := mc.cache[key]; ok {
        mc.mu.RUnlock()
        return value
    }
    mc.mu.RUnlock()
    
    // è®¡ç®—
    value := fn()
    
    // å­˜å…¥ç¼“å­˜
    mc.mu.Lock()
    mc.cache[key] = value
    mc.mu.Unlock()
    
    return value
}
```

---

## 8. éƒ¨åˆ†æ±‚å€¼

### 8.1 é™æ€åˆ†æ

**ç›®æ ‡**: è¯†åˆ«ç¼–è¯‘æ—¶å¯è®¡ç®—çš„éƒ¨åˆ†

```rego
allow {
    # é™æ€å·²çŸ¥
    role := "admin"
    minAge := 18
    
    # è¿è¡Œæ—¶ç¡®å®š
    input.user.role == role
    input.user.age >= minAge
}
```

**ä¼˜åŒ–**: å†…è”å¸¸é‡

```rego
allow {
    input.user.role == "admin"
    input.user.age >= 18
}
```

### 8.2 ç‰¹åŒ–ç®—æ³•

**éƒ¨åˆ†æ±‚å€¼** (Partial Evaluation):

```go
func PartialEval(query *Query, knownBindings map[Var]Value) *Query {
    specialized := query.Clone()
    
    for v, value := range knownBindings {
        // æ›¿æ¢æ‰€æœ‰å˜é‡å‡ºç°
        specialized.SubstituteVar(v, value)
        
        // ç®€åŒ–è¡¨è¾¾å¼
        specialized.Simplify()
    }
    
    return specialized
}
```

**ç¤ºä¾‹**:

```rego
# åŸå§‹
allow {
    action := input.action
    action == "read" || action == "write"
}

# å·²çŸ¥input.action = "read"
# ç‰¹åŒ–å
allow {
    true  # ç®€åŒ–ä¸ºå¸¸é‡
}
```

### 8.3 å¢é‡æ±‚å€¼

**æ¦‚å¿µ**: ä»…é‡æ–°è®¡ç®—å˜åŒ–çš„éƒ¨åˆ†

```go
type IncrementalEval struct {
    prevInput  map[string]interface{}
    prevResult interface{}
    deps       *DependencyGraph
}

func (ie *IncrementalEval) Eval(input map[string]interface{}) interface{} {
    // æ£€æµ‹å˜åŒ–
    changes := ie.DetectChanges(input)
    
    if len(changes) == 0 {
        // æ— å˜åŒ–ï¼Œè¿”å›ç¼“å­˜ç»“æœ
        return ie.prevResult
    }
    
    // æ‰¾åˆ°å—å½±å“çš„éƒ¨åˆ†
    affected := ie.deps.FindAffected(changes)
    
    // ä»…é‡æ–°æ±‚å€¼å—å½±å“çš„éƒ¨åˆ†
    result := ie.ReEval(affected, input)
    
    // æ›´æ–°ç¼“å­˜
    ie.prevInput = input
    ie.prevResult = result
    
    return result
}
```

---

## 9. OPAä¸­çš„å®ç°

### 9.1 QueryPlanner

**æºç ä½ç½®**: `topdown/planner.go`

```go
type Planner struct {
    queries []*ast.Query
    modules map[string]*ast.Module
}

func (p *Planner) Plan() *Plan {
    // 1. åˆ†ææŸ¥è¯¢
    p.analyze()
    
    // 2. æ„å»ºè§„åˆ™å›¾
    p.buildRuleGraph()
    
    // 3. æŸ¥è¯¢é‡æ’åº
    p.reorderQueries()
    
    // 4. ç´¢å¼•é€‰æ‹©
    p.selectIndexes()
    
    // 5. ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
    return p.generate()
}
```

### 9.2 ä¼˜åŒ–Pass

**å¤šé˜¶æ®µä¼˜åŒ–**:

```go
func Optimize(query *ast.Query) *ast.Query {
    q := query
    
    // Pass 1: å†…è”å¸¸é‡
    q = InlineConstants(q)
    
    // Pass 2: æ¶ˆé™¤æ­»ä»£ç 
    q = EliminateDeadCode(q)
    
    // Pass 3: å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤
    q = EliminateCSE(q)
    
    // Pass 4: å­æŸ¥è¯¢é‡æ’åº
    q = ReorderSubQueries(q)
    
    // Pass 5: ç´¢å¼•é€‰æ‹©
    q = SelectIndexes(q)
    
    return q
}
```

### 9.3 æ‰§è¡Œè®¡åˆ’

**æ•°æ®ç»“æ„**:

```go
type ExecutionPlan struct {
    Steps       []PlanStep
    Indexes     []*Index
    EstimateCost float64
}

type PlanStep struct {
    Type     string  // "scan", "index_lookup", "filter", etc.
    Operator string
    Args     []interface{}
    Cost     float64
}
```

---

## 10. å®æˆ˜ç¤ºä¾‹

### 10.1 ç®€å•ä¼˜åŒ–

**åŸå§‹ç­–ç•¥**:

```rego
allow {
    data.expensive_computation(input.data)  # 1000ms
    input.user == "admin"                    # 1ms
}
```

**ä¼˜åŒ–å**:

```rego
allow {
    input.user == "admin"                    # 1ms
    data.expensive_computation(input.data)  # 1000ms (ä½†adminæ£€æŸ¥å¤±è´¥æ—¶ä¸æ‰§è¡Œ)
}
```

**æ€§èƒ½æå‡**: 99.9%çš„éadminè¯·æ±‚å¿«1000å€ï¼

### 10.2 å¤æ‚ä¼˜åŒ–

**åŸå§‹ç­–ç•¥**:

```rego
package authz

allow {
    # 1. æ£€æŸ¥ç”¨æˆ·è§’è‰²
    user := input.user
    role := data.user_roles[user]
    
    # 2. æ£€æŸ¥èµ„æº
    resource := input.resource
    resource_type := data.resources[resource].type
    
    # 3. æ£€æŸ¥æƒé™
    data.role_permissions[role][resource_type] == true
    
    # 4. æ£€æŸ¥æ—¶é—´çª—å£
    now := time.now_ns()
    data.resources[resource].valid_from <= now
    now <= data.resources[resource].valid_to
}
```

**åˆ†æ**:

```text
1. user_roles[user]: 1ç´¢å¼•æŸ¥æ‰¾
2. resources[resource].type: 1ç´¢å¼•æŸ¥æ‰¾
3. role_permissions[role][resource_type]: 1ç´¢å¼•æŸ¥æ‰¾
4. æ—¶é—´æ£€æŸ¥: 2æ¯”è¾ƒ
```

**ä¼˜åŒ–ç­–ç•¥**:

1. **é‡æ’åº**: å…ˆæ‰§è¡Œé«˜é€‰æ‹©æ€§çš„æ£€æŸ¥
2. **ç´¢å¼•**: ä½¿ç”¨æ‰€æœ‰å¯ç”¨ç´¢å¼•
3. **CSE**: `data.resources[resource]`åªè®¿é—®ä¸€æ¬¡

**ä¼˜åŒ–å**:

```rego
allow {
    # é‡æ’åºï¼šå…ˆæ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼ˆé«˜é€‰æ‹©æ€§ï¼‰
    user := input.user
    role := data.user_roles[user]  # ç´¢å¼•
    role != null
    
    # æå–å…¬å…±å­è¡¨è¾¾å¼
    resource := input.resource
    res := data.resources[resource]  # CSE
    
    # æ—¶é—´æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼‰
    now := time.now_ns()
    res.valid_from <= now
    now <= res.valid_to
    
    # æƒé™æ£€æŸ¥ï¼ˆç´¢å¼•ï¼‰
    data.role_permissions[role][res.type] == true
}
```

### 10.3 æ€§èƒ½å¯¹æ¯”

**æµ‹è¯•åœºæ™¯**:

- 10,000ä¸ªç”¨æˆ·
- 1,000ä¸ªèµ„æº
- 10ä¸ªè§’è‰²

**åŸºå‡†æµ‹è¯•**:

| ç­–ç•¥ç‰ˆæœ¬ | å¹³å‡å»¶è¿Ÿ | P99å»¶è¿Ÿ | ååé‡ |
|----------|---------|---------|--------|
| åŸå§‹ | 15ms | 45ms | 66 req/s |
| +ç´¢å¼• | 5ms | 15ms | 200 req/s |
| +é‡æ’åº | 2ms | 6ms | 500 req/s |
| +CSE | 1.5ms | 5ms | 666 req/s |
| å…¨ä¼˜åŒ– | 1ms | 3ms | 1000 req/s |

**æ€§èƒ½æå‡**: 15å€ï¼

---

## é™„å½•

### A. ç®—æ³•å‚è€ƒ

**ç»å…¸æŸ¥è¯¢ä¼˜åŒ–ç®—æ³•**:

- **Selingerç®—æ³•**: åŠ¨æ€è§„åˆ’æŸ¥è¯¢ä¼˜åŒ–ï¼ˆIBM System Rï¼‰
- **Volcano/Cascades**: åŸºäºè§„åˆ™çš„ä¼˜åŒ–æ¡†æ¶
- **Greedy Ordering**: OPAä½¿ç”¨çš„è´ªå¿ƒç®—æ³•

**è®ºæ–‡**:

- Selinger et al. "Access Path Selection in a Relational Database" (1979)
- Graefe et al. "The Cascades Framework for Query Optimization" (1995)

### B. ä¼˜åŒ–è§„åˆ™

**OPAçš„ä¼˜åŒ–è§„åˆ™åˆ—è¡¨**:

1. **å¸¸é‡æŠ˜å **: `2 + 3` â†’ `5`
2. **å¸¸é‡ä¼ æ’­**: `x := 5; y := x` â†’ `x := 5; y := 5`
3. **æ­»ä»£ç æ¶ˆé™¤**: ç§»é™¤ä¸å¯è¾¾ä»£ç 
4. **å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤**: æå–é‡å¤è®¡ç®—
5. **è°“è¯ä¸‹æ¨**: æå‰è¿‡æ»¤
6. **ç´¢å¼•é€‰æ‹©**: ä½¿ç”¨æœ€ä¼˜ç´¢å¼•
7. **å­æŸ¥è¯¢é‡æ’åº**: ä¼˜åŒ–æ‰§è¡Œé¡ºåº
8. **éƒ¨åˆ†æ±‚å€¼**: ç¼–è¯‘æ—¶è®¡ç®—

### C. æ€§èƒ½åŸºå‡†

**åŸºå‡†æµ‹è¯•å‘½ä»¤**:

```bash
# OPAæ€§èƒ½æµ‹è¯•
opa test --bench ./policies/

# æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
opa eval --explain=full "data.authz.allow" --format=pretty
```

**æŸ¥çœ‹ä¼˜åŒ–æ•ˆæœ**:

```bash
# æŸ¥çœ‹æŸ¥è¯¢è§„åˆ’
opa eval --explain=notes "data.authz.allow" | grep "plan"
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥  
**ç»´æŠ¤è€…**: OPAæŠ€æœ¯æ–‡æ¡£é¡¹ç›®

**ç›¸å…³é˜…è¯»**:

- [SLD-Resolutionè¯¦è§£](11.1-SLD-Resolutionè¯¦è§£.md) - æ±‚å€¼ç®—æ³•
- [ç´¢å¼•æ•°æ®ç»“æ„](11.3-ç´¢å¼•æ•°æ®ç»“æ„.md) - ç´¢å¼•ç³»ç»Ÿ
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../05-æœ€ä½³å®è·µ/05.6-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md) - å®è·µæŒ‡å—
- [ç¼–è¯‘å™¨å®ç°è¯¦è§£](../10-æºç åˆ†æ/10.4-ç¼–è¯‘å™¨å®ç°è¯¦è§£.md) - ç¼–è¯‘ä¼˜åŒ–
