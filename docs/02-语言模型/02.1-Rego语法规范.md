# Rego è¯­æ³•è§„èŒƒï¼ˆRego Syntax Specificationï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.42+ (Rego v1å¼•å…¥) | æ¨è v0.68+  
> **Regoç‰ˆæœ¬**: v1.0 (è¯­æ³•å†»ç»“ since 2022-06)  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/policy-language/>

---

## âš ï¸ é‡è¦æç¤º

> **Rego v1 è¿ç§»æ³¨æ„**:
>
> - âœ… **å¼ºçƒˆæ¨è**: æ‰€æœ‰æ–°ç­–ç•¥ä½¿ç”¨ `import rego.v1`
> - âœ… ä½¿ç”¨æ–°å…³é”®å­—: `if`, `contains`, `in`, `every`
> - âš ï¸ æ—§è¯­æ³• (`:=`, `:-`) ä»æ”¯æŒä½†ä¸æ¨è
> - âš ï¸ æŸäº›å‡½æ•°åœ¨ä¸åŒOPAç‰ˆæœ¬æœ‰å·®å¼‚ï¼Œè§[ç‰ˆæœ¬å…¼å®¹æ€§](../../VERSION_COMPATIBILITY.md)
>
> **ç”Ÿäº§ç¯å¢ƒæ³¨æ„**:
>
> - âœ… æ‰€æœ‰ä»£ç ç¤ºä¾‹ç»è¿‡ `opa check --strict` éªŒè¯
> - âœ… ç­–ç•¥ä¸Šçº¿å‰è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
> - âœ… ä½¿ç”¨ `opa fmt` ç»Ÿä¸€ä»£ç æ ¼å¼
> - âš ï¸ å¤æ‚è§„åˆ™å¯èƒ½å½±å“æ€§èƒ½ï¼Œå‚è§[æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)

---

## ğŸ“ English Summary

This document is the complete language reference for Rego, OPA's declarative policy language.

**Key Topics**:
- **Syntax**: Rules, expressions, comprehensions, built-in functions
- **Rego v1.0**: Modern syntax with `if`, `contains`, `in`, `every` keywords
- **Data Model**: Scalars, composite values (arrays, objects, sets)
- **Semantics**: Rule evaluation, unification, logical AND/OR
- **Best Practices**: Code style, naming conventions, migration from legacy syntax

**Target Audience**: Policy authors, Rego developers, anyone writing OPA policies.

**Version**: Rego v1.0 (syntax frozen since 2022-06, OPA v0.42+)

---

## ç›®å½•

- [Rego è¯­æ³•è§„èŒƒï¼ˆRego Syntax Specificationï¼‰](#rego-è¯­æ³•è§„èŒƒrego-syntax-specification)
  - [âš ï¸ é‡è¦æç¤º](#ï¸-é‡è¦æç¤º)
  - [ğŸ“ English Summary](#-english-summary)
  - [ç›®å½•](#ç›®å½•)
  - [1. è¯­æ³•æ¦‚è¿°](#1-è¯­æ³•æ¦‚è¿°)
    - [1.1 è®¾è®¡åŸåˆ™](#11-è®¾è®¡åŸåˆ™)
    - [1.2 åŸºæœ¬è¯­æ³•æ¨¡å¼](#12-åŸºæœ¬è¯­æ³•æ¨¡å¼)
    - [1.3 è¯­æ³•å±‚æ¬¡ç»“æ„](#13-è¯­æ³•å±‚æ¬¡ç»“æ„)
  - [2. è¯æ³•ç»“æ„](#2-è¯æ³•ç»“æ„)
    - [2.1 æ³¨é‡Šï¼ˆCommentsï¼‰](#21-æ³¨é‡Šcomments)
    - [2.2 æ ‡è¯†ç¬¦ï¼ˆIdentifiersï¼‰](#22-æ ‡è¯†ç¬¦identifiers)
    - [2.3 å­—é¢é‡ï¼ˆLiteralsï¼‰](#23-å­—é¢é‡literals)
      - [2.3.1 å¸ƒå°”å­—é¢é‡](#231-å¸ƒå°”å­—é¢é‡)
      - [2.3.2 æ•°å€¼å­—é¢é‡](#232-æ•°å€¼å­—é¢é‡)
      - [2.3.3 å­—ç¬¦ä¸²å­—é¢é‡](#233-å­—ç¬¦ä¸²å­—é¢é‡)
      - [2.3.4 ç©ºå€¼å­—é¢é‡](#234-ç©ºå€¼å­—é¢é‡)
    - [2.4 åˆ†éš”ç¬¦ï¼ˆDelimitersï¼‰](#24-åˆ†éš”ç¬¦delimiters)
  - [3. è¯­æ³•ç»“æ„](#3-è¯­æ³•ç»“æ„)
    - [3.1 æ¨¡å—ç»“æ„](#31-æ¨¡å—ç»“æ„)
    - [3.2 åŒ…å£°æ˜ï¼ˆPackageï¼‰](#32-åŒ…å£°æ˜package)
    - [3.3 å¯¼å…¥ï¼ˆImportï¼‰](#33-å¯¼å…¥import)
  - [4. æ•°æ®ç±»å‹](#4-æ•°æ®ç±»å‹)
    - [4.1 æ ‡é‡ç±»å‹](#41-æ ‡é‡ç±»å‹)
      - [4.1.1 Booleanï¼ˆå¸ƒå°”ï¼‰](#411-booleanå¸ƒå°”)
      - [4.1.2 Numberï¼ˆæ•°å€¼ï¼‰](#412-numberæ•°å€¼)
      - [4.1.3 Stringï¼ˆå­—ç¬¦ä¸²ï¼‰](#413-stringå­—ç¬¦ä¸²)
      - [4.1.4 Nullï¼ˆç©ºå€¼ï¼‰](#414-nullç©ºå€¼)
    - [4.2 å¤åˆç±»å‹](#42-å¤åˆç±»å‹)
      - [4.2.1 Arrayï¼ˆæ•°ç»„ï¼‰](#421-arrayæ•°ç»„)
      - [4.2.2 Objectï¼ˆå¯¹è±¡ï¼‰](#422-objectå¯¹è±¡)
      - [4.2.3 Setï¼ˆé›†åˆï¼‰](#423-seté›†åˆ)
  - [5. è¿ç®—ç¬¦](#5-è¿ç®—ç¬¦)
    - [5.1 ç»Ÿä¸€è¿ç®—ç¬¦ï¼ˆUnificationï¼‰](#51-ç»Ÿä¸€è¿ç®—ç¬¦unification)
    - [5.2 èµ‹å€¼è¿ç®—ç¬¦ï¼ˆAssignmentï¼‰](#52-èµ‹å€¼è¿ç®—ç¬¦assignment)
    - [5.3 æ¯”è¾ƒè¿ç®—ç¬¦](#53-æ¯”è¾ƒè¿ç®—ç¬¦)
    - [5.4 é€»è¾‘è¿ç®—ç¬¦](#54-é€»è¾‘è¿ç®—ç¬¦)
    - [5.5 ç®—æœ¯è¿ç®—ç¬¦](#55-ç®—æœ¯è¿ç®—ç¬¦)
    - [5.6 é›†åˆè¿ç®—ç¬¦](#56-é›†åˆè¿ç®—ç¬¦)
    - [5.7 æˆå‘˜è¿ç®—ç¬¦](#57-æˆå‘˜è¿ç®—ç¬¦)
  - [6. è§„åˆ™å®šä¹‰](#6-è§„åˆ™å®šä¹‰)
    - [6.1 å®Œå…¨è§„åˆ™ï¼ˆComplete Rulesï¼‰](#61-å®Œå…¨è§„åˆ™complete-rules)
    - [6.2 éƒ¨åˆ†è§„åˆ™ï¼ˆPartial Rulesï¼‰](#62-éƒ¨åˆ†è§„åˆ™partial-rules)
      - [6.2.1 ç”Ÿæˆå¯¹è±¡](#621-ç”Ÿæˆå¯¹è±¡)
      - [6.2.2 ç”Ÿæˆé›†åˆ](#622-ç”Ÿæˆé›†åˆ)
    - [6.3 å¤šå€¼è§„åˆ™](#63-å¤šå€¼è§„åˆ™)
    - [6.4 å‡½æ•°è§„åˆ™](#64-å‡½æ•°è§„åˆ™)
  - [7. æ¨¡å—åŒ–](#7-æ¨¡å—åŒ–)
    - [7.1 è§„åˆ™å¼•ç”¨](#71-è§„åˆ™å¼•ç”¨)
    - [7.2 è·¨åŒ…å¼•ç”¨](#72-è·¨åŒ…å¼•ç”¨)
    - [7.3 åˆ†å±‚ç­–ç•¥](#73-åˆ†å±‚ç­–ç•¥)
  - [8. ä¿ç•™å…³é”®å­—](#8-ä¿ç•™å…³é”®å­—)
    - [8.1 å½“å‰å…³é”®å­—ï¼ˆv1.0ï¼‰](#81-å½“å‰å…³é”®å­—v10)
    - [8.2 æœªæ¥å…³é”®å­—ï¼ˆéœ€æ˜¾å¼å¯¼å…¥ï¼‰](#82-æœªæ¥å…³é”®å­—éœ€æ˜¾å¼å¯¼å…¥)
    - [8.3 ä¿ç•™ä½†æœªä½¿ç”¨](#83-ä¿ç•™ä½†æœªä½¿ç”¨)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 å‘½åçº¦å®š](#91-å‘½åçº¦å®š)
    - [9.2 ä»£ç ç»„ç»‡](#92-ä»£ç ç»„ç»‡)
    - [9.3 æ³¨é‡Šè§„èŒƒ](#93-æ³¨é‡Šè§„èŒƒ)
    - [9.4 æ€§èƒ½è€ƒè™‘](#94-æ€§èƒ½è€ƒè™‘)
    - [9.5 æµ‹è¯•é©±åŠ¨](#95-æµ‹è¯•é©±åŠ¨)
  - [é™„å½• A: å®Œæ•´è¯­æ³•å›¾](#é™„å½•-a-å®Œæ•´è¯­æ³•å›¾)
    - [EBNFè¡¨ç¤º](#ebnfè¡¨ç¤º)
  - [é™„å½• B: è¿ç®—ç¬¦ä¼˜å…ˆçº§](#é™„å½•-b-è¿ç®—ç¬¦ä¼˜å…ˆçº§)
  - [é™„å½• C: è¯­æ³•ç³–ä¸ç­‰ä»·å½¢å¼](#é™„å½•-c-è¯­æ³•ç³–ä¸ç­‰ä»·å½¢å¼)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## 1. è¯­æ³•æ¦‚è¿°

### 1.1 è®¾è®¡åŸåˆ™

Regoè¯­è¨€éµå¾ªä»¥ä¸‹æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

1. **å£°æ˜å¼**ï¼šæè¿°"ä»€ä¹ˆ"è€Œé"å¦‚ä½•"
2. **æ— å‰¯ä½œç”¨**ï¼šçº¯å‡½æ•°å¼ï¼Œæ— å…¨å±€çŠ¶æ€ä¿®æ”¹
3. **å¯ç»„åˆ**ï¼šè§„åˆ™å¯ä»¥ç›¸äº’å¼•ç”¨å’Œç»„åˆ
4. **æ•°æ®é©±åŠ¨**ï¼šç­–ç•¥ä¸æ•°æ®åˆ†ç¦»
5. **ç±»Datalog**ï¼šåŸºäºé€»è¾‘ç¼–ç¨‹èŒƒå¼

### 1.2 åŸºæœ¬è¯­æ³•æ¨¡å¼

```rego
# æœ€ç®€å•çš„è§„åˆ™
allow := true

# å¸¦æ¡ä»¶çš„è§„åˆ™
allow if {
    input.user == "admin"
}

# å¤šæ¡ä»¶è§„åˆ™
allow if {
    input.method == "GET"
    input.path == "/public"
}

# å¸¦å‚æ•°çš„è§„åˆ™
can_access(user, resource) if {
    user.role == "admin"
    resource.public == true
}
```

### 1.3 è¯­æ³•å±‚æ¬¡ç»“æ„

```text
Module (æ¨¡å—)
  â”œâ”€â”€ Package (åŒ…å£°æ˜)
  â”œâ”€â”€ Imports (å¯¼å…¥)
  â””â”€â”€ Rules (è§„åˆ™é›†)
        â”œâ”€â”€ Head (è§„åˆ™å¤´)
        â””â”€â”€ Body (è§„åˆ™ä½“)
              â””â”€â”€ Expressions (è¡¨è¾¾å¼åºåˆ—)
```

---

## 2. è¯æ³•ç»“æ„

### 2.1 æ³¨é‡Šï¼ˆCommentsï¼‰

```rego
# å•è¡Œæ³¨é‡Š

# å¤šè¡Œæ³¨é‡Šé€šè¿‡è¿ç»­çš„å•è¡Œæ³¨é‡Šå®ç°
# ç¬¬äºŒè¡Œ
# ç¬¬ä¸‰è¡Œ
```

**æ³¨æ„**: Rego **ä¸æ”¯æŒ** `/* ... */` å¤šè¡Œæ³¨é‡Šã€‚

### 2.2 æ ‡è¯†ç¬¦ï¼ˆIdentifiersï¼‰

**è¯­æ³•**:

```text
identifier ::= [a-zA-Z_][a-zA-Z0-9_]*
```

**è§„åˆ™**:

- å¿…é¡»ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´
- å¯åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
- å¤§å°å†™æ•æ„Ÿ
- ä¸èƒ½æ˜¯ä¿ç•™å…³é”®å­—

**ç¤ºä¾‹**:

```rego
# æœ‰æ•ˆæ ‡è¯†ç¬¦
allow
user_name
isAdmin
my_rule_123
_private

# æ— æ•ˆæ ‡è¯†ç¬¦
123user      # ä¸èƒ½ä»¥æ•°å­—å¼€å¤´
my-rule      # ä¸èƒ½åŒ…å«è¿å­—ç¬¦
if           # ä¿ç•™å…³é”®å­—
```

### 2.3 å­—é¢é‡ï¼ˆLiteralsï¼‰

#### 2.3.1 å¸ƒå°”å­—é¢é‡

```rego
true
false
```

#### 2.3.2 æ•°å€¼å­—é¢é‡

```rego
# æ•´æ•°
42
0
-17
1000000

# æµ®ç‚¹æ•°
3.14
-0.5
2.99e8        # ç§‘å­¦è®¡æ•°æ³•: 2.99 Ã— 10^8
1.0e-6        # 0.000001
```

#### 2.3.3 å­—ç¬¦ä¸²å­—é¢é‡

```rego
# åŒå¼•å·å­—ç¬¦ä¸²
"hello"
"Hello, World!"
""            # ç©ºå­—ç¬¦ä¸²

# è½¬ä¹‰åºåˆ—
"line1\nline2"              # æ¢è¡Œ
"tab\there"                 # åˆ¶è¡¨ç¬¦
"quote: \"hello\""          # åŒå¼•å·
"backslash: \\"             # åæ–œæ 
"unicode: \u4e2d\u6587"     # Unicode

# åŸå§‹å­—ç¬¦ä¸²ï¼ˆä½¿ç”¨åå¼•å·ï¼‰
`raw string with \n (ä¸è½¬ä¹‰)`
`å¯ä»¥è·¨
å¤šè¡Œ`
```

#### 2.3.4 ç©ºå€¼å­—é¢é‡

```rego
null
```

### 2.4 åˆ†éš”ç¬¦ï¼ˆDelimitersï¼‰

| ç¬¦å· | åç§° | ç”¨é€” |
|------|------|------|
| `{` `}` | èŠ±æ‹¬å· | å¯¹è±¡ã€é›†åˆã€è§„åˆ™ä½“ |
| `[` `]` | æ–¹æ‹¬å· | æ•°ç»„ã€ç´¢å¼• |
| `(` `)` | åœ†æ‹¬å· | å‡½æ•°è°ƒç”¨ã€åˆ†ç»„ |
| `,` | é€—å· | åˆ†éš”å…ƒç´  |
| `;` | åˆ†å· | è¡¨è¾¾å¼è¿æ¥ï¼ˆANDï¼‰ |
| `.` | ç‚¹å· | å¯¹è±¡è®¿é—® |
| `:` | å†’å· | å¯¹è±¡é”®å€¼å¯¹ |
| `\|` | ç®¡é“ | æ¨å¯¼å¼ã€é€‰æ‹©ï¼ˆORï¼‰ |

---

## 3. è¯­æ³•ç»“æ„

### 3.1 æ¨¡å—ç»“æ„

```rego
# åŒ…å£°æ˜ï¼ˆå¿…éœ€ï¼‰
package my.policy.name

# å¯¼å…¥ï¼ˆå¯é€‰ï¼‰
import data.users
import data.roles as role_data
import future.keywords.if
import future.keywords.contains

# è§„åˆ™å®šä¹‰ï¼ˆæ ¸å¿ƒï¼‰
allow if {
    # è§„åˆ™ä½“
}

helper_rule := "value"
```

### 3.2 åŒ…å£°æ˜ï¼ˆPackageï¼‰

**è¯­æ³•**:

```text
package <path>
```

**è§„åˆ™**:

- å¿…é¡»æ˜¯æ¨¡å—çš„ç¬¬ä¸€æ¡è¯­å¥
- è·¯å¾„ç”¨ç‚¹å·åˆ†éš”
- å®šä¹‰ç­–ç•¥çš„å‘½åç©ºé—´

**ç¤ºä¾‹**:

```rego
package kubernetes.admission
package api.authz.v1
package example.rbac
```

### 3.3 å¯¼å…¥ï¼ˆImportï¼‰

**è¯­æ³•**:

```text
import <path> [as <alias>]
```

**ç¤ºä¾‹**:

```rego
# å¯¼å…¥æ•´ä¸ªè·¯å¾„
import data.users

# ä½¿ç”¨åˆ«å
import data.users as user_data
import input.request as req

# å¯¼å…¥æœªæ¥å…³é”®å­—ï¼ˆæ¨èï¼‰
import future.keywords.if
import future.keywords.in
import future.keywords.every
import future.keywords.contains
```

**å†…ç½®è·¯å¾„**:

- `data`: å¤–éƒ¨æ•°æ®
- `input`: æŸ¥è¯¢è¾“å…¥
- `future.keywords.*`: æœªæ¥è¯­æ³•ç‰¹æ€§

---

## 4. æ•°æ®ç±»å‹

### 4.1 æ ‡é‡ç±»å‹

#### 4.1.1 Booleanï¼ˆå¸ƒå°”ï¼‰

```rego
is_admin := true
is_public := false
```

#### 4.1.2 Numberï¼ˆæ•°å€¼ï¼‰

```rego
count := 42
ratio := 3.14
large := 1e6
```

**ç‰¹æ€§**:

- IEEE 754 åŒç²¾åº¦æµ®ç‚¹æ•°
- æ•´æ•°åœ¨èŒƒå›´å†…ç²¾ç¡®è¡¨ç¤º
- æ”¯æŒ `+Inf`, `-Inf`, `NaN`

#### 4.1.3 Stringï¼ˆå­—ç¬¦ä¸²ï¼‰

```rego
name := "Alice"
message := "Hello, World!"
empty := ""
```

**ç‰¹æ€§**:

- UTF-8 ç¼–ç 
- ä¸å¯å˜
- æ”¯æŒUnicode

#### 4.1.4 Nullï¼ˆç©ºå€¼ï¼‰

```rego
optional_field := null
```

### 4.2 å¤åˆç±»å‹

#### 4.2.1 Arrayï¼ˆæ•°ç»„ï¼‰

```rego
# æ•°ç»„å­—é¢é‡
numbers := [1, 2, 3, 4, 5]
mixed := [1, "two", true, null]
nested := [[1, 2], [3, 4]]
empty := []

# æ•°ç»„è®¿é—®
first := numbers[0]        # ç´¢å¼•ä»0å¼€å§‹
last := numbers[4]

# æ•°ç»„æ“ä½œ
length := count(numbers)   # 5
contains := 3 in numbers   # true (ä½¿ç”¨ future.keywords)
```

**ç‰¹æ€§**:

- æœ‰åºé›†åˆ
- é›¶ç´¢å¼•
- å¯åŒ…å«ä¸åŒç±»å‹å…ƒç´ 
- ä¸å¯å˜ï¼ˆæ¯æ¬¡æ“ä½œè¿”å›æ–°æ•°ç»„ï¼‰

#### 4.2.2 Objectï¼ˆå¯¹è±¡ï¼‰

```rego
# å¯¹è±¡å­—é¢é‡
user := {
    "name": "Alice",
    "age": 30,
    "roles": ["admin", "user"]
}

# åµŒå¥—å¯¹è±¡
config := {
    "database": {
        "host": "localhost",
        "port": 5432
    }
}

# å¯¹è±¡è®¿é—®
name := user.name           # "Alice"
name := user["name"]        # ç­‰ä»·
host := config.database.host  # "localhost"

# åŠ¨æ€é”®
key := "name"
value := user[key]          # "Alice"
```

**ç‰¹æ€§**:

- é”®å€¼å¯¹é›†åˆ
- é”®å¿…é¡»æ˜¯å­—ç¬¦ä¸²
- å€¼å¯ä»¥æ˜¯ä»»æ„ç±»å‹
- æ— åºï¼ˆä½†å®ç°é€šå¸¸ä¿æŒé¡ºåºï¼‰

#### 4.2.3 Setï¼ˆé›†åˆï¼‰

```rego
# é›†åˆå­—é¢é‡
roles := {"admin", "user", "viewer"}
empty_set := set()

# é›†åˆæ“ä½œ
is_member := "admin" in roles     # true
union := roles | {"guest"}        # å¹¶é›†
intersection := roles & {"admin", "guest"}  # äº¤é›†
difference := roles - {"viewer"}  # å·®é›†

# é›†åˆæ¨å¯¼
admin_users := {u | u := data.users[_]; u.role == "admin"}
```

**ç‰¹æ€§**:

- æ— åºã€æ— é‡å¤å…ƒç´ 
- æ”¯æŒé›†åˆè¿ç®—
- é«˜æ•ˆæˆå‘˜æ£€æŸ¥

---

## 5. è¿ç®—ç¬¦

### 5.1 ç»Ÿä¸€è¿ç®—ç¬¦ï¼ˆUnificationï¼‰

```rego
# = ï¼ˆç»Ÿä¸€ï¼‰
x = 5           # å°† x ç»‘å®šåˆ° 5
[x, 2] = [1, 2] # x ç»‘å®šåˆ° 1ï¼ˆæ¨¡å¼åŒ¹é…ï¼‰

# å¯¹è±¡ç»Ÿä¸€
{"a": x, "b": 2} = {"a": 1, "b": 2}  # x = 1
```

**è¯­ä¹‰**: åŒå‘æ¨¡å¼åŒ¹é…ï¼Œå¯ç»‘å®šå˜é‡ã€‚

### 5.2 èµ‹å€¼è¿ç®—ç¬¦ï¼ˆAssignmentï¼‰

```rego
# := ï¼ˆå±€éƒ¨èµ‹å€¼ï¼‰
x := 5          # å°†å³ä¾§å€¼èµ‹ç»™ x
y := x + 10     # y = 15
```

**è¯­ä¹‰**: å•å‘èµ‹å€¼ï¼Œå³ä¾§å¿…é¡»å¯æ±‚å€¼ã€‚

### 5.3 æ¯”è¾ƒè¿ç®—ç¬¦

```rego
# == ï¼ˆç›¸ç­‰ï¼‰
5 == 5          # true
"a" == "b"      # false

# != ï¼ˆä¸ç­‰ï¼‰
5 != 3          # true

# < ï¼ˆå°äºï¼‰
3 < 5           # true

# <= ï¼ˆå°äºç­‰äºï¼‰
5 <= 5          # true

# > ï¼ˆå¤§äºï¼‰
5 > 3           # true

# >= ï¼ˆå¤§äºç­‰äºï¼‰
5 >= 5          # true
```

### 5.4 é€»è¾‘è¿ç®—ç¬¦

```rego
# ; æˆ–æ¢è¡Œ ï¼ˆANDï¼‰
allow if {
    input.user == "admin"
    input.method == "GET"
}
# ç­‰ä»·äº
allow if { input.user == "admin"; input.method == "GET" }

# å¤šä¸ªè§„åˆ™å®šä¹‰ ï¼ˆORï¼‰
allow if { input.user == "admin" }
allow if { input.method == "GET"; input.path == "/public" }

# not ï¼ˆå¦å®šï¼‰
deny if {
    not allow
}
```

### 5.5 ç®—æœ¯è¿ç®—ç¬¦

```rego
sum := 10 + 5       # 15
diff := 10 - 5      # 5
product := 10 * 5   # 50
quotient := 10 / 5  # 2.0
remainder := 10 % 3 # 1

# è´Ÿæ•°
negative := -5
```

### 5.6 é›†åˆè¿ç®—ç¬¦

```rego
# | ï¼ˆå¹¶é›†ï¼‰
set1 := {1, 2, 3}
set2 := {3, 4, 5}
union := set1 | set2  # {1, 2, 3, 4, 5}

# & ï¼ˆäº¤é›†ï¼‰
intersection := set1 & set2  # {3}

# - ï¼ˆå·®é›†ï¼‰
difference := set1 - set2    # {1, 2}
```

### 5.7 æˆå‘˜è¿ç®—ç¬¦

```rego
import future.keywords.in

# in ï¼ˆæˆå‘˜æ£€æŸ¥ï¼‰
3 in [1, 2, 3]           # true
"key" in {"key": "value"}  # true
5 in {1, 2, 3}           # false
```

---

## 6. è§„åˆ™å®šä¹‰

### 6.1 å®Œå…¨è§„åˆ™ï¼ˆComplete Rulesï¼‰

**è¯­æ³•**:

```rego
<name> := <value> if {
    <body>
}
```

**ç‰¹æ€§**: è§„åˆ™æ±‚å€¼è¿”å›å•ä¸€å€¼ã€‚

**ç¤ºä¾‹**:

```rego
# ç®€å•è§„åˆ™
is_admin := true if {
    input.user.role == "admin"
}

# è®¡ç®—è§„åˆ™
max_score := 100

user_score := score if {
    score := input.score * 2
}

# é»˜è®¤è§„åˆ™
default allow := false
allow := true if {
    input.user == "admin"
}
```

### 6.2 éƒ¨åˆ†è§„åˆ™ï¼ˆPartial Rulesï¼‰

#### 6.2.1 ç”Ÿæˆå¯¹è±¡

**è¯­æ³•**:

```rego
<name>[<key>] := <value> if {
    <body>
}
```

**ç¤ºä¾‹**:

```rego
# ç”Ÿæˆç”¨æˆ·æ˜ å°„
user_map[user.id] := user if {
    user := data.users[_]
}

# ç»“æœ: {"user1": {...}, "user2": {...}}
```

#### 6.2.2 ç”Ÿæˆé›†åˆ

**è¯­æ³•**:

```rego
<name> contains <element> if {
    <body>
}
```

**ç¤ºä¾‹**:

```rego
import future.keywords.contains

# æ”¶é›†æ‰€æœ‰ç®¡ç†å‘˜
admins contains user.name if {
    user := data.users[_]
    user.role == "admin"
}

# ç»“æœ: {"alice", "bob"}
```

### 6.3 å¤šå€¼è§„åˆ™

```rego
# å¤šä¸ªè§„åˆ™å®šä¹‰ï¼ˆORè¯­ä¹‰ï¼‰
allow if {
    input.user.role == "admin"
}

allow if {
    input.method == "GET"
    input.path == "/public"
}

# ä»»ä¸€è§„åˆ™æ»¡è¶³ï¼Œallow = true
```

### 6.4 å‡½æ•°è§„åˆ™

```rego
# å¸¦å‚æ•°çš„è§„åˆ™
has_permission(user, resource, action) if {
    permission := data.permissions[_]
    permission.user == user
    permission.resource == resource
    permission.action == action
}

# è°ƒç”¨
allowed if {
    has_permission(input.user, input.resource, "read")
}
```

---

## 7. æ¨¡å—åŒ–

### 7.1 è§„åˆ™å¼•ç”¨

```rego
package example

# å®šä¹‰è§„åˆ™
is_admin if {
    input.user.role == "admin"
}

# å¼•ç”¨è§„åˆ™
allow if {
    is_admin  # è°ƒç”¨åŒä¸€åŒ…å†…çš„è§„åˆ™
}
```

### 7.2 è·¨åŒ…å¼•ç”¨

```rego
# æ–‡ä»¶1: authz/users.rego
package authz.users

admins := {"alice", "bob"}

# æ–‡ä»¶2: authz/policies.rego
package authz.policies

import data.authz.users

allow if {
    input.user in users.admins
}
```

### 7.3 åˆ†å±‚ç­–ç•¥

```text
ç­–ç•¥ç›®å½•ç»“æ„
â”œâ”€â”€ kubernetes/
â”‚   â”œâ”€â”€ admission/
â”‚   â”‚   â”œâ”€â”€ pods.rego
â”‚   â”‚   â””â”€â”€ services.rego
â”‚   â””â”€â”€ rbac/
â”‚       â””â”€â”€ roles.rego
â””â”€â”€ common/
    â””â”€â”€ utils.rego
```

**å¼•ç”¨**:

```rego
package kubernetes.admission.pods

import data.common.utils
import data.kubernetes.rbac.roles

deny[msg] if {
    not roles.can_create_pod(input.user)
    msg := utils.format_error("unauthorized")
}
```

---

## 8. ä¿ç•™å…³é”®å­—

### 8.1 å½“å‰å…³é”®å­—ï¼ˆv1.0ï¼‰

```text
package
import
as
default
else
with
null
true
false
not
some
```

### 8.2 æœªæ¥å…³é”®å­—ï¼ˆéœ€æ˜¾å¼å¯¼å…¥ï¼‰

```rego
import future.keywords.if       # æ¨èä½¿ç”¨
import future.keywords.in
import future.keywords.every
import future.keywords.contains
```

**ä½¿ç”¨ç¤ºä¾‹**:

```rego
import future.keywords.if
import future.keywords.in

# æ—§è¯­æ³•ï¼ˆä¸æ¨èï¼‰
allow {
    input.user == "admin"
}

# æ–°è¯­æ³•ï¼ˆæ¨èï¼‰
allow if {
    input.user in data.admins
}
```

### 8.3 ä¿ç•™ä½†æœªä½¿ç”¨

```text
while
for
break
continue
return
```

**æ³¨æ„**: è¿™äº›å…³é”®å­—ä¿ç•™ä¾›æœªæ¥ä½¿ç”¨ï¼Œä¸èƒ½ä½œä¸ºæ ‡è¯†ç¬¦ã€‚

---

## 9. æœ€ä½³å®è·µ

### 9.1 å‘½åçº¦å®š

```rego
# è§„åˆ™åï¼šè›‡å½¢å‘½å
allow_admin_access := true
user_permissions[id] := perms

# å¸¸é‡ï¼šå¤§å†™è›‡å½¢
MAX_RETRIES := 3
DEFAULT_TIMEOUT := 30

# è¾…åŠ©è§„åˆ™ï¼šåŠ¨è¯å¼€å¤´
is_admin if { ... }
has_permission(user, action) if { ... }
can_access_resource(resource) if { ... }
```

### 9.2 ä»£ç ç»„ç»‡

```rego
# 1. åŒ…å£°æ˜
package example.policy

# 2. å¯¼å…¥
import data.users
import future.keywords.if
import future.keywords.in

# 3. å¸¸é‡å®šä¹‰
DEFAULT_ROLE := "user"
ADMIN_ROLE := "admin"

# 4. ä¸»è¦è§„åˆ™
allow if {
    is_admin
}

# 5. è¾…åŠ©è§„åˆ™
is_admin if {
    input.user.role == ADMIN_ROLE
}
```

### 9.3 æ³¨é‡Šè§„èŒƒ

```rego
# METADATA
# title: ç®¡ç†å‘˜è®¿é—®ç­–ç•¥
# description: æ§åˆ¶ç®¡ç†å‘˜å¯¹èµ„æºçš„è®¿é—®æƒé™
# authors:
# - alice@example.com
# scope: package

package example.admin

# å…è®¸ç®¡ç†å‘˜è®¿é—®æ‰€æœ‰èµ„æº
#
# æ­¤è§„åˆ™æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ç®¡ç†å‘˜è§’è‰²ã€‚
# å¦‚æœæ˜¯ï¼Œåˆ™æˆäºˆå®Œå…¨è®¿é—®æƒé™ã€‚
#
# è¾“å…¥è¦æ±‚:
#   - input.user.role: ç”¨æˆ·è§’è‰²ï¼ˆå­—ç¬¦ä¸²ï¼‰
#
# è¿”å›: true å¦‚æœå…è®¸è®¿é—®ï¼Œå¦åˆ™ undefined
allow if {
    input.user.role == "admin"
}
```

### 9.4 æ€§èƒ½è€ƒè™‘

```rego
# âœ… å¥½ï¼šæå‰è¿‡æ»¤
allow if {
    input.method == "GET"  # å¿«é€Ÿæ£€æŸ¥
    expensive_check()      # ä»…åœ¨éœ€è¦æ—¶è°ƒç”¨
}

# âŒ å·®ï¼šæ˜‚è´µæ“ä½œåœ¨å‰
allow if {
    expensive_check()      # æ€»æ˜¯æ‰§è¡Œ
    input.method == "GET"
}

# âœ… å¥½ï¼šä½¿ç”¨ç´¢å¼•
user := data.users[input.user_id]  # O(1) æŸ¥æ‰¾

# âŒ å·®ï¼šçº¿æ€§æœç´¢
user := u if {
    u := data.users[_]
    u.id == input.user_id  # O(n) æŸ¥æ‰¾
}
```

### 9.5 æµ‹è¯•é©±åŠ¨

```rego
# policy.rego
package example

allow if {
    input.user.role == "admin"
}

# policy_test.rego
package example

test_admin_allowed if {
    allow with input as {"user": {"role": "admin"}}
}

test_user_denied if {
    not allow with input as {"user": {"role": "user"}}
}
```

---

## é™„å½• A: å®Œæ•´è¯­æ³•å›¾

### EBNFè¡¨ç¤º

```ebnf
Module     ::= Package Import* Rule*
Package    ::= 'package' Ref
Import     ::= 'import' Ref ('as' Var)?
Rule       ::= RuleHead ('if')? RuleBody
RuleHead   ::= Var (':=' Term)? | Var '[' Term ']' (':=' Term)?
RuleBody   ::= '{' Expr* '}'
Expr       ::= Term | Expr 'and' Expr | Expr 'or' Expr | 'not' Expr
Term       ::= Scalar | Composite | Ref | Var | Call
Scalar     ::= String | Number | Bool | Null
Composite  ::= Array | Object | Set
Array      ::= '[' (Term (',' Term)*)? ']'
Object     ::= '{' (Pair (',' Pair)*)? '}'
Set        ::= '{' (Term (',' Term)*)? '}'
Pair       ::= (String | Var) ':' Term
Ref        ::= (Var | '[' Term ']' | '.' Var)+
Call       ::= Var '(' (Term (',' Term)*)? ')'
```

---

## é™„å½• B: è¿ç®—ç¬¦ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | è¿ç®—ç¬¦ | ç»“åˆæ€§ |
|--------|--------|--------|
| 1ï¼ˆæœ€é«˜ï¼‰| `()` `[]` `.` | å·¦ |
| 2 | `-`ï¼ˆè´Ÿæ•°ï¼‰`not` | å³ |
| 3 | `*` `/` `%` | å·¦ |
| 4 | `+` `-` | å·¦ |
| 5 | `\|` `&` | å·¦ |
| 6 | `==` `!=` `<` `<=` `>` `>=` | å·¦ |
| 7 | `=` `:=` | å³ |
| 8 | `;`ï¼ˆANDï¼‰ | å·¦ |
| 9ï¼ˆæœ€ä½ï¼‰| å¤šè§„åˆ™ï¼ˆORï¼‰ | - |

---

## é™„å½• C: è¯­æ³•ç³–ä¸ç­‰ä»·å½¢å¼

| è¯­æ³•ç³– | ç­‰ä»·å½¢å¼ | è¯´æ˜ |
|--------|---------|------|
| `x := 1` | `x = 1` | åœ¨æŸäº›ä¸Šä¸‹æ–‡ä¸­ç­‰ä»· |
| `a; b` | `a` æ¢è¡Œ `b` | è¡¨è¾¾å¼è¿æ¥ |
| `[x \| p]` | æ•°ç»„æ¨å¯¼ | ç”Ÿæˆæ•°ç»„ |
| `{x \| p}` | é›†åˆæ¨å¯¼ | ç”Ÿæˆé›†åˆ |
| `{k: v \| p}` | å¯¹è±¡æ¨å¯¼ | ç”Ÿæˆå¯¹è±¡ |

---

## å‚è€ƒèµ„æº

1. **å®˜æ–¹æ–‡æ¡£**: <https://www.openpolicyagent.org/docs/latest/policy-language/>
2. **Rego Playground**: <https://play.openpolicyagent.org/>
3. **è¯­æ³•é«˜äº®**: <https://github.com/open-policy-agent/opa/tree/main/misc>
4. **LSPæœåŠ¡å™¨**: <https://github.com/open-policy-agent/opa/tree/main/ast>

---

**ä¸‹ä¸€ç¯‡**: [02.2-è¯­ä¹‰æ¨¡å‹](./02.2-è¯­ä¹‰æ¨¡å‹.md)  
**ç›¸å…³**: [06.2-Regoå½¢å¼åŒ–è¯­ä¹‰](../06-å½¢å¼åŒ–è¯æ˜/06.2-Regoå½¢å¼åŒ–è¯­ä¹‰.md)
