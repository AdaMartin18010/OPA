# Rego æ±‚å€¼æ¨¡å‹ï¼ˆEvaluation Modelï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.10+ (æ ¸å¿ƒæ±‚å€¼æ¨¡å‹) | æ¨è v0.68+  
> **Regoç‰ˆæœ¬**: v1.0  
> **æ±‚å€¼ç­–ç•¥**: Top-Down + Unification  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/policy-language/>

---

## ğŸ’¡ æ±‚å€¼æ¨¡å‹ç†è§£

> **æ ¸å¿ƒæ¦‚å¿µ**:
>
> - âœ… Regoé‡‡ç”¨å£°æ˜å¼è¯­æ³•ï¼Œæè¿°**ä»€ä¹ˆæ¡ä»¶**æˆç«‹ï¼Œè€Œéå¦‚ä½•æ‰§è¡Œ
> - âœ… æ±‚å€¼å¼•æ“ä½¿ç”¨**è‡ªé¡¶å‘ä¸‹**æœç´¢ + **ç»Ÿä¸€åŒ–**ï¼ˆUnificationï¼‰
> - âœ… æ”¯æŒ**éç¡®å®šæ€§**ï¼šå¤šä¸ªè§„åˆ™æ»¡è¶³æ—¶ï¼Œç”Ÿæˆæ‰€æœ‰ç»“æœ
> - âš ï¸ ç†è§£æ±‚å€¼é¡ºåºå¯¹æ€§èƒ½ä¼˜åŒ–è‡³å…³é‡è¦
>
> **å®è·µåº”ç”¨**:
>
> - é¿å…æ— ç•Œå¾ªç¯ï¼ˆä½¿ç”¨`walk`æ›¿ä»£é€’å½’ï¼‰
> - ç†è§£å˜é‡ç»‘å®šé¡ºåºå½±å“æ€§èƒ½
> - åˆ©ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢ï¼ˆè§[ç´¢å¼•ä¸ä¼˜åŒ–](../03-å®ç°æ¶æ„/03.5-ç´¢å¼•ä¸ä¼˜åŒ–.md)ï¼‰
>
> ç›¸å…³: [Top-Downæ±‚å€¼å™¨](../03-å®ç°æ¶æ„/03.4-Top-Downæ±‚å€¼å™¨.md) | [æ€§èƒ½ä¼˜åŒ–](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)

---

## ç›®å½•

- [Rego æ±‚å€¼æ¨¡å‹ï¼ˆEvaluation Modelï¼‰](#rego-æ±‚å€¼æ¨¡å‹evaluation-model)
  - [ğŸ’¡ æ±‚å€¼æ¨¡å‹ç†è§£](#-æ±‚å€¼æ¨¡å‹ç†è§£)
  - [ç›®å½•](#ç›®å½•)
  - [1. æ±‚å€¼æ¨¡å‹æ¦‚è¿°](#1-æ±‚å€¼æ¨¡å‹æ¦‚è¿°)
    - [1.1 æ±‚å€¼ç­–ç•¥](#11-æ±‚å€¼ç­–ç•¥)
    - [1.2 æ ¸å¿ƒæ¦‚å¿µ](#12-æ ¸å¿ƒæ¦‚å¿µ)
    - [1.3 æ±‚å€¼ç”Ÿå‘½å‘¨æœŸ](#13-æ±‚å€¼ç”Ÿå‘½å‘¨æœŸ)
  - [2. ç»Ÿä¸€ï¼ˆUnificationï¼‰](#2-ç»Ÿä¸€unification)
    - [2.1 ç»Ÿä¸€ç®—æ³•](#21-ç»Ÿä¸€ç®—æ³•)
    - [2.2 ç»Ÿä¸€ç¤ºä¾‹](#22-ç»Ÿä¸€ç¤ºä¾‹)
    - [2.3 ç»Ÿä¸€ä¸èµ‹å€¼çš„åŒºåˆ«](#23-ç»Ÿä¸€ä¸èµ‹å€¼çš„åŒºåˆ«)
  - [3. Top-Downæ±‚å€¼](#3-top-downæ±‚å€¼)
    - [3.1 æŸ¥è¯¢æ±‚å€¼è¿‡ç¨‹](#31-æŸ¥è¯¢æ±‚å€¼è¿‡ç¨‹)
    - [3.2 å›æº¯æœºåˆ¶](#32-å›æº¯æœºåˆ¶)
    - [3.3 è§„åˆ™åŒ¹é…](#33-è§„åˆ™åŒ¹é…)
  - [4. å˜é‡ç»‘å®š](#4-å˜é‡ç»‘å®š)
    - [4.1 å˜é‡ä½œç”¨åŸŸ](#41-å˜é‡ä½œç”¨åŸŸ)
    - [4.2 å˜é‡ç»‘å®šé¡ºåº](#42-å˜é‡ç»‘å®šé¡ºåº)
    - [4.3 æœªç»‘å®šå˜é‡](#43-æœªç»‘å®šå˜é‡)
  - [5. é›†åˆæ¨å¯¼æ±‚å€¼](#5-é›†åˆæ¨å¯¼æ±‚å€¼)
    - [5.1 æ•°ç»„æ¨å¯¼](#51-æ•°ç»„æ¨å¯¼)
    - [5.2 å¯¹è±¡æ¨å¯¼](#52-å¯¹è±¡æ¨å¯¼)
    - [5.3 é›†åˆæ¨å¯¼](#53-é›†åˆæ¨å¯¼)
  - [6. å¦å®šä¸å…¨ç§°é‡åŒ–](#6-å¦å®šä¸å…¨ç§°é‡åŒ–)
    - [6.1 å¦å®šæ±‚å€¼](#61-å¦å®šæ±‚å€¼)
    - [6.2 å…¨ç§°é‡åŒ–](#62-å…¨ç§°é‡åŒ–)
    - [6.3 å®‰å…¨æ€§çº¦æŸ](#63-å®‰å…¨æ€§çº¦æŸ)
  - [7. éƒ¨åˆ†æ±‚å€¼](#7-éƒ¨åˆ†æ±‚å€¼)
    - [7.1 éƒ¨åˆ†æ±‚å€¼åŸç†](#71-éƒ¨åˆ†æ±‚å€¼åŸç†)
    - [7.2 æœªçŸ¥å˜é‡](#72-æœªçŸ¥å˜é‡)
    - [7.3 ä¼˜åŒ–æ•ˆæœ](#73-ä¼˜åŒ–æ•ˆæœ)
  - [8. ç¼“å­˜æœºåˆ¶](#8-ç¼“å­˜æœºåˆ¶)
    - [8.1 è§„åˆ™ç¼“å­˜](#81-è§„åˆ™ç¼“å­˜)
    - [8.2 å†…ç½®å‡½æ•°ç¼“å­˜](#82-å†…ç½®å‡½æ•°ç¼“å­˜)
    - [8.3 ç¼“å­˜å¤±æ•ˆ](#83-ç¼“å­˜å¤±æ•ˆ)
  - [9. çŸ­è·¯æ±‚å€¼](#9-çŸ­è·¯æ±‚å€¼)
    - [9.1 é€»è¾‘çŸ­è·¯](#91-é€»è¾‘çŸ­è·¯)
    - [9.2 æå‰é€€å‡º](#92-æå‰é€€å‡º)
    - [9.3 ä¼˜åŒ–ç­–ç•¥](#93-ä¼˜åŒ–ç­–ç•¥)
  - [10. æ€§èƒ½ä¼˜åŒ–](#10-æ€§èƒ½ä¼˜åŒ–)
    - [10.1 æ±‚å€¼é¡ºåºä¼˜åŒ–](#101-æ±‚å€¼é¡ºåºä¼˜åŒ–)
    - [10.2 ç´¢å¼•åˆ©ç”¨](#102-ç´¢å¼•åˆ©ç”¨)
    - [10.3 å¤æ‚åº¦åˆ†æ](#103-å¤æ‚åº¦åˆ†æ)
  - [é™„å½•Aï¼šæ±‚å€¼å½¢å¼åŒ–è¯­ä¹‰](#é™„å½•aæ±‚å€¼å½¢å¼åŒ–è¯­ä¹‰)
  - [é™„å½•Bï¼šæ±‚å€¼è°ƒè¯•æŠ€å·§](#é™„å½•bæ±‚å€¼è°ƒè¯•æŠ€å·§)

---

## 1. æ±‚å€¼æ¨¡å‹æ¦‚è¿°

### 1.1 æ±‚å€¼ç­–ç•¥

**Regoæ±‚å€¼ç‰¹å¾**ï¼š

```text
å£°æ˜å¼æ±‚å€¼ï¼ˆDeclarative Evaluationï¼‰
â”œâ”€â”€ éè¿‡ç¨‹å¼: æè¿°"æ˜¯ä»€ä¹ˆ"è€Œé"æ€ä¹ˆåš"
â”œâ”€â”€ æ— å‰¯ä½œç”¨: æ±‚å€¼è¿‡ç¨‹ä¸æ”¹å˜çŠ¶æ€
â”œâ”€â”€ å¹‚ç­‰æ€§: å¤šæ¬¡æ±‚å€¼ç»“æœç›¸åŒ
â””â”€â”€ é¡ºåºæ— å…³: è§„åˆ™é¡ºåºä¸å½±å“ç»“æœ

Top-Downæ±‚å€¼ï¼ˆGoal-Drivenï¼‰
â”œâ”€â”€ ä»æŸ¥è¯¢ç›®æ ‡å¼€å§‹
â”œâ”€â”€ é€’å½’åˆ†è§£å­ç›®æ ‡
â”œâ”€â”€ æ·±åº¦ä¼˜å…ˆæœç´¢
â””â”€â”€ å›æº¯æ¢ç´¢æ‰€æœ‰å¯èƒ½

ç»Ÿä¸€é©±åŠ¨ï¼ˆUnification-Basedï¼‰
â”œâ”€â”€ æ¨¡å¼åŒ¹é…
â”œâ”€â”€ å˜é‡ç»‘å®š
â”œâ”€â”€ çº¦æŸä¼ æ’­
â””â”€â”€ å¤±è´¥å›æº¯
```

**æ±‚å€¼æ¨¡å¼å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | Rego (Top-Down) | SQL (Set-Based) | å‘½ä»¤å¼è¯­è¨€ |
|------|----------------|----------------|-----------|
| **æ‰§è¡Œæ–¹å¼** | ç›®æ ‡é©±åŠ¨ | é›†åˆè¿ç®— | æŒ‡ä»¤é¡ºåº |
| **å›æº¯** | âœ… è‡ªåŠ¨ | âŒ æ—  | âš ï¸ æ‰‹åŠ¨ |
| **å˜é‡ç»‘å®š** | ç»Ÿä¸€ | è”æ¥ | èµ‹å€¼ |
| **å‰¯ä½œç”¨** | âŒ æ—  | âŒ æ— ï¼ˆçº¯æŸ¥è¯¢ï¼‰ | âœ… æœ‰ |
| **é¡ºåºæ•æ„Ÿ** | âŒ å¦ | âŒ å¦ | âœ… æ˜¯ |

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

**æœ¯è¯­å®šä¹‰**ï¼š

```text
æœ¯è¯­ï¼ˆTermï¼‰
â”œâ”€â”€ å€¼: 123, "hello", true, null
â”œâ”€â”€ å˜é‡: x, user, input
â”œâ”€â”€ å¼•ç”¨: input.user, data.roles[x]
â”œâ”€â”€ æ•°ç»„: [1, 2, x]
â”œâ”€â”€ å¯¹è±¡: {"key": value, "x": y}
â””â”€â”€ é›†åˆ: {1, 2, x}

æŸ¥è¯¢ï¼ˆQueryï¼‰
â”œâ”€â”€ ç­‰å¼: x = 10
â”œâ”€â”€ ç»Ÿä¸€: [x, y] = [1, 2]
â”œâ”€â”€ æ¯”è¾ƒ: x > y
â”œâ”€â”€ å‡½æ•°è°ƒç”¨: count(arr, n)
â”œâ”€â”€ è§„åˆ™å¼•ç”¨: allow
â””â”€â”€ å¤åˆ: x = 1; y = 2

ç»‘å®šï¼ˆBindingï¼‰
â””â”€â”€ å˜é‡ â†’ å€¼çš„æ˜ å°„
    ä¾‹: {x: 10, y: "hello"}
```

### 1.3 æ±‚å€¼ç”Ÿå‘½å‘¨æœŸ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è§£ææŸ¥è¯¢                          â”‚
â”‚     Query: data.authz.allow         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æŸ¥æ‰¾è§„åˆ™å®šä¹‰                      â”‚
â”‚     package authz                    â”‚
â”‚     allow if { ... }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ±‚å€¼è§„åˆ™ä½“ï¼ˆBodyï¼‰                â”‚
â”‚     - ç»Ÿä¸€å˜é‡                       â”‚
â”‚     - æ±‚å€¼è¡¨è¾¾å¼                     â”‚
â”‚     - å›æº¯æ¢ç´¢                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ”¶é›†ç»“æœ                         â”‚
â”‚     - èšåˆæ‰€æœ‰æˆåŠŸçš„ç»‘å®š              â”‚
â”‚     - åº”ç”¨è§„åˆ™å¤´ï¼ˆHeadï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. è¿”å›ç»“æœé›†                       â”‚
â”‚     {true} / {false} / {value, ...} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç»Ÿä¸€ï¼ˆUnificationï¼‰

### 2.1 ç»Ÿä¸€ç®—æ³•

**Robinsonç»Ÿä¸€ç®—æ³•**ï¼š

```text
unify(t1, t2, Î¸) â†’ Î¸'

è§„åˆ™:
1. unify(x, x, Î¸) = Î¸
   (ç›¸åŒé¡¹ç»Ÿä¸€ä¸ºè‡ªèº«)

2. unify(x, t, Î¸) = Î¸ âˆª {x: t}  if x âˆ‰ vars(t)
   (å˜é‡ä¸éå˜é‡ç»Ÿä¸€ï¼Œç»‘å®šå˜é‡)

3. unify(f(t1,...,tn), f(s1,...,sn), Î¸) = 
      unify(t1,s1,unify(t2,s2,...unify(tn,sn,Î¸)...))
   (å¤åˆé¡¹é€’å½’ç»Ÿä¸€)

4. unify(t1, t2, Î¸) = fail
   (ä¸å…¼å®¹é¡¹ç»Ÿä¸€å¤±è´¥)
```

**ç»Ÿä¸€ç¤ºä¾‹**ï¼š

```rego
package unification_examples

import rego.v1

# ç¤ºä¾‹1: å˜é‡ä¸å¸¸é‡ç»Ÿä¸€
test_simple_unify if {
    x = 10        # xç»Ÿä¸€ä¸º10
    x == 10       # æˆåŠŸ
}

# ç¤ºä¾‹2: å˜é‡ä¸å˜é‡ç»Ÿä¸€
test_var_unify if {
    x = y         # xå’Œyç»Ÿä¸€ï¼ˆå…±äº«åŒä¸€å˜é‡ï¼‰
    y = 42
    x == 42       # æˆåŠŸï¼Œxä¹Ÿæ˜¯42
}

# ç¤ºä¾‹3: æ•°ç»„ç»Ÿä¸€
test_array_unify if {
    [x, y, 3] = [1, 2, 3]
    x == 1
    y == 2
}

# ç¤ºä¾‹4: å¯¹è±¡ç»Ÿä¸€
test_object_unify if {
    {"name": n, "age": a} = {"name": "alice", "age": 30}
    n == "alice"
    a == 30
}

# ç¤ºä¾‹5: éƒ¨åˆ†ç»Ÿä¸€
test_partial_unify if {
    # åªéœ€åŒ¹é…éƒ¨åˆ†å­—æ®µ
    {"name": name} = {"name": "bob", "role": "admin"}
    name == "bob"
}
```

### 2.2 ç»Ÿä¸€ç¤ºä¾‹

**å¤æ‚ç»Ÿä¸€åœºæ™¯**ï¼š

```rego
package complex_unification

import rego.v1

# åµŒå¥—ç»“æ„ç»Ÿä¸€
users := {
    "alice": {"role": "admin", "dept": "eng"},
    "bob": {"role": "user", "dept": "sales"}
}

# æå–åµŒå¥—å€¼
admin_dept := dept if {
    # ç»Ÿä¸€åµŒå¥—å¯¹è±¡
    {"role": "admin", "dept": dept} = users[_]
}
# ç»“æœ: admin_dept = "eng"

# å¤šå˜é‡ååŒç»Ÿä¸€
pairs := [[x, y] | 
    some x in [1, 2, 3]
    some y in [4, 5, 6]
    x + y == 7
]
# ç»“æœ: [[1, 6], [2, 5], [3, 4]]
```

### 2.3 ç»Ÿä¸€ä¸èµ‹å€¼çš„åŒºåˆ«

**å¯¹æ¯”**ï¼š

```rego
package unification_vs_assignment

import rego.v1

# ç»Ÿä¸€ (=) - åŒå‘çº¦æŸ
test_unification if {
    x = 10        # xç»‘å®šä¸º10
    10 = x        # ä¹ŸæˆåŠŸï¼ˆäº¤æ¢å¾‹ï¼‰
    [a, b] = [1, 2]  # æ¨¡å¼åŒ¹é…
}

# èµ‹å€¼ (:=) - å•å‘ç»‘å®š
test_assignment if {
    x := 10       # xèµ‹å€¼ä¸º10
    # 10 := x    # âŒ é”™è¯¯! èµ‹å€¼å·¦ä¾§å¿…é¡»æ˜¯å˜é‡
    
    # èµ‹å€¼å¯ä»¥è¦†ç›–ï¼ˆå±€éƒ¨ä½œç”¨åŸŸï¼‰
    y := 1
    y := 2        # yåœ¨æ–°ä½œç”¨åŸŸä¸­ä¸º2
}

# æ¯”è¾ƒ (==) - å€¼ç›¸ç­‰æ£€æŸ¥
test_comparison if {
    x = 10
    x == 10       # æ¯”è¾ƒå€¼
    x == 5        # å¤±è´¥
}
```

**ä½¿ç”¨æŒ‡å—**ï¼š

| æ“ä½œç¬¦ | ç”¨é€” | ç‰¹æ€§ |
|-------|------|-----|
| `=` | ç»Ÿä¸€ | æ¨¡å¼åŒ¹é…ã€åŒå‘ã€å¯é‡å¤ç»‘å®š |
| `:=` | èµ‹å€¼ | è®¡ç®—è¡¨è¾¾å¼ã€å•å‘ã€ä½œç”¨åŸŸå†…å”¯ä¸€ |
| `==` | æ¯”è¾ƒ | å€¼ç›¸ç­‰æµ‹è¯•ã€ä¸ç»‘å®šå˜é‡ |

---

## 3. Top-Downæ±‚å€¼

### 3.1 æŸ¥è¯¢æ±‚å€¼è¿‡ç¨‹

**æ±‚å€¼æ ‘ç¤ºä¾‹**ï¼š

```rego
package authz

import rego.v1

allow if {
    user_is_admin
    action_is_permitted
}

user_is_admin if {
    input.user.role == "admin"
}

action_is_permitted if {
    input.action in ["read", "write"]
}
```

**æ±‚å€¼æ ‘**ï¼š

```text
ç›®æ ‡: allow
â”œâ”€ å­ç›®æ ‡1: user_is_admin
â”‚  â””â”€ input.user.role == "admin"
â”‚     â”œâ”€ ç»‘å®š: input.user.role â†’ "admin"
â”‚     â””â”€ æˆåŠŸ âœ“
â”‚
â””â”€ å­ç›®æ ‡2: action_is_permitted
   â””â”€ input.action in ["read", "write"]
      â”œâ”€ ç»‘å®š: input.action â†’ "read"
      â””â”€ æˆåŠŸ âœ“

æœ€ç»ˆç»“æœ: allow = true
```

### 3.2 å›æº¯æœºåˆ¶

**å›æº¯ç¤ºä¾‹**ï¼š

```rego
package backtracking

import rego.v1

# æŸ¥æ‰¾æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„é…å¯¹
valid_pairs := [[x, y] |
    some x in [1, 2, 3]
    some y in [10, 20, 30]
    x + y > 25
]
```

**å›æº¯è¿‡ç¨‹**ï¼š

```text
å°è¯• x=1:
  å°è¯• y=10: 1+10=11 < 25 âŒ å›æº¯
  å°è¯• y=20: 1+20=21 < 25 âŒ å›æº¯
  å°è¯• y=30: 1+30=31 > 25 âœ“ â†’ [1, 30]

å°è¯• x=2:
  å°è¯• y=10: 2+10=12 < 25 âŒ å›æº¯
  å°è¯• y=20: 2+20=22 < 25 âŒ å›æº¯
  å°è¯• y=30: 2+30=32 > 25 âœ“ â†’ [2, 30]

å°è¯• x=3:
  å°è¯• y=10: 3+10=13 < 25 âŒ å›æº¯
  å°è¯• y=20: 3+20=23 < 25 âŒ å›æº¯
  å°è¯• y=30: 3+30=33 > 25 âœ“ â†’ [3, 30]

ç»“æœ: [[1, 30], [2, 30], [3, 30]]
```

### 3.3 è§„åˆ™åŒ¹é…

**å¤šè§„åˆ™åŒ¹é…**ï¼š

```rego
package multi_rule

import rego.v1

# è§„åˆ™1: ç®¡ç†å‘˜æ€»æ˜¯å…è®¸
allow if {
    input.user.role == "admin"
}

# è§„åˆ™2: èµ„æºæ‰€æœ‰è€…å…è®¸
allow if {
    input.user.id == data.resources[input.resource].owner
}

# è§„åˆ™3: å›¢é˜Ÿæˆå‘˜åªè¯»å…è®¸
allow if {
    input.user.team == data.resources[input.resource].team
    input.action == "read"
}
```

**æ±‚å€¼é€»è¾‘**ï¼š

```text
æŸ¥è¯¢: allow

å°è¯•è§„åˆ™1:
  input.user.role == "admin"
  â†’ å¤±è´¥ (role = "user")

å°è¯•è§„åˆ™2:
  input.user.id == data.resources[input.resource].owner
  â†’ å¤±è´¥ (ä¸æ˜¯æ‰€æœ‰è€…)

å°è¯•è§„åˆ™3:
  input.user.team == data.resources[input.resource].team
  â†’ æˆåŠŸ (teamåŒ¹é…)
  input.action == "read"
  â†’ æˆåŠŸ

æœ€ç»ˆ: allow = true (è§„åˆ™3æˆåŠŸ)
```

---

## 4. å˜é‡ç»‘å®š

### 4.1 å˜é‡ä½œç”¨åŸŸ

**ä½œç”¨åŸŸè§„åˆ™**ï¼š

```rego
package scoping

import rego.v1

# å…¨å±€å˜é‡ï¼ˆè§„åˆ™çº§åˆ«ï¼‰
global_var := 100

rule1 if {
    # å±€éƒ¨å˜é‡
    local_x := 10
    local_y := 20
    local_x + local_y == 30
}

rule2 if {
    # local_x åœ¨è¿™é‡Œä¸å¯è§
    # global_var å¯è§
    global_var == 100
}

# æ¨å¯¼ä¸­çš„ä½œç”¨åŸŸ
array := [x |
    some x in [1, 2, 3]
    # xåªåœ¨è¿™ä¸ªæ¨å¯¼å†…å¯è§
]

# someçš„ä½œç”¨åŸŸ
test_some if {
    some x in [1, 2, 3]
    # xåœ¨æ•´ä¸ªè§„åˆ™ä½“å†…å¯è§
    y := x * 2
}
```

### 4.2 å˜é‡ç»‘å®šé¡ºåº

**ä¾èµ–é¡ºåº**ï¼š

```rego
package binding_order

import rego.v1

# âœ… æ­£ç¡®: å…ˆç»‘å®šåä½¿ç”¨
valid if {
    x := 10           # 1. ç»‘å®šx
    y := x * 2        # 2. ä½¿ç”¨xï¼Œç»‘å®šy
    y > 15            # 3. ä½¿ç”¨y
}

# âŒ é”™è¯¯: æœªç»‘å®šå˜é‡
invalid if {
    y := x * 2        # xæœªç»‘å®š!
    x := 10
}

# âœ… ç»Ÿä¸€å¯ä»¥ä»»æ„é¡ºåº
flexible if {
    x + y == 30       # xå’Œyçš„çº¦æŸ
    x == 10           # xç»‘å®š
    # yè‡ªåŠ¨æ¨å¯¼ä¸º20
}
```

### 4.3 æœªç»‘å®šå˜é‡

**å®‰å…¨æ€§è§„åˆ™**ï¼š

```rego
package safety

import rego.v1

# âŒ ä¸å®‰å…¨: å¦å®šä¸­çš„æœªç»‘å®šå˜é‡
unsafe1 if {
    not input.user == x  # xæœªç»‘å®š
}

# âœ… å®‰å…¨: å…ˆç»‘å®šå†å¦å®š
safe1 if {
    x := "admin"
    not input.user == x
}

# âŒ ä¸å®‰å…¨: æ¨å¯¼ä¸­æœªç»‘å®šå˜é‡
unsafe2 := [x | x > 10]  # xæ¥æºæœªçŸ¥

# âœ… å®‰å…¨: æ˜ç¡®å˜é‡æ¥æº
safe2 := [x | 
    some x in [1, 2, 3, 10, 20]
    x > 10
]
```

---

## 5. é›†åˆæ¨å¯¼æ±‚å€¼

### 5.1 æ•°ç»„æ¨å¯¼

**æ±‚å€¼è¿‡ç¨‹**ï¼š

```rego
package array_comprehension

import rego.v1

# ç®€å•æ•°ç»„æ¨å¯¼
squares := [x * x | some x in [1, 2, 3, 4, 5]]
# æ±‚å€¼:
# 1. x=1: 1*1=1  â†’ [1]
# 2. x=2: 2*2=4  â†’ [1, 4]
# 3. x=3: 3*3=9  â†’ [1, 4, 9]
# 4. x=4: 4*4=16 â†’ [1, 4, 9, 16]
# 5. x=5: 5*5=25 â†’ [1, 4, 9, 16, 25]

# å¸¦è¿‡æ»¤çš„æ¨å¯¼
evens := [x | 
    some x in [1, 2, 3, 4, 5, 6]
    x % 2 == 0
]
# æ±‚å€¼:
# x=1: 1%2=1 â‰  0 âŒ è·³è¿‡
# x=2: 2%2=0 âœ“ â†’ [2]
# x=3: 3%2=1 âŒ è·³è¿‡
# x=4: 4%2=0 âœ“ â†’ [2, 4]
# x=5: 5%2=1 âŒ è·³è¿‡
# x=6: 6%2=0 âœ“ â†’ [2, 4, 6]
```

### 5.2 å¯¹è±¡æ¨å¯¼

**é”®å€¼å¯¹ç”Ÿæˆ**ï¼š

```rego
package object_comprehension

import rego.v1

users := [
    {"id": "u1", "name": "alice", "role": "admin"},
    {"id": "u2", "name": "bob", "role": "user"},
    {"id": "u3", "name": "charlie", "role": "user"}
]

# å¯¹è±¡æ¨å¯¼: id â†’ name
user_names := {user.id: user.name | 
    some user in users
}
# ç»“æœ: {"u1": "alice", "u2": "bob", "u3": "charlie"}

# å¸¦è¿‡æ»¤
admin_names := {user.id: user.name |
    some user in users
    user.role == "admin"
}
# ç»“æœ: {"u1": "alice"}
```

### 5.3 é›†åˆæ¨å¯¼

**å»é‡ç‰¹æ€§**ï¼š

```rego
package set_comprehension

import rego.v1

data_points := [
    {"category": "A", "value": 10},
    {"category": "B", "value": 20},
    {"category": "A", "value": 15}
]

# é›†åˆæ¨å¯¼ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
categories := {point.category | some point in data_points}
# ç»“æœ: {"A", "B"}  (Aåªå‡ºç°ä¸€æ¬¡)

# å¯¹æ¯”æ•°ç»„æ¨å¯¼ï¼ˆä¸å»é‡ï¼‰
categories_array := [point.category | some point in data_points]
# ç»“æœ: ["A", "B", "A"]  (Aå‡ºç°ä¸¤æ¬¡)
```

---

## 6. å¦å®šä¸å…¨ç§°é‡åŒ–

### 6.1 å¦å®šæ±‚å€¼

**å¦å®šå³å¤±è´¥ï¼ˆNegation as Failureï¼‰**ï¼š

```rego
package negation

import rego.v1

# åŸºæœ¬å¦å®š
deny if {
    not allow  # allowå¤±è´¥æ—¶denyæˆåŠŸ
}

# å¦å®šçº¦æŸ
not_admin if {
    not input.user.role == "admin"
}

# å¤æ‚å¦å®š
no_conflicts if {
    not has_conflict
}

has_conflict if {
    some r1 in data.roles
    some r2 in data.roles
    r1 != r2
    r1.permissions & r2.permissions != set()
}
```

**æ±‚å€¼è¿‡ç¨‹**ï¼š

```text
æ±‚å€¼ not P:
1. å°è¯•æ±‚å€¼ P
2. å¦‚æœ P æˆåŠŸ â†’ not P å¤±è´¥
3. å¦‚æœ P å¤±è´¥ â†’ not P æˆåŠŸ

æ³¨æ„: 
- notä¸ç»‘å®šå˜é‡
- notä¸­çš„å˜é‡å¿…é¡»å·²ç»‘å®š
```

### 6.2 å…¨ç§°é‡åŒ–

**everyå…³é”®å­—ï¼ˆRego v1.0ï¼‰**ï¼š

```rego
package quantification

import rego.v1

pods := [
    {"name": "pod1", "image": "alpine:3.14"},
    {"name": "pod2", "image": "nginx:1.21"},
    {"name": "pod3", "image": "redis:6.2"}
]

# å…¨ç§°é‡åŒ–: æ‰€æœ‰Podå¿…é¡»æ¥è‡ªå…è®¸çš„æ³¨å†Œè¡¨
all_images_allowed if {
    every pod in pods {
        startswith(pod.image, "docker.io/") or
        startswith(pod.image, "gcr.io/")
    }
}

# ç­‰ä»·çš„ä¼ ç»Ÿå†™æ³•
all_images_allowed_traditional if {
    not any_image_disallowed
}

any_image_disallowed if {
    some pod in pods
    not startswith(pod.image, "docker.io/")
    not startswith(pod.image, "gcr.io/")
}
```

### 6.3 å®‰å…¨æ€§çº¦æŸ

**ä¸å®‰å…¨ç¤ºä¾‹ä¸ä¿®å¤**ï¼š

```rego
package safety_constraints

import rego.v1

# âŒ ä¸å®‰å…¨: å¦å®šä¸­å¼•å…¥æ–°å˜é‡
unsafe_negation if {
    not input.user == x  # xæœªç»‘å®š
}

# âœ… å®‰å…¨: å…ˆç»‘å®šå˜é‡
safe_negation if {
    some x in data.allowed_users
    not input.user == x
}

# âŒ ä¸å®‰å…¨: å…¨ç§°é‡åŒ–ä¸­çš„æœªç»‘å®šå˜é‡
unsafe_quantification := [x |
    every y in data.items {
        x > y  # xæ¥è‡ªå“ªé‡Œ?
    }
]

# âœ… å®‰å…¨: æ˜ç¡®å˜é‡æ¥æº
safe_quantification := [x |
    some x in data.candidates
    every y in data.items {
        x > y
    }
]
```

---

## 7. éƒ¨åˆ†æ±‚å€¼

### 7.1 éƒ¨åˆ†æ±‚å€¼åŸç†

**åŸºæœ¬æ¦‚å¿µ**ï¼š

```text
éƒ¨åˆ†æ±‚å€¼ = ç¼–è¯‘æ—¶ä¼˜åŒ– + è¿è¡Œæ—¶åŠ é€Ÿ

åŸç†:
1. å°†æŸ¥è¯¢åˆ†ä¸ºå·²çŸ¥éƒ¨åˆ†å’ŒæœªçŸ¥éƒ¨åˆ†
2. ç¼–è¯‘æ—¶æ±‚å€¼å·²çŸ¥éƒ¨åˆ†ï¼ˆdataã€å¸¸é‡ï¼‰
3. ç”Ÿæˆç®€åŒ–çš„ç­–ç•¥ï¼ˆåªåŒ…å«æœªçŸ¥éƒ¨åˆ†ï¼‰
4. è¿è¡Œæ—¶åªå¤„ç†æœªçŸ¥å˜é‡ï¼ˆinputï¼‰

æ•ˆæœ:
- å‡å°ç­–ç•¥å¤§å°
- é™ä½è¿è¡Œæ—¶å¤æ‚åº¦
- æå‡æ±‚å€¼é€Ÿåº¦
```

**ç¤ºä¾‹**ï¼š

```rego
package partial_eval

import rego.v1

# åŸå§‹ç­–ç•¥
allow if {
    user := data.users[input.user_id]
    user.role in data.roles.privileged
    input.action in user.permissions
}

# éƒ¨åˆ†æ±‚å€¼åï¼ˆå‡è®¾dataå·²çŸ¥ï¼ŒinputæœªçŸ¥ï¼‰
# allow if {
#     input.user_id == "u123"  # ç”¨æˆ·alice
#     input.action in ["read", "write", "admin"]  # aliceçš„æƒé™
# }
```

### 7.2 æœªçŸ¥å˜é‡

**æŒ‡å®šæœªçŸ¥å˜é‡**ï¼š

```bash
# ç¼–è¯‘æ—¶æŒ‡å®šinputä¸ºæœªçŸ¥
opa compile \
    --partial \
    --unknowns input \
    --output partial-bundle.tar.gz \
    policy/

# å¤šä¸ªæœªçŸ¥å˜é‡
opa compile \
    --partial \
    --unknowns input.user \
    --unknowns input.action \
    policy/
```

### 7.3 ä¼˜åŒ–æ•ˆæœ

**æ€§èƒ½å¯¹æ¯”**ï¼š

```text
åœºæ™¯: RBACç­–ç•¥ï¼Œ1000ä¸ªç”¨æˆ·ï¼Œ10000æ¡è§„åˆ™

å®Œæ•´æ±‚å€¼:
  - ç­–ç•¥å¤§å°: 10MB
  - åŠ è½½æ—¶é—´: 500ms
  - æ±‚å€¼æ—¶é—´: 5ms

éƒ¨åˆ†æ±‚å€¼:
  - ç­–ç•¥å¤§å°: 50KB (99%å‡å°‘)
  - åŠ è½½æ—¶é—´: 10ms (98%å‡å°‘)
  - æ±‚å€¼æ—¶é—´: 0.1ms (98%å‡å°‘)

é€‚ç”¨åœºæ™¯:
âœ… æ•°æ®å˜åŒ–æ…¢ï¼ŒæŸ¥è¯¢å˜åŒ–å¿«
âœ… ç­–ç•¥å¤æ‚ï¼Œæ•°æ®é‡å¤§
âœ… è¾¹ç¼˜éƒ¨ç½²ï¼ˆWASMï¼‰
```

---

## 8. ç¼“å­˜æœºåˆ¶

### 8.1 è§„åˆ™ç¼“å­˜

**è‡ªåŠ¨ç¼“å­˜**ï¼š

```rego
package caching

import rego.v1

# çº¯å‡½æ•°è§„åˆ™ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰
expensive_computation(x) := result if {
    # å¤æ‚è®¡ç®—
    result := x * x * x + x * x + x + 1
}

allow if {
    # ç¬¬ä¸€æ¬¡è°ƒç”¨: è®¡ç®—å¹¶ç¼“å­˜
    v1 := expensive_computation(10)
    
    # ç¬¬äºŒæ¬¡è°ƒç”¨: ç›´æ¥ä»ç¼“å­˜è¿”å›
    v2 := expensive_computation(10)
    
    v1 == v2
}
```

### 8.2 å†…ç½®å‡½æ•°ç¼“å­˜

**ç¼“å­˜é…ç½®**ï¼š

```yaml
# config.yaml
caching:
  inter_query_builtin_cache:
    max_size_bytes: 10485760  # 10MB
```

**å—ç›Šçš„å†…ç½®å‡½æ•°**ï¼š

```rego
package builtin_caching

import rego.v1

# http.sendç»“æœç¼“å­˜ï¼ˆåŒä¸€è¯·æ±‚ï¼‰
external_data := http.send({
    "method": "GET",
    "url": "https://api.example.com/data"
}).body

# JWTè§£ç ç¼“å­˜
token_payload := io.jwt.decode(input.token)[1]

# æ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜
matches if {
    regex.match(`^[a-z0-9-]+$`, input.name)
}
```

### 8.3 ç¼“å­˜å¤±æ•ˆ

**ç¼“å­˜ç­–ç•¥**ï¼š

```text
ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ:
â”œâ”€â”€ æŸ¥è¯¢é—´ç¼“å­˜ï¼ˆInter-Query Cacheï¼‰
â”‚   â””â”€â”€ å¤šä¸ªæŸ¥è¯¢å…±äº«
â”‚   â””â”€â”€ OPAè¿›ç¨‹é‡å¯æ—¶æ¸…ç©º
â”‚
â””â”€â”€ æŸ¥è¯¢å†…ç¼“å­˜ï¼ˆIntra-Query Cacheï¼‰
    â””â”€â”€ å•ä¸ªæŸ¥è¯¢å†…æœ‰æ•ˆ
    â””â”€â”€ æŸ¥è¯¢ç»“æŸæ—¶æ¸…ç©º

ç¼“å­˜é”®:
- å†…ç½®å‡½æ•°: å‡½æ•°å + å‚æ•°å“ˆå¸Œ
- è§„åˆ™: è§„åˆ™è·¯å¾„ + ç»‘å®šå“ˆå¸Œ
- HTTP: URL + æ–¹æ³• + è¯·æ±‚ä½“å“ˆå¸Œ
```

---

## 9. çŸ­è·¯æ±‚å€¼

### 9.1 é€»è¾‘çŸ­è·¯

**ANDçŸ­è·¯**ï¼š

```rego
package short_circuit

import rego.v1

# ANDçŸ­è·¯: ç¬¬ä¸€ä¸ªå¤±è´¥åç«‹å³åœæ­¢
allow if {
    cheap_check       # å¿«é€Ÿæ£€æŸ¥
    expensive_check   # æ˜‚è´µæ£€æŸ¥ï¼ˆcheap_checkå¤±è´¥æ—¶ä¸æ‰§è¡Œï¼‰
}

cheap_check if {
    input.user != null
}

expensive_check if {
    # æ˜‚è´µçš„æ•°æ®åº“æŸ¥è¯¢æˆ–APIè°ƒç”¨
    user := data.users[input.user]
    user.verified == true
}
```

### 9.2 æå‰é€€å‡º

**defaultè§„åˆ™ä¼˜åŒ–**ï¼š

```rego
package early_exit

import rego.v1

# âŒ ä¸ä¼˜åŒ–: æ€»æ˜¯è¯„ä¼°æ‰€æœ‰è§„åˆ™
default allow := false

allow if {
    condition1
    condition2
    condition3
}

# âœ… ä¼˜åŒ–: ä½¿ç”¨elseæå‰é€€å‡º
allow := true if {
    condition1
} else := false

# âœ… æ›´ä¼˜: ç›´æ¥è¿”å›false
default allow := false

allow if {
    condition1
}
```

### 9.3 ä¼˜åŒ–ç­–ç•¥

**æ±‚å€¼é¡ºåºä¼˜åŒ–**ï¼š

```rego
package optimization

import rego.v1

# âœ… å¥½: å»‰ä»·æ£€æŸ¥åœ¨å‰
allow if {
    input.method == "GET"           # O(1)
    input.path == "/api/public"     # O(1)
    check_rate_limit                # O(log n)
    verify_signature                # æ˜‚è´µ
}

# âŒ å·®: æ˜‚è´µæ“ä½œåœ¨å‰
allow_slow if {
    verify_signature                # æ€»æ˜¯æ‰§è¡Œ
    input.method == "GET"           # å¯èƒ½æå‰è¿‡æ»¤
}
```

---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 æ±‚å€¼é¡ºåºä¼˜åŒ–

**ç­–ç•¥**ï¼š

```rego
package eval_order

import rego.v1

# åŸåˆ™1: è¿‡æ»¤æ€§å¼ºçš„æ¡ä»¶åœ¨å‰
users_in_department := {user |
    some user in data.users  # 10000ä¸ªç”¨æˆ·
    user.dept == "engineering"  # è¿‡æ»¤åˆ°100ä¸ª
    user.active == true  # è¿‡æ»¤åˆ°50ä¸ª
}

# æ›´å¥½çš„é¡ºåºï¼ˆå¦‚æœactiveç”¨æˆ·å°‘ï¼‰
users_in_department_optimized := {user |
    some user in data.users
    user.active == true  # å…ˆè¿‡æ»¤åˆ°1000ä¸ª
    user.dept == "engineering"  # å†è¿‡æ»¤åˆ°50ä¸ª
}

# åŸåˆ™2: å¸¸é‡æ¯”è¾ƒåœ¨å‰
allow if {
    input.action == "read"  # å¸¸é‡æ¯”è¾ƒï¼Œæå¿«
    user := data.users[input.user_id]  # æ•°æ®è®¿é—®
    check_permissions(user, input.resource)  # å‡½æ•°è°ƒç”¨
}
```

### 10.2 ç´¢å¼•åˆ©ç”¨

**åˆ©ç”¨ç´¢å¼•**ï¼š

```rego
package indexing

import rego.v1

# âŒ çº¿æ€§æœç´¢ O(n)
user_by_email_slow(email) := user if {
    some user in data.users
    user.email == email
}

# âœ… ç´¢å¼•è®¿é—® O(1)
# æ•°æ®ç»“æ„: {"users_by_email": {"alice@example.com": {...}}}
user_by_email_fast(email) := data.users_by_email[email]

# OPAè‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–
# å½“patternæ˜¯: data.x[_].y == constant
# OPAè‡ªåŠ¨æ„å»º y â†’ x çš„ç´¢å¼•
```

### 10.3 å¤æ‚åº¦åˆ†æ

**å¸¸è§æ“ä½œå¤æ‚åº¦**ï¼š

| æ“ä½œ | å¤æ‚åº¦ | ç¤ºä¾‹ |
|------|-------|------|
| å¸¸é‡æ¯”è¾ƒ | O(1) | `x == 10` |
| ç´¢å¼•è®¿é—® | O(1) | `data.users[id]` |
| æ•°ç»„éå† | O(n) | `some x in array` |
| åµŒå¥—å¾ªç¯ | O(nÂ²) | `some x in A; some y in B` |
| é›†åˆäº¤é›† | O(min(n,m)) | `set_a & set_b` |
| å­—ç¬¦ä¸²åŒ¹é… | O(n*m) | `contains(str, pattern)` |
| æ­£åˆ™è¡¨è¾¾å¼ | O(n) | `regex.match(pattern, str)` |

**ä¼˜åŒ–æŠ€å·§**ï¼š

```rego
# âŒ O(nÂ²): ç¬›å¡å°”ç§¯
conflicts := {[u1, u2] |
    some u1 in data.users
    some u2 in data.users
    u1.team == u2.team
}

# âœ… O(n): åˆ†ç»„åå¤„ç†
teams := {team: members |
    some user in data.users
    team := user.team
    members := {u | some u in data.users; u.team == team}
}
```

---

## é™„å½•Aï¼šæ±‚å€¼å½¢å¼åŒ–è¯­ä¹‰

**å¤§æ­¥è¯­ä¹‰ï¼ˆBig-Step Semanticsï¼‰**ï¼š

```text
æ±‚å€¼åˆ¤æ–­: Î“ âŠ¢ e â‡“ v
(åœ¨ç¯å¢ƒÎ“ä¸‹ï¼Œè¡¨è¾¾å¼eæ±‚å€¼ä¸ºå€¼v)

è§„åˆ™:

[Var]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Î“ âŠ¢ x â‡“ Î“(x)

[Const]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Î“ âŠ¢ c â‡“ c

[Unify]
Î“ âŠ¢ t1 â‡“ v1    Î“ âŠ¢ t2 â‡“ v2    unify(v1, v2) = Î¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Î“ âŠ¢ t1 = t2 â‡“ Î¸

[And]
Î“ âŠ¢ e1 â‡“ Î¸1    Î“ âˆª Î¸1 âŠ¢ e2 â‡“ Î¸2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Î“ âŠ¢ e1; e2 â‡“ Î¸1 âˆª Î¸2

[Rule]
Î“ âŠ¢ body â‡“ Î¸    Î“ âˆª Î¸ âŠ¢ head â‡“ v
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Î“ âŠ¢ (head :- body) â‡“ {v}

[Not]
Î“ âŠ¢ e â‡“ fail
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Î“ âŠ¢ not e â‡“ {}
```

---

## é™„å½•Bï¼šæ±‚å€¼è°ƒè¯•æŠ€å·§

**traceå‡½æ•°**ï¼š

```rego
package debugging

import rego.v1

allow if {
    trace(sprintf("æ£€æŸ¥ç”¨æˆ·: %v", [input.user]))
    user := data.users[input.user]
    
    trace(sprintf("ç”¨æˆ·è§’è‰²: %v", [user.role]))
    user.role == "admin"
    
    trace("æˆæƒæˆåŠŸ")
}
```

**printå‡½æ•°ï¼ˆå¼€å‘æ¨¡å¼ï¼‰**ï¼š

```bash
# å¯ç”¨printè¾“å‡º
opa eval -d policy.rego 'data.authz.allow' \
    -i input.json \
    --format pretty \
    --explain=full
```

**explainæ¨¡å¼**ï¼š

```bash
# è¯¦ç»†æ±‚å€¼è¿‡ç¨‹
opa eval -d policy.rego 'data.authz.allow' \
    --explain=notes \
    -i input.json

# è¾“å‡º:
# query:1     Enter data.authz.allow
# policy.rego:5 | Enter data.authz.allow
# policy.rego:6 | | Eval input.user.role
# policy.rego:6 | | Index data.users (matched 1 rule)
# policy.rego:7 | | Eval input.action in ["read", "write"]
# policy.rego:5 | | Exit data.authz.allow
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [Regoè¯­æ³•è§„èŒƒ](./02.1-Regoè¯­æ³•è§„èŒƒ.md)
- [ç±»å‹ç³»ç»Ÿ](./02.2-ç±»å‹ç³»ç»Ÿ.md)
- [Top-Downæ±‚å€¼å™¨](../03-å®ç°æ¶æ„/03.4-Top-Downæ±‚å€¼å™¨.md)

**å‚è€ƒèµ„æº**ï¼š

- Policy Language: <https://www.openpolicyagent.org/docs/latest/policy-language/>
- Policy Reference: <https://www.openpolicyagent.org/docs/latest/policy-reference/>
- Rego Playground: <https://play.openpolicyagent.org/>
