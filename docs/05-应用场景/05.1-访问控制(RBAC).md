# è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰åº”ç”¨åœºæ™¯

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.55+ | Rego v1.0  
> **æ¨èç‰ˆæœ¬**: OPA v0.68+  
> **æœ€åéªŒè¯**: 2025-10-21  
> **éš¾åº¦**: â­â­â­ ä¸­çº§  
> **å¸¸è§åº¦**: â­â­â­â­â­ æœ€å¸¸ç”¨

---

## âš ï¸ RBACå®æ–½å»ºè®®

> **è®¾è®¡å’Œå®ç°æ³¨æ„**:
>
> - âœ… **é»˜è®¤æ‹’ç»**: å§‹ç»ˆä½¿ç”¨`default allow := false`
> - âœ… **æœ€å°æƒé™**: éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼ŒæŒ‰éœ€æˆæƒ
> - âœ… **å®Œæ•´æµ‹è¯•**: æµ‹è¯•è¦†ç›–æ‰€æœ‰è§’è‰²å’Œæƒé™ç»„åˆ
> - âœ… **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰è®¿é—®å†³ç­–ï¼Œä¾¿äºå®¡è®¡
> - âœ… **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ç´¢å¼•æ•°æ®ç»“æ„ï¼Œé¿å…éå†ï¼ˆè§[æ€§èƒ½ä¼˜åŒ–](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)ï¼‰
> - âš ï¸ å±‚çº§è§’è‰²å¯èƒ½å¯¼è‡´æ„å¤–æƒé™ï¼Œéœ€è¦å……åˆ†æµ‹è¯•
> - âš ï¸ ABACæ¡ä»¶å¤æ‚æ—¶æ³¨æ„æ€§èƒ½å½±å“
>
> **ç”Ÿäº§ç¯å¢ƒ**:
>
> - æƒé™å˜æ›´éœ€è¦ä¸¥æ ¼çš„å®¡æ‰¹æµç¨‹
> - å®šæœŸå®¡æŸ¥è§’è‰²å’Œæƒé™é…ç½®
> - ç›‘æ§å¼‚å¸¸è®¿é—®æ¨¡å¼
>
> å‚è€ƒ: [ç”Ÿäº§æ¡ˆä¾‹-ç”µå•†APIæˆæƒ](../../PRODUCTION_CASES.md#æ¡ˆä¾‹1ç”µå•†å¹³å°apiæˆæƒ) | [è®¾è®¡æ¨¡å¼](../08-æœ€ä½³å®è·µ/08.1-ç­–ç•¥è®¾è®¡æ¨¡å¼.md)  

---

## ğŸ“ English Summary

This document demonstrates how to implement Role-Based Access Control (RBAC) using OPA.

**Key Topics**:

- **RBAC Models**: Basic roles, hierarchical roles, resource-level permissions
- **ABAC Extension**: Attribute-based access control, contextual conditions
- **Implementation**: Policy design, role data modeling, permission inheritance
- **Best Practices**: Default deny, least privilege, comprehensive testing
- **Performance**: Indexing strategies, caching, query optimization

**Target Audience**: Application developers, security engineers, system architects implementing authorization.

**Difficulty**: â­â­â­ Intermediate | **Popularity**: â­â­â­â­â­ Most Common Use Case

---

## ç›®å½•

- [è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰åº”ç”¨åœºæ™¯](#è®¿é—®æ§åˆ¶rbacåº”ç”¨åœºæ™¯)
  - [âš ï¸ RBACå®æ–½å»ºè®®](#ï¸-rbacå®æ–½å»ºè®®)
  - [ğŸ“ English Summary](#-english-summary)
  - [ç›®å½•](#ç›®å½•)
  - [1. RBACæ¦‚è¿°](#1-rbacæ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯RBAC](#11-ä»€ä¹ˆæ˜¯rbac)
    - [1.2 ä¸ºä»€ä¹ˆä½¿ç”¨OPAå®ç°RBAC](#12-ä¸ºä»€ä¹ˆä½¿ç”¨opaå®ç°rbac)
    - [1.3 RBACæ¨¡å‹å±‚æ¬¡](#13-rbacæ¨¡å‹å±‚æ¬¡)
  - [2. åŸºæœ¬RBACå®ç°](#2-åŸºæœ¬rbacå®ç°)
    - [2.1 æ•°æ®æ¨¡å‹è®¾è®¡](#21-æ•°æ®æ¨¡å‹è®¾è®¡)
      - [2.1.1 ç”¨æˆ·æ•°æ®](#211-ç”¨æˆ·æ•°æ®)
      - [2.1.2 è§’è‰²æ•°æ®](#212-è§’è‰²æ•°æ®)
      - [2.1.3 èµ„æºæ•°æ®](#213-èµ„æºæ•°æ®)
    - [2.2 ç­–ç•¥å®ç°](#22-ç­–ç•¥å®ç°)
      - [2.2.1 åŸºç¡€æˆæƒè§„åˆ™](#221-åŸºç¡€æˆæƒè§„åˆ™)
      - [2.2.2 ä½¿ç”¨ç¤ºä¾‹](#222-ä½¿ç”¨ç¤ºä¾‹)
    - [2.3 è¾…åŠ©è§„åˆ™](#23-è¾…åŠ©è§„åˆ™)
      - [2.3.1 ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢](#231-ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢)
      - [2.3.2 è§’è‰²æŸ¥è¯¢](#232-è§’è‰²æŸ¥è¯¢)
  - [3. é«˜çº§RBACæ¨¡å¼](#3-é«˜çº§rbacæ¨¡å¼)
    - [3.1 å±‚çº§è§’è‰²ï¼ˆRole Hierarchyï¼‰](#31-å±‚çº§è§’è‰²role-hierarchy)
    - [3.2 å±æ€§åŸºç¡€è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰](#32-å±æ€§åŸºç¡€è®¿é—®æ§åˆ¶abac)
    - [3.3 åŠ¨æ€æƒé™](#33-åŠ¨æ€æƒé™)
    - [3.4 å§”æ‰˜æˆæƒï¼ˆDelegationï¼‰](#34-å§”æ‰˜æˆæƒdelegation)
  - [4. å®æˆ˜æ¡ˆä¾‹](#4-å®æˆ˜æ¡ˆä¾‹)
    - [4.1 APIæˆæƒ](#41-apiæˆæƒ)
      - [4.1.1 ç­–ç•¥](#411-ç­–ç•¥)
      - [4.1.2 æ•°æ®](#412-æ•°æ®)
    - [4.2 æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ](#42-æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ)
      - [4.2.1 æ•°æ®æ¨¡å‹](#421-æ•°æ®æ¨¡å‹)
      - [4.2.2 ç­–ç•¥](#422-ç­–ç•¥)
    - [4.3 å¤šç§Ÿæˆ·SaaS](#43-å¤šç§Ÿæˆ·saas)
      - [4.3.1 æ•°æ®æ¨¡å‹](#431-æ•°æ®æ¨¡å‹)
      - [4.3.2 ç­–ç•¥](#432-ç­–ç•¥)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 ç´¢å¼•ç­–ç•¥](#51-ç´¢å¼•ç­–ç•¥)
    - [5.2 ç¼“å­˜çƒ­æ•°æ®](#52-ç¼“å­˜çƒ­æ•°æ®)
    - [5.3 éƒ¨åˆ†æ±‚å€¼](#53-éƒ¨åˆ†æ±‚å€¼)
  - [6. æµ‹è¯•ä¸éªŒè¯](#6-æµ‹è¯•ä¸éªŒè¯)
    - [6.1 å•å…ƒæµ‹è¯•](#61-å•å…ƒæµ‹è¯•)
    - [6.2 é›†æˆæµ‹è¯•](#62-é›†æˆæµ‹è¯•)
    - [6.3 æ€§èƒ½åŸºå‡†](#63-æ€§èƒ½åŸºå‡†)
  - [é™„å½•: å¸¸è§æ¨¡å¼é€ŸæŸ¥](#é™„å½•-å¸¸è§æ¨¡å¼é€ŸæŸ¥)

---

## 1. RBACæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯RBAC

**å®šä¹‰**: Role-Based Access Controlï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**:

```text
User (ç”¨æˆ·) â†’ Role (è§’è‰²) â†’ Permission (æƒé™) â†’ Resource (èµ„æº)
```

**å…³ç³»**:

- User âŠ† Role: ç”¨æˆ·è¢«åˆ†é…è§’è‰²
- Role âŠ† Permission: è§’è‰²æ‹¥æœ‰æƒé™
- Permission â†’ (Resource, Action): æƒé™å®šä¹‰å¯¹èµ„æºçš„æ“ä½œ

---

### 1.2 ä¸ºä»€ä¹ˆä½¿ç”¨OPAå®ç°RBAC

**å¯¹æ¯”ä¼ ç»ŸRBAC**:

| ç»´åº¦ | ä¼ ç»ŸRBAC | OPA RBAC |
|------|---------|----------|
| **è¡¨è¾¾èƒ½åŠ›** | ç®€å•è§’è‰² | å¤æ‚æ¡ä»¶ |
| **ä¸Šä¸‹æ–‡** | é™æ€ | åŠ¨æ€ï¼ˆæ—¶é—´ã€IPç­‰ï¼‰ |
| **æ•°æ®è®¿é—®** | æœ‰é™ | å®Œå…¨è®¿é—®data |
| **ç»„åˆ** | å›°éš¾ | æ˜“ç»„åˆ |
| **æµ‹è¯•** | æ‰‹åŠ¨ | è‡ªåŠ¨åŒ–æµ‹è¯• |

**OPAä¼˜åŠ¿**:

```rego
# ä¼ ç»ŸRBAC: user.role == "admin"
# OPA RBAC: å¯ä»¥è¡¨è¾¾å¤æ‚é€»è¾‘
allow if {
    user.role == "admin"
    user.department == resource.department
    time.now_ns() < user.access_expires
    not is_blacklisted(user.ip)
}
```

---

### 1.3 RBACæ¨¡å‹å±‚æ¬¡

```text
Level 0: Flat RBAC (æ‰å¹³RBAC)
  â””â”€ User â†’ Role â†’ Permission

Level 1: Hierarchical RBAC (å±‚çº§RBAC)
  â””â”€ Roleç»§æ‰¿: Admin âŠƒ Manager âŠƒ User

Level 2: Constrained RBAC (çº¦æŸRBAC)
  â””â”€ è§’è‰²äº’æ–¥ã€æ•°é‡é™åˆ¶

Level 3: Symmetric RBAC (å¯¹ç§°RBAC)
  â””â”€ æƒé™-è§’è‰²åŒå‘æŸ¥è¯¢

Level 4: Context-Aware RBAC (ä¸Šä¸‹æ–‡æ„ŸçŸ¥)
  â””â”€ æ—¶é—´ã€ä½ç½®ã€è®¾å¤‡ç­‰ä¸Šä¸‹æ–‡
```

---

## 2. åŸºæœ¬RBACå®ç°

### 2.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 2.1.1 ç”¨æˆ·æ•°æ®

```json
{
    "users": {
        "alice": {
            "id": "alice",
            "name": "Alice Smith",
            "email": "alice@example.com",
            "roles": ["admin", "developer"],
            "department": "engineering",
            "manager": "bob"
        },
        "bob": {
            "id": "bob",
            "roles": ["manager"],
            "department": "engineering"
        },
        "charlie": {
            "id": "charlie",
            "roles": ["viewer"],
            "department": "sales"
        }
    }
}
```

#### 2.1.2 è§’è‰²æ•°æ®

```json
{
    "roles": {
        "admin": {
            "permissions": [
                {"action": "read", "resource": "*"},
                {"action": "write", "resource": "*"},
                {"action": "delete", "resource": "*"}
            ]
        },
        "developer": {
            "permissions": [
                {"action": "read", "resource": "code"},
                {"action": "write", "resource": "code"},
                {"action": "deploy", "resource": "staging"}
            ]
        },
        "viewer": {
            "permissions": [
                {"action": "read", "resource": "*"}
            ]
        }
    }
}
```

#### 2.1.3 èµ„æºæ•°æ®

```json
{
    "resources": {
        "/api/users": {
            "type": "api",
            "owner": "engineering",
            "sensitivity": "high"
        },
        "/api/public": {
            "type": "api",
            "owner": "public",
            "sensitivity": "low"
        }
    }
}
```

---

### 2.2 ç­–ç•¥å®ç°

#### 2.2.1 åŸºç¡€æˆæƒè§„åˆ™

```rego
package rbac.authz

import future.keywords.if
import future.keywords.in

# ä¸»è¦å†³ç­–è§„åˆ™
allow if {
    # è·å–ç”¨æˆ·è§’è‰²
    some role in user_roles
    # æ£€æŸ¥è§’è‰²æƒé™
    has_permission(role, input.action, input.resource)
}

# è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
user_roles contains role if {
    some role in data.users[input.user].roles
}

# æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰æƒé™
has_permission(role, action, resource) if {
    # éå†è§’è‰²çš„æƒé™åˆ—è¡¨
    some permission in data.roles[role].permissions
    # åŒ¹é…æ“ä½œ
    permission.action == action
    # åŒ¹é…èµ„æºï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
    matches_resource(permission.resource, resource)
}

# èµ„æºåŒ¹é…ï¼ˆæ”¯æŒ * é€šé…ç¬¦ï¼‰
matches_resource(pattern, resource) if {
    pattern == "*"
}

matches_resource(pattern, resource) if {
    pattern == resource
}

matches_resource(pattern, resource) if {
    # å‰ç¼€åŒ¹é…: /api/* åŒ¹é… /api/users
    endswith(pattern, "/*")
    prefix := trim_suffix(pattern, "/*")
    startswith(resource, prefix)
}
```

#### 2.2.2 ä½¿ç”¨ç¤ºä¾‹

**æŸ¥è¯¢**:

```json
{
    "input": {
        "user": "alice",
        "action": "read",
        "resource": "/api/users"
    }
}
```

**ç»“æœ**:

```json
{
    "result": true
}
```

---

### 2.3 è¾…åŠ©è§„åˆ™

#### 2.3.1 ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢

```rego
# è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
user_info[info] if {
    user := data.users[input.user]
    info := {
        "id": user.id,
        "name": user.name,
        "roles": user.roles,
        "department": user.department
    }
}

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
user_exists if {
    data.users[input.user]
}
```

#### 2.3.2 è§’è‰²æŸ¥è¯¢

```rego
# è·å–è§’è‰²çš„æ‰€æœ‰æƒé™
role_permissions[role] := permissions if {
    some role in input.roles
    permissions := data.roles[role].permissions
}

# è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼ˆæ‰å¹³åŒ–ï¼‰
user_permissions contains permission if {
    some role in user_roles
    some permission in data.roles[role].permissions
}
```

---

## 3. é«˜çº§RBACæ¨¡å¼

### 3.1 å±‚çº§è§’è‰²ï¼ˆRole Hierarchyï¼‰

**æ•°æ®æ¨¡å‹**:

```json
{
    "role_hierarchy": {
        "admin": {
            "inherits": ["manager"]
        },
        "manager": {
            "inherits": ["developer"]
        },
        "developer": {
            "inherits": ["viewer"]
        },
        "viewer": {
            "inherits": []
        }
    }
}
```

**ç­–ç•¥**:

```rego
# é€’å½’è·å–è§’è‰²åŠå…¶ç»§æ‰¿çš„è§’è‰²
all_roles contains role if {
    some role in data.users[input.user].roles
}

all_roles contains inherited_role if {
    some role in all_roles
    some inherited_role in data.role_hierarchy[role].inherits
}

# ä½¿ç”¨æ‰€æœ‰è§’è‰²æ£€æŸ¥æƒé™
allow if {
    some role in all_roles
    has_permission(role, input.action, input.resource)
}
```

---

### 3.2 å±æ€§åŸºç¡€è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰

**ç»“åˆRBACå’ŒABAC**:

```rego
# RBAC: åŸºäºè§’è‰²
allow if {
    some role in user_roles
    has_permission(role, input.action, input.resource)
}

# ABAC: åŸºäºå±æ€§
allow if {
    # å±æ€§1: éƒ¨é—¨åŒ¹é…
    user := data.users[input.user]
    resource := data.resources[input.resource]
    user.department == resource.owner
    
    # å±æ€§2: æ—¶é—´é™åˆ¶
    within_business_hours
    
    # å±æ€§3: IPç™½åå•
    input.source_ip in data.allowed_ips
}

within_business_hours if {
    now := time.now_ns()
    hour := time.clock([now, "UTC"])[0]
    hour >= 9
    hour <= 17
}
```

---

### 3.3 åŠ¨æ€æƒé™

**åœºæ™¯**: èµ„æºæ‰€æœ‰è€…è‡ªåŠ¨è·å¾—æƒé™ã€‚

```rego
# èµ„æºæ‰€æœ‰è€…è§„åˆ™
allow if {
    input.action == "read"
    resource := data.resources[input.resource]
    resource.owner == input.user
}

# èµ„æºåˆ›å»ºè€…è§„åˆ™
allow if {
    input.action in ["read", "write", "delete"]
    resource := data.resources[input.resource]
    resource.created_by == input.user
}
```

---

### 3.4 å§”æ‰˜æˆæƒï¼ˆDelegationï¼‰

**æ•°æ®æ¨¡å‹**:

```json
{
    "delegations": [
        {
            "from": "alice",
            "to": "bob",
            "permissions": [
                {"action": "approve", "resource": "/api/orders"}
            ],
            "expires": "2025-12-31T23:59:59Z"
        }
    ]
}
```

**ç­–ç•¥**:

```rego
# æ£€æŸ¥å§”æ‰˜æƒé™
allow if {
    some delegation in data.delegations
    delegation.from == data.resources[input.resource].owner
    delegation.to == input.user
    not is_expired(delegation.expires)
    has_delegated_permission(delegation, input.action, input.resource)
}

is_expired(expires_str) if {
    expires := time.parse_rfc3339_ns(expires_str)
    time.now_ns() > expires
}

has_delegated_permission(delegation, action, resource) if {
    some perm in delegation.permissions
    perm.action == action
    perm.resource == resource
}
```

---

## 4. å®æˆ˜æ¡ˆä¾‹

### 4.1 APIæˆæƒ

**åœºæ™¯**: å¾®æœåŠ¡APIæˆæƒã€‚

#### 4.1.1 ç­–ç•¥

```rego
package api.authz

import future.keywords.if
import future.keywords.in

# ä¸»å†³ç­–
allow if {
    is_public_endpoint
}

allow if {
    is_authenticated
    has_api_permission
}

# å…¬å¼€ç«¯ç‚¹
public_endpoints := {
    "/health",
    "/metrics",
    "/api/public/*"
}

is_public_endpoint if {
    some endpoint in public_endpoints
    matches_path(endpoint, input.path)
}

# è®¤è¯æ£€æŸ¥
is_authenticated if {
    input.user != ""
    input.token != ""
    verify_token(input.token, input.user)
}

# APIæƒé™æ£€æŸ¥
has_api_permission if {
    some role in user_roles
    some api_permission in data.api_permissions[role]
    api_permission.method == input.method
    matches_path(api_permission.path, input.path)
}

# è·¯å¾„åŒ¹é…
matches_path(pattern, path) if {
    pattern == path
}

matches_path(pattern, path) if {
    endswith(pattern, "/*")
    prefix := trim_suffix(pattern, "/*")
    startswith(path, prefix)
}

# TokenéªŒè¯ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
verify_token(token, user) if {
    # å®é™…åº”è¯¥è°ƒç”¨JWTéªŒè¯
    token != ""
}
```

#### 4.1.2 æ•°æ®

```json
{
    "api_permissions": {
        "admin": [
            {"method": "*", "path": "/api/*"}
        ],
        "developer": [
            {"method": "GET", "path": "/api/services/*"},
            {"method": "POST", "path": "/api/deployments/*"}
        ],
        "viewer": [
            {"method": "GET", "path": "/api/*"}
        ]
    }
}
```

---

### 4.2 æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ

**åœºæ™¯**: ä¼ä¸šæ–‡æ¡£æƒé™æ§åˆ¶ã€‚

#### 4.2.1 æ•°æ®æ¨¡å‹

```json
{
    "documents": {
        "doc-001": {
            "title": "Q4 Financial Report",
            "owner": "alice",
            "department": "finance",
            "classification": "confidential",
            "shared_with": ["bob", "charlie"],
            "created_at": "2025-01-01T00:00:00Z"
        }
    }
}
```

#### 4.2.2 ç­–ç•¥

```rego
package documents.authz

import future.keywords.if
import future.keywords.in

# è¯»æƒé™
allow_read if {
    # åœºæ™¯1: æ–‡æ¡£æ‰€æœ‰è€…
    is_owner
}

allow_read if {
    # åœºæ™¯2: æ˜ç¡®å…±äº«
    is_shared_with_user
}

allow_read if {
    # åœºæ™¯3: åŒéƒ¨é—¨ + æƒé™
    same_department
    "read" in user_permissions
}

allow_read if {
    # åœºæ™¯4: Adminè§’è‰²
    "admin" in user_roles
}

# å†™æƒé™
allow_write if {
    is_owner
    not is_locked
}

allow_write if {
    "editor" in user_roles
    same_department
}

# åˆ é™¤æƒé™
allow_delete if {
    is_owner
    "admin" in user_roles
}

# è¾…åŠ©è§„åˆ™
document := data.documents[input.document_id]

is_owner if {
    document.owner == input.user
}

is_shared_with_user if {
    input.user in document.shared_with
}

same_department if {
    user := data.users[input.user]
    user.department == document.department
}

is_locked if {
    document.locked == true
}
```

---

### 4.3 å¤šç§Ÿæˆ·SaaS

**åœºæ™¯**: SaaSå¹³å°ç§Ÿæˆ·éš”ç¦»ã€‚

#### 4.3.1 æ•°æ®æ¨¡å‹

```json
{
    "tenants": {
        "tenant-a": {
            "id": "tenant-a",
            "name": "Company A",
            "users": ["alice", "bob"],
            "plan": "enterprise"
        }
    },
    "users": {
        "alice": {
            "id": "alice",
            "tenant": "tenant-a",
            "roles": ["org-admin"]
        }
    },
    "resources": {
        "project-123": {
            "id": "project-123",
            "tenant": "tenant-a",
            "owner": "alice"
        }
    }
}
```

#### 4.3.2 ç­–ç•¥

```rego
package saas.authz

import future.keywords.if

# ç§Ÿæˆ·éš”ç¦»
allow if {
    # 1. æ£€æŸ¥èµ„æºæ‰€å±ç§Ÿæˆ·
    resource := data.resources[input.resource_id]
    resource_tenant := resource.tenant
    
    # 2. æ£€æŸ¥ç”¨æˆ·æ‰€å±ç§Ÿæˆ·
    user := data.users[input.user]
    user_tenant := user.tenant
    
    # 3. ç§Ÿæˆ·å¿…é¡»åŒ¹é…
    resource_tenant == user_tenant
    
    # 4. æ£€æŸ¥ç§Ÿæˆ·å†…æƒé™
    has_tenant_permission
}

has_tenant_permission if {
    user := data.users[input.user]
    some role in user.roles
    some permission in data.tenant_permissions[role]
    permission.action == input.action
}

# è¶…çº§ç®¡ç†å‘˜è·¨ç§Ÿæˆ·è®¿é—®
allow if {
    user := data.users[input.user]
    user.global_admin == true
}
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 ç´¢å¼•ç­–ç•¥

```rego
# âœ… å¥½ï¼šä½¿ç”¨ç›´æ¥ç´¢å¼•
user := data.users[input.user_id]

# âŒ å·®ï¼šéå†æ‰€æœ‰ç”¨æˆ·
user := u if {
    u := data.users[_]
    u.id == input.user_id
}
```

### 5.2 ç¼“å­˜çƒ­æ•°æ®

```go
// åº”ç”¨å±‚ç¼“å­˜ç”¨æˆ·è§’è‰²
type RoleCache struct {
    cache map[string][]string
    mu    sync.RWMutex
}

func (rc *RoleCache) GetRoles(userID string) ([]string, bool) {
    rc.mu.RLock()
    defer rc.mu.RUnlock()
    roles, ok := rc.cache[userID]
    return roles, ok
}
```

### 5.3 éƒ¨åˆ†æ±‚å€¼

**é¢„è®¡ç®—å›ºå®šæ•°æ®**:

```bash
# ç¼–è¯‘æ—¶éƒ¨åˆ†æ±‚å€¼
opa build -t wasm -e 'data.rbac.authz.allow' \
    --bundle policy/ \
    --optimize 1
```

**æ•ˆæœ**: å°†è§’è‰²æƒé™æå‰å±•å¼€ï¼Œè¿è¡Œæ—¶åªéœ€æ£€æŸ¥inputã€‚

---

## 6. æµ‹è¯•ä¸éªŒè¯

### 6.1 å•å…ƒæµ‹è¯•

```rego
package rbac.authz_test

import future.keywords.if

test_admin_full_access if {
    allow with input as {
        "user": "alice",
        "action": "delete",
        "resource": "/api/users"
    } with data.users as {
        "alice": {"roles": ["admin"]}
    } with data.roles as {
        "admin": {
            "permissions": [{"action": "*", "resource": "*"}]
        }
    }
}

test_viewer_read_only if {
    allow with input as {
        "user": "charlie",
        "action": "read",
        "resource": "/api/users"
    }
    
    not allow with input as {
        "user": "charlie",
        "action": "write",
        "resource": "/api/users"
    }
}

test_department_isolation if {
    not allow with input as {
        "user": "charlie",
        "action": "read",
        "resource": "/api/engineering/docs"
    } with data.users.charlie as {
        "department": "sales"
    } with data.resources as {
        "/api/engineering/docs": {"department": "engineering"}
    }
}
```

**è¿è¡Œæµ‹è¯•**:

```bash
opa test policy/ -v
```

---

### 6.2 é›†æˆæµ‹è¯•

**æµ‹è¯•æ¡†æ¶**ï¼ˆGoç¤ºä¾‹ï¼‰:

```go
func TestRBACPolicy(t *testing.T) {
    ctx := context.Background()
    
    // åŠ è½½ç­–ç•¥
    r := rego.New(
        rego.Query("data.rbac.authz.allow"),
        rego.Load([]string{"policy.rego"}, nil),
    )
    
    // æµ‹è¯•ç”¨ä¾‹
    tests := []struct {
        input    map[string]interface{}
        expected bool
    }{
        {
            input: map[string]interface{}{
                "user":     "alice",
                "action":   "read",
                "resource": "/api/users",
            },
            expected: true,
        },
        // æ›´å¤šæµ‹è¯•...
    }
    
    for _, tt := range tests {
        result, err := r.Eval(ctx, rego.EvalInput(tt.input))
        assert.NoError(t, err)
        assert.Equal(t, tt.expected, result[0].Expressions[0].Value)
    }
}
```

---

### 6.3 æ€§èƒ½åŸºå‡†

```bash
# åŸºå‡†æµ‹è¯•
opa bench policy.rego \
    --data data.json \
    --input input.json \
    --count 10000
```

**è¾“å‡º**:

```text
+-------------------+----------+---------+
| METRIC            | VALUE    | UNIT    |
+-------------------+----------+---------+
| samples           | 10000    |         |
| mean              | 1.23     | ms      |
| p50               | 1.10     | ms      |
| p90               | 1.80     | ms      |
| p99               | 3.20     | ms      |
+-------------------+----------+---------+
```

---

## é™„å½•: å¸¸è§æ¨¡å¼é€ŸæŸ¥

| æ¨¡å¼ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| **ç›´æ¥è§’è‰²æ£€æŸ¥** | ç®€å•RBAC | `"admin" in user.roles` |
| **æƒé™æŸ¥æ‰¾** | æ ‡å‡†RBAC | `has_permission(role, action, resource)` |
| **èµ„æºæ‰€æœ‰è€…** | åŠ¨æ€æƒé™ | `resource.owner == user` |
| **éƒ¨é—¨éš”ç¦»** | ABAC | `user.dept == resource.dept` |
| **æ—¶é—´é™åˆ¶** | ä¸Šä¸‹æ–‡æ„ŸçŸ¥ | `time.now_ns() < expiry` |
| **å§”æ‰˜** | ä¸´æ—¶æˆæƒ | `delegation.to == user` |
| **ç»§æ‰¿** | å±‚çº§è§’è‰² | `all_roles contains inherited` |

---

**ä¸‹ä¸€ç¯‡**: [05.2-APIç½‘å…³æˆæƒ](./05.2-APIç½‘å…³æˆæƒ.md)  
**ç›¸å…³**: [07.1-æ ¸å¿ƒæ¦‚å¿µå®šä¹‰](../07-æ¦‚å¿µå›¾è°±/07.1-æ ¸å¿ƒæ¦‚å¿µå®šä¹‰.md)
