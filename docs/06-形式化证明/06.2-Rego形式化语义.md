# Rego å½¢å¼åŒ–è¯­ä¹‰ï¼ˆFormal Semantics of Regoï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: ç†è®ºåŸºç¡€ï¼ˆåŸºäºRego v1.0è§„èŒƒï¼‰  
> **ç†è®ºåŸºç¡€**: Datalog + é›†åˆè®º + Î»æ¼”ç®—  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯  
> **å‚è€ƒ**: OPAå®˜æ–¹è§„èŒƒ + å­¦æœ¯è®ºæ–‡

---

## ğŸ“ å½¢å¼åŒ–è¯­ä¹‰è¯´æ˜

> **æœ¬æ–‡æ¡£é€‚åˆ**:
>
> - âœ… å½¢å¼åŒ–æ–¹æ³•ç ”ç©¶è€…
> - âœ… ç¼–ç¨‹è¯­è¨€ç†è®ºçˆ±å¥½è€…
> - âœ… éœ€è¦ä¸¥æ ¼è¯æ˜ç­–ç•¥æ­£ç¡®æ€§çš„åœºæ™¯
> - âš ï¸ æé«˜ç†è®ºæ€§ï¼Œå®è·µå¼€å‘è€…å¯è·³è¿‡
>
> **å½¢å¼åŒ–çš„ä»·å€¼**:
>
> - ç²¾ç¡®å®šä¹‰Regoè¯­è¨€çš„è¯­ä¹‰
> - ä¸ºç­–ç•¥æ­£ç¡®æ€§è¯æ˜æä¾›æ•°å­¦åŸºç¡€
> - æŒ‡å¯¼ç¼–è¯‘å™¨å’Œä¼˜åŒ–å™¨çš„å®ç°
>
> **ä¸å®è·µçš„å…³è”**:
>
> - å½¢å¼åŒ–è¯­ä¹‰è§£é‡Šä¸ºä»€ä¹ˆRegoè¿™æ ·è®¾è®¡
> - ç†è§£è¯­ä¹‰æœ‰åŠ©äºè°ƒè¯•å¤æ‚ç­–ç•¥
> - ä¸ºé«˜çº§ç”¨æˆ·æä¾›ç†è®ºæ”¯æ’‘
>
> ç›¸å…³: [Datalogç†è®º](06.1-Datalogç†è®ºåŸºç¡€.md) | [æ±‚å€¼æ¨¡å‹](../02-è¯­è¨€æ¨¡å‹/02.4-æ±‚å€¼æ¨¡å‹.md)

---

## ç›®å½•

- [Rego å½¢å¼åŒ–è¯­ä¹‰ï¼ˆFormal Semantics of Regoï¼‰](#rego-å½¢å¼åŒ–è¯­ä¹‰formal-semantics-of-rego)
  - [ğŸ“ å½¢å¼åŒ–è¯­ä¹‰è¯´æ˜](#-å½¢å¼åŒ–è¯­ä¹‰è¯´æ˜)
  - [ç›®å½•](#ç›®å½•)
  - [1. è¯­æ³•åŸŸå®šä¹‰](#1-è¯­æ³•åŸŸå®šä¹‰)
    - [1.1 åŸºæœ¬åŸŸï¼ˆBasic Domainsï¼‰](#11-åŸºæœ¬åŸŸbasic-domains)
    - [1.2 å€¼åŸŸï¼ˆValue Domainï¼‰](#12-å€¼åŸŸvalue-domain)
    - [1.3 é¡¹ï¼ˆTermsï¼‰](#13-é¡¹terms)
    - [1.4 è¡¨è¾¾å¼ï¼ˆExpressionsï¼‰](#14-è¡¨è¾¾å¼expressions)
    - [1.5 è§„åˆ™ï¼ˆRulesï¼‰](#15-è§„åˆ™rules)
  - [2. æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰](#2-æŠ½è±¡è¯­æ³•æ ‘ast)
    - [2.1 ASTèŠ‚ç‚¹å®šä¹‰](#21-astèŠ‚ç‚¹å®šä¹‰)
    - [2.2 ASTè½¬æ¢è§„åˆ™](#22-astè½¬æ¢è§„åˆ™)
  - [3. ç±»å‹ç³»ç»Ÿ](#3-ç±»å‹ç³»ç»Ÿ)
    - [3.1 ç±»å‹å®šä¹‰](#31-ç±»å‹å®šä¹‰)
    - [3.2 ç±»å‹æ¨å¯¼è§„åˆ™](#32-ç±»å‹æ¨å¯¼è§„åˆ™)
    - [3.3 ç±»å‹å®‰å…¨å®šç†](#33-ç±»å‹å®‰å…¨å®šç†)
  - [4. æ“ä½œè¯­ä¹‰ï¼ˆOperational Semanticsï¼‰](#4-æ“ä½œè¯­ä¹‰operational-semantics)
    - [4.1 å°æ­¥è¯­ä¹‰ï¼ˆSmall-Stepï¼‰](#41-å°æ­¥è¯­ä¹‰small-step)
    - [4.2 ç»Ÿä¸€ï¼ˆUnificationï¼‰](#42-ç»Ÿä¸€unification)
    - [4.3 èµ‹å€¼ï¼ˆAssignmentï¼‰](#43-èµ‹å€¼assignment)
    - [4.4 æ¯”è¾ƒï¼ˆComparisonï¼‰](#44-æ¯”è¾ƒcomparison)
    - [4.5 è¿æ¥ï¼ˆConjunctionï¼‰](#45-è¿æ¥conjunction)
    - [4.6 å¦å®šï¼ˆNegationï¼‰](#46-å¦å®šnegation)
  - [5. æ±‚å€¼æ¨¡å‹ï¼ˆEvaluation Modelï¼‰](#5-æ±‚å€¼æ¨¡å‹evaluation-model)
    - [5.1 è‡ªé¡¶å‘ä¸‹æ±‚å€¼](#51-è‡ªé¡¶å‘ä¸‹æ±‚å€¼)
    - [5.2 è§„åˆ™æ±‚å€¼](#52-è§„åˆ™æ±‚å€¼)
    - [5.3 æ¨å¯¼å¼æ±‚å€¼](#53-æ¨å¯¼å¼æ±‚å€¼)
  - [6. æ­£ç¡®æ€§å®šç†](#6-æ­£ç¡®æ€§å®šç†)
    - [6.1 ç¡®å®šæ€§å®šç†](#61-ç¡®å®šæ€§å®šç†)
    - [6.2 å®Œå¤‡æ€§å®šç†](#62-å®Œå¤‡æ€§å®šç†)
    - [6.3 å¯é æ€§å®šç†](#63-å¯é æ€§å®šç†)
  - [7. å¤æ‚åº¦åˆ†æ](#7-å¤æ‚åº¦åˆ†æ)
    - [7.1 æŸ¥è¯¢å¤æ‚åº¦](#71-æŸ¥è¯¢å¤æ‚åº¦)
    - [7.2 ç»Ÿä¸€å¤æ‚åº¦](#72-ç»Ÿä¸€å¤æ‚åº¦)
    - [7.3 ç´¢å¼•ä¼˜åŒ–](#73-ç´¢å¼•ä¼˜åŒ–)
    - [7.4 éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–](#74-éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–)
  - [é™„å½• A: å½¢å¼åŒ–ç¬¦å·è¡¨](#é™„å½•-a-å½¢å¼åŒ–ç¬¦å·è¡¨)
  - [é™„å½• B: ç¤ºä¾‹æ¨å¯¼](#é™„å½•-b-ç¤ºä¾‹æ¨å¯¼)
    - [ç¤ºä¾‹ï¼šè§„åˆ™æ±‚å€¼æ¨å¯¼](#ç¤ºä¾‹è§„åˆ™æ±‚å€¼æ¨å¯¼)
  - [é™„å½• C: å‚è€ƒæ–‡çŒ®](#é™„å½•-c-å‚è€ƒæ–‡çŒ®)

---

## 1. è¯­æ³•åŸŸå®šä¹‰

### 1.1 åŸºæœ¬åŸŸï¼ˆBasic Domainsï¼‰

```text
æ ‡è¯†ç¬¦  x, y, z âˆˆ Var                    (å˜é‡ç©ºé—´)
å¸¸é‡    c âˆˆ Const = Bool âˆª Num âˆª Str    (å¸¸é‡ç©ºé—´)
è·¯å¾„    p âˆˆ Path = Var Â· (Str | Var)*    (å¼•ç”¨è·¯å¾„)
```

### 1.2 å€¼åŸŸï¼ˆValue Domainï¼‰

```haskell
-- å€¼çš„å½’çº³å®šä¹‰
data Value = 
    | VBool   Bool              -- å¸ƒå°”å€¼
    | VNum    Number            -- æ•°å€¼ï¼ˆIEEE 754ï¼‰
    | VStr    String            -- å­—ç¬¦ä¸²ï¼ˆUTF-8ï¼‰
    | VNull                     -- ç©ºå€¼
    | VArray  [Value]           -- æ•°ç»„
    | VObject (Map String Value) -- å¯¹è±¡
    | VSet    (Set Value)       -- é›†åˆ
```

**å½¢å¼åŒ–å®šä¹‰**:

```text
V ::= true | false                  (å¸ƒå°”)
    | n âˆˆ â„                         (æ•°å€¼)
    | s âˆˆ Î£*                        (å­—ç¬¦ä¸²ï¼ŒÎ£=å­—ç¬¦é›†)
    | null                          (ç©º)
    | [Vâ‚, Vâ‚‚, ..., Vâ‚™]            (æ•°ç»„)
    | {kâ‚: Vâ‚, ..., kâ‚™: Vâ‚™}       (å¯¹è±¡, káµ¢ âˆˆ Str)
    | {Vâ‚, Vâ‚‚, ..., Vâ‚™}            (é›†åˆ)
```

### 1.3 é¡¹ï¼ˆTermsï¼‰

```text
t âˆˆ Term ::= 
    | x                             (å˜é‡)
    | V                             (å€¼)
    | t.k                           (å¯¹è±¡è®¿é—®)
    | t[i]                          (æ•°ç»„/å¯¹è±¡ç´¢å¼•)
    | [t | body]                    (æ•°ç»„æ¨å¯¼)
    | {t | body}                    (é›†åˆæ¨å¯¼)
    | {k: v | body}                 (å¯¹è±¡æ¨å¯¼)
    | f(tâ‚, ..., tâ‚™)                (å‡½æ•°è°ƒç”¨)
```

### 1.4 è¡¨è¾¾å¼ï¼ˆExpressionsï¼‰

```text
e âˆˆ Expr ::=
    | tâ‚ = tâ‚‚                       (ç»Ÿä¸€)
    | tâ‚ := tâ‚‚                      (èµ‹å€¼)
    | tâ‚ == tâ‚‚                      (ç›¸ç­‰æ¯”è¾ƒ)
    | tâ‚ != tâ‚‚                      (ä¸ç­‰æ¯”è¾ƒ)
    | tâ‚ < tâ‚‚                       (å°äº)
    | tâ‚ > tâ‚‚                       (å¤§äº)
    | eâ‚; eâ‚‚                        (è¿æ¥ï¼ŒAND)
    | some x in t                   (å­˜åœ¨é‡åŒ–)
    | every x in t { body }         (å…¨ç§°é‡åŒ–)
    | not e                         (å¦å®š)
```

### 1.5 è§„åˆ™ï¼ˆRulesï¼‰

```text
r âˆˆ Rule ::= 
    head :- body                    (è•´æ¶µå¼)
    
head âˆˆ Head ::= 
    | p                             (å®Œå…¨è§„åˆ™)
    | p[k]                          (éƒ¨åˆ†è§„åˆ™-å¯¹è±¡)
    | p[k] := v                     (éƒ¨åˆ†è§„åˆ™-èµ‹å€¼)
    
body âˆˆ Body ::= 
    | eâ‚, eâ‚‚, ..., eâ‚™               (è¡¨è¾¾å¼åºåˆ—ï¼Œé€—å·=AND)
    | { eâ‚ | eâ‚‚ | ... | eâ‚™ }        (é€‰æ‹©ï¼Œç®¡é“=OR)
```

---

## 2. æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰

### 2.1 ASTèŠ‚ç‚¹å®šä¹‰

```typescript
// TypeScripté£æ ¼çš„ç±»å‹å®šä¹‰

type AST = Module

interface Module {
    package: Package
    imports: Import[]
    rules: Rule[]
}

interface Rule {
    head: Head
    body: Body
    location: Location
}

interface Head {
    name: Ref
    key?: Term
    value?: Term
}

interface Body {
    expressions: Expr[]
}

type Expr = 
    | BinaryExpr
    | UnaryExpr
    | TermExpr
    | ComprehensionExpr

interface BinaryExpr {
    operator: '=' | ':=' | '==' | '!=' | '<' | '>' | '+' | '-' | '*' | '/'
    left: Term
    right: Term
}

interface Ref {
    path: Term[]  // å¦‚ data.users[i].roles
}
```

### 2.2 ASTè½¬æ¢è§„åˆ™

**æºç  â†’ AST**:

```rego
# æºç 
allow if {
    input.method == "GET"
    input.user.role == "admin"
}
```

**å¯¹åº”AST**ï¼ˆç®€åŒ–è¡¨ç¤ºï¼‰:

```json
{
  "type": "Rule",
  "head": {
    "name": {"path": ["allow"]},
    "value": true
  },
  "body": [
    {
      "type": "BinaryExpr",
      "operator": "==",
      "left": {"ref": ["input", "method"]},
      "right": {"value": "GET"}
    },
    {
      "type": "BinaryExpr",
      "operator": "==",
      "left": {"ref": ["input", "user", "role"]},
      "right": {"value": "admin"}
    }
  ]
}
```

---

## 3. ç±»å‹ç³»ç»Ÿ

### 3.1 ç±»å‹å®šä¹‰

```text
Ï„ âˆˆ Type ::=
    | Boolean                       (å¸ƒå°”ç±»å‹)
    | Number                        (æ•°å€¼ç±»å‹)
    | String                        (å­—ç¬¦ä¸²ç±»å‹)
    | Null                          (ç©ºç±»å‹)
    | Array<Ï„>                      (æ•°ç»„ç±»å‹)
    | Object<String, Ï„>             (å¯¹è±¡ç±»å‹)
    | Set<Ï„>                        (é›†åˆç±»å‹)
    | Ï„â‚ | Ï„â‚‚                       (è”åˆç±»å‹)
    | Any                           (ä»»æ„ç±»å‹)
```

### 3.2 ç±»å‹æ¨å¯¼è§„åˆ™

**å˜é‡ç±»å‹**:

```text
Î“(x) = Ï„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Var)
Î“ âŠ¢ x : Ï„
```

**å­—é¢é‡ç±»å‹**:

```text
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Bool)
Î“ âŠ¢ true : Boolean


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Num)
Î“ âŠ¢ 42 : Number


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Str)
Î“ âŠ¢ "abc" : String
```

**æ•°ç»„ç±»å‹**:

```text
Î“ âŠ¢ tâ‚ : Ï„    Î“ âŠ¢ tâ‚‚ : Ï„    ...    Î“ âŠ¢ tâ‚™ : Ï„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Array)
        Î“ âŠ¢ [tâ‚, tâ‚‚, ..., tâ‚™] : Array<Ï„>
```

**å¯¹è±¡ç±»å‹**:

```text
Î“ âŠ¢ vâ‚ : Ï„â‚    Î“ âŠ¢ vâ‚‚ : Ï„â‚‚    ...    Î“ âŠ¢ vâ‚™ : Ï„â‚™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Object)
    Î“ âŠ¢ {kâ‚: vâ‚, kâ‚‚: vâ‚‚, ..., kâ‚™: vâ‚™} : Object<String, Ï„â‚|Ï„â‚‚|...|Ï„â‚™>
```

**å‡½æ•°ç±»å‹**:

```text
Î“ âŠ¢ tâ‚ : Ï„â‚    ...    Î“ âŠ¢ tâ‚™ : Ï„â‚™    f : (Ï„â‚, ..., Ï„â‚™) â†’ Ï„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Call)
                Î“ âŠ¢ f(tâ‚, ..., tâ‚™) : Ï„
```

### 3.3 ç±»å‹å®‰å…¨å®šç†

**å®šç† 3.1 (Progress)**: å¦‚æœ `âŠ¢ e : Ï„` ä¸” `e` ä¸æ˜¯å€¼ï¼Œåˆ™å­˜åœ¨ `e'` ä½¿å¾— `e â†’ e'`ã€‚

**å®šç† 3.2 (Preservation)**: å¦‚æœ `Î“ âŠ¢ e : Ï„` ä¸” `e â†’ e'`ï¼Œåˆ™ `Î“ âŠ¢ e' : Ï„`ã€‚

**è¯æ˜**: å¯¹è¡¨è¾¾å¼ç»“æ„å½’çº³ï¼ˆè§é™„å½•Aï¼‰ã€‚

---

## 4. æ“ä½œè¯­ä¹‰ï¼ˆOperational Semanticsï¼‰

### 4.1 å°æ­¥è¯­ä¹‰ï¼ˆSmall-Stepï¼‰

**æ±‚å€¼é…ç½®**:

```text
âŸ¨e, ÏƒâŸ© â†’ âŸ¨e', Ïƒ'âŸ©
```

- `e`: å½“å‰è¡¨è¾¾å¼
- `Ïƒ`: ç¯å¢ƒï¼ˆVar â†’ Valueï¼‰
- `e'`: åç»§è¡¨è¾¾å¼
- `Ïƒ'`: æ›´æ–°åçš„ç¯å¢ƒ

### 4.2 ç»Ÿä¸€ï¼ˆUnificationï¼‰

**è§„åˆ™ (E-Unify-Var)**:

```text
Ïƒ(x) = âŠ¥    unify(vâ‚, vâ‚‚) = v
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨x = v, ÏƒâŸ© â†’ âŸ¨true, Ïƒ[x â†¦ v]âŸ©
```

**è§„åˆ™ (E-Unify-Val)**:

```text
vâ‚ == vâ‚‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨vâ‚ = vâ‚‚, ÏƒâŸ© â†’ âŸ¨true, ÏƒâŸ©
```

**è§„åˆ™ (E-Unify-Array)**:

```text
|arrâ‚| = |arrâ‚‚| = n
âˆ€i âˆˆ [1..n]: âŸ¨arrâ‚[i] = arrâ‚‚[i], Ïƒáµ¢âŸ© â†’ âŸ¨true, Ïƒáµ¢â‚Šâ‚âŸ©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨[arrâ‚] = [arrâ‚‚], Ïƒâ‚âŸ© â†’ âŸ¨true, Ïƒâ‚™â‚Šâ‚âŸ©
```

### 4.3 èµ‹å€¼ï¼ˆAssignmentï¼‰

**è§„åˆ™ (E-Assign)**:

```text
âŸ¨t, ÏƒâŸ© â‡“ v
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨x := t, ÏƒâŸ© â†’ âŸ¨true, Ïƒ[x â†¦ v]âŸ©
```

**æ³¨æ„**: `:=` æ˜¯**å±€éƒ¨èµ‹å€¼**ï¼Œä¸å½±å“å…¨å±€æ•°æ®ã€‚

### 4.4 æ¯”è¾ƒï¼ˆComparisonï¼‰

**è§„åˆ™ (E-Eq)**:

```text
âŸ¨tâ‚, ÏƒâŸ© â‡“ vâ‚    âŸ¨tâ‚‚, ÏƒâŸ© â‡“ vâ‚‚    vâ‚ â‰¡ vâ‚‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨tâ‚ == tâ‚‚, ÏƒâŸ© â†’ âŸ¨true, ÏƒâŸ©
```

**å€¼ç›¸ç­‰å®šä¹‰** (`â‰¡`):

```text
v â‰¡ v                                               (è‡ªå)
true â‰¡ true,  false â‰¡ false                         (å¸ƒå°”)
nâ‚ â‰¡ nâ‚‚  âŸº  |nâ‚ - nâ‚‚| < Îµ                          (æ•°å€¼ï¼ŒÎµ=ç²¾åº¦)
sâ‚ â‰¡ sâ‚‚  âŸº  sâ‚ == sâ‚‚ (å­—ç¬¦ä¸²ç›¸ç­‰)                  (å­—ç¬¦ä¸²)
[vâ‚, ..., vâ‚™] â‰¡ [wâ‚, ..., wâ‚™]  âŸº  âˆ€i: váµ¢ â‰¡ wáµ¢      (æ•°ç»„)
{k: v} â‰¡ {k: w}  âŸº  v â‰¡ w                           (å¯¹è±¡)
```

### 4.5 è¿æ¥ï¼ˆConjunctionï¼‰

**è§„åˆ™ (E-And)**:

```text
âŸ¨eâ‚, ÏƒâŸ© â†’ âŸ¨true, Ïƒ'âŸ©    âŸ¨eâ‚‚, Ïƒ'âŸ© â†’ âŸ¨true, Ïƒ''âŸ©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨eâ‚; eâ‚‚, ÏƒâŸ© â†’ âŸ¨true, Ïƒ''âŸ©
```

**çŸ­è·¯è§„åˆ™**:

```text
âŸ¨eâ‚, ÏƒâŸ© â†’ âŸ¨false, Ïƒ'âŸ©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨eâ‚; eâ‚‚, ÏƒâŸ© â†’ âŸ¨false, Ïƒ'âŸ©
```

### 4.6 å¦å®šï¼ˆNegationï¼‰

**è§„åˆ™ (E-Not)**:

```text
âŸ¨e, ÏƒâŸ© â†’ âŸ¨false, _âŸ©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŸ¨not e, ÏƒâŸ© â†’ âŸ¨true, ÏƒâŸ©
```

**é‡è¦**: `not` ä¸æ”¹å˜ç¯å¢ƒï¼ˆé—­ä¸–ç•Œå‡è®¾ï¼‰ã€‚

---

## 5. æ±‚å€¼æ¨¡å‹ï¼ˆEvaluation Modelï¼‰

### 5.1 è‡ªé¡¶å‘ä¸‹æ±‚å€¼

**æŸ¥è¯¢æ±‚å€¼å‡½æ•°**:

```text
eval : Query Ã— Env Ã— Data â†’ SetâŸ¨BindingâŸ©

eval(q, Ïƒ, D) = {Î¸ | Ïƒ âŠ¢ q â‡“ Î¸ âˆ§ consistent(Î¸, D)}
```

**ç®—æ³•æµç¨‹**:

```python
def eval_query(query, env, data):
    if isinstance(query, Term):
        return eval_term(query, env, data)
    
    elif isinstance(query, Equality):  # t1 = t2
        v1 = eval_term(query.left, env, data)
        v2 = eval_term(query.right, env, data)
        bindings = unify(v1, v2)
        return {env.extend(b) for b in bindings}
    
    elif isinstance(query, Conjunction):  # e1; e2
        results = set()
        for env1 in eval_query(query.left, env, data):
            for env2 in eval_query(query.right, env1, data):
                results.add(env2)
        return results
    
    elif isinstance(query, Disjunction):  # e1 | e2
        results1 = eval_query(query.left, env, data)
        results2 = eval_query(query.right, env, data)
        return results1.union(results2)
    
    elif isinstance(query, Negation):  # not e
        if eval_query(query.body, env, data):
            return set()  # å¤±è´¥
        else:
            return {env}  # æˆåŠŸï¼ˆä½†ä¸æ‰©å±•ç»‘å®šï¼‰
```

### 5.2 è§„åˆ™æ±‚å€¼

**è§„åˆ™è°ƒç”¨**:

```text
eval_rule : Rule Ã— Env Ã— Data â†’ SetâŸ¨ValueâŸ©

eval_rule(head :- body, Ïƒ, D) = 
    {Ïƒ'(head) | Ïƒ' âˆˆ eval(body, Ïƒ, D)}
```

**å®Œå…¨è§„åˆ™**:

```rego
allow := true :- body
```

â†’ è¿”å›å•ä¸ªå€¼ï¼ˆ`true` æˆ– `undefined`ï¼‰

**éƒ¨åˆ†è§„åˆ™**:

```rego
users[name] := user :- body
```

â†’ è¿”å›å¯¹è±¡ï¼ˆå¤šä¸ªé”®å€¼å¯¹ï¼‰

### 5.3 æ¨å¯¼å¼æ±‚å€¼

**æ•°ç»„æ¨å¯¼**:

```text
eval([t | body], Ïƒ, D) = 
    [Ïƒ'(t) | Ïƒ' âˆˆ eval(body, Ïƒ, D)]
```

**é›†åˆæ¨å¯¼**:

```text
eval({t | body}, Ïƒ, D) = 
    {Ïƒ'(t) | Ïƒ' âˆˆ eval(body, Ïƒ, D)}
```

**ç¤ºä¾‹**:

```rego
# æå–æ‰€æœ‰ç®¡ç†å‘˜åå­—
admin_names := [u.name | u := data.users[_]; u.role == "admin"]
```

**è¯­ä¹‰**:

```text
eval(admin_names, âˆ…, D) = 
    [u.name | u âˆˆ D.users âˆ§ u.role = "admin"]
```

---

## 6. æ­£ç¡®æ€§å®šç†

### 6.1 ç¡®å®šæ€§å®šç†

**å®šç† 6.1 (Determinism)**: å¯¹äºä»»æ„æŸ¥è¯¢ `q`ã€ç¯å¢ƒ `Ïƒ` å’Œæ•°æ® `D`ï¼Œæ±‚å€¼ç»“æœ `eval(q, Ïƒ, D)` æ˜¯ç¡®å®šçš„ã€‚

**è¯æ˜**:
é€šè¿‡å¯¹æŸ¥è¯¢ç»“æ„å½’çº³ï¼š

1. **åŸºç¡€æƒ…å†µ**: é¡¹æ±‚å€¼ç”±å€¼åŸŸç›´æ¥ç¡®å®šã€‚
2. **å½’çº³å‡è®¾**: å‡è®¾å­æŸ¥è¯¢æ±‚å€¼ç¡®å®šã€‚
3. **å½’çº³æ­¥éª¤**:
   - ç»Ÿä¸€ç®—æ³•çš„ç¡®å®šæ€§ï¼ˆRobinson 1965ï¼‰
   - é›†åˆè¿ç®—çš„ç¡®å®šæ€§ï¼ˆé›†åˆè®ºå…¬ç†ï¼‰

**QED** âˆ

### 6.2 å®Œå¤‡æ€§å®šç†

**å®šç† 6.2 (Completeness)**: å¦‚æœå­˜åœ¨æ»¡è¶³æŸ¥è¯¢ `q` çš„ç»‘å®š `Î¸`ï¼Œåˆ™ `Î¸ âˆˆ eval(q, Ïƒ, D)`ã€‚

**å½¢å¼åŒ–**:

```text
(âˆƒÎ¸: models(Î¸, q, D)) âŸ¹ Î¸ âˆˆ eval(q, Ïƒ, D)
```

**è¯æ˜**: è§ [Ullman 1988] å…³äºDatalogå®Œå¤‡æ€§è¯æ˜ã€‚

### 6.3 å¯é æ€§å®šç†

**å®šç† 6.3 (Soundness)**: å¦‚æœ `Î¸ âˆˆ eval(q, Ïƒ, D)`ï¼Œåˆ™ `Î¸` æ»¡è¶³æŸ¥è¯¢ `q`ã€‚

**å½¢å¼åŒ–**:

```text
Î¸ âˆˆ eval(q, Ïƒ, D) âŸ¹ models(Î¸, q, D)
```

**è¯æ˜**: é€šè¿‡æ“ä½œè¯­ä¹‰çš„ä¿å‹æ€§ï¼ˆType Preservationï¼‰ã€‚

---

## 7. å¤æ‚åº¦åˆ†æ

### 7.1 æŸ¥è¯¢å¤æ‚åº¦

**æ—¶é—´å¤æ‚åº¦**:

```text
T(query) = O(|Data| Ã— |Rules| Ã— B^d)
```

- `|Data|`: æ•°æ®å¤§å°
- `|Rules|`: è§„åˆ™æ•°é‡
- `B`: åˆ†æ”¯å› å­
- `d`: æŸ¥è¯¢æ·±åº¦

**ç©ºé—´å¤æ‚åº¦**:

```text
S(query) = O(|Vars| Ã— |Bindings|)
```

### 7.2 ç»Ÿä¸€å¤æ‚åº¦

**Robinsonç»Ÿä¸€ç®—æ³•**:

```text
unify(tâ‚, tâ‚‚) = O(min(|tâ‚|, |tâ‚‚|))
```

### 7.3 ç´¢å¼•ä¼˜åŒ–

**å“ˆå¸Œç´¢å¼•**:

```text
index_lookup : O(1)          # å¸¸æ•°æ—¶é—´
index_build  : O(n log n)    # å»ºç«‹ç´¢å¼•
```

**Trieç´¢å¼•**:

```text
trie_lookup : O(k)           # k=é”®é•¿åº¦
trie_build  : O(n Ã— k)
```

### 7.4 éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–

**å®šç† 7.1**: éƒ¨åˆ†æ±‚å€¼å¯å°†æŸ¥è¯¢å¤æ‚åº¦é™ä½åˆ° `O(|Input|)`ï¼ˆæ•°æ®é¡¹æå‰è®¡ç®—ï¼‰ã€‚

---

## é™„å½• A: å½¢å¼åŒ–ç¬¦å·è¡¨

| ç¬¦å· | å«ä¹‰ | é¢†åŸŸ |
|------|------|------|
| `Î“` | ç±»å‹ç¯å¢ƒ | ç±»å‹ç³»ç»Ÿ |
| `Ïƒ` | å€¼ç¯å¢ƒï¼ˆå˜é‡ç»‘å®šï¼‰ | æ±‚å€¼ |
| `Î¸` | æ›¿æ¢/ç»Ÿä¸€å­ | ç»Ÿä¸€ |
| `âŠ¢` | æ¨å¯¼å…³ç³» | ç±»å‹/è¯æ˜ |
| `â‡“` | å¤§æ­¥æ±‚å€¼ | è¯­ä¹‰ |
| `â†’` | å°æ­¥æ±‚å€¼ | è¯­ä¹‰ |
| `â‰¡` | å€¼ç›¸ç­‰ | ç­‰ä»· |
| `âŠ¥` | æœªå®šä¹‰/å¤±è´¥ | åº•ç±»å‹ |
| `âŠ¤` | çœŸ/æˆåŠŸ | é¡¶ç±»å‹ |

---

## é™„å½• B: ç¤ºä¾‹æ¨å¯¼

### ç¤ºä¾‹ï¼šè§„åˆ™æ±‚å€¼æ¨å¯¼

**ç­–ç•¥**:

```rego
package example

allow if {
    input.method == "GET"
    input.user.role == "admin"
}
```

**è¾“å…¥**:

```json
{
    "method": "GET",
    "user": {"role": "admin"}
}
```

**æ¨å¯¼è¿‡ç¨‹**:

```text
Ïƒâ‚€ = {input â†¦ {"method": "GET", "user": {"role": "admin"}}}

æ­¥éª¤1: æ±‚å€¼ input.method == "GET"
    âŸ¨input.method, Ïƒâ‚€âŸ© â‡“ "GET"
    âŸ¨"GET" == "GET", Ïƒâ‚€âŸ© â†’ âŸ¨true, Ïƒâ‚€âŸ©

æ­¥éª¤2: æ±‚å€¼ input.user.role == "admin"
    âŸ¨input.user.role, Ïƒâ‚€âŸ© â‡“ "admin"
    âŸ¨"admin" == "admin", Ïƒâ‚€âŸ© â†’ âŸ¨true, Ïƒâ‚€âŸ©

æ­¥éª¤3: è¿æ¥ï¼ˆANDï¼‰
    âŸ¨(æ­¥éª¤1) ; (æ­¥éª¤2), Ïƒâ‚€âŸ© â†’ âŸ¨true, Ïƒâ‚€âŸ©

æ­¥éª¤4: è§„åˆ™å¤´
    âŸ¨allow, Ïƒâ‚€âŸ© â‡“ true

ç»“è®º: allow = true
```

---

## é™„å½• C: å‚è€ƒæ–‡çŒ®

1. **Abiteboul, S., et al.** (1995). *Foundations of Databases*. Addison-Wesley.
2. **Ullman, J. D.** (1988). *Principles of Database and Knowledge-Base Systems*. Computer Science Press.
3. **Robinson, J. A.** (1965). "A Machine-Oriented Logic Based on the Resolution Principle". *JACM*.
4. **Plotkin, G. D.** (2004). "A Structural Approach to Operational Semantics". *JLAP*.
5. **OPA Documentation** (2025). "Policy Language Reference". <https://www.openpolicyagent.org/>

---

**ä¸‹ä¸€ç¯‡**: [06.3-æ±‚å€¼æ­£ç¡®æ€§è¯æ˜](./06.3-æ±‚å€¼æ­£ç¡®æ€§è¯æ˜.md)  
**ç›¸å…³**: [02.2-è¯­ä¹‰æ¨¡å‹](../02-è¯­è¨€æ¨¡å‹/02.2-è¯­ä¹‰æ¨¡å‹.md)
