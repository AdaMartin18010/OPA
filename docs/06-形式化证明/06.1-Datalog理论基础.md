# Datalogç†è®ºåŸºç¡€ï¼ˆDatalog Theoretical Foundationsï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: ç†è®ºåŸºç¡€ï¼ˆä¸ä¾èµ–ç‰ˆæœ¬ï¼‰  
> **ç†è®ºåŸºç¡€**: é€»è¾‘ç¼–ç¨‹ã€æ•°æ®åº“ç†è®º  
> **åº”ç”¨**: Regoè¯­è¨€è¯­ä¹‰ã€æŸ¥è¯¢ä¼˜åŒ–  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯  
> **å‚è€ƒ**: Classic Datalogè®ºæ–‡é›†

---

## ğŸ“š ç†è®ºæ–‡æ¡£è¯´æ˜

> **æœ¬æ–‡æ¡£é€‚åˆ**:
>
> - âœ… å¯¹å½¢å¼åŒ–æ–¹æ³•æ„Ÿå…´è¶£çš„ç ”ç©¶äººå‘˜
> - âœ… å¸Œæœ›æ·±å…¥ç†è§£Regoè¯­ä¹‰çš„å¼€å‘è€…
> - âœ… ç­–ç•¥æ­£ç¡®æ€§éªŒè¯éœ€æ±‚
> - âš ï¸ é«˜åº¦ç†è®ºæ€§ï¼Œå®è·µå¼€å‘è€…å¯è·³è¿‡
>
> **ç†è®ºä»·å€¼**:
>
> - ç†è§£Regoä¸Datalogçš„å…³ç³»
> - ä¸ºç­–ç•¥ä¼˜åŒ–æä¾›ç†è®ºåŸºç¡€
> - å½¢å¼åŒ–éªŒè¯ç­–ç•¥æ­£ç¡®æ€§
>
> **å®è·µå…³è”**:
>
> - Datalogçš„é€’å½’æŸ¥è¯¢å¯¹åº”Regoçš„`walk`å‡½æ•°
> - Datalogçš„å¦å®šå¯¹åº”Regoçš„`not`
> - æŸ¥è¯¢ä¼˜åŒ–ç†è®ºæŒ‡å¯¼Regoæ€§èƒ½ä¼˜åŒ–
>
> ç›¸å…³: [æ±‚å€¼æ¨¡å‹](../02-è¯­è¨€æ¨¡å‹/02.4-æ±‚å€¼æ¨¡å‹.md) | [Top-Downæ±‚å€¼å™¨](../03-å®ç°æ¶æ„/03.4-Top-Downæ±‚å€¼å™¨.md)

---

## 1. Datalogæ¦‚è¿°

### 1.1 åŸºæœ¬å®šä¹‰

**Datalog = æ•°æ®åº“ + é€»è¾‘**:

```text
Datalogç‰¹ç‚¹:
â”œâ”€â”€ å£°æ˜å¼è¯­è¨€
â”œâ”€â”€ åŸºäºHornå­å¥
â”œâ”€â”€ æ— å‰¯ä½œç”¨
â”œâ”€â”€ ä¿è¯ç»ˆæ­¢
â””â”€â”€ å¯åˆ¤å®šæ€§
```

**è¯­æ³•ç»„æˆ**ï¼š

```text
Fact (äº‹å®):
  parent(tom, bob).
  parent(bob, ann).

Rule (è§„åˆ™):
  ancestor(X, Y) :- parent(X, Y).
  ancestor(X, Z) :- parent(X, Y), ancestor(Y, Z).

Query (æŸ¥è¯¢):
  ?- ancestor(tom, ann).
```

### 1.2 Rego vs Datalog

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | Datalog | Rego |
|------|---------|------|
| **è¯­æ³•** | Prologé£æ ¼ | JSONå‹å¥½ |
| **æ•°æ®** | å…³ç³» | JSONæ–‡æ¡£ |
| **å¦å®š** | åˆ†å±‚å¦å®š | å®‰å…¨å¦å®š |
| **èšåˆ** | æœ‰é™æ”¯æŒ | ä¸°å¯Œçš„å†…ç½®å‡½æ•° |
| **ç±»å‹** | æ— ç±»å‹ | åŠ¨æ€ç±»å‹ |

**Regoç»§æ‰¿è‡ªDatalog**ï¼š

```text
1. é€’å½’è§„åˆ™
2. ç»Ÿä¸€æ±‚å€¼
3. éç¡®å®šæ€§æœç´¢
4. æœ€å°ä¸åŠ¨ç‚¹è¯­ä¹‰
```

---

## 2. å½¢å¼åŒ–è¯­æ³•

### 2.1 æœ¯è¯­ï¼ˆTermsï¼‰

```text
æœ¯è¯­ t ::= c           (å¸¸é‡: 1, "hello", true)
         | X           (å˜é‡: å¤§å†™å­—æ¯å¼€å¤´)
         | f(tâ‚,...,tâ‚™) (å¤åˆé¡¹)

ç¤ºä¾‹:
  å¸¸é‡: 42, "alice", null
  å˜é‡: X, User, Result
  å¤åˆ: person("alice", 30)
```

### 2.2 åŸå­ï¼ˆAtomsï¼‰

```text
åŸå­ A ::= p(tâ‚,...,tâ‚™)

å…¶ä¸­:
  p: è°“è¯ç¬¦å·
  táµ¢: æœ¯è¯­

ç¤ºä¾‹:
  parent(tom, bob)
  employee(X, "engineering", 100000)
```

### 2.3 å­å¥ï¼ˆClausesï¼‰

**Hornå­å¥**ï¼š

```text
å­å¥ C ::= H :- Bâ‚, ..., Bâ‚™

å…¶ä¸­:
  H: å¤´éƒ¨ï¼ˆheadï¼‰- å•ä¸ªåŸå­
  Báµ¢: ä½“éƒ¨ï¼ˆbodyï¼‰- åŸå­åºåˆ—

è¯­ä¹‰: H â† Bâ‚ âˆ§ ... âˆ§ Bâ‚™
```

**ç¤ºä¾‹**ï¼š

```datalog
% äº‹å®ï¼ˆæ— ä½“éƒ¨çš„å­å¥ï¼‰
parent(tom, bob).

% è§„åˆ™
ancestor(X, Y) :- parent(X, Y).
ancestor(X, Z) :- parent(X, Y), ancestor(Y, Z).

% æŸ¥è¯¢
?- ancestor(tom, Z).
```

---

## 3. è¯­ä¹‰ç†è®º

### 3.1 Herbrandè¯­ä¹‰

**Herbrandå®‡å®™**ï¼š

```text
ç»™å®šç¨‹åºPï¼ŒHerbrandå®‡å®™U_PåŒ…å«ï¼š
  - Pä¸­æ‰€æœ‰å¸¸é‡
  - æ‰€æœ‰ç”±Pä¸­å‡½æ•°ç¬¦å·æ„é€ çš„é¡¹

ç¤ºä¾‹:
P = { p(a). p(f(X)) :- p(X). }

U_P = {a, f(a), f(f(a)), ...}
```

**HerbrandåŸº**ï¼š

```text
H_P = Pä¸­æ‰€æœ‰è°“è¯ç¬¦å·åœ¨U_Pä¸Šçš„æ‰€æœ‰å¯èƒ½å®ä¾‹

ç¤ºä¾‹:
P = { parent(tom, bob). ancestor(X,Y) :- parent(X,Y). }

H_P = {
  parent(tom, bob),
  parent(tom, tom),
  ancestor(tom, bob),
  ancestor(bob, tom),
  ...
}
```

### 3.2 æœ€å°æ¨¡å‹

**æ¨¡å‹å®šä¹‰**ï¼š

```text
æ¨¡å‹ M âŠ† H_P æ»¡è¶³ï¼š
  å¯¹æ‰€æœ‰è§„åˆ™ H :- Bâ‚, ..., Bâ‚™
  å¦‚æœ Bâ‚, ..., Bâ‚™ âˆˆ Mï¼Œåˆ™ H âˆˆ M

æœ€å°æ¨¡å‹ = æœ€å°çš„æ»¡è¶³æ‰€æœ‰è§„åˆ™çš„Herbrandè§£é‡Š
```

**ç¤ºä¾‹**ï¼š

```datalog
p(a).
p(b).
q(X) :- p(X).

æœ€å°æ¨¡å‹ M = {p(a), p(b), q(a), q(b)}
```

### 3.3 ä¸åŠ¨ç‚¹è¯­ä¹‰

**T_Pç®—å­**ï¼š

```text
T_P: 2^H_P â†’ 2^H_P

T_P(I) = {H | H :- Bâ‚,...,Bâ‚™ âˆˆ ground(P), Bâ‚,...,Bâ‚™ âˆˆ I}

æ€§è´¨:
  1. å•è°ƒæ€§: I âŠ† J â‡’ T_P(I) âŠ† T_P(J)
  2. è¿ç»­æ€§
  3. æœ‰æœ€å°ä¸åŠ¨ç‚¹ lfp(T_P)
```

**å®šç†**ï¼š

```text
Mæ˜¯Pçš„æœ€å°æ¨¡å‹ âŸº M = lfp(T_P)
```

**è®¡ç®—ç¤ºä¾‹**ï¼š

```datalog
p(a).
q(X) :- p(X).

è¿­ä»£:
Iâ‚€ = âˆ…
Iâ‚ = T_P(Iâ‚€) = {p(a)}
Iâ‚‚ = T_P(Iâ‚) = {p(a), q(a)}
Iâ‚ƒ = T_P(Iâ‚‚) = {p(a), q(a)}  // ä¸åŠ¨ç‚¹

lfp(T_P) = {p(a), q(a)}
```

---

## 4. å¦å®šè¯­ä¹‰

### 4.1 åˆ†å±‚å¦å®šï¼ˆStratified Negationï¼‰

**åˆ†å±‚å®šä¹‰**ï¼š

```text
ç¨‹åºPæ˜¯åˆ†å±‚çš„ï¼Œå¦‚æœå¯ä»¥åˆ†å±‚ä¸ºPâ‚, ..., Pâ‚™ï¼Œä½¿å¾—ï¼š
  - Páµ¢ä¸­è§„åˆ™åªä¾èµ–Pâ±¼ (j â‰¤ i)çš„æ­£åŸå­
  - Páµ¢ä¸­è§„åˆ™åªå¦å®šPâ±¼ (j < i)çš„åŸå­

ç¤ºä¾‹:
Pâ‚: p(a). p(b).
Pâ‚‚: q(X) :- p(X), not r(X).
Pâ‚ƒ: r(X) :- p(X), q(X).
```

**è¯­ä¹‰**ï¼š

```text
é€å±‚è®¡ç®—:
1. è®¡ç®—Mâ‚ = lfp(T_Pâ‚)
2. è®¡ç®—Mâ‚‚ = lfp(T_Pâ‚‚^{not Mâ‚})
3. ...

æœ€ç»ˆæ¨¡å‹ M = â‹ƒ Máµ¢
```

### 4.2 å®Œç¾æ¨¡å‹è¯­ä¹‰ï¼ˆPerfect Model Semanticsï¼‰

**å®šä¹‰**ï¼š

```text
å¯¹åˆ†å±‚ç¨‹åºP:
  å®Œç¾æ¨¡å‹ = é€å±‚æ„å»ºçš„å”¯ä¸€æœ€å°æ¨¡å‹

æ€§è´¨:
  1. å”¯ä¸€æ€§
  2. ç›´è§‚æ€§
  3. å¯è®¡ç®—æ€§
```

---

## 5. é€’å½’

### 5.1 çº¿æ€§é€’å½’

```datalog
% ç¥–å…ˆå…³ç³»
ancestor(X, Y) :- parent(X, Y).
ancestor(X, Z) :- parent(X, Y), ancestor(Y, Z).
```

**è®¡ç®—**ï¼š

```text
æ•°æ®: parent(a,b), parent(b,c), parent(c,d)

è¿­ä»£:
Iâ‚€ = {parent(a,b), parent(b,c), parent(c,d)}
Iâ‚ = Iâ‚€ âˆª {ancestor(a,b), ancestor(b,c), ancestor(c,d)}
Iâ‚‚ = Iâ‚ âˆª {ancestor(a,c), ancestor(b,d)}
Iâ‚ƒ = Iâ‚‚ âˆª {ancestor(a,d)}
Iâ‚„ = Iâ‚ƒ  // ä¸åŠ¨ç‚¹
```

### 5.2 äº’é€’å½’

```datalog
even(0).
even(X) :- X > 0, Y = X - 1, odd(Y).

odd(X) :- X > 0, Y = X - 1, even(Y).
```

---

## 6. å¤æ‚åº¦åˆ†æ

### 6.1 æ•°æ®å¤æ‚åº¦

**å®šä¹‰**ï¼š

```text
æ•°æ®å¤æ‚åº¦ = å›ºå®šç¨‹åºPï¼Œå˜åŒ–æ•°æ®åº“Dæ—¶çš„å¤æ‚åº¦

å®šç†: Datalogçš„æ•°æ®å¤æ‚åº¦æ˜¯Pï¼ˆå¤šé¡¹å¼ï¼‰
```

**è¯æ˜æ€è·¯**ï¼š

```text
1. ç¨‹åºå¤§å°å›ºå®š â†’ å¸¸é‡
2. HerbrandåŸºå¤§å° â‰¤ |D|^k (kæ˜¯æœ€å¤§å…ƒæ•°)
3. ä¸åŠ¨ç‚¹è¿­ä»£ â‰¤ |H_P|æ¬¡
4. æ€»å¤æ‚åº¦: O(|D|^k)ï¼Œå¤šé¡¹å¼
```

### 6.2 ç»„åˆå¤æ‚åº¦

**å®šä¹‰**ï¼š

```text
ç»„åˆå¤æ‚åº¦ = åŒæ—¶è€ƒè™‘På’ŒDçš„å¤§å°

å®šç†: Datalogçš„ç»„åˆå¤æ‚åº¦æ˜¯EXPTIMEå®Œå…¨çš„
```

---

## 7. Regoä¸­çš„Datalog

### 7.1 å¯¹åº”å…³ç³»

**Datalog**ï¼š

```datalog
% è§„åˆ™
allow(User) :-
    user(User),
    role(User, Role),
    permission(Role, "admin").

% æŸ¥è¯¢
?- allow("alice").
```

**Rego**ï¼š

```rego
# è§„åˆ™
allow if {
    some User
    data.users[User]
    role := data.roles[User]
    data.permissions[role] == "admin"
}

# æŸ¥è¯¢
data.authz.allow
```

### 7.2 æ‰©å±•ç‰¹æ€§

**Regoè¶…è¶ŠDatalog**ï¼š

```text
1. JSONæ•°æ®æ¨¡å‹
   â””â”€â”€ vs å…³ç³»æ¨¡å‹

2. ä¸°å¯Œçš„å†…ç½®å‡½æ•°
   â””â”€â”€ å­—ç¬¦ä¸²ã€æ•°ç»„ã€åŠ å¯†ç­‰

3. æ¨å¯¼
   â””â”€â”€ [x | condition]

4. èµ‹å€¼
   â””â”€â”€ x := expr

5. æ¯”è¾ƒè¿ç®—ç¬¦
   â””â”€â”€ ==, !=, <, >, <=, >=
```

---

## 8. æŸ¥è¯¢ä¼˜åŒ–

### 8.1 Magic Setsè½¬æ¢

**ç›®æ ‡**ï¼šé¿å…è®¡ç®—ä¸ç›¸å…³çš„äº‹å®

**ç¤ºä¾‹**ï¼š

```datalog
% åŸå§‹ç¨‹åº
reachable(X, Y) :- edge(X, Y).
reachable(X, Z) :- reachable(X, Y), edge(Y, Z).

% æŸ¥è¯¢: ?- reachable(a, Z).

% Magic Setsè½¬æ¢
magic_reachable(a).
magic_reachable(Y) :- magic_reachable(X), edge(X, Y).

reachable(X, Y) :- magic_reachable(X), edge(X, Y).
reachable(X, Z) :- magic_reachable(X), reachable(X, Y), edge(Y, Z).
```

**æ•ˆæœ**ï¼š

```text
åŸå§‹: è®¡ç®—æ‰€æœ‰å¯è¾¾æ€§
ä¼˜åŒ–: åªè®¡ç®—ä»aå‡ºå‘çš„å¯è¾¾æ€§
```

### 8.2 åŠæœ´ç´ æ±‚å€¼ï¼ˆSemi-Naive Evaluationï¼‰

**æ€æƒ³**ï¼šåªå¤„ç†æ–°æ´¾ç”Ÿçš„äº‹å®

**ç®—æ³•**ï¼š

```text
Î”â‚€ = EDB
for i = 1, 2, ... do
    Î”áµ¢ = T_P(I_{i-1}) - I_{i-1}  // åªè®¡ç®—æ–°äº‹å®
    I_i = I_{i-1} âˆª Î”áµ¢
    if Î”áµ¢ = âˆ… then return Iáµ¢
```

**ä¼˜åŠ¿**ï¼š

```text
æœ´ç´ æ±‚å€¼: æ¯è½®é‡æ–°è®¡ç®—æ‰€æœ‰äº‹å®
åŠæœ´ç´ : æ¯è½®åªè®¡ç®—æ–°äº‹å®

æ€§èƒ½æå‡: é€šå¸¸2-10x
```

---

## 9. å®è·µåº”ç”¨

### 9.1 å›¾æŸ¥è¯¢

**ä¼ é€’é—­åŒ…**ï¼š

```datalog
% è¾¹
edge(a, b).
edge(b, c).
edge(c, d).

% å¯è¾¾æ€§
path(X, Y) :- edge(X, Y).
path(X, Z) :- path(X, Y), edge(Y, Z).

% æŸ¥è¯¢: ä»aå¯è¾¾å“ªäº›èŠ‚ç‚¹ï¼Ÿ
?- path(a, Z).
% ç»“æœ: Z âˆˆ {b, c, d}
```

**Regoå®ç°**ï¼š

```rego
package graph

edges := {
    "a": ["b"],
    "b": ["c"],
    "c": ["d"]
}

reachable[node] if {
    start := "a"
    walk_graph(start, node)
}

walk_graph(current, dest) if {
    dest in edges[current]
}

walk_graph(current, dest) if {
    next in edges[current]
    walk_graph(next, dest)
}
```

### 9.2 å…³ç³»ä»£æ•°

**SQLåˆ°Datalog**ï¼š

```sql
-- SQL
SELECT u.name
FROM users u, roles r
WHERE u.role_id = r.id
  AND r.name = 'admin'
```

**Datalog**ï¼š

```datalog
result(Name) :-
    users(Name, RoleId),
    roles(RoleId, "admin").
```

---

## 10. ç†è®ºæ„ä¹‰

### 10.1 ä¸ºä»€ä¹ˆç ”ç©¶Datalogï¼Ÿ

```text
1. ç†è®ºä¼˜é›…
   â””â”€â”€ ç®€æ´çš„è¯­æ³•å’Œè¯­ä¹‰

2. å¯åˆ¤å®šæ€§
   â””â”€â”€ ä¿è¯æŸ¥è¯¢ç»ˆæ­¢

3. ä¼˜åŒ–ç†è®ºæˆç†Ÿ
   â””â”€â”€ æ•°åå¹´ç ”ç©¶ç§¯ç´¯

4. å®è·µåº”ç”¨å¹¿æ³›
   â””â”€â”€ æ•°æ®åº“ã€é™æ€åˆ†æã€ç­–ç•¥è¯­è¨€
```

### 10.2 å¯¹Regoçš„å½±å“

```text
1. è¯­ä¹‰åŸºç¡€
   â””â”€â”€ Regoçš„å½¢å¼åŒ–è¯­ä¹‰åŸºäºDatalog

2. æŸ¥è¯¢ç­–ç•¥
   â””â”€â”€ Top-Downæ±‚å€¼å€Ÿé‰´Prolog/Datalog

3. ä¼˜åŒ–æŠ€æœ¯
   â””â”€â”€ ç´¢å¼•ã€Magic Setsç­‰

4. å®‰å…¨æ€§ä¿è¯
   â””â”€â”€ åˆ†å±‚å¦å®šç¡®ä¿ç»ˆæ­¢æ€§
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [Regoå½¢å¼åŒ–è¯­ä¹‰](./06.2-Regoå½¢å¼åŒ–è¯­ä¹‰.md)
- [Top-Downæ±‚å€¼å™¨](../03-å®ç°æ¶æ„/03.4-Top-Downæ±‚å€¼å™¨.md)

**å‚è€ƒæ–‡çŒ®**ï¼š

- Abiteboul, S., Hull, R., Vianu, V. (1995). *Foundations of Databases*
- Ullman, J. D. (1989). *Principles of Database and Knowledge-Base Systems*
- Ceri, S., Gottlob, G., Tanca, L. (1989). *What You Always Wanted to Know About Datalog (And Never Dared to Ask)*
