# ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–

> **æ–‡æ¡£ç±»å‹**: å½¢å¼åŒ–ç±»å‹ç†è®º  
> **ç†è®ºé¢†åŸŸ**: ç±»å‹ç³»ç»Ÿã€ç±»å‹å®‰å…¨æ€§ã€ç¨‹åºéªŒè¯  
> **é€‚ç”¨è¯»è€…**: ç¼–ç¨‹è¯­è¨€ç ”ç©¶è€…ã€ç±»å‹ç³»ç»Ÿè®¾è®¡è€…ã€é«˜çº§å¼€å‘è€…  
> **å…ˆä¿®çŸ¥è¯†**: [ä¸€é˜¶é€»è¾‘](06.3-å‘½é¢˜é€»è¾‘ä¸ä¸€é˜¶é€»è¾‘åŸºç¡€.md)ã€[Regoç±»å‹ç³»ç»Ÿ](../02-è¯­è¨€æ¨¡å‹/02.2-ç±»å‹ç³»ç»Ÿ.md)  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 1.1 - ç±»å‹ç†è®º

---

## ğŸ“ ç±»å‹ç³»ç»Ÿç†è®ºæ¡†æ¶

> **æœ¬æ–‡æ¡£ç›®æ ‡**:
>
> - âœ… å½¢å¼åŒ–å®šä¹‰Regoçš„ç±»å‹ç³»ç»Ÿ
> - âœ… è¯æ˜ç±»å‹ç³»ç»Ÿçš„å¥å…¨æ€§ï¼ˆSoundnessï¼‰
> - âœ… è¯æ˜ç±»å‹å®‰å…¨æ€§ï¼ˆType Safetyï¼‰
> - âœ… å»ºç«‹ç±»å‹æ¨å¯¼çš„æ•°å­¦åŸºç¡€
> - âœ… ä¸ºç±»å‹æ£€æŸ¥å™¨æä¾›ç†è®ºä¿è¯
>
> **æ ¸å¿ƒå®šç†**:
>
> - **Progress**: è‰¯ç±»å‹çš„è¡¨è¾¾å¼è¦ä¹ˆæ˜¯å€¼ï¼Œè¦ä¹ˆå¯ä»¥ç»§ç»­æ±‚å€¼
> - **Preservation**: æ±‚å€¼ä¿æŒç±»å‹
> - **Type Safety**: è‰¯ç±»å‹çš„ç¨‹åºä¸ä¼š"å¡ä½"ï¼ˆstuckï¼‰
>
> **å®é™…ä»·å€¼**:
>
> - é™æ€ä¿è¯ç±»å‹é”™è¯¯ä¸ä¼šåœ¨è¿è¡Œæ—¶å‘ç”Ÿ
> - ä¸ºç±»å‹æ£€æŸ¥å™¨æä¾›æ­£ç¡®æ€§ä¾æ®
> - æ”¯æŒç±»å‹æ¨å¯¼å’Œç±»å‹é‡æ„
> - ä¼˜åŒ–ç¼–è¯‘å™¨ç”Ÿæˆä»£ç 

---

## ç›®å½•

- [ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–](#ç±»å‹ç³»ç»Ÿå½¢å¼åŒ–)
  - [ğŸ“ ç±»å‹ç³»ç»Ÿç†è®ºæ¡†æ¶](#-ç±»å‹ç³»ç»Ÿç†è®ºæ¡†æ¶)
  - [ç›®å½•](#ç›®å½•)
  - [1. ç±»å‹ç³»ç»ŸåŸºç¡€](#1-ç±»å‹ç³»ç»ŸåŸºç¡€)
    - [1.1 ç±»å‹çš„å®šä¹‰](#11-ç±»å‹çš„å®šä¹‰)
      - [1.1.1 ç±»å‹è¯­æ³•](#111-ç±»å‹è¯­æ³•)
      - [1.1.2 ç±»å‹çš„æ€§è´¨](#112-ç±»å‹çš„æ€§è´¨)
    - [1.2 ç±»å‹ç¯å¢ƒ](#12-ç±»å‹ç¯å¢ƒ)
    - [1.3 å­ç±»å‹å…³ç³»](#13-å­ç±»å‹å…³ç³»)
  - [2. ç±»å‹æ¨å¯¼è§„åˆ™](#2-ç±»å‹æ¨å¯¼è§„åˆ™)
    - [2.1 åŸºæœ¬å€¼ç±»å‹](#21-åŸºæœ¬å€¼ç±»å‹)
    - [2.2 å¤åˆç±»å‹](#22-å¤åˆç±»å‹)
      - [2.2.1 æ•°ç»„ç±»å‹](#221-æ•°ç»„ç±»å‹)
      - [2.2.2 å¯¹è±¡ç±»å‹](#222-å¯¹è±¡ç±»å‹)
      - [2.2.3 é›†åˆç±»å‹](#223-é›†åˆç±»å‹)
    - [2.3 å‡½æ•°ç±»å‹](#23-å‡½æ•°ç±»å‹)
    - [2.4 è§„åˆ™ç±»å‹](#24-è§„åˆ™ç±»å‹)
  - [3. ç±»å‹ç³»ç»Ÿçš„å¥å…¨æ€§](#3-ç±»å‹ç³»ç»Ÿçš„å¥å…¨æ€§)
    - [3.1 Progresså®šç†](#31-progresså®šç†)
    - [3.2 Preservationå®šç†](#32-preservationå®šç†)
    - [3.3 Type Safetyå®šç†](#33-type-safetyå®šç†)
  - [4. ç±»å‹æ¨å¯¼ç®—æ³•](#4-ç±»å‹æ¨å¯¼ç®—æ³•)
    - [4.1 Algorithm W](#41-algorithm-w)
    - [4.2 çº¦æŸç”Ÿæˆä¸æ±‚è§£](#42-çº¦æŸç”Ÿæˆä¸æ±‚è§£)
    - [4.3 ä¸»ç±»å‹å®šç†](#43-ä¸»ç±»å‹å®šç†)
  - [5. ç»“æ„ç±»å‹ä¸é¸­å­ç±»å‹](#5-ç»“æ„ç±»å‹ä¸é¸­å­ç±»å‹)
    - [5.1 ç»“æ„ç­‰ä»·æ€§](#51-ç»“æ„ç­‰ä»·æ€§)
    - [5.2 ä¸åä¹‰ç±»å‹çš„å¯¹æ¯”](#52-ä¸åä¹‰ç±»å‹çš„å¯¹æ¯”)
    - [5.3 Regoçš„ç»“æ„ç±»å‹è¯­ä¹‰](#53-regoçš„ç»“æ„ç±»å‹è¯­ä¹‰)
  - [6. å¤šæ€æ€§](#6-å¤šæ€æ€§)
    - [6.1 å‚æ•°å¤šæ€](#61-å‚æ•°å¤šæ€)
    - [6.2 ç±»å‹å˜é‡å®ä¾‹åŒ–](#62-ç±»å‹å˜é‡å®ä¾‹åŒ–)
    - [6.3 Let-å¤šæ€](#63-let-å¤šæ€)
  - [7. ä¸Regoçš„æ˜ å°„](#7-ä¸regoçš„æ˜ å°„)
    - [7.1 Regoç±»å‹åˆ°å½¢å¼åŒ–ç±»å‹](#71-regoç±»å‹åˆ°å½¢å¼åŒ–ç±»å‹)
    - [7.2 ç±»å‹æ£€æŸ¥å®ç°](#72-ç±»å‹æ£€æŸ¥å®ç°)
    - [7.3 ç±»å‹é”™è¯¯å¤„ç†](#73-ç±»å‹é”™è¯¯å¤„ç†)
  - [é™„å½•](#é™„å½•)
    - [A. ç±»å‹ç†è®ºæœ¯è¯­å¯¹ç…§](#a-ç±»å‹ç†è®ºæœ¯è¯­å¯¹ç…§)
    - [B. é‡è¦å®šç†é€ŸæŸ¥](#b-é‡è¦å®šç†é€ŸæŸ¥)
    - [C. å‚è€ƒæ–‡çŒ®](#c-å‚è€ƒæ–‡çŒ®)

---

## 1. ç±»å‹ç³»ç»ŸåŸºç¡€

### 1.1 ç±»å‹çš„å®šä¹‰

#### 1.1.1 ç±»å‹è¯­æ³•

**å®šä¹‰ 1.1** (ç±»å‹ Type)

ç±»å‹çš„å½’çº³å®šä¹‰ï¼š

```haskell
Ï„ ::= Bool                    -- å¸ƒå°”ç±»å‹
    | Number                  -- æ•°å€¼ç±»å‹
    | String                  -- å­—ç¬¦ä¸²ç±»å‹
    | Null                    -- ç©ºç±»å‹
    | Array(Ï„)                -- æ•°ç»„ç±»å‹
    | Object(Ï„â‚, Ï„â‚‚)          -- å¯¹è±¡ç±»å‹ (é”®â†’å€¼)
    | Set(Ï„)                  -- é›†åˆç±»å‹
    | Ï„â‚ â†’ Ï„â‚‚                 -- å‡½æ•°ç±»å‹
    | Î±                       -- ç±»å‹å˜é‡
    | âˆ€Î±. Ï„                   -- å…¨ç§°é‡åŒ–ç±»å‹
    | âŠ¥                       -- åº•ç±»å‹ (never)
    | âŠ¤                       -- é¡¶ç±»å‹ (any)
```

**Regoç±»å‹å¯¹åº”**:

| Rego | å½¢å¼åŒ–ç±»å‹ | ç¤ºä¾‹ |
|------|-----------|------|
| `boolean` | Bool | `true`, `false` |
| `number` | Number | `42`, `3.14` |
| `string` | String | `"admin"` |
| `null` | Null | `null` |
| `array` | Array(Ï„) | `[1, 2, 3]` : Array(Number) |
| `object` | Object(String, Ï„) | `{"a": 1}` : Object(String, Number) |
| `set` | Set(Ï„) | `{1, 2, 3}` : Set(Number) |

#### 1.1.2 ç±»å‹çš„æ€§è´¨

**å®šä¹‰ 1.2** (ç±»å‹å¤§å°)

ç±»å‹ Ï„ çš„å¤§å° |Ï„| å®šä¹‰ä¸ºï¼š

```text
|Bool| = |Number| = |String| = |Null| = 1
|Array(Ï„)| = 1 + |Ï„|
|Object(Ï„â‚,Ï„â‚‚)| = 1 + |Ï„â‚| + |Ï„â‚‚|
|Set(Ï„)| = 1 + |Ï„|
|Ï„â‚ â†’ Ï„â‚‚| = 1 + |Ï„â‚| + |Ï„â‚‚|
|âˆ€Î±. Ï„| = 1 + |Ï„|
```

**å®šä¹‰ 1.3** (è‡ªç”±ç±»å‹å˜é‡)

ç±»å‹ Ï„ ä¸­çš„è‡ªç”±ç±»å‹å˜é‡ FTV(Ï„)ï¼š

```text
FTV(Bool) = FTV(Number) = FTV(String) = FTV(Null) = âˆ…
FTV(Array(Ï„)) = FTV(Ï„)
FTV(Object(Ï„â‚,Ï„â‚‚)) = FTV(Ï„â‚) âˆª FTV(Ï„â‚‚)
FTV(Set(Ï„)) = FTV(Ï„)
FTV(Ï„â‚ â†’ Ï„â‚‚) = FTV(Ï„â‚) âˆª FTV(Ï„â‚‚)
FTV(Î±) = {Î±}
FTV(âˆ€Î±. Ï„) = FTV(Ï„) \ {Î±}
```

### 1.2 ç±»å‹ç¯å¢ƒ

**å®šä¹‰ 1.4** (ç±»å‹ç¯å¢ƒ Type Environment)

ç±»å‹ç¯å¢ƒ Î“ æ˜¯ä»å˜é‡åˆ°ç±»å‹çš„æœ‰é™æ˜ å°„ï¼š

```text
Î“ ::= âˆ…                       -- ç©ºç¯å¢ƒ
    | Î“, x : Ï„                -- æ‰©å±•ç¯å¢ƒ
```

**æ“ä½œ**:

```text
dom(Î“): ç¯å¢ƒçš„å®šä¹‰åŸŸï¼ˆå˜é‡é›†åˆï¼‰
Î“(x): æŸ¥æ‰¾å˜é‡xçš„ç±»å‹
Î“[x â†¦ Ï„]: æ›´æ–°/æ·»åŠ ç»‘å®š
```

**ç¤ºä¾‹**:

```text
Î“ = {
  input : Object(String, âŠ¤),
  user : Object(String, String),
  count : Number â†’ Number
}

Î“(user) = Object(String, String)
Î“[admin : Bool] = Î“ âˆª {admin : Bool}
```

### 1.3 å­ç±»å‹å…³ç³»

**å®šä¹‰ 1.5** (å­ç±»å‹å…³ç³» <:)

å­ç±»å‹å…³ç³» Ï„ <: Ïƒ è¡¨ç¤º Ï„ æ˜¯ Ïƒ çš„å­ç±»å‹ã€‚

**å…¬ç†**:

```text
(S-Refl)   Ï„ <: Ï„

(S-Trans)  Ï„ <: Ïƒ    Ïƒ <: Ï
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               Ï„ <: Ï

(S-Bot)    âŠ¥ <: Ï„

(S-Top)    Ï„ <: âŠ¤
```

**ç»“æ„è§„åˆ™**:

```text
(S-Array)  Ï„ <: Ïƒ
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Array(Ï„) <: Array(Ïƒ)

(S-Set)    Ï„ <: Ïƒ
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Set(Ï„) <: Set(Ïƒ)

(S-Object) Ï„â‚ <: Ïƒâ‚    Ï„â‚‚ <: Ïƒâ‚‚
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Object(Ï„â‚,Ï„â‚‚) <: Object(Ïƒâ‚,Ïƒâ‚‚)

(S-Fun)    Ïƒâ‚ <: Ï„â‚    Ï„â‚‚ <: Ïƒâ‚‚
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  -- é€†å˜+åå˜
           Ï„â‚ â†’ Ï„â‚‚ <: Ïƒâ‚ â†’ Ïƒâ‚‚
```

**ç¤ºä¾‹**:

```text
Array(Number) <: Array(âŠ¤)
Set(String) <: Set(âŠ¤)
âŠ¥ â†’ âŠ¤ <: Number â†’ Number  -- å‡½æ•°æ˜¯æœ€å®½æ³›çš„
```

---

## 2. ç±»å‹æ¨å¯¼è§„åˆ™

### 2.1 åŸºæœ¬å€¼ç±»å‹

**ç±»å‹åˆ¤æ–­** çš„å½¢å¼ï¼š

```text
Î“ âŠ¢ e : Ï„

è¯»ä½œï¼šåœ¨ç±»å‹ç¯å¢ƒ Î“ ä¸‹ï¼Œè¡¨è¾¾å¼ e å…·æœ‰ç±»å‹ Ï„
```

**åŸºæœ¬è§„åˆ™**:

```text
(T-True)   
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ true : Bool

(T-False)  
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ false : Bool

(T-Num)    
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ n : Number

(T-Str)    
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ "s" : String

(T-Null)   
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ null : Null

(T-Var)    x : Ï„ âˆˆ Î“
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ x : Ï„
```

**ç¤ºä¾‹æ¨å¯¼**:

```text
Î“ = {x : Number}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  (T-Num)
Î“ âŠ¢ 42 : Number

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  (T-Var, xâˆˆÎ“)
Î“ âŠ¢ x : Number
```

### 2.2 å¤åˆç±»å‹

#### 2.2.1 æ•°ç»„ç±»å‹

```text
(T-Array)  Î“ âŠ¢ eâ‚ : Ï„    Î“ âŠ¢ eâ‚‚ : Ï„    ...    Î“ âŠ¢ eâ‚™ : Ï„
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ [eâ‚, eâ‚‚, ..., eâ‚™] : Array(Ï„)

(T-ArrayEmpty)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ [] : Array(Î±)     -- å¤šæ€ç©ºæ•°ç»„
```

**ç¤ºä¾‹**:

```text
Î“ âŠ¢ 1 : Number    Î“ âŠ¢ 2 : Number    Î“ âŠ¢ 3 : Number
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Array)
Î“ âŠ¢ [1, 2, 3] : Array(Number)
```

#### 2.2.2 å¯¹è±¡ç±»å‹

```text
(T-Object) Î“ âŠ¢ kâ‚ : String  ...  Î“ âŠ¢ kâ‚™ : String
           Î“ âŠ¢ vâ‚ : Ï„â‚      ...  Î“ âŠ¢ vâ‚™ : Ï„â‚™
           Ï„ = Ï„â‚ âŠ” Ï„â‚‚ âŠ” ... âŠ” Ï„â‚™           -- æœ€å°ä¸Šç•Œ
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ {kâ‚: vâ‚, ..., kâ‚™: vâ‚™} : Object(String, Ï„)

(T-ObjectEmpty)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ {} : Object(String, Î±)
```

**ç¤ºä¾‹**:

```text
Î“ âŠ¢ "name" : String    Î“ âŠ¢ "Alice" : String
Î“ âŠ¢ "age" : String     Î“ âŠ¢ 30 : Number
Ï„ = String âŠ” Number = âŠ¤
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-Object)
Î“ âŠ¢ {"name": "Alice", "age": 30} : Object(String, âŠ¤)
```

#### 2.2.3 é›†åˆç±»å‹

```text
(T-Set)    Î“ âŠ¢ eâ‚ : Ï„    Î“ âŠ¢ eâ‚‚ : Ï„    ...    Î“ âŠ¢ eâ‚™ : Ï„
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ {eâ‚, eâ‚‚, ..., eâ‚™} : Set(Ï„)

(T-SetEmpty)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ {} : Set(Î±)   -- åŒºåˆ«äºç©ºå¯¹è±¡éœ€è¦ä¸Šä¸‹æ–‡
```

### 2.3 å‡½æ•°ç±»å‹

**å†…ç½®å‡½æ•°ç±»å‹**:

```text
(T-BuiltinFun)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ count : Array(Î±) â†’ Number

           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ concat : String â†’ String â†’ String

           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ contains : String â†’ String â†’ Bool
```

**å‡½æ•°åº”ç”¨**:

```text
(T-App)    Î“ âŠ¢ f : Ï„â‚ â†’ Ï„â‚‚    Î“ âŠ¢ e : Ï„â‚
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ f(e) : Ï„â‚‚
```

**ç¤ºä¾‹**:

```text
Î“ âŠ¢ count : Array(Î±) â†’ Number
Î“ âŠ¢ [1, 2, 3] : Array(Number)
Number <: Î±  (å®ä¾‹åŒ–)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-App)
Î“ âŠ¢ count([1, 2, 3]) : Number
```

### 2.4 è§„åˆ™ç±»å‹

**Regoè§„åˆ™çš„ç±»å‹**:

```text
(T-Rule)   Î“, xâ‚ : Ï„â‚, ..., xâ‚™ : Ï„â‚™ âŠ¢ body : Bool
           Î“ âŠ¢ head : Ï„
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ (head if body) : Ï„

(T-RuleDefault)
           Î“ âŠ¢ v : Ï„
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ (default name = v) : Ï„
```

**ç¤ºä¾‹**:

```rego
# allow if input.admin == true
#
# ç±»å‹æ¨å¯¼:
#   input : Object(String, âŠ¤)
#   input.admin : âŠ¤
#   true : Bool
#   input.admin == true : Bool  (éœ€è¦éšå¼è½¬æ¢)
#   allow : Bool
```

---

## 3. ç±»å‹ç³»ç»Ÿçš„å¥å…¨æ€§

### 3.1 Progresså®šç†

**å®šç† 3.1** (Progress)

å¦‚æœ âˆ… âŠ¢ e : Ï„ï¼ˆå°é—­è‰¯ç±»å‹è¡¨è¾¾å¼ï¼‰ï¼Œåˆ™ï¼š

1. e æ˜¯å€¼ï¼ˆvalueï¼‰ï¼Œæˆ–è€…
2. å­˜åœ¨ e' ä½¿å¾— e â†’ e'ï¼ˆå¯ä»¥æ±‚å€¼ä¸€æ­¥ï¼‰

**è¯æ˜** (å¯¹ç±»å‹æ¨å¯¼å½’çº³):

**æƒ…å†µ1: e = v** (å€¼)

```text
v åŒ…æ‹¬: true, false, n, "s", null, [], {}, [vâ‚,...,vâ‚™], ...
ç›´æ¥æ»¡è¶³æ¡ä»¶1  âœ“
```

**æƒ…å†µ2: e = x** (å˜é‡)

```text
Î“ = âˆ… (å°é—­)
x : Ï„ âˆˆ âˆ…  çŸ›ç›¾ï¼
ä¸å¯èƒ½æ˜¯å°é—­è¡¨è¾¾å¼ä¸­çš„è‡ªç”±å˜é‡
```

**æƒ…å†µ3: e = f(eâ‚)**:

```text
å­æƒ…å†µ3.1: eâ‚ ä¸æ˜¯å€¼
  ç”±å½’çº³å‡è®¾: eâ‚ â†’ eâ‚'
  å› æ­¤: f(eâ‚) â†’ f(eâ‚')  âœ“  (æ»¡è¶³æ¡ä»¶2)

å­æƒ…å†µ3.2: eâ‚ = v (å€¼)
  f æ˜¯å†…ç½®å‡½æ•°
  å­˜åœ¨ Î´(f, v) = v'  (deltaè§„åˆ™)
  å› æ­¤: f(v) â†’ v'  âœ“  (æ»¡è¶³æ¡ä»¶2)
```

**æƒ…å†µ4: e = eâ‚[eâ‚‚]** (ç´¢å¼•)

```text
ç±»ä¼¼åˆ†æ
```

**ç»“è®º**: æ‰€æœ‰æƒ…å†µéƒ½æ»¡è¶³Progress  âœ“

### 3.2 Preservationå®šç†

**å®šç† 3.2** (Preservation/Subject Reduction)

å¦‚æœ Î“ âŠ¢ e : Ï„ ä¸” e â†’ e'ï¼Œåˆ™ Î“ âŠ¢ e' : Ï„ã€‚

**å¼•ç† 3.1** (Substitution Lemma)

å¦‚æœ Î“, x : Ïƒ âŠ¢ e : Ï„ ä¸” Î“ âŠ¢ v : Ïƒï¼Œåˆ™ Î“ âŠ¢ e[x â†¦ v] : Ï„ã€‚

**è¯æ˜** (å¯¹ e çš„ç»“æ„å½’çº³):

**æƒ…å†µ1: e = x**:

```text
Î“, x:Ïƒ âŠ¢ x : Ïƒ     (T-Var)
Î“ âŠ¢ v : Ïƒ          (å‰æ)
e[xâ†¦v] = v
å› æ­¤: Î“ âŠ¢ v : Ïƒ = Ï„  âœ“
```

**æƒ…å†µ2: e = y** (y â‰  x)

```text
Î“, x:Ïƒ âŠ¢ y : Ï„     (y:Ï„ âˆˆ Î“)
e[xâ†¦v] = y
å› æ­¤: Î“ âŠ¢ y : Ï„  âœ“
```

**æƒ…å†µ3: e = f(eâ‚)**:

```text
Î“, x:Ïƒ âŠ¢ f(eâ‚) : Ï„â‚‚
  ç”±(T-App): Î“, x:Ïƒ âŠ¢ f : Ï„â‚â†’Ï„â‚‚
            Î“, x:Ïƒ âŠ¢ eâ‚ : Ï„â‚

å½’çº³å‡è®¾: Î“ âŠ¢ eâ‚[xâ†¦v] : Ï„â‚

å› æ­¤: f(eâ‚)[xâ†¦v] = f(eâ‚[xâ†¦v])
     Î“ âŠ¢ f : Ï„â‚â†’Ï„â‚‚
     Î“ âŠ¢ eâ‚[xâ†¦v] : Ï„â‚
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (T-App)
     Î“ âŠ¢ f(eâ‚[xâ†¦v]) : Ï„â‚‚  âœ“
```

**å®šç†3.2è¯æ˜** (å¯¹æ±‚å€¼è§„åˆ™å½’çº³):

**è§„åˆ™: (E-App)**:

```text
f(v) â†’ Î´(f, v)

å‰æ: Î“ âŠ¢ f(v) : Ï„
  ç”±(T-App): Î“ âŠ¢ f : Ïƒâ†’Ï„
            Î“ âŠ¢ v : Ïƒ

Î´(f, v) å®šä¹‰è‰¯å¥½ï¼ˆå†…ç½®å‡½æ•°ç±»å‹æ­£ç¡®ï¼‰
å› æ­¤: Î“ âŠ¢ Î´(f, v) : Ï„  âœ“
```

**è§„åˆ™: (E-Context)**:

```text
e â†’ e'  âŸ¹  C[e] â†’ C[e']

å‰æ: Î“ âŠ¢ C[e] : Ï„
å½’çº³å‡è®¾: Î“ âŠ¢ e' : Ïƒ

ç”±ç±»å‹è§„åˆ™: Î“ âŠ¢ C[e'] : Ï„  âœ“
```

**ç»“è®º**: Preservationæˆç«‹  âœ“

### 3.3 Type Safetyå®šç†

**å®šç† 3.3** (Type Safety)

è‰¯ç±»å‹çš„å°é—­è¡¨è¾¾å¼ä¸ä¼šå¡ä½ï¼ˆstuckï¼‰ã€‚

**å®šä¹‰ 3.1** (å¡ä½ Stuck)

è¡¨è¾¾å¼ e å¡ä½ï¼Œå¦‚æœï¼š

1. e ä¸æ˜¯å€¼
2. ä¸å­˜åœ¨ e' ä½¿å¾— e â†’ e'

**è¯æ˜**:

```text
è®¾ âˆ… âŠ¢ e : Ï„ (è‰¯ç±»å‹å°é—­è¡¨è¾¾å¼)
å‡è®¾ e å¡ä½

ç”±Progress: e æ˜¯å€¼æˆ–å¯ä»¥æ±‚å€¼
ç”±å‡è®¾: e ä¸æ˜¯å€¼ä¸”ä¸èƒ½æ±‚å€¼
çŸ›ç›¾ï¼

å› æ­¤: è‰¯ç±»å‹è¡¨è¾¾å¼ä¸ä¼šå¡ä½  âœ“
```

**æ¨è®º 3.1**:

```text
å¦‚æœ âˆ… âŠ¢ e : Ï„ï¼Œåˆ™:
  è¦ä¹ˆ e åœ¨æœ‰é™æ­¥åæ±‚å€¼åˆ°å€¼ v
  è¦ä¹ˆ e æ— é™æ±‚å€¼ï¼ˆå‘æ•£ï¼‰
  ä½†ä¸ä¼šå› ç±»å‹é”™è¯¯è€Œå¡ä½
```

---

## 4. ç±»å‹æ¨å¯¼ç®—æ³•

### 4.1 Algorithm W

**Hindley-Milnerç±»å‹æ¨å¯¼**:

```python
def infer(env, expr):
    """Algorithm W: ç±»å‹æ¨å¯¼"""
    match expr:
        case Var(x):
            if x not in env:
                raise TypeError(f"Unbound variable: {x}")
            return instantiate(env[x])
        
        case Num(n):
            return Number
        
        case Bool(b):
            return Bool
        
        case App(f, arg):
            tf = infer(env, f)
            targ = infer(env, arg)
            tret = fresh_var()
            unify(tf, Arrow(targ, tret))
            return tret
        
        case Lambda(x, body):
            tx = fresh_var()
            tbody = infer(env.extend(x, tx), body)
            return Arrow(tx, tbody)
        
        case Let(x, e1, e2):
            t1 = infer(env, e1)
            t1_gen = generalize(env, t1)
            return infer(env.extend(x, t1_gen), e2)
```

**ç±»å‹å˜é‡ç»Ÿä¸€**:

```python
def unify(t1, t2):
    """ç»Ÿä¸€ä¸¤ä¸ªç±»å‹"""
    t1 = deref(t1)
    t2 = deref(t2)
    
    if t1 == t2:
        return
    
    if isinstance(t1, TypeVar):
        if occurs(t1, t2):
            raise TypeError("Infinite type")
        bind(t1, t2)
        return
    
    if isinstance(t2, TypeVar):
        unify(t2, t1)
        return
    
    if isinstance(t1, Arrow) and isinstance(t2, Arrow):
        unify(t1.arg, t2.arg)
        unify(t1.ret, t2.ret)
        return
    
    raise TypeError(f"Cannot unify {t1} with {t2}")
```

### 4.2 çº¦æŸç”Ÿæˆä¸æ±‚è§£

**ä¸¤é˜¶æ®µç±»å‹æ£€æŸ¥**:

**é˜¶æ®µ1: çº¦æŸç”Ÿæˆ**:

```text
C = âˆ…  (çº¦æŸé›†åˆ)

æ¨å¯¼ Î“ âŠ¢ e : Ï„ æ—¶ç”Ÿæˆçº¦æŸ:
  C = C âˆª {Ï„â‚ = Ï„â‚‚}
```

**é˜¶æ®µ2: çº¦æŸæ±‚è§£**:

```text
solve(C):
  for (Ï„â‚ = Ï„â‚‚) in C:
    Î¸ = unify(Ï„â‚, Ï„â‚‚)
    C = CÎ¸
  return Î¸
```

**ç¤ºä¾‹**:

```rego
# count(input.users) > 10

# çº¦æŸç”Ÿæˆ:
Câ‚: input : Î±â‚
Câ‚‚: input.users : Î±â‚‚
Câ‚ƒ: count : Array(Î²) â†’ Number
Câ‚„: Î±â‚‚ = Array(Î²)
Câ‚…: count(input.users) : Number
Câ‚†: 10 : Number
Câ‚‡: Number > Number : Bool

# çº¦æŸæ±‚è§£:
Î¸ = {Î±â‚‚ â†¦ Array(Î²), Î±â‚ â†¦ Object(String, Array(Î²)), ...}
```

### 4.3 ä¸»ç±»å‹å®šç†

**å®šç† 4.1** (Principal Type)

å¦‚æœè¡¨è¾¾å¼ e å¯ç±»å‹åŒ–ï¼Œåˆ™å­˜åœ¨ä¸»ç±»å‹ï¼ˆprincipal typeï¼‰Ï„ï¼Œä½¿å¾—ï¼š

1. Î“ âŠ¢ e : Ï„
2. å¯¹ä»»ä½• Î“ âŠ¢ e : Ïƒï¼Œå­˜åœ¨æ›¿æ¢ Î¸ ä½¿å¾— Ïƒ = Ï„Î¸

**è¯æ˜**: Algorithm W è®¡ç®—ä¸»ç±»å‹  âœ“

---

## 5. ç»“æ„ç±»å‹ä¸é¸­å­ç±»å‹

### 5.1 ç»“æ„ç­‰ä»·æ€§

**å®šä¹‰ 5.1** (ç»“æ„ç­‰ä»·)

ä¸¤ä¸ªç±»å‹ç»“æ„ç­‰ä»·ï¼Œè®°ä½œ Ï„ â‰… Ïƒï¼Œå¦‚æœå®ƒä»¬çš„ç»“æ„ç›¸åŒï¼ˆå¿½ç•¥åç§°ï¼‰ã€‚

**Regoé‡‡ç”¨ç»“æ„ç±»å‹**:

```rego
# ç±»å‹ç”±ç»“æ„å†³å®šï¼Œè€Œéåç§°
user1 = {"name": "Alice", "age": 30}
user2 = {"name": "Bob", "age": 25}

# user1 å’Œ user2 å…·æœ‰ç›¸åŒçš„ç»“æ„ç±»å‹:
# Object(String, String âŠ” Number)
```

### 5.2 ä¸åä¹‰ç±»å‹çš„å¯¹æ¯”

| ç‰¹æ€§ | ç»“æ„ç±»å‹ | åä¹‰ç±»å‹ |
|------|---------|---------|
| ç­‰ä»·æ€§ | ç»“æ„ç›¸åŒå³ç­‰ä»· | éœ€è¦æ˜¾å¼å£°æ˜ç»§æ‰¿ |
| çµæ´»æ€§ | é«˜ï¼ˆé¸­å­ç±»å‹ï¼‰ | ä½ï¼ˆä¸¥æ ¼å±‚æ¬¡ï¼‰ |
| å®‰å…¨æ€§ | è¾ƒä½ï¼ˆæ˜“æ··æ·†ï¼‰ | è¾ƒé«˜ï¼ˆæ˜¾å¼ç±»å‹ï¼‰ |
| é€‚ç”¨åœºæ™¯ | åŠ¨æ€è¯­è¨€ã€JSON | é™æ€è¯­è¨€ã€OOP |

**Regoé€‰æ‹©ç»“æ„ç±»å‹çš„åŸå› **:

1. JSONæ•°æ®è‡ªç„¶æ˜¯ç»“æ„åŒ–çš„
2. ç­–ç•¥ä»£ç éœ€è¦çµæ´»å¤„ç†ä¸åŒæ•°æ®æº
3. ä¸éœ€è¦é¢„å®šä¹‰ç±»å‹å±‚æ¬¡

### 5.3 Regoçš„ç»“æ„ç±»å‹è¯­ä¹‰

**å…¼å®¹æ€§åˆ¤æ–­**:

```text
Object(kâ‚, vâ‚) å…¼å®¹ Object(kâ‚‚, vâ‚‚) âŸº
  âˆ€key. (key âˆˆ dom(vâ‚) âŸ¹ 
         key âˆˆ dom(vâ‚‚) âˆ§ vâ‚(key) å…¼å®¹ vâ‚‚(key))
```

**ç¤ºä¾‹**:

```rego
# å…è®¸é¢å¤–å­—æ®µ
input = {"name": "Alice", "age": 30, "email": "alice@example.com"}

# åªéœ€è¦éƒ¨åˆ†å­—æ®µå³å¯åŒ¹é…
user = input
user.name == "Alice"  # âœ“
```

---

## 6. å¤šæ€æ€§

### 6.1 å‚æ•°å¤šæ€

**å®šä¹‰ 6.1** (å¤šæ€ç±»å‹)

```text
âˆ€Î±. Ï„  è¡¨ç¤ºå¯¹æ‰€æœ‰ç±»å‹ Î±ï¼Œç±»å‹ Ï„ æˆç«‹
```

**ç¤ºä¾‹**:

```text
identity : âˆ€Î±. Î± â†’ Î±
identity(x) = x

count : âˆ€Î±. Array(Î±) â†’ Number
```

### 6.2 ç±»å‹å˜é‡å®ä¾‹åŒ–

**è§„åˆ™**:

```text
(T-Inst)   Î“ âŠ¢ e : âˆ€Î±. Ï„
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ e : Ï„[Î± â†¦ Ïƒ]  (ä»»æ„ç±»å‹ Ïƒ)
```

**ç¤ºä¾‹**:

```text
count : âˆ€Î±. Array(Î±) â†’ Number

count : Array(Number) â†’ Number  (Î± â†¦ Number)
count : Array(String) â†’ Number  (Î± â†¦ String)
```

### 6.3 Let-å¤šæ€

**è§„åˆ™**:

```text
(T-Let)    Î“ âŠ¢ eâ‚ : Ï„â‚
           Î± = FTV(Ï„â‚) \ FTV(Î“)
           Î“, x : âˆ€Î±. Ï„â‚ âŠ¢ eâ‚‚ : Ï„â‚‚
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Î“ âŠ¢ let x = eâ‚ in eâ‚‚ : Ï„â‚‚
```

**Regoä¸æ”¯æŒæ˜¾å¼letï¼Œä½†è§„åˆ™ç»‘å®šç±»ä¼¼**:

```rego
# è§„åˆ™ç»‘å®šæ˜¯å¤šæ€çš„
nums = [1, 2, 3]    # âˆ€Î±. Array(Î±), å®ä¾‹åŒ–ä¸º Array(Number)
```

---

## 7. ä¸Regoçš„æ˜ å°„

### 7.1 Regoç±»å‹åˆ°å½¢å¼åŒ–ç±»å‹

**æ˜ å°„è¡¨**:

| Regoè¿è¡Œæ—¶ç±»å‹ | å½¢å¼åŒ–ç±»å‹ | ç±»å‹åˆ¤æ–­ |
|---------------|-----------|---------|
| `boolean` | Bool | `Î“ âŠ¢ true : Bool` |
| `number` | Number | `Î“ âŠ¢ 42 : Number` |
| `string` | String | `Î“ âŠ¢ "a" : String` |
| `null` | Null | `Î“ âŠ¢ null : Null` |
| `array` | Array(Ï„) | `Î“ âŠ¢ [eâ‚,...,eâ‚™] : Array(Ï„)` |
| `object` | Object(String, Ï„) | `Î“ âŠ¢ {k:v,...} : Object(String,Ï„)` |
| `set` | Set(Ï„) | `Î“ âŠ¢ {eâ‚,...,eâ‚™} : Set(Ï„)` |

### 7.2 ç±»å‹æ£€æŸ¥å®ç°

**ä¼ªä»£ç **:

```go
func TypeCheck(expr Expr, env TypeEnv) (Type, error) {
    switch e := expr.(type) {
    case *BoolLit:
        return BoolType, nil
    
    case *NumLit:
        return NumberType, nil
    
    case *StrLit:
        return StringType, nil
    
    case *ArrayLit:
        elemTypes := []Type{}
        for _, elem := range e.Elements {
            t, err := TypeCheck(elem, env)
            if err != nil {
                return nil, err
            }
            elemTypes = append(elemTypes, t)
        }
        unified := UnifyAll(elemTypes)
        return ArrayType{Elem: unified}, nil
    
    case *FuncCall:
        fType, err := TypeCheck(e.Func, env)
        if err != nil {
            return nil, err
        }
        argType, err := TypeCheck(e.Arg, env)
        if err != nil {
            return nil, err
        }
        
        arrow, ok := fType.(*ArrowType)
        if !ok {
            return nil, TypeError("Not a function")
        }
        
        if !Compatible(argType, arrow.Arg) {
            return nil, TypeError("Type mismatch")
        }
        
        return arrow.Ret, nil
    
    // ... å…¶ä»–æƒ…å†µ
    }
}
```

### 7.3 ç±»å‹é”™è¯¯å¤„ç†

**å¸¸è§ç±»å‹é”™è¯¯**:

```rego
# é”™è¯¯1: ç±»å‹ä¸åŒ¹é…
x = "hello"
y = x + 10  # é”™è¯¯: String + Number

# é”™è¯¯2: å­—æ®µä¸å­˜åœ¨
user = {"name": "Alice"}
age = user.age  # è­¦å‘Š/é”™è¯¯: å­—æ®µä¸å­˜åœ¨

# é”™è¯¯3: æ•°ç»„è¶Šç•Œ
arr = [1, 2, 3]
x = arr[10]  # è¿è¡Œæ—¶é”™è¯¯ï¼ˆé™æ€æ£€æŸ¥éš¾ä»¥å‘ç°ï¼‰

# é”™è¯¯4: ç±»å‹ä¸ä¸€è‡´
arr = [1, "two", 3]  # ç±»å‹: Array(Number âŠ” String)
sum = count(arr)     # âœ“ ä½†å¯èƒ½ä¸æ˜¯æœŸæœ›çš„
```

**ç±»å‹é”™è¯¯æ¶ˆæ¯**:

```text
TypeError: 
  Expression: x + 10
  Expected: Number
  Got: String
  Location: line 2, column 5
  
Suggestion: 
  Use to_number(x) to convert String to Number
```

---

## é™„å½•

### A. ç±»å‹ç†è®ºæœ¯è¯­å¯¹ç…§

| è‹±æ–‡ | ä¸­æ–‡ | è¯´æ˜ |
|------|------|------|
| Soundness | å¥å…¨æ€§ | ç±»å‹ç³»ç»Ÿä¸æ¥å—é”™è¯¯ç¨‹åº |
| Completeness | å®Œå¤‡æ€§ | ç±»å‹ç³»ç»Ÿæ¥å—æ‰€æœ‰æ­£ç¡®ç¨‹åº |
| Progress | è¿›å±•æ€§ | è‰¯ç±»å‹è¡¨è¾¾å¼å¯ç»§ç»­æ±‚å€¼ |
| Preservation | ä¿æŒæ€§ | æ±‚å€¼ä¿æŒç±»å‹ |
| Principal Type | ä¸»ç±»å‹ | æœ€ä¸€èˆ¬çš„ç±»å‹ |
| Subtyping | å­ç±»å‹ | ç±»å‹å±‚æ¬¡å…³ç³» |

### B. é‡è¦å®šç†é€ŸæŸ¥

1. **Progress**: è‰¯ç±»å‹è¡¨è¾¾å¼ä¸ä¼šå¡ä½
2. **Preservation**: æ±‚å€¼ä¿æŒç±»å‹
3. **Type Safety**: Progress + Preservation
4. **Principal Type**: å­˜åœ¨æœ€ä¸€èˆ¬ç±»å‹
5. **Substitution Lemma**: æ›¿æ¢ä¿æŒç±»å‹

### C. å‚è€ƒæ–‡çŒ®

1. **Pierce, B.C.** "Types and Programming Languages" (2002)
   - ç±»å‹ç³»ç»Ÿç†è®ºåœ£ç»
2. **Cardelli, L.** "Type Systems" (1996)
   - ç±»å‹ç³»ç»Ÿç»¼è¿°
3. **Milner, R.** "A Theory of Type Polymorphism in Programming" (1978)
   - Hindley-Milnerç±»å‹ç³»ç»Ÿ
4. **Wright, A.K., Felleisen, M.** "A Syntactic Approach to Type Soundness" (1994)
   - Progress + Preservationè¯æ˜æŠ€æœ¯
5. **Regoè¯­è¨€è§„èŒƒ** - <https://www.openpolicyagent.org/docs/latest/policy-language/>

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥  
**ç»´æŠ¤è€…**: OPAæŠ€æœ¯æ–‡æ¡£é¡¹ç›®  
**åé¦ˆ**: æ¬¢è¿é€šè¿‡GitHub Issuesæä¾›å»ºè®®

**ä¸‹ä¸€æ­¥é˜…è¯»**:

- [éƒ¨åˆ†æ±‚å€¼ç†è®º](06.6-éƒ¨åˆ†æ±‚å€¼ç†è®º.md) - ç‰¹åŒ–ä¸ä¼˜åŒ–çš„ç†è®ºåŸºç¡€
- [Regoç±»å‹ç³»ç»Ÿ](../02-è¯­è¨€æ¨¡å‹/02.2-ç±»å‹ç³»ç»Ÿ.md) - å®ç”¨ç±»å‹ç³»ç»ŸæŒ‡å—
- [ç±»å‹ç³»ç»Ÿå®ç°](../03-å®ç°æ¶æ„/03.3-ç¼–è¯‘å™¨è®¾è®¡.md) - ç±»å‹æ£€æŸ¥å™¨å®ç°
