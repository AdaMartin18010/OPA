# å¹¶å‘è¯­ä¹‰ä¸æ­£ç¡®æ€§

> **æ–‡æ¡£ç±»å‹**: å½¢å¼åŒ–å¹¶å‘ç†è®º  
> **ç†è®ºé¢†åŸŸ**: å¹¶å‘è¯­ä¹‰ã€åŒæ­¥æœºåˆ¶ã€æ­£ç¡®æ€§è¯æ˜  
> **é€‚ç”¨è¯»è€…**: å¹¶å‘ç³»ç»Ÿä¸“å®¶ã€åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘è€…ã€ç†è®ºç ”ç©¶è€…  
> **å…ˆä¿®çŸ¥è¯†**: [ä¸€é˜¶é€»è¾‘](06.3-å‘½é¢˜é€»è¾‘ä¸ä¸€é˜¶é€»è¾‘åŸºç¡€.md)ã€[æ±‚å€¼ç®—æ³•](06.4-æ±‚å€¼ç®—æ³•æ­£ç¡®æ€§è¯æ˜.md)  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 1.2 - å¹¶å‘ç†è®º

---

## ğŸ“ å¹¶å‘ç†è®ºæ¡†æ¶

> **æœ¬æ–‡æ¡£ç›®æ ‡**:
>
> - âœ… å½¢å¼åŒ–å¹¶å‘æ±‚å€¼æ¨¡å‹
> - âœ… åˆ†ææ•°æ®ç«äº‰å’ŒåŒæ­¥
> - âœ… è¯æ˜çº¿ç¨‹å®‰å…¨æ€§
> - âœ… ç ”ç©¶åˆ†å¸ƒå¼ä¸€è‡´æ€§
> - âœ… åº”ç”¨äºOPAå¹¶å‘åœºæ™¯
>
> **æ ¸å¿ƒæ¦‚å¿µ**:
>
> - **å¹¶å‘æ¨¡å‹**: äº¤é”™è¯­ä¹‰ã€çœŸå¹¶å‘è¯­ä¹‰
> - **åŒæ­¥æœºåˆ¶**: é”ã€æ¶ˆæ¯ä¼ é€’ã€STM
> - **æ•°æ®ç«äº‰**: åŒæ—¶è®¿é—®å…±äº«æ•°æ®
> - **çº¿ç¨‹å®‰å…¨**: å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§
> - **ä¸€è‡´æ€§**: åˆ†å¸ƒå¼ç³»ç»Ÿçš„çŠ¶æ€åè°ƒ
>
> **å®é™…ä»·å€¼**:
>
> - OPA Serverçš„å¹¶å‘è¯·æ±‚å¤„ç†
> - åˆ†å¸ƒå¼ç­–ç•¥å†³ç­–ä¸€è‡´æ€§
> - ç¼“å­˜ä¸€è‡´æ€§åè®®
> - æ— é”æ•°æ®ç»“æ„è®¾è®¡
> - æ€§èƒ½ä¸æ­£ç¡®æ€§æƒè¡¡

---

## ç›®å½•

- [å¹¶å‘è¯­ä¹‰ä¸æ­£ç¡®æ€§](#å¹¶å‘è¯­ä¹‰ä¸æ­£ç¡®æ€§)
  - [ğŸ“ å¹¶å‘ç†è®ºæ¡†æ¶](#-å¹¶å‘ç†è®ºæ¡†æ¶)
  - [ç›®å½•](#ç›®å½•)
  - [1. å¹¶å‘æ¨¡å‹](#1-å¹¶å‘æ¨¡å‹)
    - [1.1 äº¤é”™è¯­ä¹‰](#11-äº¤é”™è¯­ä¹‰)
      - [1.1.1 å®šä¹‰](#111-å®šä¹‰)
      - [1.1.2 äº¤é”™è¯­ä¹‰è§„åˆ™](#112-äº¤é”™è¯­ä¹‰è§„åˆ™)
    - [1.2 çœŸå¹¶å‘è¯­ä¹‰](#12-çœŸå¹¶å‘è¯­ä¹‰)
      - [1.2.1 ååºè¯­ä¹‰](#121-ååºè¯­ä¹‰)
      - [1.2.2 Petriç½‘](#122-petriç½‘)
    - [1.3 å†…å­˜æ¨¡å‹](#13-å†…å­˜æ¨¡å‹)
      - [1.3.1 é¡ºåºä¸€è‡´æ€§ (SC)](#131-é¡ºåºä¸€è‡´æ€§-sc)
      - [1.3.2 Total Store Order (TSO)](#132-total-store-order-tso)
      - [1.3.3 Release/Acquireè¯­ä¹‰](#133-releaseacquireè¯­ä¹‰)
  - [2. æ•°æ®ç«äº‰åˆ†æ](#2-æ•°æ®ç«äº‰åˆ†æ)
    - [2.1 ç«äº‰æ¡ä»¶å®šä¹‰](#21-ç«äº‰æ¡ä»¶å®šä¹‰)
    - [2.2 Happens-Beforeå…³ç³»](#22-happens-beforeå…³ç³»)
    - [2.3 ç«äº‰æ£€æµ‹](#23-ç«äº‰æ£€æµ‹)
      - [2.3.1 Locksetç®—æ³•](#231-locksetç®—æ³•)
      - [2.3.2 Happens-Beforeç®—æ³•](#232-happens-beforeç®—æ³•)
  - [3. åŒæ­¥æœºåˆ¶](#3-åŒæ­¥æœºåˆ¶)
    - [3.1 äº’æ–¥é”](#31-äº’æ–¥é”)
      - [3.1.1 è¯­ä¹‰](#311-è¯­ä¹‰)
      - [3.1.2 æ­£ç¡®æ€§](#312-æ­£ç¡®æ€§)
    - [3.2 è¯»å†™é”](#32-è¯»å†™é”)
      - [3.2.1 è¯­ä¹‰](#321-è¯­ä¹‰)
      - [3.2.2 æ€§èƒ½](#322-æ€§èƒ½)
    - [3.3 æ¶ˆæ¯ä¼ é€’](#33-æ¶ˆæ¯ä¼ é€’)
      - [3.3.1 Channelè¯­ä¹‰](#331-channelè¯­ä¹‰)
    - [3.4 è½¯ä»¶äº‹åŠ¡å†…å­˜](#34-è½¯ä»¶äº‹åŠ¡å†…å­˜)
      - [3.4.1 æ¦‚å¿µ](#341-æ¦‚å¿µ)
      - [3.4.2 å®ç°](#342-å®ç°)
  - [4. çº¿ç¨‹å®‰å…¨æ€§è¯æ˜](#4-çº¿ç¨‹å®‰å…¨æ€§è¯æ˜)
    - [4.1 ä¸å˜é‡](#41-ä¸å˜é‡)
    - [4.2 ä¸²è¡ŒåŒ–](#42-ä¸²è¡ŒåŒ–)
    - [4.3 çº¿æ€§ä¸€è‡´æ€§](#43-çº¿æ€§ä¸€è‡´æ€§)
  - [5. åˆ†å¸ƒå¼ä¸€è‡´æ€§](#5-åˆ†å¸ƒå¼ä¸€è‡´æ€§)
    - [5.1 CAPå®šç†](#51-capå®šç†)
    - [5.2 ä¸€è‡´æ€§æ¨¡å‹](#52-ä¸€è‡´æ€§æ¨¡å‹)
      - [5.2.1 å¼ºä¸€è‡´æ€§](#521-å¼ºä¸€è‡´æ€§)
      - [5.2.2 æœ€ç»ˆä¸€è‡´æ€§](#522-æœ€ç»ˆä¸€è‡´æ€§)
      - [5.2.3 å› æœä¸€è‡´æ€§](#523-å› æœä¸€è‡´æ€§)
    - [5.3 å…±è¯†ç®—æ³•](#53-å…±è¯†ç®—æ³•)
      - [5.3.1 Raft](#531-raft)
      - [5.3.2 Paxos](#532-paxos)
  - [6. OPAå¹¶å‘åœºæ™¯](#6-opaå¹¶å‘åœºæ™¯)
    - [6.1 å¹¶å‘æŸ¥è¯¢å¤„ç†](#61-å¹¶å‘æŸ¥è¯¢å¤„ç†)
    - [6.2 æ•°æ®åŠ è½½ä¸æ›´æ–°](#62-æ•°æ®åŠ è½½ä¸æ›´æ–°)
    - [6.3 ç¼“å­˜ä¸€è‡´æ€§](#63-ç¼“å­˜ä¸€è‡´æ€§)
    - [6.4 åˆ†å¸ƒå¼å†³ç­–](#64-åˆ†å¸ƒå¼å†³ç­–)
  - [7. æ€§èƒ½ä¸æ­£ç¡®æ€§](#7-æ€§èƒ½ä¸æ­£ç¡®æ€§)
    - [7.1 æ— é”æ•°æ®ç»“æ„](#71-æ— é”æ•°æ®ç»“æ„)
    - [7.2 é”ç²’åº¦é€‰æ‹©](#72-é”ç²’åº¦é€‰æ‹©)
    - [7.3 NUMAä¼˜åŒ–](#73-numaä¼˜åŒ–)
  - [é™„å½•](#é™„å½•)
    - [A. æœ¯è¯­å¯¹ç…§](#a-æœ¯è¯­å¯¹ç…§)
    - [B. æ ¸å¿ƒå®šç†é€ŸæŸ¥](#b-æ ¸å¿ƒå®šç†é€ŸæŸ¥)
    - [C. OPAå¹¶å‘æ€»ç»“](#c-opaå¹¶å‘æ€»ç»“)
    - [D. å‚è€ƒæ–‡çŒ®](#d-å‚è€ƒæ–‡çŒ®)

---

## 1. å¹¶å‘æ¨¡å‹

### 1.1 äº¤é”™è¯­ä¹‰

#### 1.1.1 å®šä¹‰

**äº¤é”™è¯­ä¹‰** (Interleaving Semantics):

```text
å¹¶å‘æ‰§è¡Œ = æ‰€æœ‰å¯èƒ½çš„ä¸²è¡Œæ‰§è¡Œé¡ºåºçš„é›†åˆ
```

**å½¢å¼åŒ–**:

```text
è®¾ä¸¤ä¸ªçº¿ç¨‹ Tâ‚, Tâ‚‚
  Tâ‚: a; b
  Tâ‚‚: c; d

å¯èƒ½çš„äº¤é”™:
  a; b; c; d
  a; c; b; d
  a; c; d; b
  c; a; b; d
  c; a; d; b
  c; d; a; b
```

#### 1.1.2 äº¤é”™è¯­ä¹‰è§„åˆ™

**æ“ä½œè¯­ä¹‰**:

```text
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  (Step-Left)
(Sâ‚ || Sâ‚‚, Ïƒ) â†’ (Sâ‚' || Sâ‚‚, Ïƒ')
  if (Sâ‚, Ïƒ) â†’ (Sâ‚', Ïƒ')

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  (Step-Right)
(Sâ‚ || Sâ‚‚, Ïƒ) â†’ (Sâ‚ || Sâ‚‚', Ïƒ')
  if (Sâ‚‚, Ïƒ) â†’ (Sâ‚‚', Ïƒ')
```

**ç¤ºä¾‹**:

```go
// Goä»£ç 
var x int = 0

// çº¿ç¨‹1
go func() {
    x = 1  // (1)
    y = x  // (2)
}()

// çº¿ç¨‹2
go func() {
    x = 2  // (3)
}()

// å¯èƒ½çš„æ‰§è¡Œé¡ºåº
// (1) (2) (3): y = 1, x = 2
// (1) (3) (2): y = 2, x = 2
// (3) (1) (2): y = 1, x = 1
```

### 1.2 çœŸå¹¶å‘è¯­ä¹‰

#### 1.2.1 ååºè¯­ä¹‰

**å®šä¹‰**: ç”¨ååºå…³ç³»è¡¨ç¤ºå› æœå…³ç³»

```text
Event = {eâ‚, eâ‚‚, ...}  (äº‹ä»¶é›†åˆ)
â‰º : Event Ã— Event      (å› æœå…ˆåºå…³ç³»)

æ€§è´¨:
1. éè‡ªå: e âŠ€ e
2. åå¯¹ç§°: eâ‚ â‰º eâ‚‚ âˆ§ eâ‚‚ â‰º eâ‚ âŸ¹ eâ‚ = eâ‚‚
3. ä¼ é€’: eâ‚ â‰º eâ‚‚ âˆ§ eâ‚‚ â‰º eâ‚ƒ âŸ¹ eâ‚ â‰º eâ‚ƒ
```

**å¹¶å‘å…³ç³»**:

```text
eâ‚ || eâ‚‚  âŸº  eâ‚ âŠ€ eâ‚‚ âˆ§ eâ‚‚ âŠ€ eâ‚
```

**ç¤ºä¾‹**:

```text
çº¿ç¨‹1: a â†’ b
çº¿ç¨‹2: c â†’ d

ååº:
  a â‰º b
  c â‰º d
  a || c, a || d, b || c, b || d
```

#### 1.2.2 Petriç½‘

**å®šä¹‰**: (P, T, F)

- P: ä½ç½®é›†ï¼ˆçŠ¶æ€ï¼‰
- T: å˜è¿é›†ï¼ˆåŠ¨ä½œï¼‰
- F: æµå…³ç³»ï¼ˆè¾¹ï¼‰

**è§¦å‘è§„åˆ™**:

```text
å˜è¿ t å¯è§¦å‘ âŸº âˆ€p âˆˆ â€¢t. M(p) â‰¥ F(p,t)
```

### 1.3 å†…å­˜æ¨¡å‹

#### 1.3.1 é¡ºåºä¸€è‡´æ€§ (SC)

**å®šä¹‰** (Lamport 1979):

```text
ç¨‹åºæ‰§è¡Œçš„ç»“æœç­‰åŒäºæ‰€æœ‰å¤„ç†å™¨çš„æ“ä½œ
ä»¥æŸç§é¡ºåºäº¤é”™æ‰§è¡Œï¼Œä¸”æ¯ä¸ªå¤„ç†å™¨çš„
æ“ä½œæŒ‰ç¨‹åºé¡ºåºå‡ºç°ã€‚
```

**å½¢å¼åŒ–**:

```text
âˆ€çº¿ç¨‹ T. Tä¸­æ“ä½œä¿æŒç¨‹åºé¡ºåº
âˆƒå…¨å±€é¡ºåº â‰º_global. æ‰€æœ‰æ“ä½œçš„æ€»åº
```

#### 1.3.2 Total Store Order (TSO)

**ç‰¹ç‚¹**: å†™æ“ä½œå…ˆè¿›å…¥Store Buffer

```text
CPU1       CPU2
 |          |
 â†“          â†“
StoreBuffer StoreBuffer
 |          |
 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â†“
   Memory
```

**å½±å“**: Store-Loadå¯ä»¥é‡æ’åº

#### 1.3.3 Release/Acquireè¯­ä¹‰

**Release**: å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹å¯è§
**Acquire**: è¯»æ“ä½œçœ‹åˆ°æœ€æ–°å†™å…¥

```go
// Go atomicæ“ä½œ
atomic.StoreInt32(&flag, 1)  // Release
value := atomic.LoadInt32(&flag)  // Acquire
```

---

## 2. æ•°æ®ç«äº‰åˆ†æ

### 2.1 ç«äº‰æ¡ä»¶å®šä¹‰

**å®šä¹‰ 2.1** (æ•°æ®ç«äº‰ Data Race)

ä¸¤ä¸ªæ“ä½œå­˜åœ¨æ•°æ®ç«äº‰ï¼Œå¦‚æœï¼š

1. è®¿é—®åŒä¸€å†…å­˜ä½ç½®
2. è‡³å°‘ä¸€ä¸ªæ˜¯å†™æ“ä½œ
3. å¹¶å‘æ‰§è¡Œï¼ˆæ— happens-beforeå…³ç³»ï¼‰

**å½¢å¼åŒ–**:

```text
Race(eâ‚, eâ‚‚) âŸº
  loc(eâ‚) = loc(eâ‚‚) âˆ§
  (write(eâ‚) âˆ¨ write(eâ‚‚)) âˆ§
  Â¬(eâ‚ â‰º eâ‚‚) âˆ§ Â¬(eâ‚‚ â‰º eâ‚)
```

**ç¤ºä¾‹**:

```go
var x int = 0

// çº¿ç¨‹1
x = 1  // å†™

// çº¿ç¨‹2
y = x  // è¯»

// ç«äº‰ï¼(xè¢«å¹¶å‘è¯»å†™)
```

### 2.2 Happens-Beforeå…³ç³»

**å®šä¹‰ 2.2** (Happens-Before â‰º_hb)

äº‹ä»¶eâ‚ happens-before eâ‚‚ï¼Œè®°ä½œ eâ‚ â‰º_hb eâ‚‚ï¼Œå¦‚æœï¼š

1. **ç¨‹åºé¡ºåº**: åŒä¸€çº¿ç¨‹ä¸­eâ‚åœ¨eâ‚‚ä¹‹å‰
2. **åŒæ­¥é¡ºåº**: eâ‚æ˜¯releaseï¼Œeâ‚‚æ˜¯å¯¹åº”çš„acquire
3. **ä¼ é€’æ€§**: eâ‚ â‰º_hb eâ‚‚ âˆ§ eâ‚‚ â‰º_hb eâ‚ƒ âŸ¹ eâ‚ â‰º_hb eâ‚ƒ

**è§„åˆ™**:

```text
(HB-PO)   same_thread(eâ‚, eâ‚‚) âˆ§ before(eâ‚, eâ‚‚)
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    eâ‚ â‰º_hb eâ‚‚

(HB-Sync) release(eâ‚, m) âˆ§ acquire(eâ‚‚, m)
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    eâ‚ â‰º_hb eâ‚‚

(HB-Trans) eâ‚ â‰º_hb eâ‚‚    eâ‚‚ â‰º_hb eâ‚ƒ
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                 eâ‚ â‰º_hb eâ‚ƒ
```

**å®šç† 2.1** (æ— ç«äº‰ä¿è¯)

å¦‚æœç¨‹åºæ— æ•°æ®ç«äº‰ï¼Œåˆ™å…¶è¡Œä¸ºç­‰ä»·äºæŸä¸ªé¡ºåºä¸€è‡´æ‰§è¡Œã€‚

### 2.3 ç«äº‰æ£€æµ‹

#### 2.3.1 Locksetç®—æ³•

**æ€æƒ³**: è·Ÿè¸ªä¿æŠ¤æ¯ä¸ªå˜é‡çš„é”é›†åˆ

```python
def lockset_check():
    for each variable v:
        locks[v] = all_locks  # åˆå§‹ï¼šæ‰€æœ‰é”
    
    for each access to v in thread t:
        locks[v] = locks[v] âˆ© held_locks[t]
        
        if locks[v] == âˆ…:
            report_race(v)
```

**ç¤ºä¾‹**:

```go
var mu sync.Mutex
var x int

// çº¿ç¨‹1
mu.Lock()
x = 1
mu.Unlock()

// çº¿ç¨‹2
x = 2  // ç«äº‰ï¼(æ— é”ä¿æŠ¤)
```

#### 2.3.2 Happens-Beforeç®—æ³•

**Vector Clockç®—æ³•**:

```python
VectorClock = [câ‚, câ‚‚, ..., câ‚™]  # nä¸ªçº¿ç¨‹

def increment_clock(thread_id):
    VC[thread_id][thread_id] += 1

def send_message(thread_i, thread_j):
    VC[thread_j] = max(VC[thread_i], VC[thread_j])
    VC[thread_j][thread_j] += 1

def happens_before(VCâ‚, VCâ‚‚):
    return all(VCâ‚[i] <= VCâ‚‚[i] for i in range(n))
```

---

## 3. åŒæ­¥æœºåˆ¶

### 3.1 äº’æ–¥é”

#### 3.1.1 è¯­ä¹‰

**æ“ä½œ**:

```text
Lock(m):   è·å–é”mï¼ˆé˜»å¡ç›´åˆ°æˆåŠŸï¼‰
Unlock(m): é‡Šæ”¾é”m
```

**ä¸å˜é‡**:

```text
âˆ€æ—¶åˆ»t. |{çº¿ç¨‹ | æŒæœ‰é”m}| â‰¤ 1
```

**ä¸´ç•ŒåŒº**:

```go
mu.Lock()
// ä¸´ç•ŒåŒºï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ
x = x + 1
mu.Unlock()
```

#### 3.1.2 æ­£ç¡®æ€§

**å®šç† 3.1** (äº’æ–¥æ€§)

å¦‚æœæ‰€æœ‰å¯¹å…±äº«å˜é‡çš„è®¿é—®éƒ½ç”±åŒä¸€ä¸ªé”ä¿æŠ¤ï¼Œåˆ™æ— æ•°æ®ç«äº‰ã€‚

**è¯æ˜**:

```text
è®¾ä¸¤ä¸ªè®¿é—® eâ‚, eâ‚‚ éƒ½è®¿é—®å˜é‡ v

å¦‚æœ eâ‚ å’Œ eâ‚‚ éƒ½æŒæœ‰é” m:
  eâ‚: Lock(m) ... access v ... Unlock(m)
  eâ‚‚: Lock(m) ... access v ... Unlock(m)

åˆ™è¦ä¹ˆ Unlock_eâ‚ â‰º_hb Lock_eâ‚‚ (eâ‚å…ˆ)
     æˆ– Unlock_eâ‚‚ â‰º_hb Lock_eâ‚ (eâ‚‚å…ˆ)

å› æ­¤ eâ‚ â‰º_hb eâ‚‚ æˆ– eâ‚‚ â‰º_hb eâ‚

å³ï¼šæ— å¹¶å‘ï¼Œæ— ç«äº‰  âœ“
```

### 3.2 è¯»å†™é”

#### 3.2.1 è¯­ä¹‰

**æ“ä½œ**:

```text
RLock(rw):  è·å–è¯»é”ï¼ˆå…è®¸å¤šä¸ªè¯»è€…ï¼‰
RUnlock(rw): é‡Šæ”¾è¯»é”
Lock(rw):   è·å–å†™é”ï¼ˆç‹¬å ï¼‰
Unlock(rw):  é‡Šæ”¾å†™é”
```

**ä¸å˜é‡**:

```text
âˆ€æ—¶åˆ»t. 
  (|readers| > 0 âˆ§ |writers| = 0) âˆ¨
  (|readers| = 0 âˆ§ |writers| â‰¤ 1)
```

#### 3.2.2 æ€§èƒ½

**é€‚ç”¨åœºæ™¯**: è¯»å¤šå†™å°‘

```go
var rwmu sync.RWMutex
var cache map[string]interface{}

// è¯»æ“ä½œï¼ˆå¹¶å‘ï¼‰
func Get(key string) interface{} {
    rwmu.RLock()
    defer rwmu.RUnlock()
    return cache[key]
}

// å†™æ“ä½œï¼ˆç‹¬å ï¼‰
func Set(key string, val interface{}) {
    rwmu.Lock()
    defer rwmu.Unlock()
    cache[key] = val
}
```

### 3.3 æ¶ˆæ¯ä¼ é€’

#### 3.3.1 Channelè¯­ä¹‰

**æ“ä½œ**:

```text
ch := make(chan T)  // åˆ›å»ºchannel
ch <- v             // å‘é€ï¼ˆé˜»å¡ï¼‰
v := <-ch           // æ¥æ”¶ï¼ˆé˜»å¡ï¼‰
```

**Happens-Beforeè§„åˆ™**:

```text
send(ch, v) â‰º_hb receive(ch, v)
```

**ç¤ºä¾‹**:

```go
ch := make(chan int)

go func() {
    x = 1       // (1)
    ch <- 42    // (2) send
}()

<-ch            // (3) receive
y = x           // (4)

// (1) â‰º_hb (2) â‰º_hb (3) â‰º_hb (4)
// å› æ­¤ y == 1 ä¿è¯
```

### 3.4 è½¯ä»¶äº‹åŠ¡å†…å­˜

#### 3.4.1 æ¦‚å¿µ

**STM**: å°†å†…å­˜æ“ä½œç»„ç»‡ä¸ºäº‹åŠ¡

```text
atomic {
    // äº‹åŠ¡ä½“
    // è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
}
```

**æ€§è´¨**:

- åŸå­æ€§ï¼ˆAtomicityï¼‰
- ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰
- éš”ç¦»æ€§ï¼ˆIsolationï¼‰

#### 3.4.2 å®ç°

**ä¹è§‚å¹¶å‘æ§åˆ¶**:

```python
def stm_transaction(txn_body):
    read_set = {}
    write_set = {}
    
    # æ‰§è¡Œé˜¶æ®µ
    result = txn_body(read_set, write_set)
    
    # éªŒè¯é˜¶æ®µ
    if validate(read_set):
        # æäº¤
        apply(write_set)
        return result
    else:
        # å›æ»šé‡è¯•
        return stm_transaction(txn_body)

def validate(read_set):
    for (var, version) in read_set:
        if global_version[var] != version:
            return False  # å†²çª
    return True
```

---

## 4. çº¿ç¨‹å®‰å…¨æ€§è¯æ˜

### 4.1 ä¸å˜é‡

**å®šä¹‰ 4.1** (å¹¶å‘ä¸å˜é‡)

è°“è¯ I(Ïƒ) æ˜¯å¹¶å‘ä¸å˜é‡ï¼Œå¦‚æœï¼š

```text
âˆ€åˆå§‹çŠ¶æ€ Ïƒâ‚€. I(Ïƒâ‚€) âˆ§
âˆ€è½¬ç§» Ïƒ â†’ Ïƒ'. I(Ïƒ) âŸ¹ I(Ïƒ')
```

**ç¤ºä¾‹**:

```go
// ä¸å˜é‡: balance >= 0
type Account struct {
    mu      sync.Mutex
    balance int
}

func (a *Account) Withdraw(amount int) bool {
    a.mu.Lock()
    defer a.mu.Unlock()
    
    if a.balance >= amount {  // æ£€æŸ¥ä¸å˜é‡
        a.balance -= amount
        return true
    }
    return false
}
```

### 4.2 ä¸²è¡ŒåŒ–

**å®šä¹‰ 4.2** (ä¸²è¡ŒåŒ– Serializability)

å¹¶å‘æ‰§è¡Œç­‰ä»·äºæŸä¸ªä¸²è¡Œæ‰§è¡Œã€‚

**å†²çªä¸²è¡ŒåŒ–**:

```text
ä¸¤ä¸ªæ“ä½œå†²çª âŸº 
  è®¿é—®åŒä¸€å¯¹è±¡ âˆ§ è‡³å°‘ä¸€ä¸ªæ˜¯å†™

ä¸²è¡ŒåŒ– âŸº å†²çªå›¾æ— ç¯
```

**å®šç† 4.1** (Two-Phase Lockingä¿è¯ä¸²è¡ŒåŒ–)

å¦‚æœæ‰€æœ‰äº‹åŠ¡éµå¾ª2PLåè®®ï¼Œåˆ™æ‰§è¡Œæ˜¯ä¸²è¡ŒåŒ–çš„ã€‚

**è¯æ˜æ¦‚è¦**:

```text
2PL = å¢é•¿é˜¶æ®µ(åªè·å–é”) + æ”¶ç¼©é˜¶æ®µ(åªé‡Šæ”¾é”)

å†²çªå›¾:
  T_i â†’ T_j å¦‚æœ T_i å…ˆé‡Šæ”¾é” L, T_j åè·å–é” L

2PLä¿è¯æ— ç¯:
  å‡è®¾ç¯ Tâ‚ â†’ Tâ‚‚ â†’ ... â†’ Tâ‚™ â†’ Tâ‚
  åˆ™ Tâ‚ åœ¨ Tâ‚‚ ä¹‹å‰é‡Šæ”¾æŸé”
     Tâ‚‚ åœ¨ Tâ‚ƒ ä¹‹å‰é‡Šæ”¾æŸé”
     ...
     Tâ‚™ åœ¨ Tâ‚ ä¹‹å‰é‡Šæ”¾æŸé”
  
  çŸ›ç›¾ï¼(æ—¶é—´ä¸èƒ½æˆç¯)
  
å› æ­¤æ— ç¯ï¼Œä¸²è¡ŒåŒ–  âœ“
```

### 4.3 çº¿æ€§ä¸€è‡´æ€§

**å®šä¹‰ 4.3** (Linearizability)

æ¯ä¸ªæ“ä½œçœ‹èµ·æ¥åœ¨æŸä¸ªåŸå­æ—¶åˆ»ç¬é—´å®Œæˆã€‚

**å½¢å¼åŒ–**:

```text
âˆƒçº¿æ€§åŒ–ç‚¹ lin(op) âˆˆ [start(op), end(op)]
ä½¿å¾—æŒ‰ lin(op) æ’åºçš„æ‰§è¡Œç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ
```

**ç¤ºä¾‹**:

```text
çº¿ç¨‹1: write(x, 1) [â”€â”€â”€â”€â”€â”€â”€â”€]
              çº¿ç¨‹2:     read(x) [â”€â”€] â†’ 1

çº¿æ€§åŒ–ç‚¹: writeåœ¨readä¹‹å‰
ä¸²è¡Œæ‰§è¡Œ: write(x,1); read(x) â†’ 1  âœ“
```

---

## 5. åˆ†å¸ƒå¼ä¸€è‡´æ€§

### 5.1 CAPå®šç†

**å®šç† 5.1** (CAPå®šç† - Brewer 2000)

åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªä¸­çš„ä¸¤ä¸ªï¼š

- **Consistency**: ä¸€è‡´æ€§ï¼ˆæ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°ç›¸åŒæ•°æ®ï¼‰
- **Availability**: å¯ç”¨æ€§ï¼ˆè¯·æ±‚æ€»èƒ½å¾—åˆ°å“åº”ï¼‰
- **Partition tolerance**: åˆ†åŒºå®¹é”™ï¼ˆç½‘ç»œåˆ†åŒºæ—¶ç³»ç»Ÿä»å¯ç”¨ï¼‰

**è¯æ˜æ¦‚è¦**:

```text
å‡è®¾ç½‘ç»œåˆ†åŒºå°†èŠ‚ç‚¹åˆ†ä¸º Gâ‚ å’Œ Gâ‚‚

æƒ…å†µ1: é€‰æ‹© CP (ä¸€è‡´æ€§ + åˆ†åŒºå®¹é”™)
  åˆ†åŒºæ—¶ï¼Œæ‹’ç»æŸäº›è¯·æ±‚ â†’ ä¸æ»¡è¶³ A

æƒ…å†µ2: é€‰æ‹© AP (å¯ç”¨æ€§ + åˆ†åŒºå®¹é”™)
  åˆ†åŒºæ—¶ï¼Œä¸¤ä¾§ç‹¬ç«‹æ¥å—å†™å…¥ â†’ ä¸æ»¡è¶³ C

æƒ…å†µ3: é€‰æ‹© CA (ä¸€è‡´æ€§ + å¯ç”¨æ€§)
  å¿…é¡»æ‹’ç»åˆ†åŒº â†’ ä¸æ»¡è¶³ P

å› æ­¤æœ€å¤šé€‰2ä¸ª  âœ“
```

### 5.2 ä¸€è‡´æ€§æ¨¡å‹

#### 5.2.1 å¼ºä¸€è‡´æ€§

**çº¿æ€§ä¸€è‡´æ€§** (Linearizability):

- æœ€å¼ºçš„ä¸€è‡´æ€§
- ç­‰ä»·äºå•æœºæ‰§è¡Œ

#### 5.2.2 æœ€ç»ˆä¸€è‡´æ€§

**å®šä¹‰**: å¦‚æœåœæ­¢æ›´æ–°ï¼Œæœ€ç»ˆæ‰€æœ‰å‰¯æœ¬æ”¶æ•›åˆ°ç›¸åŒå€¼

**ç¤ºä¾‹**: DNS, Cassandra

#### 5.2.3 å› æœä¸€è‡´æ€§

**å®šä¹‰**: å› æœç›¸å…³çš„æ“ä½œæŒ‰é¡ºåºï¼Œæ— å…³æ“ä½œå¯å¹¶å‘

```text
write(x, 1)  write(y, 2)
    â†“           â†“
read(x) â†’ 1  read(y) â†’ 2
    â†“
read(y) â†’ ?  (å¯ä»¥æ˜¯æ—§å€¼æˆ–æ–°å€¼)
```

### 5.3 å…±è¯†ç®—æ³•

#### 5.3.1 Raft

**å…³é”®æ¦‚å¿µ**:

- Leaderé€‰ä¸¾
- æ—¥å¿—å¤åˆ¶
- å®‰å…¨æ€§ä¿è¯

**ä¸å˜é‡**:

- é€‰ä¸¾å®‰å…¨æ€§ï¼šæ¯ä¸ªä»»æœŸæœ€å¤šä¸€ä¸ªLeader
- æ—¥å¿—åŒ¹é…ï¼šç›¸åŒç´¢å¼•å’Œä»»æœŸçš„æ—¥å¿—æ¡ç›®ç›¸åŒ
- Leaderå®Œæ•´æ€§ï¼šå·²æäº¤çš„æ—¥å¿—ä¸ä¼šä¸¢å¤±

#### 5.3.2 Paxos

**é˜¶æ®µ**:

1. Prepare: æè®®è€…è¯¢é—®æ¥å—è€…
2. Promise: æ¥å—è€…æ‰¿è¯º
3. Accept: æè®®è€…æäº¤å€¼
4. Learn: å­¦ä¹ è€…å­¦ä¹ å·²é€‰æ‹©çš„å€¼

**å®šç†**: Paxosä¿è¯å®‰å…¨æ€§ï¼ˆä¸è¿èƒŒä¸€è‡´æ€§ï¼‰

---

## 6. OPAå¹¶å‘åœºæ™¯

### 6.1 å¹¶å‘æŸ¥è¯¢å¤„ç†

**åœºæ™¯**: OPA ServeråŒæ—¶å¤„ç†å¤šä¸ªæŸ¥è¯¢è¯·æ±‚

```go
// OPA Serverä¼ªä»£ç 
func (s *Server) Query(ctx context.Context, query string) Result {
    // åªè¯»æ•°æ®è®¿é—®ï¼ˆå¹¶å‘å®‰å…¨ï¼‰
    data := s.store.Read()  // RLock
    
    // ç‹¬ç«‹æ±‚å€¼ï¼ˆæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çŠ¶æ€ï¼‰
    eval := NewEvaluator(query, data)
    result := eval.Eval()
    
    return result
}
```

**çº¿ç¨‹å®‰å…¨æ€§**:

- `store.Read()` ä½¿ç”¨è¯»é”ï¼ˆå…è®¸å¹¶å‘ï¼‰
- æ±‚å€¼å™¨çŠ¶æ€ç‹¬ç«‹ï¼ˆæ— å…±äº«ï¼‰
- ç»“æœè¿”å›å‰æ— å‰¯ä½œç”¨

### 6.2 æ•°æ®åŠ è½½ä¸æ›´æ–°

**æŒ‘æˆ˜**: æ•°æ®æ›´æ–°æ—¶å¦‚ä½•ä¿è¯æŸ¥è¯¢ä¸€è‡´æ€§ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: Copy-On-Write

```go
type Store struct {
    mu   sync.RWMutex
    data *immutable.Map  // ä¸å¯å˜æ•°æ®ç»“æ„
}

func (s *Store) Update(newData Data) {
    s.mu.Lock()
    defer s.mu.Unlock()
    
    // åˆ›å»ºæ–°ç‰ˆæœ¬ï¼ˆCOWï¼‰
    s.data = s.data.Set(newData.Key, newData.Value)
}

func (s *Store) Read() *immutable.Map {
    s.mu.RLock()
    defer s.mu.RUnlock()
    return s.data  // è¿”å›ä¸å¯å˜å¿«ç…§
}
```

**ä¼˜åŠ¿**:

- è¯»æ“ä½œæ— éœ€æ‹·è´ï¼ˆæŒ‡é’ˆå…±äº«ï¼‰
- å†™æ“ä½œä¸å½±å“æ­£åœ¨è¿›è¡Œçš„è¯»
- æœ€ç»ˆä¸€è‡´æ€§

### 6.3 ç¼“å­˜ä¸€è‡´æ€§

**é—®é¢˜**: ç¼–è¯‘åçš„ç­–ç•¥ç¼“å­˜å¦‚ä½•å¤±æ•ˆï¼Ÿ

**ç­–ç•¥**: Write-Through + ç‰ˆæœ¬å·

```go
type Cache struct {
    mu       sync.Mutex
    entries  map[string]*CacheEntry
    version  int64
}

type CacheEntry struct {
    compiled *Policy
    version  int64
}

func (c *Cache) Get(key string, storeVer int64) *Policy {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    entry := c.entries[key]
    if entry != nil && entry.version == storeVer {
        return entry.compiled  // ç¼“å­˜å‘½ä¸­
    }
    return nil  // ç¼“å­˜å¤±æ•ˆ
}

func (c *Cache) Put(key string, policy *Policy, ver int64) {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    c.entries[key] = &CacheEntry{
        compiled: policy,
        version:  ver,
    }
}
```

### 6.4 åˆ†å¸ƒå¼å†³ç­–

**åœºæ™¯**: å¤šä¸ªOPAå®ä¾‹åšåˆ†å¸ƒå¼æˆæƒå†³ç­–

**æŒ‘æˆ˜**:

- æ•°æ®åŒæ­¥å»¶è¿Ÿ
- éƒ¨åˆ†å¤±è´¥
- ç½‘ç»œåˆ†åŒº

**è§£å†³æ–¹æ¡ˆ**:

1. **æœ€ç»ˆä¸€è‡´æ€§** + å¹‚ç­‰å†³ç­–
2. **Quorumè¯»å†™**: å¤šæ•°æ´¾ä¸€è‡´
3. **åˆ†å¸ƒå¼è·Ÿè¸ª**: å…³è”å†³ç­–é“¾

**ç¤ºä¾‹**: åˆ†å¸ƒå¼é™æµ

```text
èŠ‚ç‚¹1: å…è®¸100 QPS
èŠ‚ç‚¹2: å…è®¸100 QPS
èŠ‚ç‚¹3: å…è®¸100 QPS

é—®é¢˜: æ€»QPSå¯èƒ½è¶…è¿‡300
è§£å†³: å…±äº«è®¡æ•°å™¨ + Raftå…±è¯†
```

---

## 7. æ€§èƒ½ä¸æ­£ç¡®æ€§

### 7.1 æ— é”æ•°æ®ç»“æ„

**CASæ“ä½œ** (Compare-And-Swap):

```go
func CAS(addr *int64, old, new int64) bool {
    // åŸå­æ“ä½œ
    if *addr == old {
        *addr = new
        return true
    }
    return false
}
```

**æ— é”æ ˆ**:

```go
type LockFreeStack struct {
    head unsafe.Pointer  // *Node
}

func (s *LockFreeStack) Push(value interface{}) {
    node := &Node{value: value}
    for {
        old := atomic.LoadPointer(&s.head)
        node.next = (*Node)(old)
        if atomic.CompareAndSwapPointer(&s.head, old, unsafe.Pointer(node)) {
            return
        }
        // CASå¤±è´¥ï¼Œé‡è¯•
    }
}
```

**ä¼˜åŠ¿**: æ— é”ç«äº‰å¼€é”€  
**åŠ£åŠ¿**: ABAé—®é¢˜ã€å¤æ‚åº¦é«˜

### 7.2 é”ç²’åº¦é€‰æ‹©

**æƒè¡¡**:

| é”ç²’åº¦ | å¹¶å‘åº¦ | å¼€é”€ | å¤æ‚åº¦ |
|-------|-------|-----|-------|
| å…¨å±€é” | ä½ | ä½ | ä½ |
| åˆ†æ®µé” | ä¸­ | ä¸­ | ä¸­ |
| ç»†ç²’åº¦é” | é«˜ | é«˜ | é«˜ |
| æ— é” | æœ€é«˜ | ä½ | æœ€é«˜ |

**æœ€ä½³å®è·µ**:

1. æµ‹é‡ç«äº‰ç¨‹åº¦
2. ä»ç²—ç²’åº¦å¼€å§‹
3. æ ¹æ®profilingç»†åŒ–
4. é¿å…è¿‡æ—©ä¼˜åŒ–

### 7.3 NUMAä¼˜åŒ–

**NUMAæ¶æ„** (Non-Uniform Memory Access):

```text
CPU0 â”€â”¬â”€ LocalMem0
      â”‚
CPU1 â”€â”¼â”€ LocalMem1  (è¿œç¨‹è®¿é—®æ…¢)
      â”‚
CPU2 â”€â”¼â”€ LocalMem2
      â”‚
CPU3 â”€â”´â”€ LocalMem3
```

**ä¼˜åŒ–ç­–ç•¥**:

1. **æœ¬åœ°åŒ–æ•°æ®**: çº¿ç¨‹è®¿é—®æœ¬åœ°å†…å­˜
2. **å‡å°‘è·¨èŠ‚ç‚¹é€šä¿¡**: åˆ†åŒºæ•°æ®
3. **äº²å’Œæ€§ç»‘å®š**: å›ºå®šçº¿ç¨‹åˆ°CPU

```go
// ä¼ªä»£ç 
func ProcessSharded(data []Chunk) {
    numCPU := runtime.NumCPU()
    
    for i, chunk := range data {
        cpuID := i % numCPU
        
        // ç»‘å®šåˆ°ç‰¹å®šCPU
        runtime.LockOSThread()
        setAffinity(cpuID)
        
        process(chunk)  // æœ¬åœ°å†…å­˜è®¿é—®
    }
}
```

---

## é™„å½•

### A. æœ¯è¯­å¯¹ç…§

| è‹±æ–‡ | ä¸­æ–‡ | è¯´æ˜ |
|------|------|------|
| Concurrency | å¹¶å‘ | é€»è¾‘ä¸ŠåŒæ—¶ |
| Parallelism | å¹¶è¡Œ | ç‰©ç†ä¸ŠåŒæ—¶ |
| Data Race | æ•°æ®ç«äº‰ | å¹¶å‘è¯»å†™å†²çª |
| Happens-Before | å…ˆåºå…³ç³» | å› æœé¡ºåº |
| Linearizability | çº¿æ€§ä¸€è‡´æ€§ | æœ€å¼ºä¸€è‡´æ€§ |
| Eventual Consistency | æœ€ç»ˆä¸€è‡´æ€§ | å»¶è¿Ÿæ”¶æ•› |

### B. æ ¸å¿ƒå®šç†é€ŸæŸ¥

1. **äº’æ–¥æ€§**: é”ä¿æŠ¤æ¶ˆé™¤ç«äº‰
2. **2PLä¸²è¡ŒåŒ–**: ä¸¤é˜¶æ®µé”ä¿è¯ä¸²è¡ŒåŒ–
3. **CAPå®šç†**: æœ€å¤šé€‰2ä¸ªï¼ˆC/A/Pï¼‰
4. **çº¿æ€§ä¸€è‡´æ€§**: å­˜åœ¨å…¨å±€é¡ºåº
5. **æ— ç«äº‰ä¿è¯**: æ— ç«äº‰â†’é¡ºåºä¸€è‡´

### C. OPAå¹¶å‘æ€»ç»“

| åœºæ™¯ | æœºåˆ¶ | æ€§èƒ½ | ä¸€è‡´æ€§ |
|------|------|------|--------|
| æŸ¥è¯¢å¹¶å‘ | è¯»é” | é«˜ | å¿«ç…§ä¸€è‡´ |
| æ•°æ®æ›´æ–° | COW | ä¸­ | æœ€ç»ˆä¸€è‡´ |
| ç¼“å­˜ | ç‰ˆæœ¬å· | é«˜ | å¯è°ƒ |
| åˆ†å¸ƒå¼ | Raft | ä½ | å¼ºä¸€è‡´ |

### D. å‚è€ƒæ–‡çŒ®

1. **Lamport, L.** "How to Make a Multiprocessor Computer That Correctly Executes Multiprocess Programs" (1979)
   - é¡ºåºä¸€è‡´æ€§å®šä¹‰
2. **Herlihy, M., Wing, J.** "Linearizability: A Correctness Condition for Concurrent Objects" (1990)
   - çº¿æ€§ä¸€è‡´æ€§ç†è®º
3. **Brewer, E.** "CAP Twelve Years Later: How the Rules Have Changed" (2012)
   - CAPå®šç†è¯¦è§£
4. **Ongaro, D., Ousterhout, J.** "In Search of an Understandable Consensus Algorithm" (2014)
   - Raftå…±è¯†ç®—æ³•
5. **Go Memory Model** - <https://go.dev/ref/mem>
   - Goå¹¶å‘è¯­ä¹‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥  
**ç»´æŠ¤è€…**: OPAæŠ€æœ¯æ–‡æ¡£é¡¹ç›®  
**åé¦ˆ**: æ¬¢è¿é€šè¿‡GitHub Issuesæä¾›å»ºè®®

**ğŸ‰ Phase 1å½¢å¼åŒ–ç†è®ºå®Œæ•´å®Œæˆï¼ğŸ‰**:

**ä¸‹ä¸€æ­¥é˜…è¯»**:

- [ç´¢å¼•ä¸ä¼˜åŒ–](../03-å®ç°æ¶æ„/03.5-ç´¢å¼•ä¸ä¼˜åŒ–.md) - OPAæ€§èƒ½ä¼˜åŒ–å®ç°
- [Top-Downæ±‚å€¼å™¨](../03-å®ç°æ¶æ„/03.4-Top-Downæ±‚å€¼å™¨.md) - å¹¶å‘æ±‚å€¼å®ç°
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md) - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
