# éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯ï¼ˆPartial Evaluationï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.20+ (å¼•å…¥éƒ¨åˆ†æ±‚å€¼) | æ¨è v0.68+  
> **æŠ€æœ¯åŸºç¡€**: FutamuraæŠ•å½±ã€è¶…çº§ç¼–è¯‘  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/policy-performance/>

---

## ğŸš€ éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–æŠ€æœ¯

> **ä»€ä¹ˆæ˜¯éƒ¨åˆ†æ±‚å€¼**:
>
> - âœ… å°†å·²çŸ¥çš„éƒ¨åˆ†è¾“å…¥æå‰æ±‚å€¼ï¼Œç”Ÿæˆä¼˜åŒ–åçš„ç­–ç•¥
> - âœ… å…¸å‹åº”ç”¨ï¼šå°†é™æ€æ•°æ®ï¼ˆå¦‚ç”¨æˆ·æƒé™è¡¨ï¼‰ç¼–è¯‘è¿›ç­–ç•¥
> - âœ… å¯è·å¾—5-10xæ€§èƒ½æå‡
> - âš ï¸ éœ€è¦æ˜ç¡®åŒºåˆ†é™æ€æ•°æ®å’ŒåŠ¨æ€è¾“å…¥
>
> **ä½¿ç”¨åœºæ™¯**:
>
> - APIç½‘å…³æˆæƒï¼ˆé™æ€è·¯ç”±è§„åˆ™ï¼‰
> - K8så‡†å…¥æ§åˆ¶ï¼ˆé™æ€ç­–ç•¥æ¨¡æ¿ï¼‰
> - è¾¹ç¼˜è®¡ç®—ï¼ˆé¢„ç¼–è¯‘ç­–ç•¥ï¼‰
>
> **å®è·µå»ºè®®**:
>
> - ä½¿ç”¨`opa build`å‘½ä»¤ç”Ÿæˆä¼˜åŒ–Bundle
> - æµ‹è¯•éªŒè¯éƒ¨åˆ†æ±‚å€¼åçš„æ­£ç¡®æ€§
>
> ç›¸å…³: [æ€§èƒ½ä¼˜åŒ–](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md) | [WASMç¼–è¯‘](../01-æŠ€æœ¯è§„èŒƒ/01.3-WASMç¼–è¯‘è§„èŒƒ.md)

---

## ç›®å½•

- [éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯ï¼ˆPartial Evaluationï¼‰](#éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯partial-evaluation)
  - [ğŸš€ éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–æŠ€æœ¯](#-éƒ¨åˆ†æ±‚å€¼ä¼˜åŒ–æŠ€æœ¯)
  - [ç›®å½•](#ç›®å½•)
  - [1. éƒ¨åˆ†æ±‚å€¼æ¦‚è¿°](#1-éƒ¨åˆ†æ±‚å€¼æ¦‚è¿°)
    - [1.1 åŸºæœ¬æ¦‚å¿µ](#11-åŸºæœ¬æ¦‚å¿µ)
    - [1.2 åº”ç”¨ä»·å€¼](#12-åº”ç”¨ä»·å€¼)
    - [1.3 æ ¸å¿ƒæ€æƒ³](#13-æ ¸å¿ƒæ€æƒ³)
  - [2. éƒ¨åˆ†æ±‚å€¼åŸç†](#2-éƒ¨åˆ†æ±‚å€¼åŸç†)
    - [2.1 å·²çŸ¥ä¸æœªçŸ¥](#21-å·²çŸ¥ä¸æœªçŸ¥)
    - [2.2 ç‰¹åŒ–è¿‡ç¨‹](#22-ç‰¹åŒ–è¿‡ç¨‹)
    - [2.3 æ®‹ä½™ç¨‹åº](#23-æ®‹ä½™ç¨‹åº)
  - [3. OPAä¸­çš„éƒ¨åˆ†æ±‚å€¼](#3-opaä¸­çš„éƒ¨åˆ†æ±‚å€¼)
    - [3.1 ç¼–è¯‘å‘½ä»¤](#31-ç¼–è¯‘å‘½ä»¤)
    - [3.2 æœªçŸ¥å˜é‡æŒ‡å®š](#32-æœªçŸ¥å˜é‡æŒ‡å®š)
    - [3.3 è¾“å‡ºæ ¼å¼](#33-è¾“å‡ºæ ¼å¼)
  - [4. ä¼˜åŒ–æ•ˆæœ](#4-ä¼˜åŒ–æ•ˆæœ)
    - [4.1 ç­–ç•¥å¤§å°](#41-ç­–ç•¥å¤§å°)
    - [4.2 æ‰§è¡Œé€Ÿåº¦](#42-æ‰§è¡Œé€Ÿåº¦)
    - [4.3 é€‚ç”¨åœºæ™¯](#43-é€‚ç”¨åœºæ™¯)
  - [5. é«˜çº§æŠ€æœ¯](#5-é«˜çº§æŠ€æœ¯)
    - [5.1 å±•å¼€å¾ªç¯](#51-å±•å¼€å¾ªç¯)
    - [5.2 å‡½æ•°ç‰¹åŒ–](#52-å‡½æ•°ç‰¹åŒ–)
    - [5.3 æ•°æ®å†…è”](#53-æ•°æ®å†…è”)
  - [6. WASMéƒ¨ç½²](#6-wasméƒ¨ç½²)
    - [6.1 éƒ¨åˆ†æ±‚å€¼+WASM](#61-éƒ¨åˆ†æ±‚å€¼wasm)
    - [6.2 è¾¹ç¼˜è®¡ç®—åœºæ™¯](#62-è¾¹ç¼˜è®¡ç®—åœºæ™¯)
    - [6.3 æ€§èƒ½å¯¹æ¯”](#63-æ€§èƒ½å¯¹æ¯”)
  - [7. å®è·µæ¡ˆä¾‹](#7-å®è·µæ¡ˆä¾‹)
    - [7.1 RBACç­–ç•¥ä¼˜åŒ–](#71-rbacç­–ç•¥ä¼˜åŒ–)
    - [7.2 Kuberneteså‡†å…¥æ§åˆ¶](#72-kuberneteså‡†å…¥æ§åˆ¶)
    - [7.3 APIç½‘å…³æˆæƒ](#73-apiç½‘å…³æˆæƒ)
  - [8. å±€é™æ€§](#8-å±€é™æ€§)
    - [8.1 é€‚ç”¨é™åˆ¶](#81-é€‚ç”¨é™åˆ¶)
    - [8.2 æ€§èƒ½æƒè¡¡](#82-æ€§èƒ½æƒè¡¡)
    - [8.3 è°ƒè¯•å›°éš¾](#83-è°ƒè¯•å›°éš¾)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 ä½•æ—¶ä½¿ç”¨](#91-ä½•æ—¶ä½¿ç”¨)
    - [9.2 ç­–ç•¥è®¾è®¡](#92-ç­–ç•¥è®¾è®¡)
    - [9.3 æµ‹è¯•éªŒè¯](#93-æµ‹è¯•éªŒè¯)
  - [10. æœªæ¥å‘å±•](#10-æœªæ¥å‘å±•)
    - [10.1 JITç¼–è¯‘](#101-jitç¼–è¯‘)
    - [10.2 è‡ªé€‚åº”ä¼˜åŒ–](#102-è‡ªé€‚åº”ä¼˜åŒ–)
    - [10.3 AIè¾…åŠ©ç‰¹åŒ–](#103-aiè¾…åŠ©ç‰¹åŒ–)
  - [é™„å½•Aï¼šç†è®ºåŸºç¡€](#é™„å½•aç†è®ºåŸºç¡€)
  - [é™„å½•Bï¼šå®ç°ç»†èŠ‚](#é™„å½•bå®ç°ç»†èŠ‚)

---

## 1. éƒ¨åˆ†æ±‚å€¼æ¦‚è¿°

### 1.1 åŸºæœ¬æ¦‚å¿µ

**å®šä¹‰**ï¼š

```text
éƒ¨åˆ†æ±‚å€¼ (Partial Evaluation) æ˜¯ä¸€ç§ç¨‹åºä¼˜åŒ–æŠ€æœ¯ï¼š
ç»™å®šç¨‹åº P å’Œéƒ¨åˆ†è¾“å…¥ Iâ‚ï¼Œç”Ÿæˆç‰¹åŒ–ç¨‹åº P'ï¼Œä½¿å¾—ï¼š

  P(Iâ‚, Iâ‚‚) = P'(Iâ‚‚)

å…¶ä¸­:
  - Iâ‚: å·²çŸ¥è¾“å…¥ï¼ˆç¼–è¯‘æ—¶å¯ç”¨ï¼‰
  - Iâ‚‚: æœªçŸ¥è¾“å…¥ï¼ˆè¿è¡Œæ—¶æä¾›ï¼‰
  - P': ç‰¹åŒ–åçš„ç¨‹åºï¼ˆé’ˆå¯¹Iâ‚ä¼˜åŒ–ï¼‰
```

**ä¾‹å­**ï¼š

```rego
# åŸå§‹ç­–ç•¥ P
allow if {
    user := data.users[input.user_id]
    user.role == "admin"
}

# å·²çŸ¥: data.users = {"u1": {"role": "admin"}, "u2": {"role": "user"}}
# æœªçŸ¥: input.user_id

# éƒ¨åˆ†æ±‚å€¼å P'
allow if {
    input.user_id == "u1"  # åªæœ‰u1æ˜¯admin
}
```

### 1.2 åº”ç”¨ä»·å€¼

**æ€§èƒ½æå‡**ï¼š

```text
åœºæ™¯: 1000æ¡RBACè§„åˆ™ï¼Œ10,000ä¸ªç”¨æˆ·

å®Œæ•´æ±‚å€¼:
  - ç­–ç•¥å¤§å°: 10MB
  - åŠ è½½æ—¶é—´: 500ms
  - å†³ç­–å»¶è¿Ÿ: 5ms

éƒ¨åˆ†æ±‚å€¼:
  - ç­–ç•¥å¤§å°: 50KB (99%å‡å°‘)
  - åŠ è½½æ—¶é—´: 10ms (98%å‡å°‘)
  - å†³ç­–å»¶è¿Ÿ: 0.1ms (98%å‡å°‘)
```

### 1.3 æ ¸å¿ƒæ€æƒ³

**åˆ†ç¦»å…³æ³¨ç‚¹**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®Œæ•´ç­–ç•¥ + å®Œæ•´æ•°æ®    â”‚
â”‚                         â”‚
â”‚   data.users (10K)      â”‚
â”‚   + policy (1000 rules) â”‚
â”‚                         â”‚
â”‚   å†³ç­–æ—¶é—´: 5ms         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ éƒ¨åˆ†æ±‚å€¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç‰¹åŒ–ç­–ç•¥ (ä»…input)   â”‚
â”‚                         â”‚
â”‚   å·²é¢„è®¡ç®—dataéƒ¨åˆ†      â”‚
â”‚   + ç®€åŒ–è§„åˆ™ (10 rules) â”‚
â”‚                         â”‚
â”‚   å†³ç­–æ—¶é—´: 0.1ms       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. éƒ¨åˆ†æ±‚å€¼åŸç†

### 2.1 å·²çŸ¥ä¸æœªçŸ¥

**åˆ†ç±»å˜é‡**ï¼š

```rego
package authz

import rego.v1

# KNOWN (ç¼–è¯‘æ—¶å·²çŸ¥)
default_role := "user"
role_permissions := {
    "admin": ["read", "write", "delete"],
    "user": ["read"]
}

# UNKNOWN (è¿è¡Œæ—¶æä¾›)
allow if {
    user := data.users[input.user_id]      # input.user_id æœªçŸ¥
    user.role in ["admin", "operator"]
    input.action in role_permissions[user.role]
}
```

**çº¦å®š**ï¼š

```bash
# æŒ‡å®šæœªçŸ¥å˜é‡
opa compile \
    --partial \
    --unknowns input \
    policy.rego
```

### 2.2 ç‰¹åŒ–è¿‡ç¨‹

**æ­¥éª¤**ï¼š

```text
1. ç¬¦å·æ‰§è¡Œ
   â””â”€â”€ éå†æ‰€æœ‰å¯èƒ½æ‰§è¡Œè·¯å¾„

2. æ±‚å€¼å·²çŸ¥éƒ¨åˆ†
   â””â”€â”€ æ›¿æ¢dataå¼•ç”¨ä¸ºå…·ä½“å€¼

3. ç®€åŒ–è¡¨è¾¾å¼
   â””â”€â”€ å¸¸é‡æŠ˜å ã€æ­»ä»£ç æ¶ˆé™¤

4. ç”Ÿæˆæ®‹ä½™ä»£ç 
   â””â”€â”€ åªä¿ç•™ä¾èµ–inputçš„éƒ¨åˆ†
```

**ç¤ºä¾‹**ï¼š

```rego
# åŸå§‹ç­–ç•¥
allow if {
    user := data.users[input.user_id]
    user.role == "admin"
    input.action in data.admin_actions
}

# å·²çŸ¥:
#   data.users = {"alice": {"role": "admin"}, "bob": {"role": "user"}}
#   data.admin_actions = ["read", "write", "delete"]

# ç‰¹åŒ–å
allow if {
    input.user_id == "alice"
    input.action in ["read", "write", "delete"]
}
```

### 2.3 æ®‹ä½™ç¨‹åº

**æ®‹ä½™ç¨‹åºç‰¹ç‚¹**ï¼š

```text
1. æ›´å°
   â””â”€â”€ ç§»é™¤äº†æ‰€æœ‰dataå¼•ç”¨

2. æ›´å¿«
   â””â”€â”€ é¢„è®¡ç®—äº†å¸¸é‡éƒ¨åˆ†

3. ç­‰ä»·
   â””â”€â”€ å¯¹äºæ‰€æœ‰inputï¼Œç»“æœç›¸åŒ

4. ç‰¹åŒ–
   â””â”€â”€ ä»…å¯¹ç‰¹å®šdataæœ‰æ•ˆ
```

---

## 3. OPAä¸­çš„éƒ¨åˆ†æ±‚å€¼

### 3.1 ç¼–è¯‘å‘½ä»¤

**åŸºæœ¬ç”¨æ³•**ï¼š

```bash
# ç¼–è¯‘ç­–ç•¥ï¼ŒæŒ‡å®šinputä¸ºæœªçŸ¥
opa build \
    --target wasm \
    --partial \
    --unknowns input \
    -e data.authz.allow \
    policy/

# è¾“å‡º: bundle.tar.gz
```

**è¾“å‡ºå†…å®¹**ï¼š

```text
bundle.tar.gz
â”œâ”€â”€ policy.wasm          # ç‰¹åŒ–åçš„WASM
â”œâ”€â”€ data.json            # æ®‹ä½™æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
â””â”€â”€ .manifest            # Bundleå…ƒæ•°æ®
```

### 3.2 æœªçŸ¥å˜é‡æŒ‡å®š

**å•ä¸ªæœªçŸ¥**ï¼š

```bash
opa compile \
    --partial \
    --unknowns input \
    policy.rego
```

**å¤šä¸ªæœªçŸ¥**ï¼š

```bash
opa compile \
    --partial \
    --unknowns input.user \
    --unknowns input.resource \
    policy.rego
```

**é€šé…ç¬¦**ï¼š

```bash
# input.usersä¸‹çš„æ‰€æœ‰å­—æ®µæœªçŸ¥
opa compile \
    --partial \
    --unknowns 'input.users[_]' \
    policy.rego
```

### 3.3 è¾“å‡ºæ ¼å¼

**æŸ¥çœ‹ç‰¹åŒ–ç»“æœ**ï¼š

```bash
# è¾“å‡ºRegoæ ¼å¼çš„æ®‹ä½™ç­–ç•¥
opa build \
    --partial \
    --unknowns input \
    -e data.authz.allow \
    policy/ \
    -o bundle.tar.gz

tar -xzf bundle.tar.gz
cat policy.rego  # æŸ¥çœ‹ç‰¹åŒ–åçš„ç­–ç•¥
```

---

## 4. ä¼˜åŒ–æ•ˆæœ

### 4.1 ç­–ç•¥å¤§å°

**å®æµ‹æ•°æ®**ï¼š

| åŸå§‹ç­–ç•¥ | æ•°æ®é‡ | å®Œæ•´Bundle | éƒ¨åˆ†æ±‚å€¼Bundle | å‹ç¼©æ¯” |
|---------|-------|-----------|---------------|-------|
| 100KB | 1MB | 1.1MB | 10KB | 110x |
| 500KB | 10MB | 10.5MB | 50KB | 210x |
| 1MB | 100MB | 101MB | 100KB | 1010x |

### 4.2 æ‰§è¡Œé€Ÿåº¦

**æ€§èƒ½å¯¹æ¯”**ï¼š

```text
åœºæ™¯: RBACæˆæƒï¼Œ10,000ç”¨æˆ·

å®Œæ•´ç­–ç•¥:
  P50: 2ms
  P99: 10ms
  ååé‡: 500 req/s

éƒ¨åˆ†æ±‚å€¼:
  P50: 0.05ms (40x faster)
  P99: 0.2ms (50x faster)
  ååé‡: 20,000 req/s (40x faster)
```

### 4.3 é€‚ç”¨åœºæ™¯

**é«˜æ”¶ç›Šåœºæ™¯**ï¼š

```text
âœ… æ•°æ®å˜åŒ–æ…¢ï¼ˆå¤©/å‘¨çº§åˆ«ï¼‰
âœ… ç­–ç•¥å¤æ‚ï¼ˆè§„åˆ™å¤šï¼‰
âœ… æ•°æ®é‡å¤§ï¼ˆMBçº§åˆ«ï¼‰
âœ… æŸ¥è¯¢é¢‘ç¹ï¼ˆåƒ/ç§’ï¼‰
âœ… ä½å»¶è¿Ÿè¦æ±‚ï¼ˆ< 1msï¼‰
```

**ä½æ”¶ç›Šåœºæ™¯**ï¼š

```text
âŒ æ•°æ®é¢‘ç¹å˜åŒ–ï¼ˆåˆ†é’Ÿçº§åˆ«ï¼‰
âŒ ç­–ç•¥ç®€å•ï¼ˆå‡ æ¡è§„åˆ™ï¼‰
âŒ æ•°æ®é‡å°ï¼ˆ<100KBï¼‰
âŒ æŸ¥è¯¢ä¸é¢‘ç¹
âŒ å»¶è¿Ÿè¦æ±‚å®½æ¾ï¼ˆ> 10msï¼‰
```

---

## 5. é«˜çº§æŠ€æœ¯

### 5.1 å±•å¼€å¾ªç¯

**åŸå§‹ç­–ç•¥**ï¼š

```rego
allowed_users := [u |
    some u in data.users
    u.role == "admin"
]
```

**å±•å¼€å**ï¼š

```rego
allowed_users := ["alice", "bob", "charlie"]
# ç›´æ¥ç¡¬ç¼–ç ç»“æœ
```

### 5.2 å‡½æ•°ç‰¹åŒ–

**åŸå§‹ç­–ç•¥**ï¼š

```rego
check_permission(user, action) if {
    action in data.role_permissions[user.role]
}

allow if {
    user := data.users[input.user_id]
    check_permission(user, input.action)
}
```

**ç‰¹åŒ–åï¼ˆå†…è”+ç®€åŒ–ï¼‰**ï¼š

```rego
# é’ˆå¯¹ data.users = {"alice": {"role": "admin"}}
allow if {
    input.user_id == "alice"
    input.action in ["read", "write", "delete"]
}
```

### 5.3 æ•°æ®å†…è”

**åŸå§‹ç­–ç•¥**ï¼š

```rego
allow if {
    input.user_id in data.allowed_users
}
```

**å†…è”å**ï¼š

```rego
allow if {
    input.user_id in {"u1", "u2", "u3", ...}  # ç›´æ¥åµŒå…¥
}
```

---

## 6. WASMéƒ¨ç½²

### 6.1 éƒ¨åˆ†æ±‚å€¼+WASM

**å·¥ä½œæµ**ï¼š

```text
1. å¼€å‘æ—¶: ç¼–å†™ç­–ç•¥ + æµ‹è¯•
   â†“
2. æ„å»ºæ—¶: éƒ¨åˆ†æ±‚å€¼ + ç¼–è¯‘ä¸ºWASM
   opa build --target wasm --partial --unknowns input ...
   â†“
3. éƒ¨ç½²æ—¶: åˆ†å‘è½»é‡çº§WASM bundle
   â†“
4. è¿è¡Œæ—¶: ä»…å¤„ç†inputï¼ˆæå¿«ï¼‰
```

### 6.2 è¾¹ç¼˜è®¡ç®—åœºæ™¯

**CDNè¾¹ç¼˜èŠ‚ç‚¹**ï¼š

```text
éœ€æ±‚:
  - å»¶è¿Ÿ: < 1ms
  - èµ„æº: æœ‰é™ï¼ˆ10MBå†…å­˜ï¼‰
  - ç½‘ç»œ: ä½å¸¦å®½

è§£å†³æ–¹æ¡ˆ:
  1. ä¸­å¿ƒæœåŠ¡å™¨éƒ¨åˆ†æ±‚å€¼
  2. åˆ†å‘å°WASM bundleï¼ˆ< 100KBï¼‰
  3. è¾¹ç¼˜èŠ‚ç‚¹åŠ è½½æ‰§è¡Œ

æ•ˆæœ:
  âœ… æ»¡è¶³å»¶è¿Ÿè¦æ±‚
  âœ… å‡å°‘ç½‘ç»œä¼ è¾“
  âœ… é™ä½èµ„æºæ¶ˆè€—
```

### 6.3 æ€§èƒ½å¯¹æ¯”

| éƒ¨ç½²æ–¹å¼ | Bundleå¤§å° | åŠ è½½æ—¶é—´ | å†³ç­–å»¶è¿Ÿ |
|---------|-----------|---------|---------|
| Native OPA (å®Œæ•´) | 10MB | 500ms | 5ms |
| Native OPA (éƒ¨åˆ†æ±‚å€¼) | 100KB | 20ms | 0.2ms |
| WASM (å®Œæ•´) | 2MB | 100ms | 2ms |
| **WASM (éƒ¨åˆ†æ±‚å€¼)** | **50KB** | **5ms** | **0.1ms** |

---

## 7. å®è·µæ¡ˆä¾‹

### 7.1 RBACç­–ç•¥ä¼˜åŒ–

**åŸå§‹ç­–ç•¥**ï¼š

```rego
package authz

import rego.v1

# æ•°æ®: 10,000ç”¨æˆ·ï¼Œ1,000è§’è‰²
allow if {
    user := data.users[input.user_id]
    some role in user.roles
    some perm in data.role_permissions[role]
    perm.resource == input.resource
    perm.action == input.action
}
```

**éƒ¨åˆ†æ±‚å€¼**ï¼š

```bash
opa build \
    --target wasm \
    --partial \
    --unknowns input \
    -e data.authz.allow \
    policy/ data/

# data/ åŒ…å«10,000ç”¨æˆ·å’Œ1,000è§’è‰²æ•°æ®
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š

```text
åŸå§‹:
  Bundle: 15MB
  å†³ç­–: 10ms

ä¼˜åŒ–å:
  Bundle: 200KB (75x reduction)
  å†³ç­–: 0.2ms (50x faster)
```

### 7.2 Kuberneteså‡†å…¥æ§åˆ¶

**åœºæ™¯**ï¼šéªŒè¯Podå®‰å…¨ç­–ç•¥

**ç­–ç•¥**ï¼š

```rego
package k8s.admission

import rego.v1

# å·²çŸ¥: å®‰å…¨åŸºçº¿ç­–ç•¥
deny[msg] if {
    input.request.kind.kind == "Pod"
    container := input.request.object.spec.containers[_]
    not container.securityContext.runAsNonRoot
    msg := sprintf("å®¹å™¨å¿…é¡»ä»¥érootç”¨æˆ·è¿è¡Œ: %s", [container.name])
}
```

**éƒ¨åˆ†æ±‚å€¼**ï¼š

```bash
# å·²çŸ¥: data.security_baseline
# æœªçŸ¥: input.request

opa build \
    --target wasm \
    --partial \
    --unknowns input.request \
    policy/
```

**éƒ¨ç½²**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-policy
  namespace: opa
data:
  policy.wasm: |
    <base64-encoded-wasm>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opa
spec:
  template:
    spec:
      containers:
      - name: opa
        image: openpolicyagent/opa:latest-static
        args:
          - "run"
          - "--server"
          - "/policies/policy.wasm"
        volumeMounts:
        - name: policy
          mountPath: /policies
      volumes:
      - name: policy
        configMap:
          name: opa-policy
```

### 7.3 APIç½‘å…³æˆæƒ

**åœºæ™¯**ï¼šé«˜å¹¶å‘APIæˆæƒ

**ç­–ç•¥**ï¼š

```rego
package api.authz

import rego.v1

# 10,000ä¸ªAPIè·¯ç”±ï¼Œ5,000ä¸ªç”¨æˆ·
allow if {
    route := data.routes[input.path]
    user := data.users[input.user_id]
    route.required_role in user.roles
}
```

**ä¼˜åŒ–æµç¨‹**ï¼š

```bash
# 1. æ•°æ®å‡†å¤‡
cat > data.json <<EOF
{
  "routes": {...},  # 10,000æ¡
  "users": {...}    # 5,000æ¡
}
EOF

# 2. éƒ¨åˆ†æ±‚å€¼
opa build \
    --target wasm \
    --partial \
    --unknowns input \
    -e data.api.authz.allow \
    policy/ data.json \
    -o api-authz.tar.gz

# 3. éƒ¨ç½²åˆ°ç½‘å…³
# Bundleå¤§å°: 15MB â†’ 150KB
# å†³ç­–å»¶è¿Ÿ: 5ms â†’ 0.15ms
```

---

## 8. å±€é™æ€§

### 8.1 é€‚ç”¨é™åˆ¶

**ä¸é€‚ç”¨æƒ…å†µ**ï¼š

```rego
# 1. ä¾èµ–è¿è¡Œæ—¶å‡½æ•°
allow if {
    time.now_ns() < data.expiry  # time.now_ns()è¿è¡Œæ—¶å˜åŒ–
}

# 2. ä¾èµ–å¤–éƒ¨è°ƒç”¨
allow if {
    response := http.send({"url": data.api_endpoint})
    response.status_code == 200
}

# 3. å¤æ‚åŠ¨æ€æŸ¥è¯¢
allow if {
    path := input.nested.deep.path[_][_]
    data.complex_structure[path] == input.value
}
```

### 8.2 æ€§èƒ½æƒè¡¡

**Trade-offs**ï¼š

```text
ä¼˜ç‚¹:
  âœ… è¿è¡Œæ—¶æå¿«
  âœ… Bundleæå°
  âœ… å‡å°‘ç½‘ç»œä¼ è¾“

ç¼ºç‚¹:
  âŒ ç¼–è¯‘æ—¶é—´é•¿ï¼ˆæ•°æ®å¤§æ—¶ï¼‰
  âŒ æ•°æ®å˜æ›´éœ€é‡æ–°ç¼–è¯‘
  âŒ è°ƒè¯•å›°éš¾ï¼ˆä»£ç ç‰¹åŒ–åï¼‰
  âŒ çµæ´»æ€§é™ä½
```

### 8.3 è°ƒè¯•å›°éš¾

**é—®é¢˜**ï¼š

```text
1. æºç æ˜ å°„ä¸¢å¤±
   â””â”€â”€ ç‰¹åŒ–åä»£ç ä¸åŸå§‹ä»£ç å·®å¼‚å¤§

2. ä¸­é—´çŠ¶æ€ä¸å¯è§
   â””â”€â”€ æ•°æ®å·²å†…è”ï¼Œæ— æ³•æŸ¥çœ‹

3. é”™è¯¯å®šä½å›°éš¾
   â””â”€â”€ é”™è¯¯ä¿¡æ¯æŒ‡å‘ç‰¹åŒ–åä»£ç 
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# 1. å¼€å‘é˜¶æ®µä½¿ç”¨Native OPA
opa eval -d policy.rego -i input.json 'data.authz.allow'

# 2. ä¿ç•™åŸå§‹ç­–ç•¥ç”¨äºè°ƒè¯•
opa test policy/ -v

# 3. éƒ¨åˆ†æ±‚å€¼å‰å……åˆ†æµ‹è¯•
opa test policy/ --coverage --threshold=90
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 ä½•æ—¶ä½¿ç”¨

**å†³ç­–æ ‘**ï¼š

```text
æ•°æ®å˜åŒ–é¢‘ç‡?
â”œâ”€ å°æ—¶/å¤©/å‘¨ â†’ è€ƒè™‘éƒ¨åˆ†æ±‚å€¼
â”‚  â””â”€ æ•°æ®å¤§å°?
â”‚     â”œâ”€ > 1MB â†’ å¼ºçƒˆæ¨è
â”‚     â””â”€ < 100KB â†’ å¯é€‰
â”‚
â””â”€ åˆ†é’Ÿ/ç§’ â†’ ä¸æ¨è
   â””â”€ ä½¿ç”¨ç¼“å­˜æˆ–æ•°æ®åˆ†ç‰‡
```

### 9.2 ç­–ç•¥è®¾è®¡

**å‹å¥½çš„ç­–ç•¥ç»“æ„**ï¼š

```rego
# âœ… å¥½: æ¸…æ™°åˆ†ç¦»dataå’Œinput
allow if {
    # 1. åŠ è½½æ•°æ®ï¼ˆå¯éƒ¨åˆ†æ±‚å€¼ï¼‰
    user := data.users[input.user_id]
    permissions := data.role_permissions[user.role]
    
    # 2. æ£€æŸ¥inputï¼ˆè¿è¡Œæ—¶ï¼‰
    input.action in permissions
}

# âŒ å·®: æ··åˆdataå’Œinput
allow if {
    some user in data.users  # éå†æ‰€æœ‰ç”¨æˆ·
    user.id == input.user_id
    input.action in user.permissions
}
```

### 9.3 æµ‹è¯•éªŒè¯

**éªŒè¯æµç¨‹**ï¼š

```bash
# 1. åŸå§‹ç­–ç•¥æµ‹è¯•
opa test policy/ -v

# 2. éƒ¨åˆ†æ±‚å€¼
opa build --partial --unknowns input policy/ data/

# 3. éªŒè¯ç­‰ä»·æ€§
opa eval -b bundle.tar.gz -i test_input1.json
opa eval -d policy/ -i test_input1.json
# æ¯”è¾ƒç»“æœæ˜¯å¦ç›¸åŒ

# 4. æ€§èƒ½æµ‹è¯•
opa bench bundle.tar.gz -i test_inputs/
```

---

## 10. æœªæ¥å‘å±•

### 10.1 JITç¼–è¯‘

**æ¦‚å¿µ**ï¼š

```text
è¿è¡Œæ—¶JIT (Just-In-Time) ç¼–è¯‘:
1. è¯†åˆ«çƒ­ç‚¹ç­–ç•¥
2. åŠ¨æ€éƒ¨åˆ†æ±‚å€¼
3. ç¼–è¯‘ä¸ºæœºå™¨ç 
4. ç¼“å­˜ç¼–è¯‘ç»“æœ

æ•ˆæœ: æ¥è¿‘é™æ€ç¼–è¯‘æ€§èƒ½ï¼Œä¿æŒåŠ¨æ€çµæ´»æ€§
```

### 10.2 è‡ªé€‚åº”ä¼˜åŒ–

**è‡ªé€‚åº”ç‰¹åŒ–**ï¼š

```text
æ ¹æ®è¿è¡Œæ—¶ç»Ÿè®¡è‡ªåŠ¨ä¼˜åŒ–:
1. æ”¶é›†inputåˆ†å¸ƒ
2. è¯†åˆ«å¸¸è§æ¨¡å¼
3. é’ˆå¯¹æ€§ç‰¹åŒ–
4. åŠ¨æ€åˆ‡æ¢ç­–ç•¥

ç¤ºä¾‹:
  - 90%è¯·æ±‚æ¥è‡ªadminç”¨æˆ·
  â†’ ç‰¹åŒ–adminè·¯å¾„
```

### 10.3 AIè¾…åŠ©ç‰¹åŒ–

**æœºå™¨å­¦ä¹ ä¼˜åŒ–**ï¼š

```text
ä½¿ç”¨MLé¢„æµ‹ä¼˜åŒ–ç­–ç•¥:
1. åˆ†æå†å²æŸ¥è¯¢
2. é¢„æµ‹çƒ­ç‚¹æ•°æ®
3. è‡ªåŠ¨ç”Ÿæˆç‰¹åŒ–ç­–ç•¥
4. A/Bæµ‹è¯•æ•ˆæœ

æ½œåŠ›: è‡ªåŠ¨åŒ–ä¼˜åŒ–è¿‡ç¨‹
```

---

## é™„å½•Aï¼šç†è®ºåŸºç¡€

**FutamuraæŠ•å½±**ï¼š

```text
ä¸‰ä¸ªæŠ•å½±å±‚æ¬¡:

ç¬¬ä¸€FutamuraæŠ•å½±:
  [[P]]_Iâ‚ = P'
  (ç¨‹åºç‰¹åŒ–)

ç¬¬äºŒFutamuraæŠ•å½±:
  [[Eval]]_P = Compiler_P
  (ç¼–è¯‘å™¨ç”Ÿæˆ)

ç¬¬ä¸‰FutamuraæŠ•å½±:
  [[Eval]]_Eval = Compiler-Compiler
  (ç¼–è¯‘å™¨ç”Ÿæˆå™¨)

OPAå®ç°: ç¬¬ä¸€æŠ•å½±
```

---

## é™„å½•Bï¼šå®ç°ç»†èŠ‚

**ç‰¹åŒ–ç®—æ³•ï¼ˆç®€åŒ–ï¼‰**ï¼š

```go
func PartialEval(policy *Policy, knownData map[string]interface{}) *Policy {
    residual := &Policy{}
    
    for _, rule := range policy.Rules {
        // 1. æ›¿æ¢dataå¼•ç”¨
        specialized := substituteData(rule, knownData)
        
        // 2. ç®€åŒ–è¡¨è¾¾å¼
        simplified := simplify(specialized)
        
        // 3. æ£€æŸ¥æ˜¯å¦å®Œå…¨æ±‚å€¼
        if isFullyEvaluated(simplified) {
            // ç›´æ¥æ·»åŠ ç»“æœ
            residual.addConstant(rule.Head, simplified.Value)
        } else {
            // ä¿ç•™æ®‹ä½™è§„åˆ™
            residual.addRule(simplified)
        }
    }
    
    return residual
}

func substituteData(rule *Rule, data map[string]interface{}) *Rule {
    newRule := rule.Clone()
    
    for _, expr := range newRule.Body {
        if ref, ok := expr.(*DataRef); ok {
            // æ›¿æ¢ data.x ä¸ºå…·ä½“å€¼
            value := resolve(data, ref.Path)
            newRule.replaceExpr(expr, &Constant{Value: value})
        }
    }
    
    return newRule
}

func simplify(rule *Rule) *Rule {
    // å¸¸é‡æŠ˜å 
    rule = constantFold(rule)
    
    // æ­»ä»£ç æ¶ˆé™¤
    rule = deadCodeElimination(rule)
    
    // è¡¨è¾¾å¼åŒ–ç®€
    rule = simplifyExpressions(rule)
    
    return rule
}
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [ç¼–è¯‘å™¨è®¾è®¡](./03.3-ç¼–è¯‘å™¨è®¾è®¡.md)
- [ç´¢å¼•ä¸ä¼˜åŒ–](./03.5-ç´¢å¼•ä¸ä¼˜åŒ–.md)
- [WASMç¼–è¯‘è§„èŒƒ](../01-æŠ€æœ¯è§„èŒƒ/01.3-WASMç¼–è¯‘è§„èŒƒ.md)

**å‚è€ƒèµ„æº**ï¼š

- Partial Evaluation: <https://www.openpolicyagent.org/docs/latest/policy-performance/#partial-evaluation>
- WASM Compilation: <https://www.openpolicyagent.org/docs/latest/wasm/>
- Futamura Projections: <https://en.wikipedia.org/wiki/Partial_evaluation>
