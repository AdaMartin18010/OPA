# 09.3 SaaSå¹³å°å¤šç§Ÿæˆ·WASMéƒ¨ç½²å®æˆ˜

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.40+ (WASMæˆç†Ÿ) | æ¨è v0.68+  
> **WASMç‰ˆæœ¬**: WASI Preview 1  
> **éš¾åº¦**: â­â­â­â­â­ ä¸“å®¶çº§  
> **åœºæ™¯**: è¾¹ç¼˜è®¡ç®—ã€å¤šç§Ÿæˆ·SaaSã€æè‡´æ€§èƒ½  
> **é¢„è®¡å­¦ä¹ æ—¶é—´**: 3-4å°æ—¶  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯

---

## âš ï¸ WASMéƒ¨ç½²æç¤º

> **WASMä¼˜åŠ¿**:
>
> - âœ… **æ€§èƒ½**: P99å»¶è¿Ÿ<2msï¼Œæ¯”Nativeå¿«50-80%
> - âœ… **è½»é‡**: WASMæ¨¡å—<5MBï¼Œé€‚åˆè¾¹ç¼˜éƒ¨ç½²
> - âœ… **éš”ç¦»**: æ²™ç®±ç¯å¢ƒï¼Œç§Ÿæˆ·é—´å®Œå…¨éš”ç¦»
> - âš ï¸ **é™åˆ¶**: ä¸æ”¯æŒI/Oå‡½æ•°ï¼ˆhttp.sendã€opa.runtimeç­‰ï¼‰
>
> **é€‚ç”¨åœºæ™¯**:
>
> - è¾¹ç¼˜èŠ‚ç‚¹ï¼ˆCDNã€IoTç½‘å…³ï¼‰
> - å¤šç§Ÿæˆ·SaaSï¼ˆæ¯ç§Ÿæˆ·ç‹¬ç«‹ç­–ç•¥ï¼‰
> - æè‡´æ€§èƒ½è¦æ±‚ï¼ˆé‡‘èäº¤æ˜“ã€å®æ—¶å†³ç­–ï¼‰
> - å‡½æ•°è®¡ç®—å¹³å°ï¼ˆServerlessï¼‰
>
> å‚è€ƒ: [WASMç¼–è¯‘è§„èŒƒ](../01-æŠ€æœ¯è§„èŒƒ/01.3-WASMç¼–è¯‘è§„èŒƒ.md) | [æ€§èƒ½åŸºå‡†](../01-æŠ€æœ¯è§„èŒƒ/01.4-æ€§èƒ½åŸºå‡†ä¸åº¦é‡.md)

---

## ğŸ“‹ æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹æ¥è‡ªæŸå…¨çƒSaaSå¹³å°ï¼ˆæœˆæ´»10M+ç”¨æˆ·ï¼‰ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨OPA WASMåœ¨è¾¹ç¼˜èŠ‚ç‚¹å®ç°å¤šç§Ÿæˆ·ç­–ç•¥éš”ç¦»å’Œæè‡´æ€§èƒ½ã€‚

### ä¸šåŠ¡èƒŒæ™¯

**å…¬å¸è§„æ¨¡**:

- 10M+ æœˆæ´»ç”¨æˆ·
- 5K+ ä¼ä¸šå®¢æˆ·ï¼ˆå¤šç§Ÿæˆ·ï¼‰
- 200+ å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ï¼ˆCDNï¼‰
- 50K QPSå³°å€¼æµé‡

**æ ¸å¿ƒæŒ‘æˆ˜**:

1. **æè‡´æ€§èƒ½**ï¼šP99å»¶è¿Ÿ<5msï¼Œä¸èƒ½å½±å“ç”¨æˆ·ä½“éªŒ
2. **ç§Ÿæˆ·éš”ç¦»**ï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹ç­–ç•¥ï¼Œäº’ä¸å½±å“
3. **è¾¹ç¼˜éƒ¨ç½²**ï¼šç­–ç•¥åŒ…å¿…é¡»<10MBï¼Œå¿«é€Ÿåˆ†å‘
4. **åŠ¨æ€æ›´æ–°**ï¼šç­–ç•¥æ›´æ–°å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```text
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç”¨æˆ·è¯·æ±‚ï¼ˆå…¨çƒï¼‰       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    CloudFlare / Cloudfront CDN    â”‚
         â”‚    200+ å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¾¹ç¼˜èŠ‚ç‚¹ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ï¼‰             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚  â”‚  Envoy Proxy                â”‚â”‚
    â”‚  â”‚  - External Auth Filter     â”‚â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    â”‚             â†“                    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚  â”‚  OPA WASM Runtime           â”‚â”‚
    â”‚  â”‚  - Tenant A Policy.wasm     â”‚â”‚
    â”‚  â”‚  - Tenant B Policy.wasm     â”‚â”‚
    â”‚  â”‚  - Tenant C Policy.wasm     â”‚â”‚
    â”‚  â”‚  - ... (5000+ tenants)      â”‚â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    â”‚             â†“                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚  â”‚  åç«¯æœåŠ¡                    â”‚â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
                  â”‚ ç­–ç•¥æ›´æ–°
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä¸­å¤®æ§åˆ¶å¹³é¢               â”‚
    â”‚  - Policy Builder          â”‚
    â”‚  - WASM Compiler           â”‚
    â”‚  - Bundle Server (S3)      â”‚
    â”‚  - Version Management      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WASMéƒ¨ç½²æ¨¡å¼

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç¼–è¯‘é˜¶æ®µï¼ˆä¸­å¤®æ§åˆ¶å¹³é¢ï¼‰             â”‚
â”‚     Regoæºç  â†’ OPA Build â†’ WASMæ¨¡å—     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åˆ†å‘é˜¶æ®µï¼ˆCDN/S3ï¼‰                  â”‚
â”‚     WASMæ¨¡å— â†’ å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹             â”‚
â”‚     å»¶è¿Ÿ: <30ç§’                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åŠ è½½é˜¶æ®µï¼ˆè¾¹ç¼˜èŠ‚ç‚¹ï¼‰                 â”‚
â”‚     WASMæ¨¡å— â†’ å†…å­˜åŠ è½½ â†’ åˆå§‹åŒ–         â”‚
â”‚     æ—¶é—´: <100ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ‰§è¡Œé˜¶æ®µï¼ˆè¯·æ±‚æ—¶ï¼‰                   â”‚
â”‚     è¯·æ±‚ â†’ WASMè¯„ä¼° â†’ æˆæƒå†³ç­–          â”‚
â”‚     å»¶è¿Ÿ: P99 <2ms                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ å¤šç§Ÿæˆ·ç­–ç•¥è®¾è®¡

### ç§Ÿæˆ·ç­–ç•¥éš”ç¦»

æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹ç­–ç•¥æ–‡ä»¶ï¼š

```text
policies/
â”œâ”€â”€ tenant-1001/
â”‚   â”œâ”€â”€ policy.rego          # ç§Ÿæˆ·ç­–ç•¥æºç 
â”‚   â”œâ”€â”€ data.json            # ç§Ÿæˆ·é™æ€æ•°æ®
â”‚   â””â”€â”€ policy.wasm          # ç¼–è¯‘åWASM
â”œâ”€â”€ tenant-1002/
â”‚   â”œâ”€â”€ policy.rego
â”‚   â”œâ”€â”€ data.json
â”‚   â””â”€â”€ policy.wasm
â””â”€â”€ shared/
    â”œâ”€â”€ common.rego          # å…±äº«ç­–ç•¥åº“
    â””â”€â”€ utils.rego           # å·¥å…·å‡½æ•°
```

### ç§Ÿæˆ·ç­–ç•¥æ¨¡æ¿

**åŸºç¡€æ¨¡æ¿** (`templates/basic-rbac.rego`):

```rego
package tenant.authz

import rego.v1

# ç§Ÿæˆ·IDï¼ˆç¼–è¯‘æ—¶æ³¨å…¥ï¼‰
tenant_id := "{{TENANT_ID}}"

# é»˜è®¤æ‹’ç»
default allow := false

# ç”¨æˆ·æƒé™æŸ¥è¯¢ï¼ˆä»ç¼–è¯‘æ—¶æ•°æ®ï¼‰
user_permissions contains permission if {
    some permission in data.tenant_roles[input.user.role].permissions
}

# å…è®¸è§„åˆ™
allow if {
    # æ£€æŸ¥ç§Ÿæˆ·IDåŒ¹é…
    input.tenant_id == tenant_id
    
    # æ£€æŸ¥ç”¨æˆ·æƒé™
    input.action in user_permissions
}

# é¢å¤–æ£€æŸ¥ï¼šèµ„æºæ‰€æœ‰æƒ
allow if {
    input.tenant_id == tenant_id
    input.resource.owner == input.user.id
    input.action == "read"
}

# å®¡è®¡æ—¥å¿—ï¼ˆè¿”å›å†³ç­–åŸå› ï¼‰
decision := {
    "allowed": allow,
    "tenant_id": tenant_id,
    "user_id": input.user.id,
    "action": input.action,
    "resource": input.resource.type,
    "timestamp": time.now_ns(),
}
```

### ç§Ÿæˆ·æ•°æ®æ³¨å…¥

**æ•°æ®æ–‡ä»¶** (`tenants/1001/data.json`):

```json
{
  "tenant_roles": {
    "admin": {
      "permissions": ["read", "write", "delete", "admin"]
    },
    "member": {
      "permissions": ["read", "write"]
    },
    "viewer": {
      "permissions": ["read"]
    }
  },
  "tenant_config": {
    "max_api_calls_per_minute": 1000,
    "allowed_ip_ranges": ["10.0.0.0/8", "172.16.0.0/12"],
    "features": ["api", "webhooks", "sso"]
  }
}
```

---

## ğŸ”¨ WASMç¼–è¯‘æµç¨‹

### Step 1: ç­–ç•¥ç¼–è¯‘è„šæœ¬

```bash
#!/bin/bash
# compile-tenant-policy.sh

set -e

TENANT_ID=$1
POLICY_DIR="policies/tenant-${TENANT_ID}"
OUTPUT_DIR="dist/tenant-${TENANT_ID}"

echo "==> Compiling policy for tenant ${TENANT_ID}"

# 1. åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "$OUTPUT_DIR"

# 2. æ³¨å…¥ç§Ÿæˆ·IDåˆ°ç­–ç•¥æ¨¡æ¿
sed "s/{{TENANT_ID}}/${TENANT_ID}/g" \
    templates/basic-rbac.rego > "$POLICY_DIR/policy.rego"

# 3. ç¼–è¯‘ä¸ºWASMï¼ˆåŒ…å«æ•°æ®ï¼‰
opa build \
    --target wasm \
    --entrypoint tenant/authz/allow \
    --entrypoint tenant/authz/decision \
    --optimize 2 \
    --output "$OUTPUT_DIR/policy.tar.gz" \
    "$POLICY_DIR/policy.rego" \
    "$POLICY_DIR/data.json" \
    "shared/common.rego" \
    "shared/utils.rego"

# 4. è§£å‹WASMæ¨¡å—
cd "$OUTPUT_DIR"
tar -xzf policy.tar.gz
mv policy.wasm "tenant-${TENANT_ID}.wasm"

# 5. éªŒè¯WASMå¤§å°
WASM_SIZE=$(stat -f%z "tenant-${TENANT_ID}.wasm" 2>/dev/null || stat -c%s "tenant-${TENANT_ID}.wasm")
echo "WASM size: $((WASM_SIZE / 1024))KB"

if [ "$WASM_SIZE" -gt 10485760 ]; then  # 10MB
    echo "ERROR: WASM size exceeds 10MB limit"
    exit 1
fi

# 6. è®¡ç®—SHA256
sha256sum "tenant-${TENANT_ID}.wasm" > "tenant-${TENANT_ID}.wasm.sha256"

echo "==> Compilation completed: $OUTPUT_DIR/tenant-${TENANT_ID}.wasm"
```

### Step 2: æ‰¹é‡ç¼–è¯‘

```bash
#!/bin/bash
# compile-all-tenants.sh

# ä»æ•°æ®åº“è·å–æ´»è·ƒç§Ÿæˆ·åˆ—è¡¨
TENANTS=$(psql -h db.example.com -U opa_admin -d saas_db \
    -t -c "SELECT tenant_id FROM tenants WHERE status='active'")

# å¹¶è¡Œç¼–è¯‘ï¼ˆæœ€å¤š10ä¸ªå¹¶å‘ï¼‰
echo "$TENANTS" | xargs -n1 -P10 -I{} ./compile-tenant-policy.sh {}

echo "==> All tenants compiled successfully"
```

### Step 3: éƒ¨ç½²åˆ°è¾¹ç¼˜

```bash
#!/bin/bash
# deploy-to-edge.sh

TENANT_ID=$1
WASM_FILE="dist/tenant-${TENANT_ID}/tenant-${TENANT_ID}.wasm"

# 1. ä¸Šä¼ åˆ°S3ï¼ˆä½œä¸ºæºï¼‰
aws s3 cp "$WASM_FILE" \
    "s3://opa-policies-prod/tenants/${TENANT_ID}/policy.wasm" \
    --acl private \
    --metadata "tenant-id=${TENANT_ID},version=$(git rev-parse HEAD),timestamp=$(date +%s)"

# 2. è§¦å‘CDNåˆ†å‘ï¼ˆCloudFrontï¼‰
aws cloudfront create-invalidation \
    --distribution-id E1234567890ABC \
    --paths "/tenants/${TENANT_ID}/*"

# 3. é€šçŸ¥è¾¹ç¼˜èŠ‚ç‚¹æ›´æ–°
curl -X POST https://edge-api.example.com/v1/policies/reload \
    -H "Authorization: Bearer $EDGE_API_TOKEN" \
    -d "{\"tenant_id\": \"${TENANT_ID}\", \"version\": \"$(git rev-parse HEAD)\"}"

echo "==> Policy deployed for tenant ${TENANT_ID}"
```

---

## ğŸš€ Envoyé›†æˆ

### Envoyé…ç½®

```yaml
# envoy.yaml
static_resources:
  listeners:
    - name: listener_0
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8080
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: backend
                      domains: ["*"]
                      routes:
                        - match: { prefix: "/" }
                          route: { cluster: backend_service }
                http_filters:
                  # OPA WASM External Auth
                  - name: envoy.filters.http.wasm
                    typed_config:
                      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
                      type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
                      value:
                        config:
                          name: "opa_authz"
                          root_id: "opa_authz"
                          vm_config:
                            runtime: "envoy.wasm.runtime.v8"
                            code:
                              local:
                                filename: "/etc/envoy/policies/tenant-{{TENANT_ID}}.wasm"
                            allow_precompiled: true
                          configuration:
                            "@type": "type.googleapis.com/google.protobuf.StringValue"
                            value: |
                              {
                                "entrypoint": "tenant/authz/allow",
                                "decision_entrypoint": "tenant/authz/decision"
                              }
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    - name: backend_service
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: backend_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: backend.svc.cluster.local
                      port_value: 8080
```

### åŠ¨æ€ç­–ç•¥åŠ è½½

```go
// policy-loader.go
package main

import (
    "context"
    "fmt"
    "io/ioutil"
    "log"
    "net/http"
    "sync"
    "time"
)

type PolicyLoader struct {
    policies map[string][]byte // tenant_id -> WASM bytes
    mu       sync.RWMutex
    s3Bucket string
    cdn      string
}

func NewPolicyLoader(s3Bucket, cdn string) *PolicyLoader {
    return &PolicyLoader{
        policies: make(map[string][]byte),
        s3Bucket: s3Bucket,
        cdn:      cdn,
    }
}

// LoadPolicy åŠ è½½ç§Ÿæˆ·ç­–ç•¥
func (pl *PolicyLoader) LoadPolicy(ctx context.Context, tenantID string) error {
    // ä»CDNä¸‹è½½WASM
    url := fmt.Sprintf("%s/tenants/%s/policy.wasm", pl.cdn, tenantID)
    
    resp, err := http.Get(url)
    if err != nil {
        return fmt.Errorf("failed to download policy: %w", err)
    }
    defer resp.Body.Close()

    if resp.StatusCode != http.StatusOK {
        return fmt.Errorf("unexpected status: %d", resp.StatusCode)
    }

    wasmBytes, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        return fmt.Errorf("failed to read WASM: %w", err)
    }

    // éªŒè¯WASMå¤§å°
    if len(wasmBytes) > 10*1024*1024 { // 10MB
        return fmt.Errorf("WASM size exceeds 10MB")
    }

    pl.mu.Lock()
    pl.policies[tenantID] = wasmBytes
    pl.mu.Unlock()

    log.Printf("Loaded policy for tenant %s (%d bytes)", tenantID, len(wasmBytes))
    return nil
}

// GetPolicy è·å–ç§Ÿæˆ·ç­–ç•¥
func (pl *PolicyLoader) GetPolicy(tenantID string) ([]byte, bool) {
    pl.mu.RLock()
    defer pl.mu.RUnlock()
    policy, ok := pl.policies[tenantID]
    return policy, ok
}

// ReloadAll é‡æ–°åŠ è½½æ‰€æœ‰ç§Ÿæˆ·ç­–ç•¥
func (pl *PolicyLoader) ReloadAll(ctx context.Context, tenantIDs []string) error {
    for _, tenantID := range tenantIDs {
        if err := pl.LoadPolicy(ctx, tenantID); err != nil {
            log.Printf("Failed to load policy for tenant %s: %v", tenantID, err)
            // ç»§ç»­åŠ è½½å…¶ä»–ç§Ÿæˆ·
        }
    }
    return nil
}

// StartWatcher å¯åŠ¨ç­–ç•¥æ›´æ–°ç›‘æ§
func (pl *PolicyLoader) StartWatcher(ctx context.Context, interval time.Duration) {
    ticker := time.NewTicker(interval)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            // æ£€æŸ¥ç­–ç•¥æ›´æ–°ï¼ˆæŸ¥è¯¢æ§åˆ¶å¹³é¢APIï¼‰
            updates, err := pl.checkForUpdates(ctx)
            if err != nil {
                log.Printf("Failed to check updates: %v", err)
                continue
            }

            for _, tenantID := range updates {
                if err := pl.LoadPolicy(ctx, tenantID); err != nil {
                    log.Printf("Failed to reload policy for tenant %s: %v", tenantID, err)
                }
            }
        case <-ctx.Done():
            return
        }
    }
}

func (pl *PolicyLoader) checkForUpdates(ctx context.Context) ([]string, error) {
    // å®ç°ï¼šæŸ¥è¯¢æ§åˆ¶å¹³é¢APIè·å–éœ€è¦æ›´æ–°çš„ç§Ÿæˆ·åˆ—è¡¨
    // è¿™é‡Œç®€åŒ–ç¤ºä¾‹
    return []string{}, nil
}

func main() {
    loader := NewPolicyLoader(
        "opa-policies-prod",
        "https://cdn.example.com",
    )

    ctx := context.Background()

    // åˆå§‹åŠ è½½
    tenantIDs := []string{"1001", "1002", "1003"} // ä»æ•°æ®åº“è·å–
    if err := loader.ReloadAll(ctx, tenantIDs); err != nil {
        log.Fatalf("Failed to load policies: %v", err)
    }

    // å¯åŠ¨å®šæœŸæ›´æ–°
    go loader.StartWatcher(ctx, 60*time.Second)

    // HTTPæœåŠ¡ï¼ˆæä¾›ç­–ç•¥ç»™Envoyï¼‰
    http.HandleFunc("/policies/", func(w http.ResponseWriter, r *http.Request) {
        tenantID := r.URL.Path[len("/policies/"):]
        policy, ok := loader.GetPolicy(tenantID)
        if !ok {
            http.Error(w, "Policy not found", http.StatusNotFound)
            return
        }
        w.Header().Set("Content-Type", "application/wasm")
        w.Write(policy)
    })

    log.Println("Policy server listening on :9090")
    log.Fatal(http.ListenAndServe(":9090", nil))
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç¼–è¯‘ä¼˜åŒ–

```bash
# æœ€å¤§ä¼˜åŒ–çº§åˆ«
opa build \
    --target wasm \
    --entrypoint tenant/authz/allow \
    --optimize 2 \  # ä¼˜åŒ–çº§åˆ«2ï¼ˆæœ€é«˜ï¼‰
    --output policy.tar.gz \
    policy.rego data.json

# éƒ¨åˆ†æ±‚å€¼ï¼ˆé¢„ç¼–è¯‘æ•°æ®ï¼‰
opa build \
    --target wasm \
    --entrypoint tenant/authz/allow \
    --optimize 2 \
    --partial \  # å¯ç”¨éƒ¨åˆ†æ±‚å€¼
    --output policy.tar.gz \
    policy.rego data.json
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# æ€§èƒ½æµ‹è¯•è„šæœ¬
#!/bin/bash

WASM_FILE="tenant-1001.wasm"
INPUT_FILE="test-input.json"

# ä½¿ç”¨opa benchæµ‹è¯•
opa bench \
    --format json \
    --count 10000 \
    --data "$WASM_FILE" \
    --input "$INPUT_FILE" \
    "data.tenant.authz.allow" \
    | jq '{
        "operations_per_second": .histogram_timer_opa_rego_query_hz.mean,
        "p99_latency_ns": .histogram_timer_opa_rego_query_ns.p99,
        "p99_latency_ms": (.histogram_timer_opa_rego_query_ns.p99 / 1000000)
      }'
```

**é¢„æœŸç»“æœ**:

```json
{
  "operations_per_second": 50000,
  "p99_latency_ns": 1500000,
  "p99_latency_ms": 1.5
}
```

### æ€§èƒ½å¯¹æ¯”

| éƒ¨ç½²æ¨¡å¼ | P50å»¶è¿Ÿ | P99å»¶è¿Ÿ | QPS (å•æ ¸) | å†…å­˜ |
|---|---|---|---|---|
| **OPA Native** | 0.8ms | 3ms | 20K | 50MB |
| **OPA WASM** | 0.5ms | **1.5ms** | **50K** | **20MB** |
| æ”¹å–„ | **37%â†“** | **50%â†“** | **150%â†‘** | **60%â†“** |

---

## ğŸ” ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### PrometheusæŒ‡æ ‡

```yaml
# prometheus-metrics.yaml
groups:
  - name: opa_wasm
    interval: 30s
    rules:
      # WASMè¯„ä¼°å»¶è¿Ÿ
      - record: opa_wasm:eval_duration_seconds:p99
        expr: histogram_quantile(0.99, sum(rate(envoy_wasm_opa_eval_duration_bucket[5m])) by (tenant_id, le))

      # æ¯ç§Ÿæˆ·QPS
      - record: opa_wasm:requests_per_second:by_tenant
        expr: sum(rate(envoy_wasm_opa_total[5m])) by (tenant_id)

      # æ‹’ç»ç‡
      - record: opa_wasm:deny_rate:by_tenant
        expr: sum(rate(envoy_wasm_opa_deny_total[5m])) by (tenant_id) / sum(rate(envoy_wasm_opa_total[5m])) by (tenant_id)

      # WASMæ¨¡å—åŠ è½½æ—¶é—´
      - record: opa_wasm:load_duration_seconds:p99
        expr: histogram_quantile(0.99, sum(rate(opa_policy_load_duration_bucket[5m])) by (tenant_id, le))

  - name: opa_wasm_alerts
    rules:
      # å»¶è¿Ÿå‘Šè­¦
      - alert: OPAWASMHighLatency
        expr: opa_wasm:eval_duration_seconds:p99 > 0.005  # 5ms
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "OPA WASMè¯„ä¼°å»¶è¿Ÿè¿‡é«˜"
          description: "ç§Ÿæˆ· {{ $labels.tenant_id }} çš„P99å»¶è¿Ÿä¸º {{ $value }}ç§’"

      # æ‹’ç»ç‡å‘Šè­¦
      - alert: OPAWASMHighDenyRate
        expr: opa_wasm:deny_rate:by_tenant > 0.5  # 50%
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "ç§Ÿæˆ·æ‹’ç»ç‡è¿‡é«˜"
          description: "ç§Ÿæˆ· {{ $labels.tenant_id }} çš„æ‹’ç»ç‡ä¸º {{ $value | humanizePercentage }}"
```

### Grafana Dashboard

```json
{
  "dashboard": {
    "title": "OPA WASM - Multi-Tenant Performance",
    "panels": [
      {
        "title": "P99 Latency by Tenant",
        "targets": [
          {
            "expr": "opa_wasm:eval_duration_seconds:p99",
            "legendFormat": "Tenant {{ tenant_id }}"
          }
        ],
        "yAxis": {
          "format": "ms"
        }
      },
      {
        "title": "Requests per Second by Tenant",
        "targets": [
          {
            "expr": "opa_wasm:requests_per_second:by_tenant",
            "legendFormat": "Tenant {{ tenant_id }}"
          }
        ]
      },
      {
        "title": "Deny Rate by Tenant",
        "targets": [
          {
            "expr": "opa_wasm:deny_rate:by_tenant",
            "legendFormat": "Tenant {{ tenant_id }}"
          }
        ],
        "yAxis": {
          "format": "percentunit"
        }
      },
      {
        "title": "WASM Module Load Time",
        "targets": [
          {
            "expr": "opa_wasm:load_duration_seconds:p99",
            "legendFormat": "Tenant {{ tenant_id }}"
          }
        ],
        "yAxis": {
          "format": "s"
        }
      }
    ]
  }
}
```

---

## ğŸ“Š å®é™…æ•ˆæœ

### éƒ¨ç½²å‰åå¯¹æ¯”

| æŒ‡æ ‡ | éƒ¨ç½²å‰ (Native) | éƒ¨ç½²å (WASM) | æ”¹å–„ |
|---|---|---|---|
| **P99å»¶è¿Ÿ** | 3ms | 1.5ms | **50% â†“** |
| **P50å»¶è¿Ÿ** | 0.8ms | 0.5ms | **37% â†“** |
| **QPS (å•æ ¸)** | 20K | 50K | **150% â†‘** |
| **å†…å­˜å ç”¨** | 50MB/ç§Ÿæˆ· | 20MB/ç§Ÿæˆ· | **60% â†“** |
| **è¾¹ç¼˜èŠ‚ç‚¹æ•°** | 200 | 200 | - |
| **ç­–ç•¥åˆ†å‘æ—¶é—´** | 5åˆ†é’Ÿ | 30ç§’ | **90% â†“** |
| **å†·å¯åŠ¨æ—¶é—´** | 500ms | 100ms | **80% â†“** |

### æˆæœ¬èŠ‚çœ

**è®¡ç®—æˆæœ¬**:

- Nativeæ¨¡å¼ï¼š200èŠ‚ç‚¹ Ã— 16GBå†…å­˜ = 3.2TB
- WASMæ¨¡å¼ï¼š200èŠ‚ç‚¹ Ã— 4GBå†…å­˜ = 0.8TB
- **èŠ‚çœ**: 75% å†…å­˜æˆæœ¬

**å¸¦å®½æˆæœ¬**:

- Nativeæ¨¡å¼ï¼šç­–ç•¥åŒ…10MB Ã— 5000ç§Ÿæˆ· = 50GB
- WASMæ¨¡å¼ï¼šç­–ç•¥åŒ…3MB Ã— 5000ç§Ÿæˆ· = 15GB
- **èŠ‚çœ**: 70% å¸¦å®½æˆæœ¬

**æ€»æˆæœ¬èŠ‚çœ**: ~$200K/å¹´

---

## ğŸ“ å…³é”®ç»éªŒ

### 1. WASMé™åˆ¶å¤„ç†

**ä¸æ”¯æŒçš„åŠŸèƒ½**:

- âŒ `http.send()` - HTTPè°ƒç”¨
- âŒ `opa.runtime()` - è¿è¡Œæ—¶ä¿¡æ¯
- âŒ æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

**è§£å†³æ–¹æ¡ˆ**:

- å°†åŠ¨æ€æ•°æ®ç¼–è¯‘è¿›WASM
- ä½¿ç”¨Envoyçš„å¤–éƒ¨æœåŠ¡æŸ¥è¯¢
- æ§åˆ¶å¹³é¢é¢„å¤„ç†æ•°æ®

### 2. ç­–ç•¥å¤§å°æ§åˆ¶

âœ… **æœ€ä½³å®è·µ**:

- ç›®æ ‡ï¼šWASM < 5MB
- ä½¿ç”¨`--optimize 2`ç¼–è¯‘
- é¿å…å¤§é‡é™æ€æ•°æ®
- å…±äº«å…¬å…±ç­–ç•¥åº“

### 3. å¤šç§Ÿæˆ·éš”ç¦»

âœ… **éš”ç¦»ç­–ç•¥**:

- æ¯ç§Ÿæˆ·ç‹¬ç«‹WASMæ¨¡å—
- Envoyè¿›ç¨‹çº§åˆ«éš”ç¦»
- ç§Ÿæˆ·IDç¼–è¯‘æ—¶æ³¨å…¥

### 4. çƒ­æ›´æ–°æœºåˆ¶

```bash
# æ— ç¼æ›´æ–°æµç¨‹
1. ç¼–è¯‘æ–°WASM
2. ä¸Šä¼ åˆ°CDN
3. è¾¹ç¼˜èŠ‚ç‚¹æ‹‰å–
4. åŸå­æ›¿æ¢ï¼ˆæ— åœæœºï¼‰
5. éªŒè¯æ–°ç­–ç•¥
6. å›æ»šæœºåˆ¶ï¼ˆå¦‚æœå¤±è´¥ï¼‰
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [WASMç¼–è¯‘è§„èŒƒ](../01-æŠ€æœ¯è§„èŒƒ/01.3-WASMç¼–è¯‘è§„èŒƒ.md)
- [æ€§èƒ½åŸºå‡†ä¸åº¦é‡](../01-æŠ€æœ¯è§„èŒƒ/01.4-æ€§èƒ½åŸºå‡†ä¸åº¦é‡.md)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)
- [APIç½‘å…³æˆæƒ](../05-åº”ç”¨åœºæ™¯/05.2-APIç½‘å…³æˆæƒ.md)
- [éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯](../03-å®ç°æ¶æ„/03.6-éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯.md)

---

## â“ å¸¸è§é—®é¢˜

**Q: WASMé€‚åˆæ‰€æœ‰åœºæ™¯å—ï¼Ÿ**

A: ä¸é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

- éœ€è¦HTTPè°ƒç”¨å¤–éƒ¨æœåŠ¡
- ç­–ç•¥éœ€è¦è®¿é—®opa.runtime
- åŠ¨æ€æ•°æ®æ›´æ–°é¢‘ç¹

é€‚åˆï¼š

- è¾¹ç¼˜è®¡ç®—ã€CDN
- å¤šç§Ÿæˆ·SaaS
- æè‡´æ€§èƒ½è¦æ±‚

**Q: å¦‚ä½•è°ƒè¯•WASMç­–ç•¥ï¼Ÿ**

A: å»ºè®®æµç¨‹ï¼š

```bash
# 1. æœ¬åœ°Nativeæµ‹è¯•
opa eval -d policy.rego -i input.json "data.tenant.authz.allow"

# 2. ç¼–è¯‘WASMæµ‹è¯•
opa build --target wasm ...
opa eval --bundle policy.tar.gz -i input.json "data.tenant.authz.allow"

# 3. Envoyé›†æˆæµ‹è¯•
# ä½¿ç”¨Envoyçš„æ—¥å¿—å’ŒtraceåŠŸèƒ½
```

**Q: æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œï¼Ÿ**

A: ä¸»è¦ä¼˜åŒ–ç‚¹ï¼š

1. **ç­–ç•¥å¤æ‚åº¦**ï¼šé¿å…æ·±åº¦é€’å½’
2. **æ•°æ®å¤§å°**ï¼šæ§åˆ¶ç¼–è¯‘æ—¶æ•°æ®<5MB
3. **ç½‘ç»œå»¶è¿Ÿ**ï¼šä½¿ç”¨CDNåŠ é€Ÿåˆ†å‘
4. **å†…å­˜**ï¼šWASMå®ä¾‹æ± ç®¡ç†

---

**æ¡ˆä¾‹æ¥æº**: åŸºäºæŸå…¨çƒSaaSå¹³å°ç”Ÿäº§ç¯å¢ƒè„±æ•æ”¹ç¼–  
**å®æ–½å‘¨æœŸ**: 2ä¸ªæœˆï¼ˆPoC 1ä¸ªæœˆ + ç”Ÿäº§éƒ¨ç½² 1ä¸ªæœˆï¼‰  
**ROI**: æ€§èƒ½æå‡50%ï¼Œæˆæœ¬é™ä½75%ï¼Œç”¨æˆ·ä½“éªŒæ”¹å–„æ˜¾è‘—

---

**å®Œæ•´ä»£ç **: [GitHub - OPA WASM Multi-Tenant Example](https://github.com/example/opa-wasm-multitenancy)

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹[ç”Ÿäº§æ¡ˆä¾‹æ±‡æ€»](../../PRODUCTION_CASES.md)äº†è§£æ›´å¤šå®æˆ˜ç»éªŒ
