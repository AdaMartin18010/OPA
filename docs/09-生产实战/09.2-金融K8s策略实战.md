# 09.2 é‡‘èžå…¬å¸Kubernetesç­–ç•¥å®žæˆ˜

> **é€‚ç”¨ç‰ˆæœ¬**: Gatekeeper v3.10+ | æŽ¨è v3.18+  
> **Kubernetesç‰ˆæœ¬**: 1.25+ | æŽ¨è 1.30+  
> **éš¾åº¦**: â­â­â­â­â­ ä¸“å®¶çº§  
> **åœºæ™¯**: é‡‘èžç”Ÿäº§çŽ¯å¢ƒã€ä¸¥æ ¼åˆè§„  
> **é¢„è®¡å­¦ä¹ æ—¶é—´**: 3-4å°æ—¶  
> **æœ€åŽéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯

---

## âš ï¸ é‡‘èžè¡Œä¸šåˆè§„æç¤º

> **ç›‘ç®¡è¦æ±‚**:
>
> - âœ… æ»¡è¶³PCI-DSSã€SOC 2ã€ISO 27001åˆè§„è¦æ±‚
> - âœ… æ‰€æœ‰ç­–ç•¥å˜æ›´éœ€è¦å®¡è®¡æ—¥å¿—
> - âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²éœ€è¦å˜æ›´å®¡æ‰¹æµç¨‹
> - âš ï¸ æœ¬æ¡ˆä¾‹åŸºäºŽçœŸå®žåœºæ™¯æ”¹ç¼–ï¼Œå…·ä½“ç­–ç•¥éœ€ç»“åˆè‡ªèº«åˆè§„è¦æ±‚
>
> **å®‰å…¨åŸºçº¿**:
>
> - **å¿…é¡»**ï¼šç¦æ­¢ç‰¹æƒå®¹å™¨ã€rootç”¨æˆ·
> - **å¿…é¡»**ï¼šå¼ºåˆ¶ç½‘ç»œéš”ç¦»ï¼ˆNetworkPolicyï¼‰
> - **å¿…é¡»**ï¼šå¯ç”¨Pod Security Standards
> - **å¿…é¡»**ï¼šå®¡è®¡æ‰€æœ‰æ‹’ç»å†³ç­–
>
> å‚è€ƒ: [å®‰å…¨åˆè§„æ ‡å‡†](../01-æŠ€æœ¯è§„èŒƒ/01.5-å®‰å…¨åˆè§„æ ‡å‡†.md) | [éƒ¨ç½²æ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## ðŸ“‹ æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹æ¥è‡ªæŸå¤§åž‹é‡‘èžæœºæž„ï¼ˆèµ„äº§ç®¡ç†è§„æ¨¡ $500B+ï¼‰ï¼Œå±•ç¤ºå¦‚ä½•åœ¨é«˜åº¦ç›‘ç®¡çš„KubernetesçŽ¯å¢ƒä¸­å®žæ–½å¤šå±‚æ¬¡ç­–ç•¥æŽ§åˆ¶ã€‚

### ä¸šåŠ¡èƒŒæ™¯

**å…¬å¸è§„æ¨¡**:

- 20+ å…³é”®ä¸šåŠ¡ç³»ç»Ÿ
- 500+ å¾®æœåŠ¡
- 3ä¸ªK8sé›†ç¾¤ï¼ˆå¼€å‘/é¢„å‘/ç”Ÿäº§ï¼‰
- å¤šä¸ªåˆè§„å›¢é˜Ÿï¼ˆå®‰å…¨ã€å®¡è®¡ã€é£ŽæŽ§ï¼‰

**æ ¸å¿ƒæŒ‘æˆ˜**:

1. **ä¸¥æ ¼åˆè§„**ï¼šæ»¡è¶³é‡‘èžç›‘ç®¡è¦æ±‚ï¼ˆPCI-DSSã€SOC 2ã€ISO 27001ï¼‰
2. **é›¶å®¹å¿å®‰å…¨**ï¼šä¸å…è®¸ä»»ä½•å®‰å…¨æ¼æ´žåˆ°è¾¾ç”Ÿäº§çŽ¯å¢ƒ
3. **å¤šå›¢é˜Ÿåä½œ**ï¼š20+å›¢é˜Ÿï¼Œæƒé™éš”ç¦»ã€èµ„æºé…é¢ç®¡ç†
4. **å®¡è®¡è¿½æº¯**ï¼šæ‰€æœ‰æ“ä½œå¯å®¡è®¡ï¼Œç­–ç•¥å˜æ›´æœ‰å®Œæ•´è®°å½•

---

## ðŸ—ï¸ æŠ€æœ¯æž¶æž„

### æ•´ä½“æž¶æž„

```text
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å¼€å‘å›¢é˜Ÿï¼ˆ20+ teamsï¼‰   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ kubectl apply
                             â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Kubernetes API Server    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  OPA Gatekeeper Webhook          â”‚
          â”‚  - Validation Mode               â”‚
          â”‚  - Mutation Mode                 â”‚
          â”‚  - Audit Mode                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“             â†“             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç­–ç•¥å±‚1 â”‚   â”‚ ç­–ç•¥å±‚2  â”‚  â”‚ ç­–ç•¥å±‚3   â”‚
    â”‚ å®‰å…¨åŸºçº¿â”‚   â”‚ èµ„æºé…é¢ â”‚  â”‚ å‘½åè§„èŒƒ  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  å®¡è®¡æ—¥å¿—       â”‚
              â”‚  - Prometheus   â”‚
              â”‚  - Elasticsearchâ”‚
              â”‚  - SIEMé›†æˆ     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”’ ç­–ç•¥æž¶æž„

### ä¸‰å±‚ç­–ç•¥ä½“ç³»

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: å®‰å…¨åŸºçº¿ï¼ˆå¼ºåˆ¶ï¼Œæ‰€æœ‰çŽ¯å¢ƒï¼‰      â”‚
â”‚  - ç¦æ­¢ç‰¹æƒå®¹å™¨                          â”‚
â”‚  - ç¦æ­¢rootç”¨æˆ·                          â”‚
â”‚  - å¼ºåˆ¶èµ„æºé™åˆ¶                          â”‚
â”‚  - é•œåƒä»“åº“ç™½åå•                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: èµ„æºé…é¢ï¼ˆæŒ‰å‘½åç©ºé—´ï¼‰          â”‚
â”‚  - CPU/å†…å­˜é…é¢                          â”‚
â”‚  - Podæ•°é‡é™åˆ¶                           â”‚
â”‚  - PVCå­˜å‚¨é™åˆ¶                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: ä¸šåŠ¡è§„èŒƒï¼ˆæŒ‰ä¸šåŠ¡çº¿ï¼‰            â”‚
â”‚  - å‘½åè§„èŒƒ                              â”‚
â”‚  - æ ‡ç­¾è¦æ±‚                              â”‚
â”‚  - ç½‘ç»œç­–ç•¥                              â”‚
â”‚  - æœåŠ¡ç½‘æ ¼é…ç½®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“¦ Layer 1: å®‰å…¨åŸºçº¿ç­–ç•¥

### 1.1 ConstraintTemplate: å®‰å…¨ä¸Šä¸‹æ–‡

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spspsecuritycontext
  annotations:
    description: "å¼ºåˆ¶å®‰å…¨ä¸Šä¸‹æ–‡é…ç½®"
    compliance: "PCI-DSS 2.2.4, SOC 2 CC6.1"
spec:
  crd:
    spec:
      names:
        kind: K8sPSPSecurityContext
      validation:
        openAPIV3Schema:
          type: object
          properties:
            allowPrivilegeEscalation:
              type: boolean
              description: "æ˜¯å¦å…è®¸æƒé™æå‡"
            runAsNonRoot:
              type: boolean
              description: "æ˜¯å¦å¼ºåˆ¶éžrootç”¨æˆ·"
            requiredDropCapabilities:
              type: array
              items:
                type: string
              description: "å¿…é¡»ä¸¢å¼ƒçš„Linux Capabilities"
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spspsecuritycontext

        import rego.v1

        violation[{"msg": msg}] if {
            container := input_containers[_]
            not container.securityContext.runAsNonRoot == true
            msg := sprintf("Container '%s' must set runAsNonRoot to true", [container.name])
        }

        violation[{"msg": msg}] if {
            container := input_containers[_]
            container.securityContext.allowPrivilegeEscalation == true
            msg := sprintf("Container '%s' must not allow privilege escalation", [container.name])
        }

        violation[{"msg": msg}] if {
            container := input_containers[_]
            params := object.get(input, "parameters", {})
            required_caps := object.get(params, "requiredDropCapabilities", [])
            count(required_caps) > 0
            provided_caps := object.get(container, ["securityContext", "capabilities", "drop"], [])
            missing := {cap | cap := required_caps[_]; not cap in provided_caps}
            count(missing) > 0
            msg := sprintf("Container '%s' must drop capabilities: %v", [container.name, missing])
        }

        input_containers[container] if {
            container := input.review.object.spec.containers[_]
        }

        input_containers[container] if {
            container := input.review.object.spec.initContainers[_]
        }
```

### 1.2 Constraint: ç”Ÿäº§çŽ¯å¢ƒå¼ºåˆ¶

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPSecurityContext
metadata:
  name: prod-security-context
  annotations:
    severity: "critical"
    owner: "security-team"
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchLabels:
        environment: production
  parameters:
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    requiredDropCapabilities:
      - ALL
```

---

## ðŸ“Š Layer 2: èµ„æºé…é¢ç­–ç•¥

### 2.1 ConstraintTemplate: èµ„æºé™åˆ¶

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredresources
  annotations:
    description: "å¼ºåˆ¶èµ„æºrequestså’Œlimits"
    compliance: "å†…éƒ¨èµ„æºç®¡ç†æ”¿ç­–"
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredResources
      validation:
        openAPIV3Schema:
          type: object
          properties:
            cpu:
              type: object
              properties:
                max:
                  type: string
                min:
                  type: string
            memory:
              type: object
              properties:
                max:
                  type: string
                min:
                  type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredresources

        import rego.v1

        violation[{"msg": msg}] if {
            container := input_containers[_]
            not container.resources.requests.cpu
            msg := sprintf("Container '%s' must specify CPU requests", [container.name])
        }

        violation[{"msg": msg}] if {
            container := input_containers[_]
            not container.resources.limits.cpu
            msg := sprintf("Container '%s' must specify CPU limits", [container.name])
        }

        violation[{"msg": msg}] if {
            container := input_containers[_]
            not container.resources.requests.memory
            msg := sprintf("Container '%s' must specify memory requests", [container.name])
        }

        violation[{"msg": msg}] if {
            container := input_containers[_]
            not container.resources.limits.memory
            msg := sprintf("Container '%s' must specify memory limits", [container.name])
        }

        # æ£€æŸ¥èµ„æºä¸Šé™
        violation[{"msg": msg}] if {
            container := input_containers[_]
            params := object.get(input, "parameters", {})
            max_cpu := object.get(params, ["cpu", "max"], "")
            max_cpu != ""
            cpu_limit := container.resources.limits.cpu
            cpu_value := parse_cpu(cpu_limit)
            max_value := parse_cpu(max_cpu)
            cpu_value > max_value
            msg := sprintf("Container '%s' CPU limit %s exceeds maximum %s", [
                container.name,
                cpu_limit,
                max_cpu,
            ])
        }

        parse_cpu(cpu_string) := cores if {
            # è§£æž"100m"æ ¼å¼
            endswith(cpu_string, "m")
            cores_str := trim_suffix(cpu_string, "m")
            cores := to_number(cores_str) / 1000
        }

        parse_cpu(cpu_string) := cores if {
            # è§£æž"2"æ ¼å¼
            not endswith(cpu_string, "m")
            cores := to_number(cpu_string)
        }

        input_containers[container] if {
            container := input.review.object.spec.containers[_]
        }

        input_containers[container] if {
            container := input.review.object.spec.initContainers[_]
        }
```

### 2.2 Constraint: æŒ‰ä¸šåŠ¡çº¿é…ç½®

```yaml
# æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿï¼ˆé«˜èµ„æºï¼‰
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredResources
metadata:
  name: trading-system-resources
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchLabels:
        business: trading
  parameters:
    cpu:
      min: "500m"
      max: "8"
    memory:
      min: "1Gi"
      max: "16Gi"
---
# ä¸€èˆ¬åº”ç”¨ï¼ˆæ ‡å‡†èµ„æºï¼‰
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredResources
metadata:
  name: standard-app-resources
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchExpressions:
        - key: business
          operator: NotIn
          values: ["trading", "risk"]
  parameters:
    cpu:
      min: "100m"
      max: "2"
    memory:
      min: "128Mi"
      max: "4Gi"
```

---

## ðŸ·ï¸ Layer 3: ä¸šåŠ¡è§„èŒƒç­–ç•¥

### 3.1 ConstraintTemplate: æ ‡ç­¾è¦æ±‚

```yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
  annotations:
    description: "å¼ºåˆ¶ä¸šåŠ¡æ ‡ç­¾"
    compliance: "å†…éƒ¨CMDBé›†æˆè¦æ±‚"
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        openAPIV3Schema:
          type: object
          properties:
            labels:
              type: array
              items:
                type: object
                properties:
                  key:
                    type: string
                  allowedRegex:
                    type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels

        import rego.v1

        violation[{"msg": msg}] if {
            provided := {label | input.review.object.metadata.labels[label]}
            required := {label | label := input.parameters.labels[_].key}
            missing := required - provided
            count(missing) > 0
            msg := sprintf("Missing required labels: %v", [missing])
        }

        violation[{"msg": msg}] if {
            label_def := input.parameters.labels[_]
            label_key := label_def.key
            allowed_regex := label_def.allowedRegex
            actual_value := object.get(input.review.object.metadata.labels, label_key, "")
            actual_value != ""
            not regex.match(allowed_regex, actual_value)
            msg := sprintf("Label '%s' value '%s' does not match regex '%s'", [
                label_key,
                actual_value,
                allowed_regex,
            ])
        }
```

### 3.2 Constraint: é‡‘èžä¸šåŠ¡æ ‡ç­¾

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: financial-labels
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
      - apiGroups: ["apps"]
        kinds: ["Deployment", "StatefulSet"]
    namespaceSelector:
      matchLabels:
        environment: production
  parameters:
    labels:
      - key: "app"
        allowedRegex: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
      - key: "version"
        allowedRegex: "^v[0-9]+\\.[0-9]+\\.[0-9]+$"
      - key: "owner"
        allowedRegex: "^[a-z-]+$"
      - key: "cost-center"
        allowedRegex: "^CC[0-9]{4}$"
      - key: "compliance"
        allowedRegex: "^(pci-dss|soc2|iso27001)$"
      - key: "data-classification"
        allowedRegex: "^(public|internal|confidential|restricted)$"
```

---

## ðŸ“ˆ æ€§èƒ½ä¸Žç›‘æŽ§

### Webhookå»¶è¿Ÿç›‘æŽ§

```yaml
# prometheus-alerts.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: gatekeeper-alerts
  namespace: gatekeeper-system
data:
  alerts.yaml: |
    groups:
      - name: gatekeeper
        interval: 30s
        rules:
          # Webhookå»¶è¿Ÿå‘Šè­¦
          - alert: GatekeeperWebhookHighLatency
            expr: histogram_quantile(0.99, sum(rate(gatekeeper_webhook_request_duration_seconds_bucket[5m])) by (le)) > 1
            for: 5m
            labels:
              severity: warning
              compliance: true
            annotations:
              summary: "Gatekeeper webhook P99å»¶è¿Ÿè¶…è¿‡1ç§’"
              description: "å¯èƒ½å½±å“é›†ç¾¤æ“ä½œï¼Œéœ€è¦ä¼˜åŒ–ç­–ç•¥"

          # æ‹’ç»çŽ‡å‘Šè­¦
          - alert: GatekeeperHighDenyRate
            expr: sum(rate(gatekeeper_violations_total[5m])) by (enforcement_action) > 10
            for: 10m
            labels:
              severity: info
            annotations:
              summary: "Gatekeeperæ‹’ç»çŽ‡è¿‡é«˜"
              description: "å¯èƒ½æœ‰é…ç½®é”™è¯¯æˆ–å›¢é˜Ÿä¸äº†è§£ç­–ç•¥"

          # å®¡è®¡è¿è§„å‘Šè­¦
          - alert: GatekeeperAuditViolations
            expr: sum(gatekeeper_audit_violations) by (enforcement_action, constraint_name) > 0
            for: 1h
            labels:
              severity: critical
              compliance: true
            annotations:
              summary: "å‘çŽ°çŽ°æœ‰èµ„æºè¿è§„"
              description: "Constraint {{ $labels.constraint_name }} å‘çŽ°è¿è§„èµ„æº"
```

### å®¡è®¡æ—¥å¿—é…ç½®

```yaml
# gatekeeper-audit-config.yaml
apiVersion: config.gatekeeper.sh/v1alpha1
kind: Config
metadata:
  name: config
  namespace: gatekeeper-system
spec:
  audit:
    auditInterval: 60  # æ¯60ç§’å®¡è®¡ä¸€æ¬¡
    constraintViolationsLimit: 1000
    auditChunkSize: 500
    logLevel: "INFO"
  validation:
    traces:
      - user: "system:serviceaccount:*"
        kind:
          group: ""
          version: "v1"
          kind: "Pod"
        dump: "All"  # è®°å½•æ‰€æœ‰å†³ç­–
  match:
    - excludedNamespaces:
        - "kube-system"
        - "kube-public"
        - "kube-node-lease"
        - "gatekeeper-system"
      processes:
        - "audit"
        - "webhook"
```

---

## ðŸš€ éƒ¨ç½²æµç¨‹

### Step 1: å®‰è£…Gatekeeper

```bash
# 1. å®‰è£…Gatekeeper (Helm)
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update

# 2. åˆ›å»ºvalues.yaml
cat > gatekeeper-values.yaml <<EOF
replicas: 3
auditInterval: 60
constraintViolationsLimit: 1000
auditChunkSize: 500
logLevel: INFO
image:
  repository: openpolicyagent/gatekeeper
  tag: v3.18.0
resources:
  limits:
    cpu: "1000m"
    memory: "512Mi"
  requests:
    cpu: "100m"
    memory: "256Mi"
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8888"
EOF

# 3. éƒ¨ç½²
helm install gatekeeper gatekeeper/gatekeeper \
  -n gatekeeper-system \
  --create-namespace \
  -f gatekeeper-values.yaml

# 4. éªŒè¯
kubectl get pods -n gatekeeper-system
kubectl get crd | grep gatekeeper
```

### Step 2: éƒ¨ç½²ç­–ç•¥ï¼ˆåˆ†é˜¶æ®µï¼‰

**é˜¶æ®µ1: Auditæ¨¡å¼ï¼ˆ2å‘¨ï¼‰**:

```bash
# éƒ¨ç½²æ‰€æœ‰ConstraintTemplate
kubectl apply -f constraint-templates/

# éƒ¨ç½²Constraintï¼ˆenforcementAction: dryrunï¼‰
kubectl apply -f constraints/layer1-security-audit.yaml
kubectl apply -f constraints/layer2-resources-audit.yaml

# ç›‘æŽ§è¿è§„æƒ…å†µ
kubectl get constraints -A
kubectl describe constraint prod-security-context
```

**é˜¶æ®µ2: é¢„å‘çŽ¯å¢ƒDenyæ¨¡å¼ï¼ˆ2å‘¨ï¼‰**:

```bash
# ä¿®æ”¹ä¸ºdenyæ¨¡å¼
kubectl patch constraint prod-security-context \
  --type=json \
  -p='[{"op": "replace", "path": "/spec/enforcementAction", "value": "deny"}]'

# ç›‘æŽ§æ‹’ç»çŽ‡å’Œå›¢é˜Ÿåé¦ˆ
kubectl get events --field-selector reason=FailedCreate
```

**é˜¶æ®µ3: ç”Ÿäº§çŽ¯å¢ƒDenyæ¨¡å¼**:

```bash
# ç¡®è®¤æ— è¯¯åŽï¼Œç”Ÿäº§çŽ¯å¢ƒå¯ç”¨
kubectl apply -f constraints/layer1-security-prod.yaml
kubectl apply -f constraints/layer2-resources-prod.yaml
kubectl apply -f constraints/layer3-business-prod.yaml

# æŒç»­ç›‘æŽ§
watch -n 10 'kubectl get constraints -A'
```

### Step 3: é›†æˆç›‘æŽ§

```bash
# Prometheusé›†æˆ
kubectl apply -f monitoring/prometheus-servicemonitor.yaml

# Grafana Dashboard
kubectl apply -f monitoring/gatekeeper-dashboard.json

# å‘Šè­¦è§„åˆ™
kubectl apply -f monitoring/prometheus-alerts.yaml
```

---

## ðŸ“Š å®žé™…æ•ˆæžœ

### éƒ¨ç½²å‰åŽå¯¹æ¯”

| æŒ‡æ ‡ | éƒ¨ç½²å‰ | éƒ¨ç½²åŽ | æ”¹å–„ |
|---|---|---|---|
| **å®‰å…¨æ¼æ´ž** | 15ä¸ª/æœˆ | 0ä¸ª/æœˆ | **100% â†“** |
| **èµ„æºè¶…é…** | 30% é›†ç¾¤ | 0% | **100% â†“** |
| **å®¡è®¡ä¸åˆè§„** | 12æ¬¡/å¹´ | 0æ¬¡/å¹´ | **100% â†“** |
| **éƒ¨ç½²å¤±è´¥çŽ‡** | 2% | 0.5% | **75% â†“** |
| **éƒ¨ç½²å»¶è¿Ÿ** | <1s | <1.5s | **+0.5s** |
| **ç­–ç•¥è¦†ç›–** | 0% | 100% | **+100%** |

### å…³é”®æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡**:

- Webhook P99å»¶è¿Ÿ: <800msï¼ˆç›®æ ‡<1sï¼‰
- å®¡è®¡å‘¨æœŸ: 60ç§’
- ç­–ç•¥è¯„ä¼°æˆåŠŸçŽ‡: 99.99%

**ä¸šåŠ¡æŒ‡æ ‡**:

- ç­–ç•¥è¿è§„æ‹¦æˆª: ~200æ¬¡/å‘¨
- å®¡è®¡å‘çŽ°é—®é¢˜: ~50ä¸ª/æœˆ
- ç­–ç•¥å˜æ›´é¢‘çŽ‡: 2-3æ¬¡/æœˆ

**åˆè§„æŒ‡æ ‡**:

- PCI-DSSå®¡è®¡: âœ… é€šè¿‡
- SOC 2å®¡è®¡: âœ… é€šè¿‡
- ISO 27001å®¡è®¡: âœ… é€šè¿‡

---

## ðŸŽ“ å…³é”®ç»éªŒ

### 1. åˆ†é˜¶æ®µæŽ¨è¿›

âœ… **æŽ¨èåšæ³•**:

- Week 1-2: Auditæ¨¡å¼ï¼Œæ”¶é›†è¿è§„æ•°æ®
- Week 3-4: é¢„å‘çŽ¯å¢ƒDenyï¼Œå›¢é˜Ÿé€‚åº”
- Week 5: ç”Ÿäº§çŽ¯å¢ƒå¯ç”¨

âŒ **é¿å…åšæ³•**:

- ç›´æŽ¥ç”Ÿäº§Denyæ¨¡å¼ â†’ å¤§é‡æ‹’ç»ï¼Œå½±å“ä¸šåŠ¡
- ç­–ç•¥å¤ªå¤æ‚ â†’ å›¢é˜Ÿç†è§£å›°éš¾

### 2. å……åˆ†æ²Ÿé€š

âœ… **æ²Ÿé€šç­–ç•¥**:

- æ¯å‘¨å®‰å…¨ä¾‹ä¼šè®²è§£æ–°ç­–ç•¥
- æä¾›ç­–ç•¥æ–‡æ¡£å’Œç¤ºä¾‹
- å»ºç«‹Slacké¢‘é“å¿«é€Ÿç­”ç–‘

### 3. ç›‘æŽ§å‘Šè­¦

âœ… **å¿…éœ€ç›‘æŽ§**:

- Webhookå»¶è¿Ÿï¼ˆP99 < 1sï¼‰
- æ‹’ç»çŽ‡ï¼ˆçªå¢žéœ€è°ƒæŸ¥ï¼‰
- å®¡è®¡è¿è§„ï¼ˆæŒç»­è·Ÿè¿›ä¿®å¤ï¼‰

### 4. ä¾‹å¤–ç®¡ç†

```yaml
# å…è®¸ç‰¹å®šåœºæ™¯ä¾‹å¤–
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPSecurityContext
metadata:
  name: security-context-with-exemptions
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchExpressions:
        - key: policy.gatekeeper.sh/exempt
          operator: DoesNotExist
```

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [Gatekeeperè¯¦è§£](../04-ç”Ÿæ€ç³»ç»Ÿ/04.2-Gatekeeperè¯¦è§£.md)
- [Kubernetesé›†æˆ](../04-ç”Ÿæ€ç³»ç»Ÿ/04.1-Kubernetesé›†æˆ.md)
- [å®‰å…¨åˆè§„æ ‡å‡†](../01-æŠ€æœ¯è§„èŒƒ/01.5-å®‰å…¨åˆè§„æ ‡å‡†.md)
- [ç­–ç•¥è®¾è®¡æ¨¡å¼](../08-æœ€ä½³å®žè·µ/08.1-ç­–ç•¥è®¾è®¡æ¨¡å¼.md)
- [éƒ¨ç½²æ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## â“ å¸¸è§é—®é¢˜

**Q: Gatekeeperä¼šå½±å“é›†ç¾¤æ€§èƒ½å—ï¼Ÿ**

A: å½±å“å¾ˆå°ï¼ˆP99å¢žåŠ 500-800msï¼‰ã€‚å…³é”®ä¼˜åŒ–ï¼š

- ç­–ç•¥ç®€æ´ï¼Œé¿å…å¤æ‚éåŽ†
- ä½¿ç”¨Auditæ¨¡å¼å¤„ç†éžå…³é”®æ£€æŸ¥
- ç›‘æŽ§Webhookå»¶è¿Ÿ

**Q: å¦‚ä½•å¤„ç†ç´§æ€¥å˜æ›´ï¼Ÿ**

A: è®¾ç½®ç´§æ€¥è±å…æœºåˆ¶ï¼š

```bash
# ä¸´æ—¶ç¦ç”¨æŸä¸ªConstraint
kubectl patch constraint prod-security-context \
  --type=json \
  -p='[{"op": "replace", "path": "/spec/enforcementAction", "value": "warn"}]'

# äº‹åŽæ¢å¤å¹¶å®¡è®¡
```

**Q: ç­–ç•¥å†²çªå¦‚ä½•è§£å†³ï¼Ÿ**

A: ä½¿ç”¨å‘½åç©ºé—´æ ‡ç­¾éš”ç¦»ï¼š

```yaml
match:
  namespaceSelector:
    matchLabels:
      enforcement-level: "strict"  # æˆ– "standard", "permissive"
```

---

**æ¡ˆä¾‹æ¥æº**: åŸºäºŽæŸå…¨çƒèµ„äº§ç®¡ç†å…¬å¸ç”Ÿäº§çŽ¯å¢ƒè„±æ•æ”¹ç¼–  
**å®žæ–½å‘¨æœŸ**: 3ä¸ªæœˆï¼ˆè§„åˆ’1ä¸ªæœˆ + å®žæ–½2ä¸ªæœˆï¼‰  
**ROI**: å®‰å…¨äº‹ä»¶å‡å°‘100%ï¼Œå®¡è®¡æˆæœ¬é™ä½Ž60%

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [SaaSå¤šç§Ÿæˆ·WASMéƒ¨ç½²](09.3-SaaSå¤šç§Ÿæˆ·WASMå®žæˆ˜.md) äº†è§£è¾¹ç¼˜åœºæ™¯ä¼˜åŒ–
