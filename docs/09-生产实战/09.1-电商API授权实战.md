# 09.1 ç”µå•†APIæˆæƒå®æˆ˜

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.60+ | æ¨è v0.68+  
> **Regoç‰ˆæœ¬**: v1.0  
> **éš¾åº¦**: â­â­â­â­ é«˜çº§  
> **åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒå®æˆ˜  
> **é¢„è®¡å­¦ä¹ æ—¶é—´**: 2-3å°æ—¶  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯

---

## âš ï¸ ç”Ÿäº§å®æˆ˜æç¤º

> **æ¡ˆä¾‹è¯´æ˜**:
>
> - âœ… æœ¬æ¡ˆä¾‹åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒè„±æ•æ”¹ç¼–
> - âœ… ä»£ç ç»è¿‡å®é™…åœºæ™¯éªŒè¯ï¼Œå¯ç›´æ¥å‚è€ƒ
> - âš ï¸ å…·ä½“å‚æ•°ï¼ˆQPSã€å»¶è¿Ÿç­‰ï¼‰éœ€æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´
> - âš ï¸ å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´éªŒè¯
>
> **å­¦ä¹ è·¯å¾„**:
>
> - å…ˆå­¦ä¹ : [APIè§„èŒƒ](../01-æŠ€æœ¯è§„èŒƒ/01.1-APIè§„èŒƒ.md) | [ç­–ç•¥è®¾è®¡](../08-æœ€ä½³å®è·µ/08.1-ç­–ç•¥è®¾è®¡æ¨¡å¼.md)
> - å†å®è·µ: è·Ÿéšæœ¬æ¡ˆä¾‹é€æ­¥å®æ–½
> - æœ€åä¼˜åŒ–: [æ€§èƒ½ä¼˜åŒ–](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)
>
> é…å¥—: [éƒ¨ç½²æ£€æŸ¥æ¸…å•](../../CHECKLIST.md) | [æ¡ˆä¾‹æ±‡æ€»](../../PRODUCTION_CASES.md)

---

## ğŸ“‹ æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒè„±æ•ï¼Œå±•ç¤ºå¦‚ä½•åœ¨å¤§è§„æ¨¡ç”µå•†å¹³å°ä¸­ä½¿ç”¨OPAå®ç°APIçº§åˆ«çš„ç»†ç²’åº¦æˆæƒæ§åˆ¶ã€‚

### ä¸šåŠ¡èƒŒæ™¯

**å…¬å¸è§„æ¨¡**:

- 1000+ å¾®æœåŠ¡
- 50K QPSå³°å€¼æµé‡
- ç™¾ä¸‡çº§ç”¨æˆ·
- å¤æ‚çš„å¤šè§’è‰²æƒé™ä½“ç³»

**æ ¸å¿ƒæŒ‘æˆ˜**:

1. **æ€§èƒ½è¦æ±‚**ï¼šP99å»¶è¿Ÿ<5msï¼Œä¸èƒ½å½±å“ç”¨æˆ·ä½“éªŒ
2. **æƒé™å¤æ‚**ï¼šç”¨æˆ·ã€å•†å®¶ã€å‘˜å·¥ä¸‰å¤§è§’è‰²ï¼Œæ•°åç§ç»†åˆ†æƒé™
3. **åŠ¨æ€æ€§å¼º**ï¼šæƒé™éœ€è¦å®æ—¶ç”Ÿæ•ˆï¼Œä¸èƒ½é‡å¯æœåŠ¡
4. **å¯å®¡è®¡æ€§**ï¼šæ‰€æœ‰æˆæƒå†³ç­–éœ€è¦å®Œæ•´å®¡è®¡

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```text
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç”¨æˆ·/å•†å®¶      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTPS
                             v
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   API Gateway   â”‚
                    â”‚    (Envoy)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”
          â”‚  OPA Sidecar â”‚<â”€â”€â”€â”‚  ç­–ç•¥Bundle â”‚
          â”‚  (æˆæƒå†³ç­–)  â”‚    â”‚  (æ¯5åˆ†é’Ÿ)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    â”‚
     â”Œâ”€â”€â”€â”€vâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”
     â”‚ å•†å“æœåŠ¡ â”‚    â”‚ è®¢å•æœåŠ¡  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éƒ¨ç½²æ¶æ„

**é€‰å‹**: Sidecaræ¨¡å¼  
**åŸå› **:

- âœ… ä½å»¶è¿Ÿï¼ˆæœ¬åœ°è°ƒç”¨ï¼‰
- âœ… é«˜å¯ç”¨ï¼ˆéšæœåŠ¡æ‰©ç¼©å®¹ï¼‰
- âœ… æ•…éšœéš”ç¦»ï¼ˆå•æœåŠ¡æ•…éšœä¸å½±å“å…¨å±€ï¼‰

**é…ç½®**:

- OPAç‰ˆæœ¬: v0.60.0-envoy
- å®¹å™¨èµ„æº: 128Miå†…å­˜ / 100m CPU
- å‰¯æœ¬æ•°: è·Ÿéšä¸šåŠ¡æœåŠ¡å‰¯æœ¬
- é€šä¿¡æ–¹å¼: gRPC (ç«¯å£9191)

---

## ğŸ“ ç­–ç•¥å®ç°

### 1. ç­–ç•¥ç»“æ„è®¾è®¡

```text
policies/
â”œâ”€â”€ authz/
â”‚   â”œâ”€â”€ main.rego              # ä¸»ç­–ç•¥
â”‚   â”œâ”€â”€ rbac.rego              # åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
â”‚   â”œâ”€â”€ resource_owner.rego    # èµ„æºæ‰€æœ‰æƒæ£€æŸ¥
â”‚   â”œâ”€â”€ helpers.rego           # è¾…åŠ©å‡½æ•°
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ main_test.rego
â”‚       â”œâ”€â”€ rbac_test.rego
â”‚       â””â”€â”€ resource_owner_test.rego
â””â”€â”€ data/
    â”œâ”€â”€ roles.json             # è§’è‰²æƒé™é…ç½®
    â”œâ”€â”€ api_mapping.json       # APIè·¯å¾„æ˜ å°„
    â””â”€â”€ blacklist.json         # é»‘åå•
```

### 2. ä¸»ç­–ç•¥å®ç°

```rego
# policies/authz/main.rego
# OPAç‰ˆæœ¬: v0.60+
# æµ‹è¯•çŠ¶æ€: âœ… ç”Ÿäº§éªŒè¯

package envoy.authz

import rego.v1

# å¯¼å…¥å…¶ä»–ç­–ç•¥æ¨¡å—
import data.authz.rbac
import data.authz.resource_owner
import data.authz.helpers

# é»˜è®¤æ‹’ç»
default allow := false

# Envoyæˆæƒå†³ç­–å…¥å£
allow if {
    # 1. æå–å¹¶éªŒè¯JWT Token
    token_valid
    
    # 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•
    not user_blacklisted
    
    # 3. æ ¹æ®è§’è‰²ç±»å‹è¿›è¡Œæˆæƒ
    role_based_authorization
}

# JWT TokenéªŒè¯
token_valid if {
    # ä»Headeræå–Token
    token := helpers.get_token(input.attributes.request.http.headers)
    
    # éªŒè¯JWTç­¾åå’Œæœ‰æ•ˆæœŸ
    payload := io.jwt.decode_verify(token, {"secret": data.jwt_secret})
    
    # æå–ç”¨æˆ·ä¿¡æ¯
    helpers.user_info := {
        "id": payload[2].sub,
        "role": payload[2].role,
        "tenant_id": payload[2].tenant_id,
    }
}

# é»‘åå•æ£€æŸ¥
user_blacklisted if {
    user_id := helpers.user_info.id
    data.blacklist[user_id]
}

# åŸºäºè§’è‰²çš„æˆæƒåˆ†æ”¯
role_based_authorization if {
    user_role := helpers.user_info.role
    
    # å†…éƒ¨å‘˜å·¥ï¼šå®Œå…¨RBAC
    user_role == "employee"
    rbac.employee_allowed
}

role_based_authorization if {
    user_role == "merchant"
    # å•†å®¶ï¼šRBAC + èµ„æºæ‰€æœ‰æƒ
    rbac.merchant_allowed
    resource_owner.check_ownership
}

role_based_authorization if {
    user_role == "customer"
    # ç”¨æˆ·ï¼šä»…èµ„æºæ‰€æœ‰æƒ
    resource_owner.check_ownership
}

# Envoyå“åº”æ ¼å¼
response := {
    "allowed": allow,
    "headers": headers,
    "body": body,
} if {
    headers := {
        "x-user-id": helpers.user_info.id,
        "x-user-role": helpers.user_info.role,
    }
    body := ""
}

response := {
    "allowed": false,
    "headers": {},
    "body": sprintf("Access denied: %s", [deny_reason]),
} if {
    not allow
    deny_reason := "Insufficient permissions"
}
```

### 3. RBACç­–ç•¥

```rego
# policies/authz/rbac.rego
package authz.rbac

import rego.v1
import data.authz.helpers

# å‘˜å·¥æƒé™æ£€æŸ¥
employee_allowed if {
    # è·å–å‘˜å·¥è§’è‰²
    user_id := helpers.user_info.id
    role := data.employees[user_id].role
    
    # è·å–è¯·æ±‚çš„APIè·¯å¾„å’Œæ–¹æ³•
    path := input.attributes.request.http.path
    method := input.attributes.request.http.method
    
    # æ˜ å°„åˆ°èµ„æºå’Œæ“ä½œ
    resource := helpers.path_to_resource(path)
    action := helpers.method_to_action(method)
    
    # æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰æƒé™
    permission := data.roles[role].permissions[_]
    permission.resource == resource
    permission.action == action
}

# å•†å®¶æƒé™æ£€æŸ¥
merchant_allowed if {
    path := input.attributes.request.http.path
    method := input.attributes.request.http.method
    
    # å•†å®¶å…è®¸çš„APIç™½åå•
    allowed_apis := data.merchant_allowed_apis
    api_key := sprintf("%s:%s", [method, path])
    
    some api in allowed_apis
    glob.match(api, ["/"], api_key)
}
```

### 4. èµ„æºæ‰€æœ‰æƒæ£€æŸ¥

```rego
# policies/authz/resource_owner.rego
package authz.resource_owner

import rego.v1
import data.authz.helpers

# æ£€æŸ¥èµ„æºæ‰€æœ‰æƒ
check_ownership if {
    resource_type := helpers.get_resource_type(input.attributes.request.http.path)
    resource_id := helpers.get_resource_id(input.attributes.request.http.path)
    
    # æ ¹æ®èµ„æºç±»å‹é€‰æ‹©æ£€æŸ¥æ–¹æ³•
    ownership_rules[resource_type](resource_id)
}

# è®¢å•æ‰€æœ‰æƒè§„åˆ™
ownership_rules.order(order_id) if {
    user_id := helpers.user_info.id
    order := data.orders[order_id]
    order.customer_id == user_id
}

# å•†å“æ‰€æœ‰æƒè§„åˆ™ï¼ˆå•†å®¶ï¼‰
ownership_rules.product(product_id) if {
    user_role := helpers.user_info.role
    user_role == "merchant"
    
    merchant_id := helpers.user_info.id
    product := data.products[product_id]
    product.merchant_id == merchant_id
}

# è´­ç‰©è½¦æ‰€æœ‰æƒè§„åˆ™
ownership_rules.cart(cart_id) if {
    user_id := helpers.user_info.id
    cart := data.carts[cart_id]
    cart.customer_id == user_id
}
```

### 5. è¾…åŠ©å‡½æ•°

```rego
# policies/authz/helpers.rego
package authz.helpers

import rego.v1

# å…¨å±€å˜é‡ï¼šç”¨æˆ·ä¿¡æ¯
user_info := {}

# ä»Headeræå–Bearer Token
get_token(headers) := token if {
    auth_header := headers.authorization
    startswith(auth_header, "Bearer ")
    token := substring(auth_header, 7, -1)
}

# APIè·¯å¾„æ˜ å°„åˆ°èµ„æºç±»å‹
path_to_resource(path) := resource if {
    # ä½¿ç”¨æ­£åˆ™åŒ¹é…
    regex.match(`^/api/v1/products.*`, path)
    resource := "product"
}

path_to_resource(path) := resource if {
    regex.match(`^/api/v1/orders.*`, path)
    resource := "order"
}

path_to_resource(path) := "unknown" if {
    # é»˜è®¤è¿”å›unknown
    true
}

# HTTPæ–¹æ³•æ˜ å°„åˆ°æ“ä½œ
method_to_action("GET") := "read"
method_to_action("POST") := "create"
method_to_action("PUT") := "update"
method_to_action("PATCH") := "update"
method_to_action("DELETE") := "delete"

# ä»è·¯å¾„æå–èµ„æºID
get_resource_id(path) := id if {
    parts := split(path, "/")
    count(parts) > 4
    id := parts[4]
}

# è·å–èµ„æºç±»å‹
get_resource_type(path) := resource_type if {
    parts := split(path, "/")
    count(parts) > 3
    resource_type := parts[3]
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```rego
# policies/authz/tests/main_test.rego
package envoy.authz

import rego.v1

# æµ‹è¯•ï¼šå‘˜å·¥è®¿é—®å…è®¸
test_employee_access_allowed if {
    allow with input as {
        "attributes": {
            "request": {
                "http": {
                    "method": "GET",
                    "path": "/api/v1/products/123",
                    "headers": {
                        "authorization": "Bearer eyJ..."  # æœ‰æ•ˆToken
                    }
                }
            }
        }
    }
    with data.employees as {"emp001": {"role": "admin"}}
    with data.roles as {
        "admin": {
            "permissions": [
                {"resource": "product", "action": "read"}
            ]
        }
    }
    with data.jwt_secret as {"kty": "oct", "k": "..."}
}

# æµ‹è¯•ï¼šå•†å®¶è®¿é—®è‡ªå·±çš„å•†å“
test_merchant_own_product if {
    allow with input as {
        "attributes": {
            "request": {
                "http": {
                    "method": "GET",
                    "path": "/api/v1/products/123",
                    "headers": {"authorization": "Bearer eyJ..."}
                }
            }
        }
    }
    with data.products as {"123": {"merchant_id": "merchant001"}}
    with helpers.user_info as {
        "id": "merchant001",
        "role": "merchant"
    }
}

# æµ‹è¯•ï¼šç”¨æˆ·è®¿é—®ä»–äººè®¢å•è¢«æ‹’ç»
test_customer_access_other_order_denied if {
    not allow with input as {
        "attributes": {
            "request": {
                "http": {
                    "method": "GET",
                    "path": "/api/v1/orders/456",
                    "headers": {"authorization": "Bearer eyJ..."}
                }
            }
        }
    }
    with data.orders as {"456": {"customer_id": "customer002"}}
    with helpers.user_info as {
        "id": "customer001",
        "role": "customer"
    }
}

# æµ‹è¯•ï¼šé»‘åå•ç”¨æˆ·è¢«æ‹’ç»
test_blacklisted_user_denied if {
    not allow with input as {
        "attributes": {
            "request": {
                "http": {
                    "method": "GET",
                    "path": "/api/v1/products",
                    "headers": {"authorization": "Bearer eyJ..."}
                }
            }
        }
    }
    with data.blacklist as {"malicious_user": true}
    with helpers.user_info as {"id": "malicious_user"}
}
```

### è¿è¡Œæµ‹è¯•

```bash
# å•å…ƒæµ‹è¯•
opa test policies/ -v

# è¾“å‡º:
# policies/authz/tests/main_test.rego:
# data.envoy.authz.test_employee_access_allowed: PASS (2.1ms)
# data.envoy.authz.test_merchant_own_product: PASS (1.8ms)
# data.envoy.authz.test_customer_access_other_order_denied: PASS (1.5ms)
# data.envoy.authz.test_blacklisted_user_denied: PASS (1.2ms)
# --------------------------------------------------------------------------------
# PASS: 4/4

# è¦†ç›–ç‡æµ‹è¯•
opa test policies/ --coverage --format=json | jq '.coverage'
# ç›®æ ‡: >90%è¦†ç›–ç‡
```

---

## ğŸš€ éƒ¨ç½²é…ç½®

### 1. Kuberneteséƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: product-service
  namespace: ecommerce
spec:
  replicas: 5
  selector:
    matchLabels:
      app: product-service
  template:
    metadata:
      labels:
        app: product-service
    spec:
      containers:
      # ä¸šåŠ¡å®¹å™¨
      - name: product-service
        image: product-service:v1.5.0
        ports:
        - name: http
          containerPort: 8080
        env:
        - name: OPA_URL
          value: "http://localhost:8181"
      
      # OPA Sidecar
      - name: opa-envoy
        image: openpolicyagent/opa:0.60.0-envoy
        args:
          - "run"
          - "--server"
          - "--addr=localhost:8181"
          - "--diagnostic-addr=0.0.0.0:8282"
          - "--set=plugins.envoy_ext_authz_grpc.addr=:9191"
          - "--set=plugins.envoy_ext_authz_grpc.path=envoy/authz/allow"
          - "--set=decision_logs.console=true"
          - "--set=bundles.ecommerce.service=bundle-server"
          - "--set=bundles.ecommerce.resource=bundles/authz-latest.tar.gz"
          - "--set=bundles.ecommerce.polling.min_delay_seconds=60"
          - "--set=bundles.ecommerce.polling.max_delay_seconds=120"
          - "--set=bundles.ecommerce.persist=true"
        ports:
        - name: grpc
          containerPort: 9191
        - name: http
          containerPort: 8181
        - name: diagnostic
          containerPort: 8282
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8282
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health?bundle=true
            port: 8282
          initialDelaySeconds: 10
          periodSeconds: 5
        volumeMounts:
        - name: opa-policy
          mountPath: /policies
          readOnly: true
      
      volumes:
      - name: opa-policy
        configMap:
          name: opa-policy
```

### 2. Envoyé…ç½®

```yaml
# envoy-config.yaml
static_resources:
  listeners:
  - name: main
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8000
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          # OPAå¤–éƒ¨æˆæƒè¿‡æ»¤å™¨
          - name: envoy.ext_authz
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
              transport_api_version: V3
              grpc_service:
                envoy_grpc:
                  cluster_name: opa
                timeout: 0.1s  # 100msè¶…æ—¶
              with_request_body:
                max_request_bytes: 8192
                allow_partial_message: true
              failure_mode_allow: false  # å¤±è´¥æ—¶æ‹’ç»è¯·æ±‚
          
          # è·¯ç”±è¿‡æ»¤å™¨
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: product_service

  clusters:
  # OPAé›†ç¾¤
  - name: opa
    type: STATIC
    connect_timeout: 0.25s
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
    load_assignment:
      cluster_name: opa
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 9191
  
  # åç«¯æœåŠ¡é›†ç¾¤
  - name: product_service
    type: STRICT_DNS
    connect_timeout: 0.25s
    load_assignment:
      cluster_name: product_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8080
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç­–ç•¥ä¼˜åŒ–

**é—®é¢˜**: åˆæœŸP99å»¶è¿Ÿ15msï¼Œä¸æ»¡è¶³<5msè¦æ±‚

**åˆ†æ**:

- ç­–ç•¥ä¸­å¤§é‡ä½¿ç”¨forå¾ªç¯éå†
- æƒé™æ•°æ®ç»“æ„æœªä¼˜åŒ–

**ä¼˜åŒ–å‰**:

```rego
# âŒ æ€§èƒ½å·®ï¼šO(n)å¤æ‚åº¦
permission := data.roles[role].permissions[_]
permission.resource == input.resource
```

**ä¼˜åŒ–å**:

```rego
# âœ… æ€§èƒ½å¥½ï¼šO(1)å¤æ‚åº¦
permissions := data.roles_index[role][input.resource]
```

**æ•°æ®ç»“æ„ä¼˜åŒ–**:

```json
{
  "roles": {
    "admin": {
      "permissions": [
        {"resource": "product", "action": "read"},
        {"resource": "product", "action": "write"}
      ]
    }
  },
  "roles_index": {
    "admin": {
      "product": [
        {"action": "read"},
        {"action": "write"}
      ]
    }
  }
}
```

**æ•ˆæœ**: P99å»¶è¿Ÿä»15msé™è‡³2.9ms âœ…

### 2. Bundleä¼˜åŒ–

**é—®é¢˜**: Bundle 50MBï¼ŒåŠ è½½æ—¶é—´30s

**ä¼˜åŒ–**:

- æ‹†åˆ†ç­–ç•¥å’Œæ•°æ®
- ä½¿ç”¨éƒ¨åˆ†æ±‚å€¼é¢„ç¼–è¯‘
- å¯ç”¨å‹ç¼©

```bash
# æ„å»ºä¼˜åŒ–çš„Bundle
opa build \
  --bundle policies/ \
  --optimize 1 \
  --entrypoint envoy/authz/allow \
  --output bundle.tar.gz

# å¤§å°å¯¹æ¯”
åŸå§‹: 50MB
ä¼˜åŒ–å: 5MB (å‡å°‘90%)

# åŠ è½½æ—¶é—´
åŸå§‹: 30s
ä¼˜åŒ–å: 3s (æå‡10å€)
```

### 3. ç›‘æ§æŒ‡æ ‡

```yaml
# prometheus-config.yaml
scrape_configs:
  - job_name: 'opa'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: product-service
      - source_labels: [__meta_kubernetes_pod_container_port_name]
        action: keep
        regex: diagnostic
```

**å…³é”®æŒ‡æ ‡**:

```promql
# P99å»¶è¿Ÿ
histogram_quantile(0.99, 
  rate(http_request_duration_seconds_bucket{job="opa"}[5m]))

# QPS
rate(http_request_count_total{job="opa"}[1m])

# é”™è¯¯ç‡
rate(http_request_errors_total{job="opa"}[5m]) / 
rate(http_request_count_total{job="opa"}[5m])
```

---

## ğŸ› é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜

#### é—®é¢˜1: Bundleæ›´æ–°å¯¼è‡´çŸ­æš‚æ‹’ç»

**ç°è±¡**: Bundleæ›´æ–°æ—¶100-200msè¯·æ±‚è¢«æ‹’ç»

**æ’æŸ¥**:

```bash
# æŸ¥çœ‹OPAæ—¥å¿—
kubectl logs product-service-xxx -c opa-envoy

# å…³é”®æ—¥å¿—
level=info msg="Bundle downloaded and activated"
level=warn msg="Decision during bundle load: denied"
```

**è§£å†³**:

```yaml
# å¯ç”¨æŒä¹…åŒ–ç¼“å­˜
bundles:
  ecommerce:
    persist: true
    # æœ¬åœ°ç¼“å­˜è·¯å¾„
    resource: file:///cache/bundle.tar.gz
```

#### é—®é¢˜2: é«˜å³°æœŸOOM

**ç°è±¡**: å¤§ä¿ƒæœŸé—´OPAå®¹å™¨è¢«OOMæ€æ‰

**æ’æŸ¥**:

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
kubectl top pod product-service-xxx -c opa-envoy

# æŸ¥çœ‹å†³ç­–æ—¥å¿—å¤§å°
kubectl exec product-service-xxx -c opa-envoy -- du -sh /tmp/
```

**è§£å†³**:

```yaml
# 1. ç¦ç”¨consoleæ—¥å¿—
decision_logs:
  console: false

# 2. å¢åŠ å†…å­˜é™åˆ¶
resources:
  limits:
    memory: "512Mi"

# 3. ä½¿ç”¨å¼‚æ­¥æ—¥å¿—
decision_logs:
  plugin: async_logger
  reporting:
    buffer_size_limit_bytes: 32768
```

---

## ğŸ“Š ç”Ÿäº§æ•°æ®

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| P50å»¶è¿Ÿ | <1ms | 0.8ms | âœ… |
| P95å»¶è¿Ÿ | <3ms | 2.1ms | âœ… |
| P99å»¶è¿Ÿ | <5ms | 2.9ms | âœ… |
| QPS | 50K | 65K | âœ… |
| CPUä½¿ç”¨ | <200m | 150m | âœ… |
| å†…å­˜ä½¿ç”¨ | <256Mi | 180Mi | âœ… |
| é”™è¯¯ç‡ | <0.01% | 0.003% | âœ… |

### æˆæœ¬åˆ†æ

| é¡¹ç›® | æ•°æ® |
|------|------|
| å¼€å‘å‘¨æœŸ | 3ä¸ªæœˆ |
| åŸºç¡€è®¾æ–½æˆæœ¬ | +15% (Sidecarå¼€é”€) |
| ç»´æŠ¤æˆæœ¬ | 2äºº/æœˆ |
| ROI | 6ä¸ªæœˆå›æœ¬ |

---

## ğŸ¯ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **ç­–ç•¥æ¨¡å—åŒ–**: ä¾¿äºç»´æŠ¤å’Œæµ‹è¯•
2. **ç´¢å¼•ä¼˜åŒ–**: æ•°æ®ç»“æ„è®¾è®¡æ˜¯æ€§èƒ½å…³é”®
3. **éƒ¨åˆ†æ±‚å€¼**: é¢„ç¼–è¯‘å¤§å¹…æå‡æ€§èƒ½
4. **å®Œæ•´æµ‹è¯•**: 90%+è¦†ç›–ç‡ä¿è¯è´¨é‡
5. **æ¸è¿›å¼ä¸Šçº¿**: ç°åº¦å‘å¸ƒé™ä½é£é™©

### è¸©å‘è®°å½•

1. **æœªä¼˜åŒ–ç´¢å¼•**: å¯¼è‡´å»¶è¿Ÿè¿‡é«˜
2. **Bundleè¿‡å¤§**: å½±å“åŠ è½½é€Ÿåº¦
3. **æ—¥å¿—è¿‡å¤š**: å¯¼è‡´OOM
4. **æœªåšé™çº§**: æ•…éšœæ—¶å½±å“ä¸šåŠ¡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIç½‘å…³æˆæƒ](../05-åº”ç”¨åœºæ™¯/05.2-APIç½‘å…³æˆæƒ.md)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../08-æœ€ä½³å®è·µ/08.2-æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)
- [ç”Ÿäº§æ¡ˆä¾‹é›†](../../PRODUCTION_CASES.md)
- [æ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## âš ï¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„

> **éƒ¨ç½²å‰è¯·ç¡®è®¤**:
>
> - âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–ï¼ˆå•å…ƒ+é›†æˆ+å‹æµ‹ï¼‰
> - âœ… ç›‘æ§å‘Šè­¦å·²é…ç½®
> - âœ… é™çº§æ–¹æ¡ˆå·²å‡†å¤‡
> - âœ… å›¢é˜Ÿå·²åŸ¹è®­
> - âœ… åº”æ€¥é¢„æ¡ˆå·²æ¼”ç»ƒ

å‚è§: [ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-21  
**ç»´æŠ¤è€…**: OPAä¸­æ–‡æ–‡æ¡£å›¢é˜Ÿ
