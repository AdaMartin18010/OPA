# æ€§èƒ½ä¼˜åŒ–æŒ‡å—ï¼ˆPerformance Optimization Guideï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.55+ | æ¨è v0.68+  
> **Regoç‰ˆæœ¬**: v1.0  
> **æ€§èƒ½ç›®æ ‡**: P99 < 10ms, åå > 10k req/s  
> **ä¼˜åŒ–æ–¹æ³•**: ç­–ç•¥ä¼˜åŒ–ã€æ¶æ„ä¼˜åŒ–ã€ç³»ç»Ÿä¼˜åŒ–  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/policy-performance/>

---

## âš ï¸ æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§

> **ä¼˜åŒ–ç­–ç•¥å»ºè®®**:
>
> - âœ… **å…ˆæµ‹é‡å†ä¼˜åŒ–**: ä½¿ç”¨`opa bench`å’Œprofilingç¡®å®šç“¶é¢ˆ
> - âœ… **80/20æ³•åˆ™**: ä¼˜å…ˆä¼˜åŒ–æœ€çƒ­è·¯å¾„ï¼ˆé€šå¸¸20%ä»£ç å 80%æ€§èƒ½ï¼‰
> - âœ… **æ•°æ®ç»“æ„ä¼˜å…ˆ**: ç´¢å¼•ä¼˜åŒ–é€šå¸¸æ¯”ç®—æ³•ä¼˜åŒ–æ•ˆæœæ›´æ˜¾è‘—
> - âœ… **éªŒè¯ä¼˜åŒ–æ•ˆæœ**: æ¯æ¬¡ä¼˜åŒ–åé‡æ–°æµ‹é‡ï¼Œç¡®è®¤æ”¹è¿›
> - âš ï¸ è¿‡åº¦ä¼˜åŒ–å¯èƒ½é™ä½å¯è¯»æ€§ï¼Œæƒè¡¡tradeoff
> - âš ï¸ å¾®ä¼˜åŒ–ï¼ˆå¦‚å‡å°‘ä¸€æ¬¡å¾ªç¯ï¼‰é€šå¸¸ä¸å¦‚ç»“æ„æ€§ä¼˜åŒ–
>
> **å…¸å‹æ€§èƒ½åŸºå‡†**:
>
> - Sidecaræ¨¡å¼: P99 < 5ms, QPS > 10K
> - é›†ä¸­å¼: P99 < 10ms, QPS > 50K  
> - WASM: P99 < 2ms, QPS > 100K
>
> å®æˆ˜æ¡ˆä¾‹: [ç”µå•†æ€§èƒ½ä¼˜åŒ–](../../PRODUCTION_CASES.md#1-ç­–ç•¥ä¼˜åŒ–) | [æ£€æŸ¥æ¸…å•-æ€§èƒ½ä¼˜åŒ–](../../CHECKLIST.md#6ï¸âƒ£-æ€§èƒ½ä¼˜åŒ–é˜¶æ®µ)

---

## ğŸ“ English Summary

This is the definitive guide for optimizing OPA policy performance in production systems.

**Key Topics**:
- **Measurement**: Profiling with `opa bench`, `--profile` flag, metrics analysis
- **Indexing**: Hash table lookup (O(1)) vs. array iteration (O(n))
- **Query Optimization**: Query ordering, early termination, caching strategies
- **Data Structures**: Sets vs. arrays, object keys vs. values
- **Architecture**: Sidecar vs. centralized, WASM compilation, partial evaluation

**Performance Targets**: P99 < 10ms, Throughput > 10k req/s (varies by deployment)

**Target Audience**: Performance engineers, DevOps, production OPA operators.

---

## 1. æ€§èƒ½ç›®æ ‡

### 1.1 æ€§èƒ½åŸºå‡†

```text
åœºæ™¯: ç”Ÿäº§ç¯å¢ƒRBACç­–ç•¥

æ€§èƒ½ç›®æ ‡:
  P50å»¶è¿Ÿ:  < 1ms
  P99å»¶è¿Ÿ:  < 10ms
  ååé‡:   > 10,000 req/s
  CPUä½¿ç”¨:  < 50%
  å†…å­˜å ç”¨: < 500MB
```

### 1.2 æµ‹é‡æ–¹æ³•

**åŸºå‡†æµ‹è¯•**ï¼š

```bash
# OPA bench
opa bench policy.rego \
    -d data.json \
    -i input.json \
    --count 10000

# è¾“å‡º
+----------------+---------+---------+---------+
| Metric         | Min     | Avg     | Max     |
+----------------+---------+---------+---------+
| Time (ns)      | 50000   | 100000  | 500000  |
| Memory (bytes) | 1024    | 2048    | 4096    |
+----------------+---------+---------+---------+
```

---

## 2. ç­–ç•¥å±‚ä¼˜åŒ–

### 2.1 é¿å…åæ¨¡å¼

**âŒ åæ¨¡å¼1: å…¨è¡¨æ‰«æ**:

```rego
# æ…¢: O(n)
user_by_email(email) := user if {
    some user in data.users
    user.email == email
}

# å¿«: O(1)
user_by_email(email) := data.users_by_email[email]
```

**âŒ åæ¨¡å¼2: ç¬›å¡å°”ç§¯**:

```rego
# æ…¢: O(nÂ²)
conflicts := [[u1, u2] |
    some u1 in data.users
    some u2 in data.users
    u1.team == u2.team
]

# å¿«: O(n)
by_team := {team: users |
    some user in data.users
    team := user.team
    users := [u | some u in data.users; u.team == team]
}
```

**âŒ åæ¨¡å¼3: é‡å¤è®¡ç®—**:

```rego
# æ…¢: å¤šæ¬¡è®¡ç®—
allow if {
    count(input.permissions) > 5
    count(input.permissions) < 20
}

# å¿«: ç¼“å­˜ç»“æœ
perm_count := count(input.permissions)
allow if {
    perm_count > 5
    perm_count < 20
}
```

### 2.2 æœ€ä½³å®è·µ

**âœ… ä½¿ç”¨é›†åˆæ“ä½œ**:

```rego
# é›†åˆäº¤é›†
allowed := user_permissions & required_permissions

# é›†åˆåŒ…å«
allow if {
    "admin" in input.user.roles
}
```

**âœ… æå‰é€€å‡º**:

```rego
allow if {
    # å¿«é€Ÿæ£€æŸ¥åœ¨å‰
    input.method == "GET"
    
    # æ˜‚è´µæ“ä½œåœ¨å
    user := data.users[input.user_id]
    check_permissions(user)
}
```

**âœ… ç´¢å¼•è®¿é—®**:

```rego
# ç›´æ¥ç´¢å¼•
user := data.users[input.user_id]
role := data.roles[user.role_id]

# é¿å…æœç´¢
# âŒ some user in data.users; user.id == input.user_id
```

---

## 3. æ•°æ®å±‚ä¼˜åŒ–

### 3.1 æ•°æ®ç»“æ„ä¼˜åŒ–

**å¯¹è±¡åŒ–æ•°ç»„**ï¼š

```json
// âŒ æ•°ç»„ - éœ€è¦æœç´¢
{
  "users": [
    {"id": "u1", "name": "alice"},
    {"id": "u2", "name": "bob"}
  ]
}

// âœ… å¯¹è±¡ - ç›´æ¥ç´¢å¼•
{
  "users": {
    "u1": {"name": "alice"},
    "u2": {"name": "bob"}
  }
}
```

**é¢„è®¡ç®—ç´¢å¼•**ï¼š

```json
{
  "users": [...],
  "indexes": {
    "by_email": {
      "alice@example.com": "u1",
      "bob@example.com": "u2"
    },
    "by_role": {
      "admin": ["u1"],
      "user": ["u2"]
    }
  }
}
```

### 3.2 æ•°æ®åˆ†ç‰‡

**æŒ‰è®¿é—®æ¨¡å¼åˆ†ç‰‡**ï¼š

```text
åŸå§‹: å•ä¸€å¤§JSON (10MB)
  â”œâ”€â”€ åŠ è½½æ…¢
  â”œâ”€â”€ å†…å­˜å ç”¨é«˜
  â””â”€â”€ æ›´æ–°æˆæœ¬å¤§

ä¼˜åŒ–: æŒ‰æ¨¡å—åˆ†ç‰‡
  â”œâ”€â”€ users.json (2MB)
  â”œâ”€â”€ roles.json (1MB)
  â”œâ”€â”€ permissions.json (3MB)
  â””â”€â”€ resources.json (4MB)

æ•ˆæœ:
  âœ… æŒ‰éœ€åŠ è½½
  âœ… å†…å­˜å‹å¥½
  âœ… æ›´æ–°ç²’åº¦ç»†
```

---

## 4. ç¼–è¯‘å™¨ä¼˜åŒ–

### 4.1 éƒ¨åˆ†æ±‚å€¼

**åœºæ™¯**: æ•°æ®å˜åŒ–æ…¢ï¼ŒæŸ¥è¯¢å˜åŒ–å¿«

```bash
# éƒ¨åˆ†æ±‚å€¼
opa build \
    --target wasm \
    --partial \
    --unknowns input \
    policy/ data/

# æ•ˆæœ:
#   ç­–ç•¥å¤§å°: 10MB â†’ 100KB (100x)
#   æ±‚å€¼å»¶è¿Ÿ: 5ms â†’ 0.1ms (50x)
```

### 4.2 ç¼–è¯‘ä¼˜åŒ–çº§åˆ«

```bash
# çº§åˆ«0: æ— ä¼˜åŒ–ï¼ˆè°ƒè¯•ï¼‰
opa build --optimize=0 policy/

# çº§åˆ«1: æ ‡å‡†ä¼˜åŒ–ï¼ˆé»˜è®¤ï¼‰
opa build --optimize=1 policy/

# çº§åˆ«2: æ¿€è¿›ä¼˜åŒ–ï¼ˆç”Ÿäº§ï¼‰
opa build --optimize=2 policy/

# å¯¹æ¯”:
#   çº§åˆ«0: ç¼–è¯‘5s, æ‰§è¡Œ10ms
#   çº§åˆ«1: ç¼–è¯‘10s, æ‰§è¡Œ2ms
#   çº§åˆ«2: ç¼–è¯‘30s, æ‰§è¡Œ0.5ms
```

---

## 5. è¿è¡Œæ—¶ä¼˜åŒ–

### 5.1 ç¼“å­˜é…ç½®

**å¯ç”¨ç¼“å­˜**ï¼š

```yaml
# config.yaml
caching:
  inter_query_builtin_cache:
    max_size_bytes: 10485760  # 10MB
```

**å—ç›Šå‡½æ•°**ï¼š

```rego
# HTTPè¯·æ±‚ç¼“å­˜
response := http.send({
    "method": "GET",
    "url": "https://api.example.com/data"
})

# JWTè§£ç ç¼“å­˜
[header, payload, sig] := io.jwt.decode(input.token)

# æ­£åˆ™ç¼“å­˜
regex.match(`^[a-z]+$`, input.name)
```

### 5.2 è¿æ¥æ± 

**Goåº”ç”¨**ï¼š

```go
// å¤ç”¨OPAå®ä¾‹
var opaPool = sync.Pool{
    New: func() interface{} {
        opa, _ := rego.New(
            rego.Query("data.authz.allow"),
            rego.Load([]string{"policy.rego"}, nil),
        ).PrepareForEval(context.Background())
        return opa
    },
}

func authorize(ctx context.Context, input map[string]interface{}) (bool, error) {
    pq := opaPool.Get().(rego.PreparedEvalQuery)
    defer opaPool.Put(pq)
    
    rs, err := pq.Eval(ctx, rego.EvalInput(input))
    if err != nil {
        return false, err
    }
    return rs.Allowed(), nil
}
```

### 5.3 æ‰¹é‡æ±‚å€¼

**æ‰¹é‡API**ï¼š

```bash
# æ‰¹é‡è¯·æ±‚
curl -X POST http://localhost:8181/v1/data/authz/allow \
  -d '{
    "inputs": [
      {"user": "alice", "resource": "doc1"},
      {"user": "bob", "resource": "doc2"}
    ]
  }'

# æ€§èƒ½æå‡: 3-5x
```

---

## 6. éƒ¨ç½²ä¼˜åŒ–

### 6.1 Sidecaræ¨¡å¼

**ä¼˜åŠ¿**ï¼š

```text
1. ä½å»¶è¿Ÿ
   â””â”€â”€ æœ¬åœ°è°ƒç”¨ï¼Œæ— ç½‘ç»œå¼€é”€

2. é«˜åå
   â””â”€â”€ æ¯æœåŠ¡ç‹¬ç«‹å®ä¾‹

3. èµ„æºéš”ç¦»
   â””â”€â”€ æ•…éšœä¸æ‰©æ•£

é…ç½®:
  - CPU: 100m request, 500m limit
  - Memory: 128Mi request, 512Mi limit
```

**Kubernetesé…ç½®**ï¼š

```yaml
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: app
      image: my-app:latest
    
    - name: opa
      image: openpolicyagent/opa:latest
      args:
        - "run"
        - "--server"
        - "--addr=localhost:8181"
        - "/policies/policy.wasm"
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
```

### 6.2 WASMéƒ¨ç½²

**ä¼˜åŠ¿**ï¼š

```text
1. æ›´å°
   â””â”€â”€ Bundle: 10MB â†’ 100KB

2. æ›´å¿«
   â””â”€â”€ å†·å¯åŠ¨: 500ms â†’ 10ms

3. å¯ç§»æ¤
   â””â”€â”€ æµè§ˆå™¨ã€è¾¹ç¼˜ã€æœåŠ¡å™¨
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```text
âœ… è¾¹ç¼˜è®¡ç®—ï¼ˆCDNï¼‰
âœ… æµè§ˆå™¨ç«¯æˆæƒ
âœ… Serverlesså‡½æ•°
âœ… IoTè®¾å¤‡
```

---

## 7. ç›‘æ§ä¸è°ƒä¼˜

### 7.1 æ€§èƒ½å‰–æ

**CPU Profiling**ï¼š

```bash
# å¯ç”¨profiling
curl http://localhost:8181/debug/pprof/profile?seconds=30 > cpu.prof

# åˆ†æ
go tool pprof cpu.prof
(pprof) top10
(pprof) web
```

**å†…å­˜Profiling**ï¼š

```bash
curl http://localhost:8181/debug/pprof/heap > mem.prof
go tool pprof mem.prof
(pprof) top10
(pprof) list <function>
```

### 7.2 å…³é”®æŒ‡æ ‡

**Prometheus Metrics**ï¼š

```promql
# æ±‚å€¼å»¶è¿ŸP99
histogram_quantile(0.99,
  rate(opa_http_request_duration_seconds_bucket[5m])
)

# ååé‡
rate(opa_http_request_total[5m])

# é”™è¯¯ç‡
rate(opa_http_request_total{code=~"5.."}[5m]) /
rate(opa_http_request_total[5m])

# å†…å­˜ä½¿ç”¨
go_memstats_alloc_bytes
```

### 7.3 å‘Šè­¦è§„åˆ™

```yaml
groups:
  - name: opa_performance
    rules:
      - alert: OPAHighLatency
        expr: histogram_quantile(0.99, opa_http_request_duration_seconds_bucket) > 0.01
        for: 5m
        annotations:
          summary: "OPA P99å»¶è¿Ÿ > 10ms"
      
      - alert: OPALowThroughput
        expr: rate(opa_http_request_total[5m]) < 1000
        for: 5m
        annotations:
          summary: "OPAååé‡ < 1000 req/s"
```

---

## 8. å®æˆ˜æ¡ˆä¾‹

### 8.1 å¤§è§„æ¨¡RBAC

**åœºæ™¯**: 10,000ç”¨æˆ·, 1,000è§’è‰², 100,000æƒé™

**ä¼˜åŒ–å‰**ï¼š

```rego
# P99: 50ms
allow if {
    some role in input.user.roles
    some perm in data.role_permissions[role]
    perm.resource == input.resource
    perm.action == input.action
}
```

**ä¼˜åŒ–å**ï¼š

```rego
# 1. é¢„è®¡ç®—ç”¨æˆ·æƒé™
user_perms := {p |
    some role in input.user.roles
    some p in data.role_permissions[role]
}

# 2. ä½¿ç”¨é›†åˆæ“ä½œ
required := {input.resource, input.action}
allow if {
    some perm in user_perms
    {perm.resource, perm.action} == required
}

# P99: 0.5ms (100xæå‡)
```

### 8.2 å®æ—¶æ—¥å¿—è¿‡æ»¤

**åœºæ™¯**: è¿‡æ»¤1Mæ¡æ—¥å¿—

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```rego
# 1. å¸ƒéš†è¿‡æ»¤å™¨é¢„ç­›é€‰
suspicious_ips := bloom_filter_from_set(data.blacklist)

filtered_logs := [log |
    some log in input.logs
    bloom_filter.may_contain(suspicious_ips, log.ip)  # å¿«é€Ÿå¦å®š
    exact_check(log)  # ç²¾ç¡®æ£€æŸ¥
]

# 2. ä½å›¾ç´¢å¼•
logs_by_level := {
    "ERROR": roaring.bitmap([1, 5, 10, ...]),
    "WARN": roaring.bitmap([2, 3, 8, ...])
}

error_logs := [input.logs[i] |
    some i in roaring.to_array(logs_by_level["ERROR"])
]

# æ€§èƒ½: 5s â†’ 50ms (100xæå‡)
```

---

## 9. ä¼˜åŒ–æ¸…å•

### 9.1 ç­–ç•¥å±‚

```text
â–¡ é¿å…å…¨è¡¨æ‰«æ
â–¡ é¿å…ç¬›å¡å°”ç§¯
â–¡ é¿å…é‡å¤è®¡ç®—
â–¡ ä½¿ç”¨é›†åˆæ“ä½œ
â–¡ æå‰é€€å‡º
â–¡ ç¼“å­˜æ˜‚è´µè®¡ç®—
â–¡ ä½¿ç”¨ç´¢å¼•è®¿é—®
â–¡ ç®€åŒ–è§„åˆ™é€»è¾‘
```

### 9.2 æ•°æ®å±‚

```text
â–¡ å¯¹è±¡åŒ–æ•°ç»„
â–¡ é¢„è®¡ç®—ç´¢å¼•
â–¡ æ•°æ®åˆ†ç‰‡
â–¡ æ‰å¹³åŒ–åµŒå¥—
â–¡ ç§»é™¤å†—ä½™æ•°æ®
â–¡ å‹ç¼©æ•°æ®
```

### 9.3 éƒ¨ç½²å±‚

```text
â–¡ å¯ç”¨éƒ¨åˆ†æ±‚å€¼
â–¡ ä½¿ç”¨WASMï¼ˆè¾¹ç¼˜ï¼‰
â–¡ Sidecaræ¨¡å¼ï¼ˆK8sï¼‰
â–¡ å¯ç”¨ç¼“å­˜
â–¡ è¿æ¥æ± /å®ä¾‹å¤ç”¨
â–¡ èµ„æºé…é¢åˆç†
â–¡ å¤šå‰¯æœ¬é«˜å¯ç”¨
```

### 9.4 ç›‘æ§å±‚

```text
â–¡ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
â–¡ æ—¥å¿—è®°å½•
â–¡ å‘Šè­¦é…ç½®
â–¡ å®šæœŸåŸºå‡†æµ‹è¯•
â–¡ çƒ­ç‚¹åˆ†æ
â–¡ ç“¶é¢ˆè¯†åˆ«
```

---

## 10. å¿«é€Ÿè¯Šæ–­

**æ€§èƒ½é—®é¢˜å†³ç­–æ ‘**ï¼š

```text
æ€§èƒ½æ…¢ï¼Ÿ
â”œâ”€ å»¶è¿Ÿé«˜ï¼Ÿ
â”‚  â”œâ”€ ç­–ç•¥å¤æ‚ï¼Ÿâ†’ ç®€åŒ–è§„åˆ™ï¼Œä¼˜åŒ–ç®—æ³•
â”‚  â”œâ”€ æ•°æ®å¤§ï¼Ÿâ†’ ç´¢å¼•ï¼Œåˆ†ç‰‡ï¼Œéƒ¨åˆ†æ±‚å€¼
â”‚  â””â”€ ç½‘ç»œæ…¢ï¼Ÿâ†’ Sidecaræ¨¡å¼ï¼ŒWASM
â”‚
â”œâ”€ ååä½ï¼Ÿ
â”‚  â”œâ”€ CPUç“¶é¢ˆï¼Ÿâ†’ å¢åŠ å‰¯æœ¬ï¼Œä¼˜åŒ–ç®—æ³•
â”‚  â”œâ”€ å†…å­˜ä¸è¶³ï¼Ÿâ†’ ä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œåˆ†ç‰‡
â”‚  â””â”€ GCé¢‘ç¹ï¼Ÿâ†’ è°ƒæ•´GOGCï¼Œå¢åŠ å†…å­˜
â”‚
â””â”€ å†…å­˜é«˜ï¼Ÿ
   â”œâ”€ æ•°æ®å¤§ï¼Ÿâ†’ åˆ†ç‰‡ï¼ŒæŒ‰éœ€åŠ è½½
   â”œâ”€ ç¼“å­˜å¤§ï¼Ÿâ†’ è°ƒæ•´ç¼“å­˜å¤§å°
   â””â”€ æ³„æ¼ï¼Ÿâ†’ Profilingï¼Œä¿®å¤ä»£ç 
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [æ€§èƒ½åŸºå‡†ä¸åº¦é‡](../01-æŠ€æœ¯è§„èŒƒ/01.4-æ€§èƒ½åŸºå‡†ä¸åº¦é‡.md)
- [ç´¢å¼•ä¸ä¼˜åŒ–](../03-å®ç°æ¶æ„/03.5-ç´¢å¼•ä¸ä¼˜åŒ–.md)
- [éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯](../03-å®ç°æ¶æ„/03.6-éƒ¨åˆ†æ±‚å€¼æŠ€æœ¯.md)

**å‚è€ƒèµ„æº**ï¼š

- Performance Tips: <https://www.openpolicyagent.org/docs/latest/policy-performance/>
- Go Performance: <https://go.dev/doc/diagnostics>
