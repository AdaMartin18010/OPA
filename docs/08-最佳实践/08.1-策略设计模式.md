# ç­–ç•¥è®¾è®¡æ¨¡å¼ï¼ˆPolicy Design Patternsï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.55+ | æ¨è v0.68+  
> **Regoç‰ˆæœ¬**: v1.0  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯  
> **ç›®æ ‡**: å¯ç»´æŠ¤ã€å¯æµ‹è¯•ã€é«˜æ€§èƒ½çš„ç­–ç•¥

---

## âš ï¸ ç”Ÿäº§ç¯å¢ƒæç¤º

> **è®¾è®¡æ¨¡å¼ä½¿ç”¨å»ºè®®**:
>
> - âœ… éµå¾ªSOLIDåŸåˆ™ï¼Œæé«˜ç­–ç•¥å¯ç»´æŠ¤æ€§
> - âœ… ä½¿ç”¨é»˜è®¤æ‹’ç»æ¨¡å¼ç¡®ä¿å®‰å…¨æ€§
> - âœ… 90%+æµ‹è¯•è¦†ç›–ç‡ï¼ŒåŒ…å«è¾¹ç•Œç”¨ä¾‹
> - âœ… æ€§èƒ½æµ‹è¯•éªŒè¯ï¼ˆç‰¹åˆ«æ˜¯å¤§æ•°æ®åœºæ™¯ï¼‰
> - âš ï¸ é¿å…è¿‡åº¦æŠ½è±¡å¯¼è‡´ç†è§£å›°éš¾
> - âš ï¸ å¤æ‚æ¨¡å¼éœ€è¦è¯¦ç»†æ–‡æ¡£è¯´æ˜
>
> **åæ¨¡å¼è­¦å‘Š**: æœ¬æ–‡æ¡£åˆ—å‡ºçš„æ‰€æœ‰åæ¨¡å¼éƒ½æ›¾åœ¨ç”Ÿäº§ç¯å¢ƒé€ æˆé—®é¢˜ï¼Œè¯·åŠ¡å¿…é¿å…ã€‚
>
> ç›¸å…³: [ç”Ÿäº§æ¡ˆä¾‹é›†](../../PRODUCTION_CASES.md) | [æ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## ğŸ“ English Summary

A collection of proven design patterns and anti-patterns for writing maintainable OPA policies.

**Key Topics**:

- **SOLID Principles**: Applied to policy design (Single Responsibility, Open/Closed, etc.)
- **Common Patterns**: Default Deny, Explicit Deny, Layered Architecture, Namespace Pattern
- **Template Pattern**: Reusable policy components with parameterization
- **Anti-Patterns**: Deep nesting, magic numbers, god rules, copy-paste duplication
- **Best Practices**: Testability, performance, security considerations

**Target Audience**: Senior policy developers, architects designing policy frameworks.

**Version**: OPA v0.55+ (Recommended: v0.68+), Rego v1.0

---

## ç›®å½•

- [ç­–ç•¥è®¾è®¡æ¨¡å¼ï¼ˆPolicy Design Patternsï¼‰](#ç­–ç•¥è®¾è®¡æ¨¡å¼policy-design-patterns)
  - [âš ï¸ ç”Ÿäº§ç¯å¢ƒæç¤º](#ï¸-ç”Ÿäº§ç¯å¢ƒæç¤º)
  - [ğŸ“ English Summary](#-english-summary)
  - [ç›®å½•](#ç›®å½•)
  - [1. è®¾è®¡åŸåˆ™](#1-è®¾è®¡åŸåˆ™)
    - [1.1 SOLIDåŸåˆ™åœ¨Regoä¸­çš„åº”ç”¨](#11-solidåŸåˆ™åœ¨regoä¸­çš„åº”ç”¨)
      - [1.1.1 å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibilityï¼‰](#111-å•ä¸€èŒè´£åŸåˆ™single-responsibility)
      - [1.1.2 å¼€é—­åŸåˆ™ï¼ˆOpen-Closedï¼‰](#112-å¼€é—­åŸåˆ™open-closed)
      - [1.1.3 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDependency Inversionï¼‰](#113-ä¾èµ–å€’ç½®åŸåˆ™dependency-inversion)
    - [1.2 DRYåŸåˆ™ï¼ˆDon't Repeat Yourselfï¼‰](#12-dryåŸåˆ™dont-repeat-yourself)
    - [1.3 æ¸…æ™°å‘½å](#13-æ¸…æ™°å‘½å)
  - [2. ç»“æ„åŒ–æ¨¡å¼](#2-ç»“æ„åŒ–æ¨¡å¼)
    - [2.1 åˆ†å±‚æ¶æ„æ¨¡å¼](#21-åˆ†å±‚æ¶æ„æ¨¡å¼)
    - [2.2 ç­–ç•¥ç»„åˆæ¨¡å¼](#22-ç­–ç•¥ç»„åˆæ¨¡å¼)
      - [2.2.1 "AND"ç»„åˆï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰](#221-andç»„åˆå…¨éƒ¨æ»¡è¶³)
      - [2.2.2 "OR"ç»„åˆï¼ˆä»»ä¸€æ»¡è¶³ï¼‰](#222-orç»„åˆä»»ä¸€æ»¡è¶³)
      - [2.2.3 ä¼˜å…ˆçº§ç»„åˆ](#223-ä¼˜å…ˆçº§ç»„åˆ)
    - [2.3 å‘½åç©ºé—´æ¨¡å¼](#23-å‘½åç©ºé—´æ¨¡å¼)
    - [2.4 æ¨¡æ¿æ¨¡å¼](#24-æ¨¡æ¿æ¨¡å¼)
  - [3. å†³ç­–æ¨¡å¼](#3-å†³ç­–æ¨¡å¼)
    - [3.1 é»˜è®¤æ‹’ç»æ¨¡å¼ï¼ˆDefault Denyï¼‰](#31-é»˜è®¤æ‹’ç»æ¨¡å¼default-deny)
    - [3.2 æ˜ç¡®æ‹’ç»æ¨¡å¼ï¼ˆExplicit Denyï¼‰](#32-æ˜ç¡®æ‹’ç»æ¨¡å¼explicit-deny)
    - [3.3 å®¡è®¡æ¨¡å¼ï¼ˆAudit Modeï¼‰](#33-å®¡è®¡æ¨¡å¼audit-mode)
    - [3.4 æ¸è¿›å¼è¿ç§»æ¨¡å¼](#34-æ¸è¿›å¼è¿ç§»æ¨¡å¼)
  - [4. æ•°æ®æ¨¡å¼](#4-æ•°æ®æ¨¡å¼)
    - [4.1 æ•°æ®è®¿é—®å°è£…](#41-æ•°æ®è®¿é—®å°è£…)
    - [4.2 æ•°æ®éªŒè¯æ¨¡å¼](#42-æ•°æ®éªŒè¯æ¨¡å¼)
    - [4.3 æ•°æ®è§„èŒƒåŒ–æ¨¡å¼](#43-æ•°æ®è§„èŒƒåŒ–æ¨¡å¼)
    - [4.4 æ•°æ®æŠ•å½±æ¨¡å¼](#44-æ•°æ®æŠ•å½±æ¨¡å¼)
  - [5. åæ¨¡å¼ï¼ˆAnti-Patternsï¼‰](#5-åæ¨¡å¼anti-patterns)
    - [5.1 âŒ é­”æ³•æ•°å­—/å­—ç¬¦ä¸²](#51--é­”æ³•æ•°å­—å­—ç¬¦ä¸²)
    - [5.2 âŒ è¿‡æ·±åµŒå¥—](#52--è¿‡æ·±åµŒå¥—)
    - [5.3 âŒ ä¸å®‰å…¨çš„å˜é‡](#53--ä¸å®‰å…¨çš„å˜é‡)
    - [5.4 âŒ å‰¯ä½œç”¨](#54--å‰¯ä½œç”¨)
    - [5.5 âŒ è¿‡åº¦ä¼˜åŒ–](#55--è¿‡åº¦ä¼˜åŒ–)
  - [6. é‡æ„æŠ€å·§](#6-é‡æ„æŠ€å·§)
    - [6.1 æå–è¾…åŠ©è§„åˆ™](#61-æå–è¾…åŠ©è§„åˆ™)
    - [6.2 åˆå¹¶é‡å¤æ¡ä»¶](#62-åˆå¹¶é‡å¤æ¡ä»¶)
    - [6.3 ä½¿ç”¨é›†åˆæ¨å¯¼ç®€åŒ–](#63-ä½¿ç”¨é›†åˆæ¨å¯¼ç®€åŒ–)
    - [6.4 ç­–ç•¥ç‰ˆæœ¬åŒ–](#64-ç­–ç•¥ç‰ˆæœ¬åŒ–)
  - [é™„å½•: è®¾è®¡æ£€æŸ¥æ¸…å•](#é™„å½•-è®¾è®¡æ£€æŸ¥æ¸…å•)
    - [ä»£ç è´¨é‡æ£€æŸ¥](#ä»£ç è´¨é‡æ£€æŸ¥)
    - [æ€§èƒ½æ£€æŸ¥](#æ€§èƒ½æ£€æŸ¥)
    - [æµ‹è¯•æ£€æŸ¥](#æµ‹è¯•æ£€æŸ¥)
    - [å®‰å…¨æ£€æŸ¥](#å®‰å…¨æ£€æŸ¥)

---

## 1. è®¾è®¡åŸåˆ™

### 1.1 SOLIDåŸåˆ™åœ¨Regoä¸­çš„åº”ç”¨

#### 1.1.1 å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibilityï¼‰

**åŸåˆ™**: æ¯ä¸ªè§„åˆ™åªåšä¸€ä»¶äº‹ã€‚

**âŒ åä¾‹**:

```rego
allow if {
    # æ··æ‚äº†è®¤è¯ã€æˆæƒã€å®¡è®¡é€»è¾‘
    user := data.users[input.user_id]
    user.active == true
    user.email_verified == true
    some role in user.roles
    data.roles[role].permissions[_] == input.action
    log_access(user, input.action)  # å‰¯ä½œç”¨ï¼
}
```

**âœ… æ­£ä¾‹**:

```rego
# 1. è®¤è¯æ£€æŸ¥
is_authenticated if {
    user := data.users[input.user_id]
    user.active == true
    user.email_verified == true
}

# 2. æˆæƒæ£€æŸ¥
has_permission if {
    some role in user_roles
    data.roles[role].permissions[_] == input.action
}

# 3. ä¸»å†³ç­–
allow if {
    is_authenticated
    has_permission
}
```

---

#### 1.1.2 å¼€é—­åŸåˆ™ï¼ˆOpen-Closedï¼‰

**åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‚

**âœ… ç¤ºä¾‹**:

```rego
# åŸºç¡€è§„åˆ™ï¼ˆä¸ä¿®æ”¹ï¼‰
allow if {
    some rule in allow_rules
    rule
}

# æ‰©å±•è§„åˆ™ï¼ˆæ·»åŠ æ–°è§„åˆ™ï¼‰
allow_rules contains is_admin
allow_rules contains is_resource_owner
allow_rules contains is_delegated

# å…·ä½“å®ç°
is_admin if { "admin" in user_roles }
is_resource_owner if { resource.owner == input.user }
is_delegated if { has_delegation }
```

---

#### 1.1.3 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDependency Inversionï¼‰

**åŸåˆ™**: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°ã€‚

**âœ… ç¤ºä¾‹**:

```rego
# æŠ½è±¡æ¥å£
allow if {
    authenticate()
    authorize()
}

# å…·ä½“å®ç°å¯æ›¿æ¢
authenticate := jwt_auth if {
    input.auth_type == "jwt"
}

authenticate := api_key_auth if {
    input.auth_type == "api_key"
}

authorize := rbac_authz if {
    data.authz_mode == "rbac"
}

authorize := abac_authz if {
    data.authz_mode == "abac"
}
```

---

### 1.2 DRYåŸåˆ™ï¼ˆDon't Repeat Yourselfï¼‰

**âŒ åä¾‹**ï¼ˆé‡å¤ä»£ç ï¼‰:

```rego
allow_read if {
    user := data.users[input.user]
    user.department == "engineering"
    user.active == true
}

allow_write if {
    user := data.users[input.user]
    user.department == "engineering"
    user.active == true
    user.level >= 3
}
```

**âœ… æ­£ä¾‹**ï¼ˆæŠ½å–å…¬å…±é€»è¾‘ï¼‰:

```rego
is_engineering_user if {
    user := data.users[input.user]
    user.department == "engineering"
    user.active == true
}

allow_read if {
    is_engineering_user
}

allow_write if {
    is_engineering_user
    user := data.users[input.user]
    user.level >= 3
}
```

---

### 1.3 æ¸…æ™°å‘½å

**è§„åˆ™å‘½åçº¦å®š**:

```rego
# å¸ƒå°”å€¼ï¼šis_/has_/can_/should_
is_authenticated
has_permission
can_access
should_audit

# é›†åˆï¼šå¤æ•°åè¯
user_roles
allowed_actions
admin_users

# è¾…åŠ©å‡½æ•°ï¼šåŠ¨è¯å¼€å¤´
get_user_info
check_quota
validate_token
```

---

## 2. ç»“æ„åŒ–æ¨¡å¼

### 2.1 åˆ†å±‚æ¶æ„æ¨¡å¼

**ç»“æ„**:

```text
ç­–ç•¥åˆ†å±‚
â”œâ”€â”€ æ¥å£å±‚ (Interface Layer)
â”‚   â””â”€â”€ allow, deny (å¯¹å¤–æ¥å£)
â”œâ”€â”€ ä¸šåŠ¡å±‚ (Business Layer)
â”‚   â””â”€â”€ ä¸šåŠ¡è§„åˆ™
â”œâ”€â”€ é€»è¾‘å±‚ (Logic Layer)
â”‚   â””â”€â”€ é€šç”¨é€»è¾‘
â””â”€â”€ æ•°æ®å±‚ (Data Layer)
    â””â”€â”€ æ•°æ®è®¿é—®
```

**å®ç°**:

```rego
# ========== æ¥å£å±‚ ==========
package api.authz

allow if {
    not deny
    some rule in allow_rules
    rule
}

deny contains msg if {
    some rule in deny_rules
    msg := rule
}

# ========== ä¸šåŠ¡å±‚ ==========
allow_rules contains business_rule_1
allow_rules contains business_rule_2

business_rule_1 if {
    # ä½¿ç”¨é€»è¾‘å±‚
    is_admin
    within_quota
}

# ========== é€»è¾‘å±‚ ==========
is_admin if {
    # ä½¿ç”¨æ•°æ®å±‚
    "admin" in get_user_roles
}

within_quota if {
    current_usage < get_quota_limit
}

# ========== æ•°æ®å±‚ ==========
get_user_roles := data.users[input.user].roles

get_quota_limit := data.quotas[input.user].limit
```

---

### 2.2 ç­–ç•¥ç»„åˆæ¨¡å¼

**åœºæ™¯**: å¤šä¸ªç‹¬ç«‹ç­–ç•¥çš„ç»„åˆã€‚

#### 2.2.1 "AND"ç»„åˆï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰

```rego
allow if {
    policy_a
    policy_b
    policy_c
}

policy_a if { ... }
policy_b if { ... }
policy_c if { ... }
```

#### 2.2.2 "OR"ç»„åˆï¼ˆä»»ä¸€æ»¡è¶³ï¼‰

```rego
allow if { policy_a }
allow if { policy_b }
allow if { policy_c }
```

#### 2.2.3 ä¼˜å…ˆçº§ç»„åˆ

```rego
# ä¼˜å…ˆçº§ï¼šdeny > allow > default
decision := "deny" if { explicit_deny }
decision := "allow" if { explicit_allow }
decision := "default" if { true }

final_allow if {
    decision == "allow"
}
```

---

### 2.3 å‘½åç©ºé—´æ¨¡å¼

**ç›®çš„**: é¿å…å‘½åå†²çªï¼Œç»„ç»‡ç­–ç•¥ã€‚

**ç»“æ„**:

```text
data
â”œâ”€â”€ api
â”‚   â”œâ”€â”€ v1
â”‚   â”‚   â””â”€â”€ authz
â”‚   â””â”€â”€ v2
â”‚       â””â”€â”€ authz
â”œâ”€â”€ kubernetes
â”‚   â”œâ”€â”€ admission
â”‚   â””â”€â”€ rbac
â””â”€â”€ common
    â””â”€â”€ utils
```

**å®ç°**:

```rego
# æ–‡ä»¶: api/v1/authz.rego
package api.v1.authz
allow if { ... }

# æ–‡ä»¶: api/v2/authz.rego
package api.v2.authz
allow if { ... }

# ä½¿ç”¨
import data.api.v1.authz as authz_v1
import data.api.v2.authz as authz_v2

allow if {
    authz_v1.allow
}
```

---

### 2.4 æ¨¡æ¿æ¨¡å¼

**åœºæ™¯**: å¯å¤ç”¨çš„ç­–ç•¥éª¨æ¶ã€‚

```rego
# æ¨¡æ¿å‡½æ•°
resource_access_template(resource_type, required_action) := allowed if {
    # 1. è·å–èµ„æº
    resource := data.resources[resource_type][input.resource_id]
    
    # 2. æ£€æŸ¥æƒé™
    user := data.users[input.user]
    required_action in user.permissions[resource_type]
    
    # 3. æ£€æŸ¥èµ„æºçŠ¶æ€
    resource.active == true
    
    # 4. è¿”å›ç»“æœ
    allowed := true
}

# å®ä¾‹åŒ–æ¨¡æ¿
allow_document_read := resource_access_template("document", "read")
allow_project_write := resource_access_template("project", "write")
```

---

## 3. å†³ç­–æ¨¡å¼

### 3.1 é»˜è®¤æ‹’ç»æ¨¡å¼ï¼ˆDefault Denyï¼‰

**åŸåˆ™**: é»˜è®¤æ‹’ç»ï¼Œæ˜¾å¼å…è®¸ã€‚

**âœ… æ¨è**:

```rego
# é»˜è®¤ç»“æœ: undefined (éšå¼æ‹’ç»)
allow if {
    explicit_allow_rule_1
}

allow if {
    explicit_allow_rule_2
}

# åº”ç”¨å±‚å¤„ç†
if opa_result.allow {
    // å…è®¸
} else {
    // æ‹’ç»ï¼ˆé»˜è®¤ï¼‰
}
```

---

### 3.2 æ˜ç¡®æ‹’ç»æ¨¡å¼ï¼ˆExplicit Denyï¼‰

**åœºæ™¯**: éœ€è¦åŒºåˆ†"æœªå®šä¹‰"å’Œ"æ˜ç¡®æ‹’ç»"ã€‚

```rego
# æ˜ç¡®å…è®¸
allow := true if {
    is_admin
}

# æ˜ç¡®æ‹’ç»
deny contains "user is blacklisted" if {
    input.user in data.blacklist
}

deny contains "resource is locked" if {
    resource := data.resources[input.resource_id]
    resource.locked == true
}

# æœ€ç»ˆå†³ç­–
final_decision := "deny" if {
    count(deny) > 0
}

final_decision := "allow" if {
    allow
    count(deny) == 0
}

final_decision := "undefined" if {
    not allow
    count(deny) == 0
}
```

---

### 3.3 å®¡è®¡æ¨¡å¼ï¼ˆAudit Modeï¼‰

**ç›®çš„**: è®°å½•è¿è§„ä½†ä¸é˜»æ­¢ã€‚

```rego
# æ­£å¸¸ç­–ç•¥
violations contains msg if {
    not has_required_label
    msg := "missing required label"
}

violations contains msg if {
    resource_too_large
    msg := "resource exceeds size limit"
}

# å®¡è®¡æ¨¡å¼
audit_mode := data.config.audit_mode

# æ ¹æ®æ¨¡å¼å†³å®šæ˜¯å¦æ‹’ç»
deny contains msg if {
    not audit_mode
    some msg in violations
}

# æ€»æ˜¯è®°å½•è¿è§„ï¼ˆç”¨äºå®¡è®¡ï¼‰
warnings := violations
```

---

### 3.4 æ¸è¿›å¼è¿ç§»æ¨¡å¼

**åœºæ™¯**: ä»æ—§ç­–ç•¥é€æ­¥è¿ç§»åˆ°æ–°ç­–ç•¥ã€‚

```rego
# æ–°ç­–ç•¥
allow_v2 if {
    # æ–°é€»è¾‘
}

# æ—§ç­–ç•¥ï¼ˆå…¼å®¹ï¼‰
allow_v1 if {
    # æ—§é€»è¾‘
}

# è¿ç§»é…ç½®
migration_enabled := data.config.v2_migration

# å†³ç­–é€»è¾‘
allow if {
    migration_enabled
    allow_v2
}

allow if {
    not migration_enabled
    allow_v1
}

# è®°å½•å·®å¼‚ï¼ˆç”¨äºéªŒè¯è¿ç§»æ­£ç¡®æ€§ï¼‰
migration_diff := {
    "v1": allow_v1,
    "v2": allow_v2,
    "consistent": allow_v1 == allow_v2
}
```

---

## 4. æ•°æ®æ¨¡å¼

### 4.1 æ•°æ®è®¿é—®å°è£…

**åŸåˆ™**: é€šè¿‡å‡½æ•°è®¿é—®æ•°æ®ï¼Œä¾¿äºä¿®æ”¹æ•°æ®ç»“æ„ã€‚

**âŒ ç›´æ¥è®¿é—®**:

```rego
allow if {
    user := data.users[input.user_id]
    "admin" in user.roles
}
```

**âœ… å°è£…è®¿é—®**:

```rego
get_user(user_id) := user if {
    user := data.users[user_id]
}

get_user_roles(user_id) := roles if {
    user := get_user(user_id)
    roles := user.roles
}

allow if {
    "admin" in get_user_roles(input.user_id)
}
```

**ä¼˜åŠ¿**: æ•°æ®ç»“æ„å˜åŒ–æ—¶åªéœ€ä¿®æ”¹å°è£…å‡½æ•°ã€‚

---

### 4.2 æ•°æ®éªŒè¯æ¨¡å¼

**ç›®çš„**: ç¡®ä¿è¾“å…¥æ•°æ®å®Œæ•´æ€§ã€‚

```rego
# éªŒè¯è§„åˆ™
validate_input contains msg if {
    not input.user_id
    msg := "missing user_id"
}

validate_input contains msg if {
    not input.action
    msg := "missing action"
}

validate_input contains msg if {
    not input.resource_id
    msg := "missing resource_id"
}

# ä¸»å†³ç­–ï¼ˆå…ˆéªŒè¯ï¼‰
allow if {
    count(validate_input) == 0  # éªŒè¯é€šè¿‡
    # æ­£å¸¸æˆæƒé€»è¾‘
    ...
}

# è¿”å›éªŒè¯é”™è¯¯
errors := validate_input if {
    count(validate_input) > 0
}
```

---

### 4.3 æ•°æ®è§„èŒƒåŒ–æ¨¡å¼

**ç›®çš„**: ç»Ÿä¸€æ•°æ®æ ¼å¼ã€‚

```rego
# è§„èŒƒåŒ–ç”¨æˆ·è¾“å…¥
normalized_input := {
    "user_id": lower(input.user_id),      # ç»Ÿä¸€å°å†™
    "action": upper(input.action),        # ç»Ÿä¸€å¤§å†™
    "resource": trim_space(input.resource), # å»é™¤ç©ºæ ¼
    "timestamp": time.now_ns()            # æ·»åŠ æ—¶é—´æˆ³
}

# ä½¿ç”¨è§„èŒƒåŒ–æ•°æ®
allow if {
    normalized_input.user_id in data.allowed_users
}
```

---

### 4.4 æ•°æ®æŠ•å½±æ¨¡å¼

**ç›®çš„**: åªæš´éœ²å¿…è¦çš„æ•°æ®å­—æ®µã€‚

```rego
# å®Œæ•´ç”¨æˆ·æ•°æ®
full_user := data.users[input.user_id]

# æŠ•å½±ï¼šåªæš´éœ²å¿…è¦å­—æ®µ
user_info := {
    "id": full_user.id,
    "roles": full_user.roles,
    "department": full_user.department
    # ä¸æš´éœ²: email, phone, address
}

# ä½¿ç”¨æŠ•å½±æ•°æ®
allow if {
    "admin" in user_info.roles
}
```

---

## 5. åæ¨¡å¼ï¼ˆAnti-Patternsï¼‰

### 5.1 âŒ é­”æ³•æ•°å­—/å­—ç¬¦ä¸²

**é—®é¢˜**:

```rego
allow if {
    input.level > 5        # 5æ˜¯ä»€ä¹ˆï¼Ÿ
    input.role == "adm"    # æ‹¼å†™é”™è¯¯ï¼Ÿ
}
```

**è§£å†³**:

```rego
MIN_ADMIN_LEVEL := 5
ADMIN_ROLE := "admin"

allow if {
    input.level > MIN_ADMIN_LEVEL
    input.role == ADMIN_ROLE
}
```

---

### 5.2 âŒ è¿‡æ·±åµŒå¥—

**é—®é¢˜**:

```rego
allow if {
    user := data.users[input.user]
    user.active == true
    some role in user.roles
    role_def := data.roles[role]
    some perm in role_def.permissions
    perm.action == input.action
    some resource_pattern in perm.resources
    glob.match(resource_pattern, [], input.resource)
}
```

**è§£å†³**ï¼ˆæå–è¾…åŠ©è§„åˆ™ï¼‰:

```rego
allow if {
    is_active_user
    has_matching_permission
}

is_active_user if {
    user := data.users[input.user]
    user.active == true
}

has_matching_permission if {
    some role in user_roles
    role_has_permission(role, input.action, input.resource)
}

role_has_permission(role, action, resource) if {
    some perm in data.roles[role].permissions
    perm.action == action
    some pattern in perm.resources
    glob.match(pattern, [], resource)
}
```

---

### 5.3 âŒ ä¸å®‰å…¨çš„å˜é‡

**é—®é¢˜**:

```rego
allow if {
    user := data.users[_]  # ä¸å®‰å…¨ï¼šuseræœªçº¦æŸ
    user.admin == true
}
```

**è§£å†³**:

```rego
allow if {
    # æ–¹å¼1ï¼šæ˜ç¡®ç»‘å®š
    user := data.users[input.user_id]
    user.admin == true
}

allow if {
    # æ–¹å¼2ï¼šä½¿ç”¨some
    some user_id in object.keys(data.users)
    user := data.users[user_id]
    user.admin == true
}
```

---

### 5.4 âŒ å‰¯ä½œç”¨

**é—®é¢˜**: Regoæ˜¯çº¯å‡½æ•°å¼ï¼Œä¸åº”æœ‰å‰¯ä½œç”¨ã€‚

```rego
# âŒ é”™è¯¯ï¼šå°è¯•ä¿®æ”¹å…¨å±€çŠ¶æ€
allow if {
    # data.audit_log[_] := {"user": input.user}  # ä¸å…è®¸ï¼
    ...
}
```

**è§£å†³**: é€šè¿‡Decision Logsæˆ–è¿”å›å€¼å¤„ç†å®¡è®¡ã€‚

```rego
# âœ… æ­£ç¡®ï¼šè¿”å›å®¡è®¡ä¿¡æ¯
audit_event := {
    "user": input.user,
    "action": input.action,
    "allowed": allow,
    "timestamp": time.now_ns()
}
```

---

### 5.5 âŒ è¿‡åº¦ä¼˜åŒ–

**é—®é¢˜**: è¿‡æ—©ä¼˜åŒ–å½±å“å¯è¯»æ€§ã€‚

```rego
# âŒ è¿‡åº¦ä¼˜åŒ–ï¼šéš¾ä»¥ç†è§£
allow if {
    [true | x := input.users[_]; y := data.perms[x]; z := y[_]; z == input.act][0]
}
```

**è§£å†³**: ä¼˜å…ˆä¿è¯å¯è¯»æ€§ã€‚

```rego
# âœ… æ¸…æ™°å¯è¯»
allow if {
    some user in input.users
    some perm in data.perms[user]
    perm == input.action
}
```

---

## 6. é‡æ„æŠ€å·§

### 6.1 æå–è¾…åŠ©è§„åˆ™

**é‡æ„å‰**:

```rego
allow if {
    user := data.users[input.user]
    user.active == true
    user.email_verified == true
    "admin" in user.roles
}

allow if {
    user := data.users[input.user]
    user.active == true
    user.email_verified == true
    resource := data.resources[input.resource]
    resource.owner == input.user
}
```

**é‡æ„å**:

```rego
is_valid_user if {
    user := data.users[input.user]
    user.active == true
    user.email_verified == true
}

allow if {
    is_valid_user
    "admin" in user.roles
}

allow if {
    is_valid_user
    is_resource_owner
}
```

---

### 6.2 åˆå¹¶é‡å¤æ¡ä»¶

**é‡æ„å‰**:

```rego
allow if {
    input.method == "GET"
    input.path == "/api/public"
}

allow if {
    input.method == "POST"
    input.path == "/api/public"
}
```

**é‡æ„å**:

```rego
allow if {
    input.method in ["GET", "POST"]
    input.path == "/api/public"
}
```

---

### 6.3 ä½¿ç”¨é›†åˆæ¨å¯¼ç®€åŒ–

**é‡æ„å‰**:

```rego
admin_users := users if {
    users := [u | 
        some user_id in object.keys(data.users)
        u := data.users[user_id]
        u.role == "admin"
    ]
}
```

**é‡æ„å**:

```rego
admin_users := [u | 
    u := data.users[_]
    u.role == "admin"
]
```

---

### 6.4 ç­–ç•¥ç‰ˆæœ¬åŒ–

**ç›®çš„**: æ”¯æŒå¤šç‰ˆæœ¬å…±å­˜ã€‚

```rego
# v1/policy.rego
package authz.v1
allow if { ... }

# v2/policy.rego
package authz.v2
allow if { ... }

# è·¯ç”±
package authz

import data.authz.v1
import data.authz.v2

allow if {
    input.api_version == "v1"
    v1.allow
}

allow if {
    input.api_version == "v2"
    v2.allow
}
```

---

## é™„å½•: è®¾è®¡æ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡æ£€æŸ¥

- [ ] è§„åˆ™å‘½åæ¸…æ™°ã€ä¸€è‡´
- [ ] é¿å…é­”æ³•æ•°å­—/å­—ç¬¦ä¸²
- [ ] æå–å…¬å…±é€»è¾‘
- [ ] åµŒå¥—æ·±åº¦ < 3å±‚
- [ ] å•ä¸ªæ–‡ä»¶ < 300è¡Œ
- [ ] å•ä¸ªè§„åˆ™ < 20è¡Œ

### æ€§èƒ½æ£€æŸ¥

- [ ] ä½¿ç”¨ç´¢å¼•è®¿é—® (`data.x[id]`)
- [ ] é¿å…å…¨è¡¨æ‰«æ (`data.x[_]`)
- [ ] æå‰å¤±è´¥ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
- [ ] ç¼“å­˜è®¡ç®—ç»“æœ
- [ ] å¯ç”¨éƒ¨åˆ†æ±‚å€¼

### æµ‹è¯•æ£€æŸ¥

- [ ] è¦†ç›–ç‡ > 80%
- [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- [ ] æµ‹è¯•é”™è¯¯è¾“å…¥
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] é›†æˆæµ‹è¯•

### å®‰å…¨æ£€æŸ¥

- [ ] é»˜è®¤æ‹’ç»
- [ ] è¾“å…¥éªŒè¯
- [ ] é˜²æ­¢æ³¨å…¥æ”»å‡»
- [ ] æ•æ„Ÿæ•°æ®è„±æ•
- [ ] å®¡è®¡æ—¥å¿—

---

**ä¸‹ä¸€ç¯‡**: [08.2-æ€§èƒ½ä¼˜åŒ–](./08.2-æ€§èƒ½ä¼˜åŒ–.md)  
**ç›¸å…³**: [02.1-Regoè¯­æ³•è§„èŒƒ](../02-è¯­è¨€æ¨¡å‹/02.1-Regoè¯­æ³•è§„èŒƒ.md)
