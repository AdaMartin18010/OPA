# WASM ç¼–è¯‘è§„èŒƒï¼ˆWebAssembly Compilation Specificationï¼‰

> **æ›´æ–°æ—¥æœŸ**: 2025å¹´10æœˆ20æ—¥  
> **WASMç‰ˆæœ¬**: WASI Preview 1  
> **OPAç‰ˆæœ¬**: v0.60+  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/wasm/>

---

## ç›®å½•

- [WASM ç¼–è¯‘è§„èŒƒï¼ˆWebAssembly Compilation Specificationï¼‰](#wasm-ç¼–è¯‘è§„èŒƒwebassembly-compilation-specification)
  - [ç›®å½•](#ç›®å½•)
  - [1. WASMç¼–è¯‘æ¦‚è¿°](#1-wasmç¼–è¯‘æ¦‚è¿°)
    - [1.1 ä¸ºä»€ä¹ˆéœ€è¦WASM](#11-ä¸ºä»€ä¹ˆéœ€è¦wasm)
    - [1.2 WASM vs Native Rego](#12-wasm-vs-native-rego)
    - [1.3 WASMè¿è¡Œæ—¶æ¶æ„](#13-wasmè¿è¡Œæ—¶æ¶æ„)
  - [2. ç¼–è¯‘æµç¨‹](#2-ç¼–è¯‘æµç¨‹)
    - [2.1 ç¼–è¯‘ç®¡é“](#21-ç¼–è¯‘ç®¡é“)
    - [2.2 ç¼–è¯‘å‘½ä»¤](#22-ç¼–è¯‘å‘½ä»¤)
    - [2.3 ç¼–è¯‘é€‰é¡¹](#23-ç¼–è¯‘é€‰é¡¹)
    - [2.4 EntrypointæŒ‡å®š](#24-entrypointæŒ‡å®š)
  - [3. WASMæ¨¡å—ç»“æ„](#3-wasmæ¨¡å—ç»“æ„)
    - [3.1 å¯¼å‡ºå‡½æ•°](#31-å¯¼å‡ºå‡½æ•°)
    - [3.2 å†…å­˜å¸ƒå±€](#32-å†…å­˜å¸ƒå±€)
    - [3.3 æ•°æ®åµŒå…¥](#33-æ•°æ®åµŒå…¥)
  - [4. ABIæ¥å£è§„èŒƒ](#4-abiæ¥å£è§„èŒƒ)
    - [4.1 ä¸»æ±‚å€¼å‡½æ•°](#41-ä¸»æ±‚å€¼å‡½æ•°)
    - [4.2 å†…å­˜ç®¡ç†å‡½æ•°](#42-å†…å­˜ç®¡ç†å‡½æ•°)
    - [4.3 å†…ç½®å‡½æ•°](#43-å†…ç½®å‡½æ•°)
    - [4.4 æ•°æ®è®¿é—®](#44-æ•°æ®è®¿é—®)
  - [5. JavaScript SDK](#5-javascript-sdk)
    - [5.1 åŠ è½½WASMæ¨¡å—](#51-åŠ è½½wasmæ¨¡å—)
    - [5.2 æ‰§è¡ŒæŸ¥è¯¢](#52-æ‰§è¡ŒæŸ¥è¯¢)
    - [5.3 æ•°æ®æ›´æ–°](#53-æ•°æ®æ›´æ–°)
    - [5.4 å®Œæ•´ç¤ºä¾‹](#54-å®Œæ•´ç¤ºä¾‹)
  - [6. Go SDK](#6-go-sdk)
    - [6.1 ä½¿ç”¨wazeroè¿è¡Œæ—¶](#61-ä½¿ç”¨wazeroè¿è¡Œæ—¶)
    - [6.2 åµŒå…¥WASMç­–ç•¥](#62-åµŒå…¥wasmç­–ç•¥)
  - [7. å…¶ä»–è¯­è¨€SDK](#7-å…¶ä»–è¯­è¨€sdk)
    - [7.1 Python (wasmtime-py)](#71-python-wasmtime-py)
    - [7.2 Rust (wasmtime)](#72-rust-wasmtime)
    - [7.3 .NET (Wasmtime.Dotnet)](#73-net-wasmtimedotnet)
  - [8. æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)
    - [8.1 ç¼–è¯‘ä¼˜åŒ–çº§åˆ«](#81-ç¼–è¯‘ä¼˜åŒ–çº§åˆ«)
    - [8.2 ç­–ç•¥ä¼˜åŒ–](#82-ç­–ç•¥ä¼˜åŒ–)
    - [8.3 ç¼“å­˜ç­–ç•¥](#83-ç¼“å­˜ç­–ç•¥)
    - [8.4 æ€§èƒ½åŸºå‡†](#84-æ€§èƒ½åŸºå‡†)
  - [9. é™åˆ¶ä¸æƒè¡¡](#9-é™åˆ¶ä¸æƒè¡¡)
    - [9.1 åŠŸèƒ½é™åˆ¶](#91-åŠŸèƒ½é™åˆ¶)
    - [9.2 æ€§èƒ½æƒè¡¡](#92-æ€§èƒ½æƒè¡¡)
    - [9.3 è°ƒè¯•éš¾åº¦](#93-è°ƒè¯•éš¾åº¦)
  - [10. æœ€ä½³å®è·µ](#10-æœ€ä½³å®è·µ)
    - [10.1 ä½•æ—¶ä½¿ç”¨WASM](#101-ä½•æ—¶ä½¿ç”¨wasm)
    - [10.2 Entrypointè®¾è®¡](#102-entrypointè®¾è®¡)
    - [10.3 æ•°æ®ç®¡ç†](#103-æ•°æ®ç®¡ç†)
  - [é™„å½•Aï¼šWASMæ¨¡å—å®Œæ•´ç¤ºä¾‹](#é™„å½•awasmæ¨¡å—å®Œæ•´ç¤ºä¾‹)
  - [é™„å½•Bï¼šæ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•](#é™„å½•bæ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•)

---

## 1. WASMç¼–è¯‘æ¦‚è¿°

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦WASM

**ä¸šåŠ¡åœºæ™¯**ï¼š

```text
åœºæ™¯1: æµè§ˆå™¨ç«¯ç­–ç•¥æ‰§è¡Œ
  â”œâ”€â”€ å‰ç«¯åº”ç”¨éœ€è¦æœ¬åœ°æˆæƒå†³ç­–
  â”œâ”€â”€ å‡å°‘ç½‘ç»œå»¶è¿Ÿ
  â””â”€â”€ æå‡ç”¨æˆ·ä½“éªŒ

åœºæ™¯2: è¾¹ç¼˜è®¡ç®—/Serverless
  â”œâ”€â”€ Cloudflare Workers
  â”œâ”€â”€ Fastly Compute@Edge
  â””â”€â”€ AWS Lambda@Edge

åœºæ™¯3: å¤šè¯­è¨€é›†æˆ
  â”œâ”€â”€ Pythonåº”ç”¨é›†æˆç­–ç•¥å¼•æ“
  â”œâ”€â”€ RustæœåŠ¡åµŒå…¥æˆæƒé€»è¾‘
  â””â”€â”€ .NETåº”ç”¨ç­–ç•¥ç®¡ç†

åœºæ™¯4: æ²™ç®±éš”ç¦»
  â”œâ”€â”€ ç­–ç•¥åœ¨éš”ç¦»ç¯å¢ƒæ‰§è¡Œ
  â”œâ”€â”€ é˜²æ­¢æ¶æ„ç­–ç•¥æ”»å‡»
  â””â”€â”€ èµ„æºä½¿ç”¨é™åˆ¶
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

- ğŸš€ **é«˜æ€§èƒ½**: æ¥è¿‘åŸç”Ÿä»£ç é€Ÿåº¦ï¼ˆ~80%ï¼‰
- ğŸŒ **è·¨å¹³å°**: ä¸€æ¬¡ç¼–è¯‘ï¼Œå¤„å¤„è¿è¡Œ
- ğŸ”’ **å®‰å…¨éš”ç¦»**: æ²™ç®±ç¯å¢ƒï¼Œå†…å­˜å®‰å…¨
- ğŸ“¦ **ä½“ç§¯å°**: å‹ç¼©åé€šå¸¸ < 1MB
- ğŸ”Œ **æ˜“é›†æˆ**: æ”¯æŒä¸»æµè¯­è¨€è¿è¡Œæ—¶

### 1.2 WASM vs Native Rego

**ç‰¹æ€§å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | Native Rego | WASM |
|------|-------------|------|
| **æ‰§è¡Œé€Ÿåº¦** | â­â­â­â­â­ (åŸºå‡†) | â­â­â­â­ (80-90%) |
| **å¯åŠ¨é€Ÿåº¦** | â­â­â­ (éœ€è¦è§£æ) | â­â­â­â­â­ (é¢„ç¼–è¯‘) |
| **å†…å­˜å ç”¨** | â­â­â­ (Goè¿è¡Œæ—¶) | â­â­â­â­â­ (è½»é‡çº§) |
| **è·¨è¯­è¨€** | âŒ (ä»…Go) | âœ… (æ‰€æœ‰è¯­è¨€) |
| **è°ƒè¯•** | â­â­â­â­â­ (å®Œæ•´å·¥å…·) | â­â­ (æœ‰é™) |
| **åŠ¨æ€æ›´æ–°** | âœ… (çƒ­åŠ è½½) | âš ï¸ (éœ€é‡æ–°åŠ è½½) |
| **å†…ç½®å‡½æ•°** | âœ… (å…¨éƒ¨æ”¯æŒ) | âš ï¸ (éƒ¨åˆ†æ”¯æŒ) |

**é€‰æ‹©æŒ‡å—**ï¼š

```text
é€‰æ‹©Native Rego:
  âœ… Goåº”ç”¨
  âœ… éœ€è¦å®Œæ•´å†…ç½®å‡½æ•°
  âœ… éœ€è¦åŠ¨æ€ç­–ç•¥æ›´æ–°
  âœ… å¼€å‘è°ƒè¯•é˜¶æ®µ

é€‰æ‹©WASM:
  âœ… éGoè¯­è¨€åº”ç”¨
  âœ… æµè§ˆå™¨/è¾¹ç¼˜è®¡ç®—
  âœ… éœ€è¦æ²™ç®±éš”ç¦»
  âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```

### 1.3 WASMè¿è¡Œæ—¶æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Host Application                â”‚
â”‚  (Go / JS / Python / Rust / .NET)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         WASM SDK / Runtime              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   opa.wasm (Compiled Policy)      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Exported Functions:        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - opa_eval()              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - opa_malloc()            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - opa_heap_ptr_get()      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Linear Memory (64KB-16MB)  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Stack                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Heap (JSON data)       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Embedded Data           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç¼–è¯‘æµç¨‹

### 2.1 ç¼–è¯‘ç®¡é“

```text
Regoç­–ç•¥ (.rego)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯æ³•åˆ†æ & è¯­æ³•è§£æ          â”‚
â”‚    Lexer â†’ Parser â†’ AST        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç±»å‹æ£€æŸ¥ & è¯­ä¹‰åˆ†æ          â”‚
â”‚    Type Checker â†’ Annotated ASTâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç¼–è¯‘ä¸ºä¸­é—´è¡¨ç¤º (IR)          â”‚
â”‚    Planner â†’ IR                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. IRä¼˜åŒ–                      â”‚
â”‚    - å¸¸é‡æŠ˜å                    â”‚
â”‚    - æ­»ä»£ç æ¶ˆé™¤                 â”‚
â”‚    - å†…è”å±•å¼€                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. WASMä»£ç ç”Ÿæˆ                â”‚
â”‚    IR â†’ WASM Instructions      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ•°æ®åµŒå…¥ï¼ˆå¯é€‰ï¼‰             â”‚
â”‚    Embed JSON data in WASM     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
policy.wasm
```

### 2.2 ç¼–è¯‘å‘½ä»¤

**åŸºæœ¬ç¼–è¯‘**ï¼š

```bash
# ç¼–è¯‘å•ä¸ªEntrypoint
opa build -t wasm -e data.authz.allow policy.rego

# è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶
opa build -t wasm -e data.authz.allow -o bundle.tar.gz policy.rego

# æå–WASMæ–‡ä»¶
tar -xzf bundle.tar.gz policy.wasm
```

**å¤šEntrypointç¼–è¯‘**ï¼š

```bash
# ç¼–è¯‘å¤šä¸ªå†³ç­–ç‚¹
opa build -t wasm \
  -e data.authz.allow \
  -e data.authz.deny \
  -e data.validation.errors \
  policy/

# ç»“æœï¼šä¸€ä¸ªWASMæ¨¡å—åŒ…å«æ‰€æœ‰Entrypoints
```

**åŒ…å«æ•°æ®**ï¼š

```bash
# åµŒå…¥é™æ€æ•°æ®åˆ°WASM
opa build -t wasm -e data.authz.allow \
  policy/ \
  data.json

# æ•°æ®ä¼šç¼–è¯‘åˆ°WASMæ¨¡å—ä¸­
```

### 2.3 ç¼–è¯‘é€‰é¡¹

**ä¼˜åŒ–çº§åˆ«**ï¼š

```bash
# é»˜è®¤ä¼˜åŒ–ï¼ˆçº§åˆ«1ï¼‰
opa build -t wasm -e data.authz.allow policy.rego

# æœ€å¤§ä¼˜åŒ–ï¼ˆçº§åˆ«2ï¼‰
opa build -t wasm -e data.authz.allow \
  --optimize=2 \
  policy.rego

# ç¦ç”¨ä¼˜åŒ–ï¼ˆè°ƒè¯•ç”¨ï¼‰
opa build -t wasm -e data.authz.allow \
  --optimize=0 \
  policy.rego
```

**ä¼˜åŒ–çº§åˆ«è¯´æ˜**ï¼š

| çº§åˆ« | è¯´æ˜ | ç¼–è¯‘æ—¶é—´ | æ‰§è¡Œæ€§èƒ½ | WASMå¤§å° |
|------|------|---------|---------|---------|
| 0 | æ— ä¼˜åŒ– | å¿« | æ…¢ | å¤§ |
| 1 | æ ‡å‡†ä¼˜åŒ– | ä¸­ç­‰ | å¥½ | ä¸­ç­‰ |
| 2 | æ¿€è¿›ä¼˜åŒ– | æ…¢ | æœ€ä½³ | å° |

**è°ƒè¯•ç¬¦å·**ï¼š

```bash
# ä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼ˆç”¨äºé”™è¯¯è¿½è¸ªï¼‰
opa build -t wasm -e data.authz.allow \
  --debug \
  policy.rego
```

### 2.4 EntrypointæŒ‡å®š

**Entrypointè¯­æ³•**ï¼š

```text
-e <package>.<rule>

ç¤ºä¾‹:
  -e data.authz.allow           # ç®€å•è§„åˆ™
  -e data.api.v1.permissions    # åµŒå¥—åŒ…
  -e data["my-pkg"].result      # åŒ…å«ç‰¹æ®Šå­—ç¬¦
```

**EntrypointæŸ¥è¯¢**ï¼š

```javascript
// JavaScriptä¸­è°ƒç”¨ä¸åŒEntrypoint
const result1 = await policy.evaluate(input, 'data.authz.allow');
const result2 = await policy.evaluate(input, 'data.authz.deny');
```

**é»˜è®¤Entrypoint**ï¼š

```bash
# å¦‚æœä¸æŒ‡å®š-eï¼Œéœ€è¦åœ¨æŸ¥è¯¢æ—¶æä¾›å®Œæ•´è·¯å¾„
opa build -t wasm policy.rego

# æŸ¥è¯¢æ—¶å¿…é¡»æ˜ç¡®æŒ‡å®šè·¯å¾„
policy.evaluate(input, 'data.authz.allow')
```

---

## 3. WASMæ¨¡å—ç»“æ„

### 3.1 å¯¼å‡ºå‡½æ•°

**æ ¸å¿ƒå¯¼å‡º**ï¼š

```wasm
;; ä¸»æ±‚å€¼å‡½æ•°
(export "eval" (func $opa_eval))
  params: i32  ;; context pointer
  result: i32  ;; result pointer

;; å†…å­˜åˆ†é…
(export "malloc" (func $opa_malloc))
  params: i32  ;; size
  result: i32  ;; pointer

;; è·å–å †æŒ‡é’ˆ
(export "heap_ptr_get" (func $opa_heap_ptr_get))
  result: i32  ;; heap base pointer

;; å †æŒ‡é’ˆè®¾ç½®
(export "heap_ptr_set" (func $opa_heap_ptr_set))
  params: i32  ;; new heap pointer

;; å…¥å£ç‚¹è°ƒç”¨
(export "entrypoints" (func $opa_entrypoints))
  result: i32  ;; JSON array of entrypoints

;; ç­–ç•¥å…ƒæ•°æ®
(export "builtins" (func $opa_builtins))
  result: i32  ;; JSON object of required builtins
```

### 3.2 å†…å­˜å¸ƒå±€

```text
WASM Linear Memory (é»˜è®¤ 2MB, æœ€å¤§ 16MB)

0x00000000  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Stack (64KB)            â”‚
            â”‚   â†“ grows down            â”‚
0x00010000  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚   Heap (JSON data)        â”‚
            â”‚   â†‘ grows up              â”‚
            â”‚                           â”‚
            â”‚   - Input data            â”‚
            â”‚   - Evaluation results    â”‚
            â”‚   - Temporary objects     â”‚
            â”‚                           â”‚
0x001F0000  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚   Embedded Data (optional)â”‚
            â”‚   - Static base documents â”‚
            â”‚   - Role definitions      â”‚
0x00200000  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†…å­˜ç®¡ç†**ï¼š

```javascript
// JavaScriptå†…å­˜æ“ä½œç¤ºä¾‹
class WasmMemory {
  constructor(wasmInstance) {
    this.memory = wasmInstance.exports.memory;
    this.malloc = wasmInstance.exports.malloc;
  }

  // åˆ†é…å†…å­˜å¹¶å†™å…¥JSON
  allocateJSON(obj) {
    const json = JSON.stringify(obj);
    const bytes = new TextEncoder().encode(json);
    const ptr = this.malloc(bytes.length);
    const buffer = new Uint8Array(this.memory.buffer);
    buffer.set(bytes, ptr);
    return ptr;
  }

  // ä»æŒ‡é’ˆè¯»å–JSON
  readJSON(ptr) {
    const buffer = new Uint8Array(this.memory.buffer);
    const nullIdx = buffer.indexOf(0, ptr);
    const slice = buffer.slice(ptr, nullIdx);
    const json = new TextDecoder().decode(slice);
    return JSON.parse(json);
  }
}
```

### 3.3 æ•°æ®åµŒå…¥

**ç¼–è¯‘æ—¶åµŒå…¥**ï¼š

```bash
# data.json
{
  "roles": {
    "admin": ["read", "write", "delete"],
    "user": ["read"]
  }
}

# ç¼–è¯‘æ—¶åµŒå…¥
opa build -t wasm -e data.authz.allow \
  policy.rego data.json

# WASMä¸­å¯ä»¥ç›´æ¥è®¿é—® data.roles
```

**ç­–ç•¥è®¿é—®åµŒå…¥æ•°æ®**ï¼š

```rego
package authz

import rego.v1

# ç›´æ¥å¼•ç”¨åµŒå…¥çš„æ•°æ®
user_permissions := data.roles[input.user.role]

allow if {
    input.action in user_permissions
}
```

---

## 4. ABIæ¥å£è§„èŒƒ

### 4.1 ä¸»æ±‚å€¼å‡½æ•°

**å‡½æ•°ç­¾å**ï¼š

```c
int32_t opa_eval(int32_t ctx_addr);
```

**å‚æ•°æ ¼å¼ï¼ˆctx_addræŒ‡å‘çš„JSONï¼‰**ï¼š

```json
{
  "input": {
    "user": "alice",
    "action": "read",
    "resource": "/api/data"
  },
  "entrypoint": 0
}
```

**è¿”å›å€¼ï¼ˆæŒ‡å‘JSONçš„æŒ‡é’ˆï¼‰**ï¼š

```json
[
  {
    "result": true,
    "expressions": [
      {
        "value": true,
        "text": "data.authz.allow",
        "location": {
          "row": 5,
          "col": 1
        }
      }
    ]
  }
]
```

### 4.2 å†…å­˜ç®¡ç†å‡½æ•°

**malloc**ï¼š

```c
int32_t opa_malloc(int32_t size);

// ç”¨æ³•
int32_t ptr = opa_malloc(1024);  // åˆ†é…1KB
```

**heap_ptr_get/set**ï¼š

```c
int32_t opa_heap_ptr_get();
void opa_heap_ptr_set(int32_t ptr);

// é‡ç½®å †ï¼ˆæ¸…ç†ä¸´æ—¶æ•°æ®ï¼‰
int32_t heap_top = opa_heap_ptr_get();
// ... æ‰§è¡Œæ“ä½œ ...
opa_heap_ptr_set(heap_top);  // æ¢å¤å †çŠ¶æ€
```

### 4.3 å†…ç½®å‡½æ•°

**entrypoints**ï¼š

```c
int32_t opa_entrypoints();

// è¿”å› (JSONå­—ç¬¦ä¸²æŒ‡é’ˆ):
[
  {
    "id": 0,
    "path": "data/authz/allow"
  },
  {
    "id": 1,
    "path": "data/authz/deny"
  }
]
```

**builtins**ï¼š

```c
int32_t opa_builtins();

// è¿”å› (JSONå¯¹è±¡æŒ‡é’ˆ):
{
  "http.send": {
    "decl": {
      "args": [...],
      "result": {...}
    }
  }
}
```

### 4.4 æ•°æ®è®¿é—®

**Base Documents**ï¼š

ç¼–è¯‘æ—¶åµŒå…¥çš„æ•°æ®å¯é€šè¿‡æ ‡å‡†Regoå¼•ç”¨è®¿é—®ï¼š

```rego
# è®¿é—®åµŒå…¥çš„ data.json
user_roles := data.roles[input.user]

# è®¿é—®åµŒå…¥çš„ config.yaml
max_retries := data.config.retry.max_attempts
```

---

## 5. JavaScript SDK

### 5.1 åŠ è½½WASMæ¨¡å—

**ä½¿ç”¨@open-policy-agent/opa-wasm**ï¼š

```bash
npm install @open-policy-agent/opa-wasm
```

```javascript
const { loadPolicy } = require('@open-policy-agent/opa-wasm');
const fs = require('fs');

// åŠ è½½WASMæ–‡ä»¶
const wasm = fs.readFileSync('policy.wasm');
const policy = await loadPolicy(wasm);
```

**æµè§ˆå™¨ä¸­åŠ è½½**ï¼š

```html
<script type="module">
import { loadPolicy } from 'https://cdn.skypack.dev/@open-policy-agent/opa-wasm';

fetch('/policy.wasm')
  .then(response => response.arrayBuffer())
  .then(buffer => loadPolicy(buffer))
  .then(policy => {
    console.log('Policy loaded');
    window.policy = policy;
  });
</script>
```

### 5.2 æ‰§è¡ŒæŸ¥è¯¢

**åŸºæœ¬æŸ¥è¯¢**ï¼š

```javascript
const input = {
  user: 'alice',
  action: 'read',
  resource: '/api/data'
};

// æ±‚å€¼
const result = await policy.evaluate(input);

console.log(result);
// è¾“å‡º: [{ result: true }]
```

**æŒ‡å®šEntrypoint**ï¼š

```javascript
// æŸ¥è¯¢ç‰¹å®šè§„åˆ™
const allowed = await policy.evaluate(input, 'data/authz/allow');
const denied = await policy.evaluate(input, 'data/authz/deny');
```

**è®¾ç½®å¤–éƒ¨æ•°æ®**ï¼š

```javascript
// æ›´æ–°å¤–éƒ¨æ•°æ®
policy.setData({
  users: {
    alice: { role: 'admin' },
    bob: { role: 'user' }
  }
});

const result = await policy.evaluate({ user: 'alice', action: 'write' });
```

### 5.3 æ•°æ®æ›´æ–°

**å®Œæ•´æ›¿æ¢**ï¼š

```javascript
policy.setData({
  roles: {
    admin: ['read', 'write', 'delete'],
    user: ['read']
  }
});
```

**éƒ¨åˆ†æ›´æ–°ï¼ˆè·¯å¾„ï¼‰**ï¼š

```javascript
policy.setDataPath(['roles', 'admin'], ['read', 'write', 'delete', 'admin']);
```

**åˆ é™¤æ•°æ®**ï¼š

```javascript
policy.removeDataPath(['roles', 'guest']);
```

### 5.4 å®Œæ•´ç¤ºä¾‹

```javascript
const { loadPolicy } = require('@open-policy-agent/opa-wasm');
const fs = require('fs');

async function main() {
  // 1. åŠ è½½ç­–ç•¥
  const wasm = fs.readFileSync('authz.wasm');
  const policy = await loadPolicy(wasm);

  // 2. è®¾ç½®åŸºç¡€æ•°æ®
  policy.setData({
    users: {
      alice: { role: 'admin', department: 'engineering' },
      bob: { role: 'user', department: 'sales' }
    },
    roles: {
      admin: { permissions: ['read', 'write', 'delete'] },
      user: { permissions: ['read'] }
    }
  });

  // 3. æ‰§è¡ŒæˆæƒæŸ¥è¯¢
  const requests = [
    { user: 'alice', action: 'write', resource: '/api/data' },
    { user: 'bob', action: 'write', resource: '/api/data' },
    { user: 'alice', action: 'delete', resource: '/api/data' }
  ];

  for (const req of requests) {
    const result = await policy.evaluate(req);
    console.log(`${req.user} ${req.action} ${req.resource}: ${result[0].result}`);
  }

  // 4. æ¸…ç†
  policy.close();
}

main().catch(console.error);
```

---

## 6. Go SDK

### 6.1 ä½¿ç”¨wazeroè¿è¡Œæ—¶

```go
package main

import (
    "context"
    "encoding/json"
    "fmt"
    "os"

    "github.com/tetratelabs/wazero"
    "github.com/tetratelabs/wazero/api"
)

func main() {
    ctx := context.Background()

    // 1. åˆ›å»ºWASMè¿è¡Œæ—¶
    runtime := wazero.NewRuntime(ctx)
    defer runtime.Close(ctx)

    // 2. åŠ è½½WASMæ¨¡å—
    wasmBytes, _ := os.ReadFile("policy.wasm")
    mod, _ := runtime.Instantiate(ctx, wasmBytes)
    defer mod.Close(ctx)

    // 3. å‡†å¤‡è¾“å…¥
    input := map[string]interface{}{
        "user":     "alice",
        "action":   "read",
        "resource": "/api/data",
    }
    inputJSON, _ := json.Marshal(input)

    // 4. åˆ†é…å†…å­˜å¹¶å†™å…¥
    malloc := mod.ExportedFunction("malloc")
    results, _ := malloc.Call(ctx, uint64(len(inputJSON)))
    ptr := api.DecodeU32(results[0])

    memory := mod.Memory()
    memory.Write(ptr, inputJSON)

    // 5. æ‰§è¡Œæ±‚å€¼
    eval := mod.ExportedFunction("eval")
    results, _ = eval.Call(ctx, uint64(ptr))
    resultPtr := api.DecodeU32(results[0])

    // 6. è¯»å–ç»“æœ
    resultBytes, _ := memory.Read(resultPtr, 4096)
    nullIdx := bytes.IndexByte(resultBytes, 0)
    var result []map[string]interface{}
    json.Unmarshal(resultBytes[:nullIdx], &result)

    fmt.Printf("Result: %+v\n", result)
}
```

### 6.2 åµŒå…¥WASMç­–ç•¥

```go
package authz

import (
    _ "embed"
    "github.com/tetratelabs/wazero"
)

//go:embed policy.wasm
var policyWASM []byte

type Authorizer struct {
    runtime wazero.Runtime
    module  api.Module
}

func NewAuthorizer(ctx context.Context) (*Authorizer, error) {
    runtime := wazero.NewRuntime(ctx)
    module, err := runtime.Instantiate(ctx, policyWASM)
    if err != nil {
        return nil, err
    }

    return &Authorizer{
        runtime: runtime,
        module:  module,
    }, nil
}

func (a *Authorizer) Evaluate(ctx context.Context, input map[string]interface{}) (bool, error) {
    // å®ç°æ±‚å€¼é€»è¾‘
    // ...
}

func (a *Authorizer) Close(ctx context.Context) error {
    a.module.Close(ctx)
    return a.runtime.Close(ctx)
}
```

---

## 7. å…¶ä»–è¯­è¨€SDK

### 7.1 Python (wasmtime-py)

```python
from wasmtime import Store, Module, Instance
import json

# åŠ è½½WASM
store = Store()
module = Module.from_file(store.engine, 'policy.wasm')
instance = Instance(store, module, [])

# å‡†å¤‡è¾“å…¥
input_data = {
    'user': 'alice',
    'action': 'read',
    'resource': '/api/data'
}
input_json = json.dumps(input_data).encode('utf-8')

# åˆ†é…å†…å­˜
malloc = instance.exports(store)['malloc']
ptr = malloc(store, len(input_json))

# å†™å…¥æ•°æ®
memory = instance.exports(store)['memory']
memory.write(store, input_json, ptr)

# æ‰§è¡Œæ±‚å€¼
eval_func = instance.exports(store)['eval']
result_ptr = eval_func(store, ptr)

# è¯»å–ç»“æœ
result_bytes = memory.read(store, result_ptr, 4096)
result_json = result_bytes.split(b'\0')[0].decode('utf-8')
result = json.loads(result_json)

print(f"Result: {result}")
```

### 7.2 Rust (wasmtime)

```rust
use wasmtime::*;
use serde_json::json;

fn main() -> Result<()> {
    // åˆ›å»ºå¼•æ“å’Œå­˜å‚¨
    let engine = Engine::default();
    let mut store = Store::new(&engine, ());

    // åŠ è½½æ¨¡å—
    let module = Module::from_file(&engine, "policy.wasm")?;
    let instance = Instance::new(&mut store, &module, &[])?;

    // è·å–å¯¼å‡ºå‡½æ•°
    let malloc = instance.get_typed_func::<i32, i32>(&mut store, "malloc")?;
    let eval = instance.get_typed_func::<i32, i32>(&mut store, "eval")?;
    let memory = instance.get_memory(&mut store, "memory").unwrap();

    // å‡†å¤‡è¾“å…¥
    let input = json!({
        "user": "alice",
        "action": "read",
        "resource": "/api/data"
    });
    let input_json = serde_json::to_string(&input)?;
    let input_bytes = input_json.as_bytes();

    // åˆ†é…å¹¶å†™å…¥
    let ptr = malloc.call(&mut store, input_bytes.len() as i32)?;
    memory.write(&mut store, ptr as usize, input_bytes)?;

    // æ‰§è¡Œæ±‚å€¼
    let result_ptr = eval.call(&mut store, ptr)?;

    // è¯»å–ç»“æœ
    let mut result_bytes = vec![0u8; 4096];
    memory.read(&store, result_ptr as usize, &mut result_bytes)?;
    let null_idx = result_bytes.iter().position(|&b| b == 0).unwrap();
    let result_json = String::from_utf8(result_bytes[..null_idx].to_vec())?;
    let result: serde_json::Value = serde_json::from_str(&result_json)?;

    println!("Result: {}", result);
    Ok(())
}
```

### 7.3 .NET (Wasmtime.Dotnet)

```csharp
using System;
using System.Text;
using System.Text.Json;
using Wasmtime;

class Program
{
    static void Main()
    {
        // åˆ›å»ºå¼•æ“å’Œæ¨¡å—
        using var engine = new Engine();
        using var module = Module.FromFile(engine, "policy.wasm");
        using var linker = new Linker(engine);
        using var store = new Store(engine);

        // å®ä¾‹åŒ–
        var instance = linker.Instantiate(store, module);

        // è·å–å‡½æ•°
        var malloc = instance.GetFunction<int, int>("malloc");
        var eval = instance.GetFunction<int, int>("eval");
        var memory = instance.GetMemory("memory");

        // å‡†å¤‡è¾“å…¥
        var input = new {
            user = "alice",
            action = "read",
            resource = "/api/data"
        };
        var inputJson = JsonSerializer.Serialize(input);
        var inputBytes = Encoding.UTF8.GetBytes(inputJson);

        // åˆ†é…å¹¶å†™å…¥
        var ptr = malloc(inputBytes.Length);
        memory.WriteString(ptr, inputJson);

        // æ‰§è¡Œæ±‚å€¼
        var resultPtr = eval(ptr);

        // è¯»å–ç»“æœ
        var resultJson = memory.ReadString(resultPtr, 0, 4096);
        var result = JsonSerializer.Deserialize<object>(resultJson);

        Console.WriteLine($"Result: {result}");
    }
}
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 ç¼–è¯‘ä¼˜åŒ–çº§åˆ«

```bash
# çº§åˆ«0: æ— ä¼˜åŒ–ï¼ˆè°ƒè¯•ï¼‰
opa build -t wasm -e data.authz.allow --optimize=0 policy.rego
# ç¼–è¯‘æ—¶é—´: 5s, WASMå¤§å°: 2.5MB, æ‰§è¡Œé€Ÿåº¦: 100ms

# çº§åˆ«1: æ ‡å‡†ä¼˜åŒ–ï¼ˆé»˜è®¤ï¼‰
opa build -t wasm -e data.authz.allow --optimize=1 policy.rego
# ç¼–è¯‘æ—¶é—´: 10s, WASMå¤§å°: 1.2MB, æ‰§è¡Œé€Ÿåº¦: 15ms

# çº§åˆ«2: æ¿€è¿›ä¼˜åŒ–ï¼ˆç”Ÿäº§ï¼‰
opa build -t wasm -e data.authz.allow --optimize=2 policy.rego
# ç¼–è¯‘æ—¶é—´: 30s, WASMå¤§å°: 800KB, æ‰§è¡Œé€Ÿåº¦: 10ms
```

### 8.2 ç­–ç•¥ä¼˜åŒ–

**é¿å…æ˜‚è´µæ“ä½œ**ï¼š

```rego
# âŒ æ…¢: å¤šæ¬¡æ•°ç»„éå†
allow if {
    some role in input.user.roles
    role in data.admin_roles
}

# âœ… å¿«: ä½¿ç”¨é›†åˆäº¤é›†
allow if {
    count(input.user.roles & data.admin_roles) > 0
}
```

**ç¼“å­˜ä¸­é—´ç»“æœ**ï¼š

```rego
# âŒ æ…¢: é‡å¤è®¡ç®—
allow if {
    expensive_check(input.resource)
    expensive_check(input.resource).level > 5
}

# âœ… å¿«: ç¼“å­˜ç»“æœ
check_result := expensive_check(input.resource)

allow if {
    check_result.level > 5
}
```

### 8.3 ç¼“å­˜ç­–ç•¥

**WASMæ¨¡å—ç¼“å­˜**ï¼š

```javascript
// æµè§ˆå™¨: ä½¿ç”¨IndexedDBç¼“å­˜ç¼–è¯‘åçš„æ¨¡å—
const cachedModule = await WebAssembly.compileStreaming(
  fetch('/policy.wasm')
);

// å­˜å‚¨åˆ°IndexedDB
await idb.put('wasm-cache', 'policy', cachedModule);

// åç»­åŠ è½½
const module = await idb.get('wasm-cache', 'policy');
const instance = await WebAssembly.instantiate(module);
```

**æ±‚å€¼ç»“æœç¼“å­˜**ï¼š

```javascript
class CachedPolicy {
  constructor(policy) {
    this.policy = policy;
    this.cache = new Map();
  }

  async evaluate(input) {
    const key = JSON.stringify(input);
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }

    const result = await this.policy.evaluate(input);
    this.cache.set(key, result);
    return result;
  }
}
```

### 8.4 æ€§èƒ½åŸºå‡†

**æµ‹è¯•åœºæ™¯**ï¼šç®€å•RBACç­–ç•¥

| è¿è¡Œæ—¶ | å†·å¯åŠ¨ | çƒ­æ‰§è¡Œ | å†…å­˜å ç”¨ |
|--------|-------|-------|---------|
| **Native OPA** | 50ms | 0.1ms | 50MB |
| **WASM (Node.js)** | 10ms | 0.15ms | 10MB |
| **WASM (Browser)** | 15ms | 0.2ms | 8MB |
| **WASM (Go/wazero)** | 5ms | 0.12ms | 15MB |

**ååé‡å¯¹æ¯”**ï¼š

```text
Native OPA:    10,000 req/s
WASM (Node):    8,000 req/s  (80%)
WASM (Browser): 6,000 req/s  (60%)
WASM (Go):      9,000 req/s  (90%)
```

---

## 9. é™åˆ¶ä¸æƒè¡¡

### 9.1 åŠŸèƒ½é™åˆ¶

**ä¸æ”¯æŒçš„å†…ç½®å‡½æ•°**ï¼š

```text
âŒ http.send           # ç½‘ç»œè¯·æ±‚
âŒ opa.runtime         # è¿è¡Œæ—¶ä¿¡æ¯
âŒ trace               # è°ƒè¯•è¿½è¸ª
âŒ time.now_ns         # é«˜ç²¾åº¦æ—¶é—´ï¼ˆéƒ¨åˆ†è¿è¡Œæ—¶ï¼‰

âœ… å¤§éƒ¨åˆ†å†…ç½®å‡½æ•°éƒ½æ”¯æŒ:
   - å­—ç¬¦ä¸²æ“ä½œ
   - æ•°ç»„/å¯¹è±¡æ“ä½œ
   - åŠ å¯†å‡½æ•°
   - æ­£åˆ™è¡¨è¾¾å¼
   - JSONæ“ä½œ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// åœ¨å®¿ä¸»ç¯å¢ƒå®ç°ç¼ºå¤±çš„å†…ç½®å‡½æ•°
policy.setBuiltins({
  'http.send': async (req) => {
    const response = await fetch(req.url, req);
    return await response.json();
  },
  'time.now_ns': () => Date.now() * 1000000
});
```

### 9.2 æ€§èƒ½æƒè¡¡

**é¦–æ¬¡ç¼–è¯‘å¼€é”€**ï¼š

```text
Scenario: ç¬¬ä¸€æ¬¡åŠ è½½WASMæ¨¡å—

Native OPA:
  è§£æRego: 50ms
  ç¼–è¯‘: 100ms
  æ€»è®¡: 150ms

WASM:
  ä¸‹è½½WASM: 100ms (ç½‘ç»œä¾èµ–)
  ç¼–è¯‘WASM: 50ms
  æ€»è®¡: 150ms

âœ… ç›¸ä¼¼çš„å†·å¯åŠ¨æ—¶é—´
âœ… ä½†WASMå¯ä»¥ç¼“å­˜ç¼–è¯‘ç»“æœ
```

**å†…å­˜overhead**ï¼š

```text
WASMé¢å¤–å¼€é”€:
  - WASM Runtime: ~2MB
  - Linear Memory: 2-16MB
  - å®¿ä¸»ç»‘å®š: ~1MB

å¯¹æ¯”Native:
  - Go Runtime: ~20MB
  - GC overhead: ~10MB

âœ… WASMæ€»ä½“æ›´è½»é‡
```

### 9.3 è°ƒè¯•éš¾åº¦

**é™åˆ¶**ï¼š

```text
âŒ æ— æ³•ä½¿ç”¨ print() / trace()
âŒ éš¾ä»¥å•æ­¥è°ƒè¯•
âŒ é”™è¯¯å †æ ˆä¿¡æ¯æœ‰é™
```

**è°ƒè¯•ç­–ç•¥**ï¼š

```bash
# 1. ä½¿ç”¨Native OPAå¼€å‘å’Œæµ‹è¯•
opa eval -d policy.rego 'data.authz.allow' --input input.json

# 2. ç¼–è¯‘ä¸ºWASMå‰å……åˆ†æµ‹è¯•
opa test policy/ -v

# 3. ç¼–è¯‘æ—¶ä¿ç•™è°ƒè¯•ä¿¡æ¯
opa build -t wasm -e data.authz.allow --debug policy.rego

# 4. ä½¿ç”¨WASMè°ƒè¯•å·¥å…·
wasmtime run --invoke eval policy.wasm
```

---

## 10. æœ€ä½³å®è·µ

### 10.1 ä½•æ—¶ä½¿ç”¨WASM

**é€‚åˆä½¿ç”¨WASM**ï¼š

```text
âœ… éGoè¯­è¨€åº”ç”¨é›†æˆ
âœ… æµè§ˆå™¨/è¾¹ç¼˜è®¡ç®—åœºæ™¯
âœ… éœ€è¦ç­–ç•¥æ²™ç®±éš”ç¦»
âœ… ç”Ÿäº§ç¯å¢ƒå¤§è§„æ¨¡éƒ¨ç½²
âœ… ç­–ç•¥å˜æ›´é¢‘ç‡ä½ï¼ˆå¤©/å‘¨çº§åˆ«ï¼‰
âœ… ä¸ä¾èµ–http.sendç­‰ç‰¹æ®Šå†…ç½®å‡½æ•°
```

**ä¸é€‚åˆä½¿ç”¨WASM**ï¼š

```text
âŒ Goè¯­è¨€åº”ç”¨ï¼ˆç›´æ¥ç”¨Nativeï¼‰
âŒ éœ€è¦é¢‘ç¹çƒ­æ›´æ–°ç­–ç•¥
âŒ ä¸¥é‡ä¾èµ–ä¸æ”¯æŒçš„å†…ç½®å‡½æ•°
âŒ éœ€è¦è¯¦ç»†çš„è°ƒè¯•å’Œè¿½è¸ª
âŒ å¼€å‘é˜¶æ®µï¼ˆè¿­ä»£é€Ÿåº¦æ…¢ï¼‰
```

### 10.2 Entrypointè®¾è®¡

**æœ€ä½³å®è·µ**ï¼š

```rego
# âœ… å¥½çš„è®¾è®¡: æ˜ç¡®çš„å…¥å£ç‚¹
package authz.api

import rego.v1

# ä¸»å†³ç­–ç‚¹
default allow := false

allow if {
    is_admin
}

allow if {
    is_resource_owner
}

# è¾…åŠ©è§„åˆ™
is_admin if {
    input.user.role == "admin"
}

is_resource_owner if {
    input.user.id == data.resources[input.resource_id].owner
}
```

**ç¼–è¯‘**ï¼š

```bash
# åªå¯¼å‡ºä¸»å†³ç­–ç‚¹
opa build -t wasm -e data.authz.api.allow policy/
```

### 10.3 æ•°æ®ç®¡ç†

**ç­–ç•¥**ï¼š

```text
åµŒå…¥å¼æ•°æ®ï¼ˆç¼–è¯‘æ—¶ï¼‰:
  âœ… é™æ€é…ç½®ï¼ˆè§’è‰²å®šä¹‰ã€æƒé™çŸ©é˜µï¼‰
  âœ… ä¸å¸¸å˜åŒ–çš„å¼•ç”¨æ•°æ®
  âœ… å°å‹æ•°æ®é›†ï¼ˆ<100KBï¼‰

å¤–éƒ¨æ•°æ®ï¼ˆè¿è¡Œæ—¶ï¼‰:
  âœ… ç”¨æˆ·ä¿¡æ¯ã€èµ„æºå±æ€§
  âœ… é¢‘ç¹å˜åŒ–çš„æ•°æ®
  âœ… å¤§å‹æ•°æ®é›†ï¼ˆ>1MBï¼‰
  âœ… å¤šç§Ÿæˆ·æ•°æ®
```

**ç¤ºä¾‹**ï¼š

```bash
# åµŒå…¥é™æ€è§’è‰²å®šä¹‰
opa build -t wasm -e data.authz.allow \
  policy/ \
  static/roles.json

# è¿è¡Œæ—¶è®¾ç½®åŠ¨æ€ç”¨æˆ·æ•°æ®
policy.setDataPath(['users'], dynamicUserData);
```

---

## é™„å½•Aï¼šWASMæ¨¡å—å®Œæ•´ç¤ºä¾‹

**policy.rego**ï¼š

```rego
package authz

import rego.v1

default allow := false

# Adminå…¨å±€è®¿é—®
allow if {
    input.user.role == "admin"
}

# èµ„æºæ‰€æœ‰è€…è®¿é—®
allow if {
    input.user.id == data.resources[input.resource].owner
    input.action in ["read", "write"]
}

# å›¢é˜Ÿæˆå‘˜åªè¯»è®¿é—®
allow if {
    input.user.team == data.resources[input.resource].team
    input.action == "read"
}
```

**ç¼–è¯‘**ï¼š

```bash
opa build -t wasm -e data.authz.allow \
  --optimize=2 \
  -o authz-bundle.tar.gz \
  policy.rego

tar -xzf authz-bundle.tar.gz policy.wasm
```

**JavaScriptä½¿ç”¨**ï¼š

```javascript
const { loadPolicy } = require('@open-policy-agent/opa-wasm');
const fs = require('fs');

async function main() {
  const wasm = fs.readFileSync('policy.wasm');
  const policy = await loadPolicy(wasm);

  // è®¾ç½®èµ„æºæ•°æ®
  policy.setData({
    resources: {
      'doc-123': {
        owner: 'alice',
        team: 'engineering'
      }
    }
  });

  // æµ‹è¯•ç”¨ä¾‹
  const tests = [
    { user: { id: 'alice', role: 'user' }, resource: 'doc-123', action: 'write' },
    { user: { id: 'bob', role: 'admin' }, resource: 'doc-123', action: 'delete' },
    { user: { id: 'charlie', team: 'engineering' }, resource: 'doc-123', action: 'read' }
  ];

  for (const input of tests) {
    const result = await policy.evaluate(input);
    console.log(`${input.user.id} ${input.action}: ${result[0].result}`);
  }
}

main().catch(console.error);
```

---

## é™„å½•Bï¼šæ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•

**ç¼–è¯‘é˜¶æ®µ**ï¼š

- [ ] ä½¿ç”¨ `--optimize=2` è¿›è¡Œç”Ÿäº§æ„å»º
- [ ] ç§»é™¤ä¸å¿…è¦çš„ç­–ç•¥å’Œè§„åˆ™
- [ ] åˆå¹¶å¤šä¸ªå°ç­–ç•¥æ–‡ä»¶
- [ ] åµŒå…¥é™æ€æ•°æ®è€Œéè¿è¡Œæ—¶åŠ è½½
- [ ] æœ€å°åŒ–Entrypointæ•°é‡

**è¿è¡Œæ—¶**ï¼š

- [ ] ç¼“å­˜WASMæ¨¡å—ç¼–è¯‘ç»“æœ
- [ ] å¤ç”¨WASMå®ä¾‹å¤„ç†å¤šä¸ªè¯·æ±‚
- [ ] å®ç°æ±‚å€¼ç»“æœç¼“å­˜
- [ ] æ‰¹é‡è®¾ç½®æ•°æ®è€Œéé€æ¡æ›´æ–°
- [ ] ä½¿ç”¨å¯¹è±¡æ± ç®¡ç†å†…å­˜

**ç­–ç•¥ä¼˜åŒ–**ï¼š

- [ ] é¿å…æ·±åº¦åµŒå¥—çš„è¿­ä»£
- [ ] ä½¿ç”¨ç´¢å¼•åŠ é€Ÿæ•°æ®æŸ¥æ‰¾
- [ ] æå–å…¬å…±å­è¡¨è¾¾å¼
- [ ] ä½¿ç”¨æ—©æœŸé€€å‡ºä¼˜åŒ–
- [ ] å‡å°‘ä¸å¿…è¦çš„ç±»å‹è½¬æ¢

**ç›‘æ§**ï¼š

- [ ] è·Ÿè¸ªæ±‚å€¼å»¶è¿Ÿï¼ˆP50/P99ï¼‰
- [ ] ç›‘æ§WASMå†…å­˜ä½¿ç”¨
- [ ] è®°å½•ç¼“å­˜å‘½ä¸­ç‡
- [ ] æ£€æµ‹å†…å­˜æ³„æ¼
- [ ] å®šæœŸæ€§èƒ½åŸºå‡†æµ‹è¯•

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [Bundleæ ¼å¼è§„èŒƒ](./01.2-Bundleæ ¼å¼è§„èŒƒ.md)
- [æ€§èƒ½åŸºå‡†ä¸åº¦é‡](./01.4-æ€§èƒ½åŸºå‡†ä¸åº¦é‡.md)
- [Kubernetesé›†æˆ](../04-ç”Ÿæ€ç³»ç»Ÿ/04.1-Kubernetesé›†æˆ.md)

**å‚è€ƒèµ„æº**ï¼š

- WASM Compilation: <https://www.openpolicyagent.org/docs/latest/wasm/>
- JavaScript SDK: <https://github.com/open-policy-agent/npm-opa-wasm>
- WASI Specification: <https://wasi.dev/>
