# OPA API 规范（API Specification）

> **更新日期**: 2025年10月20日  
> **协议版本**: REST API v1 / gRPC v1  
> **OpenAPI版本**: 3.0.3  
> **基础**: <https://www.openpolicyagent.org/docs/latest/rest-api/>

---

## 目录

- [OPA API 规范（API Specification）](#opa-api-规范api-specification)
  - [目录](#目录)
  - [1. API概述](#1-api概述)
    - [1.1 协议支持](#11-协议支持)
    - [1.2 默认配置](#12-默认配置)
    - [1.3 API设计原则](#13-api设计原则)
  - [2. REST API](#2-rest-api)
    - [2.1 策略查询（Policy Query）](#21-策略查询policy-query)
      - [2.1.1 基本查询](#211-基本查询)
      - [2.1.2 批量查询](#212-批量查询)
      - [2.1.3 查询参数](#213-查询参数)
    - [2.2 策略管理](#22-策略管理)
      - [2.2.1 上传策略](#221-上传策略)
      - [2.2.2 列出策略](#222-列出策略)
      - [2.2.3 获取策略](#223-获取策略)
      - [2.2.4 删除策略](#224-删除策略)
    - [2.3 数据管理](#23-数据管理)
      - [2.3.1 写入数据](#231-写入数据)
      - [2.3.2 读取数据](#232-读取数据)
      - [2.3.3 删除数据](#233-删除数据)
    - [2.4 编译API（部分求值）](#24-编译api部分求值)
    - [2.5 健康检查](#25-健康检查)
      - [2.5.1 基本健康](#251-基本健康)
      - [2.5.2 Bundle健康](#252-bundle健康)
      - [2.5.3 插件健康](#253-插件健康)
    - [2.6 监控指标](#26-监控指标)
    - [2.7 决策日志查询](#27-决策日志查询)
  - [3. gRPC API](#3-grpc-api)
    - [3.1 服务定义](#31-服务定义)
    - [3.2 启用gRPC](#32-启用grpc)
    - [3.3 客户端示例](#33-客户端示例)
  - [4. 认证与授权](#4-认证与授权)
    - [4.1 TLS配置](#41-tls配置)
    - [4.2 Token认证](#42-token认证)
    - [4.3 mTLS](#43-mtls)
  - [5. 错误处理](#5-错误处理)
    - [5.1 HTTP状态码](#51-http状态码)
    - [5.2 错误响应格式](#52-错误响应格式)
    - [5.3 错误代码](#53-错误代码)
  - [6. 性能考虑](#6-性能考虑)
    - [6.1 缓存](#61-缓存)
    - [6.2 压缩](#62-压缩)
    - [6.3 连接复用](#63-连接复用)
    - [6.4 批量优化](#64-批量优化)
  - [附录 A: OpenAPI规范](#附录-a-openapi规范)
  - [附录 B: 性能基准](#附录-b-性能基准)
    - [延迟（Latency）](#延迟latency)
    - [吞吐量（Throughput）](#吞吐量throughput)

---

## 1. API概述

### 1.1 协议支持

OPA提供两种主要协议：

| 协议 | 传输 | 用途 | 性能 |
|------|------|------|------|
| **REST** | HTTP/1.1, HTTP/2 | 通用、易集成 | 中等 |
| **gRPC** | HTTP/2 | 高性能、流式 | 高 |

### 1.2 默认配置

```bash
# 启动OPA服务器
opa run --server --addr :8181

# 基础URL
BASE_URL=http://localhost:8181
```

### 1.3 API设计原则

- **RESTful**: 符合REST约束
- **幂等性**: GET/PUT操作幂等
- **JSON**: 统一使用JSON格式
- **版本化**: URL路径包含版本（`/v1/...`）
- **向后兼容**: v1 API长期支持

---

## 2. REST API

### 2.1 策略查询（Policy Query）

#### 2.1.1 基本查询

**端点**: `POST /v1/data/{path}`

**描述**: 查询策略决策结果。

**请求**:

```http
POST /v1/data/example/allow HTTP/1.1
Host: localhost:8181
Content-Type: application/json

{
    "input": {
        "user": "alice",
        "action": "read",
        "resource": "/api/users"
    }
}
```

**响应**:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "result": true,
    "decision_id": "7b4c8f3e-f890-4d9a-b2c3-1a2b3c4d5e6f"
}
```

**路径参数**:

- `{path}`: 策略路径，如 `example/allow`、`kubernetes/admission`

**请求体字段**:

```json
{
    "input": {},           // 必需：输入数据
    "unknowns": [],        // 可选：未知变量（用于部分求值）
    "provenance": false,   // 可选：返回来源信息
    "explain": "notes",    // 可选：调试信息级别
    "metrics": false,      // 可选：性能指标
    "instrument": false,   // 可选：详细度量
    "strict_builtin_errors": false  // 可选：严格错误处理
}
```

**响应字段**:

```json
{
    "decision_id": "uuid",      // 决策唯一ID
    "result": <any>,            // 查询结果
    "provenance": {...},        // 来源信息（如请求）
    "explanation": [...],       // 执行轨迹（如请求）
    "metrics": {...},           // 性能指标（如请求）
    "warnings": [...]           // 警告信息
}
```

#### 2.1.2 批量查询

**端点**: `POST /v1/data/{path}`

**请求**（多个输入）:

```json
{
    "inputs": [
        {"user": "alice", "action": "read"},
        {"user": "bob", "action": "write"}
    ]
}
```

**响应**（批量结果）:

```json
{
    "results": [
        {"result": true, "decision_id": "..."},
        {"result": false, "decision_id": "..."}
    ]
}
```

#### 2.1.3 查询参数

**URL参数**:

```text
GET /v1/data/example/allow?pretty=true&provenance=true&explain=full&metrics=true
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `pretty` | bool | false | 格式化JSON输出 |
| `provenance` | bool | false | 返回来源信息 |
| `explain` | string | "off" | 调试级别：`off`/`notes`/`fails`/`full` |
| `metrics` | bool | false | 返回性能指标 |
| `instrument` | bool | false | 详细仪器化数据 |

---

### 2.2 策略管理

#### 2.2.1 上传策略

**端点**: `PUT /v1/policies/{id}`

**描述**: 上传或更新Rego策略模块。

**请求**:

```http
PUT /v1/policies/example HTTP/1.1
Host: localhost:8181
Content-Type: text/plain

package example

import future.keywords.if

allow if {
    input.user == "admin"
}
```

**响应**:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "result": {
        "id": "example",
        "raw": "package example\n...",
        "ast": {...}
    }
}
```

#### 2.2.2 列出策略

**端点**: `GET /v1/policies`

**响应**:

```json
{
    "result": [
        {
            "id": "example",
            "raw": "package example\n...",
            "ast": {...}
        }
    ]
}
```

#### 2.2.3 获取策略

**端点**: `GET /v1/policies/{id}`

**响应**:

```json
{
    "result": {
        "id": "example",
        "raw": "package example\n...",
        "ast": {...}
    }
}
```

#### 2.2.4 删除策略

**端点**: `DELETE /v1/policies/{id}`

**响应**:

```http
HTTP/1.1 204 No Content
```

---

### 2.3 数据管理

#### 2.3.1 写入数据

**端点**: `PUT /v1/data/{path}` 或 `PATCH /v1/data/{path}`

**PUT请求**（替换）:

```http
PUT /v1/data/users HTTP/1.1
Content-Type: application/json

{
    "alice": {"role": "admin"},
    "bob": {"role": "user"}
}
```

**PATCH请求**（合并）:

```http
PATCH /v1/data/users HTTP/1.1
Content-Type: application/json

[
    {
        "op": "add",
        "path": "/charlie",
        "value": {"role": "viewer"}
    },
    {
        "op": "remove",
        "path": "/bob"
    }
]
```

**PATCH操作**（JSON Patch RFC 6902）:

- `add`: 添加
- `remove`: 删除
- `replace`: 替换
- `move`: 移动
- `copy`: 复制
- `test`: 测试

#### 2.3.2 读取数据

**端点**: `GET /v1/data/{path}`

**请求**:

```http
GET /v1/data/users/alice HTTP/1.1
```

**响应**:

```json
{
    "result": {
        "role": "admin"
    }
}
```

#### 2.3.3 删除数据

**端点**: `DELETE /v1/data/{path}`

**响应**:

```http
HTTP/1.1 204 No Content
```

---

### 2.4 编译API（部分求值）

**端点**: `POST /v1/compile`

**描述**: 对策略进行部分求值，生成优化查询。

**请求**:

```json
{
    "query": "data.example.allow == true",
    "input": {
        "user": "alice"
    },
    "unknowns": ["input.action", "input.resource"]
}
```

**响应**:

```json
{
    "result": {
        "queries": [
            [
                {
                    "index": 0,
                    "terms": [
                        {"type": "ref", "value": ["input", "action"]},
                        {"type": "string", "value": "read"}
                    ]
                }
            ]
        ]
    }
}
```

**用途**:

- 预计算固定数据部分
- 生成高效的运行时查询
- 边缘分发（WASM）

---

### 2.5 健康检查

#### 2.5.1 基本健康

**端点**: `GET /health`

**响应**:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{}
```

**状态码**:

- `200`: 健康
- `500`: 不健康

#### 2.5.2 Bundle健康

**端点**: `GET /health?bundles`

**响应**:

```json
{
    "bundles": {
        "authz": {
            "active_revision": "v1.2.3",
            "last_successful_download": "2025-10-20T12:00:00Z",
            "last_successful_activation": "2025-10-20T12:00:01Z"
        }
    }
}
```

#### 2.5.3 插件健康

**端点**: `GET /health?plugins`

**响应**:

```json
{
    "plugins": {
        "bundle": {"state": "OK"},
        "decision_logs": {"state": "OK"},
        "status": {"state": "OK"}
    }
}
```

---

### 2.6 监控指标

**端点**: `GET /metrics`

**描述**: Prometheus格式的指标。

**响应**:

```text
# HELP http_request_duration_seconds Duration of HTTP requests
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{code="200",handler="v1/data",method="post",le="0.005"} 123
http_request_duration_seconds_bucket{code="200",handler="v1/data",method="post",le="0.01"} 456
...

# HELP opa_policy_evaluation_total Total policy evaluations
# TYPE opa_policy_evaluation_total counter
opa_policy_evaluation_total{policy="example.allow"} 10234
```

**关键指标**:

- `http_request_duration_seconds`: 请求延迟
- `opa_policy_evaluation_total`: 策略求值次数
- `opa_policy_evaluation_duration_seconds`: 求值时长
- `opa_bundle_loaded_total`: Bundle加载次数

---

### 2.7 决策日志查询

**端点**: `POST /v1/data/system/diagnostics/decision`

**请求**:

```json
{
    "input": {
        "decision_id": "7b4c8f3e-f890-4d9a-b2c3-1a2b3c4d5e6f"
    }
}
```

**响应**:

```json
{
    "result": {
        "decision_id": "...",
        "timestamp": "2025-10-20T12:00:00Z",
        "input": {...},
        "result": true,
        "path": "example/allow",
        "metrics": {
            "timer_rego_query_eval_ns": 1234567
        }
    }
}
```

---

## 3. gRPC API

### 3.1 服务定义

**Protocol Buffers**:

```protobuf
syntax = "proto3";

package grpc.openpolicyagent.v1;

service OPA {
    // 策略查询
    rpc Evaluate(EvaluateRequest) returns (EvaluateResponse);
    
    // 流式查询
    rpc StreamingEvaluate(stream EvaluateRequest) returns (stream EvaluateResponse);
}

message EvaluateRequest {
    string path = 1;           // 策略路径
    bytes input = 2;           // JSON编码的输入
    bool unknowns = 3;         // 是否部分求值
    bool explain = 4;          // 是否返回解释
    bool metrics = 5;          // 是否返回指标
}

message EvaluateResponse {
    string decision_id = 1;    // 决策ID
    bytes result = 2;          // JSON编码的结果
    bytes provenance = 3;      // 来源信息
    repeated string warnings = 4;  // 警告
    bytes metrics = 5;         // 性能指标
}
```

### 3.2 启用gRPC

```bash
opa run --server --addr :8181 --grpc-addr :9000
```

### 3.3 客户端示例

**Go客户端**:

```go
import (
    "context"
    pb "github.com/open-policy-agent/opa/grpc"
    "google.golang.org/grpc"
)

func main() {
    conn, _ := grpc.Dial("localhost:9000", grpc.WithInsecure())
    defer conn.Close()
    
    client := pb.NewOPAClient(conn)
    
    resp, err := client.Evaluate(context.Background(), &pb.EvaluateRequest{
        Path:  "example/allow",
        Input: []byte(`{"user": "alice"}`),
    })
    
    // 处理响应
}
```

---

## 4. 认证与授权

### 4.1 TLS配置

```bash
opa run --server \
    --tls-cert-file server-cert.pem \
    --tls-private-key-file server-key.pem \
    --tls-ca-cert-file ca-cert.pem
```

### 4.2 Token认证

**请求头**:

```http
Authorization: Bearer <token>
```

**配置**:

```yaml
# config.yaml
services:
  - name: my-service
    url: https://bundle-server.com
    credentials:
      bearer:
        token: "secret-token"
```

### 4.3 mTLS

**双向TLS认证**:

```bash
opa run --server \
    --tls-cert-file server-cert.pem \
    --tls-private-key-file server-key.pem \
    --tls-ca-cert-file ca-cert.pem \
    --authentication=tls
```

---

## 5. 错误处理

### 5.1 HTTP状态码

| 状态码 | 含义 | 场景 |
|--------|------|------|
| `200` | 成功 | 查询成功 |
| `204` | 无内容 | 删除成功 |
| `400` | 错误请求 | JSON格式错误、语法错误 |
| `404` | 未找到 | 策略/数据不存在 |
| `500` | 服务器错误 | 内部错误、panic |
| `503` | 服务不可用 | Bundle未加载 |

### 5.2 错误响应格式

```json
{
    "code": "invalid_parameter",
    "message": "invalid input document: parse error at line 5",
    "errors": [
        {
            "code": "rego_parse_error",
            "message": "unexpected token 'if'",
            "location": {"file": "policy.rego", "row": 5, "col": 10}
        }
    ]
}
```

### 5.3 错误代码

| 代码 | 说明 |
|------|------|
| `invalid_parameter` | 参数无效 |
| `rego_parse_error` | Rego语法错误 |
| `rego_type_error` | 类型错误 |
| `rego_unsafe_var_error` | 不安全变量 |
| `internal_error` | 内部错误 |

---

## 6. 性能考虑

### 6.1 缓存

**响应头**:

```http
Cache-Control: max-age=300
ETag: "abc123"
```

**条件请求**:

```http
If-None-Match: "abc123"
```

### 6.2 压缩

**请求头**:

```http
Accept-Encoding: gzip, deflate
```

**响应头**:

```http
Content-Encoding: gzip
```

### 6.3 连接复用

**HTTP/2**:

- 多路复用
- 头部压缩
- 服务器推送

**Keep-Alive**:

```http
Connection: keep-alive
Keep-Alive: timeout=5, max=100
```

### 6.4 批量优化

```json
{
    "inputs": [/* 100个输入 */]
}
```

**性能**:

- 单次查询: 1ms × 100 = 100ms
- 批量查询: 10ms（批处理开销）

---

## 附录 A: OpenAPI规范

完整OpenAPI 3.0规范: <https://www.openpolicyagent.org/docs/latest/rest-api/>

**示例片段**:

```yaml
openapi: 3.0.3
info:
  title: OPA REST API
  version: v1
paths:
  /v1/data/{path}:
    post:
      summary: Query Policy
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
```

---

## 附录 B: 性能基准

### 延迟（Latency）

| 操作 | p50 | p99 | p99.9 |
|------|-----|-----|-------|
| 简单查询 | 0.5ms | 2ms | 10ms |
| 复杂查询 | 5ms | 20ms | 50ms |
| Bundle加载 | 100ms | 500ms | 2s |

### 吞吐量（Throughput）

- **单核**: 100K 决策/秒（简单规则）
- **4核**: 300K 决策/秒
- **批量**: 500K 决策/秒

---

**下一篇**: [01.2-Bundle格式规范](./01.2-Bundle格式规范.md)  
**相关**: [08.5-监控与调试](../08-最佳实践/08.5-监控与调试.md)
