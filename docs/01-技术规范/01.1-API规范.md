# OPA API è§„èŒƒï¼ˆAPI Specificationï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.55+ | æ¨è v0.68+  
> **åè®®ç‰ˆæœ¬**: REST API v1 / gRPC v1  
> **OpenAPIç‰ˆæœ¬**: 3.0.3  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/rest-api/>

---

## âš ï¸ é‡è¦æç¤º

> **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ³¨æ„äº‹é¡¹**:
>
> - âœ… å¯ç”¨TLS/mTLSåŠ å¯†é€šä¿¡
> - âœ… é…ç½®é€‚å½“çš„è®¤è¯æœºåˆ¶ï¼ˆToken/è¯ä¹¦ï¼‰
> - âœ… è®¾ç½®åˆç†çš„è¶…æ—¶å’Œé‡è¯•ç­–ç•¥  
> - âœ… å¯ç”¨å¥åº·æ£€æŸ¥å’Œç›‘æ§æŒ‡æ ‡
> - âœ… é™åˆ¶APIè®¿é—®æƒé™ï¼ˆç½‘ç»œç­–ç•¥ï¼‰
> - âš ï¸ è°¨æ…ä½¿ç”¨ç¼–è¯‘APIï¼ˆå¯èƒ½æ¶ˆè€—å¤§é‡èµ„æºï¼‰
> - âš ï¸ å†³ç­–æ—¥å¿—å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œéœ€è¦è„±æ•å¤„ç†
>
> è¯¦è§: [ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•](../../CHECKLIST.md)

---

## ğŸ“ English Summary

This document provides a comprehensive specification of OPA's REST API and gRPC API.

**Key Topics**:

- **REST API**: Policy queries, policy management, data management, compilation, health checks
- **gRPC API**: High-performance binary protocol for Envoy integration
- **Authentication**: Token-based auth, mTLS, API key management
- **Performance**: Caching strategies, batch queries, connection pooling
- **Monitoring**: Health endpoints, metrics, decision logs

**Target Audience**: Backend developers, DevOps engineers, system architects integrating OPA into their applications.

**Version**: OPA v0.55+ (Recommended: v0.68+)

---

## ç›®å½•

- [OPA API è§„èŒƒï¼ˆAPI Specificationï¼‰](#opa-api-è§„èŒƒapi-specification)
  - [âš ï¸ é‡è¦æç¤º](#ï¸-é‡è¦æç¤º)
  - [ğŸ“ English Summary](#-english-summary)
  - [ç›®å½•](#ç›®å½•)
  - [1. APIæ¦‚è¿°](#1-apiæ¦‚è¿°)
    - [1.1 åè®®æ”¯æŒ](#11-åè®®æ”¯æŒ)
    - [1.2 é»˜è®¤é…ç½®](#12-é»˜è®¤é…ç½®)
    - [1.3 APIè®¾è®¡åŸåˆ™](#13-apiè®¾è®¡åŸåˆ™)
  - [2. REST API](#2-rest-api)
    - [2.1 ç­–ç•¥æŸ¥è¯¢ï¼ˆPolicy Queryï¼‰](#21-ç­–ç•¥æŸ¥è¯¢policy-query)
      - [2.1.1 åŸºæœ¬æŸ¥è¯¢](#211-åŸºæœ¬æŸ¥è¯¢)
      - [2.1.2 æ‰¹é‡æŸ¥è¯¢](#212-æ‰¹é‡æŸ¥è¯¢)
      - [2.1.3 æŸ¥è¯¢å‚æ•°](#213-æŸ¥è¯¢å‚æ•°)
    - [2.2 ç­–ç•¥ç®¡ç†](#22-ç­–ç•¥ç®¡ç†)
      - [2.2.1 ä¸Šä¼ ç­–ç•¥](#221-ä¸Šä¼ ç­–ç•¥)
      - [2.2.2 åˆ—å‡ºç­–ç•¥](#222-åˆ—å‡ºç­–ç•¥)
      - [2.2.3 è·å–ç­–ç•¥](#223-è·å–ç­–ç•¥)
      - [2.2.4 åˆ é™¤ç­–ç•¥](#224-åˆ é™¤ç­–ç•¥)
    - [2.3 æ•°æ®ç®¡ç†](#23-æ•°æ®ç®¡ç†)
      - [2.3.1 å†™å…¥æ•°æ®](#231-å†™å…¥æ•°æ®)
      - [2.3.2 è¯»å–æ•°æ®](#232-è¯»å–æ•°æ®)
      - [2.3.3 åˆ é™¤æ•°æ®](#233-åˆ é™¤æ•°æ®)
    - [2.4 ç¼–è¯‘APIï¼ˆéƒ¨åˆ†æ±‚å€¼ï¼‰](#24-ç¼–è¯‘apiéƒ¨åˆ†æ±‚å€¼)
    - [2.5 å¥åº·æ£€æŸ¥](#25-å¥åº·æ£€æŸ¥)
      - [2.5.1 åŸºæœ¬å¥åº·](#251-åŸºæœ¬å¥åº·)
      - [2.5.2 Bundleå¥åº·](#252-bundleå¥åº·)
      - [2.5.3 æ’ä»¶å¥åº·](#253-æ’ä»¶å¥åº·)
    - [2.6 ç›‘æ§æŒ‡æ ‡](#26-ç›‘æ§æŒ‡æ ‡)
    - [2.7 å†³ç­–æ—¥å¿—æŸ¥è¯¢](#27-å†³ç­–æ—¥å¿—æŸ¥è¯¢)
  - [3. gRPC API](#3-grpc-api)
    - [3.1 æœåŠ¡å®šä¹‰](#31-æœåŠ¡å®šä¹‰)
    - [3.2 å¯ç”¨gRPC](#32-å¯ç”¨grpc)
    - [3.3 å®¢æˆ·ç«¯ç¤ºä¾‹](#33-å®¢æˆ·ç«¯ç¤ºä¾‹)
  - [4. è®¤è¯ä¸æˆæƒ](#4-è®¤è¯ä¸æˆæƒ)
    - [4.1 TLSé…ç½®](#41-tlsé…ç½®)
    - [4.2 Tokenè®¤è¯](#42-tokenè®¤è¯)
    - [4.3 mTLS](#43-mtls)
  - [5. é”™è¯¯å¤„ç†](#5-é”™è¯¯å¤„ç†)
    - [5.1 HTTPçŠ¶æ€ç ](#51-httpçŠ¶æ€ç )
    - [5.2 é”™è¯¯å“åº”æ ¼å¼](#52-é”™è¯¯å“åº”æ ¼å¼)
    - [5.3 é”™è¯¯ä»£ç ](#53-é”™è¯¯ä»£ç )
  - [6. æ€§èƒ½è€ƒè™‘](#6-æ€§èƒ½è€ƒè™‘)
    - [6.1 ç¼“å­˜](#61-ç¼“å­˜)
    - [6.2 å‹ç¼©](#62-å‹ç¼©)
    - [6.3 è¿æ¥å¤ç”¨](#63-è¿æ¥å¤ç”¨)
    - [6.4 æ‰¹é‡ä¼˜åŒ–](#64-æ‰¹é‡ä¼˜åŒ–)
  - [é™„å½• A: OpenAPIè§„èŒƒ](#é™„å½•-a-openapiè§„èŒƒ)
  - [é™„å½• B: æ€§èƒ½åŸºå‡†](#é™„å½•-b-æ€§èƒ½åŸºå‡†)
    - [å»¶è¿Ÿï¼ˆLatencyï¼‰](#å»¶è¿Ÿlatency)
    - [ååé‡ï¼ˆThroughputï¼‰](#ååé‡throughput)

---

## 1. APIæ¦‚è¿°

### 1.1 åè®®æ”¯æŒ

OPAæä¾›ä¸¤ç§ä¸»è¦åè®®ï¼š

| åè®® | ä¼ è¾“ | ç”¨é€” | æ€§èƒ½ |
|------|------|------|------|
| **REST** | HTTP/1.1, HTTP/2 | é€šç”¨ã€æ˜“é›†æˆ | ä¸­ç­‰ |
| **gRPC** | HTTP/2 | é«˜æ€§èƒ½ã€æµå¼ | é«˜ |

### 1.2 é»˜è®¤é…ç½®

```bash
# å¯åŠ¨OPAæœåŠ¡å™¨
opa run --server --addr :8181

# åŸºç¡€URL
BASE_URL=http://localhost:8181
```

### 1.3 APIè®¾è®¡åŸåˆ™

- **RESTful**: ç¬¦åˆRESTçº¦æŸ
- **å¹‚ç­‰æ€§**: GET/PUTæ“ä½œå¹‚ç­‰
- **JSON**: ç»Ÿä¸€ä½¿ç”¨JSONæ ¼å¼
- **ç‰ˆæœ¬åŒ–**: URLè·¯å¾„åŒ…å«ç‰ˆæœ¬ï¼ˆ`/v1/...`ï¼‰
- **å‘åå…¼å®¹**: v1 APIé•¿æœŸæ”¯æŒ

---

## 2. REST API

### 2.1 ç­–ç•¥æŸ¥è¯¢ï¼ˆPolicy Queryï¼‰

#### 2.1.1 åŸºæœ¬æŸ¥è¯¢

**ç«¯ç‚¹**: `POST /v1/data/{path}`

**æè¿°**: æŸ¥è¯¢ç­–ç•¥å†³ç­–ç»“æœã€‚

**è¯·æ±‚**:

```http
POST /v1/data/example/allow HTTP/1.1
Host: localhost:8181
Content-Type: application/json

{
    "input": {
        "user": "alice",
        "action": "read",
        "resource": "/api/users"
    }
}
```

**å“åº”**:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "result": true,
    "decision_id": "7b4c8f3e-f890-4d9a-b2c3-1a2b3c4d5e6f"
}
```

**è·¯å¾„å‚æ•°**:

- `{path}`: ç­–ç•¥è·¯å¾„ï¼Œå¦‚ `example/allow`ã€`kubernetes/admission`

**è¯·æ±‚ä½“å­—æ®µ**:

```json
{
    "input": {},           // å¿…éœ€ï¼šè¾“å…¥æ•°æ®
    "unknowns": [],        // å¯é€‰ï¼šæœªçŸ¥å˜é‡ï¼ˆç”¨äºéƒ¨åˆ†æ±‚å€¼ï¼‰
    "provenance": false,   // å¯é€‰ï¼šè¿”å›æ¥æºä¿¡æ¯
    "explain": "notes",    // å¯é€‰ï¼šè°ƒè¯•ä¿¡æ¯çº§åˆ«
    "metrics": false,      // å¯é€‰ï¼šæ€§èƒ½æŒ‡æ ‡
    "instrument": false,   // å¯é€‰ï¼šè¯¦ç»†åº¦é‡
    "strict_builtin_errors": false  // å¯é€‰ï¼šä¸¥æ ¼é”™è¯¯å¤„ç†
}
```

**å“åº”å­—æ®µ**:

```json
{
    "decision_id": "uuid",      // å†³ç­–å”¯ä¸€ID
    "result": <any>,            // æŸ¥è¯¢ç»“æœ
    "provenance": {...},        // æ¥æºä¿¡æ¯ï¼ˆå¦‚è¯·æ±‚ï¼‰
    "explanation": [...],       // æ‰§è¡Œè½¨è¿¹ï¼ˆå¦‚è¯·æ±‚ï¼‰
    "metrics": {...},           // æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚è¯·æ±‚ï¼‰
    "warnings": [...]           // è­¦å‘Šä¿¡æ¯
}
```

#### 2.1.2 æ‰¹é‡æŸ¥è¯¢

**ç«¯ç‚¹**: `POST /v1/data/{path}`

**è¯·æ±‚**ï¼ˆå¤šä¸ªè¾“å…¥ï¼‰:

```json
{
    "inputs": [
        {"user": "alice", "action": "read"},
        {"user": "bob", "action": "write"}
    ]
}
```

**å“åº”**ï¼ˆæ‰¹é‡ç»“æœï¼‰:

```json
{
    "results": [
        {"result": true, "decision_id": "..."},
        {"result": false, "decision_id": "..."}
    ]
}
```

#### 2.1.3 æŸ¥è¯¢å‚æ•°

**URLå‚æ•°**:

```text
GET /v1/data/example/allow?pretty=true&provenance=true&explain=full&metrics=true
```

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `pretty` | bool | false | æ ¼å¼åŒ–JSONè¾“å‡º |
| `provenance` | bool | false | è¿”å›æ¥æºä¿¡æ¯ |
| `explain` | string | "off" | è°ƒè¯•çº§åˆ«ï¼š`off`/`notes`/`fails`/`full` |
| `metrics` | bool | false | è¿”å›æ€§èƒ½æŒ‡æ ‡ |
| `instrument` | bool | false | è¯¦ç»†ä»ªå™¨åŒ–æ•°æ® |

---

### 2.2 ç­–ç•¥ç®¡ç†

#### 2.2.1 ä¸Šä¼ ç­–ç•¥

**ç«¯ç‚¹**: `PUT /v1/policies/{id}`

**æè¿°**: ä¸Šä¼ æˆ–æ›´æ–°Regoç­–ç•¥æ¨¡å—ã€‚

**è¯·æ±‚**:

```http
PUT /v1/policies/example HTTP/1.1
Host: localhost:8181
Content-Type: text/plain

package example

import future.keywords.if

allow if {
    input.user == "admin"
}
```

**å“åº”**:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "result": {
        "id": "example",
        "raw": "package example\n...",
        "ast": {...}
    }
}
```

#### 2.2.2 åˆ—å‡ºç­–ç•¥

**ç«¯ç‚¹**: `GET /v1/policies`

**å“åº”**:

```json
{
    "result": [
        {
            "id": "example",
            "raw": "package example\n...",
            "ast": {...}
        }
    ]
}
```

#### 2.2.3 è·å–ç­–ç•¥

**ç«¯ç‚¹**: `GET /v1/policies/{id}`

**å“åº”**:

```json
{
    "result": {
        "id": "example",
        "raw": "package example\n...",
        "ast": {...}
    }
}
```

#### 2.2.4 åˆ é™¤ç­–ç•¥

**ç«¯ç‚¹**: `DELETE /v1/policies/{id}`

**å“åº”**:

```http
HTTP/1.1 204 No Content
```

---

### 2.3 æ•°æ®ç®¡ç†

#### 2.3.1 å†™å…¥æ•°æ®

**ç«¯ç‚¹**: `PUT /v1/data/{path}` æˆ– `PATCH /v1/data/{path}`

**PUTè¯·æ±‚**ï¼ˆæ›¿æ¢ï¼‰:

```http
PUT /v1/data/users HTTP/1.1
Content-Type: application/json

{
    "alice": {"role": "admin"},
    "bob": {"role": "user"}
}
```

**PATCHè¯·æ±‚**ï¼ˆåˆå¹¶ï¼‰:

```http
PATCH /v1/data/users HTTP/1.1
Content-Type: application/json

[
    {
        "op": "add",
        "path": "/charlie",
        "value": {"role": "viewer"}
    },
    {
        "op": "remove",
        "path": "/bob"
    }
]
```

**PATCHæ“ä½œ**ï¼ˆJSON Patch RFC 6902ï¼‰:

- `add`: æ·»åŠ 
- `remove`: åˆ é™¤
- `replace`: æ›¿æ¢
- `move`: ç§»åŠ¨
- `copy`: å¤åˆ¶
- `test`: æµ‹è¯•

#### 2.3.2 è¯»å–æ•°æ®

**ç«¯ç‚¹**: `GET /v1/data/{path}`

**è¯·æ±‚**:

```http
GET /v1/data/users/alice HTTP/1.1
```

**å“åº”**:

```json
{
    "result": {
        "role": "admin"
    }
}
```

#### 2.3.3 åˆ é™¤æ•°æ®

**ç«¯ç‚¹**: `DELETE /v1/data/{path}`

**å“åº”**:

```http
HTTP/1.1 204 No Content
```

---

### 2.4 ç¼–è¯‘APIï¼ˆéƒ¨åˆ†æ±‚å€¼ï¼‰

**ç«¯ç‚¹**: `POST /v1/compile`

**æè¿°**: å¯¹ç­–ç•¥è¿›è¡Œéƒ¨åˆ†æ±‚å€¼ï¼Œç”Ÿæˆä¼˜åŒ–æŸ¥è¯¢ã€‚

**è¯·æ±‚**:

```json
{
    "query": "data.example.allow == true",
    "input": {
        "user": "alice"
    },
    "unknowns": ["input.action", "input.resource"]
}
```

**å“åº”**:

```json
{
    "result": {
        "queries": [
            [
                {
                    "index": 0,
                    "terms": [
                        {"type": "ref", "value": ["input", "action"]},
                        {"type": "string", "value": "read"}
                    ]
                }
            ]
        ]
    }
}
```

**ç”¨é€”**:

- é¢„è®¡ç®—å›ºå®šæ•°æ®éƒ¨åˆ†
- ç”Ÿæˆé«˜æ•ˆçš„è¿è¡Œæ—¶æŸ¥è¯¢
- è¾¹ç¼˜åˆ†å‘ï¼ˆWASMï¼‰

---

### 2.5 å¥åº·æ£€æŸ¥

#### 2.5.1 åŸºæœ¬å¥åº·

**ç«¯ç‚¹**: `GET /health`

**å“åº”**:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{}
```

**çŠ¶æ€ç **:

- `200`: å¥åº·
- `500`: ä¸å¥åº·

#### 2.5.2 Bundleå¥åº·

**ç«¯ç‚¹**: `GET /health?bundles`

**å“åº”**:

```json
{
    "bundles": {
        "authz": {
            "active_revision": "v1.2.3",
            "last_successful_download": "2025-10-20T12:00:00Z",
            "last_successful_activation": "2025-10-20T12:00:01Z"
        }
    }
}
```

#### 2.5.3 æ’ä»¶å¥åº·

**ç«¯ç‚¹**: `GET /health?plugins`

**å“åº”**:

```json
{
    "plugins": {
        "bundle": {"state": "OK"},
        "decision_logs": {"state": "OK"},
        "status": {"state": "OK"}
    }
}
```

---

### 2.6 ç›‘æ§æŒ‡æ ‡

**ç«¯ç‚¹**: `GET /metrics`

**æè¿°**: Prometheusæ ¼å¼çš„æŒ‡æ ‡ã€‚

**å“åº”**:

```text
# HELP http_request_duration_seconds Duration of HTTP requests
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{code="200",handler="v1/data",method="post",le="0.005"} 123
http_request_duration_seconds_bucket{code="200",handler="v1/data",method="post",le="0.01"} 456
...

# HELP opa_policy_evaluation_total Total policy evaluations
# TYPE opa_policy_evaluation_total counter
opa_policy_evaluation_total{policy="example.allow"} 10234
```

**å…³é”®æŒ‡æ ‡**:

- `http_request_duration_seconds`: è¯·æ±‚å»¶è¿Ÿ
- `opa_policy_evaluation_total`: ç­–ç•¥æ±‚å€¼æ¬¡æ•°
- `opa_policy_evaluation_duration_seconds`: æ±‚å€¼æ—¶é•¿
- `opa_bundle_loaded_total`: BundleåŠ è½½æ¬¡æ•°

---

### 2.7 å†³ç­–æ—¥å¿—æŸ¥è¯¢

**ç«¯ç‚¹**: `POST /v1/data/system/diagnostics/decision`

**è¯·æ±‚**:

```json
{
    "input": {
        "decision_id": "7b4c8f3e-f890-4d9a-b2c3-1a2b3c4d5e6f"
    }
}
```

**å“åº”**:

```json
{
    "result": {
        "decision_id": "...",
        "timestamp": "2025-10-20T12:00:00Z",
        "input": {...},
        "result": true,
        "path": "example/allow",
        "metrics": {
            "timer_rego_query_eval_ns": 1234567
        }
    }
}
```

---

## 3. gRPC API

### 3.1 æœåŠ¡å®šä¹‰

**Protocol Buffers**:

```protobuf
syntax = "proto3";

package grpc.openpolicyagent.v1;

service OPA {
    // ç­–ç•¥æŸ¥è¯¢
    rpc Evaluate(EvaluateRequest) returns (EvaluateResponse);
    
    // æµå¼æŸ¥è¯¢
    rpc StreamingEvaluate(stream EvaluateRequest) returns (stream EvaluateResponse);
}

message EvaluateRequest {
    string path = 1;           // ç­–ç•¥è·¯å¾„
    bytes input = 2;           // JSONç¼–ç çš„è¾“å…¥
    bool unknowns = 3;         // æ˜¯å¦éƒ¨åˆ†æ±‚å€¼
    bool explain = 4;          // æ˜¯å¦è¿”å›è§£é‡Š
    bool metrics = 5;          // æ˜¯å¦è¿”å›æŒ‡æ ‡
}

message EvaluateResponse {
    string decision_id = 1;    // å†³ç­–ID
    bytes result = 2;          // JSONç¼–ç çš„ç»“æœ
    bytes provenance = 3;      // æ¥æºä¿¡æ¯
    repeated string warnings = 4;  // è­¦å‘Š
    bytes metrics = 5;         // æ€§èƒ½æŒ‡æ ‡
}
```

### 3.2 å¯ç”¨gRPC

```bash
opa run --server --addr :8181 --grpc-addr :9000
```

### 3.3 å®¢æˆ·ç«¯ç¤ºä¾‹

**Goå®¢æˆ·ç«¯**:

```go
import (
    "context"
    pb "github.com/open-policy-agent/opa/grpc"
    "google.golang.org/grpc"
)

func main() {
    conn, _ := grpc.Dial("localhost:9000", grpc.WithInsecure())
    defer conn.Close()
    
    client := pb.NewOPAClient(conn)
    
    resp, err := client.Evaluate(context.Background(), &pb.EvaluateRequest{
        Path:  "example/allow",
        Input: []byte(`{"user": "alice"}`),
    })
    
    // å¤„ç†å“åº”
}
```

---

## 4. è®¤è¯ä¸æˆæƒ

### 4.1 TLSé…ç½®

```bash
opa run --server \
    --tls-cert-file server-cert.pem \
    --tls-private-key-file server-key.pem \
    --tls-ca-cert-file ca-cert.pem
```

### 4.2 Tokenè®¤è¯

**è¯·æ±‚å¤´**:

```http
Authorization: Bearer <token>
```

**é…ç½®**:

```yaml
# config.yaml
services:
  - name: my-service
    url: https://bundle-server.com
    credentials:
      bearer:
        token: "secret-token"
```

### 4.3 mTLS

**åŒå‘TLSè®¤è¯**:

```bash
opa run --server \
    --tls-cert-file server-cert.pem \
    --tls-private-key-file server-key.pem \
    --tls-ca-cert-file ca-cert.pem \
    --authentication=tls
```

---

## 5. é”™è¯¯å¤„ç†

### 5.1 HTTPçŠ¶æ€ç 

| çŠ¶æ€ç  | å«ä¹‰ | åœºæ™¯ |
|--------|------|------|
| `200` | æˆåŠŸ | æŸ¥è¯¢æˆåŠŸ |
| `204` | æ— å†…å®¹ | åˆ é™¤æˆåŠŸ |
| `400` | é”™è¯¯è¯·æ±‚ | JSONæ ¼å¼é”™è¯¯ã€è¯­æ³•é”™è¯¯ |
| `404` | æœªæ‰¾åˆ° | ç­–ç•¥/æ•°æ®ä¸å­˜åœ¨ |
| `500` | æœåŠ¡å™¨é”™è¯¯ | å†…éƒ¨é”™è¯¯ã€panic |
| `503` | æœåŠ¡ä¸å¯ç”¨ | BundleæœªåŠ è½½ |

### 5.2 é”™è¯¯å“åº”æ ¼å¼

```json
{
    "code": "invalid_parameter",
    "message": "invalid input document: parse error at line 5",
    "errors": [
        {
            "code": "rego_parse_error",
            "message": "unexpected token 'if'",
            "location": {"file": "policy.rego", "row": 5, "col": 10}
        }
    ]
}
```

### 5.3 é”™è¯¯ä»£ç 

| ä»£ç  | è¯´æ˜ |
|------|------|
| `invalid_parameter` | å‚æ•°æ— æ•ˆ |
| `rego_parse_error` | Regoè¯­æ³•é”™è¯¯ |
| `rego_type_error` | ç±»å‹é”™è¯¯ |
| `rego_unsafe_var_error` | ä¸å®‰å…¨å˜é‡ |
| `internal_error` | å†…éƒ¨é”™è¯¯ |

---

## 6. æ€§èƒ½è€ƒè™‘

### 6.1 ç¼“å­˜

**å“åº”å¤´**:

```http
Cache-Control: max-age=300
ETag: "abc123"
```

**æ¡ä»¶è¯·æ±‚**:

```http
If-None-Match: "abc123"
```

### 6.2 å‹ç¼©

**è¯·æ±‚å¤´**:

```http
Accept-Encoding: gzip, deflate
```

**å“åº”å¤´**:

```http
Content-Encoding: gzip
```

### 6.3 è¿æ¥å¤ç”¨

**HTTP/2**:

- å¤šè·¯å¤ç”¨
- å¤´éƒ¨å‹ç¼©
- æœåŠ¡å™¨æ¨é€

**Keep-Alive**:

```http
Connection: keep-alive
Keep-Alive: timeout=5, max=100
```

### 6.4 æ‰¹é‡ä¼˜åŒ–

```json
{
    "inputs": [/* 100ä¸ªè¾“å…¥ */]
}
```

**æ€§èƒ½**:

- å•æ¬¡æŸ¥è¯¢: 1ms Ã— 100 = 100ms
- æ‰¹é‡æŸ¥è¯¢: 10msï¼ˆæ‰¹å¤„ç†å¼€é”€ï¼‰

---

## é™„å½• A: OpenAPIè§„èŒƒ

å®Œæ•´OpenAPI 3.0è§„èŒƒ: <https://www.openpolicyagent.org/docs/latest/rest-api/>

**ç¤ºä¾‹ç‰‡æ®µ**:

```yaml
openapi: 3.0.3
info:
  title: OPA REST API
  version: v1
paths:
  /v1/data/{path}:
    post:
      summary: Query Policy
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
```

---

## é™„å½• B: æ€§èƒ½åŸºå‡†

### å»¶è¿Ÿï¼ˆLatencyï¼‰

| æ“ä½œ | p50 | p99 | p99.9 |
|------|-----|-----|-------|
| ç®€å•æŸ¥è¯¢ | 0.5ms | 2ms | 10ms |
| å¤æ‚æŸ¥è¯¢ | 5ms | 20ms | 50ms |
| BundleåŠ è½½ | 100ms | 500ms | 2s |

### ååé‡ï¼ˆThroughputï¼‰

- **å•æ ¸**: 100K å†³ç­–/ç§’ï¼ˆç®€å•è§„åˆ™ï¼‰
- **4æ ¸**: 300K å†³ç­–/ç§’
- **æ‰¹é‡**: 500K å†³ç­–/ç§’

---

**ä¸‹ä¸€ç¯‡**: [01.2-Bundleæ ¼å¼è§„èŒƒ](./01.2-Bundleæ ¼å¼è§„èŒƒ.md)  
**ç›¸å…³**: [08.5-ç›‘æ§ä¸è°ƒè¯•](../08-æœ€ä½³å®è·µ/08.5-ç›‘æ§ä¸è°ƒè¯•.md)
