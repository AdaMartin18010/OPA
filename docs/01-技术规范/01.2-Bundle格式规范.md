# Bundle æ ¼å¼è§„èŒƒï¼ˆBundle Format Specificationï¼‰

> **æ›´æ–°æ—¥æœŸ**: 2025å¹´10æœˆ20æ—¥  
> **è§„èŒƒç‰ˆæœ¬**: Bundle Format v1  
> **å‹ç¼©æ ¼å¼**: tar.gz + signature  
> **å‚è€ƒ**: <https://www.openpolicyagent.org/docs/latest/management-bundles/>

---

## ç›®å½•

- [Bundle æ ¼å¼è§„èŒƒï¼ˆBundle Format Specificationï¼‰](#bundle-æ ¼å¼è§„èŒƒbundle-format-specification)
  - [ç›®å½•](#ç›®å½•)
  - [1. Bundleæ¦‚è¿°](#1-bundleæ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯Bundle](#11-ä»€ä¹ˆæ˜¯bundle)
    - [1.2 ä¸ºä»€ä¹ˆéœ€è¦Bundle](#12-ä¸ºä»€ä¹ˆéœ€è¦bundle)
    - [1.3 Bundleç”Ÿå‘½å‘¨æœŸ](#13-bundleç”Ÿå‘½å‘¨æœŸ)
  - [2. Bundleæ–‡ä»¶ç»“æ„](#2-bundleæ–‡ä»¶ç»“æ„)
    - [2.1 ç›®å½•ç»“æ„](#21-ç›®å½•ç»“æ„)
    - [2.2 manifest.json](#22-manifestjson)
    - [2.3 ç­–ç•¥æ–‡ä»¶ç»„ç»‡](#23-ç­–ç•¥æ–‡ä»¶ç»„ç»‡)
    - [2.4 æ•°æ®æ–‡ä»¶ç»„ç»‡](#24-æ•°æ®æ–‡ä»¶ç»„ç»‡)
  - [3. Bundle Manifestè¯¦è§£](#3-bundle-manifestè¯¦è§£)
    - [3.1 å¿…éœ€å­—æ®µ](#31-å¿…éœ€å­—æ®µ)
    - [3.2 å¯é€‰å­—æ®µ](#32-å¯é€‰å­—æ®µ)
    - [3.3 Revisionå­—æ®µ](#33-revisionå­—æ®µ)
    - [3.4 Rootså­—æ®µ](#34-rootså­—æ®µ)
    - [3.5 Metadataå­—æ®µ](#35-metadataå­—æ®µ)
  - [4. Bundleç­¾åæœºåˆ¶](#4-bundleç­¾åæœºåˆ¶)
    - [4.1 ç­¾åæ–‡ä»¶ç»“æ„](#41-ç­¾åæ–‡ä»¶ç»“æ„)
    - [4.2 ç­¾åç®—æ³•](#42-ç­¾åç®—æ³•)
    - [4.3 éªŒè¯æµç¨‹](#43-éªŒè¯æµç¨‹)
    - [4.4 å¯†é’¥ç®¡ç†](#44-å¯†é’¥ç®¡ç†)
  - [5. Bundleåˆ†å‘æœºåˆ¶](#5-bundleåˆ†å‘æœºåˆ¶)
    - [5.1 HTTP(S) Bundle Server](#51-https-bundle-server)
    - [5.2 å¯¹è±¡å­˜å‚¨ï¼ˆS3/GCS/Azure Blobï¼‰](#52-å¯¹è±¡å­˜å‚¨s3gcsazure-blob)
    - [5.3 OCI Registry](#53-oci-registry)
    - [5.4 è½®è¯¢ä¸å¢é‡æ›´æ–°](#54-è½®è¯¢ä¸å¢é‡æ›´æ–°)
  - [6. Bundleæ„å»ºå®è·µ](#6-bundleæ„å»ºå®è·µ)
    - [6.1 ä½¿ç”¨OPA CLIæ„å»º](#61-ä½¿ç”¨opa-cliæ„å»º)
    - [6.2 ä½¿ç”¨æ„å»ºå·¥å…·é“¾](#62-ä½¿ç”¨æ„å»ºå·¥å…·é“¾)
    - [6.3 CI/CDé›†æˆ](#63-cicdé›†æˆ)
    - [6.4 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥](#64-ç‰ˆæœ¬ç®¡ç†ç­–ç•¥)
  - [7. Delta Bundlesï¼ˆå¢é‡Bundleï¼‰](#7-delta-bundleså¢é‡bundle)
    - [7.1 Delta Bundleæ ¼å¼](#71-delta-bundleæ ¼å¼)
    - [7.2 å¢é‡æ›´æ–°ç®—æ³•](#72-å¢é‡æ›´æ–°ç®—æ³•)
    - [7.3 æ€§èƒ½ä¼˜åŒ–](#73-æ€§èƒ½ä¼˜åŒ–)
  - [8. Bundleæ€§èƒ½è€ƒè™‘](#8-bundleæ€§èƒ½è€ƒè™‘)
    - [8.1 Bundleå¤§å°ä¼˜åŒ–](#81-bundleå¤§å°ä¼˜åŒ–)
    - [8.2 åŠ è½½æ€§èƒ½](#82-åŠ è½½æ€§èƒ½)
    - [8.3 å†…å­˜å ç”¨](#83-å†…å­˜å ç”¨)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 Bundleç»„ç»‡åŸåˆ™](#91-bundleç»„ç»‡åŸåˆ™)
    - [9.2 å®‰å…¨å»ºè®®](#92-å®‰å…¨å»ºè®®)
    - [9.3 è¿ç»´å»ºè®®](#93-è¿ç»´å»ºè®®)
  - [é™„å½•Aï¼šBundleæ ¼å¼å®Œæ•´ç¤ºä¾‹](#é™„å½•abundleæ ¼å¼å®Œæ•´ç¤ºä¾‹)
  - [é™„å½•Bï¼šBundle APIç«¯ç‚¹](#é™„å½•bbundle-apiç«¯ç‚¹)

---

## 1. Bundleæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯Bundle

**å®šä¹‰**ï¼šBundleæ˜¯OPAç­–ç•¥å’Œæ•°æ®çš„æ‰“åŒ…åˆ†å‘å•å…ƒï¼Œä½¿ç”¨tar.gzæ ¼å¼å‹ç¼©ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- ğŸ“¦ **åŸå­æ€§**: ç­–ç•¥+æ•°æ®ä½œä¸ºå•ä¸€å•å…ƒéƒ¨ç½²
- ğŸ” **ç­¾åéªŒè¯**: æ”¯æŒJWTç­¾åä¿è¯å®Œæ•´æ€§
- ğŸ”„ **ç‰ˆæœ¬åŒ–**: é€šè¿‡revisionè¿½è¸ªå˜æ›´
- ğŸŒ **å¯åˆ†å‘**: æ”¯æŒHTTP/S3/OCIå¤šç§åˆ†å‘æ–¹å¼

**Bundleç»“æ„**ï¼š

```text
bundle.tar.gz
â”œâ”€â”€ .manifest                  # Bundleå…ƒæ•°æ®
â”œâ”€â”€ policy/                    # ç­–ç•¥æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ authz.rego
â”‚   â””â”€â”€ rbac.rego
â””â”€â”€ data/                      # æ•°æ®æ–‡ä»¶ç›®å½•
    â””â”€â”€ roles.json
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Bundle

**é—®é¢˜åœºæ™¯**ï¼š

1. âŒ **ç­–ç•¥ç¢ç‰‡åŒ–**: ç­–ç•¥åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ï¼Œéš¾ä»¥ç»Ÿä¸€ç®¡ç†
2. âŒ **ç‰ˆæœ¬ä¸ä¸€è‡´**: ç­–ç•¥ä¸æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´é”™è¯¯
3. âŒ **åˆ†å‘å›°éš¾**: ç¼ºä¹æ ‡å‡†åŒ–çš„åˆ†å‘æœºåˆ¶
4. âŒ **å®‰å…¨é£é™©**: æ— æ³•éªŒè¯ç­–ç•¥æ¥æºå’Œå®Œæ•´æ€§

**Bundleè§£å†³æ–¹æ¡ˆ**ï¼š

```text
ä¼ ç»Ÿæ–¹å¼:
  ç­–ç•¥æ–‡ä»¶1 â”€â”€â”
  ç­–ç•¥æ–‡ä»¶2 â”€â”€â”¼â”€â”€> æ‰‹åŠ¨åŒæ­¥ â”€â”€> å¤šä¸ªOPAå®ä¾‹
  æ•°æ®æ–‡ä»¶  â”€â”€â”˜                 (ç‰ˆæœ¬ä¸ä¸€è‡´)

Bundleæ–¹å¼:
  [ç­–ç•¥+æ•°æ®+Manifest] â”€â”€> Bundle Server â”€â”€> è‡ªåŠ¨åˆ†å‘ â”€â”€> æ‰€æœ‰OPAå®ä¾‹
                         (ç­¾åéªŒè¯)      (ç‰ˆæœ¬ä¸€è‡´)
```

### 1.3 Bundleç”Ÿå‘½å‘¨æœŸ

```text
1. æ„å»ºé˜¶æ®µ
   â”œâ”€â”€ ç¼–å†™ç­–ç•¥(.rego)
   â”œâ”€â”€ å‡†å¤‡æ•°æ®(.json/.yaml)
   â”œâ”€â”€ ç”Ÿæˆmanifest
   â””â”€â”€ æ‰“åŒ…ç­¾å

2. å‘å¸ƒé˜¶æ®µ
   â”œâ”€â”€ ä¸Šä¼ åˆ°Bundle Server
   â”œâ”€â”€ æ›´æ–°ç‰ˆæœ¬æ ‡ç­¾
   â””â”€â”€ è§¦å‘é€šçŸ¥(å¯é€‰)

3. åˆ†å‘é˜¶æ®µ
   â”œâ”€â”€ OPAè½®è¯¢æ£€æŸ¥æ›´æ–°
   â”œâ”€â”€ ä¸‹è½½æ–°Bundle
   â””â”€â”€ éªŒè¯ç­¾å

4. æ¿€æ´»é˜¶æ®µ
   â”œâ”€â”€ è§£å‹Bundle
   â”œâ”€â”€ ç¼–è¯‘ç­–ç•¥
   â”œâ”€â”€ åŠ è½½æ•°æ®
   â””â”€â”€ åŸå­æ€§åˆ‡æ¢
```

---

## 2. Bundleæ–‡ä»¶ç»“æ„

### 2.1 ç›®å½•ç»“æ„

**æ ‡å‡†Bundleå¸ƒå±€**ï¼š

```text
my-bundle/
â”œâ”€â”€ .manifest                           # å¿…éœ€ï¼šBundleå…ƒæ•°æ®
â”œâ”€â”€ .signatures.json                    # å¯é€‰ï¼šç­¾åæ–‡ä»¶
â”œâ”€â”€ policy/                             # ç­–ç•¥æ ¹ç›®å½•
â”‚   â”œâ”€â”€ authz/
â”‚   â”‚   â”œâ”€â”€ api.rego                   # APIæˆæƒç­–ç•¥
â”‚   â”‚   â””â”€â”€ rbac.rego                  # RBACç­–ç•¥
â”‚   â””â”€â”€ validation/
â”‚       â””â”€â”€ schema.rego                 # æ•°æ®éªŒè¯ç­–ç•¥
â””â”€â”€ data/                               # æ•°æ®æ ¹ç›®å½•
    â”œâ”€â”€ users.json                      # ç”¨æˆ·æ•°æ®
    â””â”€â”€ roles/
        â””â”€â”€ definitions.yaml            # è§’è‰²å®šä¹‰
```

**è·¯å¾„æ˜ å°„**ï¼š

```text
Bundleå†…è·¯å¾„              OPAå†…éƒ¨è·¯å¾„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
policy/authz/api.rego    data.authz.api
data/users.json          data.users
```

### 2.2 manifest.json

**åŸºæœ¬ç»“æ„**ï¼š

```json
{
  "revision": "v1.2.3",
  "roots": ["authz", "validation"],
  "metadata": {
    "description": "Production authorization policies",
    "authors": ["security-team@example.com"],
    "created": "2025-10-20T10:00:00Z"
  },
  "rego_version": 1,
  "wasm": [
    {
      "entrypoint": "authz/allow",
      "module": "policy.wasm"
    }
  ]
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | å¿…éœ€ | ç±»å‹ | è¯´æ˜ |
|------|------|------|------|
| `revision` | âœ… | string | Bundleç‰ˆæœ¬æ ‡è¯† |
| `roots` | âŒ | []string | ç­–ç•¥å‘½åç©ºé—´æ ¹ |
| `metadata` | âŒ | object | è‡ªå®šä¹‰å…ƒæ•°æ® |
| `rego_version` | âŒ | int | Regoè¯­æ³•ç‰ˆæœ¬(é»˜è®¤0) |
| `wasm` | âŒ | []object | WASMæ¨¡å—é…ç½® |

### 2.3 ç­–ç•¥æ–‡ä»¶ç»„ç»‡

**æ¨èç»„ç»‡æ–¹å¼**ï¼š

```text
policy/
â”œâ”€â”€ core/                    # æ ¸å¿ƒç­–ç•¥ï¼ˆå…¨å±€ï¼‰
â”‚   â”œâ”€â”€ defaults.rego       # é»˜è®¤è§„åˆ™
â”‚   â””â”€â”€ helpers.rego        # è¾…åŠ©å‡½æ•°
â”œâ”€â”€ domains/                 # é¢†åŸŸç­–ç•¥
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ authz.rego
â”‚   â”‚   â””â”€â”€ ratelimit.rego
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ validation.rego
â””â”€â”€ tests/                   # æµ‹è¯•æ–‡ä»¶
    â””â”€â”€ authz_test.rego
```

**å‘½åçº¦å®š**ï¼š

```text
âœ… å¥½çš„å‘½å:
   - user_management.rego       # æ¸…æ™°çš„åŠŸèƒ½æè¿°
   - rbac_rules.rego            # æ ‡å‡†ç¼©å†™
   - api_v2_authz.rego          # åŒ…å«ç‰ˆæœ¬

âŒ é¿å…:
   - policy.rego                # è¿‡äºå®½æ³›
   - temp.rego                  # ä¸´æ—¶æ–‡ä»¶
   - è§„åˆ™.rego                  # éASCIIå­—ç¬¦
```

### 2.4 æ•°æ®æ–‡ä»¶ç»„ç»‡

**æ”¯æŒæ ¼å¼**ï¼š

- âœ… JSON (`.json`)
- âœ… YAML (`.yaml`, `.yml`)

**ç¤ºä¾‹ç»“æ„**ï¼š

```text
data/
â”œâ”€â”€ static/                  # é™æ€é…ç½®
â”‚   â”œâ”€â”€ regions.json
â”‚   â””â”€â”€ service_tiers.yaml
â”œâ”€â”€ external/                # å¤–éƒ¨æ•°æ®
â”‚   â””â”€â”€ user_groups.json
â””â”€â”€ generated/               # è‡ªåŠ¨ç”Ÿæˆ
    â””â”€â”€ metrics.json
```

**data/static/regions.json**ï¼š

```json
{
  "regions": [
    {
      "id": "us-east-1",
      "name": "US East (N. Virginia)",
      "compliance": ["SOC2", "HIPAA"]
    },
    {
      "id": "eu-west-1",
      "name": "Europe (Ireland)",
      "compliance": ["GDPR", "SOC2"]
    }
  ]
}
```

---

## 3. Bundle Manifestè¯¦è§£

### 3.1 å¿…éœ€å­—æ®µ

**revisionï¼ˆç‰ˆæœ¬æ ‡è¯†ï¼‰**ï¼š

```json
{
  "revision": "abc123def456"
}
```

**ç‰¹æ€§**ï¼š

- ğŸ”¢ æ¨èæ ¼å¼: è¯­ä¹‰ç‰ˆæœ¬(`v1.2.3`) æˆ– Git SHA
- ğŸ”„ ç”¨äºæ£€æµ‹Bundleæ›´æ–°
- ğŸ“Š å¯åœ¨ç›‘æ§ä¸­è¿½è¸ªéƒ¨ç½²ç‰ˆæœ¬

### 3.2 å¯é€‰å­—æ®µ

**å®Œæ•´ç¤ºä¾‹**ï¼š

```json
{
  "revision": "v2.1.0",
  "roots": ["authz", "validation", "audit"],
  "metadata": {
    "description": "Q4 2025 Authorization Policies",
    "authors": ["security@example.com"],
    "created": "2025-10-20T15:30:00Z",
    "source": "https://github.com/example/policies",
    "build": {
      "ci_job": "jenkins-build-1234",
      "commit": "a1b2c3d4"
    }
  },
  "rego_version": 1,
  "wasm": [
    {
      "entrypoint": "authz/allow",
      "module": "policy/authz.wasm"
    }
  ]
}
```

### 3.3 Revisionå­—æ®µ

**ç‰ˆæœ¬ç­–ç•¥**ï¼š

```text
1. è¯­ä¹‰ç‰ˆæœ¬ï¼ˆæ¨èï¼‰:
   v1.0.0 â†’ v1.0.1 â†’ v1.1.0 â†’ v2.0.0
   MAJOR.MINOR.PATCH

2. Git SHAï¼ˆCI/CDå‹å¥½ï¼‰:
   a1b2c3d â†’ e4f5g6h â†’ i7j8k9l

3. æ—¶é—´æˆ³:
   20251020-150000 â†’ 20251020-160000

4. è‡ªå®šä¹‰æ ‡ç­¾:
   prod-20251020 â†’ prod-20251021
```

**æ£€æµ‹æ›´æ–°é€»è¾‘**ï¼š

```rego
package bundle

import rego.v1

# å½“å‰Bundleç‰ˆæœ¬
current_revision := opa.runtime().config.bundle.revision

# æ£€æŸ¥æ˜¯å¦ä¸ºæ–°ç‰ˆæœ¬
is_new_version(new_revision) if {
    new_revision != current_revision
}
```

### 3.4 Rootså­—æ®µ

**ä½œç”¨**ï¼šå®šä¹‰Bundleç®¡ç†çš„ç­–ç•¥å‘½åç©ºé—´æ ¹ã€‚

**ç¤ºä¾‹**ï¼š

```json
{
  "roots": ["authz", "validation"]
}
```

**æ•ˆæœ**ï¼š

```text
Bundleæ¿€æ´»æ—¶ï¼š
  1. æ¸…é™¤ data.authz.* ä¸‹æ‰€æœ‰æ—§ç­–ç•¥
  2. æ¸…é™¤ data.validation.* ä¸‹æ‰€æœ‰æ—§ç­–ç•¥
  3. åŠ è½½Bundleä¸­çš„æ–°ç­–ç•¥

æœªåˆ—åœ¨rootsä¸­çš„å‘½åç©ºé—´ä¸å—å½±å“
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```text
åœºæ™¯1: å•ä¸€Bundleç®¡ç†æ‰€æœ‰ç­–ç•¥
  roots: []               # ç©ºæ•°ç»„ = ç®¡ç†æ•´ä¸ªå‘½åç©ºé—´

åœºæ™¯2: å¤šBundleåˆ†ç¦»ç®¡ç†
  Bundle A: roots: ["authz"]
  Bundle B: roots: ["audit"]
  â†’ ä¸¤ä¸ªBundleç‹¬ç«‹æ›´æ–°ï¼Œäº’ä¸å½±å“
```

### 3.5 Metadataå­—æ®µ

**æ ‡å‡†å­—æ®µå»ºè®®**ï¼š

```json
{
  "metadata": {
    "description": "Bundleç”¨é€”æè¿°",
    "authors": ["ç»´æŠ¤è€…é‚®ç®±"],
    "created": "ISO 8601æ—¶é—´æˆ³",
    "source": "æºä»£ç ä»“åº“URL",
    "environment": "prod|staging|dev",
    "compliance": ["SOC2", "GDPR"],
    "version_notes": "æœ¬ç‰ˆæœ¬å˜æ›´è¯´æ˜"
  }
}
```

**è‡ªå®šä¹‰å­—æ®µ**ï¼š

```json
{
  "metadata": {
    "team": "platform-security",
    "cost_center": "CC-1234",
    "approval_ticket": "JIRA-5678",
    "rollback_plan": "https://runbook.example.com/bundle-rollback"
  }
}
```

---

## 4. Bundleç­¾åæœºåˆ¶

### 4.1 ç­¾åæ–‡ä»¶ç»“æ„

**.signatures.json**ï¼š

```json
{
  "signatures": [
    {
      "keyid": "key1",
      "signature": "eyJhbGciOiJSUzI1NiIsIn...",
      "scope": "write"
    }
  ]
}
```

**å®Œæ•´ç­¾åç¤ºä¾‹**ï¼š

```json
{
  "signatures": [
    {
      "keyid": "production-key-2025",
      "signature": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
      "scope": "write",
      "claims": {
        "iss": "security-team@example.com",
        "sub": "bundle-v2.1.0",
        "iat": 1729425000,
        "exp": 1760961000,
        "aud": ["opa-prod"]
      }
    }
  ]
}
```

### 4.2 ç­¾åç®—æ³•

**æ”¯æŒç®—æ³•**ï¼ˆJWTæ ‡å‡†ï¼‰ï¼š

- âœ… **RS256**: RSA + SHA-256ï¼ˆæ¨èï¼‰
- âœ… **RS384**: RSA + SHA-384
- âœ… **RS512**: RSA + SHA-512
- âœ… **ES256**: ECDSA + SHA-256
- âœ… **ES384**: ECDSA + SHA-384
- âœ… **ES512**: ECDSA + SHA-512

**ç­¾åè´Ÿè½½**ï¼š

```json
{
  "files": [
    {
      "name": ".manifest",
      "hash": "sha256:a1b2c3...",
      "algorithm": "SHA-256"
    },
    {
      "name": "policy/authz.rego",
      "hash": "sha256:d4e5f6...",
      "algorithm": "SHA-256"
    }
  ]
}
```

### 4.3 éªŒè¯æµç¨‹

**OPAéªŒè¯æ­¥éª¤**ï¼š

```text
1. ä¸‹è½½Bundle
   â†“
2. è§£å‹åˆ°ä¸´æ—¶ç›®å½•
   â†“
3. è¯»å–.signatures.json
   â†“
4. éªŒè¯JWTç­¾å
   â”œâ”€â”€ æ£€æŸ¥ç­¾åç®—æ³•
   â”œâ”€â”€ éªŒè¯å…¬é’¥
   â””â”€â”€ æ£€æŸ¥claimsï¼ˆiss, exp, audï¼‰
   â†“
5. éªŒè¯æ–‡ä»¶å“ˆå¸Œ
   â”œâ”€â”€ è®¡ç®—æ¯ä¸ªæ–‡ä»¶çš„SHA-256
   â””â”€â”€ ä¸ç­¾åä¸­çš„å“ˆå¸Œå¯¹æ¯”
   â†“
6. éªŒè¯é€šè¿‡ â†’ æ¿€æ´»Bundle
   éªŒè¯å¤±è´¥ â†’ æ‹’ç»åŠ è½½
```

**OPAé…ç½®**ï¼š

```yaml
bundles:
  authz:
    service: bundleServer
    resource: bundles/prod/authz.tar.gz
    signing:
      keyid: production-key-2025
      scope: write
```

### 4.4 å¯†é’¥ç®¡ç†

**å…¬é’¥é…ç½®**ï¼š

```yaml
keys:
  production-key-2025:
    algorithm: RS256
    key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
      -----END PUBLIC KEY-----
    scope: write
```

**å¯†é’¥è½®æ¢ç­–ç•¥**ï¼š

```text
1. ç”Ÿæˆæ–°å¯†é’¥å¯¹
   â””â”€â”€ openssl genrsa -out new_private.pem 4096

2. åˆ†å‘æ–°å…¬é’¥åˆ°æ‰€æœ‰OPAå®ä¾‹
   â””â”€â”€ æ›´æ–°ConfigMap/Secret

3. ä½¿ç”¨æ–°ç§é’¥ç­¾åBundle
   â””â”€â”€ opa sign --signing-key new_private.pem

4. å®½é™æœŸï¼ˆä¸¤ä¸ªå¯†é’¥å¹¶å­˜ï¼‰
   â””â”€â”€ 30å¤©

5. ç§»é™¤æ—§å¯†é’¥
```

---

## 5. Bundleåˆ†å‘æœºåˆ¶

### 5.1 HTTP(S) Bundle Server

**æ ‡å‡†ç«¯ç‚¹**ï¼š

```text
GET /bundles/<name>.tar.gz
Response:
  200 OK
  Content-Type: application/gzip
  Body: [bundle tar.gz content]
```

**å¸¦ETagçš„å¢é‡æ›´æ–°**ï¼š

```http
Request:
  GET /bundles/authz.tar.gz
  If-None-Match: "abc123"

Response (æœªæ›´æ–°):
  304 Not Modified

Response (å·²æ›´æ–°):
  200 OK
  ETag: "def456"
  Body: [new bundle]
```

**OPAé…ç½®**ï¼š

```yaml
services:
  bundleServer:
    url: https://bundles.example.com
    credentials:
      bearer:
        token: ${BUNDLE_TOKEN}

bundles:
  authz:
    service: bundleServer
    resource: bundles/prod/authz.tar.gz
    polling:
      min_delay_seconds: 60
      max_delay_seconds: 120
```

### 5.2 å¯¹è±¡å­˜å‚¨ï¼ˆS3/GCS/Azure Blobï¼‰

**S3ç¤ºä¾‹**ï¼š

```yaml
services:
  s3:
    url: https://my-bucket.s3.amazonaws.com
    credentials:
      s3_signing:
        environment_credentials: {}

bundles:
  authz:
    service: s3
    resource: policies/prod/bundle.tar.gz
```

**è®¿é—®æƒé™ï¼ˆAWS IAM Policyï¼‰**ï¼š

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:GetObject"],
      "Resource": "arn:aws:s3:::my-bucket/policies/*"
    }
  ]
}
```

**GCSç¤ºä¾‹**ï¼š

```yaml
services:
  gcs:
    url: https://storage.googleapis.com/my-bucket
    credentials:
      gcp_metadata: {}

bundles:
  authz:
    service: gcs
    resource: policies/prod/bundle.tar.gz
```

### 5.3 OCI Registry

**OCIæ ¼å¼Bundle**ï¼ˆ2024+æ–°ç‰¹æ€§ï¼‰ï¼š

```bash
# æ¨é€Bundleåˆ°OCI Registry
opa build -b policy/ -o bundle.tar.gz
oras push registry.example.com/policies/authz:v1.0.0 bundle.tar.gz

# OPAé…ç½®
services:
  oci:
    url: https://registry.example.com
    type: oci
    credentials:
      bearer:
        token: ${REGISTRY_TOKEN}

bundles:
  authz:
    service: oci
    resource: policies/authz:v1.0.0
```

### 5.4 è½®è¯¢ä¸å¢é‡æ›´æ–°

**è½®è¯¢ç­–ç•¥**ï¼š

```yaml
bundles:
  authz:
    polling:
      min_delay_seconds: 60        # æœ€å°è½®è¯¢é—´éš”
      max_delay_seconds: 120       # æœ€å¤§è½®è¯¢é—´éš”ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
      long_polling_timeout_seconds: 0  # 0=ç¦ç”¨é•¿è½®è¯¢
```

**è½®è¯¢è¡Œä¸º**ï¼š

```text
1. åˆå§‹è¯·æ±‚: 60ç§’å
2. æˆåŠŸä¸‹è½½: é‡ç½®ä¸º60ç§’
3. 404é”™è¯¯: æŒ‡æ•°é€€é¿åˆ°120ç§’
4. ç½‘ç»œé”™è¯¯: æŒ‡æ•°é€€é¿åˆ°120ç§’
5. æ¢å¤æ­£å¸¸: é‡ç½®ä¸º60ç§’
```

---

## 6. Bundleæ„å»ºå®è·µ

### 6.1 ä½¿ç”¨OPA CLIæ„å»º

**åŸºæœ¬å‘½ä»¤**ï¼š

```bash
# æ„å»ºBundle
opa build -b policy/ -o bundle.tar.gz

# æŒ‡å®šæ•°æ®ç›®å½•
opa build -b policy/ data/ -o bundle.tar.gz

# ç”Ÿæˆmanifest
opa build policy/ \
  --bundle \
  --revision "v1.0.0" \
  --output bundle.tar.gz
```

**é«˜çº§é€‰é¡¹**ï¼š

```bash
# ä¼˜åŒ–ç­–ç•¥ï¼ˆç§»é™¤æ³¨é‡Šã€æ ¼å¼åŒ–ï¼‰
opa build -b policy/ -o bundle.tar.gz \
  --optimize=1

# åŒ…å«WASMæ¨¡å—
opa build -t wasm -e authz/allow policy/ -o policy.wasm
opa build -b policy/ policy.wasm -o bundle.tar.gz

# æ’é™¤æµ‹è¯•æ–‡ä»¶
opa build -b policy/ -o bundle.tar.gz \
  --exclude-files-verify '*_test.rego'

# éªŒè¯ç­–ç•¥è¯­æ³•
opa build -b policy/ -o bundle.tar.gz \
  --verify
```

### 6.2 ä½¿ç”¨æ„å»ºå·¥å…·é“¾

**Makefileç¤ºä¾‹**ï¼š

```makefile
VERSION ?= $(shell git rev-parse --short HEAD)
BUNDLE_NAME = authz-bundle

.PHONY: build
build:
 opa build \
  --bundle \
  --revision "$(VERSION)" \
  --output $(BUNDLE_NAME).tar.gz \
  policy/

.PHONY: sign
sign: build
 opa sign \
  --signing-key private_key.pem \
  --bundle $(BUNDLE_NAME).tar.gz \
  --output-file-path .signatures.json

.PHONY: publish
publish: sign
 aws s3 cp $(BUNDLE_NAME).tar.gz \
  s3://my-bucket/bundles/$(BUNDLE_NAME)-$(VERSION).tar.gz

.PHONY: test
test:
 opa test policy/ -v
```

### 6.3 CI/CDé›†æˆ

**GitHub Actionsç¤ºä¾‹**ï¼š

```yaml
name: Build and Publish Bundle

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Test Policies
        run: opa test policy/ -v
      
      - name: Build Bundle
        run: |
          opa build -b policy/ data/ \
            --revision "${{ github.sha }}" \
            --output bundle.tar.gz
      
      - name: Sign Bundle
        env:
          SIGNING_KEY: ${{ secrets.BUNDLE_SIGNING_KEY }}
        run: |
          echo "$SIGNING_KEY" > private_key.pem
          opa sign --signing-key private_key.pem \
            --bundle bundle.tar.gz
      
      - name: Publish to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp bundle.tar.gz \
            s3://my-bundles/prod/bundle-${{ github.sha }}.tar.gz
```

### 6.4 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**ç‰ˆæœ¬å‘½å**ï¼š

```text
ç¯å¢ƒåˆ†ç¦»:
  bundles/
    â”œâ”€â”€ dev/bundle-latest.tar.gz
    â”œâ”€â”€ staging/bundle-v1.2.3-rc1.tar.gz
    â””â”€â”€ prod/bundle-v1.2.3.tar.gz

å¤šç§Ÿæˆ·:
  bundles/
    â”œâ”€â”€ tenant-a/bundle-v1.0.0.tar.gz
    â””â”€â”€ tenant-b/bundle-v2.0.0.tar.gz

ç‰¹æ€§åˆ†æ”¯:
  bundles/
    â”œâ”€â”€ main/bundle-abc123.tar.gz
    â””â”€â”€ feature-rbac-v2/bundle-def456.tar.gz
```

---

## 7. Delta Bundlesï¼ˆå¢é‡Bundleï¼‰

### 7.1 Delta Bundleæ ¼å¼

**Delta Manifest**ï¼š

```json
{
  "revision": "v1.0.1",
  "parent_revision": "v1.0.0",
  "delta": true,
  "patch": [
    {
      "op": "upsert",
      "path": "policy/authz/new_rule.rego",
      "value": "<base64-encoded-content>"
    },
    {
      "op": "remove",
      "path": "policy/deprecated.rego"
    }
  ]
}
```

**æ“ä½œç±»å‹**ï¼š

- `upsert`: æ·»åŠ æˆ–æ›´æ–°æ–‡ä»¶
- `remove`: åˆ é™¤æ–‡ä»¶
- `replace`: æ›¿æ¢æ•´ä¸ªè·¯å¾„

### 7.2 å¢é‡æ›´æ–°ç®—æ³•

**åº”ç”¨Deltaæµç¨‹**ï¼š

```text
1. éªŒè¯parent_revisionåŒ¹é…
   â†“
2. æŒ‰é¡ºåºåº”ç”¨patchæ“ä½œ
   â”œâ”€â”€ upsert: è§£ç base64 â†’ å†™å…¥æ–‡ä»¶
   â”œâ”€â”€ remove: åˆ é™¤æ–‡ä»¶
   â””â”€â”€ replace: æ›¿æ¢ç›®å½•
   â†“
3. æ›´æ–°æœ¬åœ°revision
   â†“
4. é‡æ–°ç¼–è¯‘ç­–ç•¥
```

### 7.3 æ€§èƒ½ä¼˜åŒ–

**åœºæ™¯å¯¹æ¯”**ï¼š

```text
å…¨é‡Bundle:
  å¤§å°: 10MB
  ä¸‹è½½: 10s
  è§£å‹: 2s
  æ€»æ—¶é—´: 12s

Delta Bundle:
  å¤§å°: 100KB (1% of full)
  ä¸‹è½½: 0.1s
  åº”ç”¨patch: 0.5s
  æ€»æ—¶é—´: 0.6s

æ€§èƒ½æå‡: 20x
```

**é€‚ç”¨åœºæ™¯**ï¼š

- âœ… é¢‘ç¹æ›´æ–°ï¼ˆ<5åˆ†é’Ÿé—´éš”ï¼‰
- âœ… å¤§å‹Bundleï¼ˆ>100MBï¼‰
- âœ… å¸¦å®½å—é™ç¯å¢ƒ

---

## 8. Bundleæ€§èƒ½è€ƒè™‘

### 8.1 Bundleå¤§å°ä¼˜åŒ–

**ä¼˜åŒ–æŠ€æœ¯**ï¼š

```bash
# 1. ç§»é™¤æ³¨é‡Šå’Œæµ‹è¯•æ–‡ä»¶
opa build -b policy/ -o bundle.tar.gz \
  --exclude-files-verify '*_test.rego'

# 2. å¯ç”¨å‹ç¼©ä¼˜åŒ–
tar -czf bundle.tar.gz --options gzip:compression-level=9 bundle/

# 3. åˆ†ç¦»å¤§å‹æ•°æ®æ–‡ä»¶
#   ç­–ç•¥Bundle: 1MB
#   æ•°æ®Bundle: 100MBï¼ˆç‹¬ç«‹æ›´æ–°ï¼‰
```

**å¤§å°åŸºå‡†**ï¼š

```text
å°å‹Bundle: < 1MB      (åŠ è½½<100ms)
ä¸­å‹Bundle: 1-10MB     (åŠ è½½100ms-1s)
å¤§å‹Bundle: 10-100MB   (åŠ è½½1s-10s)
è¶…å¤§Bundle: > 100MB    (è€ƒè™‘æ‹†åˆ†)
```

### 8.2 åŠ è½½æ€§èƒ½

**åŠ è½½é˜¶æ®µ**ï¼š

```text
1. ä¸‹è½½: å–å†³äºç½‘ç»œå¸¦å®½
2. è§£å‹: CPUå¯†é›†å‹
3. è§£æ: ç­–ç•¥æ–‡ä»¶æ•°é‡
4. ç¼–è¯‘: è§„åˆ™å¤æ‚åº¦
5. ç´¢å¼•: è§„åˆ™æ€»æ•°
```

**ä¼˜åŒ–æªæ–½**ï¼š

```text
âœ… ä½¿ç”¨CDNåŠ é€Ÿä¸‹è½½
âœ… é¢„ç¼–è¯‘ä¸ºWASMï¼ˆè·³è¿‡ç¼–è¯‘é˜¶æ®µï¼‰
âœ… æ‹†åˆ†ä¸ºå¤šä¸ªå°Bundle
âœ… ä½¿ç”¨Deltaæ›´æ–°
```

### 8.3 å†…å­˜å ç”¨

**å†…å­˜è®¡ç®—**ï¼š

```text
æ€»å†…å­˜ = Bundleå¤§å° + ç¼–è¯‘åAST + è¿è¡Œæ—¶æ•°æ®

ç¤ºä¾‹:
  Bundle: 10MB
  AST:    30MB (3x)
  æ•°æ®:   50MB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»è®¡:   90MB
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 Bundleç»„ç»‡åŸåˆ™

**åŸåˆ™1: å•ä¸€èŒè´£**:

```text
âŒ é¿å…:
   bundles/everything.tar.gz  (100MB, åŒ…å«æ‰€æœ‰ç­–ç•¥)

âœ… æ¨è:
   bundles/authz.tar.gz       (1MB, æˆæƒç­–ç•¥)
   bundles/validation.tar.gz  (2MB, éªŒè¯ç­–ç•¥)
   bundles/audit.tar.gz       (500KB, å®¡è®¡ç­–ç•¥)
```

**åŸåˆ™2: ç¯å¢ƒéš”ç¦»**:

```text
bundles/
  â”œâ”€â”€ dev/
  â”‚   â””â”€â”€ authz-v1.0.0.tar.gz
  â”œâ”€â”€ staging/
  â”‚   â””â”€â”€ authz-v1.0.0.tar.gz      (å®Œå…¨ç›¸åŒ)
  â””â”€â”€ prod/
      â””â”€â”€ authz-v1.0.0.tar.gz      (å®Œå…¨ç›¸åŒ)

ç­–ç•¥ä¸€è‡´æ€§ â†’ é™ä½ç”Ÿäº§é£é™©
```

**åŸåˆ™3: ç‰ˆæœ¬ä¸å¯å˜**:

```text
âœ… å¥½çš„ç‰ˆæœ¬:
   bundle-v1.0.0.tar.gz      (æ°¸ä¸ä¿®æ”¹)
   bundle-v1.0.1.tar.gz      (æ–°ç‰ˆæœ¬)

âŒ é¿å…:
   bundle-latest.tar.gz      (å†…å®¹ç»å¸¸å˜åŒ–)
```

### 9.2 å®‰å…¨å»ºè®®

**å¼ºåˆ¶ç­¾åéªŒè¯**ï¼š

```yaml
bundles:
  authz:
    signing:
      keyid: production-key
      scope: write
      exclude_files: []  # ä¸æ’é™¤ä»»ä½•æ–‡ä»¶
```

**æœ€å°æƒé™åŸåˆ™**ï¼š

```text
Bundle Serverè®¿é—®:
  - åªè¯»æƒé™ï¼ˆGetObjectï¼‰
  - ç¦æ­¢å†™å…¥ï¼ˆPutObjectï¼‰
  - é™åˆ¶IPèŒƒå›´

å¯†é’¥ç®¡ç†:
  - ç§é’¥å­˜å‚¨åœ¨HSM/KMS
  - å…¬é’¥å¯å…¬å¼€åˆ†å‘
  - å®šæœŸè½®æ¢ï¼ˆ90å¤©ï¼‰
```

### 9.3 è¿ç»´å»ºè®®

**ç›‘æ§æŒ‡æ ‡**ï¼š

```text
- bundle_loaded_total: BundleåŠ è½½æˆåŠŸæ¬¡æ•°
- bundle_failed_load_total: BundleåŠ è½½å¤±è´¥æ¬¡æ•°
- bundle_loading_duration_ns: BundleåŠ è½½è€—æ—¶
- bundle_size_bytes: Bundleå¤§å°
- bundle_poll_interval_seconds: è½®è¯¢é—´éš”
```

**æ—¥å¿—è®°å½•**ï¼š

```json
{
  "level": "info",
  "msg": "Bundle loaded successfully",
  "revision": "v1.2.3",
  "name": "authz",
  "size_bytes": 1048576,
  "load_duration_ms": 245,
  "num_policies": 15,
  "num_data_files": 3
}
```

**æ•…éšœå¤„ç†**ï¼š

```text
åœºæ™¯1: Bundleä¸‹è½½å¤±è´¥
  â†’ ä¿æŒå½“å‰Bundleè¿è¡Œ
  â†’ æŒ‡æ•°é€€é¿é‡è¯•
  â†’ å‘Šè­¦é€šçŸ¥

åœºæ™¯2: ç­¾åéªŒè¯å¤±è´¥
  â†’ æ‹’ç»åŠ è½½
  â†’ ä¿æŒå½“å‰Bundle
  â†’ ç´§æ€¥å‘Šè­¦

åœºæ™¯3: ç­–ç•¥ç¼–è¯‘é”™è¯¯
  â†’ å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
  â†’ è®°å½•é”™è¯¯è¯¦æƒ…
  â†’ é˜»æ­¢è‡ªåŠ¨æ›´æ–°
```

---

## é™„å½•Aï¼šBundleæ ¼å¼å®Œæ•´ç¤ºä¾‹

**å®Œæ•´Bundleç»“æ„**ï¼š

```text
authz-bundle/
â”œâ”€â”€ .manifest
â”œâ”€â”€ .signatures.json
â”œâ”€â”€ policy/
â”‚   â”œâ”€â”€ authz/
â”‚   â”‚   â”œâ”€â”€ api.rego
â”‚   â”‚   â”œâ”€â”€ rbac.rego
â”‚   â”‚   â””â”€â”€ helpers.rego
â”‚   â””â”€â”€ validation/
â”‚       â””â”€â”€ schema.rego
â””â”€â”€ data/
    â”œâ”€â”€ users.json
    â””â”€â”€ roles.json
```

**.manifest**ï¼š

```json
{
  "revision": "v1.2.3",
  "roots": ["authz", "validation"],
  "metadata": {
    "description": "Production authorization policies",
    "authors": ["security@example.com"],
    "created": "2025-10-20T10:00:00Z",
    "source": "https://github.com/example/policies",
    "environment": "production"
  },
  "rego_version": 1
}
```

**.signatures.json**ï¼š

```json
{
  "signatures": [
    {
      "keyid": "prod-key-2025",
      "signature": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlcyI6W3sibmFtZSI6Ii5tYW5pZmVzdCIsImhhc2giOiJzaGEyNTY6YTFiMmMzLi4uIiwiYWxnb3JpdGhtIjoiU0hBLTI1NiJ9XX0.signature-data-here",
      "scope": "write"
    }
  ]
}
```

**policy/authz/api.rego**ï¼š

```rego
package authz.api

import rego.v1

default allow := false

allow if {
    input.method == "GET"
    input.path[0] == "public"
}

allow if {
    input.user.role == "admin"
}
```

---

## é™„å½•Bï¼šBundle APIç«¯ç‚¹

**æ ‡å‡†Bundle Server API**ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/bundles/<name>.tar.gz` | GET | ä¸‹è½½Bundle |
| `/bundles/<name>/manifest` | GET | ä»…è·å–manifest |
| `/bundles/<name>/signature` | GET | ä»…è·å–ç­¾å |

**å“åº”å¤´**ï¼š

```http
Content-Type: application/gzip
ETag: "abc123"
Last-Modified: Mon, 20 Oct 2025 10:00:00 GMT
Content-Length: 1048576
X-Bundle-Revision: v1.2.3
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š

- [APIè§„èŒƒ](./01.1-APIè§„èŒƒ.md)
- [WASMç¼–è¯‘è§„èŒƒ](./01.3-WASMç¼–è¯‘è§„èŒƒ.md)
- [Kubernetesé›†æˆ](../04-ç”Ÿæ€ç³»ç»Ÿ/04.1-Kubernetesé›†æˆ.md)

**å‚è€ƒèµ„æº**ï¼š

- Bundle Specification: <https://www.openpolicyagent.org/docs/latest/management-bundles/>
- Bundle Signing: <https://www.openpolicyagent.org/docs/latest/management-bundle-signing/>
- Bundle API: <https://www.openpolicyagent.org/docs/latest/rest-api/#bundle-api>
