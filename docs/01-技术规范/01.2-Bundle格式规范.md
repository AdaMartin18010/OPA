# Bundle 格式规范（Bundle Format Specification）

> **更新日期**: 2025年10月20日  
> **规范版本**: Bundle Format v1  
> **压缩格式**: tar.gz + signature  
> **参考**: <https://www.openpolicyagent.org/docs/latest/management-bundles/>

---

## 目录

- [Bundle 格式规范（Bundle Format Specification）](#bundle-格式规范bundle-format-specification)
  - [目录](#目录)
  - [1. Bundle概述](#1-bundle概述)
    - [1.1 什么是Bundle](#11-什么是bundle)
    - [1.2 为什么需要Bundle](#12-为什么需要bundle)
    - [1.3 Bundle生命周期](#13-bundle生命周期)
  - [2. Bundle文件结构](#2-bundle文件结构)
    - [2.1 目录结构](#21-目录结构)
    - [2.2 manifest.json](#22-manifestjson)
    - [2.3 策略文件组织](#23-策略文件组织)
    - [2.4 数据文件组织](#24-数据文件组织)
  - [3. Bundle Manifest详解](#3-bundle-manifest详解)
    - [3.1 必需字段](#31-必需字段)
    - [3.2 可选字段](#32-可选字段)
    - [3.3 Revision字段](#33-revision字段)
    - [3.4 Roots字段](#34-roots字段)
    - [3.5 Metadata字段](#35-metadata字段)
  - [4. Bundle签名机制](#4-bundle签名机制)
    - [4.1 签名文件结构](#41-签名文件结构)
    - [4.2 签名算法](#42-签名算法)
    - [4.3 验证流程](#43-验证流程)
    - [4.4 密钥管理](#44-密钥管理)
  - [5. Bundle分发机制](#5-bundle分发机制)
    - [5.1 HTTP(S) Bundle Server](#51-https-bundle-server)
    - [5.2 对象存储（S3/GCS/Azure Blob）](#52-对象存储s3gcsazure-blob)
    - [5.3 OCI Registry](#53-oci-registry)
    - [5.4 轮询与增量更新](#54-轮询与增量更新)
  - [6. Bundle构建实践](#6-bundle构建实践)
    - [6.1 使用OPA CLI构建](#61-使用opa-cli构建)
    - [6.2 使用构建工具链](#62-使用构建工具链)
    - [6.3 CI/CD集成](#63-cicd集成)
    - [6.4 版本管理策略](#64-版本管理策略)
  - [7. Delta Bundles（增量Bundle）](#7-delta-bundles增量bundle)
    - [7.1 Delta Bundle格式](#71-delta-bundle格式)
    - [7.2 增量更新算法](#72-增量更新算法)
    - [7.3 性能优化](#73-性能优化)
  - [8. Bundle性能考虑](#8-bundle性能考虑)
    - [8.1 Bundle大小优化](#81-bundle大小优化)
    - [8.2 加载性能](#82-加载性能)
    - [8.3 内存占用](#83-内存占用)
  - [9. 最佳实践](#9-最佳实践)
    - [9.1 Bundle组织原则](#91-bundle组织原则)
    - [9.2 安全建议](#92-安全建议)
    - [9.3 运维建议](#93-运维建议)
  - [附录A：Bundle格式完整示例](#附录abundle格式完整示例)
  - [附录B：Bundle API端点](#附录bbundle-api端点)

---

## 1. Bundle概述

### 1.1 什么是Bundle

**定义**：Bundle是OPA策略和数据的打包分发单元，使用tar.gz格式压缩。

**核心特性**：

- 📦 **原子性**: 策略+数据作为单一单元部署
- 🔐 **签名验证**: 支持JWT签名保证完整性
- 🔄 **版本化**: 通过revision追踪变更
- 🌐 **可分发**: 支持HTTP/S3/OCI多种分发方式

**Bundle结构**：

```text
bundle.tar.gz
├── .manifest                  # Bundle元数据
├── policy/                    # 策略文件目录
│   ├── authz.rego
│   └── rbac.rego
└── data/                      # 数据文件目录
    └── roles.json
```

### 1.2 为什么需要Bundle

**问题场景**：

1. ❌ **策略碎片化**: 策略分散在多个文件，难以统一管理
2. ❌ **版本不一致**: 策略与数据版本不匹配导致错误
3. ❌ **分发困难**: 缺乏标准化的分发机制
4. ❌ **安全风险**: 无法验证策略来源和完整性

**Bundle解决方案**：

```text
传统方式:
  策略文件1 ──┐
  策略文件2 ──┼──> 手动同步 ──> 多个OPA实例
  数据文件  ──┘                 (版本不一致)

Bundle方式:
  [策略+数据+Manifest] ──> Bundle Server ──> 自动分发 ──> 所有OPA实例
                         (签名验证)      (版本一致)
```

### 1.3 Bundle生命周期

```text
1. 构建阶段
   ├── 编写策略(.rego)
   ├── 准备数据(.json/.yaml)
   ├── 生成manifest
   └── 打包签名

2. 发布阶段
   ├── 上传到Bundle Server
   ├── 更新版本标签
   └── 触发通知(可选)

3. 分发阶段
   ├── OPA轮询检查更新
   ├── 下载新Bundle
   └── 验证签名

4. 激活阶段
   ├── 解压Bundle
   ├── 编译策略
   ├── 加载数据
   └── 原子性切换
```

---

## 2. Bundle文件结构

### 2.1 目录结构

**标准Bundle布局**：

```text
my-bundle/
├── .manifest                           # 必需：Bundle元数据
├── .signatures.json                    # 可选：签名文件
├── policy/                             # 策略根目录
│   ├── authz/
│   │   ├── api.rego                   # API授权策略
│   │   └── rbac.rego                  # RBAC策略
│   └── validation/
│       └── schema.rego                 # 数据验证策略
└── data/                               # 数据根目录
    ├── users.json                      # 用户数据
    └── roles/
        └── definitions.yaml            # 角色定义
```

**路径映射**：

```text
Bundle内路径              OPA内部路径
────────────────────     ─────────────────────
policy/authz/api.rego    data.authz.api
data/users.json          data.users
```

### 2.2 manifest.json

**基本结构**：

```json
{
  "revision": "v1.2.3",
  "roots": ["authz", "validation"],
  "metadata": {
    "description": "Production authorization policies",
    "authors": ["security-team@example.com"],
    "created": "2025-10-20T10:00:00Z"
  },
  "rego_version": 1,
  "wasm": [
    {
      "entrypoint": "authz/allow",
      "module": "policy.wasm"
    }
  ]
}
```

**字段说明**：

| 字段 | 必需 | 类型 | 说明 |
|------|------|------|------|
| `revision` | ✅ | string | Bundle版本标识 |
| `roots` | ❌ | []string | 策略命名空间根 |
| `metadata` | ❌ | object | 自定义元数据 |
| `rego_version` | ❌ | int | Rego语法版本(默认0) |
| `wasm` | ❌ | []object | WASM模块配置 |

### 2.3 策略文件组织

**推荐组织方式**：

```text
policy/
├── core/                    # 核心策略（全局）
│   ├── defaults.rego       # 默认规则
│   └── helpers.rego        # 辅助函数
├── domains/                 # 领域策略
│   ├── api/
│   │   ├── authz.rego
│   │   └── ratelimit.rego
│   └── data/
│       └── validation.rego
└── tests/                   # 测试文件
    └── authz_test.rego
```

**命名约定**：

```text
✅ 好的命名:
   - user_management.rego       # 清晰的功能描述
   - rbac_rules.rego            # 标准缩写
   - api_v2_authz.rego          # 包含版本

❌ 避免:
   - policy.rego                # 过于宽泛
   - temp.rego                  # 临时文件
   - 规则.rego                  # 非ASCII字符
```

### 2.4 数据文件组织

**支持格式**：

- ✅ JSON (`.json`)
- ✅ YAML (`.yaml`, `.yml`)

**示例结构**：

```text
data/
├── static/                  # 静态配置
│   ├── regions.json
│   └── service_tiers.yaml
├── external/                # 外部数据
│   └── user_groups.json
└── generated/               # 自动生成
    └── metrics.json
```

**data/static/regions.json**：

```json
{
  "regions": [
    {
      "id": "us-east-1",
      "name": "US East (N. Virginia)",
      "compliance": ["SOC2", "HIPAA"]
    },
    {
      "id": "eu-west-1",
      "name": "Europe (Ireland)",
      "compliance": ["GDPR", "SOC2"]
    }
  ]
}
```

---

## 3. Bundle Manifest详解

### 3.1 必需字段

**revision（版本标识）**：

```json
{
  "revision": "abc123def456"
}
```

**特性**：

- 🔢 推荐格式: 语义版本(`v1.2.3`) 或 Git SHA
- 🔄 用于检测Bundle更新
- 📊 可在监控中追踪部署版本

### 3.2 可选字段

**完整示例**：

```json
{
  "revision": "v2.1.0",
  "roots": ["authz", "validation", "audit"],
  "metadata": {
    "description": "Q4 2025 Authorization Policies",
    "authors": ["security@example.com"],
    "created": "2025-10-20T15:30:00Z",
    "source": "https://github.com/example/policies",
    "build": {
      "ci_job": "jenkins-build-1234",
      "commit": "a1b2c3d4"
    }
  },
  "rego_version": 1,
  "wasm": [
    {
      "entrypoint": "authz/allow",
      "module": "policy/authz.wasm"
    }
  ]
}
```

### 3.3 Revision字段

**版本策略**：

```text
1. 语义版本（推荐）:
   v1.0.0 → v1.0.1 → v1.1.0 → v2.0.0
   MAJOR.MINOR.PATCH

2. Git SHA（CI/CD友好）:
   a1b2c3d → e4f5g6h → i7j8k9l

3. 时间戳:
   20251020-150000 → 20251020-160000

4. 自定义标签:
   prod-20251020 → prod-20251021
```

**检测更新逻辑**：

```rego
package bundle

import rego.v1

# 当前Bundle版本
current_revision := opa.runtime().config.bundle.revision

# 检查是否为新版本
is_new_version(new_revision) if {
    new_revision != current_revision
}
```

### 3.4 Roots字段

**作用**：定义Bundle管理的策略命名空间根。

**示例**：

```json
{
  "roots": ["authz", "validation"]
}
```

**效果**：

```text
Bundle激活时：
  1. 清除 data.authz.* 下所有旧策略
  2. 清除 data.validation.* 下所有旧策略
  3. 加载Bundle中的新策略

未列在roots中的命名空间不受影响
```

**使用场景**：

```text
场景1: 单一Bundle管理所有策略
  roots: []               # 空数组 = 管理整个命名空间

场景2: 多Bundle分离管理
  Bundle A: roots: ["authz"]
  Bundle B: roots: ["audit"]
  → 两个Bundle独立更新，互不影响
```

### 3.5 Metadata字段

**标准字段建议**：

```json
{
  "metadata": {
    "description": "Bundle用途描述",
    "authors": ["维护者邮箱"],
    "created": "ISO 8601时间戳",
    "source": "源代码仓库URL",
    "environment": "prod|staging|dev",
    "compliance": ["SOC2", "GDPR"],
    "version_notes": "本版本变更说明"
  }
}
```

**自定义字段**：

```json
{
  "metadata": {
    "team": "platform-security",
    "cost_center": "CC-1234",
    "approval_ticket": "JIRA-5678",
    "rollback_plan": "https://runbook.example.com/bundle-rollback"
  }
}
```

---

## 4. Bundle签名机制

### 4.1 签名文件结构

**.signatures.json**：

```json
{
  "signatures": [
    {
      "keyid": "key1",
      "signature": "eyJhbGciOiJSUzI1NiIsIn...",
      "scope": "write"
    }
  ]
}
```

**完整签名示例**：

```json
{
  "signatures": [
    {
      "keyid": "production-key-2025",
      "signature": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
      "scope": "write",
      "claims": {
        "iss": "security-team@example.com",
        "sub": "bundle-v2.1.0",
        "iat": 1729425000,
        "exp": 1760961000,
        "aud": ["opa-prod"]
      }
    }
  ]
}
```

### 4.2 签名算法

**支持算法**（JWT标准）：

- ✅ **RS256**: RSA + SHA-256（推荐）
- ✅ **RS384**: RSA + SHA-384
- ✅ **RS512**: RSA + SHA-512
- ✅ **ES256**: ECDSA + SHA-256
- ✅ **ES384**: ECDSA + SHA-384
- ✅ **ES512**: ECDSA + SHA-512

**签名负载**：

```json
{
  "files": [
    {
      "name": ".manifest",
      "hash": "sha256:a1b2c3...",
      "algorithm": "SHA-256"
    },
    {
      "name": "policy/authz.rego",
      "hash": "sha256:d4e5f6...",
      "algorithm": "SHA-256"
    }
  ]
}
```

### 4.3 验证流程

**OPA验证步骤**：

```text
1. 下载Bundle
   ↓
2. 解压到临时目录
   ↓
3. 读取.signatures.json
   ↓
4. 验证JWT签名
   ├── 检查签名算法
   ├── 验证公钥
   └── 检查claims（iss, exp, aud）
   ↓
5. 验证文件哈希
   ├── 计算每个文件的SHA-256
   └── 与签名中的哈希对比
   ↓
6. 验证通过 → 激活Bundle
   验证失败 → 拒绝加载
```

**OPA配置**：

```yaml
bundles:
  authz:
    service: bundleServer
    resource: bundles/prod/authz.tar.gz
    signing:
      keyid: production-key-2025
      scope: write
```

### 4.4 密钥管理

**公钥配置**：

```yaml
keys:
  production-key-2025:
    algorithm: RS256
    key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
      -----END PUBLIC KEY-----
    scope: write
```

**密钥轮换策略**：

```text
1. 生成新密钥对
   └── openssl genrsa -out new_private.pem 4096

2. 分发新公钥到所有OPA实例
   └── 更新ConfigMap/Secret

3. 使用新私钥签名Bundle
   └── opa sign --signing-key new_private.pem

4. 宽限期（两个密钥并存）
   └── 30天

5. 移除旧密钥
```

---

## 5. Bundle分发机制

### 5.1 HTTP(S) Bundle Server

**标准端点**：

```text
GET /bundles/<name>.tar.gz
Response:
  200 OK
  Content-Type: application/gzip
  Body: [bundle tar.gz content]
```

**带ETag的增量更新**：

```http
Request:
  GET /bundles/authz.tar.gz
  If-None-Match: "abc123"

Response (未更新):
  304 Not Modified

Response (已更新):
  200 OK
  ETag: "def456"
  Body: [new bundle]
```

**OPA配置**：

```yaml
services:
  bundleServer:
    url: https://bundles.example.com
    credentials:
      bearer:
        token: ${BUNDLE_TOKEN}

bundles:
  authz:
    service: bundleServer
    resource: bundles/prod/authz.tar.gz
    polling:
      min_delay_seconds: 60
      max_delay_seconds: 120
```

### 5.2 对象存储（S3/GCS/Azure Blob）

**S3示例**：

```yaml
services:
  s3:
    url: https://my-bucket.s3.amazonaws.com
    credentials:
      s3_signing:
        environment_credentials: {}

bundles:
  authz:
    service: s3
    resource: policies/prod/bundle.tar.gz
```

**访问权限（AWS IAM Policy）**：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:GetObject"],
      "Resource": "arn:aws:s3:::my-bucket/policies/*"
    }
  ]
}
```

**GCS示例**：

```yaml
services:
  gcs:
    url: https://storage.googleapis.com/my-bucket
    credentials:
      gcp_metadata: {}

bundles:
  authz:
    service: gcs
    resource: policies/prod/bundle.tar.gz
```

### 5.3 OCI Registry

**OCI格式Bundle**（2024+新特性）：

```bash
# 推送Bundle到OCI Registry
opa build -b policy/ -o bundle.tar.gz
oras push registry.example.com/policies/authz:v1.0.0 bundle.tar.gz

# OPA配置
services:
  oci:
    url: https://registry.example.com
    type: oci
    credentials:
      bearer:
        token: ${REGISTRY_TOKEN}

bundles:
  authz:
    service: oci
    resource: policies/authz:v1.0.0
```

### 5.4 轮询与增量更新

**轮询策略**：

```yaml
bundles:
  authz:
    polling:
      min_delay_seconds: 60        # 最小轮询间隔
      max_delay_seconds: 120       # 最大轮询间隔（指数退避）
      long_polling_timeout_seconds: 0  # 0=禁用长轮询
```

**轮询行为**：

```text
1. 初始请求: 60秒后
2. 成功下载: 重置为60秒
3. 404错误: 指数退避到120秒
4. 网络错误: 指数退避到120秒
5. 恢复正常: 重置为60秒
```

---

## 6. Bundle构建实践

### 6.1 使用OPA CLI构建

**基本命令**：

```bash
# 构建Bundle
opa build -b policy/ -o bundle.tar.gz

# 指定数据目录
opa build -b policy/ data/ -o bundle.tar.gz

# 生成manifest
opa build policy/ \
  --bundle \
  --revision "v1.0.0" \
  --output bundle.tar.gz
```

**高级选项**：

```bash
# 优化策略（移除注释、格式化）
opa build -b policy/ -o bundle.tar.gz \
  --optimize=1

# 包含WASM模块
opa build -t wasm -e authz/allow policy/ -o policy.wasm
opa build -b policy/ policy.wasm -o bundle.tar.gz

# 排除测试文件
opa build -b policy/ -o bundle.tar.gz \
  --exclude-files-verify '*_test.rego'

# 验证策略语法
opa build -b policy/ -o bundle.tar.gz \
  --verify
```

### 6.2 使用构建工具链

**Makefile示例**：

```makefile
VERSION ?= $(shell git rev-parse --short HEAD)
BUNDLE_NAME = authz-bundle

.PHONY: build
build:
 opa build \
  --bundle \
  --revision "$(VERSION)" \
  --output $(BUNDLE_NAME).tar.gz \
  policy/

.PHONY: sign
sign: build
 opa sign \
  --signing-key private_key.pem \
  --bundle $(BUNDLE_NAME).tar.gz \
  --output-file-path .signatures.json

.PHONY: publish
publish: sign
 aws s3 cp $(BUNDLE_NAME).tar.gz \
  s3://my-bucket/bundles/$(BUNDLE_NAME)-$(VERSION).tar.gz

.PHONY: test
test:
 opa test policy/ -v
```

### 6.3 CI/CD集成

**GitHub Actions示例**：

```yaml
name: Build and Publish Bundle

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Test Policies
        run: opa test policy/ -v
      
      - name: Build Bundle
        run: |
          opa build -b policy/ data/ \
            --revision "${{ github.sha }}" \
            --output bundle.tar.gz
      
      - name: Sign Bundle
        env:
          SIGNING_KEY: ${{ secrets.BUNDLE_SIGNING_KEY }}
        run: |
          echo "$SIGNING_KEY" > private_key.pem
          opa sign --signing-key private_key.pem \
            --bundle bundle.tar.gz
      
      - name: Publish to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp bundle.tar.gz \
            s3://my-bundles/prod/bundle-${{ github.sha }}.tar.gz
```

### 6.4 版本管理策略

**版本命名**：

```text
环境分离:
  bundles/
    ├── dev/bundle-latest.tar.gz
    ├── staging/bundle-v1.2.3-rc1.tar.gz
    └── prod/bundle-v1.2.3.tar.gz

多租户:
  bundles/
    ├── tenant-a/bundle-v1.0.0.tar.gz
    └── tenant-b/bundle-v2.0.0.tar.gz

特性分支:
  bundles/
    ├── main/bundle-abc123.tar.gz
    └── feature-rbac-v2/bundle-def456.tar.gz
```

---

## 7. Delta Bundles（增量Bundle）

### 7.1 Delta Bundle格式

**Delta Manifest**：

```json
{
  "revision": "v1.0.1",
  "parent_revision": "v1.0.0",
  "delta": true,
  "patch": [
    {
      "op": "upsert",
      "path": "policy/authz/new_rule.rego",
      "value": "<base64-encoded-content>"
    },
    {
      "op": "remove",
      "path": "policy/deprecated.rego"
    }
  ]
}
```

**操作类型**：

- `upsert`: 添加或更新文件
- `remove`: 删除文件
- `replace`: 替换整个路径

### 7.2 增量更新算法

**应用Delta流程**：

```text
1. 验证parent_revision匹配
   ↓
2. 按顺序应用patch操作
   ├── upsert: 解码base64 → 写入文件
   ├── remove: 删除文件
   └── replace: 替换目录
   ↓
3. 更新本地revision
   ↓
4. 重新编译策略
```

### 7.3 性能优化

**场景对比**：

```text
全量Bundle:
  大小: 10MB
  下载: 10s
  解压: 2s
  总时间: 12s

Delta Bundle:
  大小: 100KB (1% of full)
  下载: 0.1s
  应用patch: 0.5s
  总时间: 0.6s

性能提升: 20x
```

**适用场景**：

- ✅ 频繁更新（<5分钟间隔）
- ✅ 大型Bundle（>100MB）
- ✅ 带宽受限环境

---

## 8. Bundle性能考虑

### 8.1 Bundle大小优化

**优化技术**：

```bash
# 1. 移除注释和测试文件
opa build -b policy/ -o bundle.tar.gz \
  --exclude-files-verify '*_test.rego'

# 2. 启用压缩优化
tar -czf bundle.tar.gz --options gzip:compression-level=9 bundle/

# 3. 分离大型数据文件
#   策略Bundle: 1MB
#   数据Bundle: 100MB（独立更新）
```

**大小基准**：

```text
小型Bundle: < 1MB      (加载<100ms)
中型Bundle: 1-10MB     (加载100ms-1s)
大型Bundle: 10-100MB   (加载1s-10s)
超大Bundle: > 100MB    (考虑拆分)
```

### 8.2 加载性能

**加载阶段**：

```text
1. 下载: 取决于网络带宽
2. 解压: CPU密集型
3. 解析: 策略文件数量
4. 编译: 规则复杂度
5. 索引: 规则总数
```

**优化措施**：

```text
✅ 使用CDN加速下载
✅ 预编译为WASM（跳过编译阶段）
✅ 拆分为多个小Bundle
✅ 使用Delta更新
```

### 8.3 内存占用

**内存计算**：

```text
总内存 = Bundle大小 + 编译后AST + 运行时数据

示例:
  Bundle: 10MB
  AST:    30MB (3x)
  数据:   50MB
  ─────────────
  总计:   90MB
```

---

## 9. 最佳实践

### 9.1 Bundle组织原则

**原则1: 单一职责**:

```text
❌ 避免:
   bundles/everything.tar.gz  (100MB, 包含所有策略)

✅ 推荐:
   bundles/authz.tar.gz       (1MB, 授权策略)
   bundles/validation.tar.gz  (2MB, 验证策略)
   bundles/audit.tar.gz       (500KB, 审计策略)
```

**原则2: 环境隔离**:

```text
bundles/
  ├── dev/
  │   └── authz-v1.0.0.tar.gz
  ├── staging/
  │   └── authz-v1.0.0.tar.gz      (完全相同)
  └── prod/
      └── authz-v1.0.0.tar.gz      (完全相同)

策略一致性 → 降低生产风险
```

**原则3: 版本不可变**:

```text
✅ 好的版本:
   bundle-v1.0.0.tar.gz      (永不修改)
   bundle-v1.0.1.tar.gz      (新版本)

❌ 避免:
   bundle-latest.tar.gz      (内容经常变化)
```

### 9.2 安全建议

**强制签名验证**：

```yaml
bundles:
  authz:
    signing:
      keyid: production-key
      scope: write
      exclude_files: []  # 不排除任何文件
```

**最小权限原则**：

```text
Bundle Server访问:
  - 只读权限（GetObject）
  - 禁止写入（PutObject）
  - 限制IP范围

密钥管理:
  - 私钥存储在HSM/KMS
  - 公钥可公开分发
  - 定期轮换（90天）
```

### 9.3 运维建议

**监控指标**：

```text
- bundle_loaded_total: Bundle加载成功次数
- bundle_failed_load_total: Bundle加载失败次数
- bundle_loading_duration_ns: Bundle加载耗时
- bundle_size_bytes: Bundle大小
- bundle_poll_interval_seconds: 轮询间隔
```

**日志记录**：

```json
{
  "level": "info",
  "msg": "Bundle loaded successfully",
  "revision": "v1.2.3",
  "name": "authz",
  "size_bytes": 1048576,
  "load_duration_ms": 245,
  "num_policies": 15,
  "num_data_files": 3
}
```

**故障处理**：

```text
场景1: Bundle下载失败
  → 保持当前Bundle运行
  → 指数退避重试
  → 告警通知

场景2: 签名验证失败
  → 拒绝加载
  → 保持当前Bundle
  → 紧急告警

场景3: 策略编译错误
  → 回滚到上一版本
  → 记录错误详情
  → 阻止自动更新
```

---

## 附录A：Bundle格式完整示例

**完整Bundle结构**：

```text
authz-bundle/
├── .manifest
├── .signatures.json
├── policy/
│   ├── authz/
│   │   ├── api.rego
│   │   ├── rbac.rego
│   │   └── helpers.rego
│   └── validation/
│       └── schema.rego
└── data/
    ├── users.json
    └── roles.json
```

**.manifest**：

```json
{
  "revision": "v1.2.3",
  "roots": ["authz", "validation"],
  "metadata": {
    "description": "Production authorization policies",
    "authors": ["security@example.com"],
    "created": "2025-10-20T10:00:00Z",
    "source": "https://github.com/example/policies",
    "environment": "production"
  },
  "rego_version": 1
}
```

**.signatures.json**：

```json
{
  "signatures": [
    {
      "keyid": "prod-key-2025",
      "signature": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlcyI6W3sibmFtZSI6Ii5tYW5pZmVzdCIsImhhc2giOiJzaGEyNTY6YTFiMmMzLi4uIiwiYWxnb3JpdGhtIjoiU0hBLTI1NiJ9XX0.signature-data-here",
      "scope": "write"
    }
  ]
}
```

**policy/authz/api.rego**：

```rego
package authz.api

import rego.v1

default allow := false

allow if {
    input.method == "GET"
    input.path[0] == "public"
}

allow if {
    input.user.role == "admin"
}
```

---

## 附录B：Bundle API端点

**标准Bundle Server API**：

| 端点 | 方法 | 说明 |
|------|------|------|
| `/bundles/<name>.tar.gz` | GET | 下载Bundle |
| `/bundles/<name>/manifest` | GET | 仅获取manifest |
| `/bundles/<name>/signature` | GET | 仅获取签名 |

**响应头**：

```http
Content-Type: application/gzip
ETag: "abc123"
Last-Modified: Mon, 20 Oct 2025 10:00:00 GMT
Content-Length: 1048576
X-Bundle-Revision: v1.2.3
```

---

**相关文档**：

- [API规范](./01.1-API规范.md)
- [WASM编译规范](./01.3-WASM编译规范.md)
- [Kubernetes集成](../04-生态系统/04.1-Kubernetes集成.md)

**参考资源**：

- Bundle Specification: <https://www.openpolicyagent.org/docs/latest/management-bundles/>
- Bundle Signing: <https://www.openpolicyagent.org/docs/latest/management-bundle-signing/>
- Bundle API: <https://www.openpolicyagent.org/docs/latest/rest-api/#bundle-api>
