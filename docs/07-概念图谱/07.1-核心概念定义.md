# OPA æ ¸å¿ƒæ¦‚å¿µå®šä¹‰ï¼ˆCore Concepts & Definitionsï¼‰

> **é€‚ç”¨ç‰ˆæœ¬**: OPA v0.10+ (æ ¸å¿ƒæ¦‚å¿µç¨³å®š) | æ¨è v0.68+  
> **Regoç‰ˆæœ¬**: v1.0  
> **ç›®æ ‡è¯»è€…**: åˆå­¦è€… â†’ é«˜çº§ç”¨æˆ·  
> **æœ€åéªŒè¯**: 2025-10-21  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯

---

## ğŸ“˜ æ¦‚å¿µå›¾è°±æŒ‡å—

> **æœ¬æ–‡æ¡£ç”¨é€”**:
>
> - âœ… å¿«é€ŸæŸ¥æ‰¾OPA/Regoæ ¸å¿ƒæœ¯è¯­å®šä¹‰
> - âœ… ç†è§£æ¦‚å¿µä¹‹é—´çš„å…³ç³»
> - âœ… ä½œä¸ºå­¦ä¹ è·¯å¾„çš„å‚è€ƒæ‰‹å†Œ
> - âœ… è§£å†³æœ¯è¯­æ··æ·†é—®é¢˜
>
> **ä½¿ç”¨å»ºè®®**:
>
> - åˆå­¦è€…ï¼šæŒ‰é¡ºåºé˜…è¯»ï¼Œå»ºç«‹å®Œæ•´æ¦‚å¿µä½“ç³»
> - è¿›é˜¶ç”¨æˆ·ï¼šä½œä¸ºæœ¯è¯­é€ŸæŸ¥æ‰‹å†Œ
> - é…åˆ[æœ¯è¯­è¡¨](../GLOSSARY.md)å’Œ[å¿«é€Ÿå‚è€ƒ](../QUICK_REFERENCE.md)ä½¿ç”¨
>
> ç›¸å…³: [å­¦ä¹ è·¯çº¿å›¾](../LEARNING_PATH.md) | [FAQ](../FAQ.md)

---

## ç›®å½•

- [OPA æ ¸å¿ƒæ¦‚å¿µå®šä¹‰ï¼ˆCore Concepts \& Definitionsï¼‰](#opa-æ ¸å¿ƒæ¦‚å¿µå®šä¹‰core-concepts--definitions)
  - [ğŸ“˜ æ¦‚å¿µå›¾è°±æŒ‡å—](#-æ¦‚å¿µå›¾è°±æŒ‡å—)
  - [ç›®å½•](#ç›®å½•)
  - [1. åŸºç¡€æ¦‚å¿µå±‚](#1-åŸºç¡€æ¦‚å¿µå±‚)
    - [1.1 OPA (Open Policy Agent)](#11-opa-open-policy-agent)
    - [1.2 Rego (ç­–ç•¥è¯­è¨€)](#12-rego-ç­–ç•¥è¯­è¨€)
    - [1.3 Policy (ç­–ç•¥)](#13-policy-ç­–ç•¥)
    - [1.4 Rule (è§„åˆ™)](#14-rule-è§„åˆ™)
      - [1.4.1 å®Œå…¨è§„åˆ™ï¼ˆComplete Ruleï¼‰](#141-å®Œå…¨è§„åˆ™complete-rule)
      - [1.4.2 éƒ¨åˆ†è§„åˆ™ï¼ˆPartial Ruleï¼‰](#142-éƒ¨åˆ†è§„åˆ™partial-rule)
      - [1.4.3 å¤šå€¼è§„åˆ™ï¼ˆMulti-Value Ruleï¼‰](#143-å¤šå€¼è§„åˆ™multi-value-rule)
    - [1.5 Query (æŸ¥è¯¢)](#15-query-æŸ¥è¯¢)
  - [2. ç­–ç•¥æ¦‚å¿µå±‚](#2-ç­–ç•¥æ¦‚å¿µå±‚)
    - [2.1 Module (æ¨¡å—)](#21-module-æ¨¡å—)
    - [2.2 Package (åŒ…)](#22-package-åŒ…)
    - [2.3 Expression (è¡¨è¾¾å¼)](#23-expression-è¡¨è¾¾å¼)
      - [2.3.1 ç»Ÿä¸€è¡¨è¾¾å¼ï¼ˆUnificationï¼‰](#231-ç»Ÿä¸€è¡¨è¾¾å¼unification)
      - [2.3.2 èµ‹å€¼è¡¨è¾¾å¼ï¼ˆAssignmentï¼‰](#232-èµ‹å€¼è¡¨è¾¾å¼assignment)
      - [2.3.3 æ¯”è¾ƒè¡¨è¾¾å¼ï¼ˆComparisonï¼‰](#233-æ¯”è¾ƒè¡¨è¾¾å¼comparison)
      - [2.3.4 æˆå‘˜è¡¨è¾¾å¼ï¼ˆMembershipï¼‰](#234-æˆå‘˜è¡¨è¾¾å¼membership)
      - [2.3.5 å¦å®šè¡¨è¾¾å¼ï¼ˆNegationï¼‰](#235-å¦å®šè¡¨è¾¾å¼negation)
    - [2.4 Term (é¡¹)](#24-term-é¡¹)
    - [2.5 Comprehension (æ¨å¯¼å¼)](#25-comprehension-æ¨å¯¼å¼)
      - [2.5.1 æ•°ç»„æ¨å¯¼](#251-æ•°ç»„æ¨å¯¼)
      - [2.5.2 é›†åˆæ¨å¯¼](#252-é›†åˆæ¨å¯¼)
      - [2.5.3 å¯¹è±¡æ¨å¯¼](#253-å¯¹è±¡æ¨å¯¼)
  - [3. æ•°æ®æ¦‚å¿µå±‚](#3-æ•°æ®æ¦‚å¿µå±‚)
    - [3.1 Input (è¾“å…¥)](#31-input-è¾“å…¥)
    - [3.2 Data (æ•°æ®)](#32-data-æ•°æ®)
    - [3.3 Bundle (ç­–ç•¥åŒ…)](#33-bundle-ç­–ç•¥åŒ…)
    - [3.4 Document (æ–‡æ¡£)](#34-document-æ–‡æ¡£)
  - [4. æ‰§è¡Œæ¦‚å¿µå±‚](#4-æ‰§è¡Œæ¦‚å¿µå±‚)
    - [4.1 Evaluation (æ±‚å€¼)](#41-evaluation-æ±‚å€¼)
    - [4.2 Unification (ç»Ÿä¸€)](#42-unification-ç»Ÿä¸€)
    - [4.3 Backtracking (å›æº¯)](#43-backtracking-å›æº¯)
    - [4.4 Partial Evaluation (éƒ¨åˆ†æ±‚å€¼)](#44-partial-evaluation-éƒ¨åˆ†æ±‚å€¼)
    - [4.5 Indexing (ç´¢å¼•)](#45-indexing-ç´¢å¼•)
      - [4.5.1 æ•°æ®ç´¢å¼•](#451-æ•°æ®ç´¢å¼•)
      - [4.5.2 è§„åˆ™ç´¢å¼•](#452-è§„åˆ™ç´¢å¼•)
  - [5. éƒ¨ç½²æ¦‚å¿µå±‚](#5-éƒ¨ç½²æ¦‚å¿µå±‚)
    - [5.1 Sidecar (è¾¹è½¦æ¨¡å¼)](#51-sidecar-è¾¹è½¦æ¨¡å¼)
    - [5.2 Library (åº“åµŒå…¥)](#52-library-åº“åµŒå…¥)
    - [5.3 Server (æœåŠ¡æ¨¡å¼)](#53-server-æœåŠ¡æ¨¡å¼)
    - [5.4 WASM (WebAssembly)](#54-wasm-webassembly)
  - [6. æ¦‚å¿µå…³ç³»ç½‘ç»œ](#6-æ¦‚å¿µå…³ç³»ç½‘ç»œ)
    - [6.1 æ¦‚å¿µä¾èµ–å›¾](#61-æ¦‚å¿µä¾èµ–å›¾)
    - [6.2 æ¦‚å¿µäº¤äº’çŸ©é˜µ](#62-æ¦‚å¿µäº¤äº’çŸ©é˜µ)
    - [6.3 æŠ½è±¡å±‚æ¬¡](#63-æŠ½è±¡å±‚æ¬¡)
  - [é™„å½•ï¼šæœ¯è¯­å¯¹ç…§è¡¨](#é™„å½•æœ¯è¯­å¯¹ç…§è¡¨)

---

## 1. åŸºç¡€æ¦‚å¿µå±‚

### 1.1 OPA (Open Policy Agent)

**å®šä¹‰**: å¼€æºçš„ã€é€šç”¨çš„ã€äº‘åŸç”Ÿçš„ç­–ç•¥å¼•æ“ã€‚

**æ ¸å¿ƒç‰¹å¾**:

```text
OPA = {
    è¯­è¨€: Rego (å£°æ˜å¼ç­–ç•¥è¯­è¨€),
    å¼•æ“: Top-Downæ±‚å€¼å™¨,
    æ•°æ®: JSONæ ¼å¼,
    éƒ¨ç½²: Sidecar | Library | Server | WASM,
    åè®®: REST | gRPC,
    ç”Ÿæ€: CNCFæ¯•ä¸šé¡¹ç›®
}
```

**è®¾è®¡å“²å­¦**:

- **Policy as Code**: ç­–ç•¥å³ä»£ç ï¼Œç‰ˆæœ¬åŒ–ã€æµ‹è¯•ã€CI/CD
- **Decoupled Decision**: å†³ç­–é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦
- **General Purpose**: é¢†åŸŸæ— å…³ï¼Œé€‚ç”¨äºä»»ä½•éœ€è¦å†³ç­–çš„åœºæ™¯

**ç±»æ¯”**:

```text
OPA : å†³ç­– â‰ˆ PostgreSQL : æ•°æ®å­˜å‚¨
```

---

### 1.2 Rego (ç­–ç•¥è¯­è¨€)

**å®šä¹‰**: OPAçš„ç­–ç•¥å®šä¹‰è¯­è¨€ï¼ŒåŸºäºDatalogçš„å£°æ˜å¼æŸ¥è¯¢è¯­è¨€ã€‚

**è¯­è¨€ç‰¹æ€§**:

| ç‰¹æ€§ | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| **å£°æ˜å¼** | æè¿°"ä»€ä¹ˆ"è€Œé"å¦‚ä½•" | `allow if input.user == "admin"` |
| **é€»è¾‘å¼** | åŸºäºä¸€é˜¶é€»è¾‘ | `p :- q, r, s` |
| **æ— å‰¯ä½œç”¨** | çº¯å‡½æ•°å¼ | æ— å…¨å±€çŠ¶æ€ä¿®æ”¹ |
| **æ•°æ®é©±åŠ¨** | æ•°æ®ä¸ç­–ç•¥åˆ†ç¦» | `data.users` vs `input.request` |
| **å¯ç»„åˆ** | è§„åˆ™ç›¸äº’å¼•ç”¨ | `allow if is_admin` |

**å‘½åç”±æ¥**: **Re**asoning **Go** â†’ Rego

**ç±»å‹ç³»ç»Ÿ**:

```text
åŠ¨æ€å¼ºç±»å‹ + ç»“æ„åŒ–ç±»å‹ + æ— éšå¼è½¬æ¢
```

---

### 1.3 Policy (ç­–ç•¥)

**å®šä¹‰**: ç”¨Regoç¼–å†™çš„å†³ç­–é€»è¾‘é›†åˆï¼Œæè¿°"å…è®¸ä»€ä¹ˆ"æˆ–"æ‹’ç»ä»€ä¹ˆ"ã€‚

**ç­–ç•¥ç»“æ„**:

```rego
# åŒ…å‘½åç©ºé—´
package authz.api.v1

# å¯¼å…¥ä¾èµ–
import data.roles

# è§„åˆ™å®šä¹‰
allow if {
    input.method == "GET"
    is_public_resource
}

# è¾…åŠ©è§„åˆ™
is_public_resource if {
    startswith(input.path, "/public")
}
```

**ç­–ç•¥ç±»å‹**:

```text
ç­–ç•¥åˆ†ç±»
â”œâ”€â”€ è®¿é—®æ§åˆ¶ç­–ç•¥ (Authorization)
â”œâ”€â”€ åˆè§„æ€§ç­–ç•¥ (Compliance)
â”œâ”€â”€ èµ„æºé…ç½®ç­–ç•¥ (Configuration)
â””â”€â”€ æ•°æ®è¿‡æ»¤ç­–ç•¥ (Data Filtering)
```

**ç­–ç•¥ç”Ÿå‘½å‘¨æœŸ**:

```text
ç¼–å†™ â†’ æµ‹è¯• â†’ ç‰ˆæœ¬æ§åˆ¶ â†’ æ‰“åŒ…(Bundle) â†’ åˆ†å‘ â†’ åŠ è½½ â†’ æ‰§è¡Œ â†’ ç›‘æ§
```

---

### 1.4 Rule (è§„åˆ™)

**å®šä¹‰**: ç­–ç•¥çš„åŸºæœ¬å•å…ƒï¼Œç”±**è§„åˆ™å¤´**ï¼ˆheadï¼‰å’Œ**è§„åˆ™ä½“**ï¼ˆbodyï¼‰ç»„æˆã€‚

**å½¢å¼åŒ–å®šä¹‰**:

```text
Rule ::= Head :- Body
```

**è§„åˆ™ç±»å‹**:

#### 1.4.1 å®Œå…¨è§„åˆ™ï¼ˆComplete Ruleï¼‰

```rego
# è¿”å›å•ä¸€å€¼
is_admin := true if {
    input.user.role == "admin"
}
```

#### 1.4.2 éƒ¨åˆ†è§„åˆ™ï¼ˆPartial Ruleï¼‰

```rego
# ç”Ÿæˆé›†åˆ
admins contains user.name if {
    user := data.users[_]
    user.role == "admin"
}

# ç”Ÿæˆå¯¹è±¡
user_scores[user] := score if {
    score := calculate_score(user)
}
```

#### 1.4.3 å¤šå€¼è§„åˆ™ï¼ˆMulti-Value Ruleï¼‰

```rego
# å¤šä¸ªå®šä¹‰ï¼ˆORè¯­ä¹‰ï¼‰
allow if { input.user == "admin" }
allow if { input.path == "/public" }
```

**è§„åˆ™æ±‚å€¼**:

```text
æ¡ä»¶å…¨éƒ¨æ»¡è¶³ â†’ è§„åˆ™æˆåŠŸ â†’ ç”Ÿæˆå€¼
ä»»ä¸€æ¡ä»¶å¤±è´¥ â†’ è§„åˆ™å¤±è´¥ â†’ undefined
```

---

### 1.5 Query (æŸ¥è¯¢)

**å®šä¹‰**: å‘OPAå‘èµ·çš„å†³ç­–è¯·æ±‚ï¼Œç”±è¾“å…¥æ•°æ®å’ŒæŸ¥è¯¢è·¯å¾„ç»„æˆã€‚

**æŸ¥è¯¢æ ¼å¼**:

```http
POST /v1/data/authz/allow
Content-Type: application/json

{
    "input": {
        "user": "alice",
        "method": "GET",
        "path": "/api/users"
    }
}
```

**å“åº”æ ¼å¼**:

```json
{
    "result": true,
    "decision_id": "uuid-1234"
}
```

**æŸ¥è¯¢ç±»å‹**:

| ç±»å‹ | è·¯å¾„ | è¿”å› |
|------|------|------|
| **ç­–ç•¥æŸ¥è¯¢** | `/v1/data/pkg/rule` | è§„åˆ™ç»“æœ |
| **æ•°æ®æŸ¥è¯¢** | `/v1/data/users/alice` | æ•°æ®å†…å®¹ |
| **éƒ¨åˆ†æ±‚å€¼** | `/v1/compile` | ä¼˜åŒ–åçš„æŸ¥è¯¢ |

---

## 2. ç­–ç•¥æ¦‚å¿µå±‚

### 2.1 Module (æ¨¡å—)

**å®šä¹‰**: åŒ…å«ä¸€ç»„è§„åˆ™çš„Regoæºæ–‡ä»¶ï¼ˆ`.rego`ï¼‰ã€‚

**æ¨¡å—ç»“æ„**:

```rego
# 1. Packageå£°æ˜ï¼ˆå¿…éœ€ï¼‰
package example.rbac

# 2. Importsï¼ˆå¯é€‰ï¼‰
import data.users
import future.keywords.if

# 3. Rulesï¼ˆæ ¸å¿ƒï¼‰
allow if {
    # è§„åˆ™é€»è¾‘
}
```

**æ¨¡å—å‘½å**:

```text
æ–‡ä»¶è·¯å¾„ â†’ åŒ…è·¯å¾„
policy/
  authz/
    api.rego  â†’ package policy.authz.api
```

---

### 2.2 Package (åŒ…)

**å®šä¹‰**: ç­–ç•¥çš„å‘½åç©ºé—´ï¼Œç»„ç»‡ç›¸å…³è§„åˆ™ã€‚

**åŒ…å±‚æ¬¡**:

```text
data
â”œâ”€â”€ kubernetes
â”‚   â”œâ”€â”€ admission     # package kubernetes.admission
â”‚   â”‚   â”œâ”€â”€ pods
â”‚   â”‚   â””â”€â”€ services
â”‚   â””â”€â”€ rbac          # package kubernetes.rbac
â””â”€â”€ api
    â””â”€â”€ authz         # package api.authz
```

**åŒ…å¼•ç”¨**:

```rego
# å®šä¹‰åŒ…
package api.authz

# å¼•ç”¨å…¶ä»–åŒ…
import data.kubernetes.rbac

allow if {
    rbac.can_access(input.user, input.resource)
}
```

---

### 2.3 Expression (è¡¨è¾¾å¼)

**å®šä¹‰**: è§„åˆ™ä½“çš„ç»„æˆéƒ¨åˆ†ï¼Œè¡¨ç¤ºçº¦æŸæˆ–è®¡ç®—ã€‚

**è¡¨è¾¾å¼ç±»å‹**:

#### 2.3.1 ç»Ÿä¸€è¡¨è¾¾å¼ï¼ˆUnificationï¼‰

```rego
x = 5                      # ç»‘å®šå˜é‡
[a, b] = [1, 2]           # æ¨¡å¼åŒ¹é…
```

#### 2.3.2 èµ‹å€¼è¡¨è¾¾å¼ï¼ˆAssignmentï¼‰

```rego
x := 5                     # å±€éƒ¨èµ‹å€¼
y := x * 2                # è®¡ç®—
```

#### 2.3.3 æ¯”è¾ƒè¡¨è¾¾å¼ï¼ˆComparisonï¼‰

```rego
input.count > 10          # å¤§äº
input.name == "alice"     # ç›¸ç­‰
```

#### 2.3.4 æˆå‘˜è¡¨è¾¾å¼ï¼ˆMembershipï¼‰

```rego
import future.keywords.in

"admin" in input.roles    # æˆå‘˜æ£€æŸ¥
```

#### 2.3.5 å¦å®šè¡¨è¾¾å¼ï¼ˆNegationï¼‰

```rego
not is_blacklisted        # é€»è¾‘å¦å®š
```

---

### 2.4 Term (é¡¹)

**å®šä¹‰**: è¡¨è¾¾å¼çš„åŸºæœ¬å•å…ƒï¼Œå¯ä»¥æ˜¯å€¼ã€å˜é‡æˆ–å¼•ç”¨ã€‚

**é¡¹åˆ†ç±»**:

```text
Term
â”œâ”€â”€ Scalar (æ ‡é‡)
â”‚   â”œâ”€â”€ Boolean: true, false
â”‚   â”œâ”€â”€ Number: 42, 3.14
â”‚   â”œâ”€â”€ String: "hello"
â”‚   â””â”€â”€ Null: null
â”œâ”€â”€ Composite (å¤åˆ)
â”‚   â”œâ”€â”€ Array: [1, 2, 3]
â”‚   â”œâ”€â”€ Object: {"key": "value"}
â”‚   â””â”€â”€ Set: {1, 2, 3}
â”œâ”€â”€ Variable (å˜é‡)
â”‚   â””â”€â”€ x, user, count
â””â”€â”€ Reference (å¼•ç”¨)
    â””â”€â”€ input.user.name, data.users[i]
```

---

### 2.5 Comprehension (æ¨å¯¼å¼)

**å®šä¹‰**: ä»é›†åˆç”Ÿæˆæ–°é›†åˆçš„è¡¨è¾¾å¼ã€‚

**æ¨å¯¼å¼ç±»å‹**:

#### 2.5.1 æ•°ç»„æ¨å¯¼

```rego
admin_names := [u.name | u := data.users[_]; u.role == "admin"]
```

**è¯­ä¹‰**:

```text
[è¡¨è¾¾å¼ | ç»‘å®š; æ¡ä»¶1; æ¡ä»¶2; ...]
```

#### 2.5.2 é›†åˆæ¨å¯¼

```rego
admin_set := {u.name | u := data.users[_]; u.role == "admin"}
```

#### 2.5.3 å¯¹è±¡æ¨å¯¼

```rego
user_map := {u.id: u | u := data.users[_]}
```

**æ‰§è¡Œæµç¨‹**:

```text
éå†é›†åˆ â†’ åº”ç”¨æ¡ä»¶è¿‡æ»¤ â†’ æ”¶é›†è¡¨è¾¾å¼ç»“æœ â†’ è¿”å›æ–°é›†åˆ
```

---

## 3. æ•°æ®æ¦‚å¿µå±‚

### 3.1 Input (è¾“å…¥)

**å®šä¹‰**: æŸ¥è¯¢æ—¶æä¾›çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œé€šå¸¸æ˜¯è¯·æ±‚ä¿¡æ¯ã€‚

**è¾“å…¥ç»“æ„**:

```json
{
    "input": {
        "user": "alice",
        "method": "GET",
        "path": "/api/users",
        "headers": {
            "Authorization": "Bearer ..."
        },
        "timestamp": "2025-10-20T12:00:00Z"
    }
}
```

**è®¿é—®æ–¹å¼**:

```rego
# ç›´æ¥è®¿é—®
user := input.user
method := input.method

# æ¡ä»¶æ£€æŸ¥
allow if {
    input.method == "GET"
    input.user in data.admins
}
```

**è¾“å…¥ç‰¹æ€§**:

- æ¯æ¬¡æŸ¥è¯¢å¯ä¸åŒ
- ä¸å¯ä¿®æ”¹ï¼ˆåªè¯»ï¼‰
- é€šå¸¸æ¥è‡ªåº”ç”¨å±‚

---

### 3.2 Data (æ•°æ®)

**å®šä¹‰**: å­˜å‚¨åœ¨OPAä¸­çš„é™æ€æˆ–åŠ¨æ€æ•°æ®ï¼Œä¾›ç­–ç•¥å¼•ç”¨ã€‚

**æ•°æ®æ¥æº**:

```text
Data Sources
â”œâ”€â”€ Bundle (æ‰“åŒ…æ•°æ®)
â”‚   â””â”€â”€ data.json
â”œâ”€â”€ Remote (è¿œç¨‹æ‹‰å–)
â”‚   â”œâ”€â”€ HTTP/HTTPS
â”‚   â”œâ”€â”€ S3
â”‚   â””â”€â”€ Git
â”œâ”€â”€ API (åŠ¨æ€åŠ è½½)
â”‚   â””â”€â”€ PUT /v1/data/...
â””â”€â”€ Config (å¯åŠ¨é…ç½®)
    â””â”€â”€ --bundle, --data
```

**æ•°æ®ç»“æ„ç¤ºä¾‹**:

```json
{
    "users": {
        "alice": {
            "role": "admin",
            "department": "engineering"
        },
        "bob": {
            "role": "user",
            "department": "sales"
        }
    },
    "roles": {
        "admin": {
            "permissions": ["read", "write", "delete"]
        },
        "user": {
            "permissions": ["read"]
        }
    }
}
```

**è®¿é—®æ–¹å¼**:

```rego
# å®Œæ•´è·¯å¾„
alice := data.users.alice

# æ¨¡å¼åŒ¹é…
user := data.users[name]  # nameç»‘å®šåˆ°é”®

# éå†
users := [u | u := data.users[_]]
```

---

### 3.3 Bundle (ç­–ç•¥åŒ…)

**å®šä¹‰**: åŒ…å«ç­–ç•¥æ–‡ä»¶å’Œæ•°æ®çš„å‹ç¼©åŒ…ï¼ˆ`.tar.gz`ï¼‰ï¼Œç”¨äºåˆ†å‘å’Œéƒ¨ç½²ã€‚

**Bundleç»“æ„**:

```text
my-bundle.tar.gz
â”œâ”€â”€ .manifest
â”œâ”€â”€ policy/
â”‚   â”œâ”€â”€ authz.rego
â”‚   â””â”€â”€ rbac.rego
â””â”€â”€ data/
    â”œâ”€â”€ users.json
    â””â”€â”€ roles.json
```

**Manifestæ–‡ä»¶**ï¼ˆ`.manifest`ï¼‰:

```json
{
    "revision": "v1.2.3",
    "roots": ["policy", "data"],
    "metadata": {
        "author": "alice",
        "created": "2025-10-20T12:00:00Z"
    }
}
```

**BundleåŠ è½½**:

```bash
# CLIåŠ è½½
opa run --bundle bundle.tar.gz

# è¿œç¨‹åŠ è½½
opa run --server \
    --set bundles.authz.service=my-service \
    --set bundles.authz.resource=bundles/authz.tar.gz
```

---

### 3.4 Document (æ–‡æ¡£)

**å®šä¹‰**: OPAå†…éƒ¨æ•°æ®çš„å±‚æ¬¡ç»“æ„è¡¨ç¤ºï¼Œæœ¬è´¨ä¸Šæ˜¯JSONå¯¹è±¡/æ•°ç»„ã€‚

**æ–‡æ¡£è·¯å¾„**:

```text
data                         # æ ¹æ–‡æ¡£
  â”œâ”€â”€ users                  # data.users
  â”‚   â””â”€â”€ alice              # data.users.alice
  â”‚       â””â”€â”€ role           # data.users.alice.role
  â””â”€â”€ policies
      â””â”€â”€ allow              # data.policies.allow
```

**è™šæ‹Ÿæ–‡æ¡£**:

```rego
# å®šä¹‰è§„åˆ™
package virtual

result := 42 if {
    input.flag == true
}
```

**è®¿é—®**:

```text
GET /v1/data/virtual/result?input={"flag":true}
â†’ {"result": 42}
```

---

## 4. æ‰§è¡Œæ¦‚å¿µå±‚

### 4.1 Evaluation (æ±‚å€¼)

**å®šä¹‰**: OPAæ‰§è¡Œç­–ç•¥æŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œè®¡ç®—è§„åˆ™æ˜¯å¦æ»¡è¶³ã€‚

**æ±‚å€¼ç­–ç•¥**:

```text
Top-Down + Depth-First + Backtracking
```

**æ±‚å€¼è¿‡ç¨‹**:

```text
1. è§£ææŸ¥è¯¢è·¯å¾„ (data.pkg.rule)
2. æŸ¥æ‰¾å¯¹åº”è§„åˆ™
3. ç»‘å®šå˜é‡
4. æ±‚å€¼è§„åˆ™ä½“è¡¨è¾¾å¼ï¼ˆANDè¿æ¥ï¼‰
5. ç»Ÿä¸€/åŒ¹é…
6. è¿”å›ç»“æœæˆ–å›æº¯
```

**æ±‚å€¼ç¤ºä¾‹**:

```rego
# ç­–ç•¥
allow if {
    input.method == "GET"    # æ­¥éª¤1
    is_admin                 # æ­¥éª¤2
}

is_admin if {
    input.user.role == "admin"  # æ­¥éª¤2.1
}
```

**æ±‚å€¼æ ‘**:

```text
allow
  â”œâ”€ input.method == "GET" âœ“
  â””â”€ is_admin
       â””â”€ input.user.role == "admin" âœ“
ç»“æœ: allow = true
```

---

### 4.2 Unification (ç»Ÿä¸€)

**å®šä¹‰**: åŒå‘æ¨¡å¼åŒ¹é…ï¼Œä½¿ä¸¤ä¸ªé¡¹ç›¸ç­‰çš„å˜é‡ç»‘å®šè¿‡ç¨‹ã€‚

**ç»Ÿä¸€è§„åˆ™**:

```text
unify(v, v) = âˆ…                    # ç›¸åŒå€¼
unify(X, t) = {X â†¦ t}              # å˜é‡ç»‘å®š
unify([a, b], [1, 2]) = {aâ†¦1, bâ†¦2} # ç»“æ„åŒ¹é…
```

**ç¤ºä¾‹**:

```rego
# ç»Ÿä¸€å˜é‡
x = 5                 # x ç»‘å®šåˆ° 5

# ç»Ÿä¸€æ•°ç»„
[a, b, c] = [1, 2, 3] # a=1, b=2, c=3

# ç»Ÿä¸€å¯¹è±¡
{"name": n, "age": a} = {"name": "alice", "age": 30}
# n="alice", a=30
```

---

### 4.3 Backtracking (å›æº¯)

**å®šä¹‰**: å½“æ±‚å€¼å¤±è´¥æ—¶ï¼Œè¿”å›ä¸Šä¸€é€‰æ‹©ç‚¹å°è¯•å…¶ä»–å¯èƒ½ã€‚

**å›æº¯åœºæ™¯**:

```rego
# å¤šä¸ªè§„åˆ™å®šä¹‰
allow if { condition1 }  # å°è¯•1
allow if { condition2 }  # å°è¯•2ï¼ˆå¦‚æœ1å¤±è´¥ï¼‰

# é›†åˆéå†
user := data.users[_]    # éå†æ‰€æœ‰ç”¨æˆ·
user.role == "admin"     # å›æº¯åˆ°ç¬¦åˆæ¡ä»¶çš„
```

**æ‰§è¡Œæµ**:

```text
å°è¯•è§„åˆ™1 â†’ å¤±è´¥ â†’ å›æº¯ â†’ å°è¯•è§„åˆ™2 â†’ æˆåŠŸ â†’ è¿”å›
```

---

### 4.4 Partial Evaluation (éƒ¨åˆ†æ±‚å€¼)

**å®šä¹‰**: é¢„å…ˆè®¡ç®—å·²çŸ¥æ•°æ®éƒ¨åˆ†ï¼Œç”Ÿæˆä¼˜åŒ–åçš„æŸ¥è¯¢ã€‚

**åœºæ™¯**: æ•°æ®å›ºå®šã€è¾“å…¥å¯å˜ã€‚

**ç¤ºä¾‹**:

```rego
# åŸå§‹è§„åˆ™
allow if {
    data.roles[input.user].permissions[_] == input.action
}
```

**éƒ¨åˆ†æ±‚å€¼å**ï¼ˆå‡è®¾ `data.roles` å·²çŸ¥ï¼‰:

```rego
# é’ˆå¯¹ç”¨æˆ· alice
allow if {
    input.user == "alice"
    {"read", "write"}[_] == input.action
}
```

**æ€§èƒ½æå‡**: `O(n)` â†’ `O(1)`

---

### 4.5 Indexing (ç´¢å¼•)

**å®šä¹‰**: å¯¹æ•°æ®æˆ–è§„åˆ™å»ºç«‹ç´¢å¼•ï¼ŒåŠ é€ŸæŸ¥è¯¢ã€‚

**ç´¢å¼•ç±»å‹**:

#### 4.5.1 æ•°æ®ç´¢å¼•

```rego
# æ— ç´¢å¼•: O(n) éå†
user := data.users[_]
user.id == input.user_id

# æœ‰ç´¢å¼•: O(1) æŸ¥æ‰¾
user := data.users[input.user_id]
```

#### 4.5.2 è§„åˆ™ç´¢å¼•

```rego
# OPAè‡ªåŠ¨ä¸ºä»¥ä¸‹æ¨¡å¼å»ºç«‹ç´¢å¼•:
input.x == constant
data.y[z] == constant
```

**æ€§èƒ½å½±å“**:

```text
ç™¾ä¸‡æ¡è§„åˆ™ Ã— ç´¢å¼• = äºšæ¯«ç§’æŸ¥è¯¢
```

---

## 5. éƒ¨ç½²æ¦‚å¿µå±‚

### 5.1 Sidecar (è¾¹è½¦æ¨¡å¼)

**å®šä¹‰**: OPAä½œä¸ºç‹¬ç«‹è¿›ç¨‹ï¼Œä¸åº”ç”¨å®¹å™¨å…±äº«Pod/VMã€‚

**æ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kubernetes    â”‚
â”‚      Pod        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    App    â”‚  â”‚ â†â”€ ä¸šåŠ¡é€»è¾‘
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚ REST   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    OPA    â”‚  â”‚ â†â”€ ç­–ç•¥å†³ç­–
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:

- âœ… ä½å»¶è¿Ÿï¼ˆ< 1msï¼‰
- âœ… ç½‘ç»œéš”ç¦»
- âœ… ç‹¬ç«‹æ‰©å±•

**é€‚ç”¨åœºæ™¯**: å¾®æœåŠ¡ã€K8sç¯å¢ƒ

---

### 5.2 Library (åº“åµŒå…¥)

**å®šä¹‰**: å°†OPAä½œä¸ºGoåº“åµŒå…¥åº”ç”¨è¿›ç¨‹ã€‚

**é›†æˆæ–¹å¼**:

```go
import "github.com/open-policy-agent/opa/rego"

// åˆ›å»ºæŸ¥è¯¢
query := rego.New(
    rego.Query("data.authz.allow"),
    rego.Input(inputData),
)

// æ‰§è¡Œ
rs, err := query.Eval(ctx)
if rs.Allowed() {
    // å…è®¸è®¿é—®
}
```

**ä¼˜ç‚¹**:

- âœ… é›¶ç½‘ç»œå¼€é”€
- âœ… è¿›ç¨‹å†…è°ƒç”¨
- âœ… ç±»å‹å®‰å…¨

**é€‚ç”¨åœºæ™¯**: Goåº”ç”¨ã€é«˜æ€§èƒ½éœ€æ±‚

---

### 5.3 Server (æœåŠ¡æ¨¡å¼)

**å®šä¹‰**: OPAä½œä¸ºç‹¬ç«‹HTTP/gRPCæœåŠ¡è¿è¡Œã€‚

**éƒ¨ç½²**:

```bash
opa run --server \
    --addr :8181 \
    --bundle my-bundle.tar.gz
```

**API**:

```text
POST /v1/data/{path}      # ç­–ç•¥æŸ¥è¯¢
PUT  /v1/policies/{id}    # ä¸Šä¼ ç­–ç•¥
GET  /v1/data/{path}      # æ•°æ®æŸ¥è¯¢
GET  /health              # å¥åº·æ£€æŸ¥
```

**é€‚ç”¨åœºæ™¯**: å¤šåº”ç”¨å…±äº«ã€é›†ä¸­ç®¡ç†

---

### 5.4 WASM (WebAssembly)

**å®šä¹‰**: å°†Regoç­–ç•¥ç¼–è¯‘ä¸ºWASMï¼Œåœ¨æ²™ç®±ç¯å¢ƒæ‰§è¡Œã€‚

**ç¼–è¯‘**:

```bash
opa build -t wasm -e 'data.authz.allow' policy.rego
```

**ç”Ÿæˆ**:

```text
policy.wasm        # WASMå­—èŠ‚ç 
policy.tar.gz      # åŒ…å«æ•°æ®
```

**æ‰§è¡Œ**:

```javascript
// æµè§ˆå™¨/è¾¹ç¼˜ç¯å¢ƒ
const policy = await loadPolicy('policy.wasm');
const result = policy.evaluate(input);
```

**ä¼˜ç‚¹**:

- âœ… è½»é‡ï¼ˆ< 200KBï¼‰
- âœ… æ²™ç®±å®‰å…¨
- âœ… è·¨å¹³å°

**é€‚ç”¨åœºæ™¯**: è¾¹ç¼˜è®¡ç®—ã€æµè§ˆå™¨ã€CDN

---

## 6. æ¦‚å¿µå…³ç³»ç½‘ç»œ

### 6.1 æ¦‚å¿µä¾èµ–å›¾

```mermaid
graph TD
    OPA[OPAå¼•æ“] --> Rego[Regoè¯­è¨€]
    OPA --> Data[æ•°æ®å±‚]
    Rego --> Policy[ç­–ç•¥]
    Policy --> Module[æ¨¡å—]
    Module --> Package[åŒ…]
    Module --> Rule[è§„åˆ™]
    Rule --> Head[è§„åˆ™å¤´]
    Rule --> Body[è§„åˆ™ä½“]
    Body --> Expr[è¡¨è¾¾å¼]
    Expr --> Term[é¡¹]
    Data --> Input[è¾“å…¥]
    Data --> DataStore[æ•°æ®å­˜å‚¨]
    DataStore --> Bundle[Bundle]
    OPA --> Eval[æ±‚å€¼å™¨]
    Eval --> Unify[ç»Ÿä¸€ç®—æ³•]
    Eval --> Index[ç´¢å¼•]
    OPA --> Deploy[éƒ¨ç½²æ¨¡å¼]
    Deploy --> Sidecar[Sidecar]
    Deploy --> Library[Library]
    Deploy --> Server[Server]
    Deploy --> WASM[WASM]
```

### 6.2 æ¦‚å¿µäº¤äº’çŸ©é˜µ

|  | Policy | Rule | Input | Data | Query | Decision |
|---|---|---|---|---|---|---|
| **Policy** | - | åŒ…å« | è¯»å– | å¼•ç”¨ | è¢«æŸ¥è¯¢ | äº§ç”Ÿ |
| **Rule** | å±äº | - | è¯»å– | å¼•ç”¨ | è¢«æ±‚å€¼ | äº§ç”Ÿ |
| **Input** | æä¾›ç»™ | æä¾›ç»™ | - | ç‹¬ç«‹ | æºå¸¦ | å½±å“ |
| **Data** | æä¾›ç»™ | æä¾›ç»™ | ç‹¬ç«‹ | - | æºå¸¦ | å½±å“ |
| **Query** | è°ƒç”¨ | è°ƒç”¨ | æºå¸¦ | æºå¸¦ | - | äº§ç”Ÿ |
| **Decision** | æ¥è‡ª | æ¥è‡ª | åŸºäº | åŸºäº | å“åº” | - |

### 6.3 æŠ½è±¡å±‚æ¬¡

```text
ç¬¬5å±‚ï¼šåº”ç”¨å±‚
  â”œâ”€â”€ å¾®æœåŠ¡æˆæƒ
  â”œâ”€â”€ K8så‡†å…¥æ§åˆ¶
  â””â”€â”€ APIç½‘å…³
      â†“
ç¬¬4å±‚ï¼šæ¥å£å±‚
  â”œâ”€â”€ REST API
  â”œâ”€â”€ gRPC
  â””â”€â”€ SDK
      â†“
ç¬¬3å±‚ï¼šç­–ç•¥å±‚
  â”œâ”€â”€ Policy
  â”œâ”€â”€ Rule
  â””â”€â”€ Expression
      â†“
ç¬¬2å±‚ï¼šè¯­è¨€å±‚
  â”œâ”€â”€ Regoè¯­æ³•
  â”œâ”€â”€ ç±»å‹ç³»ç»Ÿ
  â””â”€â”€ æ±‚å€¼è¯­ä¹‰
      â†“
ç¬¬1å±‚ï¼šå¼•æ“å±‚
  â”œâ”€â”€ ç¼–è¯‘å™¨
  â”œâ”€â”€ æ±‚å€¼å™¨
  â””â”€â”€ å­˜å‚¨
      â†“
ç¬¬0å±‚ï¼šåŸºç¡€è®¾æ–½å±‚
  â”œâ”€â”€ Go Runtime
  â”œâ”€â”€ WASM Runtime
  â””â”€â”€ æ“ä½œç³»ç»Ÿ
```

---

## é™„å½•ï¼šæœ¯è¯­å¯¹ç…§è¡¨

| è‹±æ–‡ | ä¸­æ–‡ | ç®€è¦è¯´æ˜ |
|------|------|---------|
| Policy | ç­–ç•¥ | å†³ç­–é€»è¾‘é›†åˆ |
| Rule | è§„åˆ™ | ç­–ç•¥çš„åŸºæœ¬å•å…ƒ |
| Query | æŸ¥è¯¢ | å†³ç­–è¯·æ±‚ |
| Evaluation | æ±‚å€¼ | æ‰§è¡Œç­–ç•¥çš„è¿‡ç¨‹ |
| Unification | ç»Ÿä¸€ | æ¨¡å¼åŒ¹é…ç®—æ³• |
| Bundle | ç­–ç•¥åŒ… | æ‰“åŒ…çš„ç­–ç•¥å’Œæ•°æ® |
| Sidecar | è¾¹è½¦ | è¿›ç¨‹çº§éƒ¨ç½²æ¨¡å¼ |
| Partial Evaluation | éƒ¨åˆ†æ±‚å€¼ | é¢„è®¡ç®—ä¼˜åŒ–æŠ€æœ¯ |
| Comprehension | æ¨å¯¼å¼ | é›†åˆç”Ÿæˆè¡¨è¾¾å¼ |
| Datalog | æ•°æ®é€»è¾‘ | é€»è¾‘ç¼–ç¨‹è¯­è¨€ |

---

**ä¸‹ä¸€ç¯‡**: [07.2-å…³ç³»çŸ©é˜µ](./07.2-å…³ç³»çŸ©é˜µ.md)  
**ç›¸å…³**: [02.1-Regoè¯­æ³•è§„èŒƒ](../02-è¯­è¨€æ¨¡å‹/02.1-Regoè¯­æ³•è§„èŒƒ.md)
